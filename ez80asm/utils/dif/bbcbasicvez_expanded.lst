        Output     Line 
040000             0001   ; --- Begin mos_api.inc ---
040000             0248   ; --- Begin equs.inc ---
040000             0312   ; --- Begin macros.inc ---
040000             0366   ; --- Begin agon_init.asm ---
000000 C3      0393 JP	_start				; Jump to start
000001 52   
000002 00   
000003 FF   
000004 FF   
000005 FF   
000006 FF   
000007 FF   
000008 49      0396 RST_08:			RST.LIS	08h				; API call
000009 CF   
00000A C9      0397 RET
00000B FF   
00000C FF   
00000D FF   
00000E FF   
00000F FF   
000010 49      0400 RST_10:			RST.LIS 10h				; Output
000011 D7   
000012 C9      0401 RET
000013 FF   
000014 FF   
000015 FF   
000016 FF   
000017 FF   
000018 49      0404 RST_18:			RST.LIS	18h				; Block Output
000019 DF   
00001A C9      0405 RET
00001B FF   
00001C FF   
00001D FF   
00001E FF   
00001F FF   
000020 FF   
000021 FF   
000022 FF   
000023 FF   
000024 FF   
000025 FF   
000026 FF   
000027 FF   
000028 FF   
000029 FF   
00002A FF   
00002B FF   
00002C FF   
00002D FF   
00002E FF   
00002F FF   
000030 FF   
000031 FF   
000032 FF   
000033 FF   
000034 FF   
000035 FF   
000036 FF   
000037 FF   
000038 FB      0415 RST_38:			EI
000039 ED      0416 RETI
00003A 4D   
00003B FF      0420 ALIGN	64
00003C FF   
00003D FF   
00003E FF   
00003F FF   
000040 4D      0422 DB	"MOS"				; Flag for MOS - to confirm this is a valid MOS command
000041 4F   
000042 53   
000043 00      0423 DB	00h				; MOS header version 0
000044 00      0424 DB	00h				; Flag for run mode (0: Z80, 1: ADL)
000045 42      0426 _exec_name:		DB	"BBCBASIC.BIN", 0		; The executable name, only used in argv
000046 42   
000047 43   
000048 42   
000049 41   
00004A 53   
00004B 49   
00004C 43   
00004D 2E   
00004E 42   
00004F 49   
000050 4E   
000051 00   
000052 5B      0431 _start:			PUSH.LIL	IY			; Preserve IY
000053 FD   
000054 E5   
000055 FD      0433 LD		IY, 0			; Preserve SPS
000056 21   
000057 00   
000058 00   
000059 FD      0434 ADD		IY, SP
00005A 39   
00005B 5B      0435 PUSH.LIL	IY
00005C FD   
00005D E5   
00005E E3      0437 EX		(SP), HL		; Get the SPS part of the return address
00005F 5B      0438 PUSH.LIL	HL
000060 E5   
000061 E3      0439 EX		(SP), HL		; And restore it for BASIC
000062 5B      0441 PUSH.LIL	AF			; Preserve the rest of the registers
000063 F5   
000064 5B      0442 PUSH.LIL	BC
000065 C5   
000066 5B      0443 PUSH.LIL	DE
000067 D5   
000068 5B      0444 PUSH.LIL	IX
000069 DD   
00006A E5   
00006B ED      0446 LD		A, MB			; Segment base
00006C 6E   
00006D DD      0447 LD		IX, argv_ptrs		; The argv array pointer address
00006E 21   
00006F 65   
000070 01   
000071 CD      0448 CALL		_set_aix24		; Convert to a 24-bit address
000072 51   
000073 01   
000074 5B      0449 PUSH.LIL	IX
000075 DD   
000076 E5   
000077 CD      0450 CALL		_parse_params		; Parse the parameters
000078 E1   
000079 00   
00007A 5B      0451 POP.LIL		IX			; IX: argv
00007B DD   
00007C E1   
00007D 06      0452 LD		B, 0			;  C: argc
00007E 00   
00007F CD      0453 CALL		_main			; Start user code
000080 9A   
000081 00   
000082 5B      0455 POP.LIL		IX			; Restore the registers
000083 DD   
000084 E1   
000085 5B      0456 POP.LIL		DE
000086 D1   
000087 5B      0457 POP.LIL		BC
000088 C1   
000089 5B      0458 POP.LIL		AF
00008A F1   
00008B EB      0460 EX		DE, HL 			; DE: Return code from BASIC
00008C 5B      0461 POP.LIL		HL 			; The SPS part of the return address
00008D E1   
00008E 5B      0462 POP.LIL		IY			; Get the preserved SPS
00008F FD   
000090 E1   
000091 FD      0463 LD		SP, IY			; Restore SPS
000092 F9   
000093 E3      0464 EX		(SP), HL		; Store the SPS part of the return address on the stack
000094 EB      0465 EX		DE, HL 			; HL: Return code from BASIC
000095 5B      0467 POP.LIL		IY			; Restore IY
000096 FD   
000097 E1   
000098 49      0468 RET.L					; Return to MOS
000099 C9   
00009A 21      0476 _main:			LD	HL, ACCS		; Clear the ACCS
00009B 00   
00009C 52   
00009D 36      0477 LD	(HL), 0
00009E 00   
00009F 79      0478 LD	A, C
0000A0 FE      0479 CP	2
0000A1 02   
0000A2 28      0480 JR	Z, _autoload		; 2 parameters = autoload
0000A3 24   
0000A4 38      0481 JR	C, _startbasic		; 1 parameter = normal start
0000A5 35   
0000A6 CD      0483 CALL	TELL
0000A7 FA   
0000A8 44   
0000A9 55      0484 DB	"Usage:\n\r"
0000AA 73   
0000AB 61   
0000AC 67   
0000AD 65   
0000AE 3A   
0000AF 0A   
0000B0 0D   
0000B1 52      0485 DB	"RUN . <filename>\n\r", 0
0000B2 55   
0000B3 4E   
0000B4 20   
0000B5 2E   
0000B6 20   
0000B7 3C   
0000B8 66   
0000B9 69   
0000BA 6C   
0000BB 65   
0000BC 6E   
0000BD 61   
0000BE 6D   
0000BF 65   
0000C0 3E   
0000C1 0A   
0000C2 0D   
0000C3 00   
0000C4 21      0486 LD	HL, 0			; The error code
0000C5 00   
0000C6 00   
0000C7 C9      0487 RET
0000C8 5B      0489 _autoload:		LD.LIL	HL, (IX+3)		; HLU: Address of filename
0000C9 DD   
0000CA 27   
0000CB 03   
0000CC 11      0490 LD	DE, ACCS		;  DE: Destination address
0000CD 00   
0000CE 52   
0000CF 5B      0491 @@:			LD.LIL	A, (HL)			; Fetch the filename byte
0000D0 7E   
0000D1 12      0492 LD	(DE), A			;
0000D2 5B      0493 INC.LIL	HL			; Increase the source pointer
0000D3 23   
0000D4 1C      0494 INC	E			; We only need to increase E as ACCS is on a page boundary
0000D5 20      0495 JR	NZ, @B			; Loop until we hit a 0 byte
0000D6 F8   
0000D7 1D      0496 DEC	E
0000D8 3E      0497 LD	A, CR
0000D9 0D   
0000DA 12      0498 LD	(DE), A			; Replace the 0 byte with a CR for BBC BASIC
0000DB E1      0500 _startbasic:		POP	 HL			; Pop the return address to init off SPS
0000DC 5B      0501 PUSH.LIL HL 			; Stack it on SPL (*BYE will use this as the return address)
0000DD E5   
0000DE C3      0502 JP	 START			; And start BASIC
0000DF 17   
0000E0 37   
0000E1 01      0512 _parse_params:		LD		BC, _exec_name		; Get the address of the app name in this segment
0000E2 45   
0000E3 00   
0000E4 CD      0513 CALL		_set_abc24		; Convert it to a 24-bit address based upon segment base
0000E5 3F   
0000E6 01   
0000E7 5B      0514 LD.LIL		(IX+0), BC		; ARGV[0] = the executable name
0000E8 DD   
0000E9 0F   
0000EA 00   
0000EB 5B      0515 INC.LIL		IX
0000EC DD   
0000ED 23   
0000EE 5B      0516 INC.LIL		IX
0000EF DD   
0000F0 23   
0000F1 5B      0517 INC.LIL		IX
0000F2 DD   
0000F3 23   
0000F4 CD      0518 CALL		_skip_spaces		; Skip HL past any leading spaces
0000F5 36   
0000F6 01   
0000F7 01      0520 LD		BC, 1			; C: ARGC = 1 - also clears out top 16 bits of BCU
0000F8 01   
0000F9 00   
0000FA 06      0521 LD		B, argv_ptrs_max - 1	; B: Maximum number of argv_ptrs
0000FB 0F   
0000FC C5      0523 _parse_params_1:	PUSH		BC			; Stack ARGC
0000FD 5B      0524 PUSH.LIL	HL			; Stack start address of token
0000FE E5   
0000FF CD      0525 CALL		_get_token		; Get the next token
000100 25   
000101 01   
000102 79      0526 LD		A, C			; A: Length of the token in characters
000103 5B      0527 POP.LIL		DE			; Start address of token (was in HL)
000104 D1   
000105 C1      0528 POP		BC			; ARGC
000106 B7      0529 OR		A			; Check for A=0 (no token found) OR at end of string
000107 C8      0530 RET		Z
000108 5B      0532 LD.LIL		(IX+0), DE		; Store the pointer to the token
000109 DD   
00010A 1F   
00010B 00   
00010C 5B      0533 PUSH.LIL	HL			; DE=HL
00010D E5   
00010E 5B      0534 POP.LIL		DE
00010F D1   
000110 CD      0535 CALL		_skip_spaces		; And skip HL past any spaces onto the next character
000111 36   
000112 01   
000113 AF      0536 XOR		A
000114 5B      0537 LD.LIL		(DE), A			; Zero-terminate the token
000115 12   
000116 5B      0538 INC.LIL		IX
000117 DD   
000118 23   
000119 5B      0539 INC.LIL		IX
00011A DD   
00011B 23   
00011C 5B      0540 INC.LIL		IX			; Advance to next pointer position
00011D DD   
00011E 23   
00011F 0C      0541 INC		C			; Increment ARGC
000120 79      0542 LD		A, C			; Check for C >= A
000121 B8      0543 CP		B
000122 38      0544 JR		C, _parse_params_1	; And loop
000123 D8   
000124 C9      0545 RET
000125 0E      0554 _get_token:		LD		C, 0			; Initialise length
000126 00   
000127 5B      0555 @@:			LD.LIL		A, (HL)			; Get the character from the parameter string
000128 7E   
000129 B7      0556 OR		A			; Exit if 0 (end of parameter string in MOS)
00012A C8      0557 RET 		Z
00012B FE      0558 CP		13			; Exit if CR (end of parameter string in BBC BASIC)
00012C 0D   
00012D C8      0559 RET		Z
00012E FE      0560 CP		' '			; Exit if space (end of token)
00012F 20   
000130 C8      0561 RET		Z
000131 5B      0562 INC.LIL		HL			; Advance to next character
000132 23   
000133 0C      0563 INC 		C			; Increment length
000134 18      0564 JR		@B
000135 F1   
000136 5B      0573 _skip_spaces:		LD.LIL		A, (HL)			; Get the character from the parameter string
000137 7E   
000138 FE      0574 CP		' '			; Exit if not space
000139 20   
00013A C0      0575 RET		NZ
00013B 5B      0576 INC.LIL		HL			; Advance to next character
00013C 23   
00013D 18      0577 JR		_skip_spaces		; Increment length
00013E F7   
00013F 5B      0586 _set_abc24:		PUSH.LIL	HL			; Preserve HL
000140 E5   
000141 5B      0587 PUSH.LIL	BC			; Stick BC onto SPL
000142 C5   
000143 5B      0588 LD.LIL		HL, 2			; HL: SP+2
000144 21   
000145 02   
000146 00   
000147 00   
000148 5B      0589 ADD.LIL		HL, SP
000149 39   
00014A 5B      0590 LD.LIL		(HL), A			; Store A in it
00014B 77   
00014C 5B      0591 POP.LIL		BC			; Fetch ammended BC
00014D C1   
00014E 5B      0592 POP.LIL		HL			; Restore HL
00014F E1   
000150 C9      0593 RET
000151 5B      0602 _set_aix24:		PUSH.LIL	IX			; Stick IX onto SPL
000152 DD   
000153 E5   
000154 5B      0603 LD.LIL		IX, 2			; IX: SP+2
000155 DD   
000156 21   
000157 02   
000158 00   
000159 00   
00015A 5B      0604 ADD.LIL		IX, SP
00015B DD   
00015C 39   
00015D 5B      0605 LD.LIL		(IX), A			; Store A in it
00015E DD   
00015F 77   
000160 00   
000161 5B      0606 POP.LIL		IX			; Fetch ammended IX
000162 DD   
000163 E1   
000164 C9      0607 RET
000165 00      0611 argv_ptrs:		BLKP	argv_ptrs_max, 0		; Storage for the argv array pointers
000166 00   
000167 00   
000168 00   
000169 00   
00016A 00   
00016B 00   
00016C 00   
00016D 00   
00016E 00   
00016F 00   
000170 00   
000171 00   
000172 00   
000173 00   
000174 00   
000175 00   
000176 00   
000177 00   
000178 00   
000179 00   
00017A 00   
00017B 00   
00017C 00   
00017D 00   
00017E 00   
00017F 00   
000180 00   
000181 00   
000182 00   
000183 00   
000184 00   
000185 00   
000186 00   
000187 00   
000188 00   
000189 00   
00018A 00   
00018B 00   
00018C 00   
00018D 00   
00018E 00   
00018F 00   
000190 00   
000191 00   
000192 00   
000193 00   
000194 00   
000195             0614   ; --- Begin agon_graphics.asm ---
000195 DD      0656 MODE_:			PUSH	IX			; Get the system vars in IX
000196 E5   
000197 3E    0001M1 LD	A, function
000198 08   
000199 49    0002M1 RST.LIS	08h
00019A CF   
00019B 5B      0658 RES.LIL	4, (IX+sysvar_vpd_pflags)
00019C DD   
00019D CB   
00019E 04   
00019F A6   
0001A0 CD      0659 CALL    EXPRI
0001A1 33   
0001A2 18   
0001A3 D9      0660 EXX
0001A4 3E    0001M1 LD      A, VAL
0001A5 16   
0001A6 CD    0002M1 CALL    OSWRCH
0001A7 B1   
0001A8 05   
0001A9 7D    0001M1 LD      A, VAL
0001AA CD    0002M1 CALL    OSWRCH
0001AB B1   
0001AC 05   
0001AD 3E    0001M1 LD	A, function
0001AE 08   
0001AF 49    0002M1 RST.LIS	08h
0001B0 CF   
0001B1 5B      0664 @@:			BIT.LIL	4, (IX+sysvar_vpd_pflags)
0001B2 DD   
0001B3 CB   
0001B4 04   
0001B5 66   
0001B6 28      0665 JR	Z, @B			; Wait for the result
0001B7 F9   
0001B8 DD      0666 POP	IX
0001B9 E1   
0001BA C3      0667 JP	XEQ
0001BB 99   
0001BC 24   
0001BD FD      0671 GETSCHR:		INC	IY
0001BE 23   
0001BF CD      0672 CALL    EXPRI      		; Get X coordinate
0001C0 33   
0001C1 18   
0001C2 D9      0673 EXX
0001C3 E5      0674 PUSH	HL			; Stack X
0001C4 CD      0675 CALL	COMMA
0001C5 A2   
0001C6 20   
0001C7 CD      0676 CALL	EXPRI			; Get Y coordinate
0001C8 33   
0001C9 18   
0001CA D9      0677 EXX
0001CB CD      0678 CALL	BRAKET			; Closing bracket
0001CC AE   
0001CD 20   
0001CE D1      0679 POP	DE			; Pop X back into DE
0001CF CD      0680 CALL	GETSCHR_1
0001D0 DB   
0001D1 01   
0001D2 11      0682 LD	DE,ACCS
0001D3 00   
0001D4 52   
0001D5 12      0683 LD	(DE),A
0001D6 3E      0684 LD	A,80H
0001D7 80   
0001D8 D0      0685 RET	NC
0001D9 1C      0686 INC	E
0001DA C9      0687 RET
0001DB DD      0696 GETSCHR_1:		PUSH	IX			; Get the system vars in IX
0001DC E5   
0001DD 3E    0001M1 LD	A, function
0001DE 08   
0001DF 49    0002M1 RST.LIS	08h
0001E0 CF   
0001E1 5B      0698 RES.LIL	1, (IX+sysvar_vpd_pflags)
0001E2 DD   
0001E3 CB   
0001E4 04   
0001E5 8E   
0001E6 3E    0001M1 LD      A, VAL
0001E7 17   
0001E8 CD    0002M1 CALL    OSWRCH
0001E9 B1   
0001EA 05   
0001EB 3E    0001M1 LD      A, VAL
0001EC 00   
0001ED CD    0002M1 CALL    OSWRCH
0001EE B1   
0001EF 05   
0001F0 3E    0001M1 LD      A, VAL
0001F1 83   
0001F2 CD    0002M1 CALL    OSWRCH
0001F3 B1   
0001F4 05   
0001F5 7B    0001M1 LD      A, VAL
0001F6 CD    0002M1 CALL    OSWRCH
0001F7 B1   
0001F8 05   
0001F9 7A    0001M1 LD      A, VAL
0001FA CD    0002M1 CALL    OSWRCH
0001FB B1   
0001FC 05   
0001FD 7D    0001M1 LD      A, VAL
0001FE CD    0002M1 CALL    OSWRCH
0001FF B1   
000200 05   
000201 7C    0001M1 LD      A, VAL
000202 CD    0002M1 CALL    OSWRCH
000203 B1   
000204 05   
000205 5B      0706 @@:			BIT.LIL	1, (IX+sysvar_vpd_pflags)
000206 DD   
000207 CB   
000208 04   
000209 4E   
00020A 28      0707 JR	Z, @B			; Wait for the result
00020B F9   
00020C 5B      0708 LD.LIL	A, (IX+sysvar_scrchar)	; Fetch the result in A
00020D DD   
00020E 7E   
00020F 09   
000210 B7      0709 OR	A			; Check for 00h
000211 37      0710 SCF				; C = character map
000212 20      0711 JR	NZ, @F			; We have a character, so skip next bit
000213 01   
000214 AF      0712 XOR	A			; Clear carry
000215 DD      0713 @@:			POP	IX
000216 E1   
000217 C9      0714 RET
000218 DD      0723 POINT_:			PUSH	IX			; Get the system vars in IX
000219 E5   
00021A 3E    0001M1 LD	A, function
00021B 08   
00021C 49    0002M1 RST.LIS	08h
00021D CF   
00021E 5B      0725 RES.LIL	2, (IX+sysvar_vpd_pflags)
00021F DD   
000220 CB   
000221 04   
000222 96   
000223 3E    0001M1 LD      A, VAL
000224 17   
000225 CD    0002M1 CALL    OSWRCH
000226 B1   
000227 05   
000228 3E    0001M1 LD      A, VAL
000229 00   
00022A CD    0002M1 CALL    OSWRCH
00022B B1   
00022C 05   
00022D 3E    0001M1 LD      A, VAL
00022E 84   
00022F CD    0002M1 CALL    OSWRCH
000230 B1   
000231 05   
000232 7B    0001M1 LD      A, VAL
000233 CD    0002M1 CALL    OSWRCH
000234 B1   
000235 05   
000236 7A    0001M1 LD      A, VAL
000237 CD    0002M1 CALL    OSWRCH
000238 B1   
000239 05   
00023A 7D    0001M1 LD      A, VAL
00023B CD    0002M1 CALL    OSWRCH
00023C B1   
00023D 05   
00023E 7C    0001M1 LD      A, VAL
00023F CD    0002M1 CALL    OSWRCH
000240 B1   
000241 05   
000242 5B      0733 @@:			BIT.LIL	2, (IX+sysvar_vpd_pflags)
000243 DD   
000244 CB   
000245 04   
000246 56   
000247 28      0734 JR	Z, @B			; Wait for the result
000248 F9   
000249 5B      0738 LD.LIL	A, (IX+sysvar_scrpixelIndex)
00024A DD   
00024B 7E   
00024C 16   
00024D DD      0739 POP	IX
00024E E1   
00024F C9      0740 RET
000250 CD      0746 COLOUR_:		CALL	EXPRI			; The colour / mode
000251 33   
000252 18   
000253 D9      0747 EXX
000254 7D      0748 LD	A, L
000255 32      0749 LD	(VDU_BUFFER+0), A	; Store first parameter
000256 00   
000257 52   
000258 CD      0750 CALL	NXT			; Are there any more parameters?
000259 0B   
00025A 45   
00025B FE      0751 CP	','
00025C 2C   
00025D 28      0752 JR	Z, COLOUR_1		; Yes, so we're doing a palette change next
00025E 0E   
00025F 3E    0001M1 LD      A, VAL
000260 11   
000261 CD    0002M1 CALL    OSWRCH
000262 B1   
000263 05   
000264 3A    0001M1 LD      A, VAL
000265 00   
000266 52   
000267 CD    0002M1 CALL    OSWRCH
000268 B1   
000269 05   
00026A C3      0756 JP	XEQ
00026B 99   
00026C 24   
00026D CD      0758 COLOUR_1:		CALL	COMMA
00026E A2   
00026F 20   
000270 CD      0759 CALL	EXPRI			; Parse R (OR P)
000271 33   
000272 18   
000273 D9      0760 EXX
000274 7D      0761 LD	A, L
000275 32      0762 LD	(VDU_BUFFER+1), A
000276 01   
000277 52   
000278 CD      0763 CALL	NXT			; Are there any more parameters?
000279 0B   
00027A 45   
00027B FE      0764 CP	','
00027C 2C   
00027D 28      0765 JR	Z, COLOUR_2		; Yes, so we're doing COLOUR L,R,G,B
00027E 23   
00027F 3E    0001M1 LD      A, VAL
000280 13   
000281 CD    0002M1 CALL    OSWRCH
000282 B1   
000283 05   
000284 3A    0001M1 LD      A, VAL
000285 00   
000286 52   
000287 CD    0002M1 CALL    OSWRCH
000288 B1   
000289 05   
00028A 3A    0001M1 LD      A, VAL
00028B 01   
00028C 52   
00028D CD    0002M1 CALL    OSWRCH
00028E B1   
00028F 05   
000290 3E    0001M1 LD      A, VAL
000291 00   
000292 CD    0002M1 CALL    OSWRCH
000293 B1   
000294 05   
000295 3E    0001M1 LD      A, VAL
000296 00   
000297 CD    0002M1 CALL    OSWRCH
000298 B1   
000299 05   
00029A 3E    0001M1 LD      A, VAL
00029B 00   
00029C CD    0002M1 CALL    OSWRCH
00029D B1   
00029E 05   
00029F C3      0773 JP	XEQ
0002A0 99   
0002A1 24   
0002A2 CD      0775 COLOUR_2:		CALL	COMMA
0002A3 A2   
0002A4 20   
0002A5 CD      0776 CALL	EXPRI			; Parse G
0002A6 33   
0002A7 18   
0002A8 D9      0777 EXX
0002A9 7D      0778 LD	A, L
0002AA 32      0779 LD	(VDU_BUFFER+2), A
0002AB 02   
0002AC 52   
0002AD CD      0780 CALL	COMMA
0002AE A2   
0002AF 20   
0002B0 CD      0781 CALL	EXPRI			; Parse B
0002B1 33   
0002B2 18   
0002B3 D9      0782 EXX
0002B4 7D      0783 LD	A, L
0002B5 32      0784 LD	(VDU_BUFFER+3), A
0002B6 03   
0002B7 52   
0002B8 3E    0001M1 LD      A, VAL
0002B9 13   
0002BA CD    0002M1 CALL    OSWRCH
0002BB B1   
0002BC 05   
0002BD 3A    0001M1 LD      A, VAL
0002BE 00   
0002BF 52   
0002C0 CD    0002M1 CALL    OSWRCH
0002C1 B1   
0002C2 05   
0002C3 3E    0001M1 LD      A, VAL
0002C4 FF   
0002C5 CD    0002M1 CALL    OSWRCH
0002C6 B1   
0002C7 05   
0002C8 3A    0001M1 LD      A, VAL
0002C9 01   
0002CA 52   
0002CB CD    0002M1 CALL    OSWRCH
0002CC B1   
0002CD 05   
0002CE 3A    0001M1 LD      A, VAL
0002CF 02   
0002D0 52   
0002D1 CD    0002M1 CALL    OSWRCH
0002D2 B1   
0002D3 05   
0002D4 3A    0001M1 LD      A, VAL
0002D5 03   
0002D6 52   
0002D7 CD    0002M1 CALL    OSWRCH
0002D8 B1   
0002D9 05   
0002DA C3      0791 JP	XEQ
0002DB 99   
0002DC 24   
0002DD             0794   ; --- Begin agon_gpio.asm ---
0002DD CD      0818 GPIOB_SETMODE:		CALL	SWITCH_A
0002DE 36   
0002DF 05   
0002E0 F4      0819 DW	GPIOB_M0	; Output
0002E1 02   
0002E2 19      0820 DW	GPIOB_M1	; Input
0002E3 03   
0002E4 39      0821 DW	GPIOB_M2	; Open Drain IO
0002E5 03   
0002E6 59      0822 DW	GPIOB_M3	; Open Source IO
0002E7 03   
0002E8 74      0823 DW	GPIOB_M4	; Interrupt, Dual Edge
0002E9 03   
0002EA A0      0824 DW	GPIOB_M5	; Alt Function
0002EB 03   
0002EC BB      0825 DW	GPIOB_M6	; Interrupt, Active Low
0002ED 03   
0002EE E2      0826 DW	GPIOB_M7	; Interrupt, Active High
0002EF 03   
0002F0 04      0827 DW	GPIOB_M8	; Interrupt, Falling Edge
0002F1 04   
0002F2 26      0828 DW	GPIOB_M9	; Interrupt, Rising Edge
0002F3 04   
0002F4 C5    0001M1 PUSH    BC
0002F5 78    0002M1 LD      A, VAL
0002F6 2F    0003M1 CPL
0002F7 4F    0004M1 LD      C, A
0002F8 ED    0005M1 IN0     A, (REG)
0002F9 38   
0002FA 9B   
0002FB A1    0006M1 AND     C
0002FC ED    0007M1 OUT0    (REG), A
0002FD 39   
0002FE 9B   
0002FF C1    0008M1 POP     BC
000300 C5    0001M1 PUSH    BC
000301 78    0002M1 LD      A, VAL
000302 2F    0003M1 CPL
000303 4F    0004M1 LD      C, A
000304 ED    0005M1 IN0     A, (REG)
000305 38   
000306 9C   
000307 A1    0006M1 AND     C
000308 ED    0007M1 OUT0    (REG), A
000309 39   
00030A 9C   
00030B C1    0008M1 POP     BC
00030C C5    0001M1 PUSH    BC
00030D 78    0002M1 LD      A, VAL
00030E 2F    0003M1 CPL
00030F 4F    0004M1 LD      C, A
000310 ED    0005M1 IN0     A, (REG)
000311 38   
000312 9D   
000313 A1    0006M1 AND     C
000314 ED    0007M1 OUT0    (REG), A
000315 39   
000316 9D   
000317 C1    0008M1 POP     BC
000318 C9      0835 RET
000319 ED    0001M1 IN0     A, (REG)
00031A 38   
00031B 9B   
00031C B0    0002M1 OR      VAL
00031D ED    0003M1 OUT0    (REG), A
00031E 39   
00031F 9B   
000320 C5    0001M1 PUSH    BC
000321 78    0002M1 LD      A, VAL
000322 2F    0003M1 CPL
000323 4F    0004M1 LD      C, A
000324 ED    0005M1 IN0     A, (REG)
000325 38   
000326 9C   
000327 A1    0006M1 AND     C
000328 ED    0007M1 OUT0    (REG), A
000329 39   
00032A 9C   
00032B C1    0008M1 POP     BC
00032C C5    0001M1 PUSH    BC
00032D 78    0002M1 LD      A, VAL
00032E 2F    0003M1 CPL
00032F 4F    0004M1 LD      C, A
000330 ED    0005M1 IN0     A, (REG)
000331 38   
000332 9D   
000333 A1    0006M1 AND     C
000334 ED    0007M1 OUT0    (REG), A
000335 39   
000336 9D   
000337 C1    0008M1 POP     BC
000338 C9      0842 RET
000339 C5    0001M1 PUSH    BC
00033A 78    0002M1 LD      A, VAL
00033B 2F    0003M1 CPL
00033C 4F    0004M1 LD      C, A
00033D ED    0005M1 IN0     A, (REG)
00033E 38   
00033F 9B   
000340 A1    0006M1 AND     C
000341 ED    0007M1 OUT0    (REG), A
000342 39   
000343 9B   
000344 C1    0008M1 POP     BC
000345 ED    0001M1 IN0     A, (REG)
000346 38   
000347 9C   
000348 B0    0002M1 OR      VAL
000349 ED    0003M1 OUT0    (REG), A
00034A 39   
00034B 9C   
00034C C5    0001M1 PUSH    BC
00034D 78    0002M1 LD      A, VAL
00034E 2F    0003M1 CPL
00034F 4F    0004M1 LD      C, A
000350 ED    0005M1 IN0     A, (REG)
000351 38   
000352 9D   
000353 A1    0006M1 AND     C
000354 ED    0007M1 OUT0    (REG), A
000355 39   
000356 9D   
000357 C1    0008M1 POP     BC
000358 C9      0849 RET
000359 ED    0001M1 IN0     A, (REG)
00035A 38   
00035B 9B   
00035C B0    0002M1 OR      VAL
00035D ED    0003M1 OUT0    (REG), A
00035E 39   
00035F 9B   
000360 ED    0001M1 IN0     A, (REG)
000361 38   
000362 9C   
000363 B0    0002M1 OR      VAL
000364 ED    0003M1 OUT0    (REG), A
000365 39   
000366 9C   
000367 C5    0001M1 PUSH    BC
000368 78    0002M1 LD      A, VAL
000369 2F    0003M1 CPL
00036A 4F    0004M1 LD      C, A
00036B ED    0005M1 IN0     A, (REG)
00036C 38   
00036D 9D   
00036E A1    0006M1 AND     C
00036F ED    0007M1 OUT0    (REG), A
000370 39   
000371 9D   
000372 C1    0008M1 POP     BC
000373 C9      0856 RET
000374 ED    0001M1 IN0     A, (REG)
000375 38   
000376 9A   
000377 B0    0002M1 OR      VAL
000378 ED    0003M1 OUT0    (REG), A
000379 39   
00037A 9A   
00037B C5    0001M1 PUSH    BC
00037C 78    0002M1 LD      A, VAL
00037D 2F    0003M1 CPL
00037E 4F    0004M1 LD      C, A
00037F ED    0005M1 IN0     A, (REG)
000380 38   
000381 9B   
000382 A1    0006M1 AND     C
000383 ED    0007M1 OUT0    (REG), A
000384 39   
000385 9B   
000386 C1    0008M1 POP     BC
000387 C5    0001M1 PUSH    BC
000388 78    0002M1 LD      A, VAL
000389 2F    0003M1 CPL
00038A 4F    0004M1 LD      C, A
00038B ED    0005M1 IN0     A, (REG)
00038C 38   
00038D 9C   
00038E A1    0006M1 AND     C
00038F ED    0007M1 OUT0    (REG), A
000390 39   
000391 9C   
000392 C1    0008M1 POP     BC
000393 C5    0001M1 PUSH    BC
000394 78    0002M1 LD      A, VAL
000395 2F    0003M1 CPL
000396 4F    0004M1 LD      C, A
000397 ED    0005M1 IN0     A, (REG)
000398 38   
000399 9D   
00039A A1    0006M1 AND     C
00039B ED    0007M1 OUT0    (REG), A
00039C 39   
00039D 9D   
00039E C1    0008M1 POP     BC
00039F C9      0864 RET
0003A0 ED    0001M1 IN0     A, (REG)
0003A1 38   
0003A2 9B   
0003A3 B0    0002M1 OR      VAL
0003A4 ED    0003M1 OUT0    (REG), A
0003A5 39   
0003A6 9B   
0003A7 C5    0001M1 PUSH    BC
0003A8 78    0002M1 LD      A, VAL
0003A9 2F    0003M1 CPL
0003AA 4F    0004M1 LD      C, A
0003AB ED    0005M1 IN0     A, (REG)
0003AC 38   
0003AD 9C   
0003AE A1    0006M1 AND     C
0003AF ED    0007M1 OUT0    (REG), A
0003B0 39   
0003B1 9C   
0003B2 C1    0008M1 POP     BC
0003B3 ED    0001M1 IN0     A, (REG)
0003B4 38   
0003B5 9D   
0003B6 B0    0002M1 OR      VAL
0003B7 ED    0003M1 OUT0    (REG), A
0003B8 39   
0003B9 9D   
0003BA C9      0871 RET
0003BB C5    0001M1 PUSH    BC
0003BC 78    0002M1 LD      A, VAL
0003BD 2F    0003M1 CPL
0003BE 4F    0004M1 LD      C, A
0003BF ED    0005M1 IN0     A, (REG)
0003C0 38   
0003C1 9A   
0003C2 A1    0006M1 AND     C
0003C3 ED    0007M1 OUT0    (REG), A
0003C4 39   
0003C5 9A   
0003C6 C1    0008M1 POP     BC
0003C7 C5    0001M1 PUSH    BC
0003C8 78    0002M1 LD      A, VAL
0003C9 2F    0003M1 CPL
0003CA 4F    0004M1 LD      C, A
0003CB ED    0005M1 IN0     A, (REG)
0003CC 38   
0003CD 9B   
0003CE A1    0006M1 AND     C
0003CF ED    0007M1 OUT0    (REG), A
0003D0 39   
0003D1 9B   
0003D2 C1    0008M1 POP     BC
0003D3 ED    0001M1 IN0     A, (REG)
0003D4 38   
0003D5 9C   
0003D6 B0    0002M1 OR      VAL
0003D7 ED    0003M1 OUT0    (REG), A
0003D8 39   
0003D9 9C   
0003DA ED    0001M1 IN0     A, (REG)
0003DB 38   
0003DC 9D   
0003DD B0    0002M1 OR      VAL
0003DE ED    0003M1 OUT0    (REG), A
0003DF 39   
0003E0 9D   
0003E1 C9      0879 RET
0003E2 ED    0001M1 IN0     A, (REG)
0003E3 38   
0003E4 9A   
0003E5 B0    0002M1 OR      VAL
0003E6 ED    0003M1 OUT0    (REG), A
0003E7 39   
0003E8 9A   
0003E9 C5    0001M1 PUSH    BC
0003EA 78    0002M1 LD      A, VAL
0003EB 2F    0003M1 CPL
0003EC 4F    0004M1 LD      C, A
0003ED ED    0005M1 IN0     A, (REG)
0003EE 38   
0003EF 9B   
0003F0 A1    0006M1 AND     C
0003F1 ED    0007M1 OUT0    (REG), A
0003F2 39   
0003F3 9B   
0003F4 C1    0008M1 POP     BC
0003F5 ED    0001M1 IN0     A, (REG)
0003F6 38   
0003F7 9C   
0003F8 B0    0002M1 OR      VAL
0003F9 ED    0003M1 OUT0    (REG), A
0003FA 39   
0003FB 9C   
0003FC ED    0001M1 IN0     A, (REG)
0003FD 38   
0003FE 9D   
0003FF B0    0002M1 OR      VAL
000400 ED    0003M1 OUT0    (REG), A
000401 39   
000402 9D   
000403 C9      0888 RET
000404 C5    0001M1 PUSH    BC
000405 78    0002M1 LD      A, VAL
000406 2F    0003M1 CPL
000407 4F    0004M1 LD      C, A
000408 ED    0005M1 IN0     A, (REG)
000409 38   
00040A 9A   
00040B A1    0006M1 AND     C
00040C ED    0007M1 OUT0    (REG), A
00040D 39   
00040E 9A   
00040F C1    0008M1 POP     BC
000410 ED    0001M1 IN0     A, (REG)
000411 38   
000412 9B   
000413 B0    0002M1 OR      VAL
000414 ED    0003M1 OUT0    (REG), A
000415 39   
000416 9B   
000417 ED    0001M1 IN0     A, (REG)
000418 38   
000419 9C   
00041A B0    0002M1 OR      VAL
00041B ED    0003M1 OUT0    (REG), A
00041C 39   
00041D 9C   
00041E ED    0001M1 IN0     A, (REG)
00041F 38   
000420 9D   
000421 B0    0002M1 OR      VAL
000422 ED    0003M1 OUT0    (REG), A
000423 39   
000424 9D   
000425 C9      0897 RET
000426 ED    0001M1 IN0     A, (REG)
000427 38   
000428 9A   
000429 B0    0002M1 OR      VAL
00042A ED    0003M1 OUT0    (REG), A
00042B 39   
00042C 9A   
00042D ED    0001M1 IN0     A, (REG)
00042E 38   
00042F 9B   
000430 B0    0002M1 OR      VAL
000431 ED    0003M1 OUT0    (REG), A
000432 39   
000433 9B   
000434 ED    0001M1 IN0     A, (REG)
000435 38   
000436 9C   
000437 B0    0002M1 OR      VAL
000438 ED    0003M1 OUT0    (REG), A
000439 39   
00043A 9C   
00043B ED    0001M1 IN0     A, (REG)
00043C 38   
00043D 9D   
00043E B0    0002M1 OR      VAL
00043F ED    0003M1 OUT0    (REG), A
000440 39   
000441 9D   
000442 C9      0905 RET
000443             0908   ; --- Begin agon_interrupt.asm ---
000443 F3      0937 VBLANK_INIT:		DI
000444 ED      0939 LD		A, MB 				; Get a 24-bit pointer to
000445 6E   
000446 21      0940 LD		HL, VBLANK_HANDLER		; this interrupt handler routine who's
000447 C1   
000448 04   
000449 CD      0941 CALL		SET_AHL16 			; address is a 16-bit pointer in BBC BASIC's segment
00044A 83   
00044B 04   
00044C 1E      0943 LD		E, 32h				; Set up the VBlank Interrupt Vector
00044D 32   
00044E 3E    0001M1 LD	A, function
00044F 14   
000450 49    0002M1 RST.LIS	08h
000451 CF   
000452 5B      0946 PUSH.LIL	HL				; HLU: Pointer to the MOS interrupt vector
000453 E5   
000454 5B      0947 POP.LIL		DE 				; DEU: Pointer to the MOS interrupt vector
000455 D1   
000456 21      0949 LD		HL, VBLANK_HANDLER_JP + 1	; Pointer to the JP address in this segment
000457 D9   
000458 04   
000459 ED      0950 LD		A, MB	 			; Get the segment BBC BASIC is running in
00045A 6E   
00045B 32      0951 LD		(VBLANK_HANDLER_MB + 1), A 	; Store in the interrupt handler
00045C CA   
00045D 04   
00045E CD      0952 CALL		SET_AHL16 			; Convert pointer to an absolute 24-bit address
00045F 83   
000460 04   
000461 5B      0953 LD.LIL		(HL), DE			; Self-modify the code
000462 ED   
000463 1F   
000464 FB      0954 EI
000465 C9      0955 RET
000466 F3      0959 VBLANK_STOP:		DI
000467 21      0960 LD		HL, VBLANK_HANDLER_JP + 1	; Pointer to the JP address in this segment
000468 D9   
000469 04   
00046A 3A      0961 LD		A, (VBLANK_HANDLER_MB + 1)	; The stored MB of the segment BBC BASIC is running in
00046B CA   
00046C 04   
00046D F5      0962 PUSH		AF 				; Stack the MB for later
00046E CD      0963 CALL		SET_AHL16			; Convert pointer to an absolute 24-bit address
00046F 83   
000470 04   
000471 5B      0964 LD.LIL		DE, (HL)			; DEU: Address of MOS interrupt vector
000472 ED   
000473 17   
000474 5B      0965 PUSH.LIL	DE				; Transfer to HL
000475 D5   
000476 5B      0966 POP.LIL		HL
000477 E1   
000478 1E      0967 LD		E, 32h
000479 32   
00047A 3E    0001M1 LD	A, function
00047B 14   
00047C 49    0002M1 RST.LIS	08h
00047D CF   
00047E F1      0969 POP		AF 				; Restore MB to this segment
00047F ED      0970 LD		MB, A
000480 6D   
000481 FB      0971 EI
000482 C9      0972 RET
000483 5B      0976 SET_AHL16:		PUSH.LIL	HL
000484 E5   
000485 5B      0977 LD.LIL		HL, 2
000486 21   
000487 02   
000488 00   
000489 00   
00048A 5B      0978 ADD.LIL		HL, SP
00048B 39   
00048C 5B      0979 LD.LIL		(HL), A
00048D 77   
00048E 5B      0980 POP.LIL		HL
00048F E1   
000490 C9      0981 RET
000491 3E    0001M1 LD	A, function
000492 08   
000493 49    0002M1 RST.LIS	08h
000494 CF   
000495 21      0986 LD		HL, KEYCOUNT 			; Check whether the keycount has changed
000496 16   
000497 51   
000498 5B      0987 LD.LIL		A, (IX + sysvar_vkeycount)	; by comparing the MOS copy
000499 DD   
00049A 7E   
00049B 19   
00049C BE      0988 CP 		(HL)				; with our local copy
00049D 20      0989 JR		NZ, DO_KEYBOARD_1		; Yes it has, so jump to the next bit
00049E 09   
00049F AF      0991 DO_KEYBOARD_0:		XOR		A 				; Clear the keyboard values
0004A0 32      0992 LD		(KEYASCII), A
0004A1 15   
0004A2 51   
0004A3 32      0993 LD		(KEYDOWN), A
0004A4 14   
0004A5 51   
0004A6 5B      0994 RET.LIL 					; And return
0004A7 C9   
0004A8 77      0996 DO_KEYBOARD_1:		LD		(HL), A 			; Store the updated local copy of keycount
0004A9 5B      0997 LD.LIL		A, (IX + sysvar_vkeydown)	; Fetch key down value (1 = key down, 0 = key up)
0004AA DD   
0004AB 7E   
0004AC 18   
0004AD B7      0998 OR		A
0004AE 28      0999 JR		Z, DO_KEYBOARD_0		; If it is key up, then clear the keyboard values
0004AF EF   
0004B0 32      1001 LD		(KEYDOWN), A 			; Store the keydown value
0004B1 14   
0004B2 51   
0004B3 5B      1002 LD.LIL		A, (IX + sysvar_keyascii)	; Fetch key ASCII value
0004B4 DD   
0004B5 7E   
0004B6 05   
0004B7 32      1003 LD		(KEYASCII), A 			; Store locally
0004B8 15   
0004B9 51   
0004BA FE      1004 CP		1Bh				; Is it escape?
0004BB 1B   
0004BC CC      1005 CALL		Z, ESCSET			; Yes, so set the escape flags
0004BD 16   
0004BE 06   
0004BF 49      1006 RET.LIS						; Return to the interrupt handler
0004C0 C9   
0004C1 F3      1013 VBLANK_HANDLER:		DI
0004C2 F5      1014 PUSH		AF
0004C3 E5      1015 PUSH		HL
0004C4 DD      1016 PUSH		IX
0004C5 E5   
0004C6 ED      1017 LD		A, MB
0004C7 6E   
0004C8 F5      1018 PUSH		AF
0004C9 3E      1019 VBLANK_HANDLER_MB:	LD		A, 0				; This is self-modified by VBLANK_INIT
0004CA 00   
0004CB ED      1020 LD		MB, A
0004CC 6D   
0004CD 49      1021 CALL.LIS	DO_KEYBOARD
0004CE CD   
0004CF 91   
0004D0 04   
0004D1 F1      1022 POP		AF
0004D2 ED      1023 LD		MB, A
0004D3 6D   
0004D4 DD      1024 POP		IX
0004D5 E1   
0004D6 E1      1025 POP		HL
0004D7 F1      1026 POP		AF
0004D8 C3      1030 VBLANK_HANDLER_JP:	JP		0				; This is self-modified by VBLANK_INIT
0004D9 00   
0004DA 00   
0004DB 00   
0004DC             1033   ; --- Begin agon_misc.asm ---
0004DC C5      1072 ASC_TO_NUMBER:		PUSH	BC			; Preserve BC
0004DD 11      1073 LD	DE, 0			; Initialise DE
0004DE 00   
0004DF 00   
0004E0 CD      1074 CALL	SKIPSPmisc			; Skip whitespace
0004E1 20   
0004E2 05   
0004E3 7E      1075 LD	A, (HL)			; Read first character
0004E4 FE      1076 CP	'&'			; Is it prefixed with '&' (HEX number)?
0004E5 26   
0004E6 20      1077 JR	NZ, ASC_TO_NUMBER3	; Jump to decimal parser if not
0004E7 1E   
0004E8 23      1078 INC	HL			; Otherwise fall through to ASC_TO_HEX
0004E9 7E      1080 ASC_TO_NUMBER1:		LD	A, (HL)			; Fetch the character
0004EA CD      1081 CALL    UPPRCmisc			; Convert to uppercase
0004EB 2E   
0004EC 05   
0004ED D6      1082 SUB	'0'			; Normalise to 0
0004EE 30   
0004EF 38      1083 JR 	C, ASC_TO_NUMBER4	; Return if < ASCII '0'
0004F0 2E   
0004F1 FE      1084 CP 	10			; Check if >= 10
0004F2 0A   
0004F3 38      1085 JR 	C,ASC_TO_NUMBER2	; No, so skip next bit
0004F4 06   
0004F5 D6      1086 SUB 	7			; Adjust ASCII A-F to nibble
0004F6 07   
0004F7 FE      1087 CP 	16			; Check for > F
0004F8 10   
0004F9 30      1088 JR 	NC, ASC_TO_NUMBER4	; Return if out of range
0004FA 24   
0004FB EB      1089 ASC_TO_NUMBER2:		EX 	DE, HL 			; Shift DE left 4 times
0004FC 29      1090 ADD	HL, HL
0004FD 29      1091 ADD	HL, HL
0004FE 29      1092 ADD	HL, HL
0004FF 29      1093 ADD	HL, HL
000500 EB      1094 EX	DE, HL
000501 B3      1095 OR      E			; OR the new digit in to the least significant nibble
000502 5F      1096 LD      E, A
000503 23      1097 INC     HL			; Onto the next character
000504 18      1098 JR      ASC_TO_NUMBER1		; And loop
000505 E3   
000506 7E      1100 ASC_TO_NUMBER3:		LD	A, (HL)
000507 D6      1101 SUB	'0'			; Normalise to 0
000508 30   
000509 38      1102 JR	C, ASC_TO_NUMBER4	; Return if < ASCII '0'
00050A 14   
00050B FE      1103 CP	10			; Check if >= 10
00050C 0A   
00050D 30      1104 JR	NC, ASC_TO_NUMBER4	; Return if >= 10
00050E 10   
00050F EB      1105 EX 	DE, HL 			; Stick DE in HL
000510 44      1106 LD	B, H 			; And copy HL into BC
000511 4D      1107 LD	C, L
000512 29      1108 ADD	HL, HL 			; x 2
000513 29      1109 ADD	HL, HL 			; x 4
000514 09      1110 ADD	HL, BC 			; x 5
000515 29      1111 ADD	HL, HL 			; x 10
000516 EB      1112 EX	DE, HL
000517 83    0001M1 ADD     A, E
000518 5F    0002M1 LD      E, A
000519 8A    0003M1 ADC     A, D
00051A 93    0004M1 SUB     E
00051B 57    0005M1 LD      D, A
00051C 23      1114 INC	HL
00051D 18      1115 JR	ASC_TO_NUMBER3
00051E E7   
00051F C1      1116 ASC_TO_NUMBER4:		POP	BC 			; Fall through to SKIPSP here
000520 7E      1121 SKIPSPmisc:			LD      A, (HL)
000521 FE      1122 CP      ' '
000522 20   
000523 C0      1123 RET     NZ
000524 23      1124 INC     HL
000525 18      1125 JR      SKIPSPmisc
000526 F9   
000527 7E      1130 SKIPNOTSP:		LD	A, (HL)
000528 FE      1131 CP	' '
000529 20   
00052A C8      1132 RET	Z
00052B 23      1133 INC	HL
00052C 18      1134 JR	SKIPNOTSP
00052D F9   
00052E E6      1139 UPPRCmisc:  		AND     7FH
00052F 7F   
000530 FE      1140 CP      '`'
000531 60   
000532 D8      1141 RET     C
000533 E6      1142 AND     5FH			; Convert to upper case
000534 5F   
000535 C9      1143 RET
000536 E3      1148 SWITCH_A:		EX	(SP), HL		; Swap HL with the contents of the top of the stack
000537 87      1149 ADD	A, A			; Multiply A by two
000538 85    0001M1 ADD     A, L
000539 6F    0002M1 LD      L, A
00053A 8C    0003M1 ADC     A, H
00053B 95    0004M1 SUB     L
00053C 67    0005M1 LD      H, A
00053D 7E      1151 LD	A, (HL)			; follow the call. Fetch an address from the
00053E 23      1152 INC	HL 			; table.
00053F 66      1153 LD	H, (HL)
000540 6F      1154 LD	L, A
000541 E3      1155 EX	(SP), HL		; Swap this new address back, restores HL
000542 C9      1156 RET				; Return program control to this new address
000543 C5      1161 NULLTOCR:		PUSH 	BC
000544 06      1162 LD	B, 0
000545 00   
000546 0E      1163 LD	C, CR
000547 0D   
000548 18      1164 JR	CRTONULL0
000549 05   
00054A C5      1166 CRTONULL:		PUSH	BC
00054B 06      1167 LD	B, CR
00054C 0D   
00054D 0E      1168 LD	C, 0
00054E 00   
00054F E5      1170 CRTONULL0:		PUSH	HL
000550 7E      1171 CRTONULL1:		LD	A, (HL)
000551 B8      1172 CP 	B
000552 28      1173 JR	Z, CRTONULL2
000553 03   
000554 23      1174 INC	HL
000555 18      1175 JR	CRTONULL1
000556 F9   
000557 71      1176 CRTONULL2:		LD	(HL), C
000558 E1      1177 POP 	HL
000559 C1      1178 POP	BC
00055A C9      1179 RET
00055B 7E      1185 CSTR_FNAME:		LD	A, (HL)			; Get source
00055C FE      1186 CP	32			; Is it space
00055D 20   
00055E 28      1187 JR	Z, @F
00055F 09   
000560 FE      1188 CP	CR			; Or is it CR
000561 0D   
000562 28      1189 JR	Z, @F
000563 05   
000564 12      1190 LD	(DE), A			; No, so store
000565 23      1191 INC	HL			; Increment
000566 13      1192 INC	DE
000567 18      1193 JR	CSTR_FNAME		; And loop
000568 F2   
000569 AF      1194 @@:			XOR	A			; Zero terminate the target string
00056A 12      1195 LD	(DE), A
00056B 13      1196 INC	DE			; And point to next free address
00056C C9      1197 RET
00056D 7E      1203 CSTR_LINE:		LD	A, (HL)			; Get source
00056E FE      1204 CP	CR			; Is it CR
00056F 0D   
000570 28      1205 JR	Z, @F
000571 05   
000572 12      1206 LD	(DE), A			; No, so store
000573 23      1207 INC	HL			; Increment
000574 13      1208 INC	DE
000575 18      1209 JR	CSTR_LINE		; And loop
000576 F6   
000577 AF      1210 @@:			XOR	A			; Zero terminate the target string
000578 12      1211 LD	(DE), A
000579 13      1212 INC	DE			; And point to next free address
00057A C9      1213 RET
00057B 7E      1221 CSTR_FINDCH:		LD	A, (HL)			; Get source
00057C B9      1222 CP	C			; Is it our character?
00057D C8      1223 RET	Z			; Yes, so exit
00057E B7      1224 OR	A			; Is it the end of string?
00057F C8      1225 RET	Z			; Yes, so exit
000580 23      1226 INC	HL
000581 18      1227 JR	CSTR_FINDCH
000582 F8   
000583 7E      1235 CSTR_ENDSWITH:		LD	A, (HL)			; Get the source string byte
000584 CD      1236 CALL	UPPRCmisc			; Convert to upper case
000585 2E   
000586 05   
000587 4F      1237 LD	C, A
000588 1A      1238 LD	A, (DE)			; Get the substring byte
000589 B9      1239 CP	C
00058A C0      1240 RET	NZ			; Return NZ if at any point the strings don't match
00058B B1      1241 OR	C			; Check whether both bytes are zero
00058C C8      1242 RET	Z			; If so, return, as we have reached the end of both strings
00058D 23      1243 INC	HL
00058E 13      1244 INC	DE
00058F 18      1245 JR	CSTR_ENDSWITH		; And loop
000590 F2   
000591 7E      1251 CSTR_CAT:		LD	A, (HL)			; Loop until we find the end of the first string
000592 B7      1252 OR	A
000593 28      1253 JR	Z, CSTR_CAT_1
000594 03   
000595 23      1254 INC	HL
000596 18      1255 JR	CSTR_CAT
000597 F9   
000598 1A      1257 CSTR_CAT_1:		LD	A, (DE)			; Copy the second string onto the end of the first string
000599 77      1258 LD	(HL), A
00059A B7      1259 OR	A			; Check for end of string
00059B C8      1260 RET	Z			; And return
00059C 23      1261 INC	HL
00059D 13      1262 INC	DE
00059E 18      1263 JR	CSTR_CAT_1		; Loop until finished
00059F F8   
0005A0             1266   ; --- Begin agon_os.asm ---
0005A0 CD      1364 OSINIT:			CALL	VBLANK_INIT
0005A1 43   
0005A2 04   
0005A3 AF      1365 XOR	A
0005A4 32      1366 LD	(FLAGS), A		; Clear flags and set F = Z
0005A5 0F   
0005A6 51   
0005A7 21      1367 LD 	HL, USER
0005A8 00   
0005A9 55   
0005AA 11      1368 LD	DE, RAM_Top
0005AB 00   
0005AC FF   
0005AD 5F      1369 LD	E, A			; Page boundary
0005AE C9      1370 RET
0005AF 3E      1374 PROMPT: 		LD	A,'>'			; Falls through to OSWRCH
0005B0 3E   
0005B1 E5      1380 OSWRCH:			PUSH	HL
0005B2 21      1381 LD	HL, LISTON		; Fetch the LISTON variable
0005B3 FE   
0005B4 54   
0005B5 CB      1382 BIT	3, (HL)			; Check whether we are in *EDIT mode
0005B6 5E   
0005B7 20      1383 JR	NZ, OSWRCH_BUFFER	; Yes, so just output to buffer
0005B8 0A   
0005B9 2A      1385 LD	HL, (OSWRCHCH)		; L: Channel #
0005BA 12   
0005BB 51   
0005BC 2D      1386 DEC	L			; If it is 1
0005BD 28      1387 JR	Z, OSWRCH_FILE		; Then we are outputting to a file
0005BE 17   
0005BF E1      1389 POP	HL			; Otherwise
0005C0 49      1390 RST.LIS	10h			; Output the character to MOS
0005C1 D7   
0005C2 C9      1391 RET
0005C3 2A      1393 OSWRCH_BUFFER:		LD	HL, (OSWRCHPT)		; Fetch the pointer buffer
0005C4 10   
0005C5 51   
0005C6 FE      1394 CP	0AH			; Just ignore this
0005C7 0A   
0005C8 28      1395 JR	Z, OSWRCH_BUFFER2
0005C9 0A   
0005CA FE      1396 CP	0DH			; Is it the end of line?
0005CB 0D   
0005CC 20      1397 JR	NZ, OSWRCH_BUFFER1	; No, so carry on
0005CD 01   
0005CE AF      1398 XOR	A			; Turn it into a NUL character
0005CF 77      1399 OSWRCH_BUFFER1:		LD	(HL), A			; Echo the character into the buffer
0005D0 23      1400 INC	HL			; Increment pointer
0005D1 22      1401 LD	(OSWRCHPT), HL		; Write pointer back
0005D2 10   
0005D3 51   
0005D4 E1      1402 OSWRCH_BUFFER2:		POP	HL
0005D5 C9      1403 RET
0005D6 D5      1405 OSWRCH_FILE:		PUSH	DE
0005D7 5C      1406 LD	E, H			; Filehandle to E
0005D8 CD      1407 CALL	OSBPUT			; Write the byte out
0005D9 63   
0005DA 06   
0005DB D1      1408 POP	DE
0005DC E1      1409 POP	HL
0005DD C9      1410 RET
0005DE 3E    0001M1 LD	A, function
0005DF 00   
0005E0 49    0002M1 RST.LIS	08h
0005E1 CF   
0005E2 FE      1415 CP	1Bh
0005E3 1B   
0005E4 28      1416 JR	Z, LTRAP1
0005E5 55   
0005E6 C9      1417 RET
0005E7 1E      1421 OSLINE:			LD 	E, 1			; Default is to clear the buffer
0005E8 01   
0005E9 FD      1430 OSLINE1:		PUSH	IY
0005EA E5   
0005EB E5      1431 PUSH	HL			; Buffer address
0005EC 01      1432 LD	BC, 256			; Buffer length
0005ED 00   
0005EE 01   
0005EF 3E    0001M1 LD	A, function
0005F0 09   
0005F1 49    0002M1 RST.LIS	08h
0005F2 CF   
0005F3 E1      1434 POP	HL			; Pop the address
0005F4 FD      1435 POP	IY
0005F5 E1   
0005F6 F5      1436 PUSH	AF			; Stack the return value (key pressed)
0005F7 CD      1437 CALL	NULLTOCR		; Turn the 0 character to a CR
0005F8 43   
0005F9 05   
0005FA CD      1438 CALL	CRLF			; Display CRLF
0005FB FB   
0005FC 40   
0005FD F1      1439 POP	AF
0005FE FE      1440 CP	1Bh 			; Check if ESC terminated the input
0005FF 1B   
000600 CA      1441 JP	Z, LTRAP1 		; Yes, so do the ESC thing
000601 3B   
000602 06   
000603 3A      1442 LD	A, (FLAGS)		; Otherwise
000604 0F   
000605 51   
000606 CB      1443 RES	7, A 			; Clear the escape flag
000607 BF   
000608 32      1444 LD	(FLAGS), A
000609 0F   
00060A 51   
00060B CD      1445 CALL	WAIT_VBLANK 		; Wait a frame
00060C 8B   
00060D 0A   
00060E AF      1446 XOR	A			; Return A = 0
00060F 32      1447 LD	(KEYDOWN), A
000610 14   
000611 51   
000612 32      1448 LD	(KEYASCII), A
000613 15   
000614 51   
000615 C9      1449 RET
000616 E5      1455 ESCSET: 		PUSH    HL
000617 21      1456 LD      HL,FLAGS		; Pointer to FLAGS
000618 0F   
000619 51   
00061A CB      1457 BIT     6,(HL)			; If bit 6 is set, then
00061B 76   
00061C 20      1458 JR      NZ,ESCDIS		; escape is disabled, so skip
00061D 02   
00061E CB      1459 SET     7,(HL)			; Set bit 7, the escape flag
00061F FE   
000620 E1      1460 ESCDIS: 		POP     HL
000621 C9      1461 RET
000622 CD      1467 ESCTEST:		CALL	READKEY			; Read the keyboard
000623 2B   
000624 06   
000625 C0      1468 RET	NZ			; Skip if no key is pressed
000626 FE      1469 CP	1BH			; If ESC pressed then
000627 1B   
000628 28      1470 JR	Z,ESCSET		; jump to the escape set routine
000629 EC   
00062A C9      1471 RET
00062B 3A      1478 READKEY:		LD	A, (KEYDOWN)		; Get key down
00062C 14   
00062D 51   
00062E 3D      1479 DEC	A 			; Set Z flag if keydown is 1
00062F 3A      1480 LD	A, (KEYASCII)		; Get key ASCII value
000630 15   
000631 51   
000632 C9      1481 RET
000633 CD      1486 TRAP:			CALL	ESCTEST			; Read keyboard, test for ESC, set FLAGS
000634 22   
000635 06   
000636 3A      1488 LTRAP:			LD	A,(FLAGS)		; Get FLAGS
000637 0F   
000638 51   
000639 B7      1489 OR	A			; This checks for bit 7; if it is not set then the result will
00063A F0      1490 RET	P			; be positive (bit 7 is the sign bit in Z80), so return
00063B 21      1491 LTRAP1:			LD	HL,FLAGS 		; Escape is pressed at this point, so
00063C 0F   
00063D 51   
00063E CB      1492 RES	7,(HL)			; Clear the escape pressed flag and
00063F BE   
000640 C3      1493 JP	ESCAPE			; Jump to the ESCAPE error routine in exec.asm
000641 E3   
000642 25   
000643 C9      1497 RESET:			RET				; Yes this is fine
000644 0E      1508 OSOPEN:			LD	C, fa_read
000645 01   
000646 28      1509 JR	Z, @F
000647 06   
000648 0E      1510 LD	C, fa_write | fa_open_append
000649 32   
00064A 38      1511 JR	C, @F
00064B 02   
00064C 0E      1512 LD	C, fa_write | fa_create_always
00064D 0A   
00064E 3E    0001M1 LD	A, function
00064F 0A   
000650 49    0002M1 RST.LIS	08h
000651 CF   
000652 C9      1514 RET
000653 C5      1521 OSSHUT:			PUSH	BC
000654 4B      1522 LD	C, E
000655 3E    0001M1 LD	A, function
000656 0B   
000657 49    0002M1 RST.LIS	08h
000658 CF   
000659 C1      1524 POP	BC
00065A C9      1525 RET
00065B C5      1534 OSBGET:			PUSH	BC
00065C 4B      1535 LD	C, E
00065D 3E    0001M1 LD	A, function
00065E 0C   
00065F 49    0002M1 RST.LIS	08h
000660 CF   
000661 C1      1537 POP	BC
000662 C9      1538 RET
000663 C5      1545 OSBPUT:			PUSH	BC
000664 4B      1546 LD	C, E
000665 47      1547 LD	B, A
000666 3E    0001M1 LD	A, function
000667 0D   
000668 49    0002M1 RST.LIS	08h
000669 CF   
00066A C1      1549 POP	BC
00066B C9      1550 RET
00066C C5      1559 OSSTAT:			PUSH	BC
00066D 4B      1560 LD	C, E
00066E 3E    0001M1 LD	A, function
00066F 0E   
000670 49    0002M1 RST.LIS	08h
000671 CF   
000672 C1      1562 POP	BC
000673 FE      1563 CP	1
000674 01   
000675 C9      1564 RET
000676 FD      1572 GETPTR:			PUSH		IY
000677 E5   
000678 4B      1573 LD		C, E
000679 3E    0001M1 LD	A, function
00067A 19   
00067B 49    0002M1 RST.LIS	08h
00067C CF   
00067D 5B      1575 PUSH.LIL	HL
00067E E5   
00067F 5B      1576 POP.LIL		IY		; IYU: Pointer to FIL structure
000680 FD   
000681 E1   
000682 5B      1577 LD.LIL		L, (IY + FIL.fptr + 0)
000683 FD   
000684 6E   
000685 11   
000686 5B      1578 LD.LIL		H, (IY + FIL.fptr + 1)
000687 FD   
000688 66   
000689 12   
00068A 5B      1579 LD.LIL		E, (IY + FIL.fptr + 2)
00068B FD   
00068C 5E   
00068D 13   
00068E 5B      1580 LD.LIL		D, (IY + FIL.fptr + 3)
00068F FD   
000690 56   
000691 14   
000692 FD      1581 POP		IY
000693 E1   
000694 C9      1582 RET
000695 FD      1589 PUTPTR:			PUSH		IY
000696 E5   
000697 4F      1590 LD		C, A  		; C: Filehandle
000698 5B      1591 PUSH.LIL	HL
000699 E5   
00069A 5B      1592 LD.LIL		HL, 2
00069B 21   
00069C 02   
00069D 00   
00069E 00   
00069F 5B      1593 ADD.LIL		HL, SP
0006A0 39   
0006A1 5B      1594 LD.LIL		(HL), E 	; 3rd byte of DWORD set to E
0006A2 73   
0006A3 5B      1595 POP.LIL		HL
0006A4 E1   
0006A5 5A      1596 LD		E, D  		; 4th byte passed as E
0006A6 3E    0001M1 LD	A, function
0006A7 1C   
0006A8 49    0002M1 RST.LIS	08h
0006A9 CF   
0006AA FD      1598 POP		IY
0006AB E1   
0006AC C9      1599 RET
0006AD FD      1607 GETEXT:			PUSH		IY
0006AE E5   
0006AF 4B      1608 LD		C, E
0006B0 3E    0001M1 LD	A, function
0006B1 19   
0006B2 49    0002M1 RST.LIS	08h
0006B3 CF   
0006B4 5B      1610 PUSH.LIL	HL
0006B5 E5   
0006B6 5B      1611 POP.LIL		IY		; IYU: Pointer to FIL structure
0006B7 FD   
0006B8 E1   
0006B9 5B      1612 LD.LIL		L, (IY + FIL.obj.objsize + 0)
0006BA FD   
0006BB 6E   
0006BC 24   
0006BD 5B      1613 LD.LIL		H, (IY + FIL.obj.objsize + 1)
0006BE FD   
0006BF 66   
0006C0 25   
0006C1 5B      1614 LD.LIL		E, (IY + FIL.obj.objsize + 2)
0006C2 FD   
0006C3 5E   
0006C4 26   
0006C5 5B      1615 LD.LIL		D, (IY + FIL.obj.objsize + 3)
0006C6 FD   
0006C7 56   
0006C8 27   
0006C9 FD      1616 POP		IY
0006CA E1   
0006CB C9      1617 RET
0006CC C5      1626 OSLOAD:			PUSH	BC			; Stack the size
0006CD D5      1627 PUSH	DE			; Stack the load address
0006CE 11      1628 LD	DE, ACCS		; Buffer address for filename
0006CF 00   
0006D0 52   
0006D1 CD      1629 CALL	CSTR_FNAME		; Fetch filename from MOS into buffer
0006D2 5B   
0006D3 05   
0006D4 21      1630 LD	HL, ACCS		; HL: Filename
0006D5 00   
0006D6 52   
0006D7 CD      1631 CALL	EXT_DEFAULT		; Tack on the extension .BBC if not specified
0006D8 15   
0006D9 08   
0006DA CD      1632 CALL	EXT_HANDLER		; Get the default handler
0006DB 26   
0006DC 08   
0006DD D1      1633 POP	DE			; Restore the load address
0006DE C1      1634 POP	BC			; Restore the size
0006DF B7      1635 OR	A
0006E0 CA      1636 JP 	Z, OSLOAD_BBC
0006E1 A7   
0006E2 07   
0006E3 AF      1640 OSLOAD_TXT:		XOR	A			; Set file attributes to read
0006E4 CD      1641 CALL	OSOPEN			; Open the file
0006E5 44   
0006E6 06   
0006E7 5F      1642 LD 	E, A 			; The filehandle
0006E8 B7      1643 OR	A
0006E9 3E      1644 LD	A, 4			; File not found error
0006EA 04   
0006EB CA      1645 JP	Z, OSERROR		; Jump to error handler
0006EC AF   
0006ED 07   
0006EE CD      1646 CALL	NEWIT			; Call NEW to clear the program space
0006EF 3E   
0006F0 40   
0006F1 21      1648 OSLOAD_TXT1:		LD	HL, ACCS 		; Where the input is going to be stored
0006F2 00   
0006F3 52   
0006F4 CD      1652 @@:			CALL	OSBGET			; Read the byte into A
0006F5 5B   
0006F6 06   
0006F7 38      1653 JR	C, OSLOAD_TXT3		; Is it EOF?
0006F8 1C   
0006F9 FE      1654 CP	LF 			; Is it LF?
0006FA 0A   
0006FB 28      1655 JR	Z, OSLOAD_TXT3 		; Yes, so skip to the next line
0006FC 18   
0006FD FE      1656 CP	21h			; Is it less than or equal to ASCII space?
0006FE 21   
0006FF 38      1657 JR	C, @B 			; Yes, so keep looping
000700 F3   
000701 77      1658 LD	(HL), A 		; Store the first character
000702 2C      1659 INC	L
000703 CD      1663 OSLOAD_TXT2:		CALL	OSBGET			; Read the byte into A
000704 5B   
000705 06   
000706 38      1664 JR	C, OSLOAD_TXT4		; Is it EOF?
000707 26   
000708 FE      1665 CP	20h			; Skip if not an ASCII character
000709 20   
00070A 38      1666 JR	C, @F
00070B 05   
00070C 77      1667 LD	(HL), A 		; Store in the input buffer
00070D 2C      1668 INC	L			; Increment the buffer pointer
00070E CA      1669 JP	Z, BAD			; If the buffer is full (wrapped to 0) then jump to Bad Program error
00070F EF   
000710 3E   
000711 FE      1670 @@:			CP	LF			; Check for LF
000712 0A   
000713 20      1671 JR	NZ, OSLOAD_TXT2		; If not, then loop to read the rest of the characters in
000714 EE   
000715 36      1675 OSLOAD_TXT3:		LD	(HL), CR		; Store a CR for BBC BASIC
000716 0D   
000717 7D      1676 LD	A, L			; Check for minimum line length
000718 FE      1677 CP	2			; If it is 2 characters or less (including CR)
000719 02   
00071A 38      1678 JR	C, @F			; Then don't bother entering it
00071B 08   
00071C D5      1679 PUSH	DE			; Preserve the filehandle
00071D CD      1680 CALL	OSEDIT			; Enter the line in memory
00071E 39   
00071F 07   
000720 DC      1681 CALL	C,CLEAN			; If a new line has been entered, then call CLEAN to set TOP and write &FFFF end of program marker
000721 1A   
000722 40   
000723 D1      1682 POP	DE
000724 CD      1683 @@:			CALL	OSSTAT			; End of file?
000725 6C   
000726 06   
000727 20      1684 JR	NZ, OSLOAD_TXT1		; No, so loop
000728 C8   
000729 CD      1685 CALL	OSSHUT			; Close the file
00072A 53   
00072B 06   
00072C 37      1686 SCF				; Flag to BASIC that we're good
00072D C9      1687 RET
00072E FE      1691 OSLOAD_TXT4:		CP	20h			; Skip if not an ASCII character
00072F 20   
000730 38      1692 JR	C, @F
000731 05   
000732 77      1693 LD	(HL), A			; Store the character
000733 2C      1694 INC	L
000734 CA      1695 JP	Z, BAD
000735 EF   
000736 3E   
000737 18      1696 @@:			JR	OSLOAD_TXT3
000738 DC   
000739 AF      1703 OSEDIT:			XOR	A			; Entry point after *EDIT
00073A 32      1704 LD      (COUNT),A
00073B FB   
00073C 54   
00073D FD      1705 LD      IY,ACCS
00073E 21   
00073F 00   
000740 52   
000741 CD      1706 CALL    LINNUM			; HL: The line number from the input buffer
000742 8A   
000743 43   
000744 CD      1707 CALL    NXT			; Skip spaces
000745 0B   
000746 45   
000747 7C      1708 LD      A,H			; HL: The line number will be 0 for immediate mode or when auto line numbering is used
000748 B5      1709 OR      L
000749 28      1710 JR      Z,LNZERO        	; Skip if there is no line number in the input buffer
00074A 00   
00074B 11      1714 LNZERO:			LD	DE,BUFFER
00074C 00   
00074D 53   
00074E 0E      1715 LD	C,1			; LEFT MODE
00074F 01   
000750 E5      1716 PUSH	HL
000751 CD      1717 CALL	LEXAN2			; LEXICAL ANALYSIS
000752 18   
000753 44   
000754 E1      1718 POP	HL
000755 12      1719 LD	(DE),A			; TERMINATOR
000756 AF      1720 XOR	A
000757 47      1721 LD	B,A
000758 4B      1722 LD	C,E			; BC=LINE LENGTH
000759 13      1723 INC	DE
00075A 12      1724 LD	(DE),A			; ZERO NEXT
00075B 7C      1725 LD	A,H
00075C B5      1726 OR	L
00075D FD      1727 LD	IY,BUFFER		; FOR XEQ
00075E 21   
00075F 00   
000760 53   
000761 CA      1728 JP	Z,XEQ			; DIRECT MODE
000762 99   
000763 24   
000764 C5      1729 PUSH	BC
000765 CD      1730 CALL	FINDL
000766 43   
000767 41   
000768 CC      1731 CALL	Z,DEL
000769 E9   
00076A 3F   
00076B C1      1732 POP	BC
00076C 79      1733 LD	A,C
00076D B7      1734 OR	A
00076E C8      1735 RET	Z
00076F C6      1736 ADD	A,4
000770 04   
000771 4F      1737 LD	C,A			; LENGTH INCLUSIVE
000772 D5      1738 PUSH	DE			; LINE NUMBER
000773 C5      1739 PUSH	BC			; SAVE LINE LENGTH
000774 EB      1740 EX	DE,HL
000775 C5      1741 PUSH	BC
000776 CD      1742 CALL	GETTOP
000777 25   
000778 40   
000779 C1      1743 POP	BC
00077A E5      1744 PUSH	HL
00077B 09      1745 ADD	HL,BC
00077C E5      1746 PUSH	HL
00077D 24      1747 INC	H
00077E AF      1748 XOR	A
00077F ED      1749 SBC	HL,SP
000780 72   
000781 E1      1750 POP	HL
000782 D2      1751 JP	NC,ERROR_		; "No room"
000783 44   
000784 3F   
000785 E3      1752 EX	(SP),HL
000786 E5      1753 PUSH	HL
000787 23      1754 INC	HL
000788 B7      1755 OR	A
000789 ED      1756 SBC	HL,DE
00078A 52   
00078B 44      1757 LD	B,H			; BC=AMOUNT TO MOVE
00078C 4D      1758 LD	C,L
00078D E1      1759 POP	HL
00078E D1      1760 POP	DE
00078F 28      1761 JR	Z,ATENDos
000790 02   
000791 ED      1762 LDDR				; MAKE SPACE
000792 B8   
000793 C1      1763 ATENDos:          	POP	BC			; LINE LENGTH
000794 D1      1764 POP	DE			; LINE NUMBER
000795 23      1765 INC	HL
000796 71      1766 LD	(HL),C			; STORE LENGTH
000797 23      1767 INC	HL
000798 73      1768 LD	(HL),E			; STORE LINE NUMBER
000799 23      1769 INC	HL
00079A 72      1770 LD	(HL),D
00079B 23      1771 INC	HL
00079C 11      1772 LD	DE,BUFFER
00079D 00   
00079E 53   
00079F EB      1773 EX	DE,HL
0007A0 0D      1774 DEC	C
0007A1 0D      1775 DEC	C
0007A2 0D      1776 DEC	C
0007A3 ED      1777 LDIR				; ADD LINE
0007A4 B0   
0007A5 37      1778 SCF
0007A6 C9      1779 RET
0007A7 3E    0001M1 LD	A, function
0007A8 01   
0007A9 49    0002M1 RST.LIS	08h
0007AA CF   
0007AB D0      1784 RET	NC			; If load returns with carry reset - NO ROOM
0007AC B7      1785 OR	A			; If there is no error (A=0)
0007AD 37      1786 SCF				; Need to set carry indicating there was room
0007AE C8      1787 RET	Z			; Return
0007AF F5      1789 OSERROR:		PUSH	AF			; Handle the MOS error
0007B0 21      1790 LD	HL, ACCS		; Address of the buffer
0007B1 00   
0007B2 52   
0007B3 01      1791 LD	BC, 256			; Length of the buffer
0007B4 00   
0007B5 01   
0007B6 5F      1792 LD	E, A			; The error code
0007B7 3E    0001M1 LD	A, function
0007B8 0F   
0007B9 49    0002M1 RST.LIS	08h
0007BA CF   
0007BB F1      1794 POP	AF
0007BC E5      1795 PUSH	HL			; Stack the address of the error (now in ACCS)
0007BD C6      1796 ADD	A, 127			; Add 127 to the error code (MOS errors start at 128, and are trappable)
0007BE 7F   
0007BF C3      1797 JP	EXTERR			; Trigger an external error
0007C0 55   
0007C1 3F   
0007C2 C5      1805 OSSAVE:			PUSH	BC			; Stack the size
0007C3 D5      1806 PUSH	DE			; Stack the save address
0007C4 11      1807 LD	DE, ACCS		; Buffer address for filename
0007C5 00   
0007C6 52   
0007C7 CD      1808 CALL	CSTR_FNAME		; Fetch filename from MOS into buffer
0007C8 5B   
0007C9 05   
0007CA 21      1809 LD	HL, ACCS		; HL: Filename
0007CB 00   
0007CC 52   
0007CD CD      1810 CALL	EXT_DEFAULT		; Tack on the extension .BBC if not specified
0007CE 15   
0007CF 08   
0007D0 CD      1811 CALL	EXT_HANDLER		; Get the default handler
0007D1 26   
0007D2 08   
0007D3 D1      1812 POP	DE			; Restore the save address
0007D4 C1      1813 POP	BC			; Restore the size
0007D5 B7      1814 OR	A			; Is the extension .BBC
0007D6 28      1815 JR	Z, OSSAVE_BBC		; Yes, so use that
0007D7 35   
0007D8 3A      1819 OSSAVE_TXT:		LD 	A, (OSWRCHCH)		; Stack the current channel
0007D9 12   
0007DA 51   
0007DB F5      1820 PUSH	AF
0007DC AF      1821 XOR	A
0007DD 3C      1822 INC	A			; Make sure C is clear, A is 1, for OPENOUT
0007DE 32      1823 LD	(OSWRCHCH), A
0007DF 12   
0007E0 51   
0007E1 CD      1824 CALL	OSOPEN			; Open the file
0007E2 44   
0007E3 06   
0007E4 32      1825 LD	(OSWRCHFH), A		; Store the file handle for OSWRCH
0007E5 13   
0007E6 51   
0007E7 DD      1826 LD	IX, LISTON		; Required for LISTIT
0007E8 21   
0007E9 FE   
0007EA 54   
0007EB 2A      1827 LD	HL, (PAGE_)		; Get start of program area
0007EC DC   
0007ED 54   
0007EE D9      1828 EXX
0007EF 01      1829 LD	BC, 0			; Set the initial indent counters
0007F0 00   
0007F1 00   
0007F2 D9      1830 EXX
0007F3 7E      1831 OSSAVE_TXT1:		LD	A, (HL)			; Check for end of program marker
0007F4 B7      1832 OR	A
0007F5 28      1833 JR	Z, OSSAVE_TXT2
0007F6 0A   
0007F7 23      1834 INC	HL			; Skip the length byte
0007F8 5E      1835 LD	E, (HL)			; Get the line number
0007F9 23      1836 INC	HL
0007FA 56      1837 LD	D, (HL)
0007FB 23      1838 INC	HL
0007FC CD      1839 CALL	LISTIT			; List the line
0007FD 5D   
0007FE 40   
0007FF 18      1840 JR	OSSAVE_TXT1
000800 F2   
000801 3A      1841 OSSAVE_TXT2:		LD	A, (OSWRCHFH)		; Get the file handle
000802 13   
000803 51   
000804 5F      1842 LD	E, A
000805 CD      1843 CALL	OSSHUT			; Close it
000806 53   
000807 06   
000808 F1      1844 POP	AF			; Restore the channel
000809 32      1845 LD	(OSWRCHCH), A
00080A 12   
00080B 51   
00080C C9      1846 RET
00080D 3E    0001M1 LD	A, function
00080E 02   
00080F 49    0002M1 RST.LIS	08h
000810 CF   
000811 B7      1851 OR	A			; If there is no error (A=0)
000812 C8      1852 RET	Z			; Just return
000813 18      1853 JR	OSERROR			; Trip an error
000814 9A   
000815 E5      1859 EXT_DEFAULT:		PUSH	HL			; Stack the filename pointer
000816 0E      1860 LD	C, '.'			; Search for dot (marks start of extension)
000817 2E   
000818 CD      1861 CALL	CSTR_FINDCH
000819 7B   
00081A 05   
00081B B7      1862 OR	A			; Check for end of string marker
00081C 20      1863 JR	NZ, @F			; No, so skip as we have an extension at this point
00081D 06   
00081E 11      1864 LD	DE, EXT_LOOKUP		; Get the first (default extension)
00081F 52   
000820 08   
000821 CD      1865 CALL	CSTR_CAT		; Concat it to string pointed to by HL
000822 91   
000823 05   
000824 E1      1866 @@:			POP	HL			; Restore the filename pointer
000825 C9      1867 RET
000826 E5      1874 EXT_HANDLER:		PUSH	HL			; Stack the filename pointer
000827 0E      1875 LD	C, '.'			; Find the '.'
000828 2E   
000829 CD      1876 CALL	CSTR_FINDCH
00082A 7B   
00082B 05   
00082C 11      1877 LD	DE, EXT_LOOKUP		; The lookup table
00082D 52   
00082E 08   
00082F E5      1879 EXT_HANDLER_1:		PUSH	HL			; Stack the pointer to the extension
000830 CD      1880 CALL	CSTR_ENDSWITH		; Check whether the string ends with the entry in the lookup
000831 83   
000832 05   
000833 E1      1881 POP	HL			; Restore the pointer to the extension
000834 28      1882 JR	Z, EXT_HANDLER_2	; We have a match!
000835 18   
000836 1A      1884 @@:			LD	A, (DE)			; Skip to the end of the entry in the lookup
000837 13      1885 INC	DE
000838 B7      1886 OR	A
000839 20      1887 JR	NZ, @B
00083A FB   
00083B 13      1888 INC	DE			; Skip the file extension # byte
00083C 1A      1890 LD	A, (DE)			; Are we at the end of the table?
00083D B7      1891 OR	A
00083E 20      1892 JR	NZ, EXT_HANDLER_1	; No, so loop
00083F EF   
000840 3E      1894 LD      A,204			; Throw a "Bad name" error
000841 CC   
000842 CD      1895 CALL    EXTERR
000843 55   
000844 3F   
000845 42      1896 DB    	"Bad name", 0
000846 61   
000847 64   
000848 20   
000849 6E   
00084A 61   
00084B 6D   
00084C 65   
00084D 00   
00084E 13      1898 EXT_HANDLER_2:		INC	DE			; Skip to the file extension # byte
00084F 1A      1899 LD	A, (DE)
000850 E1      1900 POP	HL			; Restore the filename pointer
000851 C9      1901 RET
000852 2E      1908 EXT_LOOKUP:		DB	".BBC", 0, 0		; First entry is the default extension
000853 42   
000854 42   
000855 43   
000856 00   
000857 00   
000858 2E      1909 DB	".TXT", 0, 1
000859 54   
00085A 58   
00085B 54   
00085C 00   
00085D 01   
00085E 2E      1910 DB	".ASC", 0, 1
00085F 41   
000860 53   
000861 43   
000862 00   
000863 01   
000864 2E      1911 DB	".BAS", 0, 1
000865 42   
000866 41   
000867 53   
000868 00   
000869 01   
00086A 00      1912 DB	0			; End of table
00086B FE      1916 OSWORD:			CP	07H			; SOUND
00086C 07   
00086D CA      1918 JP	Z, OSWORD_07 ; JR WAS TOO LARGE
00086E 9E   
00086F 0A   
000870 FE      1919 CP	08H			; ENVELOPE
000871 08   
000872 28      1920 JR	Z, OSWORD_08
000873 14   
000874 FE      1921 CP	09H			; POINT
000875 09   
000876 28      1922 JR	Z, OSWORD_09
000877 03   
000878 C3      1923 JP	HUH			; Anything else trips an error
000879 AD   
00087A 08   
00087B ED      1943 OSWORD_09:		LD	DE,(SCRAP+0)
00087C 5B   
00087D 17   
00087E 51   
00087F 2A      1944 LD	HL,(SCRAP+2)
000880 19   
000881 51   
000882 CD      1945 CALL	POINT_
000883 18   
000884 02   
000885 32      1946 LD	(SCRAP+4),A
000886 1B   
000887 51   
000888 C9      1947 OSWORD_08:		RET				; Envelope not currently implemented
000889 FE      1956 OSBYTE:			CP	0BH			; Keyboard auto-repeat delay
00088A 0B   
00088B 28      1957 JR	Z, OSBYTE_0B
00088C 31   
00088D FE      1958 CP	0CH			; Keyboard auto-repeat rate
00088E 0C   
00088F 28      1959 JR	Z, OSBYTE_0C
000890 54   
000891 FE      1960 CP	13H			; Wait for vblank
000892 13   
000893 28      1961 JR	Z, OSBYTE_13
000894 77   
000895 FE      1962 CP	76H			; Set keyboard LED
000896 76   
000897 28      1963 JR	Z, OSBYTE_76
000898 7B   
000899 FE      1964 CP	81H			; Read the keyboard
00089A 81   
00089B CA      1965 JP	Z, OSBYTE_81
00089C 3C   
00089D 09   
00089E FE      1966 CP	86H			; Get cursor coordinates
00089F 86   
0008A0 CA      1967 JP	Z, OSBYTE_86
0008A1 56   
0008A2 09   
0008A3 FE      1968 CP	87H			; Fetch current mode and character under cursor
0008A4 87   
0008A5 CA      1969 JP	Z, OSBYTE_87
0008A6 85   
0008A7 09   
0008A8 FE      1970 CP	A0H			; Fetch system variable
0008A9 A0   
0008AA CA      1971 JP	Z, OSBYTE_A0
0008AB 9B   
0008AC 09   
0008AD 3E      1975 HUH:    		LD      A,254			; Bad command error
0008AE FE   
0008AF CD      1976 CALL    EXTERR
0008B0 55   
0008B1 3F   
0008B2 42      1977 DB    	"Bad command"
0008B3 61   
0008B4 64   
0008B5 20   
0008B6 63   
0008B7 6F   
0008B8 6D   
0008B9 6D   
0008BA 61   
0008BB 6E   
0008BC 64   
0008BD 00      1978 DEFB    0
0008BE 3E    0001M1 LD      A, VAL
0008BF 17   
0008C0 CD    0002M1 CALL    OSWRCH
0008C1 B1   
0008C2 05   
0008C3 3E    0001M1 LD      A, VAL
0008C4 00   
0008C5 CD    0002M1 CALL    OSWRCH
0008C6 B1   
0008C7 05   
0008C8 3E    0001M1 LD      A, VAL
0008C9 88   
0008CA CD    0002M1 CALL    OSWRCH
0008CB B1   
0008CC 05   
0008CD 7D    0001M1 LD      A, VAL
0008CE CD    0002M1 CALL    OSWRCH
0008CF B1   
0008D0 05   
0008D1 7C    0001M1 LD      A, VAL
0008D2 CD    0002M1 CALL    OSWRCH
0008D3 B1   
0008D4 05   
0008D5 3E    0001M1 LD      A, VAL
0008D6 00   
0008D7 CD    0002M1 CALL    OSWRCH
0008D8 B1   
0008D9 05   
0008DA 3E    0001M1 LD      A, VAL
0008DB 00   
0008DC CD    0002M1 CALL    OSWRCH
0008DD B1   
0008DE 05   
0008DF 3E    0001M1 LD      A, VAL
0008E0 FF   
0008E1 CD    0002M1 CALL    OSWRCH
0008E2 B1   
0008E3 05   
0008E4 C9      1992 RET
0008E5 3E    0001M1 LD      A, VAL
0008E6 17   
0008E7 CD    0002M1 CALL    OSWRCH
0008E8 B1   
0008E9 05   
0008EA 3E    0001M1 LD      A, VAL
0008EB 00   
0008EC CD    0002M1 CALL    OSWRCH
0008ED B1   
0008EE 05   
0008EF 3E    0001M1 LD      A, VAL
0008F0 88   
0008F1 CD    0002M1 CALL    OSWRCH
0008F2 B1   
0008F3 05   
0008F4 3E    0001M1 LD      A, VAL
0008F5 00   
0008F6 CD    0002M1 CALL    OSWRCH
0008F7 B1   
0008F8 05   
0008F9 3E    0001M1 LD      A, VAL
0008FA 00   
0008FB CD    0002M1 CALL    OSWRCH
0008FC B1   
0008FD 05   
0008FE 7D    0001M1 LD      A, VAL
0008FF CD    0002M1 CALL    OSWRCH
000900 B1   
000901 05   
000902 7C    0001M1 LD      A, VAL
000903 CD    0002M1 CALL    OSWRCH
000904 B1   
000905 05   
000906 3E    0001M1 LD      A, VAL
000907 FF   
000908 CD    0002M1 CALL    OSWRCH
000909 B1   
00090A 05   
00090B C9      2006 RET
00090C CD      2010 OSBYTE_13:		CALL	WAIT_VBLANK
00090D 8B   
00090E 0A   
00090F 2E      2011 LD	L, 0			; Returns 0
000910 00   
000911 C3      2012 JP	COUNT0
000912 4E   
000913 1B   
000914 3E    0001M1 LD      A, VAL
000915 17   
000916 CD    0002M1 CALL    OSWRCH
000917 B1   
000918 05   
000919 3E    0001M1 LD      A, VAL
00091A 00   
00091B CD    0002M1 CALL    OSWRCH
00091C B1   
00091D 05   
00091E 3E    0001M1 LD      A, VAL
00091F 88   
000920 CD    0002M1 CALL    OSWRCH
000921 B1   
000922 05   
000923 3E    0001M1 LD      A, VAL
000924 00   
000925 CD    0002M1 CALL    OSWRCH
000926 B1   
000927 05   
000928 3E    0001M1 LD      A, VAL
000929 00   
00092A CD    0002M1 CALL    OSWRCH
00092B B1   
00092C 05   
00092D 3E    0001M1 LD      A, VAL
00092E 00   
00092F CD    0002M1 CALL    OSWRCH
000930 B1   
000931 05   
000932 3E    0001M1 LD      A, VAL
000933 00   
000934 CD    0002M1 CALL    OSWRCH
000935 B1   
000936 05   
000937 7D    0001M1 LD      A, VAL
000938 CD    0002M1 CALL    OSWRCH
000939 B1   
00093A 05   
00093B C9      2026 RET
00093C CD      2036 OSBYTE_81:		CALL	READKEY			; Read the keyboard
00093D 2B   
00093E 06   
00093F 28      2037 JR	Z, @F 			; Skip if we have a key
000940 09   
000941 7C      2038 LD	A, H 			; Check loop counter
000942 B5      2039 OR 	L
000943 C8      2040 RET 	Z 			; Return, we've not got a key at this point
000944 CD      2041 CALL	WAIT_VBLANK 		; Wait a frame
000945 8B   
000946 0A   
000947 2B      2042 DEC 	HL			; Decrement
000948 18      2043 JR	OSBYTE_81		; And loop
000949 F2   
00094A 21      2045 @@:			LD	HL, KEYDOWN		; We have a key, so
00094B 14   
00094C 51   
00094D 36      2046 LD	(HL), 0			; clear the keydown flag
00094E 00   
00094F FE      2047 CP	1BH			; If we are not pressing ESC,
000950 1B   
000951 37      2048 SCF 				; then flag we've got a character
000952 C0      2049 RET	NZ
000953 C3      2050 JP	ESCSET			; Handle ESC
000954 16   
000955 06   
000956 DD      2057 OSBYTE_86:		PUSH	IX			; Get the system vars in IX
000957 E5   
000958 3E    0001M1 LD	A, function
000959 08   
00095A 49    0002M1 RST.LIS	08h
00095B CF   
00095C 5B      2059 RES.LIL	0, (IX+sysvar_vpd_pflags)
00095D DD   
00095E CB   
00095F 04   
000960 86   
000961 3E    0001M1 LD      A, VAL
000962 17   
000963 CD    0002M1 CALL    OSWRCH
000964 B1   
000965 05   
000966 3E    0001M1 LD      A, VAL
000967 00   
000968 CD    0002M1 CALL    OSWRCH
000969 B1   
00096A 05   
00096B 3E    0001M1 LD      A, VAL
00096C 82   
00096D CD    0002M1 CALL    OSWRCH
00096E B1   
00096F 05   
000970 5B      2063 @@:			BIT.LIL	0, (IX+sysvar_vpd_pflags)
000971 DD   
000972 CB   
000973 04   
000974 46   
000975 28      2064 JR	Z, @B			; Wait for the result
000976 F9   
000977 16      2065 LD 	D, 0
000978 00   
000979 62      2066 LD	H, D
00097A 5B      2067 LD.LIL	E, (IX + sysvar_cursorX)
00097B DD   
00097C 5E   
00097D 07   
00097E 5B      2068 LD.LIL	L, (IX + sysvar_cursorY)
00097F DD   
000980 6E   
000981 08   
000982 DD      2069 POP	IX
000983 E1   
000984 C9      2070 RET
000985 DD      2074 OSBYTE_87:		PUSH	IX
000986 E5   
000987 CD      2075 CALL	GETCSR			; Get the current screen position
000988 A9   
000989 0D   
00098A CD      2076 CALL	GETSCHR_1		; Read character from screen
00098B DB   
00098C 01   
00098D 6F      2077 LD	L, A
00098E 3E    0001M1 LD	A, function
00098F 08   
000990 49    0002M1 RST.LIS	08h
000991 CF   
000992 5B      2079 LD.LIL	H, (IX+sysvar_scrMode)	; H: Screen mode
000993 DD   
000994 66   
000995 27   
000996 DD      2080 POP	IX
000997 E1   
000998 C3      2081 JP	COUNT1
000999 50   
00099A 1B   
00099B DD      2087 OSBYTE_A0:		PUSH	IX
00099C E5   
00099D 3E    0001M1 LD	A, function
00099E 08   
00099F 49    0002M1 RST.LIS	08h
0009A0 CF   
0009A1 5B      2089 LD.LIL	BC, 0
0009A2 01   
0009A3 00   
0009A4 00   
0009A5 00   
0009A6 4D      2090 LD	C, L			; BCU = L
0009A7 5B      2091 ADD.LIL	IX, BC			; Add to IX
0009A8 DD   
0009A9 09   
0009AA 5B      2092 LD.LIL	L, (IX + 0)		; Fetch the return value
0009AB DD   
0009AC 6E   
0009AD 00   
0009AE DD      2093 POP	IX
0009AF E1   
0009B0 C3      2094 JP 	COUNT0
0009B1 4E   
0009B2 1B   
0009B3 CD      2101 OSCLI: 			CALL    SKIPSP
0009B4 0D   
0009B5 0A   
0009B6 FE      2102 CP      CR
0009B7 0D   
0009B8 C8      2103 RET     Z
0009B9 FE      2104 CP      '|'
0009BA 7C   
0009BB C8      2105 RET     Z
0009BC EB      2106 EX      DE,HL
0009BD 21      2107 LD      HL,COMDS
0009BE 1C   
0009BF 0A   
0009C0 1A      2108 OSCLI0:			LD      A,(DE)
0009C1 CD      2109 CALL    UPPRC
0009C2 14   
0009C3 0A   
0009C4 BE      2110 CP      (HL)
0009C5 28      2111 JR      Z,OSCLI2
0009C6 0B   
0009C7 38      2112 JR      C,OSCLI6
0009C8 2E   
0009C9 CB      2113 OSCLI1:			BIT     7,(HL)
0009CA 7E   
0009CB 23      2114 INC     HL
0009CC 28      2115 JR      Z,OSCLI1
0009CD FB   
0009CE 23      2116 INC     HL
0009CF 23      2117 INC     HL
0009D0 18      2118 JR      OSCLI0
0009D1 EE   
0009D2 D5      2120 OSCLI2:			PUSH    DE
0009D3 13      2121 OSCLI3:			INC     DE
0009D4 23      2122 INC     HL
0009D5 1A      2123 LD      A,(DE)
0009D6 CD      2124 CALL    UPPRC
0009D7 14   
0009D8 0A   
0009D9 FE      2125 CP      '.'			; ABBREVIATED?
0009DA 2E   
0009DB 28      2126 JR      Z,OSCLI4
0009DC 0A   
0009DD AE      2127 XOR     (HL)
0009DE 28      2128 JR      Z,OSCLI3
0009DF F3   
0009E0 FE      2129 CP      80H
0009E1 80   
0009E2 28      2130 JR      Z,OSCLI4
0009E3 03   
0009E4 D1      2131 POP     DE
0009E5 18      2132 JR      OSCLI1
0009E6 E2   
0009E7 F1      2134 OSCLI4:			POP     AF
0009E8 13      2135 INC     DE
0009E9 CB      2136 OSCLI5:			BIT     7,(HL)
0009EA 7E   
0009EB 23      2137 INC     HL
0009EC 28      2138 JR      Z,OSCLI5
0009ED FB   
0009EE 7E      2139 LD      A,(HL)
0009EF 23      2140 INC     HL
0009F0 66      2141 LD      H,(HL)
0009F1 6F      2142 LD      L,A
0009F2 E5      2143 PUSH    HL
0009F3 EB      2144 EX      DE,HL
0009F4 C3      2145 JP      SKIPSP
0009F5 0D   
0009F6 0A   
0009F7 EB      2147 OSCLI6:			EX	DE, HL			; HL: Buffer for command
0009F8 11      2148 LD	DE, ACCS		; Buffer for command string is ACCS (the string accumulator)
0009F9 00   
0009FA 52   
0009FB D5      2149 PUSH	DE			; Store buffer address
0009FC CD      2150 CALL	CSTR_LINE		; Fetch the line
0009FD 6D   
0009FE 05   
0009FF E1      2151 POP	HL			; HL: Pointer to command string in ACCS
000A00 FD      2152 PUSH	IY
000A01 E5   
000A02 3E    0001M1 LD	A, function
000A03 10   
000A04 49    0002M1 RST.LIS	08h
000A05 CF   
000A06 FD      2154 POP	IY
000A07 E1   
000A08 B7      2155 OR	A			; 0 means MOS returned OK
000A09 C8      2156 RET	Z			; So don't do anything
000A0A C3      2157 JP 	OSERROR			; Otherwise it's a MOS error
000A0B AF   
000A0C 07   
000A0D 7E      2159 SKIPSP:			LD      A,(HL)
000A0E FE      2160 CP      ' '
000A0F 20   
000A10 C0      2161 RET     NZ
000A11 23      2162 INC     HL
000A12 18      2163 JR      SKIPSP
000A13 F9   
000A14 E6      2165 UPPRC:  		AND     7FH
000A15 7F   
000A16 FE      2166 CP      '`'
000A17 60   
000A18 D8      2167 RET     C
000A19 E6      2168 AND     5FH			; CONVERT TO UPPER CASE
000A1A 5F   
000A1B C9      2169 RET
000A1C 42      2174 COMDS:  		DB	"BY","E"+80h		; BYE
000A1D 59   
000A1E 45   
000A1F 2C      2175 DW	BYE
000A20 0A   
000A21 45      2176 DB	"EDI","T"+80h		; EDIT
000A22 44   
000A23 49   
000A24 54   
000A25 37      2177 DW	STAR_EDIT
000A26 0A   
000A27 46      2178 DB	"F","X"+80h		; FX
000A28 58   
000A29 73      2179 DW	STAR_FX
000A2A 0A   
000A2B FF      2182 DB	FFh
000A2C CD      2186 BYE:			CALL	VBLANK_STOP		; Restore MOS interrupts
000A2D 66   
000A2E 04   
000A2F 5B      2187 POP.LIL	IX 			; The return address to init
000A30 DD   
000A31 E1   
000A32 21      2188 LD	HL, 0			; The return code
000A33 00   
000A34 00   
000A35 DD      2189 JP	(IX)
000A36 E9   
000A37 CD      2193 STAR_EDIT:		CALL	ASC_TO_NUMBER		; DE: Line number to edit
000A38 DC   
000A39 04   
000A3A EB      2194 EX	DE, HL			; HL: Line number
000A3B CD      2195 CALL	FINDL			; HL: Address in RAM of tokenised line
000A3C 43   
000A3D 41   
000A3E 3E      2196 LD	A, 41			; F:NZ If the line is not found
000A3F 29   
000A40 C2      2197 JP	NZ, ERROR_		; Do error 41: No such line in that case
000A41 44   
000A42 3F   
000A43 23      2201 INC	HL			; Skip the length byte
000A44 5E      2202 LD	E, (HL)			; Fetch the line number
000A45 23      2203 INC	HL
000A46 56      2204 LD	D, (HL)
000A47 23      2205 INC	HL
000A48 DD      2206 LD	IX, ACCS		; Pointer to where the copy is to be stored
000A49 21   
000A4A 00   
000A4B 52   
000A4C DD      2207 LD	(OSWRCHPT), IX
000A4D 22   
000A4E 10   
000A4F 51   
000A50 DD      2208 LD	IX, LISTON		; Pointer to LISTON variable in RAM
000A51 21   
000A52 FE   
000A53 54   
000A54 DD      2209 LD	A, (IX)			; Store that variable
000A55 7E   
000A56 00   
000A57 F5      2210 PUSH	AF
000A58 DD      2211 LD	(IX), 09h		; Set to echo to buffer
000A59 36   
000A5A 00   
000A5B 09   
000A5C CD      2212 CALL	LISTIT
000A5D 5D   
000A5E 40   
000A5F F1      2213 POP	AF
000A60 DD      2214 LD	(IX), A			; Restore the original LISTON variable
000A61 77   
000A62 00   
000A63 21      2215 LD	HL, ACCS		; HL: ACCS
000A64 00   
000A65 52   
000A66 5D      2216 LD	E, L			;  E: 0 - Don't clear the buffer; ACCS is on a page boundary so L is 0
000A67 CD      2217 CALL	OSLINE1			; Invoke the editor
000A68 E9   
000A69 05   
000A6A CD      2218 CALL	OSEDIT
000A6B 39   
000A6C 07   
000A6D DC      2219 CALL    C,CLEAN			; Set TOP, write out &FFFF end of program marker
000A6E 1A   
000A6F 40   
000A70 C3      2220 JP      CLOOP			; Jump back to immediate mode
000A71 B0   
000A72 37   
000A73 CD      2224 STAR_FX:		CALL	ASC_TO_NUMBER
000A74 DC   
000A75 04   
000A76 4B      2225 LD	C, E			; C: Save FX #
000A77 CD      2226 CALL	ASC_TO_NUMBER
000A78 DC   
000A79 04   
000A7A 7A      2227 LD	A, D  			; Is first parameter > 255?
000A7B B7      2228 OR 	A
000A7C 28      2229 JR	Z, STAR_FX1		; Yes, so skip next bit
000A7D 03   
000A7E EB      2230 EX	DE, HL 			; Parameter is 16-bit
000A7F 18      2231 JR	STAR_FX2
000A80 06   
000A81 43      2233 STAR_FX1:		LD	B, E 			; B: Save First parameter
000A82 CD      2234 CALL	ASC_TO_NUMBER		; Fetch second parameter
000A83 DC   
000A84 04   
000A85 68      2235 LD	L, B 			; L: First parameter
000A86 63      2236 LD	H, E 			; H: Second parameter
000A87 79      2238 STAR_FX2:		LD	A, C 			; A: FX #
000A88 C3      2239 JP	OSBYTE
000A89 89   
000A8A 08   
000A8B DD      2243 WAIT_VBLANK:		PUSH 	IX			; Wait for VBLANK interrupt
000A8C E5   
000A8D 3E    0001M1 LD	A, function
000A8E 08   
000A8F 49    0002M1 RST.LIS	08h
000A90 CF   
000A91 5B      2245 LD.LIL	A, (IX + sysvar_time + 0)
000A92 DD   
000A93 7E   
000A94 00   
000A95 5B      2246 @@:			CP.LIL 	A, (IX + sysvar_time + 0)
000A96 DD   
000A97 BE   
000A98 00   
000A99 28      2247 JR	Z, @B
000A9A FA   
000A9B DD      2248 POP	IX
000A9C E1   
000A9D C9      2249 RET
000A9E             2252   ; --- Begin agon_sound.asm ---
000A9E 7E      2285 SOUND_:			LD	A, (HL)			; Channel
000A9F 32      2286 LD	(VDU_BUFFER+0), A
000AA0 00   
000AA1 52   
000AA2 AF      2287 XOR	A			; Waveform
000AA3 32      2288 LD	(VDU_BUFFER+1), A
000AA4 01   
000AA5 52   
000AA6 23      2289 INC	HL
000AA7 23      2290 INC	HL
000AA8 4E      2294 LD	C, (HL)			; Volume
000AA9 06      2295 LD	B, 6			; C already contains the volume
000AAA 06   
000AAB ED      2296 MLT	BC			; Multiply by 6 (0-15 scales to 0-90)
000AAC 4C   
000AAD 79      2297 LD	A, C
000AAE 32      2298 LD	(VDU_BUFFER+2), A
000AAF 02   
000AB0 52   
000AB1 23      2299 INC	HL
000AB2 23      2300 INC	HL
000AB3 E5      2304 PUSH	HL
000AB4 6E      2305 LD	L, (HL)
000AB5 26      2306 LD	H, 0
000AB6 00   
000AB7 11      2307 LD	DE, SOUND_FREQ_LOOKUP
000AB8 29   
000AB9 0B   
000ABA 29      2308 ADD	HL, HL
000ABB 19      2309 ADD	HL, DE
000ABC 7E      2310 LD	A, (HL)
000ABD 32      2311 LD	(VDU_BUFFER+3), A
000ABE 03   
000ABF 52   
000AC0 23      2312 INC	HL
000AC1 7E      2313 LD	A, (HL)
000AC2 32      2314 LD	(VDU_BUFFER+4), A
000AC3 04   
000AC4 52   
000AC5 E1      2315 POP	HL
000AC6 23      2316 INC	HL
000AC7 23      2317 INC	HL
000AC8 4E      2321 LD	C, (HL)
000AC9 06      2322 LD	B, 50			; C contains the duration, so MLT by 50
000ACA 32   
000ACB ED      2323 MLT	BC
000ACC 4C   
000ACD ED      2324 LD	(VDU_BUFFER+5), BC
000ACE 43   
000ACF 05   
000AD0 52   
000AD1 DD      2326 PUSH	IX			; Get the system vars in IX
000AD2 E5   
000AD3 3E    0001M1 LD	A, function
000AD4 08   
000AD5 49    0002M1 RST.LIS	08h
000AD6 CF   
000AD7 5B      2328 SOUND0:			RES.LIL	3, (IX+sysvar_vpd_pflags)
000AD8 DD   
000AD9 CB   
000ADA 04   
000ADB 9E   
000ADC 3E    0001M1 LD      A, VAL
000ADD 17   
000ADE CD    0002M1 CALL    OSWRCH
000ADF B1   
000AE0 05   
000AE1 3E    0001M1 LD      A, VAL
000AE2 00   
000AE3 CD    0002M1 CALL    OSWRCH
000AE4 B1   
000AE5 05   
000AE6 3E    0001M1 LD      A, VAL
000AE7 85   
000AE8 CD    0002M1 CALL    OSWRCH
000AE9 B1   
000AEA 05   
000AEB 3A    0001M1 LD      A, VAL
000AEC 00   
000AED 52   
000AEE CD    0002M1 CALL    OSWRCH
000AEF B1   
000AF0 05   
000AF1 3A    0001M1 LD      A, VAL
000AF2 01   
000AF3 52   
000AF4 CD    0002M1 CALL    OSWRCH
000AF5 B1   
000AF6 05   
000AF7 3A    0001M1 LD      A, VAL
000AF8 02   
000AF9 52   
000AFA CD    0002M1 CALL    OSWRCH
000AFB B1   
000AFC 05   
000AFD 3A    0001M1 LD      A, VAL
000AFE 03   
000AFF 52   
000B00 CD    0002M1 CALL    OSWRCH
000B01 B1   
000B02 05   
000B03 3A    0001M1 LD      A, VAL
000B04 04   
000B05 52   
000B06 CD    0002M1 CALL    OSWRCH
000B07 B1   
000B08 05   
000B09 3A    0001M1 LD      A, VAL
000B0A 05   
000B0B 52   
000B0C CD    0002M1 CALL    OSWRCH
000B0D B1   
000B0E 05   
000B0F 3A    0001M1 LD      A, VAL
000B10 06   
000B11 52   
000B12 CD    0002M1 CALL    OSWRCH
000B13 B1   
000B14 05   
000B15 5B      2343 @@:			BIT.LIL	3, (IX+sysvar_vpd_pflags)
000B16 DD   
000B17 CB   
000B18 04   
000B19 5E   
000B1A 28      2344 JR	Z, @B			; Wait for the result
000B1B F9   
000B1C CD      2345 CALL	LTRAP			; Check for ESC
000B1D 36   
000B1E 06   
000B1F 5B      2346 LD.LIL	A, (IX+sysvar_audioSuccess)
000B20 DD   
000B21 7E   
000B22 0E   
000B23 A7      2347 AND	A			; Check if VDP has queued the note
000B24 28      2348 JR	Z, SOUND0		; No, so loop back and send again
000B25 B1   
000B26 DD      2350 POP	IX
000B27 E1   
000B28 C9      2351 RET
000B29 75      2387 SOUND_FREQ_LOOKUP:	DW	 117,  118,  120,  122,  123,  131,  133,  135
000B2A 00   
000B2B 76   
000B2C 00   
000B2D 78   
000B2E 00   
000B2F 7A   
000B30 00   
000B31 7B   
000B32 00   
000B33 83   
000B34 00   
000B35 85   
000B36 00   
000B37 87   
000B38 00   
000B39 89      2388 DW	 137,  139,  141,  143,  145,  147,  149,  151
000B3A 00   
000B3B 8B   
000B3C 00   
000B3D 8D   
000B3E 00   
000B3F 8F   
000B40 00   
000B41 91   
000B42 00   
000B43 93   
000B44 00   
000B45 95   
000B46 00   
000B47 97   
000B48 00   
000B49 99      2389 DW	 153,  156,  158,  160,  162,  165,  167,  170
000B4A 00   
000B4B 9C   
000B4C 00   
000B4D 9E   
000B4E 00   
000B4F A0   
000B50 00   
000B51 A2   
000B52 00   
000B53 A5   
000B54 00   
000B55 A7   
000B56 00   
000B57 AA   
000B58 00   
000B59 AC      2390 DW	 172,  175,  177,  180,  182,  185,  188,  190
000B5A 00   
000B5B AF   
000B5C 00   
000B5D B1   
000B5E 00   
000B5F B4   
000B60 00   
000B61 B6   
000B62 00   
000B63 B9   
000B64 00   
000B65 BC   
000B66 00   
000B67 BE   
000B68 00   
000B69 C1      2391 DW	 193,  196,  199,  202,  205,  208,  211,  214
000B6A 00   
000B6B C4   
000B6C 00   
000B6D C7   
000B6E 00   
000B6F CA   
000B70 00   
000B71 CD   
000B72 00   
000B73 D0   
000B74 00   
000B75 D3   
000B76 00   
000B77 D6   
000B78 00   
000B79 D9      2392 DW	 217,  220,  223,  226,  230,  233,  236,  240
000B7A 00   
000B7B DC   
000B7C 00   
000B7D DF   
000B7E 00   
000B7F E2   
000B80 00   
000B81 E6   
000B82 00   
000B83 E9   
000B84 00   
000B85 EC   
000B86 00   
000B87 F0   
000B88 00   
000B89 F3      2393 DW	 243,  247,  251,  254,  258,  262,  265,  269
000B8A 00   
000B8B F7   
000B8C 00   
000B8D FB   
000B8E 00   
000B8F FE   
000B90 00   
000B91 02   
000B92 01   
000B93 06   
000B94 01   
000B95 09   
000B96 01   
000B97 0D   
000B98 01   
000B99 11      2394 DW	 273,  277,  281,  285,  289,  294,  298,  302
000B9A 01   
000B9B 15   
000B9C 01   
000B9D 19   
000B9E 01   
000B9F 1D   
000BA0 01   
000BA1 21   
000BA2 01   
000BA3 26   
000BA4 01   
000BA5 2A   
000BA6 01   
000BA7 2E   
000BA8 01   
000BA9 33      2395 DW	 307,  311,  316,  320,  325,  330,  334,  339
000BAA 01   
000BAB 37   
000BAC 01   
000BAD 3C   
000BAE 01   
000BAF 40   
000BB0 01   
000BB1 45   
000BB2 01   
000BB3 4A   
000BB4 01   
000BB5 4E   
000BB6 01   
000BB7 53   
000BB8 01   
000BB9 58      2396 DW	 344,  349,  354,  359,  365,  370,  375,  381
000BBA 01   
000BBB 5D   
000BBC 01   
000BBD 62   
000BBE 01   
000BBF 67   
000BC0 01   
000BC1 6D   
000BC2 01   
000BC3 72   
000BC4 01   
000BC5 77   
000BC6 01   
000BC7 7D   
000BC8 01   
000BC9 82      2397 DW	 386,  392,  398,  403,  409,  415,  421,  427
000BCA 01   
000BCB 88   
000BCC 01   
000BCD 8E   
000BCE 01   
000BCF 93   
000BD0 01   
000BD1 99   
000BD2 01   
000BD3 9F   
000BD4 01   
000BD5 A5   
000BD6 01   
000BD7 AB   
000BD8 01   
000BD9 B2      2398 DW	 434,  440,  446,  453,  459,  466,  473,  480
000BDA 01   
000BDB B8   
000BDC 01   
000BDD BE   
000BDE 01   
000BDF C5   
000BE0 01   
000BE1 CB   
000BE2 01   
000BE3 D2   
000BE4 01   
000BE5 D9   
000BE6 01   
000BE7 E0   
000BE8 01   
000BE9 E7      2399 DW	 487,  494,  501,  508,  516,  523,  531,  539
000BEA 01   
000BEB EE   
000BEC 01   
000BED F5   
000BEE 01   
000BEF FC   
000BF0 01   
000BF1 04   
000BF2 02   
000BF3 0B   
000BF4 02   
000BF5 13   
000BF6 02   
000BF7 1B   
000BF8 02   
000BF9 22      2400 DW	 546,  554,  562,  571,  579,  587,  596,  605
000BFA 02   
000BFB 2A   
000BFC 02   
000BFD 32   
000BFE 02   
000BFF 3B   
000C00 02   
000C01 43   
000C02 02   
000C03 4B   
000C04 02   
000C05 54   
000C06 02   
000C07 5D   
000C08 02   
000C09 65      2401 DW	 613,  622,  631,  641,  650,  659,  669,  679
000C0A 02   
000C0B 6E   
000C0C 02   
000C0D 77   
000C0E 02   
000C0F 81   
000C10 02   
000C11 8A   
000C12 02   
000C13 93   
000C14 02   
000C15 9D   
000C16 02   
000C17 A7   
000C18 02   
000C19 B1      2402 DW	 689,  699,  709,  719,  729,  740,  751,  762
000C1A 02   
000C1B BB   
000C1C 02   
000C1D C5   
000C1E 02   
000C1F CF   
000C20 02   
000C21 D9   
000C22 02   
000C23 E4   
000C24 02   
000C25 EF   
000C26 02   
000C27 FA   
000C28 02   
000C29 05      2403 DW	 773,  784,  795,  807,  819,  831,  843,  855
000C2A 03   
000C2B 10   
000C2C 03   
000C2D 1B   
000C2E 03   
000C2F 27   
000C30 03   
000C31 33   
000C32 03   
000C33 3F   
000C34 03   
000C35 4B   
000C36 03   
000C37 57   
000C38 03   
000C39 63      2404 DW	 867,  880,  893,  906,  919,  932,  946,  960
000C3A 03   
000C3B 70   
000C3C 03   
000C3D 7D   
000C3E 03   
000C3F 8A   
000C40 03   
000C41 97   
000C42 03   
000C43 A4   
000C44 03   
000C45 B2   
000C46 03   
000C47 C0   
000C48 03   
000C49 CE      2405 DW	 974,  988, 1002, 1017, 1032, 1047, 1062, 1078
000C4A 03   
000C4B DC   
000C4C 03   
000C4D EA   
000C4E 03   
000C4F F9   
000C50 03   
000C51 08   
000C52 04   
000C53 17   
000C54 04   
000C55 26   
000C56 04   
000C57 36   
000C58 04   
000C59 45      2406 DW	1093, 1109, 1125, 1142, 1158, 1175, 1192, 1210
000C5A 04   
000C5B 55   
000C5C 04   
000C5D 65   
000C5E 04   
000C5F 76   
000C60 04   
000C61 86   
000C62 04   
000C63 97   
000C64 04   
000C65 A8   
000C66 04   
000C67 BA   
000C68 04   
000C69 CB      2407 DW	1227, 1245, 1263, 1282, 1300, 1319, 1338, 1358
000C6A 04   
000C6B DD   
000C6C 04   
000C6D EF   
000C6E 04   
000C6F 02   
000C70 05   
000C71 14   
000C72 05   
000C73 27   
000C74 05   
000C75 3A   
000C76 05   
000C77 4E   
000C78 05   
000C79 62      2408 DW	1378, 1398, 1418, 1439, 1459, 1481, 1502, 1524
000C7A 05   
000C7B 76   
000C7C 05   
000C7D 8A   
000C7E 05   
000C7F 9F   
000C80 05   
000C81 B3   
000C82 05   
000C83 C9   
000C84 05   
000C85 DE   
000C86 05   
000C87 F4   
000C88 05   
000C89 0A      2409 DW	1546, 1569, 1592, 1615, 1638, 1662, 1686, 1711
000C8A 06   
000C8B 21   
000C8C 06   
000C8D 38   
000C8E 06   
000C8F 4F   
000C90 06   
000C91 66   
000C92 06   
000C93 7E   
000C94 06   
000C95 96   
000C96 06   
000C97 AF   
000C98 06   
000C99 C8      2410 DW	1736, 1761, 1786, 1812, 1839, 1866, 1893, 1920
000C9A 06   
000C9B E1   
000C9C 06   
000C9D FA   
000C9E 06   
000C9F 14   
000CA0 07   
000CA1 2F   
000CA2 07   
000CA3 4A   
000CA4 07   
000CA5 65   
000CA6 07   
000CA7 80   
000CA8 07   
000CA9 9C      2411 DW	1948, 1976, 2005, 2034, 2064, 2093, 2123, 2154
000CAA 07   
000CAB B8   
000CAC 07   
000CAD D5   
000CAE 07   
000CAF F2   
000CB0 07   
000CB1 10   
000CB2 08   
000CB3 2D   
000CB4 08   
000CB5 4B   
000CB6 08   
000CB7 6A   
000CB8 08   
000CB9 8A      2412 DW	2186, 2217, 2250, 2282, 2316, 2349, 2383, 2418
000CBA 08   
000CBB A9   
000CBC 08   
000CBD CA   
000CBE 08   
000CBF EA   
000CC0 08   
000CC1 0C   
000CC2 09   
000CC3 2D   
000CC4 09   
000CC5 4F   
000CC6 09   
000CC7 72   
000CC8 09   
000CC9 95      2413 DW	2453, 2489, 2525, 2562, 2599, 2637, 2675, 2714
000CCA 09   
000CCB B9   
000CCC 09   
000CCD DD   
000CCE 09   
000CCF 02   
000CD0 0A   
000CD1 27   
000CD2 0A   
000CD3 4D   
000CD4 0A   
000CD5 73   
000CD6 0A   
000CD7 9A   
000CD8 0A   
000CD9 C2      2414 DW	2754, 2794, 2834, 2876, 2918, 2960, 3003, 3047
000CDA 0A   
000CDB EA   
000CDC 0A   
000CDD 12   
000CDE 0B   
000CDF 3C   
000CE0 0B   
000CE1 66   
000CE2 0B   
000CE3 90   
000CE4 0B   
000CE5 BB   
000CE6 0B   
000CE7 E7   
000CE8 0B   
000CE9 13      2415 DW	3091, 3136, 3182, 3228, 3275, 3322, 3371, 3420
000CEA 0C   
000CEB 40   
000CEC 0C   
000CED 6E   
000CEE 0C   
000CEF 9C   
000CF0 0C   
000CF1 CB   
000CF2 0C   
000CF3 FA   
000CF4 0C   
000CF5 2B   
000CF6 0D   
000CF7 5C   
000CF8 0D   
000CF9 8E      2416 DW	3470, 3520, 3571, 3623, 3676, 3729, 3784, 3839
000CFA 0D   
000CFB C0   
000CFC 0D   
000CFD F3   
000CFE 0D   
000CFF 27   
000D00 0E   
000D01 5C   
000D02 0E   
000D03 91   
000D04 0E   
000D05 C8   
000D06 0E   
000D07 FF   
000D08 0E   
000D09 36      2417 DW	3894, 3951, 4009, 4067, 4126, 4186, 4247, 4309
000D0A 0F   
000D0B 6F   
000D0C 0F   
000D0D A9   
000D0E 0F   
000D0F E3   
000D10 0F   
000D11 1E   
000D12 10   
000D13 5A   
000D14 10   
000D15 97   
000D16 10   
000D17 D5   
000D18 10   
000D19 13      2418 DW	4371, 4435, 4499, 4565, 4631, 4699, 4767, 4836
000D1A 11   
000D1B 53   
000D1C 11   
000D1D 93   
000D1E 11   
000D1F D5   
000D20 11   
000D21 17   
000D22 12   
000D23 5B   
000D24 12   
000D25 9F   
000D26 12   
000D27 E4   
000D28 12   
000D29             2421   ; --- Begin acorn.asm ---
000D29 3E      2503 GETIME:         LD	A,1
000D2A 01   
000D2B 21      2504 LD	HL,SCRAP
000D2C 17   
000D2D 51   
000D2E CD      2505 CALL	OSWORD
000D2F 6B   
000D30 08   
000D31 21      2506 LD	HL,SCRAP
000D32 17   
000D33 51   
000D34 5E      2507 LD	E,(HL)
000D35 23      2508 INC	HL
000D36 56      2509 LD	D,(HL)
000D37 23      2510 INC	HL
000D38 7E      2511 LD	A,(HL)
000D39 23      2512 INC	HL
000D3A 66      2513 LD	H,(HL)
000D3B 6F      2514 LD	L,A
000D3C EB      2515 EX	DE,HL
000D3D C9      2516 RET
000D3E 3E      2523 GETIMS:         LD	A,14
000D3F 0E   
000D40 21      2524 LD	HL,SCRAP
000D41 17   
000D42 51   
000D43 36      2525 LD	(HL),0
000D44 00   
000D45 CD      2526 CALL	OSWORD
000D46 6B   
000D47 08   
000D48 21      2527 LD	HL,SCRAP
000D49 17   
000D4A 51   
000D4B 11      2528 LD	DE,ACCS
000D4C 00   
000D4D 52   
000D4E 7E      2529 LD	A,(HL)
000D4F BB      2530 CP	E
000D50 C8      2531 RET	Z
000D51 01      2532 LD	BC,25
000D52 19   
000D53 00   
000D54 ED      2533 LDIR
000D55 B0   
000D56 C9      2534 RET
000D57 DD      2541 PUTIME:         PUSH	IX
000D58 E5   
000D59 DD      2542 LD	IX,SCRAP
000D5A 21   
000D5B 17   
000D5C 51   
000D5D DD      2543 LD	(IX+0),L
000D5E 75   
000D5F 00   
000D60 DD      2544 LD	(IX+1),H
000D61 74   
000D62 01   
000D63 DD      2545 LD	(IX+2),E
000D64 73   
000D65 02   
000D66 DD      2546 LD	(IX+3),D
000D67 72   
000D68 03   
000D69 3E      2547 LD	A,2
000D6A 02   
000D6B 21      2548 LD	HL,SCRAP
000D6C 17   
000D6D 51   
000D6E CD      2549 CALL	OSWORD
000D6F 6B   
000D70 08   
000D71 DD      2550 POP	IX
000D72 E1   
000D73 C9      2551 RET
000D74 7B      2558 PUTIMS:         LD	A,E		;Length
000D75 FE      2559 CP	26
000D76 1A   
000D77 D0      2560 RET	NC
000D78 06      2561 LD	B,0
000D79 00   
000D7A 4F      2562 LD	C,A
000D7B 11      2563 LD	DE,SCRAP+1
000D7C 18   
000D7D 51   
000D7E 21      2564 LD	HL,ACCS
000D7F 00   
000D80 52   
000D81 ED      2565 LDIR
000D82 B0   
000D83 21      2566 LD	HL,SCRAP
000D84 17   
000D85 51   
000D86 77      2567 LD	(HL),A
000D87 3E      2568 LD	A,15
000D88 0F   
000D89 C3      2569 JP	OSWORD
000D8A 6B   
000D8B 08   
000D8C 3E      2575 CLRSCN:         LD	A,0CH
000D8D 0C   
000D8E C3      2576 JP	OSWRCH
000D8F B1   
000D90 05   
000D91 3E      2585 OSKEY:          LD	A,129
000D92 81   
000D93 CD      2586 CALL	OSBYTE
000D94 89   
000D95 08   
000D96 7C      2587 LD	A,H
000D97 B7      2588 OR	A
000D98 C0      2589 RET	NZ		;TIME-OUT, CARRY RESET
000D99 7D      2590 LD	A,L
000D9A 37      2591 SCF
000D9B C9      2592 RET			;NORMAL, CARRY SET
000D9C 3E      2599 PUTCSR:         LD	A,1FH
000D9D 1F   
000D9E CD      2600 CALL	OSWRCH
000D9F B1   
000DA0 05   
000DA1 7B      2601 LD	A,E
000DA2 CD      2602 CALL	OSWRCH
000DA3 B1   
000DA4 05   
000DA5 7D      2603 LD	A,L
000DA6 C3      2604 JP	OSWRCH
000DA7 B1   
000DA8 05   
000DA9 3E      2611 GETCSR:         LD	A,134
000DAA 86   
000DAB CD      2612 CALL	OSBYTE
000DAC 89   
000DAD 08   
000DAE 5D      2613 LD	E,L
000DAF 6C      2614 LD	L,H
000DB0 16      2615 LD	D,0
000DB1 00   
000DB2 62      2616 LD	H,D
000DB3 C9      2617 RET
000DB4 CD      2621 POINT:          CALL	EXPRI
000DB5 33   
000DB6 18   
000DB7 D9      2622 EXX
000DB8 E5      2623 PUSH	HL
000DB9 CD      2624 CALL	CEXPRI
000DBA F1   
000DBB 10   
000DBC D9      2625 EXX
000DBD D1      2626 POP	DE
000DBE CD      2627 CALL	BRAKET
000DBF AE   
000DC0 20   
000DC1 DD      2628 LD	IX,SCRAP
000DC2 21   
000DC3 17   
000DC4 51   
000DC5 DD      2629 LD	(IX+0),E
000DC6 73   
000DC7 00   
000DC8 DD      2630 LD	(IX+1),D
000DC9 72   
000DCA 01   
000DCB DD      2631 LD	(IX+2),L
000DCC 75   
000DCD 02   
000DCE DD      2632 LD	(IX+3),H
000DCF 74   
000DD0 03   
000DD1 21      2633 LD	HL,SCRAP
000DD2 17   
000DD3 51   
000DD4 3E      2634 LD	A,9
000DD5 09   
000DD6 CD      2635 CALL	OSWORD
000DD7 6B   
000DD8 08   
000DD9 DD      2636 LD	A,(IX+4)
000DDA 7E   
000DDB 04   
000DDC 6F      2637 LD	L,A
000DDD C6      2638 ADD	A,1
000DDE 01   
000DDF 9F      2639 SBC	A,A
000DE0 67      2640 LD	H,A
000DE1 D9      2641 RETEXX:         EXX
000DE2 67      2642 LD	H,A
000DE3 6F      2643 LD	L,A
000DE4 AF      2644 XOR	A
000DE5 4F      2645 LD	C,A
000DE6 C9      2646 RET
000DE7 CD      2650 ADVAL:          CALL	ITEMI
000DE8 60   
000DE9 18   
000DEA D9      2651 EXX
000DEB 3E      2652 LD	A,128
000DEC 80   
000DED CD      2653 CALL	OSBYTE
000DEE 89   
000DEF 08   
000DF0 AF      2654 XOR	A
000DF1 18      2655 JR	RETEXX
000DF2 EE   
000DF3 3E      2659 MODEFN:         LD	A,135
000DF4 87   
000DF5 CD      2660 CALL	OSBYTE
000DF6 89   
000DF7 08   
000DF8 6C      2661 LD	L,H
000DF9 AF      2662 RETU8:          XOR	A
000DFA 67      2663 LD	H,A
000DFB 18      2664 JR	RETEXX
000DFC E4   
000DFD 3A      2668 WIDFN:          LD	A,(WIDTH)
000DFE FC   
000DFF 54   
000E00 6F      2669 LD	L,A
000E01 18      2670 JR	RETU8
000E02 F6   
000E03 06      2675 ENVEL:          LD	B,0
000E04 00   
000E05 DD      2676 LD	IX,SCRAP
000E06 21   
000E07 17   
000E08 51   
000E09 C5      2677 PUSH	BC
000E0A DD      2678 PUSH	IX
000E0B E5   
000E0C CD      2679 ENVEL1:         CALL	EXPRI
000E0D 33   
000E0E 18   
000E0F D9      2680 EXX
000E10 DD      2681 POP	IX
000E11 E1   
000E12 C1      2682 POP	BC
000E13 DD      2683 LD	(IX),L
000E14 75   
000E15 00   
000E16 78      2684 LD	A,B
000E17 FE      2685 CP	13
000E18 0D   
000E19 28      2686 JR	Z,ENVEL2
000E1A 0B   
000E1B 04      2687 INC	B
000E1C DD      2688 INC	IX
000E1D 23   
000E1E C5      2689 PUSH	BC
000E1F DD      2690 PUSH	IX
000E20 E5   
000E21 CD      2691 CALL	COMMA
000E22 A2   
000E23 20   
000E24 18      2692 JR	ENVEL1
000E25 E6   
000E26 21      2693 ENVEL2:         LD	HL,SCRAP
000E27 17   
000E28 51   
000E29 3E      2694 LD	A,8
000E2A 08   
000E2B CD      2695 CALL	OSWORD
000E2C 6B   
000E2D 08   
000E2E C3      2696 JP	XEQ
000E2F 99   
000E30 24   
000E31 06      2700 SOUND:          LD	B,0
000E32 00   
000E33 DD      2701 LD	IX,SCRAP
000E34 21   
000E35 17   
000E36 51   
000E37 C5      2702 PUSH	BC
000E38 DD      2703 PUSH	IX
000E39 E5   
000E3A CD      2704 SOUND1:         CALL	EXPRI
000E3B 33   
000E3C 18   
000E3D D9      2705 EXX
000E3E DD      2706 POP	IX
000E3F E1   
000E40 C1      2707 POP	BC
000E41 DD      2708 LD	(IX+0),L
000E42 75   
000E43 00   
000E44 DD      2709 LD	(IX+1),H
000E45 74   
000E46 01   
000E47 DD      2710 INC	IX
000E48 23   
000E49 DD      2711 INC	IX
000E4A 23   
000E4B 04      2712 INC	B
000E4C 04      2713 INC	B
000E4D 78      2714 LD	A,B
000E4E FE      2715 CP	8
000E4F 08   
000E50 28      2716 JR	Z,SOUND2
000E51 08   
000E52 C5      2717 PUSH	BC
000E53 DD      2718 PUSH	IX
000E54 E5   
000E55 CD      2719 CALL	COMMA
000E56 A2   
000E57 20   
000E58 18      2720 JR	SOUND1
000E59 E0   
000E5A 21      2721 SOUND2:         LD	HL,SCRAP
000E5B 17   
000E5C 51   
000E5D 3E      2722 LD	A,7
000E5E 07   
000E5F CD      2723 CALL	OSWORD
000E60 6B   
000E61 08   
000E62 C3      2724 JP	XEQ
000E63 99   
000E64 24   
000E65 CD      2728 MODE:           CALL	EXPRI
000E66 33   
000E67 18   
000E68 AF      2729 XOR	A
000E69 32      2730 LD	(COUNT),A
000E6A FB   
000E6B 54   
000E6C D9      2731 EXX
000E6D 65      2732 LD	H,L
000E6E 2E      2733 LD	L,22
000E6F 16   
000E70 CD      2734 CALL	WRCH2
000E71 D8   
000E72 10   
000E73 18      2735 JR	XEQGO1
000E74 72   
000E75 3E      2739 CLG:            LD	A,16
000E76 10   
000E77 CD      2740 CALL	OSWRCH
000E78 B1   
000E79 05   
000E7A 18      2741 JR	XEQGO1
000E7B 6B   
000E7C CD      2745 ORIGIN:         CALL    EXPRI
000E7D 33   
000E7E 18   
000E7F D9      2746 EXX
000E80 E5      2747 PUSH	HL
000E81 CD      2748 CALL    CEXPRI
000E82 F1   
000E83 10   
000E84 D9      2749 EXX
000E85 D1      2750 POP	DE
000E86 0E      2751 LD	C,29
000E87 1D   
000E88 CD      2752 CALL	WRCH5
000E89 CC   
000E8A 10   
000E8B 18      2753 JR	XEQGO1
000E8C 5A   
000E8D CD      2759 COLOUR:         CALL	EXPRI		;n
000E8E 33   
000E8F 18   
000E90 D9      2760 EXX
000E91 FD      2761 LD	A,(IY)
000E92 7E   
000E93 00   
000E94 FE      2762 CP	','
000E95 2C   
000E96 28      2763 JR      Z,PALCOL
000E97 08   
000E98 65      2764 LD	H,L
000E99 2E      2765 LD	L,17
000E9A 11   
000E9B CD      2766 CALL	WRCH2
000E9C D8   
000E9D 10   
000E9E 18      2767 JR	XEQGO1
000E9F 47   
000EA0 E5      2769 PALCOL:         PUSH	HL
000EA1 CD      2770 CALL	CEXPRI		;p or r
000EA2 F1   
000EA3 10   
000EA4 D9      2771 EXX
000EA5 EB      2772 EX	DE,HL
000EA6 21      2773 LD	HL,0
000EA7 00   
000EA8 00   
000EA9 FD      2774 LD	A,(IY)
000EAA 7E   
000EAB 00   
000EAC FE      2775 CP	','
000EAD 2C   
000EAE 20      2776 JR	NZ,PALET1
000EAF 15   
000EB0 D5      2777 PUSH	DE
000EB1 CD      2778 CALL	CEXPRI		;g
000EB2 F1   
000EB3 10   
000EB4 D9      2779 EXX
000EB5 E5      2780 PUSH	HL
000EB6 CD      2781 CALL	CEXPRI		;b
000EB7 F1   
000EB8 10   
000EB9 D9      2782 EXX
000EBA D1      2783 POP	DE
000EBB C1      2784 POP	BC
000EBC 7D      2785 LD	A,L
000EBD E1      2786 POP	HL
000EBE 51      2787 LD	D,C		;r
000EBF 4D      2788 LD	C,L		;n
000EC0 6B      2789 LD	L,E		;g
000EC1 67      2790 LD	H,A		;b
000EC2 1E      2791 LD	E,16
000EC3 10   
000EC4 C5      2792 PUSH	BC
000EC5 C1      2793 PALET1:         POP	BC
000EC6 06      2794 LD	B,19
000EC7 13   
000EC8 CD      2795 CALL	WRCH6
000EC9 C8   
000ECA 10   
000ECB 18      2796 JR	XEQGO1
000ECC 1A   
000ECD CD      2800 GCOL:           CALL	EXPRI
000ECE 33   
000ECF 18   
000ED0 D9      2801 EXX
000ED1 1E      2802 LD	E,0
000ED2 00   
000ED3 FD      2803 LD	A,(IY)
000ED4 7E   
000ED5 00   
000ED6 FE      2804 CP	','
000ED7 2C   
000ED8 20      2805 JR	NZ,GCOL0
000ED9 06   
000EDA E5      2806 PUSH	HL
000EDB CD      2807 CALL	CEXPRI
000EDC F1   
000EDD 10   
000EDE D9      2808 EXX
000EDF D1      2809 POP	DE
000EE0 65      2810 GCOL0:          LD	H,L
000EE1 6B      2811 LD	L,E
000EE2 16      2812 LD	D,18
000EE3 12   
000EE4 CD      2813 CALL	WRCH3		;DLH
000EE5 D4   
000EE6 10   
000EE7 C3      2814 XEQGO1:         JP	XEQ
000EE8 99   
000EE9 24   
000EEA 0E      2819 CSRON:          LD	C,1
000EEB 01   
000EEC 18      2820 JR	CSRGO
000EED 02   
000EEE 0E      2822 CSROFF:         LD	C,0
000EEF 00   
000EF0 3E      2823 CSRGO:          LD	A,23
000EF1 17   
000EF2 CD      2824 CALL	OSWRCH
000EF3 B1   
000EF4 05   
000EF5 3E      2825 LD	A,1
000EF6 01   
000EF7 CD      2826 CALL	OSWRCH
000EF8 B1   
000EF9 05   
000EFA 79      2827 LD	A,C
000EFB 06      2828 LD	B,8
000EFC 08   
000EFD CD      2829 CSRGO1:         CALL	OSWRCH
000EFE B1   
000EFF 05   
000F00 AF      2830 XOR	A
000F01 10      2831 DJNZ	CSRGO1
000F02 FA   
000F03 18      2832 JR	XEQGO1
000F04 E2   
000F05 CD      2836 LINE:           CALL	EXPRI
000F06 33   
000F07 18   
000F08 D9      2837 EXX
000F09 E5      2838 PUSH	HL
000F0A CD      2839 CALL	EXPR3
000F0B E0   
000F0C 10   
000F0D E3      2840 EX	(SP),HL		;HL <- x1, (SP) <- y2
000F0E C5      2841 PUSH	BC
000F0F EB      2842 EX	DE,HL
000F10 0E      2843 LD	C,4
000F11 04   
000F12 CD      2844 CALL	VDU25
000F13 C6   
000F14 10   
000F15 D1      2845 POP	DE
000F16 E1      2846 POP	HL
000F17 0E      2847 LD	C,5
000F18 05   
000F19 18      2848 JR	PLOT4A
000F1A 2A   
000F1B FE      2852 CIRCLE:         CP	TFILL
000F1C 03   
000F1D F5      2853 PUSH	AF
000F1E 20      2854 JR	NZ,CIRCL0
000F1F 02   
000F20 FD      2855 INC	IY
000F21 23   
000F22 CD      2856 CIRCL0:         CALL	EXPRI
000F23 33   
000F24 18   
000F25 D9      2857 EXX
000F26 E5      2858 PUSH	HL
000F27 CD      2859 CALL	CEXPRI
000F28 F1   
000F29 10   
000F2A D9      2860 EXX
000F2B E5      2861 PUSH	HL
000F2C CD      2862 CALL	CEXPRI
000F2D F1   
000F2E 10   
000F2F D9      2863 EXX
000F30 C1      2864 POP	BC		;y
000F31 D1      2865 POP	DE		;x
000F32 E5      2866 PUSH	HL
000F33 69      2867 LD	L,C
000F34 60      2868 LD	H,B
000F35 0E      2869 LD	C,4		; PLOT 4 = MOVE
000F36 04   
000F37 CD      2870 CALL	VDU25
000F38 C6   
000F39 10   
000F3A D1      2871 POP	DE		;r
000F3B 21      2872 LD	HL,0
000F3C 00   
000F3D 00   
000F3E F1      2873 POP	AF
000F3F 0E      2874 LD	C,145		; PLOT 145 = outline circle
000F40 91   
000F41 20      2875 JR	NZ,PLOT4A
000F42 02   
000F43 0E      2876 LD	C,153		; PLOT 153 = filled circle
000F44 99   
000F45 18      2877 PLOT4A:         JR	PLOT4
000F46 6C   
000F47 FE      2881 ELLIPS:         CP	TFILL
000F48 03   
000F49 F5      2882 PUSH	AF
000F4A 20      2883 JR	NZ,ELLIP0
000F4B 02   
000F4C FD      2884 INC	IY
000F4D 23   
000F4E CD      2885 ELLIP0:         CALL	EXPRI
000F4F 33   
000F50 18   
000F51 D9      2886 EXX
000F52 E5      2887 PUSH	HL
000F53 CD      2888 CALL	EXPR3
000F54 E0   
000F55 10   
000F56 E3      2889 EX	(SP),HL		;HL <- x, (SP) <- b
000F57 C5      2890 PUSH	BC
000F58 EB      2891 EX	DE,HL
000F59 0E      2892 LD	C,4		; PLOT 4 = Move absolute
000F5A 04   
000F5B CD      2893 CALL	VDU25
000F5C C6   
000F5D 10   
000F5E D1      2894 POP	DE		;a
000F5F D5      2895 PUSH	DE
000F60 21      2896 LD	HL,0
000F61 00   
000F62 00   
000F63 4D      2897 LD	C,L		; PLOT 0 - Move relative
000F64 CD      2898 CALL	VDU25
000F65 C6   
000F66 10   
000F67 D1      2899 POP	DE		;a
000F68 AF      2900 XOR	A
000F69 6F      2901 LD	L,A
000F6A 67      2902 LD	H,A
000F6B ED      2903 SBC	HL,DE
000F6C 52   
000F6D EB      2904 EX	DE,HL
000F6E E1      2905 POP	HL		;b
000F6F F1      2906 POP	AF
000F70 0E      2907 LD	C,193		; PLOT 193 = outline ellipse
000F71 C1   
000F72 20      2908 JR	NZ,PLOT4
000F73 3F   
000F74 0E      2909 LD	C,201		; PLOT 201 = filled ellipse
000F75 C9   
000F76 18      2910 JR	PLOT4
000F77 3B   
000F78 0E      2917 MOVE:           LD	C,4
000F79 04   
000F7A 18      2918 JR	PLOT1
000F7B 23   
000F7C 0E      2920 DRAW:           LD	C,5
000F7D 05   
000F7E 18      2921 JR	PLOT1
000F7F 1F   
000F80 0E      2923 FILL:           LD	C,133
000F81 85   
000F82 18      2924 JR	PLOT1
000F83 1B   
000F84 0E      2926 PLOT:           LD	C,69
000F85 45   
000F86 FE      2927 CP	TBY
000F87 0F   
000F88 28      2928 JR	Z,PLOT1
000F89 15   
000F8A CD      2929 CALL	EXPRI
000F8B 33   
000F8C 18   
000F8D D9      2930 EXX
000F8E E5      2931 PUSH	HL
000F8F CD      2932 CALL	CEXPRI
000F90 F1   
000F91 10   
000F92 D9      2933 EXX
000F93 FD      2934 LD	A,(IY)
000F94 7E   
000F95 00   
000F96 FE      2935 CP	','
000F97 2C   
000F98 28      2936 JR	Z,PLOT3
000F99 12   
000F9A D1      2937 POP	DE
000F9B 0E      2938 LD	C,69
000F9C 45   
000F9D 18      2939 JR	PLOT4
000F9E 14   
000F9F FE      2941 PLOT1:          CP	TBY
000FA0 0F   
000FA1 20      2942 JR	NZ,PLOT2
000FA2 04   
000FA3 FD      2943 INC	IY
000FA4 23   
000FA5 CB      2944 RES	2,C		;Change absolute to relative
000FA6 91   
000FA7 C5      2945 PLOT2:          PUSH	BC
000FA8 CD      2946 CALL	EXPRI
000FA9 33   
000FAA 18   
000FAB D9      2947 EXX
000FAC E5      2948 PLOT3:          PUSH	HL
000FAD CD      2949 CALL	CEXPRI
000FAE F1   
000FAF 10   
000FB0 D9      2950 EXX
000FB1 D1      2951 POP	DE
000FB2 C1      2952 POP	BC
000FB3 CD      2953 PLOT4:          CALL	VDU25
000FB4 C6   
000FB5 10   
000FB6 C3      2954 JP	XEQ
000FB7 99   
000FB8 24   
000FB9 FE      2958 RECTAN:         CP	TFILL
000FBA 03   
000FBB F5      2959 PUSH	AF
000FBC 20      2960 JR	NZ,RECT0
000FBD 02   
000FBE FD      2961 INC	IY
000FBF 23   
000FC0 CD      2962 RECT0:          CALL	EXPRI
000FC1 33   
000FC2 18   
000FC3 D9      2963 EXX
000FC4 E5      2964 PUSH	HL
000FC5 CD      2965 CALL	CEXPRI
000FC6 F1   
000FC7 10   
000FC8 D9      2966 EXX
000FC9 E5      2967 PUSH	HL
000FCA CD      2968 CALL	CEXPRI
000FCB F1   
000FCC 10   
000FCD D9      2969 EXX
000FCE E5      2970 PUSH	HL
000FCF FD      2971 LD	A,(IY)
000FD0 7E   
000FD1 00   
000FD2 FE      2972 CP	','
000FD3 2C   
000FD4 20      2973 JR	NZ,RECT1
000FD5 04   
000FD6 CD      2974 CALL	CEXPRI
000FD7 F1   
000FD8 10   
000FD9 D9      2975 EXX
000FDA C1      2976 RECT1:          POP	BC		;w
000FDB D1      2977 POP	DE		;y
000FDC E3      2978 EX	(SP),HL		;HL <- x, (SP) <- h
000FDD C5      2979 PUSH	BC
000FDE EB      2980 EX	DE,HL
000FDF 0E      2981 LD	C,4
000FE0 04   
000FE1 CD      2982 CALL	VDU25
000FE2 C6   
000FE3 10   
000FE4 FD      2983 LD	A,(IY)
000FE5 7E   
000FE6 00   
000FE7 FE      2984 CP	TTO
000FE8 B8   
000FE9 28      2985 JR	Z,RECTTO
000FEA 09   
000FEB D1      2986 POP	DE		;w
000FEC E1      2987 POP	HL		;h
000FED F1      2988 POP	AF
000FEE 20      2989 JR	NZ,OUTLIN
000FEF 22   
000FF0 0E      2990 LD	C,97
000FF1 61   
000FF2 18      2991 JR	PLOT4
000FF3 BF   
000FF4 FD      2995 RECTTO:         INC	IY		; Bump over TO
000FF5 23   
000FF6 CD      2996 CALL	EXPRI
000FF7 33   
000FF8 18   
000FF9 D9      2997 EXX
000FFA E5      2998 PUSH	HL
000FFB CD      2999 CALL	CEXPRI
000FFC F1   
000FFD 10   
000FFE D9      3000 EXX
000FFF C1      3001 POP	BC		;newx
001000 D1      3002 POP	DE		;w
001001 E3      3003 EX	(SP),HL		;HL <- h, (SP) <- newy
001002 C5      3004 PUSH	BC
001003 0E      3005 LD	C,0
001004 00   
001005 CD      3006 CALL	VDU25
001006 C6   
001007 10   
001008 D1      3007 POP	DE		;newx
001009 E1      3008 POP	HL		;newy
00100A F1      3009 POP	AF
00100B 0E      3010 LD	C,190		; PLOT 190 - Block copy
00100C BE   
00100D 20      3011 JR	NZ,PLOT4B
00100E 01   
00100F 0D      3012 DEC	C		; PLOT 189 - Block move
001010 18      3013 PLOT4B:         JR	PLOT4
001011 A1   
001012 0E      3017 OUTLIN:         LD	C,9		; PLOT 9 - draw relative
001013 09   
001014 E5      3018 PUSH	HL
001015 21      3019 LD	HL,0
001016 00   
001017 00   
001018 CD      3020 CALL	VDU25		; side 1
001019 C6   
00101A 10   
00101B E1      3021 POP	HL
00101C D5      3022 PUSH	DE
00101D 11      3023 LD	DE,0
00101E 00   
00101F 00   
001020 CD      3024 CALL	VDU25		; side 2
001021 C6   
001022 10   
001023 D1      3025 POP	DE
001024 E5      3026 PUSH	HL
001025 AF      3027 XOR	A
001026 6F      3028 LD	L,A
001027 67      3029 LD	H,A
001028 ED      3030 SBC	HL,DE
001029 52   
00102A EB      3031 EX	DE,HL
00102B 6F      3032 LD	L,A
00102C 67      3033 LD	H,A
00102D CD      3034 CALL 	VDU25		; side 3
00102E C6   
00102F 10   
001030 D1      3035 POP	DE
001031 AF      3036 XOR	A
001032 6F      3037 LD	L,A
001033 67      3038 LD	H,A
001034 ED      3039 SBC	HL,DE
001035 52   
001036 5F      3040 LD	E,A
001037 57      3041 LD	D,A
001038 18      3042 JR	PLOT4B
001039 D6   
00103A 3E      3046 MOUSE:          LD	A,128
00103B 80   
00103C 21      3047 LD	HL,9
00103D 09   
00103E 00   
00103F CD      3048 CALL	OSBYTE
001040 89   
001041 08   
001042 E5      3049 PUSH	HL
001043 3E      3050 LD	A,128
001044 80   
001045 21      3051 LD	HL,8
001046 08   
001047 00   
001048 CD      3052 CALL	OSBYTE
001049 89   
00104A 08   
00104B E5      3053 PUSH	HL
00104C 3E      3054 LD	A,128
00104D 80   
00104E 21      3055 LD	HL,7
00104F 07   
001050 00   
001051 CD      3056 CALL	OSBYTE
001052 89   
001053 08   
001054 E5      3057 PUSH	HL
001055 CD      3058 CALL	VAR_
001056 D6   
001057 25   
001058 E1      3059 POP	HL
001059 CD      3060 CALL	STOREI
00105A F7   
00105B 10   
00105C CD      3061 CALL	COMMA
00105D A2   
00105E 20   
00105F CD      3062 CALL	NXT
001060 0B   
001061 45   
001062 CD      3063 CALL	VAR_
001063 D6   
001064 25   
001065 E1      3064 POP	HL
001066 CD      3065 CALL	STOREI
001067 F7   
001068 10   
001069 CD      3066 CALL	COMMA
00106A A2   
00106B 20   
00106C CD      3067 CALL	NXT
00106D 0B   
00106E 45   
00106F CD      3068 CALL	VAR_
001070 D6   
001071 25   
001072 E1      3069 POP	HL
001073 CD      3070 CALL	STOREI
001074 F7   
001075 10   
001076 C3      3071 XEQGO2:         JP	XEQ
001077 99   
001078 24   
001079 CD      3075 WAIT:           CALL	TERMQ
00107A 36   
00107B 35   
00107C 28      3076 JR	Z,XEQGO2
00107D F8   
00107E CD      3077 CALL	EXPRI
00107F 33   
001080 18   
001081 D9      3078 EXX
001082 44      3079 LD	B,H
001083 4D      3080 LD	C,L
001084 CD      3081 CALL	GETIME
001085 29   
001086 0D   
001087 09      3082 ADD	HL,BC
001088 01      3083 LD	BC,0
001089 00   
00108A 00   
00108B EB      3084 EX	DE,HL
00108C ED      3085 ADC	HL,BC
00108D 4A   
00108E EB      3086 EX	DE,HL
00108F CD      3087 WAIT1:          CALL	TRAP
001090 33   
001091 06   
001092 D5      3088 PUSH	DE
001093 E5      3089 PUSH	HL
001094 CD      3090 CALL	GETIME
001095 29   
001096 0D   
001097 C1      3091 POP	BC
001098 B7      3092 OR	A
001099 ED      3093 SBC	HL,BC
00109A 42   
00109B 60      3094 LD	H,B
00109C 69      3095 LD	L,C
00109D EB      3096 EX	DE,HL
00109E C1      3097 POP	BC
00109F ED      3098 SBC	HL,BC
0010A0 42   
0010A1 30      3099 JR	NC,XEQGO2
0010A2 D3   
0010A3 EB      3100 EX	DE,HL
0010A4 50      3101 LD	D,B
0010A5 59      3102 LD	E,C
0010A6 18      3103 JR	WAIT1
0010A7 E7   
0010A8 E1      3107 OSCALL:         POP	HL		;DITCH RETURN ADDRESS
0010A9 21      3108 LD	HL,OSRET
0010AA BB   
0010AB 10   
0010AC E5      3109 PUSH	HL		;NEW RETURN ADDRESS
0010AD DD      3110 LD	A,(IX+4)	;A%
0010AE 7E   
0010AF 04   
0010B0 DD      3111 LD	E,(IX+20)	;E%
0010B1 5E   
0010B2 14   
0010B3 DD      3112 LD	H,(IX+100)	;Y%
0010B4 66   
0010B5 64   
0010B6 DD      3113 LD	L,(IX+96)	;X%
0010B7 6E   
0010B8 60   
0010B9 FD      3114 JP	(IY)
0010BA E9   
0010BB F5      3115 OSRET:          PUSH	AF
0010BC 7D      3116 LD	A,L		;F  H  L  A
0010BD 6C      3117 LD	L,H		;|  |  |  |
0010BE D9      3118 EXX			;|  |  |  |
0010BF C1      3119 POP	BC		;|  |  |  |
0010C0 67      3120 LD	H,A		;|  |  |  |
0010C1 68      3121 LD	L,B		;H  L  H' L'
0010C2 79      3122 LD	A,C
0010C3 D9      3123 EXX
0010C4 67      3124 LD	H,A
0010C5 C9      3125 RET
0010C6 06      3127 VDU25:          LD	B,25
0010C7 19   
0010C8 78      3128 WRCH6:          LD	A,B
0010C9 CD      3129 CALL	OSWRCH
0010CA B1   
0010CB 05   
0010CC 79      3130 WRCH5:          LD	A,C
0010CD CD      3131 CALL	OSWRCH
0010CE B1   
0010CF 05   
0010D0 7B      3132 WRCH4:          LD	A,E
0010D1 CD      3133 CALL	OSWRCH
0010D2 B1   
0010D3 05   
0010D4 7A      3134 WRCH3:          LD	A,D
0010D5 CD      3135 CALL	OSWRCH
0010D6 B1   
0010D7 05   
0010D8 7D      3136 WRCH2:          LD	A,L
0010D9 CD      3137 CALL	OSWRCH
0010DA B1   
0010DB 05   
0010DC 7C      3138 LD	A,H
0010DD C3      3139 JP	OSWRCH
0010DE B1   
0010DF 05   
0010E0 CD      3141 EXPR3:          CALL	CEXPRI
0010E1 F1   
0010E2 10   
0010E3 D9      3142 EXX
0010E4 E5      3143 PUSH	HL
0010E5 CD      3144 CALL	CEXPRI
0010E6 F1   
0010E7 10   
0010E8 D9      3145 EXX
0010E9 E5      3146 PUSH	HL
0010EA CD      3147 CALL	CEXPRI
0010EB F1   
0010EC 10   
0010ED D9      3148 EXX
0010EE C1      3149 POP	BC		;x2
0010EF D1      3150 POP	DE		;y1
0010F0 C9      3151 RET
0010F1 CD      3153 CEXPRI:         CALL	COMMA
0010F2 A2   
0010F3 20   
0010F4 C3      3154 JP	EXPRI
0010F5 33   
0010F6 18   
0010F7 CB      3156 STOREI:         BIT	7,A
0010F8 7F   
0010F9 20      3157 JR	NZ,EEK
0010FA 0C   
0010FB CB      3158 BIT	6,A
0010FC 77   
0010FD 20      3159 JR	NZ,EEK
0010FE 08   
0010FF D9      3160 EXX
001100 21      3161 LD	HL,0
001101 00   
001102 00   
001103 4D      3162 LD	C,L
001104 C3      3163 JP	STOREN
001105 F0   
001106 31   
001107 3E      3165 EEK:            LD	A,50
001108 32   
001109 CD      3166 CALL	EXTERR
00110A 55   
00110B 3F   
00110C 13      3167 DB	13H		;'Bad '
00110D 04      3168 DB	04H		;'MOUSE'
00110E 20      3169 DB	20H
00110F 15      3170 DB	15H		;'variable'
001110 00      3171 DB	0
001111 AF      3176 XOR	A
001112 CD      3177 CALL	EXTERR
001113 55   
001114 3F   
001115 53      3178 DB	"Sorry"
001116 6F   
001117 72   
001118 72   
001119 79   
00111A 00      3179 DB	0
00111B             3184   ; --- Begin asmb.asm ---
00111B CD      3231 ASSEM:          CALL	SKIP
00111C A3   
00111D 14   
00111E FD      3232 INC	IY
00111F 23   
001120 FE      3233 CP	':'
001121 3A   
001122 28      3234 JR	Z,ASSEM
001123 F7   
001124 FE      3235 CP	']'
001125 5D   
001126 C8      3236 RET	Z
001127 FE      3237 CP	CR
001128 0D   
001129 C8      3238 RET	Z
00112A FD      3239 DEC	IY
00112B 2B   
00112C DD      3240 LD	IX,(PC)		;PROGRAM COUNTER
00112D 2A   
00112E 40   
00112F 54   
001130 21      3241 LD	HL,LISTON
001131 FE   
001132 54   
001133 CB      3242 BIT	6,(HL)
001134 76   
001135 28      3243 JR	Z,ASSEM0
001136 04   
001137 DD      3244 LD	IX,(OC)		;ORIGIN of CODE
001138 2A   
001139 3C   
00113A 54   
00113B DD      3245 ASSEM0:         PUSH	IX
00113C E5   
00113D FD      3246 PUSH	IY
00113E E5   
00113F CD      3247 CALL	ASMB
001140 CF   
001141 11   
001142 C1      3248 POP	BC
001143 D1      3249 POP	DE
001144 D8      3250 RET	C
001145 CD      3251 CALL	SKIP
001146 A3   
001147 14   
001148 37      3252 SCF
001149 C0      3253 RET	NZ
00114A FD      3254 DEC	IY
00114B 2B   
00114C FD      3255 ASSEM3:         INC	IY
00114D 23   
00114E FD      3256 LD	A,(IY)
00114F 7E   
001150 00   
001151 CD      3257 CALL	TERM0
001152 C7   
001153 14   
001154 20      3258 JR	NZ,ASSEM3
001155 F6   
001156 3A      3259 LD	A,(LISTON)
001157 FE   
001158 54   
001159 DD      3260 PUSH	IX
00115A E5   
00115B E1      3261 POP	HL
00115C B7      3262 OR	A
00115D ED      3263 SBC	HL,DE
00115E 52   
00115F EB      3264 EX	DE,HL		;DE= NO. OF BYTES
001160 E5      3265 PUSH	HL
001161 2A      3266 LD	HL,(PC)
001162 40   
001163 54   
001164 E5      3267 PUSH	HL
001165 19      3268 ADD	HL,DE
001166 22      3269 LD	(PC),HL		;UPDATE PC
001167 40   
001168 54   
001169 CB      3270 BIT	6,A
00116A 77   
00116B 28      3271 JR	Z,ASSEM5
00116C 07   
00116D 2A      3272 LD	HL,(OC)
00116E 3C   
00116F 54   
001170 19      3273 ADD	HL,DE
001171 22      3274 LD	(OC),HL		;UPDATE OC
001172 3C   
001173 54   
001174 E1      3275 ASSEM5:         POP	HL		;OLD PC
001175 DD      3276 POP	IX		;CODE HERE
001176 E1   
001177 CB      3277 BIT	4,A
001178 67   
001179 28      3278 JR	Z,ASSEM
00117A A0   
00117B 7C      3279 LD	A,H
00117C CD      3280 CALL	HEX
00117D BB   
00117E 11   
00117F 7D      3281 LD	A,L
001180 CD      3282 CALL	HEXSP
001181 B4   
001182 11   
001183 AF      3283 XOR	A
001184 BB      3284 CP	E
001185 28      3285 JR	Z,ASSEM2
001186 15   
001187 3A      3286 ASSEM1:         LD	A,(COUNT)
001188 FB   
001189 54   
00118A FE      3287 CP	17
00118B 11   
00118C 3E      3288 LD	A,5
00118D 05   
00118E D4      3289 CALL	NC,TABIT	;NEXT LINE
00118F 7D   
001190 35   
001191 DD      3290 LD	A,(IX)
001192 7E   
001193 00   
001194 CD      3291 CALL	HEXSP
001195 B4   
001196 11   
001197 DD      3292 INC	IX
001198 23   
001199 1D      3293 DEC	E
00119A 20      3294 JR	NZ,ASSEM1
00119B EB   
00119C 3E      3295 ASSEM2:         LD	A,18
00119D 12   
00119E CD      3296 CALL	TABIT
00119F 7D   
0011A0 35   
0011A1 FD      3297 PUSH	IY
0011A2 E5   
0011A3 E1      3298 POP	HL
0011A4 ED      3299 SBC	HL,BC
0011A5 42   
0011A6 0A      3300 ASSEM4:         LD	A,(BC)
0011A7 CD      3301 CALL	OUT
0011A8 1B   
0011A9 41   
0011AA 03      3302 INC	BC
0011AB 2D      3303 DEC	L
0011AC 20      3304 JR	NZ,ASSEM4
0011AD F8   
0011AE CD      3305 CALL	CRLF
0011AF FB   
0011B0 40   
0011B1 C3      3306 JP	ASSEM
0011B2 1B   
0011B3 11   
0011B4 CD      3308 HEXSP:          CALL	HEX
0011B5 BB   
0011B6 11   
0011B7 3E      3309 LD	A,' '
0011B8 20   
0011B9 18      3310 JR	OUTCH1
0011BA 11   
0011BB F5      3311 HEX:            PUSH	AF
0011BC 0F      3312 RRCA
0011BD 0F      3313 RRCA
0011BE 0F      3314 RRCA
0011BF 0F      3315 RRCA
0011C0 CD      3316 CALL	HEXOUT
0011C1 C4   
0011C2 11   
0011C3 F1      3317 POP	AF
0011C4 E6      3318 HEXOUT:         AND	0FH
0011C5 0F   
0011C6 C6      3319 ADD	A,90H
0011C7 90   
0011C8 27      3320 DAA
0011C9 CE      3321 ADC	A,40H
0011CA 40   
0011CB 27      3322 DAA
0011CC C3      3323 OUTCH1:         JP	OUT
0011CD 1B   
0011CE 41   
0011CF FE      3337 ASMB:           CP	'.'
0011D0 2E   
0011D1 20      3338 JR	NZ,ASMB1
0011D2 28   
0011D3 FD      3339 INC	IY
0011D4 23   
0011D5 DD      3340 PUSH	IX
0011D6 E5   
0011D7 CD      3341 CALL	VAR_
0011D8 D6   
0011D9 25   
0011DA F5      3342 PUSH	AF
0011DB CD      3343 CALL	ZERO
0011DC F8   
0011DD 1F   
0011DE D9      3344 EXX
0011DF 2A      3345 LD	HL,(PC)
0011E0 40   
0011E1 54   
0011E2 D9      3346 EXX
0011E3 3A      3347 LD	A,(LISTON)
0011E4 FE   
0011E5 54   
0011E6 E6      3348 AND	20H
0011E7 20   
0011E8 20      3349 JR	NZ,ASMB0
0011E9 0B   
0011EA DD      3350 LD	A,(IX)
0011EB 7E   
0011EC 00   
0011ED DD      3351 OR	(IX+1)
0011EE B6   
0011EF 01   
0011F0 3E      3352 LD	A,3
0011F1 03   
0011F2 C2      3353 JP	NZ,ERROR_	;Multiple label
0011F3 44   
0011F4 3F   
0011F5 F1      3354 ASMB0:          POP	AF
0011F6 CD      3355 CALL	STOREN
0011F7 F0   
0011F8 31   
0011F9 DD      3356 POP	IX
0011FA E1   
0011FB CD      3357 ASMB1:          CALL	SKIP
0011FC A3   
0011FD 14   
0011FE C8      3358 RET	Z
0011FF FE      3359 CP	TCALL
001200 D6   
001201 0E      3360 LD	C,0C4H
001202 C4   
001203 FD      3361 INC	IY
001204 23   
001205 CA      3362 JP	Z,GRPC
001206 F2   
001207 12   
001208 FD      3363 DEC	IY
001209 2B   
00120A 21      3364 LD	HL,OPCODS
00120B CD   
00120C 14   
00120D CD      3365 CALL	FIND
00120E 5A   
00120F 14   
001210 D8      3366 RET	C
001211 48      3367 LD	C,B	;ROOT OPCODE
001212 16      3368 LD	D,0	;CLEAR IX/IY FLAG
001213 00   
001214 D6      3373 SUB	39
001215 27   
001216 30      3374 JR	NC,GROUP2
001217 07   
001218 FE      3375 CP	15-39
001219 E8   
00121A D4      3376 CALL	NC,ED
00121B C0   
00121C 13   
00121D 18      3377 JR	BYTE0
00121E 68   
00121F D6      3382 GROUP2:         SUB	10
001220 0A   
001221 30      3383 JR	NC,GROUP4
001222 0F   
001223 FE      3384 CP	3-10
001224 F9   
001225 DC      3385 CALL	C,BIT
001226 4A   
001227 14   
001228 D8      3386 RET	C
001229 CD      3387 CALL	REGLO
00122A 1F   
00122B 14   
00122C D8      3388 RET	C
00122D CD      3389 CALL	CB
00122E C4   
00122F 13   
001230 18      3390 JR	BYTE0
001231 55   
001232 D6      3394 GROUP4:         SUB	3
001233 03   
001234 30      3395 JR	NC,GROUP5
001235 06   
001236 CD      3396 G4:             CALL	PAIRasm
001237 3E   
001238 14   
001239 D8      3397 RET	C
00123A 18      3398 JR	BYTE0
00123B 4B   
00123C D6      3403 GROUP5:         SUB	8+2
00123D 0A   
00123E 30      3404 JR	NC,GROUP7
00123F 32   
001240 FE      3405 CP	5-8
001241 FD   
001242 06      3406 LD	B,7
001243 07   
001244 D4      3407 CALL	NC,OPND
001245 D2   
001246 13   
001247 78      3408 LD	A,B
001248 FE      3409 CP	7
001249 07   
00124A 20      3410 JR	NZ,G6HL
00124B 10   
00124C CD      3411 G6:             CALL	REGLO
00124D 1F   
00124E 14   
00124F 79      3412 LD	A,C
001250 30      3413 JR	NC,BIND1
001251 28   
001252 EE      3414 XOR	46H
001253 46   
001254 CD      3415 CALL	BIND
001255 C6   
001256 13   
001257 CD      3416 DB:             CALL	NUMBER
001258 02   
001259 14   
00125A 18      3417 JR	VAL8
00125B 78   
00125C E6      3419 G6HL:           AND	3FH
00125D 3F   
00125E FE      3420 CP	12
00125F 0C   
001260 37      3421 SCF
001261 C0      3422 RET	NZ
001262 79      3423 LD	A,C
001263 FE      3424 CP	80H
001264 80   
001265 0E      3425 LD	C,9
001266 09   
001267 28      3426 JR	Z,G4
001268 CD   
001269 EE      3427 XOR	1CH
00126A 1C   
00126B 0F      3428 RRCA
00126C 4F      3429 LD	C,A
00126D CD      3430 CALL	ED
00126E C0   
00126F 13   
001270 18      3431 JR	G4
001271 C4   
001272 D6      3435 GROUP7:         SUB	2
001273 02   
001274 30      3436 JR	NC,GROUP8
001275 14   
001276 CD      3437 CALL	REGHI
001277 25   
001278 14   
001279 79      3438 LD	A,C
00127A D2      3439 BIND1:          JP	NC,BIND
00127B C6   
00127C 13   
00127D EE      3440 XOR	64H
00127E 64   
00127F 07      3441 RLCA
001280 07      3442 RLCA
001281 07      3443 RLCA
001282 4F      3444 LD	C,A
001283 CD      3445 CALL	PAIR1asm
001284 42   
001285 14   
001286 D8      3446 RET	C
001287 79      3447 BYTE0:          LD	A,C
001288 18      3448 JR	BYTE2
001289 7F   
00128A D6      3453 GROUP8:         SUB	2
00128B 02   
00128C 30      3454 JR	NC,GROUPA
00128D 21   
00128E FE      3455 CP	1-2
00128F FF   
001290 CC      3456 CALL	Z,CORN
001291 B5   
001292 13   
001293 08      3457 EX	AF,AF'
001294 CD      3458 CALL	REGHI
001295 25   
001296 14   
001297 D8      3459 RET	C
001298 08      3460 EX	AF,AF'
001299 DC      3461 CALL	C,CORN
00129A B5   
00129B 13   
00129C 24      3462 INC	H
00129D 28      3463 JR	Z,BYTE0
00129E E8   
00129F 78      3464 LD	A,B
0012A0 FE      3465 CP	7
0012A1 07   
0012A2 37      3466 SCF
0012A3 C0      3467 RET	NZ
0012A4 79      3468 LD	A,C
0012A5 EE      3469 XOR	3
0012A6 03   
0012A7 07      3470 RLCA
0012A8 07      3471 RLCA
0012A9 07      3472 RLCA
0012AA CD      3473 CALL	BYTE
0012AB F2   
0012AC 13   
0012AD 18      3474 JR	VAL8
0012AE 25   
0012AF D6      3478 GROUPA:         SUB	2
0012B0 02   
0012B1 30      3479 JR	NC,GROUPB
0012B2 24   
0012B3 FE      3480 CP	1-2
0012B4 FF   
0012B5 C4      3481 CALL	NZ,COND_
0012B6 2B   
0012B7 14   
0012B8 79      3482 LD	A,C
0012B9 30      3483 JR	NC,GRPA
0012BA 02   
0012BB 3E      3484 LD	A,18H
0012BC 18   
0012BD CD      3485 GRPA:           CALL	BYTE
0012BE F2   
0012BF 13   
0012C0 CD      3486 CALL	NUMBER
0012C1 02   
0012C2 14   
0012C3 ED      3487 LD	DE,(PC)
0012C4 5B   
0012C5 40   
0012C6 54   
0012C7 13      3488 INC	DE
0012C8 37      3489 SCF
0012C9 ED      3490 SBC	HL,DE
0012CA 52   
0012CB 7D      3491 LD	A,L
0012CC 17      3492 RLA
0012CD 9F      3493 SBC	A,A
0012CE BC      3494 CP	H
0012CF 3E      3495 TOOFAR:         LD	A,1
0012D0 01   
0012D1 C2      3496 JP	NZ,ERROR_	;"Out of range"
0012D2 44   
0012D3 3F   
0012D4 7D      3497 VAL8:           LD	A,L
0012D5 18      3498 JR	BYTE2
0012D6 32   
0012D7 47      3502 GROUPB:         LD	B,A
0012D8 20      3503 JR	NZ,GROUPC
0012D9 16   
0012DA CD      3504 CALL	COND_
0012DB 2B   
0012DC 14   
0012DD 79      3505 LD	A,C
0012DE 30      3506 JR	NC,GRPB
0012DF 0B   
0012E0 78      3507 LD	A,B
0012E1 E6      3508 AND	3FH
0012E2 3F   
0012E3 FE      3509 CP	6
0012E4 06   
0012E5 3E      3510 LD	A,0E9H
0012E6 E9   
0012E7 28      3511 JR	Z,BYTE2
0012E8 20   
0012E9 3E      3512 LD	A,0C3H
0012EA C3   
0012EB CD      3513 GRPB:           CALL	BYTE
0012EC F2   
0012ED 13   
0012EE 18      3514 JR	ADDR_
0012EF 05   
0012F0 10      3518 GROUPC:         DJNZ	GROUPD
0012F1 0C   
0012F2 CD      3519 GRPC:           CALL	GRPE
0012F3 0D   
0012F4 13   
0012F5 CD      3520 ADDR_:          CALL	NUMBER
0012F6 02   
0012F7 14   
0012F8 CD      3521 VAL16:          CALL	VAL8
0012F9 D4   
0012FA 12   
0012FB 7C      3522 LD	A,H
0012FC 18      3523 JR	BYTE2
0012FD 0B   
0012FE 10      3527 GROUPD:         DJNZ	GROUPE
0012FF 0B   
001300 CD      3528 CALL	NUMBER
001301 02   
001302 14   
001303 A1      3529 AND	C
001304 B4      3530 OR	H
001305 20      3531 JR	NZ,TOOFAR
001306 C8   
001307 7D      3532 LD	A,L
001308 B1      3533 OR	C
001309 18      3534 BYTE2:          JR	BYTE1
00130A 78   
00130B 10      3538 GROUPE:         DJNZ	GROUPF
00130C 0A   
00130D CD      3539 GRPE:           CALL	COND_
00130E 2B   
00130F 14   
001310 79      3540 LD	A,C
001311 30      3541 JR	NC,BYTE1
001312 70   
001313 F6      3542 OR	9
001314 09   
001315 18      3543 JR	BYTE1
001316 6C   
001317 10      3547 GROUPF:         DJNZ	MISC
001318 6C   
001319 CD      3548 CALL	LDOP
00131A 57   
00131B 14   
00131C 30      3549 JR	NC,LDA
00131D 5F   
00131E CD      3550 CALL	REGHI
00131F 25   
001320 14   
001321 08      3551 EX	AF,AF'
001322 CD      3552 CALL	SKIP
001323 A3   
001324 14   
001325 FE      3553 CP	'('
001326 28   
001327 28      3554 JR	Z,LDIN
001328 1D   
001329 08      3555 EX	AF,AF'
00132A D2      3556 JP	NC,G6
00132B 4C   
00132C 12   
00132D 0E      3557 LD	C,1
00132E 01   
00132F CD      3558 CALL	PAIR1asm
001330 42   
001331 14   
001332 D8      3559 RET	C
001333 3E      3560 LD	A,14
001334 0E   
001335 B8      3561 CP	B
001336 47      3562 LD	B,A
001337 CC      3563 CALL	Z,PAIRasm
001338 3E   
001339 14   
00133A 78      3564 LD	A,B
00133B E6      3565 AND	3FH
00133C 3F   
00133D FE      3566 CP	12
00133E 0C   
00133F 79      3567 LD	A,C
001340 20      3568 JR	NZ,GRPB
001341 A9   
001342 3E      3569 LD	A,0F9H
001343 F9   
001344 18      3570 JR	BYTE1
001345 3D   
001346 08      3572 LDIN:           EX	AF,AF'
001347 C5      3573 PUSH	BC
001348 D4      3574 CALL	NC,REGLO
001349 1F   
00134A 14   
00134B 79      3575 LD	A,C
00134C C1      3576 POP	BC
00134D 30      3577 JR	NC,BIND
00134E 77   
00134F 0E      3578 LD	C,0AH
001350 0A   
001351 CD      3579 CALL	PAIR1asm
001352 42   
001353 14   
001354 CD      3580 CALL	LD16
001355 9C   
001356 13   
001357 30      3581 JR	NC,GRPB
001358 92   
001359 CD      3582 CALL	NUMBER
00135A 02   
00135B 14   
00135C 0E      3583 LD	C,2
00135D 02   
00135E CD      3584 CALL	PAIRasm
00135F 3E   
001360 14   
001361 CD      3585 CALL	LD16
001362 9C   
001363 13   
001364 D8      3586 RET	C
001365 CD      3587 CALL	BYTE
001366 F2   
001367 13   
001368 18      3588 JR	VAL16
001369 8E   
00136A 05      3592 OPT:            DEC	B
00136B CA      3593 JP	Z,DB
00136C 57   
00136D 12   
00136E 10      3594 DJNZ	ADDR_
00136F 85   
001370 CD      3595 CALL	NUMBER
001371 02   
001372 14   
001373 21      3596 LD	HL,LISTON
001374 FE   
001375 54   
001376 4F      3597 LD	C,A
001377 ED      3598 RLD
001378 6F   
001379 79      3599 LD	A,C
00137A ED      3600 RRD
00137B 67   
00137C C9      3601 RET
00137D FE      3603 LDA:            CP	4
00137E 04   
00137F DC      3604 CALL	C,ED
001380 C0   
001381 13   
001382 78      3605 LD	A,B
001383 18      3606 BYTE1:          JR	BYTE
001384 6D   
001385 10      3610 MISC:           DJNZ	OPT
001386 E3   
001387 DD      3611 PUSH	IX
001388 E5   
001389 CD      3612 CALL	EXPRS
00138A 3C   
00138B 18   
00138C DD      3613 POP	IX
00138D E1   
00138E 21      3614 LD	HL,ACCS
00138F 00   
001390 52   
001391 AF      3615 DEFM1:          XOR	A
001392 BB      3616 CP	E
001393 C8      3617 RET	Z
001394 7E      3618 LD	A,(HL)
001395 23      3619 INC	HL
001396 CD      3620 CALL	BYTE
001397 F2   
001398 13   
001399 1D      3621 DEC	E
00139A 18      3622 JR	DEFM1
00139B F5   
00139C 78      3626 LD16:           LD	A,B
00139D 38      3627 JR	C,LD8
00139E 0E   
00139F 78      3628 LD	A,B
0013A0 E6      3629 AND	3FH
0013A1 3F   
0013A2 FE      3630 CP	12
0013A3 0C   
0013A4 79      3631 LD	A,C
0013A5 C8      3632 RET	Z
0013A6 CD      3633 CALL	ED
0013A7 C0   
0013A8 13   
0013A9 79      3634 LD	A,C
0013AA F6      3635 OR	43H
0013AB 43   
0013AC C9      3636 RET
0013AD FE      3638 LD8:            CP	7
0013AE 07   
0013AF 37      3639 SCF
0013B0 C0      3640 RET	NZ
0013B1 79      3641 LD	A,C
0013B2 F6      3642 OR	30H
0013B3 30   
0013B4 C9      3643 RET
0013B5 C5      3645 CORN:           PUSH	BC
0013B6 CD      3646 CALL	OPND
0013B7 D2   
0013B8 13   
0013B9 CB      3647 BIT	5,B
0013BA 68   
0013BB C1      3648 POP	BC
0013BC 28      3649 JR	Z,NUMBER
0013BD 44   
0013BE 26      3650 LD	H,-1
0013BF FF   
0013C0 3E      3651 ED:             LD	A,0EDH
0013C1 ED   
0013C2 18      3652 JR	BYTE
0013C3 2E   
0013C4 3E      3654 CB:             LD	A,0CBH
0013C5 CB   
0013C6 FE      3655 BIND:           CP	76H
0013C7 76   
0013C8 37      3656 SCF
0013C9 C8      3657 RET	Z		;REJECT LD (HL),(HL)
0013CA CD      3658 CALL	BYTE
0013CB F2   
0013CC 13   
0013CD 14      3659 INC	D
0013CE F0      3660 RET	P
0013CF 7B      3661 LD	A,E
0013D0 18      3662 JR	BYTE
0013D1 20   
0013D2 E5      3664 OPND:           PUSH	HL
0013D3 21      3665 LD	HL,OPRNDS
0013D4 14   
0013D5 16   
0013D6 CD      3666 CALL	FIND
0013D7 5A   
0013D8 14   
0013D9 E1      3667 POP	HL
0013DA D8      3668 RET	C
0013DB CB      3669 BIT	7,B
0013DC 78   
0013DD C8      3670 RET	Z
0013DE CB      3671 BIT	3,B
0013DF 58   
0013E0 E5      3672 PUSH	HL
0013E1 CC      3673 CALL	Z,OFFSETasm
0013E2 F9   
0013E3 13   
0013E4 5D      3674 LD	E,L
0013E5 E1      3675 POP	HL
0013E6 3E      3676 LD	A,0DDH
0013E7 DD   
0013E8 CB      3677 BIT	6,B
0013E9 70   
0013EA 28      3678 JR	Z,OP1
0013EB 02   
0013EC 3E      3679 LD	A,0FDH
0013ED FD   
0013EE B7      3680 OP1:            OR	A
0013EF 14      3681 INC	D
0013F0 57      3682 LD	D,A
0013F1 F8      3683 RET	M
0013F2 DD      3684 BYTE:           LD	(IX),A
0013F3 77   
0013F4 00   
0013F5 DD      3685 INC	IX
0013F6 23   
0013F7 B7      3686 OR	A
0013F8 C9      3687 RET
0013F9 FD      3689 OFFSETasm:         LD	A,(IY)
0013FA 7E   
0013FB 00   
0013FC FE      3690 CP	')'
0013FD 29   
0013FE 21      3691 LD	HL,0
0013FF 00   
001400 00   
001401 C8      3692 RET	Z
001402 CD      3693 NUMBER:         CALL	SKIP
001403 A3   
001404 14   
001405 C5      3694 PUSH	BC
001406 D5      3695 PUSH	DE
001407 DD      3696 PUSH	IX
001408 E5   
001409 CD      3697 CALL	EXPRI
00140A 33   
00140B 18   
00140C DD      3698 POP	IX
00140D E1   
00140E D9      3699 EXX
00140F D1      3700 POP	DE
001410 C1      3701 POP	BC
001411 7D      3702 LD	A,L
001412 B7      3703 OR	A
001413 C9      3704 RET
001414 CD      3706 REG:            CALL	OPND
001415 D2   
001416 13   
001417 D8      3707 RET	C
001418 78      3708 LD	A,B
001419 E6      3709 AND	3FH
00141A 3F   
00141B FE      3710 CP	8
00141C 08   
00141D 3F      3711 CCF
00141E C9      3712 RET
00141F CD      3714 REGLO:          CALL	REG
001420 14   
001421 14   
001422 D8      3715 RET	C
001423 18      3716 JR	ORC
001424 2F   
001425 CD      3718 REGHI:          CALL	REG
001426 14   
001427 14   
001428 D8      3719 RET	C
001429 18      3720 JR	SHL3
00142A 26   
00142B CD      3722 COND_:          CALL	OPND
00142C D2   
00142D 13   
00142E D8      3723 RET	C
00142F 78      3724 LD	A,B
001430 E6      3725 AND	1FH
001431 1F   
001432 D6      3726 SUB	16
001433 10   
001434 30      3727 JR	NC,SHL3
001435 1B   
001436 FE      3728 CP	-15
001437 F1   
001438 37      3729 SCF
001439 C0      3730 RET	NZ
00143A 3E      3731 LD	A,3
00143B 03   
00143C 18      3732 JR	SHL3
00143D 13   
00143E CD      3734 PAIRasm:           CALL	OPND
00143F D2   
001440 13   
001441 D8      3735 RET	C
001442 78      3736 PAIR1asm:          LD	A,B
001443 E6      3737 AND	0FH
001444 0F   
001445 D6      3738 SUB	8
001446 08   
001447 D8      3739 RET	C
001448 18      3740 JR	SHL3
001449 07   
00144A CD      3742 BIT:            CALL	NUMBER
00144B 02   
00144C 14   
00144D FE      3743 CP	8
00144E 08   
00144F 3F      3744 CCF
001450 D8      3745 RET	C
001451 07      3746 SHL3:           RLCA
001452 07      3747 RLCA
001453 07      3748 RLCA
001454 B1      3749 ORC:            OR	C
001455 4F      3750 LD	C,A
001456 C9      3751 RET
001457 21      3753 LDOP:           LD	HL,LDOPS
001458 59   
001459 16   
00145A CD      3754 FIND:           CALL	SKIP
00145B A3   
00145C 14   
00145D 06      3755 EXIT:           LD	B,0
00145E 00   
00145F 37      3756 SCF
001460 C8      3757 RET	Z
001461 FE      3758 CP	TDEF
001462 DD   
001463 28      3759 JR	Z,FIND0
001464 04   
001465 FE      3760 CP	TOR+1
001466 85   
001467 3F      3761 CCF
001468 D8      3762 RET	C
001469 7E      3763 FIND0:          LD	A,(HL)
00146A B7      3764 OR	A
00146B 28      3765 JR	Z,EXIT
00146C F0   
00146D FD      3766 XOR	(IY)
00146E AE   
00146F 00   
001470 E6      3767 AND	01011111B
001471 5F   
001472 28      3768 JR	Z,FIND2
001473 09   
001474 CB      3769 FIND1:          BIT	7,(HL)
001475 7E   
001476 23      3770 INC	HL
001477 28      3771 JR	Z,FIND1
001478 FB   
001479 23      3772 INC	HL
00147A 04      3773 INC	B
00147B 18      3774 JR	FIND0
00147C EC   
00147D FD      3776 FIND2:          PUSH	IY
00147E E5   
00147F CB      3777 FIND3:          BIT	7,(HL)
001480 7E   
001481 FD      3778 INC	IY
001482 23   
001483 23      3779 INC	HL
001484 20      3780 JR	NZ,FIND5
001485 10   
001486 BE      3781 CP	(HL)
001487 CC      3782 CALL	Z,SKIP0
001488 A2   
001489 14   
00148A 7E      3783 LD	A,(HL)
00148B FD      3784 XOR	(IY)
00148C AE   
00148D 00   
00148E E6      3785 AND	01011111B
00148F 5F   
001490 28      3786 JR	Z,FIND3
001491 ED   
001492 FD      3787 FIND4:          POP	IY
001493 E1   
001494 18      3788 JR	FIND1
001495 DE   
001496 CD      3790 FIND5:          CALL	DELIM
001497 B5   
001498 14   
001499 C4      3791 CALL	NZ,SIGN
00149A AF   
00149B 14   
00149C 20      3792 JR	NZ,FIND4
00149D F4   
00149E 78      3793 FIND6:          LD	A,B
00149F 46      3794 LD	B,(HL)
0014A0 E1      3795 POP	HL
0014A1 C9      3796 RET
0014A2 23      3798 SKIP0:          INC	HL
0014A3 CD      3799 SKIP:           CALL	DELIM
0014A4 B5   
0014A5 14   
0014A6 C0      3800 RET	NZ
0014A7 CD      3801 CALL	TERM
0014A8 C1   
0014A9 14   
0014AA C8      3802 RET	Z
0014AB FD      3803 INC	IY
0014AC 23   
0014AD 18      3804 JR	SKIP
0014AE F4   
0014AF FE      3806 SIGN:           CP	'+'
0014B0 2B   
0014B1 C8      3807 RET	Z
0014B2 FE      3808 CP	'-'
0014B3 2D   
0014B4 C9      3809 RET
0014B5 FD      3811 DELIM:          LD	A,(IY)		;ASSEMBLER DELIMITER
0014B6 7E   
0014B7 00   
0014B8 FE      3812 CP	' '
0014B9 20   
0014BA C8      3813 RET	Z
0014BB FE      3814 CP	','
0014BC 2C   
0014BD C8      3815 RET	Z
0014BE FE      3816 CP	')'
0014BF 29   
0014C0 C8      3817 RET	Z
0014C1 FE      3818 TERM:           CP	';'		;ASSEMBLER TERMINATOR
0014C2 3B   
0014C3 C8      3819 RET	Z
0014C4 FE      3820 CP	'\'
0014C5 5C   
0014C6 C8      3821 RET	Z
0014C7 FE      3822 TERM0:          CP	':'		;ASSEMBLER SEPARATOR
0014C8 3A   
0014C9 D0      3823 RET	NC
0014CA FE      3824 CP	CR
0014CB 0D   
0014CC C9      3825 RET
0014CD 4E      3827 OPCODS:         DB	"NO"
0014CE 4F   
0014CF D0      3828 DB	'P'+80H
0014D0 00      3829 DB	0
0014D1 52      3830 DB	"RLC"
0014D2 4C   
0014D3 43   
0014D4 C1      3831 DB	'A'+80H
0014D5 07      3832 DB	7
0014D6 45      3833 DB	"EX"
0014D7 58   
0014D8 00      3834 DB	0
0014D9 41      3835 DB	"AF"
0014DA 46   
0014DB 00      3836 DB	0
0014DC 41      3837 DB	"AF"
0014DD 46   
0014DE 27      3838 DB	"'"+80H
0014DF 08      3839 DB	8
0014E0 52      3840 DB	"RRC"
0014E1 52   
0014E2 43   
0014E3 C1      3841 DB	'A'+80H
0014E4 0F      3842 DB	0FH
0014E5 52      3843 DB	"RL"
0014E6 4C   
0014E7 C1      3844 DB	'A'+80H
0014E8 17      3845 DB	17H
0014E9 52      3846 DB	"RR"
0014EA 52   
0014EB C1      3847 DB	'A'+80H
0014EC 1F      3848 DB	1FH
0014ED 44      3849 DB	"DA"
0014EE 41   
0014EF C1      3850 DB	'A'+80H
0014F0 27      3851 DB	27H
0014F1 43      3852 DB	"CP"
0014F2 50   
0014F3 CC      3853 DB	'L'+80H
0014F4 2F      3854 DB	2FH
0014F5 53      3855 DB	"SC"
0014F6 43   
0014F7 C6      3856 DB	'F'+80H
0014F8 37      3857 DB	37H
0014F9 43      3858 DB	"CC"
0014FA 43   
0014FB C6      3859 DB	'F'+80H
0014FC 3F      3860 DB	3FH
0014FD 48      3861 DB	"HAL"
0014FE 41   
0014FF 4C   
001500 D4      3862 DB	'T'+80H
001501 76      3863 DB	76H
001502 45      3864 DB	"EX"
001503 58   
001504 D8      3865 DB	'X'+80H
001505 D9      3866 DB	0D9H
001506 45      3867 DB	"EX"
001507 58   
001508 00      3868 DB	0
001509 44      3869 DB	"DE"
00150A 45   
00150B 00      3870 DB	0
00150C 48      3871 DB	'H'
00150D CC      3872 DB	'L'+80H
00150E EB      3873 DB	0EBH
00150F 44      3874 DB	'D'
001510 C9      3875 DB	'I'+80H
001511 F3      3876 DB	0F3H
001512 45      3877 DB	'E'
001513 C9      3878 DB	'I'+80H
001514 FB      3879 DB	0FBH
001515 4E      3881 DB	"NE"
001516 45   
001517 C7      3882 DB	'G'+80H
001518 44      3883 DB	44H
001519 49      3884 DB	"IM"
00151A 4D   
00151B 00      3885 DB	0
00151C B0      3886 DB	'0'+80H
00151D 46      3887 DB	46H
00151E 52      3888 DB	"RET"
00151F 45   
001520 54   
001521 CE      3889 DB	'N'+80H
001522 45      3890 DB	45H
001523 52      3891 DB	"RET"
001524 45   
001525 54   
001526 C9      3892 DB	'I'+80H
001527 4D      3893 DB	4DH
001528 49      3894 DB	"IM"
001529 4D   
00152A 00      3895 DB	0
00152B B1      3896 DB	'1'+80H
00152C 56      3897 DB	56H
00152D 49      3898 DB	"IM"
00152E 4D   
00152F 00      3899 DB	0
001530 B2      3900 DB	'2'+80H
001531 5E      3901 DB	5EH
001532 52      3902 DB	"RR"
001533 52   
001534 C4      3903 DB	'D'+80H
001535 67      3904 DB	67H
001536 52      3905 DB	"RL"
001537 4C   
001538 C4      3906 DB	'D'+80H
001539 6F      3907 DB	6FH
00153A 4C      3908 DB	"LD"
00153B 44   
00153C C9      3909 DB	'I'+80H
00153D A0      3910 DB	0A0H
00153E 43      3911 DB	"CP"
00153F 50   
001540 C9      3912 DB	'I'+80H
001541 A1      3913 DB	0A1H
001542 49      3914 DB	"IN"
001543 4E   
001544 C9      3915 DB	'I'+80H
001545 A2      3916 DB	0A2H
001546 4F      3917 DB	"OUT"
001547 55   
001548 54   
001549 C9      3918 DB	'I'+80H
00154A A3      3919 DB	0A3H
00154B 4C      3920 DB	"LD"
00154C 44   
00154D C4      3921 DB	'D'+80H
00154E A8      3922 DB	0A8H
00154F 43      3923 DB	"CP"
001550 50   
001551 C4      3924 DB	'D'+80H
001552 A9      3925 DB	0A9H
001553 49      3926 DB	"IN"
001554 4E   
001555 C4      3927 DB	'D'+80H
001556 AA      3928 DB	0AAH
001557 4F      3929 DB	"OUT"
001558 55   
001559 54   
00155A C4      3930 DB	'D'+80H
00155B AB      3931 DB	0ABH
00155C 4C      3932 DB	"LDI"
00155D 44   
00155E 49   
00155F D2      3933 DB	'R'+80H
001560 B0      3934 DB	0B0H
001561 43      3935 DB	"CPI"
001562 50   
001563 49   
001564 D2      3936 DB	'R'+80H
001565 B1      3937 DB	0B1H
001566 49      3938 DB	"INI"
001567 4E   
001568 49   
001569 D2      3939 DB	'R'+80H
00156A B2      3940 DB	0B2H
00156B 4F      3941 DB	"OTI"
00156C 54   
00156D 49   
00156E D2      3942 DB	'R'+80H
00156F B3      3943 DB	0B3H
001570 4C      3944 DB	"LDD"
001571 44   
001572 44   
001573 D2      3945 DB	'R'+80H
001574 B8      3946 DB	0B8H
001575 43      3947 DB	"CPD"
001576 50   
001577 44   
001578 D2      3948 DB	'R'+80H
001579 B9      3949 DB	0B9H
00157A 49      3950 DB	"IND"
00157B 4E   
00157C 44   
00157D D2      3951 DB	'R'+80H
00157E BA      3952 DB	0BAH
00157F 4F      3953 DB	"OTD"
001580 54   
001581 44   
001582 D2      3954 DB	'R'+80H
001583 BB      3955 DB	0BBH
001584 42      3957 DB	"BI"
001585 49   
001586 D4      3958 DB	'T'+80H
001587 40      3959 DB	40H
001588 52      3960 DB	"RE"
001589 45   
00158A D3      3961 DB	'S'+80H
00158B 80      3962 DB	80H
00158C 53      3963 DB	"SE"
00158D 45   
00158E D4      3964 DB	'T'+80H
00158F C0      3965 DB	0C0H
001590 52      3967 DB	"RL"
001591 4C   
001592 C3      3968 DB	'C'+80H
001593 00      3969 DB	0
001594 52      3970 DB	"RR"
001595 52   
001596 C3      3971 DB	'C'+80H
001597 08      3972 DB	8
001598 52      3973 DB	'R'
001599 CC      3974 DB	'L'+80H
00159A 10      3975 DB	10H
00159B 52      3976 DB	'R'
00159C D2      3977 DB	'R'+80H
00159D 18      3978 DB	18H
00159E 53      3979 DB	"SL"
00159F 4C   
0015A0 C1      3980 DB	'A'+80H
0015A1 20      3981 DB	20H
0015A2 53      3982 DB	"SR"
0015A3 52   
0015A4 C1      3983 DB	'A'+80H
0015A5 28      3984 DB	28H
0015A6 53      3985 DB	"SR"
0015A7 52   
0015A8 CC      3986 DB	'L'+80H
0015A9 38      3987 DB	38H
0015AA 50      3989 DB	"PO"
0015AB 4F   
0015AC D0      3990 DB	'P'+80H
0015AD C1      3991 DB	0C1H
0015AE 50      3992 DB	"PUS"
0015AF 55   
0015B0 53   
0015B1 C8      3993 DB	'H'+80H
0015B2 C5      3994 DB	0C5H
0015B3 45      3995 DB	"EX"
0015B4 58   
0015B5 00      3996 DB	0
0015B6 28      3997 DB	"(S"
0015B7 53   
0015B8 D0      3998 DB	'P'+80H
0015B9 E3      3999 DB	0E3H
0015BA 53      4001 DB	"SU"
0015BB 55   
0015BC C2      4002 DB	'B'+80H
0015BD 90      4003 DB	90H
0015BE 41      4004 DB	"AN"
0015BF 4E   
0015C0 C4      4005 DB	'D'+80H
0015C1 A0      4006 DB	0A0H
0015C2 58      4007 DB	"XO"
0015C3 4F   
0015C4 D2      4008 DB	'R'+80H
0015C5 A8      4009 DB	0A8H
0015C6 4F      4010 DB	'O'
0015C7 D2      4011 DB	'R'+80H
0015C8 B0      4012 DB	0B0H
0015C9 43      4013 DB	'C'
0015CA D0      4014 DB	'P'+80H
0015CB B8      4015 DB	0B8H
0015CC 80      4016 DB	TAND
0015CD A0      4017 DB	0A0H
0015CE 84      4018 DB	TOR
0015CF B0      4019 DB	0B0H
0015D0 41      4021 DB	"AD"
0015D1 44   
0015D2 C4      4022 DB	'D'+80H
0015D3 80      4023 DB	80H
0015D4 41      4024 DB	"AD"
0015D5 44   
0015D6 C3      4025 DB	'C'+80H
0015D7 88      4026 DB	88H
0015D8 53      4027 DB	"SB"
0015D9 42   
0015DA C3      4028 DB	'C'+80H
0015DB 98      4029 DB	98H
0015DC 49      4031 DB	"IN"
0015DD 4E   
0015DE C3      4032 DB	'C'+80H
0015DF 04      4033 DB	4
0015E0 44      4034 DB	"DE"
0015E1 45   
0015E2 C3      4035 DB	'C'+80H
0015E3 05      4036 DB	5
0015E4 49      4038 DB	'I'
0015E5 CE      4039 DB	'N'+80H
0015E6 40      4040 DB	40H
0015E7 4F      4041 DB	"OU"
0015E8 55   
0015E9 D4      4042 DB	'T'+80H
0015EA 41      4043 DB	41H
0015EB 4A      4045 DB	'J'
0015EC D2      4046 DB	'R'+80H
0015ED 20      4047 DB	20H
0015EE 44      4048 DB	"DJN"
0015EF 4A   
0015F0 4E   
0015F1 DA      4049 DB	'Z'+80H
0015F2 10      4050 DB	10H
0015F3 4A      4052 DB	'J'
0015F4 D0      4053 DB	'P'+80H
0015F5 C2      4054 DB	0C2H
0015F6 43      4056 DB	"CAL"
0015F7 41   
0015F8 4C   
0015F9 CC      4057 DB	'L'+80H
0015FA C4      4058 DB	0C4H
0015FB 52      4060 DB	"RS"
0015FC 53   
0015FD D4      4061 DB	'T'+80H
0015FE C7      4062 DB	0C7H
0015FF 52      4064 DB	"RE"
001600 45   
001601 D4      4065 DB	'T'+80H
001602 C0      4066 DB	0C0H
001603 4C      4068 DB	'L'
001604 C4      4069 DB	'D'+80H
001605 40      4070 DB	40H
001606 5D      4072 DB	TDEF & 7FH
001607 CD      4073 DB	'M'+80H
001608 00      4074 DB	0
001609 5D      4076 DB	TDEF & 7FH
00160A C2      4077 DB	'B'+80H
00160B 00      4078 DB	0
00160C 4F      4080 DB	"OP"
00160D 50   
00160E D4      4081 DB	'T'+80H
00160F 00      4082 DB	0
001610 5D      4084 DB	TDEF & 7FH
001611 D7      4085 DB	'W'+80H
001612 00      4086 DB	0
001613 00      4088 DB	0
001614 C2      4090 OPRNDS:         DB	'B'+80H
001615 00      4091 DB	0
001616 C3      4092 DB	'C'+80H
001617 01      4093 DB	1
001618 C4      4094 DB	'D'+80H
001619 02      4095 DB	2
00161A C5      4096 DB	'E'+80H
00161B 03      4097 DB	3
00161C C8      4098 DB	'H'+80H
00161D 04      4099 DB	4
00161E CC      4100 DB	'L'+80H
00161F 05      4101 DB	5
001620 28      4102 DB	"(H"
001621 48   
001622 CC      4103 DB	'L'+80H
001623 06      4104 DB	6
001624 C1      4105 DB	'A'+80H
001625 07      4106 DB	7
001626 28      4107 DB	"(I"
001627 49   
001628 D8      4108 DB	'X'+80H
001629 86      4109 DB	86H
00162A 28      4110 DB	"(I"
00162B 49   
00162C D9      4111 DB	'Y'+80H
00162D C6      4112 DB	0C6H
00162E 42      4114 DB	'B'
00162F C3      4115 DB	'C'+80H
001630 08      4116 DB	8
001631 44      4117 DB	'D'
001632 C5      4118 DB	'E'+80H
001633 0A      4119 DB	10
001634 48      4120 DB	'H'
001635 CC      4121 DB	'L'+80H
001636 0C      4122 DB	12
001637 49      4123 DB	'I'
001638 D8      4124 DB	'X'+80H
001639 8C      4125 DB	8CH
00163A 49      4126 DB	'I'
00163B D9      4127 DB	'Y'+80H
00163C CC      4128 DB	0CCH
00163D 41      4129 DB	'A'
00163E C6      4130 DB	'F'+80H
00163F 0E      4131 DB	14
001640 53      4132 DB	'S'
001641 D0      4133 DB	'P'+80H
001642 0E      4134 DB	14
001643 4E      4136 DB	'N'
001644 DA      4137 DB	'Z'+80H
001645 10      4138 DB	16
001646 DA      4139 DB	'Z'+80H
001647 11      4140 DB	17
001648 4E      4141 DB	'N'
001649 C3      4142 DB	'C'+80H
00164A 12      4143 DB	18
00164B 50      4144 DB	'P'
00164C CF      4145 DB	'O'+80H
00164D 14      4146 DB	20
00164E 50      4147 DB	'P'
00164F C5      4148 DB	'E'+80H
001650 15      4149 DB	21
001651 D0      4150 DB	'P'+80H
001652 16      4151 DB	22
001653 CD      4152 DB	'M'+80H
001654 17      4153 DB	23
001655 28      4155 DB	'('
001656 C3      4156 DB	'C'+80H
001657 20      4157 DB	20H
001658 00      4159 DB	0
001659 49      4161 LDOPS:          DB	'I'
00165A 00      4162 DB	0
00165B C1      4163 DB	'A'+80H
00165C 47      4164 DB	47H
00165D 52      4165 DB	'R'
00165E 00      4166 DB	0
00165F C1      4167 DB	'A'+80H
001660 4F      4168 DB	4FH
001661 41      4169 DB	'A'
001662 00      4170 DB	0
001663 C9      4171 DB	'I'+80H
001664 57      4172 DB	57H
001665 41      4173 DB	'A'
001666 00      4174 DB	0
001667 D2      4175 DB	'R'+80H
001668 5F      4176 DB	5FH
001669 28      4177 DB	"(BC"
00166A 42   
00166B 43   
00166C 00      4178 DB	0
00166D C1      4179 DB	'A'+80H
00166E 02      4180 DB	2
00166F 28      4181 DB	"(DE"
001670 44   
001671 45   
001672 00      4182 DB	0
001673 C1      4183 DB	'A'+80H
001674 12      4184 DB	12H
001675 41      4185 DB	'A'
001676 00      4186 DB	0
001677 28      4187 DB	"(B"
001678 42   
001679 C3      4188 DB	'C'+80H
00167A 0A      4189 DB	0AH
00167B 41      4190 DB	'A'
00167C 00      4191 DB	0
00167D 28      4192 DB	"(D"
00167E 44   
00167F C5      4193 DB	'E'+80H
001680 1A      4194 DB	1AH
001681 00      4196 DB	0
001682             4201   ; --- Begin eval.asm ---
001682 60      4337 FUNTBL:         DW	DECODE		;Line number
001683 1F   
001684 5B      4338 DW	OPENIN		;OPENIN
001685 1B   
001686 78      4339 DW	PTRev		;PTR
001687 1B   
001688 2D      4340 DW	PAGEVev		;PAGE
001689 1B   
00168A 80      4341 DW	TIMEVev		;TIME
00168B 1B   
00168C 23      4342 DW	LOMEMVev		;LOMEM
00168D 1B   
00168E 28      4343 DW	HIMEMVev		;HIMEM
00168F 1B   
001690 CC      4344 DW	ABSev		;ABS
001691 1B   
001692 08      4345 DW	ACSev		;ACS
001693 1C   
001694 E7      4346 DW	ADVAL		;ADVAL
001695 0D   
001696 10      4347 DW	ASC		;ASC
001697 1B   
001698 00      4348 DW	ASNev		;ASN
001699 1C   
00169A 04      4349 DW	ATNev		;ATN
00169B 1C   
00169C EC      4350 DW	BGET		;BGET
00169D 1A   
00169E EC      4351 DW	COSev		;COS
00169F 1B   
0016A0 4B      4352 DW	COUNTV		;COUNT
0016A1 1B   
0016A2 D4      4353 DW	DEGev		;DEG
0016A3 1B   
0016A4 41      4354 DW	ERLV		;ERL
0016A5 1B   
0016A6 46      4355 DW	ERRV		;ERR
0016A7 1B   
0016A8 2C      4356 DW	EVAL_		;EVAL_
0016A9 1C   
0016AA F4      4357 DW	EXPev		;EXP
0016AB 1B   
0016AC 70      4358 DW	EXTev		;EXT
0016AD 1B   
0016AE F8      4359 DW	ZERO		;FALSE
0016AF 1F   
0016B0 E3      4360 DW	FN		;FN
0016B1 29   
0016B2 FA      4361 DW	GET		;GET
0016B3 1A   
0016B4 F5      4362 DW	INKEY		;INKEY
0016B5 1A   
0016B6 A5      4363 DW	INSTR		;INSTR(
0016B7 1D   
0016B8 E0      4364 DW	INT_ev		;INT_
0016B9 1B   
0016BA 1D      4365 DW	LEN		;LEN
0016BB 1B   
0016BC F8      4366 DW	LNev		;LN
0016BD 1B   
0016BE FC      4367 DW	LOGev		;LOG
0016BF 1B   
0016C0 D0      4368 DW	CPL_ev		;NOT
0016C1 1B   
0016C2 58      4369 DW	OPENUP		;OPENUP
0016C3 1B   
0016C4 56      4370 DW	OPENOT		;OPENOUT
0016C5 1B   
0016C6 C8      4371 DW	PIev		;PI
0016C7 1B   
0016C8 B4      4372 DW	POINT		;POINT(
0016C9 0D   
0016CA D5      4373 DW	POS		;POS
0016CB 1A   
0016CC D8      4374 DW	RADev		;RAD
0016CD 1B   
0016CE 59      4375 DW	RND		;RND
0016CF 1C   
0016D0 DC      4376 DW	SGNev		;SGN
0016D1 1B   
0016D2 F0      4377 DW	SINev		;SIN
0016D3 1B   
0016D4 E4      4378 DW	SQRev		;SQR
0016D5 1B   
0016D6 E8      4379 DW	TANev		;TAN
0016D7 1B   
0016D8 32      4380 DW	TOPV		;TO(P)
0016D9 1B   
0016DA BD      4381 DW	TRUEev		;TRUE
0016DB 1B   
0016DC 3F      4382 DW	USR		;USR
0016DD 30   
0016DE 1F      4383 DW	VALev		;VAL
0016DF 1C   
0016E0 DB      4384 DW	VPOS		;VPOS
0016E1 1A   
0016E2 26      4385 DW	CHRS		;CHR$
0016E3 1E   
0016E4 2D      4386 DW	GETS		;GET$
0016E5 1E   
0016E6 8E      4387 DW	INKEYS		;INKEY$
0016E7 1E   
0016E8 CE      4388 DW	LEFTS		;LEFT$(
0016E9 1E   
0016EA 9E      4389 DW	MIDS		;MID$(
0016EB 1E   
0016EC FC      4390 DW	RIGHTS		;RIGHT$(
0016ED 1E   
0016EE B8      4391 DW	STRS		;STR$
0016EF 1F   
0016F0 26      4392 DW	STRING_		;STRING_$(
0016F1 1F   
0016F2 E0      4393 DW	EOF		;EOF
0016F3 1A   
0016F4 E9      4394 DW	SUM		;SUM
0016F5 1C   
0016F6 AB      4408 SOPTBL:         DW	SLE		;<= (STRING)
0016F7 1B   
0016F8 B3      4409 DW	SNE		;<>
0016F9 1B   
0016FA A5      4410 DW	SGE		;>=
0016FB 1B   
0016FC 98      4411 DW	SLT		;<
0016FD 1B   
0016FE B9      4412 DW	SEQ		;=
0016FF 1B   
001700 9E      4413 DW	SGT		;>
001701 1B   
001702 CD      4432 EXPR:           CALL	EXPR1		;GET FIRST OPERAND
001703 17   
001704 17   
001705 FE      4433 EXPR0A:         CP	EOR		;CHECK OPERATOR
001706 82   
001707 28      4434 JR	Z,EXPR0B
001708 03   
001709 FE      4435 CP	OR_
00170A 84   
00170B C0      4436 RET	NZ
00170C CD      4437 EXPR0B:         CALL	SAVEev		;SAVE FIRST OPERAND
00170D 73   
00170E 20   
00170F CD      4438 CALL	EXPR1		;GET SECOND OPERAND
001710 17   
001711 17   
001712 CD      4439 CALL	DOIT		;DO OPERATION
001713 83   
001714 20   
001715 18      4440 JR	EXPR0A		;CONTINUE
001716 EE   
001717 CD      4442 EXPR1:          CALL	EXPR2
001718 28   
001719 17   
00171A FE      4443 EXPR1A:         CP	AND_
00171B 80   
00171C C0      4444 RET	NZ
00171D CD      4445 CALL	SAVEev
00171E 73   
00171F 20   
001720 CD      4446 CALL	EXPR2
001721 28   
001722 17   
001723 CD      4447 CALL	DOIT
001724 83   
001725 20   
001726 18      4448 JR	EXPR1A
001727 F2   
001728 CD      4450 EXPR2:          CALL	EXPR3ev
001729 A0   
00172A 17   
00172B CD      4451 CALL	RELOPQ
00172C 6A   
00172D 20   
00172E C0      4452 RET	NZ
00172F 47      4453 LD	B,A
001730 FD      4454 INC	IY		;BUMP OVER OPERATOR
001731 23   
001732 CD      4455 CALL	NXT
001733 0B   
001734 45   
001735 CD      4456 CALL	RELOPQ		;COMPOUND OPERATOR?
001736 6A   
001737 20   
001738 20      4457 JR	NZ,EXPR2B
001739 07   
00173A FD      4458 INC	IY
00173B 23   
00173C B8      4459 CP	B
00173D 28      4460 JR	Z,SHIFT		;SHIFT | ==
00173E 1C   
00173F 80      4461 ADD	A,B
001740 47      4462 LD	B,A
001741 78      4463 EXPR2B:         LD	A,B
001742 08      4464 EX	AF,AF'
001743 FA      4465 JP	M,EXPR2S
001744 73   
001745 17   
001746 08      4466 EX	AF,AF'
001747 D6      4467 SUB	4
001748 04   
001749 FE      4468 CP	'>'-4
00174A 3A   
00174B 20      4469 JR	NZ,EXPR2C
00174C 02   
00174D C6      4470 ADD	A,2
00174E 02   
00174F E6      4471 EXPR2C:         AND	0FH
001750 0F   
001751 CD      4472 EXPR2D:         CALL	SAVE1
001752 77   
001753 20   
001754 CD      4473 CALL	EXPR3ev
001755 A0   
001756 17   
001757 CD      4474 CALL	DOIT		;Must NOT be "JP DOIT"
001758 83   
001759 20   
00175A C9      4475 RET
00175B FE      4477 SHIFT:          CP	'='
00175C 3D   
00175D 28      4478 JR	Z,EXPR2B	;==
00175E E2   
00175F CD      4479 CALL	NXT
001760 0B   
001761 45   
001762 CD      4480 CALL	RELOPQ
001763 6A   
001764 20   
001765 20      4481 JR	NZ,SHIFT1
001766 07   
001767 B8      4482 CP	B
001768 C2      4483 JP	NZ,SYNTAX
001769 E0   
00176A 25   
00176B FD      4484 INC	IY
00176C 23   
00176D 04      4485 INC	B
00176E 78      4486 SHIFT1:         LD	A,B
00176F D6      4487 SUB	18
001770 12   
001771 18      4488 JR	EXPR2D
001772 DE   
001773 08      4490 EXPR2S:         EX	AF,AF'
001774 3D      4491 DEC	A
001775 E6      4492 AND	7
001776 07   
001777 CD      4493 CALL	PUSHS		;SAVE STRING ON STACK
001778 19   
001779 20   
00177A F5      4494 PUSH	AF		;SAVE OPERATOR
00177B CD      4495 CALL	EXPR3ev		;SECOND STRING
00177C A0   
00177D 17   
00177E 08      4496 EX	AF,AF'
00177F F2      4497 JP	P,MISMATev
001780 6E   
001781 18   
001782 F1      4498 POP	AF
001783 4B      4499 LD	C,E		;LENGTH OF STRING #2
001784 D1      4500 POP	DE
001785 21      4501 LD	HL,0
001786 00   
001787 00   
001788 39      4502 ADD	HL,SP
001789 43      4503 LD	B,E		;LENGTH OF STRING #1
00178A D5      4504 PUSH	DE
00178B 11      4505 LD	DE,ACCS
00178C 00   
00178D 52   
00178E EB      4506 EX	DE,HL
00178F CD      4507 CALL	DISPT2
001790 BB   
001791 20   
001792 D1      4508 POP	DE
001793 EB      4509 EX	DE,HL
001794 26      4510 LD	H,0
001795 00   
001796 39      4511 ADD	HL,SP
001797 F9      4512 LD	SP,HL
001798 EB      4513 EX	DE,HL
001799 AF      4514 XOR	A		;NUMERIC MARKER
00179A 4F      4515 LD	C,A		;INTEGER MARKER
00179B 08      4516 EX	AF,AF'
00179C FD      4517 LD	A,(IY)
00179D 7E   
00179E 00   
00179F C9      4518 RET
0017A0 CD      4520 EXPR3ev:          CALL	EXPR4
0017A1 EE   
0017A2 17   
0017A3 FE      4521 EXPR3A:         CP	'-'
0017A4 2D   
0017A5 28      4522 JR	Z,EXPR3B
0017A6 08   
0017A7 FE      4523 CP	'+'
0017A8 2B   
0017A9 C0      4524 RET	NZ
0017AA 08      4525 EX	AF,AF'
0017AB FA      4526 JP	M,EXPR3S
0017AC BA   
0017AD 17   
0017AE 08      4527 EX	AF,AF'
0017AF CD      4528 EXPR3B:         CALL	SAVEev
0017B0 73   
0017B1 20   
0017B2 CD      4529 CALL	EXPR4
0017B3 EE   
0017B4 17   
0017B5 CD      4530 CALL	DOIT
0017B6 83   
0017B7 20   
0017B8 18      4531 JR	EXPR3A
0017B9 E9   
0017BA 08      4533 EXPR3S:         EX	AF,AF'
0017BB FD      4534 INC	IY		;BUMP PAST '+'
0017BC 23   
0017BD CD      4535 CALL	PUSHS		;SAVE STRING ON STACK
0017BE 19   
0017BF 20   
0017C0 CD      4536 CALL	EXPR4		;SECOND STRING
0017C1 EE   
0017C2 17   
0017C3 08      4537 EX	AF,AF'
0017C4 F2      4538 JP	P,MISMATev
0017C5 6E   
0017C6 18   
0017C7 4B      4539 LD	C,E		;C=LENGTH
0017C8 D1      4540 POP	DE
0017C9 D5      4541 PUSH	DE
0017CA 21      4542 LD	HL,ACCS
0017CB 00   
0017CC 52   
0017CD 54      4543 LD	D,H
0017CE 79      4544 LD	A,C
0017CF B7      4545 OR	A
0017D0 28      4546 JR	Z,EXP3S3
0017D1 0E   
0017D2 45      4547 LD	B,L
0017D3 6F      4548 LD	L,A		;SOURCE
0017D4 83      4549 ADD	A,E
0017D5 5F      4550 LD	E,A		;DESTINATION
0017D6 3E      4551 LD	A,19
0017D7 13   
0017D8 38      4552 JR	C,ERROR2ev	;"String too long"
0017D9 6B   
0017DA D5      4553 PUSH	DE
0017DB 1D      4554 DEC	E
0017DC 2D      4555 DEC	L
0017DD ED      4556 LDDR			;COPY
0017DE B8   
0017DF D1      4557 POP	DE
0017E0 D9      4558 EXP3S3:         EXX
0017E1 C1      4559 POP	BC
0017E2 CD      4560 CALL	POPS		;RESTORE FROM STACK
0017E3 37   
0017E4 20   
0017E5 D9      4561 EXX
0017E6 F6      4562 OR	80H		;FLAG STRING
0017E7 80   
0017E8 08      4563 EX	AF,AF'
0017E9 FD      4564 LD	A,(IY)
0017EA 7E   
0017EB 00   
0017EC 18      4565 JR	EXPR3A
0017ED B5   
0017EE CD      4567 EXPR4:          CALL	EXPR5
0017EF 14   
0017F0 18   
0017F1 FE      4568 EXPR4A:         CP	'*'
0017F2 2A   
0017F3 28      4569 JR	Z,EXPR4B
0017F4 0B   
0017F5 FE      4570 CP	'/'
0017F6 2F   
0017F7 28      4571 JR	Z,EXPR4B
0017F8 07   
0017F9 FE      4572 CP	MOD_
0017FA 83   
0017FB 28      4573 JR	Z,EXPR4B
0017FC 03   
0017FD FE      4574 CP	DIV_
0017FE 81   
0017FF C0      4575 RET	NZ
001800 CD      4576 EXPR4B:         CALL	SAVEev
001801 73   
001802 20   
001803 CD      4577 CALL	EXPR5
001804 14   
001805 18   
001806 CD      4578 CALL	DOIT
001807 83   
001808 20   
001809 18      4579 JR	EXPR4A
00180A E6   
00180B 7B      4581 EXPR45:         LD	A,E
00180C FE      4582 CP	'+'
00180D 2B   
00180E 28      4583 JR	Z,EXPR4
00180F DE   
001810 FE      4584 CP	'-'
001811 2D   
001812 28      4585 JR	Z,EXPR4
001813 DA   
001814 CD      4586 EXPR5:          CALL	ITEM
001815 D0   
001816 18   
001817 B7      4587 OR	A		;TEST TYPE
001818 08      4588 EX	AF,AF'		;SAVE TYPE
001819 CD      4589 EXPR5A:         CALL	NXT
00181A 0B   
00181B 45   
00181C FE      4590 CP	'^'
00181D 5E   
00181E C0      4591 RET	NZ
00181F CD      4592 CALL	SAVEev
001820 73   
001821 20   
001822 CD      4593 CALL	ITEM
001823 D0   
001824 18   
001825 B7      4594 OR	A
001826 08      4595 EX	AF,AF'
001827 CD      4596 CALL	DOIT
001828 83   
001829 20   
00182A 18      4597 JR	EXPR5A
00182B ED   
00182C CD      4599 EXPRN:          CALL	EXPR
00182D 02   
00182E 17   
00182F 08      4600 EX	AF,AF'
001830 F0      4601 RET	P
001831 18      4602 JR	MISMATev
001832 3B   
001833 CD      4604 EXPRI:          CALL	EXPR
001834 02   
001835 17   
001836 08      4605 EX	AF,AF'
001837 F2      4606 JP	P,SFIX
001838 17   
001839 1C   
00183A 18      4607 JR	MISMATev
00183B 32   
00183C CD      4609 EXPRS:          CALL	EXPR
00183D 02   
00183E 17   
00183F 08      4610 EX	AF,AF'
001840 F8      4611 RET	M
001841 18      4612 JR	MISMATev
001842 2B   
001843 3E      4614 BADHEX:         LD	A,28
001844 1C   
001845 C3      4615 ERROR2ev:         JP	ERROR_		;"Bad HEX or binary"
001846 44   
001847 3F   
001848 D9      4617 NEGATEev:         EXX
001849 7C      4618 LD	A,H
00184A 2F      4619 CPL
00184B 67      4620 LD	H,A
00184C 7D      4621 LD	A,L
00184D 2F      4622 CPL
00184E 6F      4623 LD	L,A
00184F D9      4624 EXX
001850 7C      4625 LD	A,H
001851 2F      4626 CPL
001852 67      4627 LD	H,A
001853 7D      4628 LD	A,L
001854 2F      4629 CPL
001855 6F      4630 LD	L,A
001856 D9      4631 ADD1ev:           EXX
001857 23      4632 INC	HL
001858 7C      4633 LD	A,H
001859 B5      4634 OR	L
00185A D9      4635 EXX
00185B 3E      4636 LD	A,0		;NUMERIC MARKER
00185C 00   
00185D C0      4637 RET	NZ
00185E 23      4638 INC	HL
00185F C9      4639 RET
001860 CD      4641 ITEMI:          CALL	ITEM
001861 D0   
001862 18   
001863 B7      4642 OR	A
001864 F2      4643 JP	P,SFIX
001865 17   
001866 1C   
001867 18      4644 JR	MISMATev
001868 05   
001869 CD      4646 ITEMS:          CALL	ITEM
00186A D0   
00186B 18   
00186C B7      4647 OR	A
00186D F8      4648 RET	M
00186E 3E      4649 MISMATev:         LD	A,6
00186F 06   
001870 18      4650 JR	ERROR2ev		;"Type mismatch"
001871 D3   
001872 CD      4652 ITEM1:          CALL	EXPR		;BRACKETED EXPR
001873 02   
001874 17   
001875 CD      4653 CALL	BRAKET
001876 AE   
001877 20   
001878 08      4654 EX	AF,AF'
001879 C9      4655 RET
00187A CD      4657 ITEMN:          CALL	ITEM
00187B D0   
00187C 18   
00187D B7      4658 OR	A
00187E F0      4659 RET	P
00187F 18      4660 JR	MISMATev
001880 ED   
001881 CD      4667 HEXev:            CALL	ZERO
001882 F8   
001883 1F   
001884 CD      4668 CALL	HEXDIG
001885 57   
001886 20   
001887 38      4669 JR	C,BADHEX
001888 BA   
001889 FD      4670 HEX1:           INC	IY
00188A 23   
00188B E6      4671 AND	0FH
00188C 0F   
00188D 06      4672 LD	B,4
00188E 04   
00188F D9      4673 HEX2:           EXX
001890 29      4674 ADD	HL,HL
001891 D9      4675 EXX
001892 ED      4676 ADC	HL,HL
001893 6A   
001894 10      4677 DJNZ	HEX2
001895 F9   
001896 D9      4678 EXX
001897 B5      4679 OR	L
001898 6F      4680 LD	L,A
001899 D9      4681 EXX
00189A CD      4682 CALL	HEXDIG
00189B 57   
00189C 20   
00189D 30      4683 JR	NC,HEX1
00189E EA   
00189F AF      4684 XOR	A
0018A0 C9      4685 RET
0018A1 CD      4692 BIN:            CALL	ZERO
0018A2 F8   
0018A3 1F   
0018A4 CD      4693 CALL	BINDIG
0018A5 4A   
0018A6 20   
0018A7 38      4694 JR	C,BADHEX
0018A8 9A   
0018A9 FD      4695 BIN1:           INC	IY
0018AA 23   
0018AB CB      4696 RR	A
0018AC 1F   
0018AD D9      4697 EXX
0018AE ED      4698 ADC	HL,HL
0018AF 6A   
0018B0 D9      4699 EXX
0018B1 ED      4700 ADC	HL,HL
0018B2 6A   
0018B3 CD      4701 CALL	BINDIG
0018B4 4A   
0018B5 20   
0018B6 30      4702 JR	NC,BIN1
0018B7 F1   
0018B8 AF      4703 XOR	A
0018B9 C9      4704 RET
0018BA CD      4711 MINUS:          CALL	ITEMN
0018BB 7A   
0018BC 18   
0018BD 0D      4712 MINUS0:         DEC	C
0018BE 0C      4713 INC	C
0018BF 28      4714 JR	Z,NEGATEev	;ZERO/INTEGER
0018C0 87   
0018C1 7C      4715 LD	A,H
0018C2 EE      4716 XOR	80H		;CHANGE SIGN (FP)
0018C3 80   
0018C4 67      4717 LD	H,A
0018C5 AF      4718 XOR	A		;NUMERIC MARKER
0018C6 C9      4719 RET
0018C7 CD      4721 ADDROF:         CALL	VAR_
0018C8 D6   
0018C9 25   
0018CA E5      4722 PUSH	HL
0018CB D9      4723 EXX
0018CC E1      4724 POP	HL
0018CD C3      4725 JP	COUNT1
0018CE 50   
0018CF 1B   
0018D0 CD      4734 ITEM:           CALL	CHECK
0018D1 86   
0018D2 32   
0018D3 CD      4735 CALL	NXT
0018D4 0B   
0018D5 45   
0018D6 FD      4736 INC	IY
0018D7 23   
0018D8 FE      4737 CP	FUNTOK
0018D9 8D   
0018DA 38      4738 JR	C,ITEM0
0018DB 08   
0018DC FE      4739 CP	TCMD
0018DD C7   
0018DE DA      4740 JP	C,DISPATev	;FUNCTIONS
0018DF C1   
0018E0 20   
0018E1 C3      4741 JP	EXTRASev		;DIM, END, MODE, REPORT$, WIDTH
0018E2 30   
0018E3 1A   
0018E4 FE      4743 ITEM0:          CP	':'
0018E5 3A   
0018E6 30      4744 JR	NC,ITEM2	;VARIABLES
0018E7 25   
0018E8 FE      4745 CP	'0'
0018E9 30   
0018EA 30      4746 JR	NC,CONev		;NUMERIC CONSTANT
0018EB 7B   
0018EC FE      4747 CP	'('
0018ED 28   
0018EE 28      4748 JR	Z,ITEM1		;EXPRESSION
0018EF 82   
0018F0 FE      4749 CP	'-'
0018F1 2D   
0018F2 28      4750 JR	Z,MINUS		;UNARY MINUS
0018F3 C6   
0018F4 FE      4751 CP	'+'
0018F5 2B   
0018F6 28      4752 JR	Z,ITEMN		;UNARY PLUS
0018F7 82   
0018F8 FE      4753 CP	'.'
0018F9 2E   
0018FA 28      4754 JR	Z,CONev		;NUMERIC CONSTANT
0018FB 6B   
0018FC FE      4755 CP	'&'
0018FD 26   
0018FE 28      4756 JR	Z,HEXev		;HEX CONSTANT
0018FF 81   
001900 FE      4757 CP	'%'
001901 25   
001902 28      4758 JR	Z,BIN		;BINARY CONSTANT
001903 9D   
001904 FE      4759 CP	'"'
001905 22   
001906 28      4760 JR	Z,CONS		;STRING CONSTANT
001907 72   
001908 FE      4761 CP	TTINT
001909 0A   
00190A CA      4762 JP	Z,TINTev		;TINT FUNCTION
00190B D0   
00190C 1A   
00190D FE      4763 ITEM2:          CP	TMOD
00190E 83   
00190F CA      4764 JP	Z,MODFUN	;MOD
001910 4D   
001911 1D   
001912 FE      4765 CP	'^'
001913 5E   
001914 28      4766 JR	Z,ADDROF	;^ OPERATOR
001915 B1   
001916 FD      4767 DEC	IY
001917 2B   
001918 CD      4768 CALL	GETVAR		;VARIABLE
001919 E3   
00191A 41   
00191B 20      4769 JR	NZ,NOSUCHev
00191C 2F   
00191D CB      4770 BIT	6,A
00191E 77   
00191F 20      4771 JR	NZ,ARRAYev
001920 7E   
001921 B7      4772 OR	A
001922 FA      4773 JP	M,LOADS		;STRING VARIABLE
001923 0E   
001924 1A   
001925 CB      4774 LOADN:          BIT	2,A
001926 57   
001927 0E      4775 LD	C,0
001928 00   
001929 28      4776 JR	Z,LOAD1		;BYTE VARIABLE
00192A 16   
00192B CB      4777 BIT	0,A
00192C 47   
00192D 28      4778 JR	Z,LOAD4		;INTEGER VARIABLE
00192E 03   
00192F DD      4779 LOAD5:          LD	C,(IX+4)
001930 4E   
001931 04   
001932 D9      4780 LOAD4:          EXX
001933 DD      4781 LD	L,(IX+0)
001934 6E   
001935 00   
001936 DD      4782 LD	H,(IX+1)
001937 66   
001938 01   
001939 D9      4783 EXX
00193A DD      4784 LD	L,(IX+2)
00193B 6E   
00193C 02   
00193D DD      4785 LD	H,(IX+3)
00193E 66   
00193F 03   
001940 C9      4786 RET
001941 21      4788 LOAD1:          LD	HL,0
001942 00   
001943 00   
001944 D9      4789 EXX
001945 26      4790 LD	H,0
001946 00   
001947 DD      4791 LD	L,(IX+0)
001948 6E   
001949 00   
00194A D9      4792 EXX
00194B C9      4793 RET
00194C DA      4795 NOSUCHev:         JP	C,SYNTAX
00194D E0   
00194E 25   
00194F 3A      4796 LD	A,(LISTON)
001950 FE   
001951 54   
001952 CB      4797 BIT	5,A
001953 6F   
001954 3E      4798 LD	A,26
001955 1A   
001956 20      4799 JR	NZ,ERROR0ev	;"No such variable"
001957 36   
001958 FD      4800 NOS1:           INC	IY
001959 23   
00195A CD      4801 CALL	RANGE
00195B EF   
00195C 43   
00195D 30      4802 JR	NC,NOS1
00195E F9   
00195F DD      4803 LD	IX,PC
001960 21   
001961 40   
001962 54   
001963 AF      4804 XOR	A
001964 4F      4805 LD	C,A
001965 18      4806 JR	LOAD4
001966 CB   
001967 FD      4814 CONev:            DEC	IY
001968 2B   
001969 FD      4815 PUSH	IY
00196A E5   
00196B DD      4816 POP	IX
00196C E1   
00196D 3E      4817 LD	A,36
00196E 24   
00196F CD      4818 CALL	FPP
001970 15   
001971 45   
001972 38      4819 JR	C,ERROR0ev
001973 1A   
001974 DD      4820 PUSH	IX
001975 E5   
001976 FD      4821 POP	IY
001977 E1   
001978 AF      4822 XOR	A
001979 C9      4823 RET
00197A 11      4832 CONS:           LD	DE,ACCS
00197B 00   
00197C 52   
00197D FD      4833 CONS3:          LD	A,(IY)
00197E 7E   
00197F 00   
001980 FD      4834 INC	IY
001981 23   
001982 FE      4835 CP	'"'
001983 22   
001984 28      4836 JR	Z,CONS2
001985 0B   
001986 12      4837 CONS1:          LD	(DE),A
001987 1C      4838 INC	E
001988 FE      4839 CP	CR
001989 0D   
00198A 20      4840 JR	NZ,CONS3
00198B F1   
00198C 3E      4841 LD	A,9
00198D 09   
00198E C3      4842 ERROR0ev:         JP	ERROR_		;"Missing """
00198F 44   
001990 3F   
001991 FD      4844 CONS2:          LD	A,(IY)
001992 7E   
001993 00   
001994 FE      4845 CP	'"'
001995 22   
001996 FD      4846 INC	IY
001997 23   
001998 28      4847 JR	Z,CONS1
001999 EC   
00199A FD      4848 DEC	IY
00199B 2B   
00199C 3E      4849 LD	A,80H		;STRING MARKER
00199D 80   
00199E C9      4850 RET
00199F 3E      4852 ARRAYev:          LD	A,14		;'Bad use of array'
0019A0 0E   
0019A1 C3      4853 JP	ERROR_
0019A2 44   
0019A3 3F   
0019A4 7E      4862 ARRLEN:         LD	A,(HL)		;Number of dimensions
0019A5 23      4863 INC	HL
0019A6 B7      4864 OR	A
0019A7 28      4865 JR	Z,ARRAYev
0019A8 F6   
0019A9 11      4866 LD	DE,1
0019AA 01   
0019AB 00   
0019AC 4E      4867 ARLOOP:         LD	C,(HL)
0019AD 23      4868 INC	HL
0019AE 46      4869 LD	B,(HL)		;BC = size of this dimension
0019AF 23      4870 INC	HL
0019B0 EB      4871 EX	DE,HL
0019B1 F5      4872 PUSH	AF
0019B2 D5      4873 PUSH	DE
0019B3 CD      4874 CALL	MUL16		;HL=HL*BC
0019B4 BD   
0019B5 36   
0019B6 D1      4875 POP	DE
0019B7 F1      4876 POP	AF
0019B8 EB      4877 EX	DE,HL
0019B9 3D      4878 DEC	A
0019BA 20      4879 JR	NZ,ARLOOP
0019BB F0   
0019BC C9      4880 RET
0019BD CD      4882 GETARR:         CALL	NXT
0019BE 0B   
0019BF 45   
0019C0 CD      4883 CALL	GETVAR
0019C1 E3   
0019C2 41   
0019C3 20      4884 JR	NZ,NOSUCHev
0019C4 87   
0019C5 CB      4885 BIT	6,A
0019C6 77   
0019C7 37      4886 SCF
0019C8 28      4887 JR	Z,NOSUCHev
0019C9 82   
0019CA E6      4888 AND	8FH
0019CB 8F   
0019CC 47      4889 LD	B,A		;Type + size
0019CD 7E      4890 GETAR1:         LD	A,(HL)
0019CE 23      4891 INC	HL
0019CF 66      4892 LD	H,(HL)
0019D0 6F      4893 LD	L,A
0019D1 E6      4894 AND	0FEH
0019D2 FE   
0019D3 B4      4895 OR	H
0019D4 28      4896 JR	Z,ARRAYev		;Bad use of array
0019D5 C9   
0019D6 C9      4897 RET
0019D7 CD      4899 GETARB:         CALL	NXT
0019D8 0B   
0019D9 45   
0019DA FE      4900 CP	'('
0019DB 28   
0019DC 20      4901 JR	NZ,GETARR
0019DD DF   
0019DE FD      4902 INC	IY
0019DF 23   
0019E0 CD      4903 CALL	GETARR
0019E1 BD   
0019E2 19   
0019E3 CD      4904 CALL	BRAKET
0019E4 AE   
0019E5 20   
0019E6 C9      4905 RET
0019E7 CB      4907 DLOADN:         BIT	2,A
0019E8 57   
0019E9 06      4908 LD	B,0
0019EA 00   
0019EB 28      4909 JR	Z,DLOAD1	;BYTE VARIABLE
0019EC 16   
0019ED CB      4910 BIT	0,A
0019EE 47   
0019EF 28      4911 JR	Z,DLOAD4	;INTEGER VARIABLE
0019F0 03   
0019F1 DD      4912 DLOAD5:         LD	B,(IX+4)
0019F2 46   
0019F3 04   
0019F4 D9      4913 DLOAD4:         EXX
0019F5 DD      4914 LD	E,(IX+0)
0019F6 5E   
0019F7 00   
0019F8 DD      4915 LD	D,(IX+1)
0019F9 56   
0019FA 01   
0019FB D9      4916 EXX
0019FC DD      4917 LD	E,(IX+2)
0019FD 5E   
0019FE 02   
0019FF DD      4918 LD	D,(IX+3)
001A00 56   
001A01 03   
001A02 C9      4919 RET
001A03 11      4921 DLOAD1:         LD	DE,0
001A04 00   
001A05 00   
001A06 D9      4922 EXX
001A07 16      4923 LD	D,0
001A08 00   
001A09 DD      4924 LD	E,(IX+0)
001A0A 5E   
001A0B 00   
001A0C D9      4925 EXX
001A0D C9      4926 RET
001A0E 11      4928 LOADS:          LD	DE,ACCS
001A0F 00   
001A10 52   
001A11 1F      4929 RRA
001A12 30      4930 JR	NC,LOADS2	;FIXED STRING
001A13 10   
001A14 CD      4931 CALL	LOAD4
001A15 32   
001A16 19   
001A17 D9      4932 EXX
001A18 7D      4933 LD	A,L
001A19 D9      4934 EXX
001A1A B7      4935 OR	A
001A1B 4F      4936 LD	C,A
001A1C 3E      4937 LD	A,80H		;STRING MARKER
001A1D 80   
001A1E C8      4938 RET	Z
001A1F 06      4939 LD	B,0
001A20 00   
001A21 ED      4940 LDIR
001A22 B0   
001A23 C9      4941 RET
001A24 7E      4943 LOADS2:         LD	A,(HL)
001A25 12      4944 LD	(DE),A
001A26 23      4945 INC	HL
001A27 FE      4946 CP	CR
001A28 0D   
001A29 3E      4947 REPDUN:         LD	A,80H		;STRING MARKER
001A2A 80   
001A2B C8      4948 RET	Z
001A2C 1C      4949 INC	E
001A2D 20      4950 JR	NZ,LOADS2
001A2E F5   
001A2F C9      4951 RET			;RETURN NULL STRING
001A30 FE      4955 EXTRASev:         CP	TMODE
001A31 EB   
001A32 CA      4956 JP	Z,MODEFN	;MODE
001A33 F3   
001A34 0D   
001A35 FE      4957 CP	TWIDTH
001A36 FE   
001A37 CA      4958 JP	Z,WIDFN		;WIDTH
001A38 FD   
001A39 0D   
001A3A FE      4959 CP	TREPORT
001A3B F6   
001A3C 28      4960 JR	Z,REPORS	;REPORT$
001A3D 11   
001A3E FE      4961 CP	TEND
001A3F E0   
001A40 28      4962 JR	Z,ENDFUN	;END
001A41 07   
001A42 FE      4963 CP	TDIM
001A43 DE   
001A44 28      4964 JR	Z,DIMFUN	;DIM
001A45 44   
001A46 C3      4965 SYNERR:         JP	SYNTAX		; 'Syntax error'
001A47 E0   
001A48 25   
001A49 2A      4969 ENDFUN:         LD	HL,(FREE)
001A4A E0   
001A4B 54   
001A4C C3      4970 JP	COUNT1
001A4D 50   
001A4E 1B   
001A4F FD      4974 REPORS:         LD	A,(IY)
001A50 7E   
001A51 00   
001A52 FE      4975 CP	'$'
001A53 24   
001A54 20      4976 JR	NZ,SYNERR
001A55 F0   
001A56 FD      4977 INC	IY
001A57 23   
001A58 2A      4978 LD	HL,(ERRTXT)
001A59 EE   
001A5A 54   
001A5B 11      4979 LD	DE,ACCS
001A5C 00   
001A5D 52   
001A5E 7E      4980 REPCPY:         LD	A,(HL)
001A5F B7      4981 OR	A
001A60 28      4982 JR	Z,REPDUN
001A61 C7   
001A62 ED      4983 LDI
001A63 A0   
001A64 FE      4984 CP	160
001A65 A0   
001A66 EA      4985 JP	PE,REPCPY
001A67 5E   
001A68 1A   
001A69 FE      4986 CP	LF
001A6A 0A   
001A6B 28      4987 JR	Z,REPCPY
001A6C F1   
001A6D 1D      4988 DEC	E
001A6E E5      4989 PUSH	HL
001A6F 21      4990 LD	HL,KEYWDS
001A70 84   
001A71 38   
001A72 01      4991 LD	BC,KEYWDL
001A73 5B   
001A74 03   
001A75 ED      4992 CPIR
001A76 B1   
001A77 06      4993 LD	B,160
001A78 A0   
001A79 FE      4994 CP	145
001A7A 91   
001A7B EA      4995 JP	PE,REPTOK
001A7C 7F   
001A7D 1A   
001A7E 04      4996 INC	B
001A7F 7E      4997 REPTOK:         LD	A,(HL)
001A80 ED      4998 LDI
001A81 A0   
001A82 B8      4999 CP	B
001A83 EA      5000 JP	PE,REPTOK
001A84 7F   
001A85 1A   
001A86 E1      5001 POP	HL
001A87 1D      5002 DEC	E
001A88 18      5003 JR	REPCPY
001A89 D4   
001A8A CD      5007 DIMFUN:         CALL	NXT
001A8B 0B   
001A8C 45   
001A8D FE      5008 CP	'('
001A8E 28   
001A8F 20      5009 JR	NZ,DIMF0
001A90 09   
001A91 FD      5010 INC	IY
001A92 23   
001A93 CD      5011 CALL	DIMF0
001A94 9A   
001A95 1A   
001A96 CD      5012 CALL	BRAKET
001A97 AE   
001A98 20   
001A99 C9      5013 RET
001A9A CD      5015 DIMF0:          CALL	GETARR
001A9B BD   
001A9C 19   
001A9D E5      5016 PUSH	HL
001A9E CD      5017 CALL	NXT
001A9F 0B   
001AA0 45   
001AA1 1E      5018 LD	E,0
001AA2 00   
001AA3 FE      5019 CP	','
001AA4 2C   
001AA5 20      5020 JR	NZ,DIMF1
001AA6 0B   
001AA7 FD      5021 INC	IY
001AA8 23   
001AA9 CD      5022 CALL	EXPRI
001AAA 33   
001AAB 18   
001AAC D9      5023 EXX
001AAD EB      5024 EX	DE,HL
001AAE 1C      5025 INC	E
001AAF 1D      5026 DEC	E
001AB0 28      5027 JR	Z,BADSUB
001AB1 19   
001AB2 E1      5028 DIMF1:          POP	HL
001AB3 7E      5029 LD	A,(HL)
001AB4 23      5030 INC	HL
001AB5 BB      5031 CP	E
001AB6 38      5032 JR	C,BADSUB
001AB7 13   
001AB8 1D      5033 DEC	E
001AB9 FA      5034 JP	M,DIMF3
001ABA C6   
001ABB 1A   
001ABC 19      5035 ADD	HL,DE
001ABD 19      5036 ADD	HL,DE
001ABE 7E      5037 LD	A,(HL)
001ABF 23      5038 INC	HL
001AC0 66      5039 LD	H,(HL)
001AC1 6F      5040 LD	L,A
001AC2 2B      5041 DEC	HL
001AC3 C3      5042 DIMF2:          JP	COUNT1
001AC4 50   
001AC5 1B   
001AC6 6F      5043 DIMF3:          LD	L,A
001AC7 26      5044 LD	H,0
001AC8 00   
001AC9 18      5045 JR	DIMF2
001ACA F8   
001ACB 3E      5047 BADSUB:         LD	A,15
001ACC 0F   
001ACD C3      5048 JP	ERROR_			;"Bad subscript"
001ACE 44   
001ACF 3F   
001AD0 CD      5078 TINTev:           CALL	TINTFN
001AD1 11   
001AD2 11   
001AD3 18      5079 JR	COUNT1
001AD4 7B   
001AD5 CD      5080 POS:            CALL	GETCSR
001AD6 A9   
001AD7 0D   
001AD8 EB      5081 EX	DE,HL
001AD9 18      5082 JR	COUNT1
001ADA 75   
001ADB CD      5083 VPOS:           CALL	GETCSR
001ADC A9   
001ADD 0D   
001ADE 18      5084 JR	COUNT1
001ADF 70   
001AE0 CD      5085 EOF:            CALL	CHANEL
001AE1 D1   
001AE2 36   
001AE3 CD      5086 CALL	OSSTAT
001AE4 6C   
001AE5 06   
001AE6 CA      5087 JP	Z,TRUEev
001AE7 BD   
001AE8 1B   
001AE9 C3      5088 JP	ZERO
001AEA F8   
001AEB 1F   
001AEC CD      5089 BGET:           CALL	CHANEL		;CHANNEL NUMBER
001AED D1   
001AEE 36   
001AEF CD      5090 CALL	OSBGET
001AF0 5B   
001AF1 06   
001AF2 6F      5091 LD	L,A
001AF3 18      5092 JR	COUNT0
001AF4 59   
001AF5 CD      5093 INKEY:          CALL	INKEYS
001AF6 8E   
001AF7 1E   
001AF8 18      5094 JR	ASC0
001AF9 19   
001AFA CD      5095 GET:            CALL	NXT
001AFB 0B   
001AFC 45   
001AFD FE      5096 CP	'('
001AFE 28   
001AFF 20      5097 JR	NZ,GET0
001B00 0A   
001B01 CD      5098 CALL	ITEMI		;PORT ADDRESS
001B02 60   
001B03 18   
001B04 D9      5099 EXX
001B05 44      5100 LD	B,H
001B06 4D      5101 LD	C,L
001B07 ED      5102 IN	L,(C)		;INPUT FROM PORT BC
001B08 68   
001B09 18      5103 JR	COUNT0
001B0A 43   
001B0B CD      5104 GET0:           CALL	GETS
001B0C 2D   
001B0D 1E   
001B0E 18      5105 JR	ASC1
001B0F 08   
001B10 CD      5106 ASC:            CALL	ITEMS
001B11 69   
001B12 18   
001B13 AF      5107 ASC0:           XOR	A
001B14 BB      5108 CP	E
001B15 CA      5109 JP	Z,TRUEev		;NULL STRING
001B16 BD   
001B17 1B   
001B18 2A      5110 ASC1:           LD	HL,(ACCS)
001B19 00   
001B1A 52   
001B1B 18      5111 JR	COUNT0
001B1C 31   
001B1D CD      5112 LEN:            CALL	ITEMS
001B1E 69   
001B1F 18   
001B20 EB      5113 EX	DE,HL
001B21 18      5114 JR	COUNT0
001B22 2B   
001B23 2A      5115 LOMEMVev:         LD	HL,(LOMEM)
001B24 DE   
001B25 54   
001B26 18      5116 JR	COUNT1
001B27 28   
001B28 2A      5117 HIMEMVev:         LD	HL,(HIMEM)
001B29 E2   
001B2A 54   
001B2B 18      5118 JR	COUNT1
001B2C 23   
001B2D 2A      5119 PAGEVev:          LD	HL,(PAGE_)
001B2E DC   
001B2F 54   
001B30 18      5120 JR	COUNT1
001B31 1E   
001B32 FD      5121 TOPV:           LD	A,(IY)
001B33 7E   
001B34 00   
001B35 FD      5122 INC	IY		;SKIP "P"
001B36 23   
001B37 FE      5123 CP	'P'
001B38 50   
001B39 C2      5124 JP	NZ,SYNTAX	;"Syntax Error"
001B3A E0   
001B3B 25   
001B3C CD      5125 CALL	GETTOP
001B3D 25   
001B3E 40   
001B3F 18      5126 JR	COUNT1
001B40 0F   
001B41 2A      5127 ERLV:           LD	HL,(ERL)
001B42 F2   
001B43 54   
001B44 18      5128 JR	COUNT1
001B45 0A   
001B46 2A      5129 ERRV:           LD	HL,(ERR)
001B47 FD   
001B48 54   
001B49 18      5130 JR	COUNT0
001B4A 03   
001B4B 2A      5131 COUNTV:         LD	HL,(COUNT)
001B4C FB   
001B4D 54   
001B4E 26      5132 COUNT0:         LD	H,0
001B4F 00   
001B50 D9      5133 COUNT1:         EXX
001B51 AF      5134 XOR	A
001B52 4F      5135 LD	C,A		;INTEGER MARKER
001B53 67      5136 LD	H,A
001B54 6F      5137 LD	L,A
001B55 C9      5138 RET
001B56 AF      5145 OPENOT:         XOR	A
001B57 21      5146 DB	21H		;SKIP NEXT 2 BYTES
001B58 3E      5147 OPENUP:         LD	A,2
001B59 02   
001B5A 21      5148 DB	21H		;SKIP NEXT 2 BYTES
001B5B 3E      5149 OPENIN:         LD	A,1
001B5C 01   
001B5D F5      5150 PUSH	AF		;SAVE OPEN TYPE
001B5E CD      5151 CALL	ITEMS		;FILENAME
001B5F 69   
001B60 18   
001B61 3E      5152 LD	A,CR
001B62 0D   
001B63 12      5153 LD	(DE),A
001B64 F1      5154 POP	AF		;RESTORE OPEN TYPE
001B65 C6      5155 ADD	A,-1		;AFFECT FLAGS
001B66 FF   
001B67 21      5156 LD	HL,ACCS
001B68 00   
001B69 52   
001B6A CD      5157 CALL	OSOPEN
001B6B 44   
001B6C 06   
001B6D 6F      5158 LD	L,A
001B6E 18      5159 JR	COUNT0
001B6F DE   
001B70 CD      5165 EXTev:            CALL	CHANEL
001B71 D1   
001B72 36   
001B73 CD      5166 CALL	GETEXT
001B74 AD   
001B75 06   
001B76 18      5167 JR	TIME0
001B77 12   
001B78 CD      5169 PTRev:            CALL	CHANEL
001B79 D1   
001B7A 36   
001B7B CD      5170 CALL	GETPTR
001B7C 76   
001B7D 06   
001B7E 18      5171 JR	TIME0
001B7F 0A   
001B80 FD      5176 TIMEVev:          LD	A,(IY)
001B81 7E   
001B82 00   
001B83 FE      5177 CP	'$'
001B84 24   
001B85 28      5178 JR	Z,TIMEVSev
001B86 09   
001B87 CD      5179 CALL	GETIME
001B88 29   
001B89 0D   
001B8A D5      5180 TIME0:          PUSH	DE
001B8B D9      5181 EXX
001B8C E1      5182 POP	HL
001B8D AF      5183 XOR	A
001B8E 4F      5184 LD	C,A
001B8F C9      5185 RET
001B90 FD      5190 TIMEVSev:         INC	IY		;SKIP $
001B91 23   
001B92 CD      5191 CALL	GETIMS
001B93 3E   
001B94 0D   
001B95 3E      5192 LD	A,80H		;MARK STRING
001B96 80   
001B97 C9      5193 RET
001B98 CD      5197 SLT:            CALL	SCP
001B99 F5   
001B9A 1F   
001B9B D0      5198 RET	NC
001B9C 18      5199 JR	TRUEev
001B9D 1F   
001B9E CD      5201 SGT:            CALL	SCP
001B9F F5   
001BA0 1F   
001BA1 C8      5202 RET	Z
001BA2 D8      5203 RET	C
001BA3 18      5204 JR	TRUEev
001BA4 18   
001BA5 CD      5206 SGE:            CALL	SCP
001BA6 F5   
001BA7 1F   
001BA8 D8      5207 RET	C
001BA9 18      5208 JR	TRUEev
001BAA 12   
001BAB CD      5210 SLE:            CALL	SCP
001BAC F5   
001BAD 1F   
001BAE 28      5211 JR	Z,TRUEev
001BAF 0D   
001BB0 D0      5212 RET	NC
001BB1 18      5213 JR	TRUEev
001BB2 0A   
001BB3 CD      5215 SNE:            CALL	SCP
001BB4 F5   
001BB5 1F   
001BB6 C8      5216 RET	Z
001BB7 18      5217 JR	TRUEev
001BB8 04   
001BB9 CD      5219 SEQ:            CALL	SCP
001BBA F5   
001BBB 1F   
001BBC C0      5220 RET	NZ
001BBD 3E      5221 TRUEev:           LD	A,-1
001BBE FF   
001BBF D9      5222 EXX
001BC0 67      5223 LD	H,A
001BC1 6F      5224 LD	L,A
001BC2 D9      5225 EXX
001BC3 67      5226 LD	H,A
001BC4 6F      5227 LD	L,A
001BC5 3C      5228 INC	A
001BC6 4F      5229 LD	C,A
001BC7 C9      5230 RET
001BC8 3E      5235 PIev:             LD	A,35
001BC9 23   
001BCA 18      5236 JR	FPP1
001BCB 43   
001BCC 3E      5241 ABSev:            LD	A,16
001BCD 10   
001BCE 18      5242 JR	FPPN
001BCF 3A   
001BD0 3E      5247 CPL_ev:           LD	A,26
001BD1 1A   
001BD2 18      5248 JR	FPPN
001BD3 36   
001BD4 3E      5253 DEGev:            LD	A,21
001BD5 15   
001BD6 18      5254 JR	FPPN
001BD7 32   
001BD8 3E      5259 RADev:            LD	A,27
001BD9 1B   
001BDA 18      5260 JR	FPPN
001BDB 2E   
001BDC 3E      5265 SGNev:            LD	A,28
001BDD 1C   
001BDE 18      5266 JR	FPPN
001BDF 2A   
001BE0 3E      5271 INT_ev:           LD	A,23
001BE1 17   
001BE2 18      5272 JR	FPPN
001BE3 26   
001BE4 3E      5277 SQRev:            LD	A,30
001BE5 1E   
001BE6 18      5278 JR	FPPN
001BE7 22   
001BE8 3E      5283 TANev:            LD	A,31
001BE9 1F   
001BEA 18      5284 JR	FPPN
001BEB 1E   
001BEC 3E      5289 COSev:            LD	A,20
001BED 14   
001BEE 18      5290 JR	FPPN
001BEF 1A   
001BF0 3E      5295 SINev:            LD	A,29
001BF1 1D   
001BF2 18      5296 JR	FPPN
001BF3 16   
001BF4 3E      5301 EXPev:            LD	A,22
001BF5 16   
001BF6 18      5302 JR	FPPN
001BF7 12   
001BF8 3E      5307 LNev:             LD	A,24
001BF9 18   
001BFA 18      5308 JR	FPPN
001BFB 0E   
001BFC 3E      5313 LOGev:            LD	A,25
001BFD 19   
001BFE 18      5314 JR	FPPN
001BFF 0A   
001C00 3E      5319 ASNev:            LD	A,18
001C01 12   
001C02 18      5320 JR	FPPN
001C03 06   
001C04 3E      5325 ATNev:            LD	A,19
001C05 13   
001C06 18      5326 JR	FPPN
001C07 02   
001C08 3E      5331 ACSev:            LD	A,17
001C09 11   
001C0A F5      5332 FPPN:           PUSH	AF
001C0B CD      5333 CALL	ITEMN
001C0C 7A   
001C0D 18   
001C0E F1      5334 POP	AF
001C0F CD      5335 FPP1:           CALL	FPP
001C10 15   
001C11 45   
001C12 DA      5336 JP	C,ERROR_
001C13 44   
001C14 3F   
001C15 AF      5337 XOR	A
001C16 C9      5338 RET
001C17 3E      5342 SFIX:           LD	A,38
001C18 26   
001C19 18      5343 JR	FPP1
001C1A F4   
001C1B 3E      5347 SFLOATev:         LD	A,39
001C1C 27   
001C1D 18      5348 JR	FPP1
001C1E F0   
001C1F CD      5353 VALev:            CALL	ITEMS
001C20 69   
001C21 18   
001C22 AF      5354 VAL0:           XOR	A
001C23 12      5355 LD	(DE),A
001C24 DD      5356 LD	IX,ACCS
001C25 21   
001C26 00   
001C27 52   
001C28 3E      5357 LD	A,36
001C29 24   
001C2A 18      5358 JR	FPP1
001C2B E3   
001C2C CD      5363 EVAL_:          CALL	ITEMS
001C2D 69   
001C2E 18   
001C2F 3E      5364 LD	A,CR
001C30 0D   
001C31 12      5365 LD	(DE),A
001C32 FD      5366 PUSH	IY
001C33 E5   
001C34 11      5367 LD	DE,ACCS
001C35 00   
001C36 52   
001C37 FD      5368 LD	IY,ACCS
001C38 21   
001C39 00   
001C3A 52   
001C3B 0E      5369 LD	C,0
001C3C 00   
001C3D CD      5370 CALL	LEXAN2		;TOKENISE
001C3E 18   
001C3F 44   
001C40 12      5371 LD	(DE),A
001C41 13      5372 INC	DE
001C42 AF      5373 XOR	A
001C43 CD      5374 CALL	PUSHS		;PUT ON STACK
001C44 19   
001C45 20   
001C46 FD      5375 LD	IY,2
001C47 21   
001C48 02   
001C49 00   
001C4A FD      5376 ADD	IY,SP
001C4B 39   
001C4C CD      5377 CALL	EXPR
001C4D 02   
001C4E 17   
001C4F FD      5378 POP	IY
001C50 E1   
001C51 FD      5379 ADD	IY,SP
001C52 39   
001C53 FD      5380 LD	SP,IY		;ADJUST STACK POINTER
001C54 F9   
001C55 FD      5381 POP	IY
001C56 E1   
001C57 08      5382 EX	AF,AF'
001C58 C9      5383 RET
001C59 DD      5392 RND:            LD	IX,RANDOM
001C5A 21   
001C5B F6   
001C5C 54   
001C5D CD      5393 CALL	NXT
001C5E 0B   
001C5F 45   
001C60 FE      5394 CP	'('
001C61 28   
001C62 28      5395 JR	Z,RND5		;ARGUMENT FOLLOWS
001C63 1C   
001C64 CD      5396 CALL	LOAD5
001C65 2F   
001C66 19   
001C67 CB      5397 RND1:           RR	C
001C68 19   
001C69 06      5398 LD	B,32
001C6A 20   
001C6B D9      5399 RND2:           EXX			;CALCULATE NEXT
001C6C ED      5400 ADC	HL,HL
001C6D 6A   
001C6E D9      5401 EXX
001C6F ED      5402 ADC	HL,HL
001C70 6A   
001C71 CB      5403 BIT	3,L
001C72 5D   
001C73 28      5404 JR	Z,RND3
001C74 01   
001C75 3F      5405 CCF
001C76 10      5406 RND3:           DJNZ	RND2
001C77 F3   
001C78 CB      5407 RND4:           RL	C		;SAVE CARRY
001C79 11   
001C7A CD      5408 CALL	STORE5		;STORE NEW NUMBER
001C7B 06   
001C7C 32   
001C7D AF      5409 XOR	A
001C7E 4F      5410 LD	C,A
001C7F C9      5411 RET
001C80 CD      5412 RND5:           CALL	ITEMI
001C81 60   
001C82 18   
001C83 DD      5413 LD	IX,RANDOM
001C84 21   
001C85 F6   
001C86 54   
001C87 CB      5414 BIT	7,H		;NEGATIVE?
001C88 7C   
001C89 37      5415 SCF
001C8A 20      5416 JR	NZ,RND4		;SEED
001C8B EC   
001C8C CD      5417 CALL	TEST
001C8D 59   
001C8E 1F   
001C8F F5      5418 PUSH	AF
001C90 41      5419 LD	B,C
001C91 EB      5420 EX	DE,HL
001C92 D9      5421 EXX
001C93 EB      5422 EX	DE,HL
001C94 CD      5423 CALL	LOAD5
001C95 2F   
001C96 19   
001C97 C4      5424 CALL	NZ,RND1		;NEXT IF NON-ZERO
001C98 67   
001C99 1C   
001C9A D9      5425 EXX			;SCRAMBLE (CARE!)
001C9B 0E      5426 LD	C,7FH
001C9C 7F   
001C9D CB      5427 RND6:           BIT	7,H		;FLOAT
001C9E 7C   
001C9F 20      5428 JR	NZ,RND7
001CA0 08   
001CA1 D9      5429 EXX
001CA2 29      5430 ADD	HL,HL
001CA3 D9      5431 EXX
001CA4 ED      5432 ADC	HL,HL
001CA5 6A   
001CA6 0D      5433 DEC	C
001CA7 20      5434 JR	NZ,RND6
001CA8 F4   
001CA9 CB      5435 RND7:           RES	7,H		;POSITIVE 0-0.999999
001CAA BC   
001CAB F1      5436 POP	AF
001CAC C8      5437 RET	Z		;ZERO ARGUMENT
001CAD D9      5438 EXX
001CAE 7B      5439 LD	A,E
001CAF 3D      5440 DEC	A
001CB0 B2      5441 OR	D
001CB1 D9      5442 EXX
001CB2 B3      5443 OR	E
001CB3 B2      5444 OR	D
001CB4 C8      5445 RET	Z		;ARGUMENT=1
001CB5 06      5446 LD	B,0		;INTEGER MARKER
001CB6 00   
001CB7 3E      5447 LD	A,10
001CB8 0A   
001CB9 CD      5448 CALL	FPP		;MULTIPLY
001CBA 15   
001CBB 45   
001CBC DA      5449 JP	C,ERROR_
001CBD 44   
001CBE 3F   
001CBF CD      5450 CALL	SFIX
001CC0 17   
001CC1 1C   
001CC2 C3      5451 JP	ADD1ev
001CC3 56   
001CC4 18   
001CC5 FD      5455 SUMLEN:         INC	IY		;Skip LEN
001CC6 23   
001CC7 CD      5456 CALL	GETARB
001CC8 D7   
001CC9 19   
001CCA CB      5457 BIT	7,B
001CCB 78   
001CCC CA      5458 JP	Z,MISMATev	;Type mismatch
001CCD 6E   
001CCE 18   
001CCF CD      5459 CALL	ARRLEN
001CD0 A4   
001CD1 19   
001CD2 E5      5460 PUSH	HL
001CD3 DD      5461 POP	IX		;IX addresses array
001CD4 E1   
001CD5 AF      5462 XOR	A
001CD6 67      5463 LD	H,A
001CD7 6F      5464 LD	L,A
001CD8 47      5465 LD	B,A
001CD9 DD      5466 SUMLN1:         LD	C,(IX)
001CDA 4E   
001CDB 00   
001CDC 09      5467 ADD	HL,BC
001CDD 0E      5468 LD	C,4
001CDE 04   
001CDF DD      5469 ADD	IX,BC
001CE0 09   
001CE1 1B      5470 DEC	DE		;Count elements
001CE2 7A      5471 LD	A,D
001CE3 B3      5472 OR	E
001CE4 20      5473 JR	NZ,SUMLN1
001CE5 F3   
001CE6 C3      5474 JP	COUNT1
001CE7 50   
001CE8 1B   
001CE9 CD      5478 SUM:            CALL	NXT
001CEA 0B   
001CEB 45   
001CEC FE      5479 CP	TLEN
001CED A9   
001CEE 28      5480 JR	Z,SUMLEN
001CEF D5   
001CF0 CD      5481 CALL	GETARB
001CF1 D7   
001CF2 19   
001CF3 CB      5482 BIT	7,B
001CF4 78   
001CF5 20      5483 JR	NZ,SUMSTR
001CF6 27   
001CF7 C5      5484 PUSH	BC
001CF8 CD      5485 CALL	ARRLEN
001CF9 A4   
001CFA 19   
001CFB E5      5486 PUSH	HL
001CFC DD      5487 POP	IX		;IX addresses array
001CFD E1   
001CFE CD      5488 CALL	ZERO
001CFF F8   
001D00 1F   
001D01 F1      5489 POP	AF		;A = element size
001D02 D5      5490 SUMUP:          PUSH	DE
001D03 F5      5491 PUSH	AF
001D04 CD      5492 CALL	DLOADN
001D05 E7   
001D06 19   
001D07 3E      5493 LD	A,11
001D08 0B   
001D09 CD      5494 CALL	FPP
001D0A 15   
001D0B 45   
001D0C DA      5495 JP	C,ERROR_
001D0D 44   
001D0E 3F   
001D0F F1      5496 POP	AF
001D10 16      5497 LD	D,0
001D11 00   
001D12 5F      5498 LD	E,A
001D13 DD      5499 ADD	IX,DE		;Bump to next element
001D14 19   
001D15 D1      5500 POP	DE
001D16 1B      5501 DEC	DE		;Count elements
001D17 47      5502 LD	B,A
001D18 7A      5503 LD	A,D
001D19 B3      5504 OR	E
001D1A 78      5505 LD	A,B
001D1B 20      5506 JR	NZ,SUMUP
001D1C E5   
001D1D C9      5507 RET
001D1E CD      5511 SUMSTR:         CALL	ARRLEN
001D1F A4   
001D20 19   
001D21 E5      5512 PUSH	HL
001D22 DD      5513 POP	IX		;IX addresses array
001D23 E1   
001D24 EB      5514 EX	DE,HL
001D25 11      5515 LD	DE,ACCS
001D26 00   
001D27 52   
001D28 06      5516 LD	B,0
001D29 00   
001D2A E5      5517 SUMST1:         PUSH	HL
001D2B DD      5518 LD	C,(IX)
001D2C 4E   
001D2D 00   
001D2E 79      5519 LD	A,C
001D2F B7      5520 OR	A
001D30 28      5521 JR	Z,SUMST2
001D31 0E   
001D32 83      5522 ADD	A,E
001D33 3E      5523 LD	A,19
001D34 13   
001D35 DA      5524 JP	C,ERROR_		;"String too long"
001D36 44   
001D37 3F   
001D38 DD      5525 LD	L,(IX+2)
001D39 6E   
001D3A 02   
001D3B DD      5526 LD	H,(IX+3)
001D3C 66   
001D3D 03   
001D3E ED      5527 LDIR
001D3F B0   
001D40 E1      5528 SUMST2:         POP	HL
001D41 0E      5529 LD	C,4
001D42 04   
001D43 DD      5530 ADD	IX,BC
001D44 09   
001D45 2B      5531 DEC	HL		;Count elements
001D46 7C      5532 LD	A,H
001D47 B5      5533 OR	L
001D48 20      5534 JR	NZ,SUMST1
001D49 E0   
001D4A F6      5535 OR	80H
001D4B 80   
001D4C C9      5536 RET
001D4D CD      5540 MODFUN:         CALL	GETARB
001D4E D7   
001D4F 19   
001D50 CB      5541 BIT	7,B
001D51 78   
001D52 C2      5542 JP	NZ,MISMATev
001D53 6E   
001D54 18   
001D55 C5      5543 PUSH	BC
001D56 CD      5544 CALL	ARRLEN
001D57 A4   
001D58 19   
001D59 E5      5545 PUSH	HL
001D5A DD      5546 POP	IX		;IX addresses array
001D5B E1   
001D5C CD      5547 CALL	ZERO
001D5D F8   
001D5E 1F   
001D5F F1      5548 POP	AF		;A = element size
001D60 D5      5549 MODUP:          PUSH	DE
001D61 F5      5550 PUSH	AF
001D62 C5      5551 PUSH	BC
001D63 E5      5552 PUSH	HL
001D64 D9      5553 EXX
001D65 E5      5554 PUSH	HL
001D66 D9      5555 EXX
001D67 CD      5556 CALL	LOADN
001D68 25   
001D69 19   
001D6A AF      5557 XOR	A
001D6B 47      5558 LD	B,A
001D6C 57      5559 LD	D,A
001D6D 5F      5560 LD	E,A
001D6E D9      5561 EXX
001D6F 57      5562 LD	D,A
001D70 1E      5563 LD	E,2
001D71 02   
001D72 D9      5564 EXX
001D73 3E      5565 LD	A,14
001D74 0E   
001D75 DD      5566 PUSH	IX
001D76 E5   
001D77 CD      5567 CALL	FPP		;Square
001D78 15   
001D79 45   
001D7A DD      5568 POP	IX
001D7B E1   
001D7C DA      5569 JP	C,ERROR_
001D7D 44   
001D7E 3F   
001D7F D9      5570 EXX
001D80 EB      5571 EX	DE,HL
001D81 E1      5572 POP	HL
001D82 D9      5573 EXX
001D83 EB      5574 EX	DE,HL
001D84 E1      5575 POP	HL
001D85 79      5576 LD	A,C
001D86 C1      5577 POP	BC
001D87 47      5578 LD	B,A
001D88 3E      5579 LD	A,11
001D89 0B   
001D8A CD      5580 CALL	FPP		;Accumulate
001D8B 15   
001D8C 45   
001D8D DA      5581 JP	C,ERROR_
001D8E 44   
001D8F 3F   
001D90 F1      5582 POP	AF
001D91 16      5583 LD	D,0
001D92 00   
001D93 5F      5584 LD	E,A
001D94 DD      5585 ADD	IX,DE		;Bump to next element
001D95 19   
001D96 D1      5586 POP	DE
001D97 1B      5587 DEC	DE		;Count elements
001D98 47      5588 LD	B,A
001D99 7A      5589 LD	A,D
001D9A B3      5590 OR	E
001D9B 78      5591 LD	A,B
001D9C 20      5592 JR	NZ,MODUP
001D9D C2   
001D9E 3E      5593 LD	A,30
001D9F 1E   
001DA0 CD      5594 CALL	FPP		;Square root
001DA1 15   
001DA2 45   
001DA3 AF      5595 XOR	A
001DA4 C9      5596 RET
001DA5 CD      5601 INSTR:          CALL	EXPRS		;STRING TO SEARCH
001DA6 3C   
001DA7 18   
001DA8 CD      5602 CALL	COMMA
001DA9 A2   
001DAA 20   
001DAB CD      5603 CALL	PUSHS		;SAVE STRING ON STACK
001DAC 19   
001DAD 20   
001DAE CD      5604 CALL	EXPRS		;SUB-STRING
001DAF 3C   
001DB0 18   
001DB1 C1      5605 POP	BC
001DB2 21      5606 LD	HL,0
001DB3 00   
001DB4 00   
001DB5 39      5607 ADD	HL,SP		;HL ADDRESSES MAIN
001DB6 C5      5608 PUSH	BC		;C = MAIN STRING LENGTH
001DB7 43      5609 LD	B,E		;B = SUB-STRING LENGTH
001DB8 CD      5610 CALL	NXT
001DB9 0B   
001DBA 45   
001DBB FE      5611 CP	','
001DBC 2C   
001DBD 3E      5612 LD	A,0
001DBE 00   
001DBF 20      5613 JR	NZ,INSTR1
001DC0 17   
001DC1 FD      5614 INC	IY		;SKIP COMMA
001DC2 23   
001DC3 C5      5615 PUSH	BC		;SAVE LENGTHS
001DC4 E5      5616 PUSH	HL		;SAVE MAIN ADDRESS
001DC5 CD      5617 CALL	PUSHS
001DC6 19   
001DC7 20   
001DC8 CD      5618 CALL	EXPRI
001DC9 33   
001DCA 18   
001DCB C1      5619 POP	BC
001DCC CD      5620 CALL	POPS
001DCD 37   
001DCE 20   
001DCF E1      5621 POP	HL		;RESTORE MAIN ADDRESS
001DD0 C1      5622 POP	BC		;RESTORE LENGTHS
001DD1 D9      5623 EXX
001DD2 7D      5624 LD	A,L
001DD3 D9      5625 EXX
001DD4 B7      5626 OR	A
001DD5 28      5627 JR	Z,INSTR1
001DD6 01   
001DD7 3D      5628 DEC	A
001DD8 11      5629 INSTR1:         LD	DE,ACCS		;DE ADDRESSES SUB
001DD9 00   
001DDA 52   
001DDB CD      5630 CALL	SEARCH
001DDC F2   
001DDD 1D   
001DDE D1      5631 POP	DE
001DDF 28      5632 JR	Z,INSTR2	;N.B. CARRY CLEARED
001DE0 03   
001DE1 ED      5633 SBC	HL,HL
001DE2 62   
001DE3 39      5634 ADD	HL,SP
001DE4 ED      5635 INSTR2:         SBC	HL,SP
001DE5 72   
001DE6 EB      5636 EX	DE,HL
001DE7 26      5637 LD	H,0
001DE8 00   
001DE9 39      5638 ADD	HL,SP
001DEA F9      5639 LD	SP,HL
001DEB EB      5640 EX	DE,HL
001DEC CD      5641 CALL	BRAKET
001DED AE   
001DEE 20   
001DEF C3      5642 JP	COUNT1
001DF0 50   
001DF1 1B   
001DF2 C5      5652 SEARCH:         PUSH	BC
001DF3 06      5653 LD	B,0
001DF4 00   
001DF5 4F      5654 LD	C,A
001DF6 09      5655 ADD	HL,BC		;NEW START ADDRESS
001DF7 C1      5656 POP	BC
001DF8 91      5657 SUB	C
001DF9 30      5658 JR	NC,SRCH4
001DFA 28   
001DFB ED      5659 NEG
001DFC 44   
001DFD 4F      5660 LD	C,A		;REMAINING LENGTH
001DFE 1A      5661 SRCH1ev:          LD	A,(DE)
001DFF C5      5662 PUSH	BC
001E00 06      5663 LD	B,0
001E01 00   
001E02 ED      5664 CPIR			;FIND FIRST CHARACTER
001E03 B1   
001E04 79      5665 LD	A,C
001E05 C1      5666 POP	BC
001E06 20      5667 JR	NZ,SRCH4
001E07 1B   
001E08 4F      5668 LD	C,A
001E09 05      5669 DEC	B		;Bug fix
001E0A B8      5670 CP	B		;Bug fix
001E0B 04      5671 INC	B		;Bug fix
001E0C 38      5672 JR	C,SRCH4		;Bug fix
001E0D 15   
001E0E C5      5673 PUSH	BC
001E0F D5      5674 PUSH	DE
001E10 E5      5675 PUSH	HL
001E11 05      5676 DEC	B
001E12 28      5677 JR	Z,SRCH3		;FOUND !
001E13 08   
001E14 13      5678 SRCH2ev:          INC	DE
001E15 1A      5679 LD	A,(DE)
001E16 BE      5680 CP	(HL)
001E17 20      5681 JR	NZ,SRCH3
001E18 03   
001E19 23      5682 INC	HL
001E1A 10      5683 DJNZ	SRCH2ev
001E1B F8   
001E1C E1      5684 SRCH3:          POP	HL
001E1D D1      5685 POP	DE
001E1E C1      5686 POP	BC
001E1F 20      5687 JR	NZ,SRCH1ev
001E20 DD   
001E21 AF      5688 XOR	A		;Z, NC
001E22 C9      5689 RET			;FOUND
001E23 F6      5691 SRCH4:          OR	0FFH		;NZ, NC
001E24 FF   
001E25 C9      5692 RET			;NOT FOUND
001E26 CD      5697 CHRS:           CALL	ITEMI
001E27 60   
001E28 18   
001E29 D9      5698 EXX
001E2A 7D      5699 LD	A,L
001E2B 18      5700 JR	GET1
001E2C 0A   
001E2D CD      5705 GETS:           CALL	NXT
001E2E 0B   
001E2F 45   
001E30 FE      5706 CP	'#'
001E31 23   
001E32 28      5707 JR	Z,GET2
001E33 06   
001E34 CD      5708 CALL	OSRDCH
001E35 DE   
001E36 05   
001E37 37      5709 GET1:           SCF
001E38 18      5710 JR	INKEY1
001E39 5B   
001E3A CD      5712 GET2:           CALL	CHNL		;File channel
001E3B DB   
001E3C 36   
001E3D CD      5713 CALL	NXT
001E3E 0B   
001E3F 45   
001E40 FE      5714 CP	TBY
001E41 0F   
001E42 28      5715 JR	Z,GET3
001E43 04   
001E44 FE      5716 CP	TTO
001E45 B8   
001E46 20      5717 JR	NZ,GET4
001E47 0C   
001E48 FD      5718 GET3:           INC	IY
001E49 23   
001E4A F5      5719 PUSH	AF
001E4B D5      5720 PUSH	DE
001E4C CD      5721 CALL	ITEMI		;Get BY or TO qualifier
001E4D 60   
001E4E 18   
001E4F D9      5722 EXX
001E50 44      5723 LD	B,H
001E51 4D      5724 LD	C,L
001E52 D1      5725 POP	DE
001E53 F1      5726 POP	AF
001E54 21      5727 GET4:           LD	HL,ACCS
001E55 00   
001E56 52   
001E57 FE      5728 CP	TTO
001E58 B8   
001E59 28      5729 JR	Z,GET5
001E5A 08   
001E5B 51      5730 LD	D,C		;Maximum count
001E5C 01      5731 LD	BC,100H		;Default
001E5D 00   
001E5E 01   
001E5F FE      5732 CP	TBY
001E60 0F   
001E61 28      5733 JR	Z,GET6
001E62 04   
001E63 16      5734 GET5:           LD	D,0
001E64 00   
001E65 CB      5735 SET	1,B		;Flag no count
001E66 C8   
001E67 C5      5736 GET6:           PUSH	BC
001E68 CD      5737 CALL	OSBGET
001E69 5B   
001E6A 06   
001E6B C1      5738 POP	BC
001E6C 38      5739 JR	C,GET9		;EOF
001E6D 1C   
001E6E CB      5740 BIT	1,B
001E6F 48   
001E70 28      5741 JR	Z,GET8
001E71 13   
001E72 B9      5742 CP	C
001E73 28      5743 JR	Z,GET9		;NUL (or supplied term)
001E74 15   
001E75 CB      5744 BIT	7,B
001E76 78   
001E77 20      5745 JR	NZ,GET7
001E78 08   
001E79 CB      5746 BIT	0,B
001E7A 40   
001E7B 28      5747 JR	Z,GET8
001E7C 08   
001E7D FE      5748 CP	LF
001E7E 0A   
001E7F 28      5749 JR	Z,GET9		;LF
001E80 09   
001E81 FE      5750 GET7:           CP	CR
001E82 0D   
001E83 28      5751 JR	Z,GET9		;CR
001E84 05   
001E85 77      5752 GET8:           LD	(HL),A
001E86 2C      5753 INC	L
001E87 15      5754 DEC	D
001E88 20      5755 JR	NZ,GET6
001E89 DD   
001E8A EB      5756 GET9:           EX	DE,HL
001E8B 3E      5757 LD	A,80H
001E8C 80   
001E8D C9      5758 RET
001E8E CD      5765 INKEYS:         CALL	ITEMI
001E8F 60   
001E90 18   
001E91 D9      5766 EXX
001E92 CD      5767 CALL	OSKEY
001E93 91   
001E94 0D   
001E95 11      5768 INKEY1:         LD	DE,ACCS
001E96 00   
001E97 52   
001E98 12      5769 LD	(DE),A
001E99 3E      5770 LD	A,80H
001E9A 80   
001E9B D0      5771 RET	NC
001E9C 1C      5772 INC	E
001E9D C9      5773 RET
001E9E CD      5778 MIDS:           CALL	EXPRS
001E9F 3C   
001EA0 18   
001EA1 CD      5779 CALL	COMMA
001EA2 A2   
001EA3 20   
001EA4 CD      5780 CALL	PUSHS		;SAVE STRING ON STACK
001EA5 19   
001EA6 20   
001EA7 CD      5781 CALL	EXPRI
001EA8 33   
001EA9 18   
001EAA C1      5782 POP	BC
001EAB CD      5783 CALL	POPS
001EAC 37   
001EAD 20   
001EAE D9      5784 EXX
001EAF 7D      5785 LD	A,L
001EB0 D9      5786 EXX
001EB1 B7      5787 OR	A
001EB2 28      5788 JR	Z,MIDS1
001EB3 0D   
001EB4 3D      5789 DEC	A
001EB5 6F      5790 LD	L,A
001EB6 93      5791 SUB	E
001EB7 1E      5792 LD	E,0
001EB8 00   
001EB9 30      5793 JR	NC,MIDS1
001EBA 06   
001EBB ED      5794 NEG
001EBC 44   
001EBD 4F      5795 LD	C,A
001EBE CD      5796 CALL	RIGHT1
001EBF 1D   
001EC0 1F   
001EC1 CD      5797 MIDS1:          CALL	NXT
001EC2 0B   
001EC3 45   
001EC4 FE      5798 CP	','
001EC5 2C   
001EC6 28      5799 JR	Z,LEFT1
001EC7 1A   
001EC8 CD      5800 CALL	BRAKET
001EC9 AE   
001ECA 20   
001ECB 3E      5801 LD	A,80H
001ECC 80   
001ECD C9      5802 RET
001ECE CD      5808 LEFTS:          CALL	EXPRS
001ECF 3C   
001ED0 18   
001ED1 CD      5809 CALL	NXT
001ED2 0B   
001ED3 45   
001ED4 FE      5810 CP	','
001ED5 2C   
001ED6 28      5811 JR	Z,LEFT1
001ED7 0A   
001ED8 CD      5812 CALL	BRAKET
001ED9 AE   
001EDA 20   
001EDB 7B      5813 LD	A,E
001EDC B7      5814 OR	A
001EDD 28      5815 JR	Z,LEFT3
001EDE 1A   
001EDF 1D      5816 DEC	E
001EE0 18      5817 JR	LEFT3
001EE1 17   
001EE2 FD      5819 LEFT1:          INC	IY
001EE3 23   
001EE4 CD      5820 CALL	PUSHS		;SAVE STRING ON STACK
001EE5 19   
001EE6 20   
001EE7 CD      5821 CALL	EXPRI
001EE8 33   
001EE9 18   
001EEA C1      5822 POP	BC
001EEB CD      5823 CALL	POPS
001EEC 37   
001EED 20   
001EEE CD      5824 CALL	BRAKET
001EEF AE   
001EF0 20   
001EF1 D9      5825 EXX
001EF2 7D      5826 LD	A,L
001EF3 D9      5827 EXX
001EF4 BB      5828 CP	E
001EF5 30      5829 JR	NC,LEFT3
001EF6 02   
001EF7 6B      5830 LD	L,E		;FOR RIGHT$
001EF8 5F      5831 LEFT2:          LD	E,A
001EF9 3E      5832 LEFT3:          LD	A,80H		;STRING MARKER
001EFA 80   
001EFB C9      5833 RET
001EFC CD      5838 RIGHTS:         CALL	EXPRS
001EFD 3C   
001EFE 18   
001EFF CD      5839 CALL	NXT
001F00 0B   
001F01 45   
001F02 FE      5840 CP	','
001F03 2C   
001F04 28      5841 JR	Z,RIGHT0
001F05 0C   
001F06 CD      5842 CALL	BRAKET
001F07 AE   
001F08 20   
001F09 7B      5843 LD	A,E
001F0A B7      5844 OR	A
001F0B 28      5845 JR	Z,LEFT3
001F0C EC   
001F0D 3D      5846 DEC	A
001F0E 0E      5847 LD	C,1
001F0F 01   
001F10 18      5848 JR	RIGHT2
001F11 0A   
001F12 CD      5850 RIGHT0:         CALL	LEFT1
001F13 E2   
001F14 1E   
001F15 D0      5851 RET	NC
001F16 1C      5852 INC	E
001F17 1D      5853 DEC	E
001F18 C8      5854 RET	Z
001F19 4B      5855 LD	C,E
001F1A 7D      5856 LD	A,L
001F1B 93      5857 SUB	E
001F1C 6F      5858 RIGHT2:         LD	L,A
001F1D 06      5859 RIGHT1:         LD	B,0
001F1E 00   
001F1F 62      5860 LD	H,D
001F20 58      5861 LD	E,B
001F21 ED      5862 LDIR			;MOVE
001F22 B0   
001F23 3E      5863 LD	A,80H
001F24 80   
001F25 C9      5864 RET
001F26 CD      5869 STRING_:        CALL	EXPRI
001F27 33   
001F28 18   
001F29 CD      5870 CALL	COMMA
001F2A A2   
001F2B 20   
001F2C D9      5871 EXX
001F2D 7D      5872 LD	A,L
001F2E D9      5873 EXX
001F2F F5      5874 PUSH	AF
001F30 CD      5875 CALL	EXPRS
001F31 3C   
001F32 18   
001F33 CD      5876 CALL	BRAKET
001F34 AE   
001F35 20   
001F36 F1      5877 POP	AF
001F37 B7      5878 OR	A
001F38 28      5879 JR	Z,LEFT2		;N=0
001F39 BE   
001F3A 3D      5880 DEC	A
001F3B 4F      5881 LD	C,A
001F3C 3E      5882 LD	A,80H		;STRING MARKER
001F3D 80   
001F3E C8      5883 RET	Z
001F3F 1C      5884 INC	E
001F40 1D      5885 DEC	E
001F41 C8      5886 RET	Z		;NULL STRING
001F42 43      5887 LD	B,E
001F43 62      5888 LD	H,D
001F44 2E      5889 LD	L,0
001F45 00   
001F46 C5      5890 STRIN1:         PUSH	BC
001F47 7E      5891 STRIN2:         LD	A,(HL)
001F48 23      5892 INC	HL
001F49 12      5893 LD	(DE),A
001F4A 1C      5894 INC	E
001F4B 3E      5895 LD	A,19
001F4C 13   
001F4D CA      5896 JP	Z,ERROR_		;"String too long"
001F4E 44   
001F4F 3F   
001F50 10      5897 DJNZ	STRIN2
001F51 F5   
001F52 C1      5898 POP	BC
001F53 0D      5899 DEC	C
001F54 20      5900 JR	NZ,STRIN1
001F55 F0   
001F56 3E      5901 LD	A,80H
001F57 80   
001F58 C9      5902 RET
001F59 7C      5910 TEST:           LD	A,H
001F5A B5      5911 OR	L
001F5B D9      5912 EXX
001F5C B4      5913 OR	H
001F5D B5      5914 OR	L
001F5E D9      5915 EXX
001F5F C9      5916 RET
001F60 D9      5923 DECODE:         EXX
001F61 FD      5924 LD	A,(IY)
001F62 7E   
001F63 00   
001F64 FD      5925 INC	IY
001F65 23   
001F66 17      5926 RLA
001F67 17      5927 RLA
001F68 67      5928 LD	H,A
001F69 E6      5929 AND	0C0H
001F6A C0   
001F6B FD      5930 XOR	(IY)
001F6C AE   
001F6D 00   
001F6E FD      5931 INC	IY
001F6F 23   
001F70 6F      5932 LD	L,A
001F71 7C      5933 LD	A,H
001F72 17      5934 RLA
001F73 17      5935 RLA
001F74 E6      5936 AND	0C0H
001F75 C0   
001F76 FD      5937 XOR	(IY)
001F77 AE   
001F78 00   
001F79 FD      5938 INC	IY
001F7A 23   
001F7B 67      5939 LD	H,A
001F7C D9      5940 EXX
001F7D AF      5941 XOR	A
001F7E 4F      5942 LD	C,A
001F7F 67      5943 LD	H,A
001F80 6F      5944 LD	L,A
001F81 C9      5945 RET
001F82 FD      5952 HEXSTS:         INC	IY		;SKIP TILDE
001F83 23   
001F84 CD      5953 CALL	ITEMN
001F85 7A   
001F86 18   
001F87 CD      5954 CALL	HEXSTR
001F88 8D   
001F89 1F   
001F8A 3E      5955 LD	A,80H
001F8B 80   
001F8C C9      5956 RET
001F8D CD      5958 HEXSTR:         CALL	SFIX
001F8E 17   
001F8F 1C   
001F90 01      5959 LD	BC,8
001F91 08   
001F92 00   
001F93 11      5960 LD	DE,ACCS
001F94 00   
001F95 52   
001F96 C5      5961 HEXST1:         PUSH	BC
001F97 06      5962 LD	B,4
001F98 04   
001F99 AF      5963 XOR	A
001F9A D9      5964 HEXST2:         EXX
001F9B 29      5965 ADD	HL,HL
001F9C D9      5966 EXX
001F9D ED      5967 ADC	HL,HL
001F9E 6A   
001F9F 17      5968 RLA
001FA0 10      5969 DJNZ	HEXST2
001FA1 F8   
001FA2 C1      5970 POP	BC
001FA3 0D      5971 DEC	C
001FA4 F8      5972 RET	M
001FA5 28      5973 JR	Z,HEXST3
001FA6 06   
001FA7 B7      5974 OR	A
001FA8 20      5975 JR	NZ,HEXST3
001FA9 03   
001FAA B8      5976 CP	B
001FAB 28      5977 JR	Z,HEXST1
001FAC E9   
001FAD C6      5978 HEXST3:         ADD	A,90H
001FAE 90   
001FAF 27      5979 DAA
001FB0 CE      5980 ADC	A,40H
001FB1 40   
001FB2 27      5981 DAA
001FB3 12      5982 LD	(DE),A
001FB4 13      5983 INC	DE
001FB5 47      5984 LD	B,A
001FB6 18      5985 JR	HEXST1
001FB7 DE   
001FB8 CD      5995 STRS:           CALL	NXT
001FB9 0B   
001FBA 45   
001FBB FE      5996 CP	'~'
001FBC 7E   
001FBD 28      5997 JR	Z,HEXSTS
001FBE C3   
001FBF CD      5998 CALL	ITEMN
001FC0 7A   
001FC1 18   
001FC2 DD      5999 LD	IX,STAVAR
001FC3 21   
001FC4 00   
001FC5 54   
001FC6 DD      6000 LD	A,(IX+3)
001FC7 7E   
001FC8 03   
001FC9 B7      6001 OR	A
001FCA DD      6002 LD	IX,G9-1		;G9 FORMAT
001FCB 21   
001FCC F2   
001FCD 1F   
001FCE 28      6003 JR	Z,STR0
001FCF 04   
001FD0 DD      6004 STR:            LD	IX,STAVAR
001FD1 21   
001FD2 00   
001FD3 54   
001FD4 11      6005 STR0:           LD	DE,ACCS
001FD5 00   
001FD6 52   
001FD7 3E      6006 LD	A,37
001FD8 25   
001FD9 CD      6007 CALL	FPP
001FDA 15   
001FDB 45   
001FDC DA      6008 JP	C,ERROR_
001FDD 44   
001FDE 3F   
001FDF DD      6009 BIT	0,(IX+2)
001FE0 CB   
001FE1 02   
001FE2 46   
001FE3 3E      6010 STR1:           LD	A,80H		;STRING MARKER
001FE4 80   
001FE5 C8      6011 RET	Z
001FE6 79      6012 LD	A,C
001FE7 C6      6013 ADD	A,4
001FE8 04   
001FE9 BB      6014 STR2:           CP	E
001FEA 28      6015 JR	Z,STR1
001FEB F7   
001FEC EB      6016 EX	DE,HL
001FED 36      6017 LD	(HL),' '	;TRAILING SPACE
001FEE 20   
001FEF 23      6018 INC	HL
001FF0 EB      6019 EX	DE,HL
001FF1 18      6020 JR	STR2
001FF2 F6   
001FF3 09      6022 G9:             DW	9
001FF4 00   
001FF5 CD      6028 SCP:            CALL	SCP0
001FF6 02   
001FF7 20   
001FF8 3E      6029 ZERO:           LD	A,0
001FF9 00   
001FFA D9      6030 EXX
001FFB 67      6031 LD	H,A
001FFC 6F      6032 LD	L,A
001FFD D9      6033 EXX
001FFE 67      6034 LD	H,A
001FFF 6F      6035 LD	L,A
002000 4F      6036 LD	C,A
002001 C9      6037 RET
002002 04      6039 SCP0:           INC	B
002003 0C      6040 INC	C
002004 05      6041 SCP1:           DEC	B
002005 28      6042 JR	Z,SCP2
002006 0A   
002007 0D      6043 DEC	C
002008 28      6044 JR	Z,SCP3
002009 0C   
00200A 1A      6045 LD	A,(DE)
00200B BE      6046 CP	(HL)
00200C C0      6047 RET	NZ
00200D 13      6048 INC	DE
00200E 23      6049 INC	HL
00200F 18      6050 JR	SCP1
002010 F3   
002011 B7      6051 SCP2:           OR	A
002012 0D      6052 DEC	C
002013 C8      6053 RET	Z
002014 37      6054 SCF
002015 C9      6055 RET
002016 B7      6056 SCP3:           OR	A
002017 0C      6057 INC	C
002018 C9      6058 RET
002019 21      6066 PUSHS:          LD	HL,ACCS
00201A 00   
00201B 52   
00201C CD      6067 CALL	CHECK
00201D 86   
00201E 32   
00201F DD      6068 POP	IX		;RETURN ADDRESS
002020 E1   
002021 B7      6069 OR	A		;CLEAR CARRY
002022 54      6070 LD	D,H
002023 4B      6071 LD	C,E
002024 ED      6072 SBC	HL,DE
002025 52   
002026 39      6073 ADD	HL,SP
002027 F9      6074 LD	SP,HL
002028 47      6075 LD	B,A
002029 C5      6076 PUSH	BC
00202A 28      6077 JR	Z,PUSHS1	;ZERO LENGTH
00202B 09   
00202C EB      6078 EX	DE,HL
00202D 06      6079 LD	B,0
00202E 00   
00202F 68      6080 LD	L,B		;L=0
002030 ED      6081 LDIR			;COPY TO STACK
002031 B0   
002032 CD      6082 CALL	CHECK
002033 86   
002034 32   
002035 DD      6083 PUSHS1:         JP	(IX)		;"RETURN"
002036 E9   
002037 DD      6091 POPS:           POP	IX		;RETURN ADDRESS
002038 E1   
002039 21      6092 LD	HL,0
00203A 00   
00203B 00   
00203C 44      6093 LD	B,H		;B=0
00203D 39      6094 ADD	HL,SP
00203E 11      6095 LD	DE,ACCS
00203F 00   
002040 52   
002041 0C      6096 INC	C
002042 0D      6097 DEC	C
002043 28      6098 JR	Z,POPS1		;ZERO LENGTH
002044 02   
002045 ED      6099 LDIR			;COPY FROM STACK
002046 B0   
002047 F9      6100 POPS1:          LD	SP,HL
002048 DD      6101 JP	(IX)		;"RETURN"
002049 E9   
00204A FD      6103 BINDIG:         LD	A,(IY)
00204B 7E   
00204C 00   
00204D FE      6104 CP	'0'
00204E 30   
00204F D8      6105 RET	C
002050 FE      6106 CP	'1'+1
002051 32   
002052 3F      6107 CCF
002053 D8      6108 RET	C
002054 D6      6109 SUB	'0'
002055 30   
002056 C9      6110 RET
002057 FD      6112 HEXDIG:         LD	A,(IY)
002058 7E   
002059 00   
00205A FE      6113 CP	'0'
00205B 30   
00205C D8      6114 RET	C
00205D FE      6115 CP	'9'+1
00205E 3A   
00205F 3F      6116 CCF
002060 D0      6117 RET	NC
002061 FE      6118 CP	'A'
002062 41   
002063 D8      6119 RET	C
002064 D6      6120 SUB	'A'-10
002065 37   
002066 FE      6121 CP	16
002067 10   
002068 3F      6122 CCF
002069 C9      6123 RET
00206A FE      6125 RELOPQ:         CP	'>'
00206B 3E   
00206C D0      6126 RET	NC
00206D FE      6127 CP	'='
00206E 3D   
00206F D0      6128 RET	NC
002070 FE      6129 CP	'<'
002071 3C   
002072 C9      6130 RET
002073 FD      6132 SAVEev:           INC	IY
002074 23   
002075 E6      6133 AND	0FH
002076 0F   
002077 08      6134 SAVE1:          EX	AF,AF'
002078 FA      6135 JP	M,MISMATev
002079 6E   
00207A 18   
00207B 08      6136 EX	AF,AF'
00207C E3      6137 EX	(SP),HL
00207D D9      6138 EXX
00207E E5      6139 PUSH	HL
00207F D9      6140 EXX
002080 F5      6141 PUSH	AF
002081 C5      6142 PUSH	BC
002082 E9      6143 JP	(HL)
002083 08      6145 DOIT:           EX	AF,AF'
002084 FA      6146 JP	M,MISMATev
002085 6E   
002086 18   
002087 D9      6147 EXX
002088 C1      6148 POP	BC		;RETURN ADDRESS
002089 D9      6149 EXX
00208A 79      6150 LD	A,C
00208B C1      6151 POP	BC
00208C 47      6152 LD	B,A
00208D F1      6153 POP	AF		;OPERATOR
00208E D9      6154 EXX
00208F EB      6155 EX	DE,HL
002090 E1      6156 POP	HL
002091 D9      6157 EXX
002092 EB      6158 EX	DE,HL
002093 E1      6159 POP	HL
002094 D9      6160 EXX
002095 C5      6161 PUSH	BC
002096 D9      6162 EXX
002097 CD      6163 CALL	FPP
002098 15   
002099 45   
00209A 38      6164 JR	C,ERROR1ev
00209B 1C   
00209C AF      6165 XOR	A
00209D 08      6166 EX	AF,AF'		;TYPE
00209E FD      6167 LD	A,(IY)
00209F 7E   
0020A0 00   
0020A1 C9      6168 RET
0020A2 CD      6170 COMMA:          CALL	NXT
0020A3 0B   
0020A4 45   
0020A5 FD      6171 INC	IY
0020A6 23   
0020A7 FE      6172 CP	','
0020A8 2C   
0020A9 C8      6173 RET	Z
0020AA 3E      6174 LD	A,5
0020AB 05   
0020AC 18      6175 JR	ERROR1ev		;"Missing ,"
0020AD 0A   
0020AE CD      6177 BRAKET:         CALL	NXT
0020AF 0B   
0020B0 45   
0020B1 FD      6178 INC	IY
0020B2 23   
0020B3 FE      6179 CP	')'
0020B4 29   
0020B5 C8      6180 RET	Z
0020B6 3E      6181 LD	A,27
0020B7 1B   
0020B8 C3      6182 ERROR1ev:         JP	ERROR_		;"Missing )"
0020B9 44   
0020BA 3F   
0020BB E5      6184 DISPT2:         PUSH	HL
0020BC 21      6185 LD	HL,SOPTBL
0020BD F6   
0020BE 16   
0020BF 18      6186 JR	DISPT0
0020C0 06   
0020C1 E5      6188 DISPATev:         PUSH	HL
0020C2 D6      6189 SUB	FUNTOK
0020C3 8D   
0020C4 21      6190 LD	HL,FUNTBL
0020C5 82   
0020C6 16   
0020C7 C5      6191 DISPT0:         PUSH	BC
0020C8 87      6192 ADD	A,A
0020C9 4F      6193 LD	C,A
0020CA 06      6194 LD	B,0
0020CB 00   
0020CC 09      6195 ADD	HL,BC
0020CD 7E      6196 LD	A,(HL)
0020CE 23      6197 INC	HL
0020CF 66      6198 LD	H,(HL)
0020D0 6F      6199 LD	L,A
0020D1 C1      6200 POP	BC
0020D2 E3      6201 EX	(SP),HL
0020D3 C9      6202 RET			;OFF TO ROUTINE
0020D4 7A      6204 STOREA:         LD	A,D
0020D5 D5      6205 PUSH	DE
0020D6 E5      6206 PUSH	HL
0020D7 DD      6207 EX	(SP),IX
0020D8 E3   
0020D9 B7      6208 OR	A
0020DA FA      6209 JP	M,STORA1
0020DB EB   
0020DC 20   
0020DD CD      6210 CALL	LOADN
0020DE 25   
0020DF 19   
0020E0 DD      6211 EX	(SP),IX
0020E1 E3   
0020E2 CD      6212 CALL	MODIFY
0020E3 CE   
0020E4 31   
0020E5 E1      6213 POP	HL
0020E6 D1      6214 POP	DE
0020E7 4A      6215 LD	C,D
0020E8 06      6216 LD	B,0
0020E9 00   
0020EA C9      6217 RET
0020EB D5      6219 STORA1:         PUSH	DE
0020EC CD      6220 CALL	LOADS
0020ED 0E   
0020EE 1A   
0020EF E1      6221 POP	HL
0020F0 DD      6222 EX	(SP),IX
0020F1 E3   
0020F2 CD      6223 CALL	MODIFS
0020F3 18   
0020F4 32   
0020F5 E1      6224 POP	HL
0020F6 D1      6225 POP	DE
0020F7 01      6226 LD	BC,4
0020F8 04   
0020F9 00   
0020FA C9      6227 RET
0020FB CB      6239 LETARR:         RES	6,D		;Lose array marker
0020FC B2   
0020FD D5      6240 PUSH	DE		;Save type & opcode
0020FE CD      6241 CALL	GETAR1		;Get and check indirect link
0020FF CD   
002100 19   
002101 CD      6242 CALL	ARRLEN		;DE = elements, HL addresses first
002102 A4   
002103 19   
002104 C1      6243 POP	BC
002105 78      6244 LD	A,B		;A = type
002106 D5      6245 PUSH	DE
002107 C5      6246 PUSH	BC
002108 E5      6247 PUSH	HL
002109 CD      6248 CALL	X14OR5		;DE = size in bytes
00210A AD   
00210B 36   
00210C 42      6249 LD	B,D
00210D 4B      6250 LD	C,E
00210E DD      6251 POP	IX
00210F E1   
002110 D1      6252 POP	DE
002111 AF      6261 XOR	A		;Clear carry and zero error code
002112 ED      6262 SBC	HL,HL
002113 62   
002114 39      6263 ADD	HL,SP		;HL = SP
002115 ED      6264 SBC	HL,BC
002116 42   
002117 38      6265 JR	C,ERROR1ev	;'No room'
002118 9F   
002119 C5      6266 PUSH	BC
00211A ED      6267 LD	BC,(FREE)
00211B 4B   
00211C E0   
00211D 54   
00211E 04      6268 INC	B		;Safety margin
00211F ED      6269 SBC	HL,BC
002120 42   
002121 09      6270 ADD	HL,BC
002122 C1      6271 POP	BC
002123 38      6272 JR	C,ERROR1ev	;'No room'
002124 93   
002125 F9      6273 LD	SP,HL
002126 36      6274 LETA0:          LD	(HL),0
002127 00   
002128 23      6275 INC	HL
002129 0B      6276 DEC	BC
00212A 78      6277 LD	A,B
00212B B1      6278 OR	C
00212C 20      6279 JR	NZ,LETA0	;Clear allocated stack
00212D F8   
00212E 4E      6280 LD	C,(HL)
00212F 23      6281 INC	HL
002130 46      6282 LD	B,(HL)
002131 67      6283 LD	H,A
002132 6F      6284 LD	L,A
002133 39      6285 ADD	HL,SP
002134 CD      6290 CALL	EXPRA
002135 3C   
002136 21   
002137 F9      6291 LD	SP,HL		;Update stack pointer
002138 C1      6292 POP	BC		;Level stack
002139 C3      6293 JP	XEQ
00213A 99   
00213B 24   
00213C 3E      6305 EXPRA:          LD	A,'='
00213D 3D   
00213E FD      6306 DEC	IY
00213F 2B   
002140 FD      6307 EXPRA1:         INC	IY
002141 23   
002142 D5      6308 PUSH	DE
002143 C5      6309 PUSH	BC
002144 E5      6310 PUSH	HL
002145 DD      6311 PUSH	IX
002146 E5   
002147 5F      6312 LD	E,A		;Operator
002148 CD      6313 CALL	ITEMA
002149 B6   
00214A 21   
00214B DD      6314 POP	IX
00214C E1   
00214D E1      6315 POP	HL
00214E C1      6316 POP	BC
00214F D1      6317 POP	DE
002150 CD      6318 CALL	NXT
002151 0B   
002152 45   
002153 FE      6319 CP	','		;List?
002154 2C   
002155 28      6320 JR	Z,EXPRA3
002156 13   
002157 CD      6321 CALL	TERMQ
002158 36   
002159 35   
00215A 20      6322 JR	NZ,EXPRA1
00215B E4   
00215C C5      6326 EXPRA2:         PUSH	BC
00215D CD      6327 CALL	STOREA		;(IX) <- (HL)
00215E D4   
00215F 20   
002160 09      6328 ADD	HL,BC
002161 DD      6329 ADD	IX,BC
002162 09   
002163 C1      6330 POP	BC
002164 0B      6331 DEC	BC
002165 78      6332 LD	A,B
002166 B1      6333 OR	C
002167 20      6334 JR	NZ,EXPRA2
002168 F3   
002169 C9      6335 RET
00216A C5      6339 EXPRA3:         PUSH	BC
00216B CD      6340 CALL	STOREA		;(IX) <- (HL)
00216C D4   
00216D 20   
00216E FD      6341 EXPRA4:         INC	IY		;Bump past comma
00216F 23   
002170 09      6342 ADD	HL,BC
002171 DD      6343 ADD	IX,BC
002172 09   
002173 C1      6344 POP	BC
002174 0B      6345 DEC	BC
002175 78      6346 LD	A,B
002176 B1      6347 OR	C
002177 C8      6348 RET	Z
002178 C5      6349 PUSH	BC
002179 D5      6350 PUSH	DE
00217A E5      6351 PUSH	HL
00217B DD      6352 PUSH	IX
00217C E5   
00217D CB      6353 BIT	7,D
00217E 7A   
00217F 20      6354 JR	NZ,EXPRA5
002180 0E   
002181 D5      6355 PUSH	DE
002182 CD      6356 CALL	EXPRN
002183 2C   
002184 18   
002185 D1      6357 POP	DE
002186 DD      6358 POP	IX
002187 E1   
002188 DD      6359 PUSH	IX
002189 E5   
00218A CD      6360 CALL	MODIFY
00218B CE   
00218C 31   
00218D 18      6361 JR	EXPRA6
00218E 0C   
00218F D5      6363 EXPRA5:         PUSH	DE
002190 CD      6364 CALL	EXPRS
002191 3C   
002192 18   
002193 E1      6365 POP	HL
002194 DD      6366 POP	IX
002195 E1   
002196 DD      6367 PUSH	IX
002197 E5   
002198 CD      6368 CALL	MODIFS
002199 18   
00219A 32   
00219B DD      6369 EXPRA6:         POP	IX
00219C E1   
00219D E1      6370 POP	HL
00219E D1      6371 POP	DE
00219F 01      6372 LD	BC,4
0021A0 04   
0021A1 00   
0021A2 CB      6373 BIT	7,D
0021A3 7A   
0021A4 20      6374 JR	NZ,EXPRA7
0021A5 01   
0021A6 4A      6375 LD	C,D
0021A7 CD      6376 EXPRA7:         CALL	NXT
0021A8 0B   
0021A9 45   
0021AA FE      6377 CP	','
0021AB 2C   
0021AC 28      6378 JR	Z,EXPRA4
0021AD C0   
0021AE D1      6379 POP	DE
0021AF 09      6380 EXPRA8:         ADD	HL,BC		;Skip remaining elements
0021B0 1B      6381 DEC	DE
0021B1 7A      6382 LD	A,D
0021B2 B3      6383 OR	E
0021B3 20      6384 JR	NZ,EXPRA8
0021B4 FA   
0021B5 C9      6385 RET
0021B6 CD      6396 ITEMA:          CALL	NXT
0021B7 0B   
0021B8 45   
0021B9 E5      6397 PUSH	HL		;Pointer to destination
0021BA C5      6398 PUSH	BC		;Number of elements
0021BB FD      6399 PUSH	IY		;In case normal expression
0021BC E5   
0021BD D5      6400 PUSH	DE		;Ditto
0021BE FE      6401 CP	'-'
0021BF 2D   
0021C0 20      6402 JR	NZ,ITEMA1	;Not unary minus
0021C1 0C   
0021C2 7B      6403 LD	A,E
0021C3 FE      6404 CP	'='
0021C4 3D   
0021C5 20      6405 JR	NZ,ITEMA1	;Not unary minus
0021C6 07   
0021C7 FD      6406 INC	IY		;Bump past '-'
0021C8 23   
0021C9 CD      6407 CALL	NXT
0021CA 0B   
0021CB 45   
0021CC 1E      6408 LD	E,'-'		;Unary minus
0021CD 2D   
0021CE D5      6409 ITEMA1:         PUSH	DE		;Type and operator
0021CF CD      6410 CALL	GETVAR
0021D0 E3   
0021D1 41   
0021D2 D1      6411 POP	DE		;Type & operator
0021D3 20      6412 JR	NZ,ITEMA4	;Non-array expression
0021D4 56   
0021D5 CB      6413 BIT	6,A
0021D6 77   
0021D7 28      6414 JR	Z,ITEMA4	;Not a whole array
0021D8 52   
0021D9 C1      6415 POP	BC		;Junk saved original op
0021DA C1      6416 POP	BC		;Junk saved text pointer
0021DB CB      6417 RES	6,A
0021DC B7   
0021DD BA      6418 CP	D
0021DE C2      6419 JP	NZ,MISMATev	;'Type mismatch'
0021DF 6E   
0021E0 18   
0021E1 D5      6420 PUSH	DE		;Save type & operator again
0021E2 CD      6421 CALL	GETAR1
0021E3 CD   
0021E4 19   
0021E5 CD      6422 CALL	ARRLEN
0021E6 A4   
0021E7 19   
0021E8 42      6423 LD	B,D		;BC = number of elements
0021E9 4B      6424 LD	C,E
0021EA D1      6425 POP	DE		;Restore type & operator
0021EB E3      6426 EX	(SP),HL
0021EC CD      6427 CALL	NXT
0021ED 0B   
0021EE 45   
0021EF DD      6428 POP	IX		;Pointer to source
0021F0 E1   
0021F1 FE      6429 CP	'.'
0021F2 2E   
0021F3 CA      6430 JP	Z,ARRDOT	;Dot product
0021F4 83   
0021F5 22   
0021F6 B7      6431 OR	A
0021F7 ED      6432 SBC	HL,BC		;Same number of elements?
0021F8 42   
0021F9 C2      6433 JP	NZ,MISMATev	;'Type mismatch'
0021FA 6E   
0021FB 18   
0021FC E1      6434 POP	HL		;Pointer to destination
0021FD CB      6435 BIT	7,D
0021FE 7A   
0021FF 20      6436 JR	NZ,ITEMA3
002200 1D   
002201 C5      6440 ITEMA2:         PUSH	BC
002202 E5      6441 PUSH	HL
002203 7A      6442 LD	A,D
002204 CD      6443 CALL	LOADN
002205 25   
002206 19   
002207 DD      6444 EX	(SP),IX
002208 E3   
002209 D5      6445 PUSH	DE
00220A CD      6446 CALL	MODIFY
00220B CE   
00220C 31   
00220D D1      6447 POP	DE
00220E DD      6448 EX	(SP),IX
00220F E3   
002210 E1      6449 POP	HL
002211 4A      6450 LD	C,D
002212 06      6451 LD	B,0
002213 00   
002214 DD      6452 ADD	IX,BC
002215 09   
002216 09      6453 ADD	HL,BC
002217 C1      6454 POP	BC
002218 0B      6455 DEC	BC
002219 78      6456 LD	A,B
00221A B1      6457 OR	C
00221B 20      6458 JR	NZ,ITEMA2
00221C E4   
00221D C9      6459 RET
00221E EB      6463 ITEMA3:         EX	DE,HL		;DE = destination
00221F 60      6464 LD	H,B
002220 69      6465 LD	L,C
002221 29      6466 ADD	HL,HL
002222 29      6467 ADD	HL,HL
002223 44      6468 LD	B,H
002224 4D      6469 LD	C,L
002225 DD      6470 PUSH	IX
002226 E5   
002227 E1      6471 POP	HL		;HL = source
002228 ED      6472 LDIR
002229 B0   
00222A C9      6473 RET
00222B D1      6477 ITEMA4:         POP	DE		;Restore original operator
00222C FD      6478 POP	IY		;Restore original text pointer
00222D E1   
00222E CB      6479 BIT	7,D
00222F 7A   
002230 20      6480 JR	NZ,ITEMA5
002231 28   
002232 D5      6481 PUSH	DE
002233 CD      6482 CALL	EXPR45		;; should be EXP345
002234 0B   
002235 18   
002236 79      6483 LD	A,C		;Exponent
002237 D1      6484 POP	DE		;Type / operator
002238 C1      6485 POP	BC		;Count
002239 DD      6486 POP	IX
00223A E1   
00223B E5      6487 ITEMA7:         PUSH	HL
00223C C5      6488 PUSH	BC
00223D D5      6489 PUSH	DE
00223E D9      6490 EXX
00223F E5      6491 PUSH	HL
002240 D9      6492 EXX
002241 F5      6493 PUSH	AF
002242 4F      6494 LD	C,A
002243 CD      6495 CALL	MODIFY
002244 CE   
002245 31   
002246 F1      6496 POP	AF
002247 D9      6497 EXX
002248 E1      6498 POP	HL
002249 D9      6499 EXX
00224A D1      6500 POP	DE
00224B 4A      6501 LD	C,D
00224C 06      6502 LD	B,0
00224D 00   
00224E DD      6503 ADD	IX,BC
00224F 09   
002250 C1      6504 POP	BC
002251 0B      6505 DEC	BC
002252 ED      6506 SBC	HL,HL
002253 62   
002254 ED      6507 SBC	HL,BC
002255 42   
002256 E1      6508 POP	HL
002257 20      6509 JR	NZ,ITEMA7	;Copy into every element!
002258 E2   
002259 C9      6510 RET
00225A CD      6514 ITEMA5:         CALL	EXPRS
00225B 3C   
00225C 18   
00225D 7B      6515 LD	A,E
00225E B7      6516 OR	A
00225F 28      6517 JR	Z,ITEMA0
002260 0B   
002261 21      6518 LD	HL,ACCS
002262 00   
002263 52   
002264 11      6519 LD	DE,BUFFER
002265 00   
002266 53   
002267 4F      6520 LD	C,A
002268 06      6521 LD	B,0
002269 00   
00226A ED      6522 LDIR
00226B B0   
00226C C1      6523 ITEMA0:         POP	BC
00226D DD      6524 POP	IX
00226E E1   
00226F D9      6525 EXX
002270 6F      6526 LD	L,A
002271 D9      6527 EXX
002272 11      6528 LD	DE,4
002273 04   
002274 00   
002275 21      6529 LD	HL,BUFFER
002276 00   
002277 53   
002278 CD      6530 ITEMA6:         CALL	STORE4
002279 09   
00227A 32   
00227B DD      6531 ADD	IX,DE
00227C 19   
00227D 0B      6532 DEC	BC
00227E 78      6533 LD	A,B
00227F B1      6534 OR	C
002280 20      6535 JR	NZ,ITEMA6	;Copy into every element!
002281 F6   
002282 C9      6536 RET
002283 FD      6540 ARRDOT:         INC	IY		;Bump past dot
002284 23   
002285 7A      6541 LD	A,D		;Type
002286 B7      6542 OR	A
002287 FA      6543 JP	M,MISMATev	;'Type mismatch'
002288 6E   
002289 18   
00228A EB      6544 EX	DE,HL
00228B E1      6545 POP	HL
00228C D5      6553 PUSH	DE
00228D E5      6554 PUSH	HL
00228E DD      6555 PUSH	IX
00228F E5   
002290 F5      6556 PUSH	AF
002291 CD      6557 CALL	GETARR
002292 BD   
002293 19   
002294 CD      6558 CALL	ARRLEN
002295 A4   
002296 19   
002297 F1      6559 POP	AF
002298 EB      6560 EX	DE,HL
002299 DD      6561 LD	L,(IX)
00229A 6E   
00229B 00   
00229C DD      6562 LD	H,(IX+1)	;Indirect pointer
00229D 66   
00229E 01   
00229F 6E      6563 LD	L,(HL)		;No. of dimensions
0022A0 2D      6564 DEC	L
0022A1 EB      6565 EX	DE,HL
0022A2 DD      6566 POP	IX
0022A3 E1   
0022A4 C1      6567 POP	BC
0022A5 D1      6568 POP	DE
0022A6 FD      6570 PUSH	IY		;Save text pointer
0022A7 E5   
0022A8 C5      6571 PUSH	BC		;Save destination pointer
0022A9 E5      6572 PUSH	HL
0022AA FD      6573 POP	IY
0022AB E1   
0022AC 21      6577 LD	HL,1
0022AD 01   
0022AE 00   
0022AF 28      6578 JR	Z,ARR1D
0022B0 06   
0022B1 FD      6579 LD	H,(IY-1)
0022B2 66   
0022B3 FF   
0022B4 FD      6580 LD	L,(IY-2)
0022B5 6E   
0022B6 FE   
0022B7 D5      6581 ARR1D:          PUSH	DE
0022B8 EB      6582 EX	DE,HL
0022B9 CD      6583 CALL	X14OR5
0022BA AD   
0022BB 36   
0022BC EB      6584 EX	DE,HL
0022BD D1      6585 POP	DE
0022BE DD      6586 LD	B,(IX-1)
0022BF 46   
0022C0 FF   
0022C1 DD      6587 LD	C,(IX-2)
0022C2 4E   
0022C3 FE   
0022C4 C5      6599 OUTER:          PUSH	BC		;1
0022C5 D5      6600 PUSH	DE		;2
0022C6 E5      6601 PUSH	HL		;3
0022C7 DD      6602 PUSH	IX		;4
0022C8 E5   
0022C9 FD      6603 PUSH	IY		;5
0022CA E5   
0022CB 50      6604 LD	D,B
0022CC 59      6605 LD	E,C
0022CD F5      6606 PUSH	AF
0022CE CD      6607 CALL	ZERO		;Zero accumulator
0022CF F8   
0022D0 1F   
0022D1 F1      6608 POP	AF
0022D2 D5      6609 INNER:          PUSH	DE		;6
0022D3 C5      6610 PUSH	BC		;Save accumulator
0022D4 E5      6611 PUSH	HL
0022D5 D9      6612 EXX
0022D6 E5      6613 PUSH	HL
0022D7 D9      6614 EXX
0022D8 CD      6616 CALL	LOADN		;Load from (IX)
0022D9 25   
0022DA 19   
0022DB DD      6617 PUSH	IX
0022DC E5   
0022DD FD      6618 EX	(SP),IY
0022DE E3   
0022DF DD      6619 POP	IX
0022E0 E1   
0022E1 CD      6621 CALL	DLOADN		;Load from (IY)
0022E2 E7   
0022E3 19   
0022E4 DD      6622 PUSH	IX
0022E5 E5   
0022E6 FD      6623 EX	(SP),IY
0022E7 E3   
0022E8 DD      6624 POP	IX
0022E9 E1   
0022EA F5      6626 PUSH	AF
0022EB 3E      6627 LD	A,10
0022EC 0A   
0022ED CD      6628 CALL	FPP		;Multiply
0022EE 15   
0022EF 45   
0022F0 DA      6629 JP	C,ERROR_
0022F1 44   
0022F2 3F   
0022F3 F1      6630 POP	AF
0022F4 D9      6632 EXX			;Restore accumulator
0022F5 EB      6633 EX	DE,HL
0022F6 E1      6634 POP	HL
0022F7 D9      6635 EXX
0022F8 EB      6636 EX	DE,HL
0022F9 E1      6637 POP	HL
0022FA 08      6638 EX	AF,AF'
0022FB 79      6639 LD	A,C
0022FC C1      6640 POP	BC
0022FD 47      6641 LD	B,A
0022FE 08      6642 EX	AF,AF'
0022FF F5      6644 PUSH	AF
002300 3E      6645 LD	A,11
002301 0B   
002302 CD      6646 CALL	FPP		;Accumulate
002303 15   
002304 45   
002305 DA      6647 JP	C,ERROR_
002306 44   
002307 3F   
002308 F1      6648 POP	AF
002309 D1      6652 POP	DE		;5
00230A D9      6654 EXX
00230B 4F      6655 LD	C,A
00230C 06      6656 LD	B,0
00230D 00   
00230E DD      6657 ADD	IX,BC
00230F 09   
002310 D1      6658 POP	DE
002311 C1      6659 POP	BC
002312 E3      6660 EX	(SP),HL
002313 EB      6661 EX	DE,HL
002314 FD      6662 ADD	IY,DE
002315 19   
002316 EB      6663 EX	DE,HL
002317 E3      6664 EX	(SP),HL
002318 C5      6665 PUSH	BC
002319 D5      6666 PUSH	DE
00231A D9      6667 EXX
00231B 1B      6671 DEC	DE		;Inner loop counter
00231C 1C      6672 INC	E
00231D 1D      6673 DEC	E
00231E 20      6674 JR	NZ,INNER
00231F B2   
002320 14      6675 INC	D
002321 15      6676 DEC	D
002322 20      6677 JR	NZ,INNER
002323 AE   
002324 FD      6679 POP	IY		;4
002325 E1   
002326 DD      6680 POP	IX		;3
002327 E1   
002328 D9      6684 EXX
002329 08      6685 EX	AF,AF'
00232A F1      6686 POP	AF
00232B C1      6687 POP	BC
00232C D1      6688 POP	DE
00232D DD      6689 EX	(SP),IX
00232E E3   
00232F D5      6690 PUSH	DE
002330 C5      6691 PUSH	BC
002331 F5      6692 PUSH	AF
002332 08      6693 EX	AF,AF'
002333 D9      6694 EXX
002334 F5      6698 PUSH	AF
002335 D5      6699 PUSH	DE
002336 CD      6700 CALL	STOREN
002337 F0   
002338 31   
002339 D1      6701 POP	DE
00233A F1      6702 POP	AF
00233B 4F      6703 LD	C,A
00233C 06      6704 LD	B,0
00233D 00   
00233E DD      6705 ADD	IX,BC
00233F 09   
002340 D9      6709 EXX
002341 08      6710 EX	AF,AF'
002342 F1      6711 POP	AF
002343 C1      6712 POP	BC
002344 D1      6713 POP	DE
002345 DD      6714 EX	(SP),IX
002346 E3   
002347 D5      6715 PUSH	DE
002348 C5      6716 PUSH	BC
002349 F5      6717 PUSH	AF
00234A 08      6718 EX	AF,AF'
00234B D9      6719 EXX
00234C E1      6721 POP	HL		;2
00234D D1      6722 POP	DE		;1 Outer loop counter
00234E C1      6723 POP	BC		;0
00234F 1B      6724 DEC	DE		;Count outer loops
002350 C5      6728 PUSH	BC
002351 D5      6729 PUSH	DE
002352 E5      6730 PUSH	HL
002353 4F      6731 LD	C,A
002354 06      6732 LD	B,0
002355 00   
002356 FD      6733 ADD	IY,BC
002357 09   
002358 F5      6734 PUSH	AF
002359 E5      6735 PUSH	HL
00235A CD      6736 CALL	X14OR5
00235B AD   
00235C 36   
00235D C1      6737 POP	BC
00235E CD      6738 CALL	MOD16
00235F 90   
002360 23   
002361 F1      6739 POP	AF
002362 B7      6740 OR	A
002363 01      6741 LD	BC,0
002364 00   
002365 00   
002366 ED      6742 SBC	HL,BC
002367 42   
002368 E1      6743 POP	HL
002369 D1      6744 POP	DE
00236A C1      6745 POP	BC
00236B 20      6746 JR	NZ,MODNZ
00236C 15   
00236D D5      6747 PUSH	DE
00236E E5      6748 PUSH	HL
00236F EB      6749 EX	DE,HL
002370 FD      6750 PUSH	IY
002371 E5   
002372 E1      6751 POP	HL
002373 B7      6752 OR	A
002374 ED      6753 SBC	HL,DE
002375 52   
002376 E5      6754 PUSH	HL
002377 FD      6755 POP	IY
002378 E1   
002379 50      6756 LD	D,B
00237A 59      6757 LD	E,C
00237B CD      6758 CALL	X14OR5
00237C AD   
00237D 36   
00237E DD      6759 ADD	IX,DE
00237F 19   
002380 E1      6760 POP	HL
002381 D1      6761 POP	DE
002382 1C      6766 INC	E
002383 1D      6767 DEC	E
002384 C2      6768 JP	NZ,OUTER
002385 C4   
002386 22   
002387 14      6769 INC	D
002388 15      6770 DEC	D
002389 C2      6771 JP	NZ,OUTER
00238A C4   
00238B 22   
00238C E1      6775 POP	HL
00238D FD      6776 POP	IY
00238E E1   
00238F C9      6777 RET
002390 AF      6781 MOD16:          XOR	A
002391 67      6782 LD	H,A
002392 6F      6783 LD	L,A
002393 3E      6784 LD	A,17
002394 11   
002395 ED      6785 MOD160:         SBC	HL,BC
002396 42   
002397 30      6786 JR	NC,MOD161
002398 01   
002399 09      6787 ADD	HL,BC
00239A 3F      6788 MOD161:         CCF
00239B CB      6789 RL	E
00239C 13   
00239D CB      6790 RL	D
00239E 12   
00239F 3D      6791 DEC	A
0023A0 C8      6792 RET	Z
0023A1 ED      6793 ADC	HL,HL
0023A2 6A   
0023A3 18      6794 JR	MOD160
0023A4 F0   
0023A5             6799   ; --- Begin exec.asm ---
0023A5 77      6986 CMDTAB:         DW	LEFTSL
0023A6 30   
0023A7 8B      6987 DW	MIDSL
0023A8 30   
0023A9 81      6988 DW	RITESL
0023AA 30   
0023AB E0      6989 DW	SYNTAX	;STR$
0023AC 25   
0023AD E0      6990 DW	SYNTAX	;STRING$
0023AE 25   
0023AF E0      6991 DW	SYNTAX	;EOF
0023B0 25   
0023B1 E0      6992 DW	SYNTAX	;SUM
0023B2 25   
0023B3 26      6993 DW	WHILE
0023B4 2E   
0023B5 57      6994 DW	CASE
0023B6 2D   
0023B7 E0      6995 DW	SYNTAX	;WHEN
0023B8 25   
0023B9 E0      6996 DW	SYNTAX	;OF
0023BA 25   
0023BB 99      6997 DW	XEQ	;ENDCASE
0023BC 24   
0023BD E0      6998 DW	SYNTAX	;OTHERWISE
0023BE 25   
0023BF 99      6999 DW	XEQ	;ENDIF
0023C0 24   
0023C1 43      7000 DW	ENDWHI	;ENDWHILE
0023C2 2E   
0023C3 01      7001 DW	PTR
0023C4 2F   
0023C5 15      7002 DW	PAGEV
0023C6 2F   
0023C7 23      7003 DW	TIMEV
0023C8 2F   
0023C9 42      7004 DW	LOMEMV
0023CA 2F   
0023CB 54      7005 DW	HIMEMV
0023CC 2F   
0023CD 31      7006 DW	SOUND
0023CE 0E   
0023CF D3      7007 DW	BPUT
0023D0 2F   
0023D1 0C      7008 DW	CALL
0023D2 30   
0023D3 4C      7009 DW	CHAIN
0023D4 24   
0023D5 96      7010 DW	CLR
0023D6 2E   
0023D7 CB      7011 DW	CLOSE
0023D8 2F   
0023D9 75      7012 DW	CLG
0023DA 0E   
0023DB 75      7013 DW	CLS
0023DC 2E   
0023DD 31      7014 DW	REM		;DATA
0023DE 25   
0023DF 31      7015 DW	REM		;DEF
0023E0 25   
0023E1 3E      7016 DW	DIM
0023E2 26   
0023E3 7C      7017 DW	DRAW
0023E4 0F   
0023E5 D3      7018 DW	END
0023E6 24   
0023E7 7D      7019 DW	ENDPRO
0023E8 2B   
0023E9 03      7020 DW	ENVEL
0023EA 0E   
0023EB 14      7021 DW	FORex
0023EC 29   
0023ED CB      7022 DW	GOSUB
0023EE 28   
0023EF B4      7023 DW	GOTO
0023F0 28   
0023F1 CD      7024 DW	GCOL
0023F2 0E   
0023F3 C9      7025 DW	IF_
0023F4 2C   
0023F5 E2      7026 DW	INPUT
0023F6 2B   
0023F7 A1      7027 DW	LET
0023F8 25   
0023F9 13      7028 DW	LOCAL
0023FA 2B   
0023FB 65      7029 DW	MODE
0023FC 0E   
0023FD 78      7030 DW	MOVE
0023FE 0F   
0023FF 61      7031 DW	NEXT
002400 29   
002401 3A      7032 DW	ON
002402 28   
002403 9C      7033 DW	VDU
002404 2F   
002405 84      7034 DW	PLOT
002406 0F   
002407 46      7035 DW	PRINT
002408 27   
002409 E7      7036 DW	PROC
00240A 29   
00240B 80      7037 DW	READ
00240C 2C   
00240D 31      7038 DW	REM
00240E 25   
00240F E5      7039 DW	REPEAT
002410 28   
002411 91      7040 DW	REPOR
002412 2E   
002413 BC      7041 DW	RESTOR
002414 2E   
002415 D6      7042 DW	RETURN
002416 28   
002417 47      7043 DW	RUN
002418 24   
002419 7E      7044 DW	STOP
00241A 2E   
00241B 8D      7045 DW	COLOUR
00241C 0E   
00241D 83      7046 DW	TRACE
00241E 2F   
00241F ED      7047 DW	UNTIL
002420 28   
002421 79      7048 DW	WIDTHV
002422 2F   
002423 08      7049 DW	CLI		;OSCLI
002424 25   
002425 31      7050 DW	REM		;NUL
002426 25   
002427 1B      7051 DW	CIRCLE
002428 0F   
002429 47      7052 DW	ELLIPS
00242A 0F   
00242B 80      7053 DW	FILL
00242C 0F   
00242D 3A      7054 DW	MOUSE
00242E 10   
00242F 7C      7055 DW	ORIGIN
002430 0E   
002431 2C      7056 DW	BYE		;QUIT
002432 0A   
002433 B9      7057 DW	RECTAN
002434 0F   
002435 5E      7058 DW	SWAPex
002436 25   
002437 11      7059 DW	SYS
002438 11   
002439 11      7060 DW	TINT
00243A 11   
00243B 79      7061 DW	WAIT
00243C 10   
00243D E0      7062 DW	SYNTAX		;INSTALL
00243E 25   
00243F 31      7063 DW	REM		;CR
002440 25   
002441 9D      7064 DW	PUT		;Token changed
002442 31   
002443 E0      7065 DW	SYNTAX		;BY
002444 25   
002445 23      7066 DW	EXITex
002446 31   
002447 CD      7072 RUN:            CALL	TERMQ
002448 36   
002449 35   
00244A 28      7073 JR	Z,RUN0
00244B 0D   
00244C CD      7074 CHAIN:          CALL	EXPRS
00244D 3C   
00244E 18   
00244F 3E      7075 LD	A,CR
002450 0D   
002451 12      7076 LD	(DE),A
002452 ED      7077 CHAIN0:         LD	SP,(HIMEM)
002453 7B   
002454 E2   
002455 54   
002456 CD      7078 CALL	LOAD0
002457 00   
002458 40   
002459 ED      7079 RUN0:           LD	SP,(HIMEM)	;PREPARE FOR RUN
00245A 7B   
00245B E2   
00245C 54   
00245D DD      7080 LD	IX,RANDOM
00245E 21   
00245F F6   
002460 54   
002461 ED      7081 RAND:           LD	A,R		;RANDOMISE (CARE!)
002462 5F   
002463 28      7082 JR	Z,RAND
002464 FC   
002465 07      7083 RLCA
002466 07      7084 RLCA
002467 DD      7085 LD	(IX+3),A
002468 77   
002469 03   
00246A 9F      7086 SBC	A,A
00246B DD      7087 LD	(IX+4),A
00246C 77   
00246D 04   
00246E CD      7088 CALL	CLEAR
00246F 43   
002470 40   
002471 21      7089 LD	HL,0
002472 00   
002473 00   
002474 22      7090 LD	(ERRTRP),HL
002475 EA   
002476 54   
002477 2A      7091 LD	HL,(PAGE_)
002478 DC   
002479 54   
00247A CD      7092 CALL	DSRCH		;LOOK FOR "DATA"
00247B F9   
00247C 35   
00247D 22      7093 LD	(DATPTR),HL	;SET DATA POINTER
00247E F0   
00247F 54   
002480 FD      7094 LD	IY,(PAGE_)
002481 2A   
002482 DC   
002483 54   
002484 CD      7095 XEQ0:           CALL	NEWLIN
002485 DB   
002486 24   
002487 FD      7096 LD	A,(IY)
002488 7E   
002489 00   
00248A FE      7097 CP	TELSE
00248B 8B   
00248C CA      7098 JP	Z,MELSE		;ELSE
00248D 30   
00248E 2D   
00248F FE      7099 CP	TWHEN
002490 C9   
002491 CA      7100 JP	Z,WHEN		;WHEN
002492 43   
002493 2D   
002494 FE      7101 CP	TOTHERWISE
002495 CC   
002496 CA      7102 JP	Z,WHEN
002497 43   
002498 2D   
002499 FD      7103 XEQ:            LD	(CURLIN),IY	;ERROR POINTER
00249A 22   
00249B F4   
00249C 54   
00249D CD      7104 CALL	TRAP		;CHECK KEYBOARD
00249E 33   
00249F 06   
0024A0 CD      7105 XEQ1:           CALL	NXT
0024A1 0B   
0024A2 45   
0024A3 FD      7106 INC	IY
0024A4 23   
0024A5 FE      7107 CP	':'		;SEPARATOR
0024A6 3A   
0024A7 28      7108 JR	Z,XEQ1
0024A8 F7   
0024A9 FE      7109 CP	CR
0024AA 0D   
0024AB 28      7110 JR	Z,XEQ0		;NEW PROGRAM LINE
0024AC D7   
0024AD FE      7111 CP	TLAST
0024AE 98   
0024AF EA      7112 JP	PE,LET0		;IMPLIED LET
0024B0 93   
0024B1 25   
0024B2 D6      7113 SUB	TCMD
0024B3 C7   
0024B4 FA      7114 JP	M,EXTRAS
0024B5 16   
0024B6 25   
0024B7 87      7115 ADD	A,A
0024B8 4F      7116 LD	C,A
0024B9 06      7117 LD	B,0
0024BA 00   
0024BB 21      7118 LD	HL,CMDTAB
0024BC A5   
0024BD 23   
0024BE 09      7119 ADD	HL,BC
0024BF 7E      7120 LD	A,(HL)		;TABLE ENTRY
0024C0 23      7121 INC	HL
0024C1 66      7122 LD	H,(HL)
0024C2 6F      7123 LD	L,A
0024C3 CD      7124 CALL	NXT
0024C4 0B   
0024C5 45   
0024C6 E9      7125 JP	(HL)		;EXECUTE STATEMENT
0024C7 FD      7129 ENDIM:          PUSH	IY
0024C8 E5   
0024C9 E1      7130 POP	HL
0024CA ED      7131 LD	BC,(PAGE_)
0024CB 4B   
0024CC DC   
0024CD 54   
0024CE ED      7132 SBC	HL,BC		;IMMEDIATE MODE ?
0024CF 42   
0024D0 DA      7133 JP	C,CLOOP
0024D1 B0   
0024D2 37   
0024D3 1E      7134 END:            LD	E,0
0024D4 00   
0024D5 CD      7135 CALL	OSSHUT		;CLOSE ALL FILES
0024D6 53   
0024D7 06   
0024D8 C3      7136 JP	WARM		;"Ready"
0024D9 AF   
0024DA 37   
0024DB FD      7138 NEWLIN:         LD	A,(IY+0)	;A=LINE LENGTH
0024DC 7E   
0024DD 00   
0024DE 01      7139 LD	BC,3
0024DF 03   
0024E0 00   
0024E1 FD      7140 ADD	IY,BC
0024E2 09   
0024E3 B7      7141 OR	A
0024E4 28      7142 JR	Z,ENDIM		;LENGTH=0, EXITex
0024E5 E1   
0024E6 2A      7143 LD	HL,(TRACEN)
0024E7 E6   
0024E8 54   
0024E9 7C      7144 LD	A,H
0024EA B5      7145 OR	L
0024EB C8      7146 RET	Z
0024EC FD      7147 LD	D,(IY-1)	;DE = LINE NUMBER
0024ED 56   
0024EE FF   
0024EF FD      7148 LD	E,(IY-2)
0024F0 5E   
0024F1 FE   
0024F2 ED      7149 SBC	HL,DE
0024F3 52   
0024F4 D8      7150 RET	C
0024F5 EB      7151 EX	DE,HL
0024F6 3E      7152 LD	A,'['		;TRACE
0024F7 5B   
0024F8 CD      7153 CALL	OUTCHR
0024F9 02   
0024FA 41   
0024FB CD      7154 CALL	PBCDL
0024FC 92   
0024FD 41   
0024FE 3E      7155 LD	A,']'
0024FF 5D   
002500 CD      7156 CALL	OUTCHR
002501 02   
002502 41   
002503 3E      7157 LD	A,' '
002504 20   
002505 C3      7158 JP	OUTCHR
002506 02   
002507 41   
002508 CD      7164 CLI:            CALL	EXPRS
002509 3C   
00250A 18   
00250B 3E      7165 LD	A,CR
00250C 0D   
00250D 12      7166 LD	(DE),A
00250E 21      7167 LD	HL,ACCS
00250F 00   
002510 52   
002511 CD      7168 CALL	OSCLI
002512 B3   
002513 09   
002514 18      7169 JR	XEQ
002515 83   
002516 FE      7171 EXTRAS:         CP	TELSE-TCMD
002517 C4   
002518 28      7172 JR	Z,REM		;ELSE
002519 17   
00251A FE      7173 CP	TERROR-TCMD
00251B BE   
00251C 28      7174 JR	Z,THROW		;ERROR
00251D 21   
00251E FE      7175 CP	TLINE-TCMD
00251F BF   
002520 CA      7176 JP	Z,LINE		;LINE
002521 05   
002522 0F   
002523 FE      7177 CP	TOFF-TCMD
002524 C0   
002525 CA      7178 JP	Z,CSROFF	;OFF
002526 EE   
002527 0E   
002528 C3      7179 JP	SYNTAX
002529 E0   
00252A 25   
00252B FD      7183 EXT:            PUSH	IY
00252C E5   
00252D E1      7184 POP	HL
00252E CD      7185 CALL	OSCLI
00252F B3   
002530 09   
002531 FD      7186 REM:            PUSH	IY
002532 E5   
002533 E1      7187 POP	HL
002534 3E      7188 LD	A,CR
002535 0D   
002536 47      7189 LD	B,A
002537 ED      7190 CPIR			;FIND LINE END
002538 B1   
002539 E5      7191 PUSH	HL
00253A FD      7192 POP	IY
00253B E1   
00253C C3      7193 JP	XEQ0
00253D 84   
00253E 24   
00253F CD      7197 THROW:          CALL	EXPRI
002540 33   
002541 18   
002542 D9      7198 EXX
002543 E5      7199 PUSH	HL
002544 D9      7200 EXX
002545 CD      7201 CALL	COMMA
002546 A2   
002547 20   
002548 CD      7202 CALL	EXPRS
002549 3C   
00254A 18   
00254B E1      7203 POP	HL
00254C AF      7204 XOR	A
00254D 12      7205 LD	(DE),A
00254E 7D      7206 LD	A,L
00254F 21      7207 LD	HL,ACCS
002550 00   
002551 52   
002552 11      7208 LD	DE,BUFFER
002553 00   
002554 53   
002555 D5      7209 PUSH	DE
002556 01      7210 LD	BC,256
002557 00   
002558 01   
002559 ED      7211 LDIR
00255A B0   
00255B C3      7212 JP	EXTERR
00255C 55   
00255D 3F   
00255E CD      7216 SWAPex:           CALL	GETVAR
00255F E3   
002560 41   
002561 20      7217 JR	NZ,SWAPNZ
002562 0B   
002563 F5      7218 PUSH	AF
002564 E5      7219 PUSH	HL
002565 CD      7220 CALL	COMMA
002566 A2   
002567 20   
002568 CD      7221 CALL	NXT
002569 0B   
00256A 45   
00256B CD      7222 CALL	GETVAR
00256C E3   
00256D 41   
00256E 20      7223 SWAPNZ:         JR	NZ,NOSUCH
00256F 6D   
002570 D1      7224 POP	DE
002571 C1      7225 POP	BC
002572 B8      7226 CP	B
002573 20      7227 JR	NZ,MISMAT
002574 74   
002575 E6      7228 AND	00001111B
002576 0F   
002577 28      7229 JR	Z,MISMAT
002578 70   
002579 78      7230 LD	A,B
00257A E6      7231 AND	11000000B
00257B C0   
00257C 28      7232 JR	Z,SWAP1ex
00257D 0A   
00257E 06      7233 LD	B,2
00257F 02   
002580 F2      7234 JP	P,SWAP1ex
002581 88   
002582 25   
002583 EA      7235 JP	PE,SWAP1ex
002584 88   
002585 25   
002586 06      7236 LD	B,4
002587 04   
002588 4E      7237 SWAP1ex:          LD	C,(HL)
002589 1A      7238 LD	A,(DE)
00258A 77      7239 LD	(HL),A
00258B 79      7240 LD	A,C
00258C 12      7241 LD	(DE),A
00258D 13      7242 INC	DE
00258E 23      7243 INC	HL
00258F 10      7244 DJNZ	SWAP1ex
002590 F7   
002591 18      7245 JR	XEQGO4
002592 28   
002593 FE      7249 LET0:           CP	'*'
002594 2A   
002595 28      7250 JR	Z,EXT
002596 94   
002597 FE      7251 CP	'='
002598 3D   
002599 28      7252 JR	Z,FNEND
00259A 71   
00259B FE      7253 CP	'['
00259C 5B   
00259D 28      7254 JR	Z,ASM
00259E 52   
00259F FD      7255 DEC	IY
0025A0 2B   
0025A1 CD      7256 LET:            CALL	ASSIGN
0025A2 AF   
0025A3 31   
0025A4 CA      7257 JP	Z,XEQ
0025A5 99   
0025A6 24   
0025A7 38      7258 JR	C,SYNTAX	;"Syntax error"
0025A8 37   
0025A9 F2      7259 JP	P,LETARR	;Numeric array
0025AA FB   
0025AB 20   
0025AC EA      7260 JP	PE,LETARR	;String array
0025AD FB   
0025AE 20   
0025AF 7A      7261 LD	A,D		;Type
0025B0 D5      7262 PUSH	DE
0025B1 E5      7263 PUSH	HL
0025B2 CD      7264 CALL	EXPRS
0025B3 3C   
0025B4 18   
0025B5 DD      7265 POP	IX
0025B6 E1   
0025B7 E1      7266 POP	HL
0025B8 CD      7267 CALL	MODIFS
0025B9 18   
0025BA 32   
0025BB C3      7268 XEQGO4:         JP	XEQ
0025BC 99   
0025BD 24   
0025BE CD      7275 GETSTR:         CALL	GETVAR
0025BF E3   
0025C0 41   
0025C1 20      7276 JR	NZ,NOSUCH
0025C2 1A   
0025C3 47      7277 LD	B,A
0025C4 E6      7278 AND	11000000B
0025C5 C0   
0025C6 F2      7279 JP	P,MISMAT
0025C7 E9   
0025C8 25   
0025C9 EA      7280 JP	PE,BADUSE
0025CA E6   
0025CB 25   
0025CC CB      7281 BIT	0,B
0025CD 40   
0025CE 28      7282 JR	Z,MISMAT
0025CF 19   
0025D0 CD      7283 CALL	NXT
0025D1 0B   
0025D2 45   
0025D3 FE      7284 CP	','
0025D4 2C   
0025D5 C9      7285 RET
0025D6 CD      7287 VAR_:           CALL	GETVAR
0025D7 E3   
0025D8 41   
0025D9 C8      7288 RET	Z
0025DA D2      7289 JP	NC,PUTVAR
0025DB CD   
0025DC 41   
0025DD 3E      7290 NOSUCH:         LD	A,26		;'No such variable'
0025DE 1A   
0025DF 21      7291 DB	21H
0025E0 3E      7292 SYNTAX:         LD	A,16		;"Syntax error"
0025E1 10   
0025E2 21      7293 DB	21H
0025E3 3E      7294 ESCAPE:         LD	A,17		;"Escape"
0025E4 11   
0025E5 21      7295 DB	21H
0025E6 3E      7296 BADUSE:         LD	A,14		;'Bad use of array'
0025E7 0E   
0025E8 21      7297 DB	21H
0025E9 3E      7298 MISMAT:         LD	A,6		;'Type mismatch'
0025EA 06   
0025EB C3      7299 ERROR0ex:         JP	ERROR_
0025EC 44   
0025ED 3F   
0025EE CD      7301 ASM0:           CALL	NEWLIN
0025EF DB   
0025F0 24   
0025F1 FD      7302 ASM:            LD	(CURLIN),IY
0025F2 22   
0025F3 F4   
0025F4 54   
0025F5 CD      7303 CALL	TRAP
0025F6 33   
0025F7 06   
0025F8 CD      7304 CALL	ASSEM
0025F9 1B   
0025FA 11   
0025FB 38      7305 JR	C,SYNTAX
0025FC E3   
0025FD FE      7306 CP	CR
0025FE 0D   
0025FF 28      7307 JR	Z,ASM0
002600 ED   
002601 21      7308 LD	HL,LISTON
002602 FE   
002603 54   
002604 7E      7309 LD	A,(HL)
002605 E6      7310 AND	0FH
002606 0F   
002607 F6      7311 OR	30H
002608 30   
002609 77      7312 LD	(HL),A
00260A 18      7313 JR	XEQGO4
00260B AF   
00260C CD      7317 FNEND:          CALL	EXPR		;FUNCTION RESULT
00260D 02   
00260E 17   
00260F 08      7318 EX	AF,AF'
002610 87      7319 ADD	A,A
002611 7B      7320 LD	A,E
002612 38      7321 JR	C,FNEND1
002613 01   
002614 79      7322 LD	A,C
002615 08      7323 FNEND1:         EX	AF,AF'
002616 E5      7324 PUSH	HL
002617 D9      7325 EXX
002618 C1      7326 POP	BC
002619 EB      7327 EX	DE,HL		;SAVE RESULT IN A'B'C'D'E'
00261A D9      7328 EXX
00261B C1      7329 FNEND2:         POP	BC
00261C 21      7330 LD	HL,FNCHK
00261D E7   
00261E 29   
00261F AF      7331 XOR	A
002620 ED      7332 SBC	HL,BC
002621 42   
002622 28      7333 JR	Z,FNEND3
002623 0A   
002624 C5      7334 PUSH	BC
002625 CD      7335 CALL	RESLOC
002626 31   
002627 34   
002628 20      7336 JR	NZ,FNEND2
002629 F1   
00262A 3E      7337 LD	A,7
00262B 07   
00262C 18      7338 JR	ERROR0ex		;"No FN"
00262D BD   
00262E FD      7340 FNEND3:         POP	IY
00262F E1   
002630 FD      7341 LD	(CURLIN),IY	;IN CASE OF ERROR
002631 22   
002632 F4   
002633 54   
002634 D9      7342 EXX
002635 EB      7343 EX	DE,HL
002636 C5      7344 PUSH	BC
002637 D9      7345 EXX
002638 E1      7346 POP	HL
002639 08      7347 EX	AF,AF'
00263A 5F      7348 LD	E,A
00263B 4F      7349 LD	C,A
00263C 1F      7350 RRA
00263D C9      7351 RET
00263E FD      7356 DIM:            PUSH	IY
00263F E5   
002640 FE      7357 CP	'!'
002641 21   
002642 CA      7358 JP	Z,DIM4
002643 0F   
002644 27   
002645 CD      7359 CALL	LOCATE		;VARIABLE
002646 B0   
002647 42   
002648 DA      7360 JP	C,BADDIM
002649 F9   
00264A 26   
00264B C4      7361 CALL	NZ,CREATE
00264C 3C   
00264D 43   
00264E FD      7362 LD	A,(IY)
00264F 7E   
002650 00   
002651 FE      7363 CP	'('
002652 28   
002653 C2      7364 JP	NZ,DIM4
002654 0F   
002655 27   
002656 E5      7365 PUSH	HL
002657 DD      7366 POP	IX
002658 E1   
002659 7E      7367 LD	A,(HL)
00265A E6      7368 AND	0FEH
00265B FE   
00265C 23      7369 INC	HL
00265D B6      7370 OR	(HL)
00265E C2      7371 JP	NZ,DIM4
00265F 0F   
002660 27   
002661 C1      7372 POP	BC		;LEVEL STACK
002662 7A      7373 LD	A,D
002663 2A      7374 LD	HL,(FREE)
002664 E0   
002665 54   
002666 E5      7375 PUSH	HL
002667 DD      7376 EX	(SP),IX
002668 E3   
002669 E5      7377 PUSH	HL
00266A F5      7378 PUSH	AF		;SAVE TYPE
00266B 11      7379 LD	DE,1
00266C 01   
00266D 00   
00266E 42      7380 LD	B,D		;DIMENSION COUNTER
00266F FD      7381 DIM1:           INC	IY
002670 23   
002671 C5      7382 PUSH	BC
002672 D5      7383 PUSH	DE
002673 DD      7384 PUSH	IX
002674 E5   
002675 CD      7385 CALL	EXPRI		;DIMENSION SIZE
002676 33   
002677 18   
002678 CB      7386 BIT	7,H
002679 7C   
00267A 20      7387 JR	NZ,BADDIM
00267B 7D   
00267C D9      7388 EXX
00267D 23      7389 INC	HL
00267E DD      7390 POP	IX
00267F E1   
002680 DD      7391 INC	IX
002681 23   
002682 DD      7392 LD	(IX),L		;SAVE SIZE
002683 75   
002684 00   
002685 DD      7393 INC	IX
002686 23   
002687 DD      7394 LD	(IX),H
002688 74   
002689 00   
00268A C1      7395 POP	BC
00268B CD      7396 CALL	MUL16		;HL=HL*BC
00268C BD   
00268D 36   
00268E 38      7397 JR	C,NOROOM	;TOO LARGE
00268F 6C   
002690 EB      7398 EX	DE,HL		;DE=PRODUCT
002691 C1      7399 POP	BC
002692 04      7400 INC	B		;DIMENSION COUNTER
002693 FD      7401 LD	A,(IY)
002694 7E   
002695 00   
002696 FE      7402 CP	','		;ANOTHER
002697 2C   
002698 28      7403 JR	Z,DIM1
002699 D5   
00269A DD      7404 INC	IX
00269B 23   
00269C CD      7405 CALL	BRAKET		;CLOSING BRACKET
00269D AE   
00269E 20   
00269F F1      7406 POP	AF		;RESTORE TYPE
0026A0 CD      7407 CALL	X14OR5		;DE=DE*n
0026A1 AD   
0026A2 36   
0026A3 38      7408 JR	C,NOROOM
0026A4 57   
0026A5 E1      7409 POP	HL
0026A6 70      7410 LD	(HL),B		;NO. OF DIMENSIONS
0026A7 DD      7411 EX	(SP),IX
0026A8 E3   
0026A9 E1      7412 POP	HL
0026AA E6      7413 AND	80H
0026AB 80   
0026AC DD      7414 OR	(IX)		;FLAGS
0026AD B6   
0026AE 00   
0026AF E5      7422 DIM3:           PUSH	HL
0026B0 24      7423 INC	H		;Safety margin
0026B1 19      7424 ADD	HL,DE
0026B2 38      7425 JR	C,NOROOM
0026B3 48   
0026B4 ED      7426 SBC	HL,SP
0026B5 72   
0026B6 30      7427 JR	NC,NOROOM
0026B7 44   
0026B8 E1      7428 POP	HL
0026B9 E5      7429 PUSH	HL
0026BA ED      7430 LD	BC,(FREE)
0026BB 4B   
0026BC E0   
0026BD 54   
0026BE B7      7431 OR	A
0026BF ED      7432 SBC	HL,BC
0026C0 42   
0026C1 44      7433 LD	B,H
0026C2 4D      7434 LD	C,L
0026C3 E1      7435 POP	HL
0026C4 ED      7436 SBC	HL,BC
0026C5 42   
0026C6 CB      7437 BIT	0,A
0026C7 47   
0026C8 28      7438 JR	Z,ARRCHK	;NOT LOCAL
0026C9 12   
0026CA 21      7439 LD	HL,0
0026CB 00   
0026CC 00   
0026CD ED      7440 SBC	HL,DE
0026CE 52   
0026CF B7      7441 OR	A
0026D0 ED      7442 SBC	HL,BC
0026D1 42   
0026D2 39      7443 ADD	HL,SP
0026D3 28      7444 JR	Z,ARRCHK	;RESERVE NOTHING
0026D4 07   
0026D5 F9      7445 LD	SP,HL
0026D6 D5      7446 PUSH	DE
0026D7 C5      7447 PUSH	BC
0026D8 F5      7448 PUSH	AF
0026D9 CD      7449 CALL	ARRCHK
0026DA DC   
0026DB 26   
0026DC DD      7450 ARRCHK:         LD	(IX+0),L	;SAVE POINTER
0026DD 75   
0026DE 00   
0026DF DD      7451 LD	(IX+1),H
0026E0 74   
0026E1 01   
0026E2 78      7452 LD	A,B
0026E3 B1      7453 OR	C
0026E4 28      7454 JR	Z,DIM2
0026E5 09   
0026E6 D5      7455 PUSH	DE
0026E7 EB      7456 EX	DE,HL
0026E8 2A      7457 LD	HL,(FREE)
0026E9 E0   
0026EA 54   
0026EB ED      7458 LDIR			;COPY DESCRIPTOR
0026EC B0   
0026ED EB      7459 EX	DE,HL
0026EE D1      7460 POP	DE
0026EF 7A      7461 DIM2:           LD	A,D
0026F0 B3      7462 OR	E
0026F1 28      7463 JR	Z,DIM5
0026F2 0E   
0026F3 36      7464 LD	(HL),0		;INITIALISE ARRAY
0026F4 00   
0026F5 23      7465 INC	HL
0026F6 1B      7466 DEC	DE
0026F7 18      7467 JR	DIM2
0026F8 F6   
0026F9 3E      7469 BADDIM:         LD	A,10		;"Bad DIM"
0026FA 0A   
0026FB 21      7470 DB	21H
0026FC 3E      7471 NOROOM:         LD	A,11		;"DIM space"
0026FD 0B   
0026FE C3      7472 ERROR1ex:         JP	ERROR_
0026FF 44   
002700 3F   
002701 ED      7474 DIM5:           SBC	HL,SP
002702 72   
002703 30      7475 JR	NC,DIM7		;LOCAL
002704 04   
002705 39      7476 ADD	HL,SP
002706 22      7477 LD	(FREE),HL
002707 E0   
002708 54   
002709 CD      7478 DIM7:           CALL	NLIST		;ANOTHER VARIABLE?
00270A 00   
00270B 45   
00270C C3      7479 JP	DIM
00270D 3E   
00270E 26   
00270F FD      7481 DIM4:           POP	IY
002710 E1   
002711 CD      7482 CALL	VAR_
002712 D6   
002713 25   
002714 B7      7483 OR	A
002715 28      7484 JR	Z,BADDIM
002716 E2   
002717 FA      7485 JP	M,BADDIM
002718 F9   
002719 26   
00271A CB      7486 BIT	6,A
00271B 77   
00271C 20      7487 JR	NZ,BADDIM
00271D DB   
00271E 47      7488 LD	B,A		;TYPE
00271F CD      7489 CALL	NXT
002720 0B   
002721 45   
002722 FE      7490 CP	TLOCAL
002723 EA   
002724 3E      7491 LD	A,0		;PRESET TO NOT LOCAL
002725 00   
002726 20      7492 JR	NZ,DIM8
002727 03   
002728 FD      7493 INC	IY
002729 23   
00272A 3C      7494 INC	A		;FLAG LOCAL
00272B F5      7495 DIM8:           PUSH	AF
00272C 78      7496 LD	A,B		;TYPE
00272D D9      7497 EXX
00272E 21      7498 LD	HL,0
00272F 00   
002730 00   
002731 4C      7499 LD	C,H
002732 CD      7500 CALL	STOREN		;RESERVED AREA
002733 F0   
002734 31   
002735 DD      7501 PUSH	IX
002736 E5   
002737 CD      7502 CALL	EXPRI
002738 33   
002739 18   
00273A DD      7503 POP	IX
00273B E1   
00273C D9      7504 EXX
00273D 23      7505 INC	HL
00273E EB      7506 EX	DE,HL
00273F 2A      7507 LD	HL,(FREE)
002740 E0   
002741 54   
002742 F1      7508 POP	AF		;LOCAL FLAG
002743 C3      7509 JP	DIM3
002744 AF   
002745 26   
002746 FE      7514 PRINT:          CP	'#'
002747 23   
002748 20      7515 JR	NZ,PRINT0
002749 64   
00274A CD      7516 CALL	CHNL		;CHANNEL NO. = E
00274B DB   
00274C 36   
00274D CD      7517 PRNTN1:         CALL	NLIST
00274E 00   
00274F 45   
002750 D5      7518 PUSH	DE
002751 CD      7519 CALL	EXPR		;ITEM TO PRINT
002752 02   
002753 17   
002754 08      7520 EX	AF,AF'
002755 FA      7521 JP	M,PRNTN2	;STRING
002756 75   
002757 27   
002758 D1      7522 POP	DE
002759 C5      7523 PUSH	BC
00275A D9      7524 EXX
00275B 7D      7525 LD	A,L
00275C D9      7526 EXX
00275D CD      7527 CALL	OSBPUT
00275E 63   
00275F 06   
002760 D9      7528 EXX
002761 7C      7529 LD	A,H
002762 D9      7530 EXX
002763 CD      7531 CALL	OSBPUT
002764 63   
002765 06   
002766 7D      7532 LD	A,L
002767 CD      7533 CALL	OSBPUT
002768 63   
002769 06   
00276A 7C      7534 LD	A,H
00276B CD      7535 CALL	OSBPUT
00276C 63   
00276D 06   
00276E C1      7536 POP	BC
00276F 79      7537 LD	A,C
002770 CD      7538 CALL	OSBPUT
002771 63   
002772 06   
002773 18      7539 JR	PRNTN1
002774 D8   
002775 4B      7540 PRNTN2:         LD	C,E
002776 D1      7541 POP	DE
002777 21      7542 LD	HL,ACCS
002778 00   
002779 52   
00277A 0C      7543 INC	C
00277B 0D      7544 PRNTN3:         DEC	C
00277C 28      7545 JR	Z,PRNTN4
00277D 09   
00277E 7E      7546 LD	A,(HL)
00277F 23      7547 INC	HL
002780 C5      7548 PUSH	BC
002781 CD      7549 CALL	OSBPUT
002782 63   
002783 06   
002784 C1      7550 POP	BC
002785 18      7551 JR	PRNTN3
002786 F4   
002787 3E      7552 PRNTN4:         LD	A,CR
002788 0D   
002789 CD      7553 CALL	OSBPUT
00278A 63   
00278B 06   
00278C 18      7554 JR	PRNTN1
00278D BF   
00278E 06      7556 PRINT6:         LD	B,2
00278F 02   
002790 18      7557 JR	PRINTC
002791 22   
002792 01      7558 PRINT8:         LD	BC,100H
002793 00   
002794 01   
002795 18      7559 JR	PRINTC
002796 1D   
002797 21      7560 PRINT9:         LD	HL,STAVAR
002798 00   
002799 54   
00279A AF      7561 XOR	A
00279B BE      7562 CP	(HL)
00279C 28      7563 JR	Z,PRINT0
00279D 10   
00279E 3A      7564 LD	A,(COUNT)
00279F FB   
0027A0 54   
0027A1 B7      7565 OR	A
0027A2 28      7566 JR	Z,PRINT0
0027A3 0A   
0027A4 96      7567 PRINTA:         SUB	(HL)
0027A5 28      7568 JR	Z,PRINT0
0027A6 07   
0027A7 30      7569 JR	NC,PRINTA
0027A8 FB   
0027A9 ED      7570 NEG
0027AA 44   
0027AB CD      7571 CALL	SPACES
0027AC A3   
0027AD 35   
0027AE 3A      7572 PRINT0:         LD	A,(STAVAR)
0027AF 00   
0027B0 54   
0027B1 4F      7573 LD	C,A		;PRINTS
0027B2 06      7574 LD	B,0		;PRINTF
0027B3 00   
0027B4 CD      7575 PRINTC:         CALL	TERMQ
0027B5 36   
0027B6 35   
0027B7 28      7576 JR	Z,PRINT4
0027B8 38   
0027B9 CB      7577 RES	0,B
0027BA 80   
0027BB FD      7578 INC	IY
0027BC 23   
0027BD FE      7579 CP	'~'
0027BE 7E   
0027BF 28      7580 JR	Z,PRINT6
0027C0 CD   
0027C1 FE      7581 CP	';'
0027C2 3B   
0027C3 28      7582 JR	Z,PRINT8
0027C4 CD   
0027C5 FE      7583 CP	','
0027C6 2C   
0027C7 28      7584 JR	Z,PRINT9
0027C8 CE   
0027C9 CD      7585 CALL	FORMAT		;SPC, TAB, '
0027CA 5C   
0027CB 35   
0027CC 28      7586 JR	Z,PRINTC
0027CD E6   
0027CE FD      7587 DEC	IY
0027CF 2B   
0027D0 C5      7588 PUSH	BC
0027D1 CD      7589 CALL	EXPR		;VARIABLE TYPE
0027D2 02   
0027D3 17   
0027D4 08      7590 EX	AF,AF'
0027D5 FA      7591 JP	M,PRINT3	;STRING
0027D6 EB   
0027D7 27   
0027D8 D1      7592 POP	DE
0027D9 D5      7593 PUSH	DE
0027DA CB      7594 BIT	1,D
0027DB 4A   
0027DC F5      7595 PUSH	AF
0027DD CC      7596 CALL	Z,STR		;DECIMAL
0027DE D0   
0027DF 1F   
0027E0 F1      7597 POP	AF
0027E1 C4      7598 CALL	NZ,HEXSTR	;HEX
0027E2 8D   
0027E3 1F   
0027E4 C1      7599 POP	BC
0027E5 C5      7600 PUSH	BC
0027E6 79      7601 LD	A,C
0027E7 93      7602 SUB	E
0027E8 D4      7603 CALL	NC,SPACES		;RIGHT JUSTIFY
0027E9 A3   
0027EA 35   
0027EB C1      7604 PRINT3:         POP	BC
0027EC CD      7605 CALL	PTEXT		;PRINT
0027ED B1   
0027EE 35   
0027EF 18      7606 JR	PRINTC
0027F0 C3   
0027F1 CB      7607 PRINT4:         BIT	0,B
0027F2 40   
0027F3 CC      7608 CALL	Z,CRLF
0027F4 FB   
0027F5 40   
0027F6 18      7609 JR	XEQGO3
0027F7 3F   
0027F8 FD      7611 ONERR:          INC	IY		;SKIP "ERROR"
0027F9 23   
0027FA CD      7612 CALL	NXT
0027FB 0B   
0027FC 45   
0027FD 21      7613 LD	HL,0		;FLAG NOT LOCAL
0027FE 00   
0027FF 00   
002800 FE      7614 CP	TLOCAL
002801 EA   
002802 20      7615 JR	NZ,ONERR1
002803 1D   
002804 FD      7616 INC	IY		;SKIP "LOCAL"
002805 23   
002806 2A      7617 LD	HL,(ERRTRP)
002807 EA   
002808 54   
002809 E5      7618 PUSH	HL
00280A 2A      7619 LD	HL,(ONERSP)
00280B EC   
00280C 54   
00280D E5      7620 PUSH	HL
00280E 21      7621 LD	HL,400H		;TYPE = 4, 'EXPONENT' = 0
00280F 00   
002810 04   
002811 E5      7622 PUSH	HL
002812 21      7623 LD	HL,ERRTRP
002813 EA   
002814 54   
002815 E5      7624 PUSH	HL
002816 21      7625 LD	HL,LOCCHK
002817 2A   
002818 35   
002819 E5      7626 PUSH	HL
00281A 21      7627 LD	HL,0
00281B 00   
00281C 00   
00281D 39      7628 ADD	HL,SP
00281E CD      7629 CALL	NXT
00281F 0B   
002820 45   
002821 22      7630 ONERR1:         LD	(ONERSP),HL
002822 EC   
002823 54   
002824 FD      7631 LD	(ERRTRP),IY
002825 22   
002826 EA   
002827 54   
002828 FE      7632 CP	TOFF
002829 87   
00282A C2      7633 JP	NZ,REM
00282B 31   
00282C 25   
00282D FD      7634 INC	IY		;SKIP "OFF"
00282E 23   
00282F ED      7635 SBC	HL,HL
002830 62   
002831 22      7636 LD	(ONERSP),HL
002832 EC   
002833 54   
002834 22      7637 LD	(ERRTRP),HL
002835 EA   
002836 54   
002837 C3      7638 XEQGO3:         JP	XEQ
002838 99   
002839 24   
00283A CD      7648 ON:             CALL	TERMQ
00283B 36   
00283C 35   
00283D CA      7649 JP	Z,CSRON
00283E EA   
00283F 0E   
002840 FE      7650 CP	TERROR
002841 85   
002842 28      7651 JR	Z,ONERR		;"ON ERROR"
002843 B4   
002844 CD      7652 CALL	EXPRI
002845 33   
002846 18   
002847 FD      7653 LD	A,(IY)
002848 7E   
002849 00   
00284A FD      7654 INC	IY
00284B 23   
00284C 1E      7655 LD	E,','		;SEPARATOR
00284D 2C   
00284E FE      7656 CP	TGOTO
00284F E5   
002850 28      7657 JR	Z,ON1
002851 0B   
002852 FE      7658 CP	TGOSUB
002853 E4   
002854 28      7659 JR	Z,ON1
002855 07   
002856 1E      7660 LD	E,TPROC
002857 F2   
002858 BB      7661 CP	E
002859 3E      7662 LD	A,39
00285A 27   
00285B 20      7663 JR	NZ,ERROR2ex	;"ON syntax"
00285C 4F   
00285D 57      7664 ON1:            LD	D,A
00285E D9      7665 EXX
00285F E5      7666 PUSH	HL
002860 D9      7667 EXX
002861 C1      7668 POP	BC		;ON INDEX
002862 78      7669 LD	A,B
002863 B4      7670 OR	H
002864 B5      7671 OR	L
002865 20      7672 JR	NZ,ON4		;OUT OF RANGE
002866 32   
002867 B1      7673 OR	C
002868 28      7674 JR	Z,ON4
002869 2F   
00286A 0D      7675 DEC	C
00286B 28      7676 JR	Z,ON3		;INDEX=1
00286C 11   
00286D CD      7677 ON2:            CALL	TERMQ
00286E 36   
00286F 35   
002870 28      7678 JR	Z,ON4		;OUT OF RANGE
002871 27   
002872 FD      7679 INC	IY		;SKIP DELIMITER
002873 23   
002874 FE      7680 CP	'"'
002875 22   
002876 28      7681 JR	Z,ON5
002877 1A   
002878 BB      7682 CP	E
002879 20      7683 JR	NZ,ON2
00287A F2   
00287B 0D      7684 DEC	C
00287C 20      7685 JR	NZ,ON2
00287D EF   
00287E 7B      7686 ON3:            LD	A,E
00287F FE      7687 CP	TPROC
002880 F2   
002881 28      7688 JR	Z,ONPROC
002882 2C   
002883 D5      7689 PUSH	DE
002884 CD      7690 CALL	ITEMI		;LINE NUMBER
002885 60   
002886 18   
002887 D1      7691 POP	DE
002888 7A      7692 LD	A,D
002889 FE      7693 CP	TGOTO
00288A E5   
00288B 28      7694 JR	Z,GOTO2
00288C 30   
00288D CD      7695 CALL	SPAN		;SKIP REST OF LIST
00288E 42   
00288F 35   
002890 18      7696 JR	GOSUB1
002891 3C   
002892 CD      7698 ON5:            CALL	QUOTE
002893 99   
002894 36   
002895 FD      7699 INC	IY
002896 23   
002897 18      7700 JR	ON2
002898 D4   
002899 FD      7702 ON4:            LD	A,(IY)
00289A 7E   
00289B 00   
00289C FD      7703 INC	IY
00289D 23   
00289E FE      7704 CP	TELSE
00289F 8B   
0028A0 CA      7705 JP	Z,IF1		;ELSE CLAUSE
0028A1 E2   
0028A2 2C   
0028A3 FE      7706 CP	CR
0028A4 0D   
0028A5 20      7707 JR	NZ,ON4
0028A6 F2   
0028A7 3E      7708 LD	A,40		;'ON range'
0028A8 28   
0028A9 21      7709 DB	21H
0028AA 3E      7710 FORVAR:         LD	A,34		;'FOR variable'
0028AB 22   
0028AC C3      7711 ERROR2ex:         JP	ERROR_
0028AD 44   
0028AE 3F   
0028AF 3E      7713 ONPROC:         LD	A,TON
0028B0 EE   
0028B1 C3      7714 JP	PROC
0028B2 E7   
0028B3 29   
0028B4 CD      7718 GOTO:           CALL	ITEMI		;LINE NUMBER
0028B5 60   
0028B6 18   
0028B7 CD      7719 GOTO1:          CALL	TERMQ
0028B8 36   
0028B9 35   
0028BA C2      7720 JP	NZ,SYNTAX
0028BB E0   
0028BC 25   
0028BD D9      7721 GOTO2:          EXX
0028BE CD      7722 CALL	FINDL
0028BF 43   
0028C0 41   
0028C1 E5      7723 PUSH	HL
0028C2 FD      7724 POP	IY
0028C3 E1   
0028C4 CA      7725 JP	Z,XEQ0
0028C5 84   
0028C6 24   
0028C7 3E      7726 LD	A,41
0028C8 29   
0028C9 18      7727 JR	ERROR2ex		;"No such line"
0028CA E1   
0028CB CD      7731 GOSUB:          CALL	ITEMI		;LINE NUMBER
0028CC 60   
0028CD 18   
0028CE FD      7732 GOSUB1:         PUSH	IY		;TEXT POINTER
0028CF E5   
0028D0 CD      7733 CALL	CHECK		;CHECK ROOM
0028D1 86   
0028D2 32   
0028D3 CD      7734 CALL	GOTO1		;SAVE MARKER
0028D4 B7   
0028D5 28   
0028D6 D1      7739 RETURN:         POP	DE		;MARKER
0028D7 21      7740 LD	HL,GOSCHK
0028D8 D6   
0028D9 28   
0028DA B7      7741 OR	A
0028DB ED      7742 SBC	HL,DE
0028DC 52   
0028DD FD      7743 POP	IY
0028DE E1   
0028DF 28      7744 JR	Z,XEQGO2ex
0028E0 30   
0028E1 3E      7745 LD	A,38
0028E2 26   
0028E3 18      7746 JR	ERROR2ex		;"No GOSUB"
0028E4 C7   
0028E5 FD      7750 REPEAT:         PUSH	IY
0028E6 E5   
0028E7 CD      7751 CALL	CHECK
0028E8 86   
0028E9 32   
0028EA CD      7752 CALL	XEQ
0028EB 99   
0028EC 24   
0028ED C1      7757 UNTIL:          POP	BC
0028EE C5      7758 PUSH	BC
0028EF 21      7759 LD	HL,REPCHK
0028F0 ED   
0028F1 28   
0028F2 B7      7760 OR	A
0028F3 ED      7761 SBC	HL,BC
0028F4 42   
0028F5 28      7762 JR	Z,UNTIL1
0028F6 0B   
0028F7 3E      7763 LD	A,3
0028F8 03   
0028F9 CD      7764 CALL	RESLOC
0028FA 31   
0028FB 34   
0028FC 20      7765 JR	NZ,UNTIL
0028FD EF   
0028FE 3E      7766 LD	A,43
0028FF 2B   
002900 18      7767 JR	ERROR2ex		;"Not in a REPEAT loop"
002901 AA   
002902 CD      7769 UNTIL1:         CALL	EXPRI
002903 33   
002904 18   
002905 CD      7770 CALL	TEST
002906 59   
002907 1F   
002908 C1      7771 POP	BC
002909 D1      7772 POP	DE
00290A 20      7773 JR	NZ,XEQGO2ex		;TRUE
00290B 05   
00290C D5      7774 PUSH	DE
00290D C5      7775 PUSH	BC
00290E D5      7776 PUSH	DE
00290F FD      7777 POP	IY
002910 E1   
002911 C3      7778 XEQGO2ex:         JP	XEQ
002912 99   
002913 24   
002914 CD      7782 FORex:            CALL	ASSIGN
002915 AF   
002916 31   
002917 20      7783 JR	NZ,FORVAR	;"FOR variable"
002918 91   
002919 F5      7784 PUSH	AF		;SAVE TYPE
00291A FD      7785 LD	A,(IY)
00291B 7E   
00291C 00   
00291D FE      7786 CP	TTO
00291E B8   
00291F 3E      7787 LD	A,36
002920 24   
002921 20      7788 JR	NZ,ERROR2ex	;"No TO"
002922 89   
002923 FD      7789 INC	IY
002924 23   
002925 DD      7790 PUSH	IX
002926 E5   
002927 CD      7791 CALL	EXPRN		;LIMIT
002928 2C   
002929 18   
00292A DD      7792 POP	IX
00292B E1   
00292C F1      7793 POP	AF
00292D 47      7794 LD	B,A		;TYPE
00292E C5      7795 PUSH	BC		;SAVE ON STACK
00292F E5      7796 PUSH	HL
002930 21      7797 LD	HL,0
002931 00   
002932 00   
002933 4C      7798 LD	C,H
002934 D9      7799 EXX
002935 E5      7800 PUSH	HL
002936 21      7801 LD	HL,1		;PRESET STEP
002937 01   
002938 00   
002939 D9      7802 EXX
00293A FD      7803 LD	A,(IY)
00293B 7E   
00293C 00   
00293D FE      7804 CP	TSTEP
00293E 88   
00293F 20      7805 JR	NZ,FOR1
002940 09   
002941 FD      7806 INC	IY
002942 23   
002943 DD      7807 PUSH	IX
002944 E5   
002945 CD      7808 CALL	EXPRN		;STEP
002946 2C   
002947 18   
002948 DD      7809 POP	IX
002949 E1   
00294A 06      7810 FOR1:           LD	B,8		;FPP '>'
00294B 08   
00294C CB      7811 BIT	7,H
00294D 7C   
00294E 20      7812 JR	NZ,FOR2		;STEP SIGN
00294F 02   
002950 06      7813 LD	B,12		;FPP '<'
002951 0C   
002952 C5      7814 FOR2:           PUSH	BC
002953 E5      7815 PUSH	HL
002954 D9      7816 EXX
002955 E5      7817 PUSH	HL
002956 D9      7818 EXX
002957 FD      7819 PUSH	IY		;SAVE TEXT POINTER
002958 E5   
002959 DD      7820 PUSH	IX		;LOOP VARIABLE
00295A E5   
00295B CD      7821 CALL	CHECK
00295C 86   
00295D 32   
00295E CD      7822 CALL	XEQ
00295F 99   
002960 24   
002961 C1      7827 NEXT:           POP	BC		;MARKER
002962 21      7828 LD	HL,FORCHK
002963 61   
002964 29   
002965 B7      7829 OR	A
002966 ED      7830 SBC	HL,BC
002967 42   
002968 28      7831 JR	Z,NEXT2
002969 0C   
00296A C5      7832 PUSH	BC
00296B 3E      7833 LD	A,3
00296C 03   
00296D CD      7834 CALL	RESLOC
00296E 31   
00296F 34   
002970 20      7835 JR	NZ,NEXT
002971 EF   
002972 3E      7836 LD	A,32
002973 20   
002974 18      7837 JR	ERROR3ex		;"Not in a FOR loop"
002975 6A   
002976 CD      7839 NEXT2:          CALL	TERMQ
002977 36   
002978 35   
002979 E1      7840 POP	HL
00297A E5      7841 PUSH	HL
00297B C5      7842 PUSH	BC
00297C E5      7843 PUSH	HL
00297D C4      7844 CALL	NZ,GETVAR	;VARIABLE
00297E E3   
00297F 41   
002980 D1      7845 POP	DE
002981 EB      7846 EX	DE,HL
002982 B7      7847 OR	A
002983 ED      7848 NEXT0:          SBC	HL,DE
002984 52   
002985 20      7849 JR	NZ,NEXT1
002986 47   
002987 D5      7850 PUSH	DE
002988 DD      7851 LD	IX,6+2
002989 21   
00298A 08   
00298B 00   
00298C DD      7852 ADD	IX,SP
00298D 39   
00298E CD      7853 CALL	DLOAD5		;STEP
00298F F1   
002990 19   
002991 DD      7854 LD	A,(IX+11)	;TYPE
002992 7E   
002993 0B   
002994 DD      7855 POP	IX
002995 E1   
002996 CD      7856 CALL	LOADN		;LOOP VARIABLE
002997 25   
002998 19   
002999 F5      7857 PUSH	AF
00299A 3E      7858 LD	A,'+' & 0FH
00299B 0B   
00299C CD      7859 CALL	FPP		;ADD STEP
00299D 15   
00299E 45   
00299F 38      7860 JR	C,ERROR3ex
0029A0 3F   
0029A1 F1      7861 POP	AF		;RESTORE TYPE
0029A2 CD      7862 CALL	STOREN		;UPDATE VARIABLE
0029A3 F0   
0029A4 31   
0029A5 DD      7863 LD	IX,12
0029A6 21   
0029A7 0C   
0029A8 00   
0029A9 DD      7864 ADD	IX,SP
0029AA 39   
0029AB CD      7865 CALL	DLOAD5		;LIMIT
0029AC F1   
0029AD 19   
0029AE DD      7866 LD	A,(IX-1)
0029AF 7E   
0029B0 FF   
0029B1 CD      7867 CALL	FPP		;TEST AGAINST LIMIT
0029B2 15   
0029B3 45   
0029B4 38      7868 JR	C,ERROR3ex
0029B5 2A   
0029B6 24      7869 INC	H
0029B7 20      7870 JR	NZ,LOOP		;KEEP LOOPING
0029B8 0A   
0029B9 21      7871 LD	HL,18
0029BA 12   
0029BB 00   
0029BC 39      7872 ADD	HL,SP
0029BD F9      7873 LD	SP,HL
0029BE CD      7874 CALL	NLIST
0029BF 00   
0029C0 45   
0029C1 18      7875 JR	NEXT
0029C2 9E   
0029C3 C1      7877 LOOP:           POP	BC
0029C4 D1      7878 POP	DE
0029C5 FD      7879 POP	IY
0029C6 E1   
0029C7 FD      7880 PUSH	IY
0029C8 E5   
0029C9 D5      7881 PUSH	DE
0029CA C5      7882 PUSH	BC
0029CB C3      7883 JP	XEQ
0029CC 99   
0029CD 24   
0029CE 21      7885 NEXT1:          LD	HL,18
0029CF 12   
0029D0 00   
0029D1 39      7886 ADD	HL,SP
0029D2 F9      7887 LD	SP,HL		;"POP" THE STACK
0029D3 C1      7888 POP	BC
0029D4 21      7889 LD	HL,FORCHK
0029D5 61   
0029D6 29   
0029D7 ED      7890 SBC	HL,BC
0029D8 42   
0029D9 E1      7891 POP	HL		;VARIABLE POINTER
0029DA E5      7892 PUSH	HL
0029DB C5      7893 PUSH	BC
0029DC 28      7894 JR	Z,NEXT0
0029DD A5   
0029DE 3E      7895 LD	A,33
0029DF 21   
0029E0 C3      7896 ERROR3ex:         JP	ERROR_		;"Can't match FOR"
0029E1 44   
0029E2 3F   
0029E3 F5      7901 FN:             PUSH	AF		;MAKE SPACE ON STACK
0029E4 CD      7902 CALL	PROC1
0029E5 EB   
0029E6 29   
0029E7 F5      7908 PROC:           PUSH	AF		;MAKE SPACE ON STACK
0029E8 CD      7909 CALL	PROC1
0029E9 EB   
0029EA 29   
0029EB CD      7911 PROC1:          CALL	CHECK
0029EC 86   
0029ED 32   
0029EE FD      7912 DEC	IY
0029EF 2B   
0029F0 FD      7913 PUSH	IY
0029F1 E5   
0029F2 CD      7914 CALL	GETDEF
0029F3 96   
0029F4 42   
0029F5 C1      7915 POP	BC
0029F6 28      7916 JR	Z,PROC4
0029F7 39   
0029F8 3E      7917 LD	A,30
0029F9 1E   
0029FA 38      7918 JR	C,ERROR3ex	;"Bad call"
0029FB E4   
0029FC C5      7919 PUSH	BC
0029FD 2A      7920 LD	HL,(PAGE_)
0029FE DC   
0029FF 54   
002A00 3E      7921 PROC2:          LD	A,TDEF
002A01 DD   
002A02 CD      7922 CALL	SEARCHex		;LOOK FOR "DEF"
002A03 FB   
002A04 35   
002A05 38      7923 JR	C,PROC3
002A06 21   
002A07 E5      7924 PUSH	HL
002A08 FD      7925 POP	IY
002A09 E1   
002A0A FD      7926 INC	IY		;SKIP DEF
002A0B 23   
002A0C CD      7927 CALL	NXT
002A0D 0B   
002A0E 45   
002A0F CD      7928 CALL	GETDEF
002A10 96   
002A11 42   
002A12 FD      7929 PUSH	IY
002A13 E5   
002A14 D1      7930 POP	DE
002A15 38      7931 JR	C,PROC6
002A16 09   
002A17 C4      7932 CALL	NZ,CREATE
002A18 3C   
002A19 43   
002A1A FD      7933 PUSH	IY
002A1B E5   
002A1C D1      7934 POP	DE
002A1D 73      7935 LD	(HL),E
002A1E 23      7936 INC	HL
002A1F 72      7937 LD	(HL),D		;SAVE ADDRESS
002A20 EB      7938 PROC6:          EX	DE,HL
002A21 3E      7939 LD	A,CR
002A22 0D   
002A23 47      7940 LD	B,A
002A24 ED      7941 CPIR			;SKIP TO END OF LINE
002A25 B1   
002A26 18      7942 JR	PROC2
002A27 D8   
002A28 FD      7943 PROC3:          POP	IY		;RESTORE TEXT POINTER
002A29 E1   
002A2A CD      7944 CALL	GETDEF
002A2B 96   
002A2C 42   
002A2D 3E      7945 LD	A,29
002A2E 1D   
002A2F 20      7946 JR	NZ,ERROR3ex	;"No such FN/PROC"
002A30 AF   
002A31 5E      7947 PROC4:          LD	E,(HL)
002A32 23      7948 INC	HL
002A33 56      7949 LD	D,(HL)		;GET ADDRESS
002A34 21      7950 LD	HL,2
002A35 02   
002A36 00   
002A37 39      7951 ADD	HL,SP
002A38 CD      7952 CALL	NXT		;ALLOW SPACE BEFORE (
002A39 0B   
002A3A 45   
002A3B D5      7953 PUSH	DE		;EXCHANGE DE,IY
002A3C FD      7954 EX	(SP),IY
002A3D E3   
002A3E D1      7955 POP	DE
002A3F FE      7956 CP	'('		;ARGUMENTS?
002A40 28   
002A41 C2      7957 JP	NZ,PROC5
002A42 E5   
002A43 2A   
002A44 CD      7958 CALL	NXT		;ALLOW SPACE BEFORE (
002A45 0B   
002A46 45   
002A47 FE      7959 CP	'('
002A48 28   
002A49 C2      7960 JP	NZ,SYNTAX	;"Syntax error"
002A4A E0   
002A4B 25   
002A4C FD      7961 PUSH	IY
002A4D E5   
002A4E C1      7962 POP	BC		;SAVE IY IN BC
002A4F D9      7963 EXX
002A50 08      7964 EX	AF,AF'
002A51 AF      7965 XOR	A		;INITIALISE RETURN COUNT
002A52 08      7966 EX	AF,AF'
002A53 CD      7967 CALL	SAVLOC		;SAVE DUMMY VARIABLES
002A54 BE   
002A55 34   
002A56 08      7968 EX	AF,AF'
002A57 B7      7969 OR	A
002A58 28      7970 JR	Z,RETCHK	;NO RETURNS
002A59 16   
002A5A E5      7971 PUSH	HL
002A5B ED      7972 NEG
002A5C 44   
002A5D 6F      7973 LD	L,A
002A5E ED      7974 NEG
002A5F 44   
002A60 26      7975 LD	H,-1		;HL = -RETURNS
002A61 FF   
002A62 29      7976 ADD	HL,HL
002A63 29      7977 ADD	HL,HL
002A64 29      7978 ADD	HL,HL		;-RETURNS * 8
002A65 E3      7979 EX	(SP),HL
002A66 DD      7980 POP	IX
002A67 E1   
002A68 DD      7981 ADD	IX,SP
002A69 39   
002A6A DD      7982 LD	SP,IX
002A6B F9   
002A6C F5      7983 PUSH	AF		;PUSH RETURN COUNT
002A6D CD      7984 CALL	RETCHK		;PUSH MARKER
002A6E 70   
002A6F 2A   
002A70 08      7985 RETCHK:         EX	AF,AF'
002A71 CD      7986 CALL	BRAKET		;CLOSING BRACKET
002A72 AE   
002A73 20   
002A74 D9      7987 EXX
002A75 C5      7988 PUSH	BC
002A76 FD      7989 POP	IY		;RESTORE IY
002A77 E1   
002A78 E5      7990 PUSH	HL
002A79 CD      7991 CALL	ARGUE		;TRANSFER ARGUMENTS
002A7A CD   
002A7B 32   
002A7C E1      7992 POP	HL
002A7D E3      8000 EX	(SP),HL
002A7E B7      8001 OR	A
002A7F 01      8002 LD	BC,RETCHK
002A80 70   
002A81 2A   
002A82 ED      8003 SBC	HL,BC
002A83 42   
002A84 09      8004 ADD	HL,BC
002A85 E3      8005 EX	(SP),HL
002A86 20      8006 JR	NZ,PROC5	;No RETURNs
002A87 5D   
002A88 D5      8008 PUSH	DE
002A89 E5      8009 PUSH	HL
002A8A 21      8010 LD	HL,7		;Skip two PUSHes and RETCHK
002A8B 07   
002A8C 00   
002A8D 39      8011 ADD	HL,SP
002A8E 7E      8012 LD	A,(HL)		;RETURN count
002A8F 23      8013 INC	HL
002A90 E5      8014 PUSH	HL
002A91 DD      8015 POP	IX		;Address RETURNs table
002A92 E1   
002A93 5F      8016 PROC0:          LD	E,A
002A94 16      8017 LD	D,0
002A95 00   
002A96 EB      8018 EX	DE,HL
002A97 29      8019 ADD	HL,HL
002A98 29      8020 ADD	HL,HL
002A99 29      8021 ADD	HL,HL
002A9A 19      8022 ADD	HL,DE		;HL addresses SAVLOC stack
002A9B 23      8023 INC	HL
002A9C 23      8024 INC	HL		;Bump past LOCCHK
002A9D 5E      8025 PROC7:          LD	E,(HL)
002A9E 23      8026 INC	HL
002A9F 56      8027 LD	D,(HL)		;DE = SAVLOC VARPTR
002AA0 23      8028 INC	HL
002AA1 4E      8029 LD	C,(HL)		;Length (if string)
002AA2 23      8030 INC	HL
002AA3 46      8031 LD	B,(HL)		;Variable type
002AA4 C5      8035 PUSH	BC		;Save type
002AA5 E5      8036 PUSH	HL
002AA6 DD      8037 PUSH	IX
002AA7 E5   
002AA8 47      8038 LD	B,A		;B = RETURN count
002AA9 DD      8039 PROC8:          LD	L,(IX+4)
002AAA 6E   
002AAB 04   
002AAC DD      8040 LD	H,(IX+5)	;HL = RETURNed VARPTR
002AAD 66   
002AAE 05   
002AAF B7      8041 OR	A
002AB0 ED      8042 SBC	HL,DE
002AB1 52   
002AB2 28      8043 JR	Z,PROC9
002AB3 09   
002AB4 EB      8044 EX	DE,HL
002AB5 11      8045 LD	DE,8
002AB6 08   
002AB7 00   
002AB8 DD      8046 ADD	IX,DE
002AB9 19   
002ABA EB      8047 EX	DE,HL
002ABB 10      8048 DJNZ	PROC8
002ABC EC   
002ABD DD      8049 PROC9:          POP	IX
002ABE E1   
002ABF E1      8050 POP	HL
002AC0 C1      8051 POP	BC		;Restore type
002AC1 20      8055 JR	NZ,PROCA
002AC2 02   
002AC3 CB      8056 SET	4,(HL)		;Flag don't restore
002AC4 E6   
002AC5 11      8060 PROCA:          LD	DE,3
002AC6 03   
002AC7 00   
002AC8 CB      8061 BIT	6,B
002AC9 70   
002ACA 20      8062 JR	NZ,PROCB	;Whole array
002ACB 08   
002ACC 1E      8063 LD	E,5
002ACD 05   
002ACE CB      8064 BIT	7,B
002ACF 78   
002AD0 28      8065 JR	Z,PROCB		;Numeric
002AD1 02   
002AD2 59      8066 LD	E,C
002AD3 13      8067 INC	DE
002AD4 19      8068 PROCB:          ADD	HL,DE
002AD5 4E      8069 LD	C,(HL)
002AD6 23      8070 INC	HL
002AD7 46      8071 LD	B,(HL)
002AD8 23      8072 INC	HL		; BC = marker ?
002AD9 EB      8073 EX	DE,HL
002ADA 21      8074 LD	HL,LOCCHK
002ADB 2A   
002ADC 35   
002ADD B7      8075 OR	A
002ADE ED      8076 SBC	HL,BC
002ADF 42   
002AE0 EB      8077 EX	DE,HL
002AE1 28      8078 JR	Z,PROC7		;Another
002AE2 BA   
002AE3 E1      8079 POP	HL
002AE4 D1      8080 POP	DE
002AE5 73      8082 PROC5:          LD	(HL),E		;SAVE "RETURN ADDRESS"
002AE6 23      8083 INC	HL
002AE7 7E      8084 LD	A,(HL)
002AE8 72      8085 LD	(HL),D
002AE9 FE      8086 CP	TON		;WAS IT "ON PROC" ?
002AEA EE   
002AEB 20      8087 JR	NZ,XEQGO
002AEC 0C   
002AED D5      8088 PUSH	DE
002AEE FD      8089 EX	(SP),IY
002AEF E3   
002AF0 CD      8090 CALL	SPAN		;SKIP REST OF ON LIST
002AF1 42   
002AF2 35   
002AF3 FD      8091 EX	(SP),IY
002AF4 E3   
002AF5 D1      8092 POP	DE
002AF6 72      8093 LD	(HL),D
002AF7 2B      8094 DEC	HL
002AF8 73      8095 LD	(HL),E
002AF9 C3      8096 XEQGO:          JP	XEQ
002AFA 99   
002AFB 24   
002AFC FD      8098 LOCERR:         INC	IY
002AFD 23   
002AFE 18      8099 JR	XEQGO
002AFF F9   
002B00 FD      8103 LOCDAT:         INC	IY
002B01 23   
002B02 2A      8104 LD	HL,(DATPTR)
002B03 F0   
002B04 54   
002B05 E5      8105 PUSH	HL
002B06 3E      8106 LD	A,40H
002B07 40   
002B08 F5      8107 PUSH	AF
002B09 21      8108 LD	HL,DATPTR
002B0A F0   
002B0B 54   
002B0C E5      8109 PUSH	HL
002B0D 21      8110 LD	HL,LOCCHK
002B0E 2A   
002B0F 35   
002B10 E5      8111 PUSH	HL
002B11 18      8112 JR	XEQGO
002B12 E6   
002B13 FE      8116 LOCAL:          CP	TERROR
002B14 85   
002B15 28      8117 JR	Z,LOCERR
002B16 E5   
002B17 FE      8118 CP	TDATA
002B18 DC   
002B19 28      8119 JR	Z,LOCDAT
002B1A E5   
002B1B C1      8120 POP	BC
002B1C C5      8121 PUSH	BC
002B1D 21      8122 LD	HL,FNCHK
002B1E E7   
002B1F 29   
002B20 B7      8123 OR	A
002B21 ED      8124 SBC	HL,BC
002B22 42   
002B23 28      8125 JR	Z,LOCAL1
002B24 23   
002B25 21      8126 LD	HL,PROCHK
002B26 EB   
002B27 29   
002B28 B7      8127 OR	A
002B29 ED      8128 SBC	HL,BC
002B2A 42   
002B2B 28      8129 JR	Z,LOCAL1
002B2C 1B   
002B2D 21      8130 LD	HL,LOCCHK
002B2E 2A   
002B2F 35   
002B30 B7      8131 OR	A
002B31 ED      8132 SBC	HL,BC
002B32 42   
002B33 28      8133 JR	Z,LOCAL1
002B34 13   
002B35 21      8134 LD	HL,ARRCHK
002B36 DC   
002B37 26   
002B38 B7      8135 OR	A
002B39 ED      8136 SBC	HL,BC
002B3A 42   
002B3B 28      8137 JR	Z,LOCAL1
002B3C 0B   
002B3D 21      8138 LD	HL,RETCHK
002B3E 70   
002B3F 2A   
002B40 B7      8139 OR	A
002B41 ED      8140 SBC	HL,BC
002B42 42   
002B43 3E      8141 LD	A,12
002B44 0C   
002B45 C2      8142 JP	NZ,ERROR_	;"Not LOCAL"
002B46 44   
002B47 3F   
002B48 FD      8143 LOCAL1:         PUSH	IY
002B49 E5   
002B4A C1      8144 POP	BC
002B4B D9      8145 EXX
002B4C FD      8146 DEC	IY
002B4D 2B   
002B4E CD      8147 CALL	SAVLOC
002B4F BE   
002B50 34   
002B51 D9      8148 EXX
002B52 C5      8149 PUSH	BC
002B53 FD      8150 POP	IY
002B54 E1   
002B55 CD      8151 LOCAL2:         CALL	GETVAR
002B56 E3   
002B57 41   
002B58 C2      8152 JP	NZ,SYNTAX
002B59 E0   
002B5A 25   
002B5B CB      8153 BIT	6,A		;ARRAY?
002B5C 77   
002B5D 20      8154 JR	NZ,LOCAL4
002B5E 14   
002B5F B7      8155 OR	A		;TYPE
002B60 08      8156 EX	AF,AF'
002B61 CD      8157 CALL	ZERO
002B62 F8   
002B63 1F   
002B64 08      8158 EX	AF,AF'
002B65 F5      8159 PUSH	AF
002B66 F4      8160 CALL	P,STOREN	;ZERO
002B67 F0   
002B68 31   
002B69 F1      8161 POP	AF
002B6A 59      8162 LD	E,C
002B6B FC      8163 CALL	M,STORES
002B6C 41   
002B6D 32   
002B6E CD      8164 LOCAL3:         CALL	NLIST
002B6F 00   
002B70 45   
002B71 18      8165 JR	LOCAL2
002B72 E2   
002B73 DD      8167 LOCAL4:         LD	(IX+0),1	;FLAG LOCAL ARRAY
002B74 36   
002B75 00   
002B76 01   
002B77 DD      8168 LD	(IX+1),0
002B78 36   
002B79 01   
002B7A 00   
002B7B 18      8169 JR	LOCAL3
002B7C F1   
002B7D C1      8173 ENDPRO:         POP	BC
002B7E 21      8174 LD	HL,PROCHK	;PROC MARKER
002B7F EB   
002B80 29   
002B81 AF      8175 XOR	A
002B82 ED      8176 SBC	HL,BC
002B83 42   
002B84 28      8177 JR	Z,ENDPR1
002B85 0B   
002B86 C5      8178 PUSH	BC		;PUT BACK
002B87 CD      8179 CALL	RESLOC
002B88 31   
002B89 34   
002B8A 20      8180 JR	NZ,ENDPRO
002B8B F1   
002B8C 3E      8181 LD	A,13
002B8D 0D   
002B8E C3      8182 JP	ERROR_		;"No PROC"
002B8F 44   
002B90 3F   
002B91 FD      8184 ENDPR1:         POP	IY
002B92 E1   
002B93 C3      8185 XEQGO6:         JP	XEQ
002B94 99   
002B95 24   
002B96 CD      8189 INPUTN:         CALL	CHNL		;E = CHANNEL NUMBER
002B97 DB   
002B98 36   
002B99 CD      8190 INPN1:          CALL	NLIST
002B9A 00   
002B9B 45   
002B9C D5      8191 PUSH	DE
002B9D CD      8192 CALL	VAR_
002B9E D6   
002B9F 25   
002BA0 D1      8193 POP	DE
002BA1 F5      8194 PUSH	AF		;SAVE TYPE
002BA2 E5      8195 PUSH	HL		;VARPTR
002BA3 B7      8196 OR	A
002BA4 FA      8197 JP	M,INPN2		;STRING
002BA5 C9   
002BA6 2B   
002BA7 CD      8198 CALL	OSBGET
002BA8 5B   
002BA9 06   
002BAA D9      8199 EXX
002BAB 6F      8200 LD	L,A
002BAC D9      8201 EXX
002BAD CD      8202 CALL	OSBGET
002BAE 5B   
002BAF 06   
002BB0 D9      8203 EXX
002BB1 67      8204 LD	H,A
002BB2 D9      8205 EXX
002BB3 CD      8206 CALL	OSBGET
002BB4 5B   
002BB5 06   
002BB6 6F      8207 LD	L,A
002BB7 CD      8208 CALL	OSBGET
002BB8 5B   
002BB9 06   
002BBA 67      8209 LD	H,A
002BBB CD      8210 CALL	OSBGET
002BBC 5B   
002BBD 06   
002BBE 4F      8211 LD	C,A
002BBF DD      8212 POP	IX
002BC0 E1   
002BC1 F1      8213 POP	AF		;RESTORE TYPE
002BC2 D5      8214 PUSH	DE		;SAVE CHANNEL
002BC3 CD      8215 CALL	STOREN
002BC4 F0   
002BC5 31   
002BC6 D1      8216 POP	DE
002BC7 18      8217 JR	INPN1
002BC8 D0   
002BC9 21      8218 INPN2:          LD	HL,ACCS
002BCA 00   
002BCB 52   
002BCC CD      8219 INPN3:          CALL	OSBGET
002BCD 5B   
002BCE 06   
002BCF FE      8220 CP	CR
002BD0 0D   
002BD1 28      8221 JR	Z,INPN4
002BD2 04   
002BD3 77      8222 LD	(HL),A
002BD4 2C      8223 INC	L
002BD5 20      8224 JR	NZ,INPN3
002BD6 F5   
002BD7 DD      8225 INPN4:          POP	IX
002BD8 E1   
002BD9 F1      8226 POP	AF
002BDA D5      8227 PUSH	DE
002BDB EB      8228 EX	DE,HL
002BDC CD      8229 CALL	STACCS
002BDD 3E   
002BDE 32   
002BDF D1      8230 POP	DE
002BE0 18      8231 JR	INPN1
002BE1 B7   
002BE2 FE      8236 INPUT:          CP	'#'
002BE3 23   
002BE4 28      8237 JR	Z,INPUTN
002BE5 B0   
002BE6 0E      8238 LD	C,0		;FLAG PROMPT
002BE7 00   
002BE8 FE      8239 CP	TLINE
002BE9 86   
002BEA 20      8240 JR	NZ,INPUT0
002BEB 04   
002BEC FD      8241 INC	IY		;SKIP "LINE"
002BED 23   
002BEE 0E      8242 LD	C,80H
002BEF 80   
002BF0 21      8243 INPUT0:         LD	HL,BUFFER
002BF1 00   
002BF2 53   
002BF3 36      8244 LD	(HL),CR		;INITIALISE EMPTY
002BF4 0D   
002BF5 CD      8245 INPUT1:         CALL	TERMQ
002BF6 36   
002BF7 35   
002BF8 28      8246 JR	Z,XEQGO6	;DONE
002BF9 99   
002BFA FD      8247 INC	IY
002BFB 23   
002BFC FE      8248 CP	','
002BFD 2C   
002BFE 28      8249 JR	Z,INPUT3	;SKIP COMMA
002BFF 51   
002C00 FE      8250 CP	';'
002C01 3B   
002C02 28      8251 JR	Z,INPUT3
002C03 4D   
002C04 E5      8252 PUSH	HL		;SAVE BUFFER POINTER
002C05 FE      8253 CP	'"'
002C06 22   
002C07 20      8254 JR	NZ,INPUT6
002C08 0A   
002C09 C5      8255 PUSH	BC
002C0A CD      8256 CALL	CONS
002C0B 7A   
002C0C 19   
002C0D C1      8257 POP	BC
002C0E CD      8258 CALL	PTEXT		;PRINT PROMPT
002C0F B1   
002C10 35   
002C11 18      8259 JR	INPUT9
002C12 05   
002C13 CD      8260 INPUT6:         CALL	FORMAT		;SPC, TAB, '
002C14 5C   
002C15 35   
002C16 20      8261 JR	NZ,INPUT2
002C17 05   
002C18 E1      8262 INPUT9:         POP	HL
002C19 CB      8263 SET	0,C		;FLAG NO PROMPT
002C1A C1   
002C1B 18      8264 JR	INPUT0
002C1C D3   
002C1D FD      8265 INPUT2:         DEC	IY
002C1E 2B   
002C1F C5      8266 PUSH	BC
002C20 CD      8267 CALL	VAR_
002C21 D6   
002C22 25   
002C23 C1      8268 POP	BC
002C24 E1      8269 POP	HL
002C25 F5      8270 PUSH	AF		;SAVE TYPE
002C26 7E      8271 LD	A,(HL)
002C27 23      8272 INC	HL
002C28 FE      8273 CP	CR		;BUFFER EMPTY?
002C29 0D   
002C2A CC      8274 CALL	Z,REFILL
002C2B 55   
002C2C 2C   
002C2D CB      8275 BIT	7,C
002C2E 79   
002C2F F5      8276 PUSH	AF
002C30 C4      8277 CALL	NZ,LINES
002C31 CF   
002C32 35   
002C33 F1      8278 POP	AF
002C34 CC      8279 CALL	Z,FETCHS
002C35 BE   
002C36 35   
002C37 F1      8280 POP	AF		;RESTORE TYPE
002C38 C5      8281 PUSH	BC
002C39 E5      8282 PUSH	HL
002C3A B7      8283 OR	A
002C3B FA      8284 JP	M,INPUT4	;STRING
002C3C 4C   
002C3D 2C   
002C3E F5      8285 PUSH	AF
002C3F DD      8286 PUSH	IX
002C40 E5   
002C41 CD      8287 CALL	VAL0
002C42 22   
002C43 1C   
002C44 DD      8288 POP	IX
002C45 E1   
002C46 F1      8289 POP	AF
002C47 CD      8290 CALL	STOREN
002C48 F0   
002C49 31   
002C4A 18      8291 JR	INPUT5
002C4B 03   
002C4C CD      8292 INPUT4:         CALL	STACCS
002C4D 3E   
002C4E 32   
002C4F E1      8293 INPUT5:         POP	HL
002C50 C1      8294 POP	BC
002C51 CB      8295 INPUT3:         RES	0,C
002C52 81   
002C53 18      8296 JR	INPUT1
002C54 A0   
002C55 CB      8298 REFILL:         BIT	0,C
002C56 41   
002C57 20      8299 JR	NZ,REFIL0	;NO PROMPT
002C58 0A   
002C59 3E      8300 LD	A,'?'
002C5A 3F   
002C5B CD      8301 CALL	OUTCHR		;PROMPT
002C5C 02   
002C5D 41   
002C5E 3E      8302 LD	A,' '
002C5F 20   
002C60 CD      8303 CALL	OUTCHR
002C61 02   
002C62 41   
002C63 21      8304 REFIL0:         LD	HL,BUFFER
002C64 00   
002C65 53   
002C66 C5      8305 PUSH	BC
002C67 E5      8306 PUSH	HL
002C68 DD      8307 PUSH	IX
002C69 E5   
002C6A CD      8308 CALL	OSLINE
002C6B E7   
002C6C 05   
002C6D DD      8309 POP	IX
002C6E E1   
002C6F E1      8310 POP	HL
002C70 C1      8311 POP	BC
002C71 47      8312 LD	B,A		;POS AT ENTRY
002C72 AF      8313 XOR	A
002C73 32      8314 LD	(COUNT),A
002C74 FB   
002C75 54   
002C76 B8      8315 CP	B
002C77 C8      8316 RET	Z
002C78 7E      8317 REFIL1:         LD	A,(HL)
002C79 FE      8318 CP	CR
002C7A 0D   
002C7B C8      8319 RET	Z
002C7C 23      8320 INC	HL
002C7D 10      8321 DJNZ	REFIL1
002C7E F9   
002C7F C9      8322 RET
002C80 FE      8326 READ:           CP	'#'
002C81 23   
002C82 CA      8327 JP	Z,INPUTN
002C83 96   
002C84 2B   
002C85 2A      8328 LD	HL,(DATPTR)
002C86 F0   
002C87 54   
002C88 7E      8329 READ0:          LD	A,(HL)
002C89 FE      8330 CP	':'
002C8A 3A   
002C8B CC      8331 CALL	Z,REFIL1
002C8C 78   
002C8D 2C   
002C8E 23      8332 INC	HL		;SKIP COMMA | "DATA"
002C8F FE      8333 CP	CR		;END OF DATA STMT?
002C90 0D   
002C91 CC      8334 CALL	Z,GETDAT
002C92 C0   
002C93 2C   
002C94 E5      8335 PUSH	HL
002C95 CD      8336 CALL	VAR_
002C96 D6   
002C97 25   
002C98 E1      8337 POP	HL
002C99 B7      8338 OR	A
002C9A FA      8339 JP	M,READ1		;STRING
002C9B B0   
002C9C 2C   
002C9D E5      8340 PUSH	HL
002C9E FD      8341 EX	(SP),IY
002C9F E3   
002CA0 F5      8342 PUSH	AF		;SAVE TYPE
002CA1 DD      8343 PUSH	IX
002CA2 E5   
002CA3 CD      8344 CALL	EXPRN
002CA4 2C   
002CA5 18   
002CA6 DD      8345 POP	IX
002CA7 E1   
002CA8 F1      8346 POP	AF
002CA9 CD      8347 CALL	STOREN
002CAA F0   
002CAB 31   
002CAC FD      8348 EX	(SP),IY
002CAD E3   
002CAE 18      8349 JR	READ2
002CAF 07   
002CB0 CD      8350 READ1:          CALL	FETCHS
002CB1 BE   
002CB2 35   
002CB3 E5      8351 PUSH	HL
002CB4 CD      8352 CALL	STACCS
002CB5 3E   
002CB6 32   
002CB7 E1      8353 READ2:          POP	HL
002CB8 22      8354 LD	(DATPTR),HL
002CB9 F0   
002CBA 54   
002CBB CD      8355 CALL	NLIST
002CBC 00   
002CBD 45   
002CBE 18      8356 JR	READ0
002CBF C8   
002CC0 CD      8358 GETDAT:         CALL	DSRCH
002CC1 F9   
002CC2 35   
002CC3 23      8359 INC	HL
002CC4 D0      8360 RET	NC
002CC5 3E      8361 LD	A,42
002CC6 2A   
002CC7 18      8362 JR	ERROR4ex		;"Out of DATA"
002CC8 64   
002CC9 CD      8369 IF_:            CALL	EXPRI
002CCA 33   
002CCB 18   
002CCC CD      8370 CALL	TEST
002CCD 59   
002CCE 1F   
002CCF 28      8371 JR	Z,IFNOT		;FALSE
002CD0 2A   
002CD1 FD      8372 LD	A,(IY)
002CD2 7E   
002CD3 00   
002CD4 FE      8373 CP	TTHEN
002CD5 8C   
002CD6 C2      8374 JP	NZ,XEQ
002CD7 99   
002CD8 24   
002CD9 FD      8375 IF0:            INC	IY		;SKIP "THEN"
002CDA 23   
002CDB FD      8376 LD	A,(IY)
002CDC 7E   
002CDD 00   
002CDE FE      8377 CP	';'
002CDF 3B   
002CE0 28      8378 JR	Z,IF0
002CE1 F7   
002CE2 CD      8379 IF1:            CALL	NXT
002CE3 0B   
002CE4 45   
002CE5 FE      8380 CP	TLINO
002CE6 8D   
002CE7 C2      8381 JP	NZ,XEQ		;STATEMENT FOLLOWS
002CE8 99   
002CE9 24   
002CEA C3      8382 JP	GOTO		;LINE NO. FOLLOWS
002CEB B4   
002CEC 28   
002CED FD      8384 IFELSE:         LD	A,(IY)
002CEE 7E   
002CEF 00   
002CF0 FD      8385 INC	IY
002CF1 23   
002CF2 FE      8386 CP	';'
002CF3 3B   
002CF4 20      8387 JR	NZ,IFNEXT
002CF5 0A   
002CF6 18      8388 JR	IFTHEN
002CF7 1E   
002CF8 CD      8390 IF2:            CALL	QUOTE		;SKIP STRING
002CF9 99   
002CFA 36   
002CFB FD      8391 IFNOT:          LD	A,(IY)
002CFC 7E   
002CFD 00   
002CFE FD      8392 INC	IY
002CFF 23   
002D00 FE      8393 IFNEXT:         CP	'"'
002D01 22   
002D02 28      8394 JR	Z,IF2		;QUOTED STRING
002D03 F4   
002D04 FE      8395 CP	TREM
002D05 F4   
002D06 CA      8396 JP	Z,REM		;REM
002D07 31   
002D08 25   
002D09 FE      8397 CP	CR
002D0A 0D   
002D0B CA      8398 JP	Z,XEQ0		;END OF LINE
002D0C 84   
002D0D 24   
002D0E FE      8399 CP	TELSE
002D0F 8B   
002D10 28      8400 JR	Z,IF1		;ELSE CLAUSE
002D11 D0   
002D12 FE      8401 CP	TTHEN
002D13 8C   
002D14 20      8402 JR	NZ,IFNOT	;TRY FOR END AGAIN
002D15 E5   
002D16 FD      8403 IFTHEN:         LD	A,(IY)
002D17 7E   
002D18 00   
002D19 FE      8404 CP	CR
002D1A 0D   
002D1B 20      8405 JR	NZ,IFELSE
002D1C D0   
002D1D 01      8406 LD	BC,TELSE
002D1E 8B   
002D1F 00   
002D20 11      8407 LD	DE,TENDIF*256+TTHEN
002D21 8C   
002D22 CD   
002D23 FD      8408 INC	IY
002D24 23   
002D25 CD      8409 CALL	NSCAN
002D26 11   
002D27 36   
002D28 CA      8410 JP	Z,XEQ1
002D29 A0   
002D2A 24   
002D2B 3E      8411 NENDIF:         LD	A,49
002D2C 31   
002D2D C3      8412 ERROR4ex:         JP	ERROR_		;"Missing ENDIF"
002D2E 44   
002D2F 3F   
002D30 01      8416 MELSE:          LD	BC,-3
002D31 FD   
002D32 FF   
002D33 FD      8417 ADD	IY,BC
002D34 09   
002D35 01      8418 LD	BC,TENDIF
002D36 CD   
002D37 00   
002D38 11      8419 LD	DE,TENDIF*256+TTHEN
002D39 8C   
002D3A CD   
002D3B CD      8420 CALL	NSCAN
002D3C 11   
002D3D 36   
002D3E 20      8421 JR	NZ,NENDIF
002D3F EB   
002D40 C3      8422 XEQGO7:         JP	XEQ
002D41 99   
002D42 24   
002D43 01      8426 WHEN:           LD	BC,-3
002D44 FD   
002D45 FF   
002D46 FD      8427 ADD	IY,BC
002D47 09   
002D48 01      8428 LD	BC,TENDCASE
002D49 CB   
002D4A 00   
002D4B 11      8429 LD	DE,TENDCASE*256+TOF
002D4C CA   
002D4D CB   
002D4E CD      8430 CALL	NSCAN
002D4F 11   
002D50 36   
002D51 28      8431 JR	Z,XEQGO7
002D52 ED   
002D53 3E      8432 LD	A,47
002D54 2F   
002D55 18      8433 JR	ERROR4ex		;"Missing ENDCASE"
002D56 D6   
002D57 CD      8437 CASE:           CALL	EXPR		;String or numeric
002D58 02   
002D59 17   
002D5A 08      8438 EX	AF,AF'
002D5B 06      8439 LD	B,0		;Flag numeric
002D5C 00   
002D5D F2      8440 JP	P,CASE6		;numeric
002D5E 66   
002D5F 2D   
002D60 CD      8441 CALL	PUSHS		;put string on stack
002D61 19   
002D62 20   
002D63 C1      8442 POP	BC		;C = length
002D64 06      8443 LD	B,1		;Flag string
002D65 01   
002D66 FD      8444 CASE6:          LD	A,(IY)
002D67 7E   
002D68 00   
002D69 FD      8445 INC	IY
002D6A 23   
002D6B FE      8446 CP	TOF
002D6C CA   
002D6D 3E      8447 LD	A,37
002D6E 25   
002D6F 20      8448 JR	NZ,ERROR4ex	;"Missing OF"
002D70 BC   
002D71 FD      8449 LD	A,(IY)
002D72 7E   
002D73 00   
002D74 FD      8450 INC	IY		;Address line-length byte
002D75 23   
002D76 FE      8451 CP	CR
002D77 0D   
002D78 3E      8452 LD	A,48
002D79 30   
002D7A 20      8453 JR	NZ,ERROR4ex	;"OF not last"
002D7B B1   
002D7C AF      8454 CASE1:          XOR	A		;Level
002D7D D9      8455 CASE0:          EXX
002D7E E5      8456 PUSH	HL		;Push to stack
002D7F D9      8457 EXX
002D80 E5      8458 PUSH	HL
002D81 C5      8459 PUSH	BC
002D82 6F      8460 LD	L,A		;Level
002D83 01      8461 LD	BC,TOTHERWISE*256+TWHEN
002D84 C9   
002D85 CC   
002D86 11      8462 LD	DE,TENDCASE*256+TOF
002D87 CA   
002D88 CB   
002D89 CD      8463 CALL	NSCAN1
002D8A 13   
002D8B 36   
002D8C C1      8464 POP	BC		;Restore from stack
002D8D E1      8465 POP	HL
002D8E D9      8466 EXX
002D8F E1      8467 POP	HL
002D90 D9      8468 EXX
002D91 3E      8469 LD	A,47
002D92 2F   
002D93 C2      8470 JP	NZ,ERROR_	;Missing ENDCASE
002D94 44   
002D95 3F   
002D96 FD      8471 LD	A,(IY-1)
002D97 7E   
002D98 FF   
002D99 FE      8472 CP	TENDCASE
002D9A CB   
002D9B 28      8473 JR	Z,CASE9
002D9C 56   
002D9D FE      8474 CP	TOTHERWISE
002D9E CC   
002D9F 28      8475 JR	Z,CASE9
002DA0 52   
002DA1 CB      8476 CASE4:          BIT	0,B		;Numeric or string?
002DA2 40   
002DA3 20      8477 JR	NZ,CASE3
002DA4 69   
002DA5 C5      8478 PUSH	BC		;Type/exponent/length
002DA6 E5      8479 PUSH	HL		;MS 32 bits
002DA7 D9      8480 EXX
002DA8 E5      8481 PUSH	HL		;LS 32 bits
002DA9 D9      8482 EXX
002DAA CD      8483 CALL	EXPRN
002DAB 2C   
002DAC 18   
002DAD DD      8484 LD	IX,0
002DAE 21   
002DAF 00   
002DB0 00   
002DB1 DD      8485 ADD	IX,SP		;Address stack
002DB2 39   
002DB3 D9      8486 EXX
002DB4 DD      8487 LD	E,(IX+0)	;Get LS 32-bits
002DB5 5E   
002DB6 00   
002DB7 DD      8488 LD	D,(IX+1)
002DB8 56   
002DB9 01   
002DBA D9      8489 EXX
002DBB DD      8490 LD	E,(IX+2)
002DBC 5E   
002DBD 02   
002DBE DD      8491 LD	D,(IX+3)	;Get MS 32-bits
002DBF 56   
002DC0 03   
002DC1 DD      8492 LD	B,(IX+4)	;Get exponent
002DC2 46   
002DC3 04   
002DC4 3E      8493 LD	A,9
002DC5 09   
002DC6 CD      8494 CALL	FPP		;In case integer vs float
002DC7 15   
002DC8 45   
002DC9 7D      8495 LD	A,L
002DCA B7      8496 OR	A		;NZ if equal
002DCB D9      8497 EXX
002DCC E1      8498 POP	HL
002DCD D9      8499 EXX
002DCE E1      8500 POP	HL
002DCF C1      8501 POP	BC
002DD0 20      8502 JR	NZ,CASE5	;Match found
002DD1 2C   
002DD2 FD      8503 CASE2:          LD	A,(IY)
002DD3 7E   
002DD4 00   
002DD5 FD      8504 INC	IY
002DD6 23   
002DD7 FE      8505 CP	','
002DD8 2C   
002DD9 28      8506 JR	Z,CASE4		;Not found, try another
002DDA C6   
002DDB D9      8507 EXX
002DDC FD      8508 PUSH	IY
002DDD E5   
002DDE E3      8509 EX	(SP),HL
002DDF 3E      8510 LD	A,CR
002DE0 0D   
002DE1 47      8511 LD	B,A
002DE2 ED      8512 CPIR			;Find CR
002DE3 B1   
002DE4 E3      8513 EX	(SP),HL
002DE5 FD      8514 POP	IY
002DE6 E1   
002DE7 D9      8515 EXX
002DE8 FD      8516 LD	A,(IY-2)	;Last token in previous line
002DE9 7E   
002DEA FE   
002DEB FE      8517 CP	TOF		;CASE statement in WHEN line
002DEC CA   
002DED 20      8518 JR	NZ,CASE1
002DEE 8D   
002DEF 3E      8519 LD	A,1
002DF0 01   
002DF1 18      8520 JR	CASE0
002DF2 8A   
002DF3 CB      8524 CASE9:          BIT	0,B
002DF4 40   
002DF5 28      8525 JR	Z,XEQGO5
002DF6 49   
002DF7 26      8526 LD	H,0
002DF8 00   
002DF9 69      8527 LD	L,C
002DFA 39      8528 ADD	HL,SP
002DFB F9      8529 LD	SP,HL
002DFC 18      8530 JR	XEQGO5
002DFD 42   
002DFE CD      8534 CASE5:          CALL	NXT
002DFF 0B   
002E00 45   
002E01 FE      8535 CP	','
002E02 2C   
002E03 20      8536 JR	NZ,CASE9	;End of list
002E04 EE   
002E05 FD      8537 INC	IY
002E06 23   
002E07 C5      8538 PUSH	BC		;Save type and string length
002E08 CD      8539 CALL	EXPR		;Evaluate but discard
002E09 02   
002E0A 17   
002E0B C1      8540 POP	BC
002E0C 18      8541 JR	CASE5
002E0D F0   
002E0E C5      8545 CASE3:          PUSH	BC
002E0F CD      8546 CALL	EXPRS
002E10 3C   
002E11 18   
002E12 C1      8547 POP	BC
002E13 21      8548 LD	HL,0
002E14 00   
002E15 00   
002E16 39      8549 ADD	HL,SP
002E17 43      8550 LD	B,E
002E18 11      8551 LD	DE,ACCS
002E19 00   
002E1A 52   
002E1B C5      8552 PUSH	BC
002E1C CD      8553 CALL	SCP		;String compare
002E1D F5   
002E1E 1F   
002E1F C1      8554 POP	BC
002E20 06      8555 LD	B,1
002E21 01   
002E22 20      8556 JR	NZ,CASE2
002E23 AE   
002E24 18      8557 JR	CASE5
002E25 D8   
002E26 FD      8561 WHILE:          PUSH	IY		;Save current position
002E27 E5   
002E28 CD      8562 CALL	CHECK
002E29 86   
002E2A 32   
002E2B CD      8563 CALL	WHICHK		;Push marker
002E2C 2E   
002E2D 2E   
002E2E CD      8564 WHICHK:         CALL	EXPRI
002E2F 33   
002E30 18   
002E31 CD      8565 CALL	TEST
002E32 59   
002E33 1F   
002E34 20      8566 JR	NZ,XEQGO5
002E35 0A   
002E36 C1      8567 POP	BC		;Pop marker
002E37 C1      8568 POP	BC		;Level stack
002E38 01      8569 LD	BC,TWHILE+TENDWHILE*256
002E39 00   
002E3A 95   
002E3B 16      8570 LD	D,1
002E3C 01   
002E3D CD      8571 CALL	WSRCH
002E3E 50   
002E3F 36   
002E40 C3      8572 XEQGO5:         JP	XEQ
002E41 99   
002E42 24   
002E43 C1      8576 ENDWHI:         POP	BC		;Marker
002E44 D1      8577 POP	DE		;Saved text pointer
002E45 D5      8578 PUSH	DE
002E46 C5      8579 PUSH	BC
002E47 B7      8580 OR	A
002E48 21      8581 LD	HL,WHICHK
002E49 2E   
002E4A 2E   
002E4B ED      8582 SBC	HL,BC
002E4C 42   
002E4D 28      8583 JR	Z,ENDWH1
002E4E 0B   
002E4F 3E      8584 LD	A,3
002E50 03   
002E51 CD      8585 CALL	RESLOC
002E52 31   
002E53 34   
002E54 20      8586 JR	NZ,ENDWHI
002E55 ED   
002E56 3E      8587 LD	A,46
002E57 2E   
002E58 18      8588 JR	ERROR5		;"Not in a WHILE loop"
002E59 4F   
002E5A FD      8590 ENDWH1:         PUSH	IY
002E5B E5   
002E5C FD      8591 LD	IY,0
002E5D 21   
002E5E 00   
002E5F 00   
002E60 FD      8592 ADD	IY,DE
002E61 19   
002E62 CD      8593 CALL	EXPRI
002E63 33   
002E64 18   
002E65 CD      8594 CALL	TEST
002E66 59   
002E67 1F   
002E68 D1      8595 POP	DE		;Text pointer
002E69 20      8596 JR	NZ,XEQGO5
002E6A D5   
002E6B C1      8597 POP	BC		;Junk marker
002E6C C1      8598 POP	BC		;Junk pointer
002E6D FD      8599 LD	IY,0
002E6E 21   
002E6F 00   
002E70 00   
002E71 FD      8600 ADD	IY,DE
002E72 19   
002E73 18      8601 JR	XEQGO5
002E74 CB   
002E75 CD      8605 CLS:            CALL	CLRSCN
002E76 8C   
002E77 0D   
002E78 AF      8606 XOR	A
002E79 32      8607 LD	(COUNT),A
002E7A FB   
002E7B 54   
002E7C 18      8608 JR	XEQGO5
002E7D C2   
002E7E CD      8612 STOP:           CALL	TELL
002E7F FA   
002E80 44   
002E81 0D      8613 DB	CR
002E82 0A      8614 DB	LF
002E83 FA      8615 DB	TSTOP
002E84 00      8616 DB	0
002E85 CD      8617 CALL	SETLIN		;FIND CURRENT LINE
002E86 5B   
002E87 41   
002E88 CD      8618 CALL	SAYLN
002E89 82   
002E8A 41   
002E8B CD      8619 CALL	CRLF
002E8C FB   
002E8D 40   
002E8E C3      8620 JP	CLOOP
002E8F B0   
002E90 37   
002E91 CD      8624 REPOR:          CALL	REPORT
002E92 E5   
002E93 44   
002E94 18      8625 JR	XEQGO5
002E95 AA   
002E96 CD      8629 CLR:            CALL	CLEAR
002E97 43   
002E98 40   
002E99 2A      8630 LD	HL,(PAGE_)
002E9A DC   
002E9B 54   
002E9C 18      8631 JR	RESTR1
002E9D 3B   
002E9E FD      8635 RESERR:         INC	IY
002E9F 23   
002EA0 3E      8636 LD	A,2
002EA1 02   
002EA2 CD      8637 CALL	RESLOC
002EA3 31   
002EA4 34   
002EA5 20      8638 JR	NZ,XEQGO5
002EA6 99   
002EA7 3E      8639 LD	A,53		;ON ERROR not LOCAL
002EA8 35   
002EA9 C3      8640 ERROR5:         JP	ERROR_
002EAA 44   
002EAB 3F   
002EAC FD      8644 RESDAT:         INC	IY
002EAD 23   
002EAE 3E      8645 LD	A,1
002EAF 01   
002EB0 CD      8646 CALL	RESLOC
002EB1 31   
002EB2 34   
002EB3 20      8647 JR	NZ,XEQGO5
002EB4 8B   
002EB5 3E      8648 LD	A,54		;'DATA not LOCAL'
002EB6 36   
002EB7 21      8649 DB	21H
002EB8 3E      8650 NOLINE:         LD	A,41		;'No such line'
002EB9 29   
002EBA 18      8651 JR	ERROR5
002EBB ED   
002EBC FE      8655 RESTOR:         CP	TERROR
002EBD 85   
002EBE 28      8656 JR	Z,RESERR
002EBF DE   
002EC0 FE      8657 CP	TDATA
002EC1 DC   
002EC2 28      8658 JR	Z,RESDAT
002EC3 E8   
002EC4 FE      8659 CP	'+'
002EC5 2B   
002EC6 28      8660 JR	Z,RESREL
002EC7 1A   
002EC8 2A      8661 LD	HL,(PAGE_)
002EC9 DC   
002ECA 54   
002ECB CD      8662 CALL	TERMQ
002ECC 36   
002ECD 35   
002ECE 28      8663 JR	Z,RESTR1
002ECF 09   
002ED0 CD      8664 CALL	ITEMI
002ED1 60   
002ED2 18   
002ED3 D9      8665 EXX
002ED4 CD      8666 CALL	FINDL		;SEARCH FOR LINE
002ED5 43   
002ED6 41   
002ED7 20      8667 JR	NZ,NOLINE
002ED8 DF   
002ED9 CD      8668 RESTR1:         CALL	DSRCH
002EDA F9   
002EDB 35   
002EDC 22      8669 LD	(DATPTR),HL
002EDD F0   
002EDE 54   
002EDF C3      8670 JP	XEQ
002EE0 99   
002EE1 24   
002EE2 CD      8672 RESREL:         CALL	EXPRI
002EE3 33   
002EE4 18   
002EE5 D9      8673 EXX
002EE6 EB      8674 EX	DE,HL
002EE7 FD      8675 PUSH	IY
002EE8 E5   
002EE9 E1      8676 POP	HL
002EEA 3E      8677 LD	A,CR
002EEB 0D   
002EEC 47      8678 LD	B,A
002EED ED      8679 CPIR			;FIND LINE END
002EEE B1   
002EEF 1D      8680 DEC	E
002EF0 28      8681 JR	Z,RESTR1
002EF1 E7   
002EF2 FA      8682 JP	M,RESTR1
002EF3 D9   
002EF4 2E   
002EF5 AF      8683 XOR	A
002EF6 47      8684 LD	B,A
002EF7 4E      8685 RESTR2:         LD	C,(HL)
002EF8 B9      8686 CP	C
002EF9 28      8687 JR	Z,NOLINE
002EFA BD   
002EFB 09      8688 ADD	HL,BC
002EFC 1D      8689 DEC	E
002EFD 20      8690 JR	NZ,RESTR2
002EFE F8   
002EFF 18      8691 JR	RESTR1
002F00 D8   
002F01 CD      8699 PTR:            CALL	CHANEL
002F02 D1   
002F03 36   
002F04 CD      8700 CALL	EQUALS
002F05 4F   
002F06 35   
002F07 7B      8701 LD	A,E
002F08 F5      8702 PUSH	AF
002F09 CD      8703 CALL	EXPRI
002F0A 33   
002F0B 18   
002F0C E5      8704 PUSH	HL
002F0D D9      8705 EXX
002F0E D1      8706 POP	DE
002F0F F1      8707 POP	AF
002F10 CD      8708 CALL	PUTPTR
002F11 95   
002F12 06   
002F13 18      8709 JR	XEQGO1ex
002F14 61   
002F15 CD      8711 PAGEV:          CALL	EQUALS
002F16 4F   
002F17 35   
002F18 CD      8712 CALL	EXPRI
002F19 33   
002F1A 18   
002F1B D9      8713 EXX
002F1C 2E      8714 LD	L,0
002F1D 00   
002F1E 22      8715 LD	(PAGE_),HL
002F1F DC   
002F20 54   
002F21 18      8716 JR	XEQGO1ex
002F22 53   
002F23 FE      8718 TIMEV:          CP	'$'
002F24 24   
002F25 28      8719 JR	Z,TIMEVS
002F26 0E   
002F27 CD      8720 CALL	EQUALS
002F28 4F   
002F29 35   
002F2A CD      8721 CALL	EXPRI
002F2B 33   
002F2C 18   
002F2D E5      8722 PUSH	HL
002F2E D9      8723 EXX
002F2F D1      8724 POP	DE
002F30 CD      8725 CALL	PUTIME
002F31 57   
002F32 0D   
002F33 18      8726 JR	XEQGO1ex
002F34 41   
002F35 FD      8728 TIMEVS:         INC	IY		;SKIP '$'
002F36 23   
002F37 CD      8729 CALL	EQUALS
002F38 4F   
002F39 35   
002F3A CD      8730 CALL	EXPRS
002F3B 3C   
002F3C 18   
002F3D CD      8731 CALL	PUTIMS
002F3E 74   
002F3F 0D   
002F40 18      8732 JR	XEQGO1ex
002F41 34   
002F42 CD      8734 LOMEMV:         CALL	EQUALS
002F43 4F   
002F44 35   
002F45 CD      8735 CALL	EXPRI
002F46 33   
002F47 18   
002F48 CD      8736 CALL	CLEAR
002F49 43   
002F4A 40   
002F4B D9      8737 EXX
002F4C 22      8738 LD	(LOMEM),HL
002F4D DE   
002F4E 54   
002F4F 22      8739 LD	(FREE),HL
002F50 E0   
002F51 54   
002F52 18      8740 JR	XEQGO1ex
002F53 22   
002F54 CD      8742 HIMEMV:         CALL	EQUALS
002F55 4F   
002F56 35   
002F57 CD      8743 CALL	EXPRI
002F58 33   
002F59 18   
002F5A D9      8744 EXX
002F5B ED      8745 LD	DE,(FREE)
002F5C 5B   
002F5D E0   
002F5E 54   
002F5F 14      8746 INC	D
002F60 AF      8747 XOR	A
002F61 ED      8748 SBC	HL,DE
002F62 52   
002F63 19      8749 ADD	HL,DE
002F64 DA      8750 JP	C,ERROR_		;"No room"
002F65 44   
002F66 3F   
002F67 ED      8751 LD	DE,(HIMEM)
002F68 5B   
002F69 E2   
002F6A 54   
002F6B 22      8752 LD	(HIMEM),HL
002F6C E2   
002F6D 54   
002F6E EB      8753 EX	DE,HL
002F6F ED      8754 SBC	HL,SP
002F70 72   
002F71 C2      8755 JP	NZ,XEQ
002F72 99   
002F73 24   
002F74 EB      8756 EX	DE,HL
002F75 F9      8757 LD	SP,HL		;LOAD STACK POINTER
002F76 C3      8758 XEQGO1ex:         JP	XEQ
002F77 99   
002F78 24   
002F79 CD      8762 WIDTHV:         CALL	EXPRI
002F7A 33   
002F7B 18   
002F7C D9      8763 EXX
002F7D 7D      8764 LD	A,L
002F7E 32      8765 LD	(WIDTH),A
002F7F FC   
002F80 54   
002F81 18      8766 JR	XEQGO1ex
002F82 F3   
002F83 FD      8772 TRACE:          INC	IY
002F84 23   
002F85 21      8773 LD	HL,0
002F86 00   
002F87 00   
002F88 FE      8774 CP	TON
002F89 EE   
002F8A 28      8775 JR	Z,TRACE0
002F8B 0A   
002F8C FE      8776 CP	TOFF
002F8D 87   
002F8E 28      8777 JR	Z,TRACE1
002F8F 07   
002F90 FD      8778 DEC	IY
002F91 2B   
002F92 CD      8779 CALL	EXPRI
002F93 33   
002F94 18   
002F95 D9      8780 EXX
002F96 2B      8781 TRACE0:         DEC	HL
002F97 22      8782 TRACE1:         LD	(TRACEN),HL
002F98 E6   
002F99 54   
002F9A 18      8783 JR	XEQGO1ex
002F9B DA   
002F9C CD      8787 VDU:            CALL	EXPRI
002F9D 33   
002F9E 18   
002F9F D9      8788 EXX
002FA0 7D      8789 LD	A,L
002FA1 06      8790 LD	B,1
002FA2 01   
002FA3 CD      8791 VDU1:           CALL	OSWRCH
002FA4 B1   
002FA5 05   
002FA6 10      8792 DJNZ	VDU1
002FA7 FB   
002FA8 FD      8793 LD	A,(IY)
002FA9 7E   
002FAA 00   
002FAB FE      8794 CP	'|'
002FAC 7C   
002FAD 28      8795 JR	Z,VDU4
002FAE 15   
002FAF FE      8796 CP	','
002FB0 2C   
002FB1 28      8797 JR	Z,VDU2
002FB2 08   
002FB3 FE      8798 CP	';'
002FB4 3B   
002FB5 20      8799 JR	NZ,VDU3
002FB6 06   
002FB7 7C      8800 LD	A,H
002FB8 CD      8801 CALL	OSWRCH
002FB9 B1   
002FBA 05   
002FBB FD      8802 VDU2:           INC	IY
002FBC 23   
002FBD CD      8803 VDU3:           CALL	TERMQ
002FBE 36   
002FBF 35   
002FC0 20      8804 JR	NZ,VDU
002FC1 DA   
002FC2 18      8805 JR	XEQGO1ex
002FC3 B2   
002FC4 FD      8807 VDU4:           INC	IY
002FC5 23   
002FC6 AF      8808 XOR	A
002FC7 06      8809 LD	B,9
002FC8 09   
002FC9 18      8810 JR	VDU1
002FCA D8   
002FCB CD      8814 CLOSE:          CALL	CHANEL
002FCC D1   
002FCD 36   
002FCE CD      8815 CALL	OSSHUT
002FCF 53   
002FD0 06   
002FD1 18      8816 JR	XEQGO1ex
002FD2 A3   
002FD3 CD      8821 BPUT:           CALL	CHANEL		;CHANNEL NUMBER
002FD4 D1   
002FD5 36   
002FD6 D5      8822 PUSH	DE
002FD7 CD      8823 CALL	COMMA
002FD8 A2   
002FD9 20   
002FDA CD      8824 CALL	EXPR
002FDB 02   
002FDC 17   
002FDD 08      8825 EX	AF,AF'
002FDE FA      8826 JP	M,BPUTS
002FDF EC   
002FE0 2F   
002FE1 CD      8827 CALL	SFIX
002FE2 17   
002FE3 1C   
002FE4 D9      8828 EXX
002FE5 7D      8829 LD	A,L
002FE6 D1      8830 POP	DE
002FE7 CD      8831 CALL	OSBPUT
002FE8 63   
002FE9 06   
002FEA 18      8832 BPUTX:          JR	XEQGO1ex
002FEB 8A   
002FEC 7B      8834 BPUTS:          LD	A,E
002FED D1      8835 POP	DE
002FEE 57      8836 LD	D,A
002FEF 21      8837 LD	HL,ACCS
002FF0 00   
002FF1 52   
002FF2 7E      8838 BPUTS1:         LD	A,(HL)
002FF3 23      8839 INC	HL
002FF4 CD      8840 CALL	OSBPUT
002FF5 63   
002FF6 06   
002FF7 15      8841 DEC	D
002FF8 20      8842 JR	NZ,BPUTS1
002FF9 F8   
002FFA CD      8843 CALL	NXT
002FFB 0B   
002FFC 45   
002FFD FE      8844 CP	';'
002FFE 3B   
002FFF FD      8845 INC	IY
003000 23   
003001 28      8846 JR	Z,BPUTX
003002 E7   
003003 3E      8847 LD	A,LF
003004 0A   
003005 CD      8848 CALL	OSBPUT
003006 63   
003007 06   
003008 FD      8849 DEC	IY
003009 2B   
00300A 18      8850 JR	BPUTX
00300B DE   
00300C CD      8854 CALL:           CALL	EXPRI		;ADDRESS
00300D 33   
00300E 18   
00300F D9      8855 EXX
003010 E5      8856 PUSH	HL		;SAVE IT
003011 06      8857 LD	B,0		;PARAMETER COUNTER
003012 00   
003013 11      8858 LD	DE,BUFFER	;VECTOR
003014 00   
003015 53   
003016 CD      8859 CALL1:          CALL	NXT
003017 0B   
003018 45   
003019 FE      8860 CP	','
00301A 2C   
00301B 20      8861 JR	NZ,CALL2
00301C 17   
00301D FD      8862 INC	IY
00301E 23   
00301F 04      8863 INC	B
003020 CD      8864 CALL	NXT
003021 0B   
003022 45   
003023 C5      8865 PUSH	BC
003024 D5      8866 PUSH	DE
003025 CD      8867 CALL	VAR_
003026 D6   
003027 25   
003028 D1      8868 POP	DE
003029 C1      8869 POP	BC
00302A 13      8870 INC	DE
00302B 12      8871 LD	(DE),A		;PARAMETER TYPE
00302C 13      8872 INC	DE
00302D EB      8873 EX	DE,HL
00302E 73      8874 LD	(HL),E		;PARAMETER ADDRESS
00302F 23      8875 INC	HL
003030 72      8876 LD	(HL),D
003031 EB      8877 EX	DE,HL
003032 18      8878 JR	CALL1
003033 E2   
003034 78      8879 CALL2:          LD	A,B
003035 32      8880 LD	(BUFFER),A	;PARAMETER COUNT
003036 00   
003037 53   
003038 E1      8881 POP	HL		;RESTORE ADDRESS
003039 CD      8882 CALL	USR1
00303A 43   
00303B 30   
00303C C3      8883 JP	XEQ
00303D 99   
00303E 24   
00303F CD      8887 USR:            CALL	ITEMI
003040 60   
003041 18   
003042 D9      8888 EXX
003043 E5      8889 USR1:           PUSH	HL		;ADDRESS ON STACK
003044 FD      8890 EX	(SP),IY
003045 E3   
003046 24      8891 INC	H		;PAGE &FF?
003047 21      8892 LD	HL,USR2		;RETURN ADDRESS
003048 72   
003049 30   
00304A E5      8893 PUSH	HL
00304B DD      8894 LD	IX,STAVAR
00304C 21   
00304D 00   
00304E 54   
00304F CC      8895 CALL	Z,OSCALL	;INTERCEPT PAGE &FF
003050 A8   
003051 10   
003052 DD      8896 LD	C,(IX+24)
003053 4E   
003054 18   
003055 C5      8897 PUSH	BC
003056 F1      8898 POP	AF		;LOAD FLAGS
003057 DD      8899 LD	A,(IX+4)	;LOAD Z80 REGISTERS
003058 7E   
003059 04   
00305A DD      8900 LD	B,(IX+8)
00305B 46   
00305C 08   
00305D DD      8901 LD	C,(IX+12)
00305E 4E   
00305F 0C   
003060 DD      8902 LD	D,(IX+16)
003061 56   
003062 10   
003063 DD      8903 LD	E,(IX+20)
003064 5E   
003065 14   
003066 DD      8904 LD	H,(IX+32)
003067 66   
003068 20   
003069 DD      8905 LD	L,(IX+48)
00306A 6E   
00306B 30   
00306C DD      8906 LD	IX,BUFFER
00306D 21   
00306E 00   
00306F 53   
003070 FD      8907 JP	(IY)		;OFF TO USER ROUTINE
003071 E9   
003072 FD      8908 USR2:           POP	IY
003073 E1   
003074 AF      8909 XOR	A
003075 4F      8910 LD	C,A
003076 C9      8911 RET
003077 CD      8917 LEFTSL:         CALL    GETSTR
003078 BE   
003079 25   
00307A 21      8918 LD	HL,0FF00H	;Default all but last
00307B 00   
00307C FF   
00307D 20      8919 JR	NZ,MIDSL1
00307E 48   
00307F 18      8920 JR	MIDSL0
003080 26   
003081 CD      8922 RITESL:         CALL	GETSTR
003082 BE   
003083 25   
003084 21      8923 LD	HL,0FFFFH	;Default last char only
003085 FF   
003086 FF   
003087 20      8924 JR	NZ,MIDSL1
003088 3E   
003089 18      8925 JR	MIDSL0
00308A 1C   
00308B CD      8927 MIDSL:          CALL	GETSTR
00308C BE   
00308D 25   
00308E 3E      8928 LD	A,5
00308F 05   
003090 C2      8929 JP	NZ,ERROR_	;'Missing comma'
003091 44   
003092 3F   
003093 FD      8930 INC	IY
003094 23   
003095 DD      8931 PUSH	IX
003096 E5   
003097 CD      8932 CALL	EXPRI
003098 33   
003099 18   
00309A DD      8933 POP	IX
00309B E1   
00309C D9      8934 EXX
00309D CD      8935 CALL	NXT
00309E 0B   
00309F 45   
0030A0 2D      8936 DEC	L
0030A1 26      8937 LD	H,254		;Default rest of string
0030A2 FE   
0030A3 FE      8938 CP	','
0030A4 2C   
0030A5 20      8939 JR	NZ,MIDSL1
0030A6 20   
0030A7 FD      8940 MIDSL0:         INC	IY
0030A8 23   
0030A9 E5      8941 PUSH	HL
0030AA DD      8942 PUSH	IX
0030AB E5   
0030AC CD      8943 CALL	EXPRI
0030AD 33   
0030AE 18   
0030AF DD      8944 POP	IX
0030B0 E1   
0030B1 D9      8945 EXX
0030B2 7D      8946 LD	A,L
0030B3 E1      8947 POP	HL
0030B4 B7      8948 OR	A
0030B5 28      8949 JR	Z,MIDSL2	;Zero length
0030B6 0D   
0030B7 3D      8950 DEC	A
0030B8 85      8951 ADD	A,L
0030B9 67      8952 LD	H,A
0030BA 30      8953 JR	NC,MIDSL1
0030BB 0B   
0030BC 7D      8954 LD	A,L
0030BD 3C      8955 INC	A
0030BE 28      8956 JR	Z,MIDSL1
0030BF 07   
0030C0 26      8957 LD	H,254
0030C1 FE   
0030C2 18      8958 JR	MIDSL1
0030C3 03   
0030C4 21      8960 MIDSL2:         LD	HL,1
0030C5 01   
0030C6 00   
0030C7 CD      8961 MIDSL1:         CALL	BRAKET
0030C8 AE   
0030C9 20   
0030CA CD      8962 CALL	EQUALS
0030CB 4F   
0030CC 35   
0030CD E5      8963 PUSH	HL
0030CE DD      8964 PUSH	IX
0030CF E5   
0030D0 CD      8965 CALL	EXPRS
0030D1 3C   
0030D2 18   
0030D3 DD      8966 POP	IX
0030D4 E1   
0030D5 E1      8967 POP	HL
0030D6 4B      8968 LD	C,E
0030D7 DD      8969 LD	B,(IX+0)
0030D8 46   
0030D9 00   
0030DA DD      8970 LD	E,(IX+2)
0030DB 5E   
0030DC 02   
0030DD DD      8971 LD	D,(IX+3)
0030DE 56   
0030DF 03   
0030E0 7D      8982 LD	A,L
0030E1 3C      8983 INC	A
0030E2 20      8984 JR	NZ,SUBSL1
0030E3 0F   
0030E4 24      8985 INC	H
0030E5 24      8986 INC	H
0030E6 79      8987 LD	A,C
0030E7 BC      8988 CP	H
0030E8 30      8989 JR	NC,SUBSL0
0030E9 01   
0030EA 67      8990 LD	H,A
0030EB 78      8991 SUBSL0:         LD	A,B
0030EC 94      8992 SUB	H
0030ED 30      8993 JR	NC,SUBSL6
0030EE 01   
0030EF AF      8994 XOR	A
0030F0 6F      8995 SUBSL6:         LD	L,A
0030F1 18      8996 JR	SUBSL5
0030F2 12   
0030F3 7C      8998 SUBSL1:         LD	A,H
0030F4 3C      8999 INC	A
0030F5 20      9000 JR	NZ,SUBSL2
0030F6 06   
0030F7 78      9001 LD	A,B
0030F8 D6      9002 SUB	2
0030F9 02   
0030FA 38      9003 JR	C,SUBSL9
0030FB 24   
0030FC 67      9004 LD	H,A
0030FD 7D      9005 SUBSL2:         LD	A,L
0030FE B8      9006 CP	B
0030FF 30      9007 JR	NC,SUBSL9
003100 1F   
003101 7C      9008 LD	A,H
003102 B8      9009 CP	B
003103 38      9010 JR	C,SUBSL3
003104 03   
003105 78      9011 SUBSL5:         LD	A,B
003106 3D      9012 DEC	A
003107 67      9013 LD	H,A
003108 7C      9014 SUBSL3:         LD	A,H
003109 95      9015 SUB	L
00310A 38      9016 JR	C,SUBSL9
00310B 14   
00310C 3C      9017 INC	A
00310D B9      9018 CP	C
00310E 38      9019 JR	C,SUBSL4
00310F 01   
003110 79      9020 LD	A,C
003111 06      9021 SUBSL4:         LD	B,0
003112 00   
003113 60      9022 LD	H,B
003114 4F      9023 LD	C,A
003115 B7      9024 OR	A
003116 28      9025 JR	Z,SUBSL9
003117 08   
003118 EB      9026 EX	DE,HL
003119 19      9027 ADD	HL,DE
00311A EB      9028 EX	DE,HL
00311B 21      9029 LD	HL,ACCS
00311C 00   
00311D 52   
00311E ED      9030 LDIR
00311F B0   
003120 C3      9031 SUBSL9:         JP	XEQ
003121 99   
003122 24   
003123 FD      9037 EXITex:           INC	IY		;Skip FOR/REPEAT/WHILE
003124 23   
003125 FE      9038 CP	TFOR
003126 E3   
003127 20      9039 JR	NZ,EXIT0
003128 0C   
003129 DD      9040 LD	IX,0		;For EXITex FOR <var>
00312A 21   
00312B 00   
00312C 00   
00312D CD      9041 CALL	TERMQ
00312E 36   
00312F 35   
003130 C4      9042 CALL	NZ,GETVAR
003131 E3   
003132 41   
003133 3E      9043 LD	A,TFOR
003134 E3   
003135 16      9044 EXIT0:          LD	D,1		;Level for WSRCH
003136 01   
003137 5F      9045 LD	E,A
003138 7B      9046 EXIT1:          LD	A,E
003139 C1      9047 POP	BC		;Marker
00313A 21      9048 LD	HL,FORCHK
00313B 61   
00313C 29   
00313D B7      9049 OR	A
00313E ED      9050 SBC	HL,BC
00313F 42   
003140 28      9051 JR	Z,EXIT4
003141 25   
003142 21      9052 LD	HL,REPCHK
003143 ED   
003144 28   
003145 B7      9053 OR	A
003146 ED      9054 SBC	HL,BC
003147 42   
003148 28      9055 JR	Z,EXIT6
003149 38   
00314A 21      9056 LD	HL,WHICHK
00314B 2E   
00314C 2E   
00314D B7      9057 OR	A
00314E ED      9058 SBC	HL,BC
00314F 42   
003150 28      9059 JR	Z,EXIT7
003151 3A   
003152 C5      9060 PUSH	BC		;Put back marker
003153 DD      9061 PUSH	IX
003154 E5   
003155 C1      9062 POP	BC
003156 D9      9063 EXX
003157 3E      9064 LD	A,3
003158 03   
003159 CD      9065 CALL	RESLOC
00315A 31   
00315B 34   
00315C D9      9066 EXX
00315D C5      9067 PUSH	BC
00315E DD      9068 POP	IX
00315F E1   
003160 20      9069 JR	NZ,EXIT1
003161 D6   
003162 3E      9070 LD	A,44
003163 2C   
003164 C3      9071 JP	ERROR_		;'Bad EXITex'
003165 44   
003166 3F   
003167 C1      9073 EXIT4:          POP	BC		;VARPTR
003168 21      9074 LD	HL,14		;Skip text pointer, limit & step
003169 0E   
00316A 00   
00316B 39      9075 ADD	HL,SP
00316C F9      9076 LD	SP,HL		;Pop FOR record
00316D FE      9077 CP	TFOR
00316E E3   
00316F 20      9078 JR	NZ,EXIT1
003170 C7   
003171 DD      9079 PUSH	IX
003172 E5   
003173 E1      9080 POP	HL
003174 7C      9081 LD	A,H
003175 B5      9082 OR	L
003176 28      9083 JR	Z,EXIT5
003177 02   
003178 ED      9084 SBC	HL,BC
003179 42   
00317A 01      9085 EXIT5:          LD	BC,TFOR+TNEXT*256
00317B 00   
00317C D0   
00317D 28      9086 JR	Z,EXIT8
00317E 15   
00317F 14      9087 INC	D		;Count nested FOR loops
003180 18      9088 JR	EXIT1
003181 B6   
003182 C1      9090 EXIT6:          POP	BC		;Text pointer
003183 FE      9091 CP	TREPEAT
003184 F5   
003185 20      9092 JR	NZ,EXIT1
003186 B1   
003187 01      9093 LD	BC,TREPEAT+TUNTIL*256
003188 00   
003189 F2   
00318A 18      9094 JR	EXIT8
00318B 08   
00318C C1      9096 EXIT7:          POP	BC		;Text pointer
00318D FE      9097 CP	TWHILE
00318E C7   
00318F 20      9098 JR	NZ,EXIT1
003190 A7   
003191 01      9099 LD	BC,TWHILE+TENDWHILE*256
003192 00   
003193 95   
003194 CD      9100 EXIT8:          CALL	WSRCH
003195 50   
003196 36   
003197 CD      9101 CALL	SPAN		;Skip UNTIL expression
003198 42   
003199 35   
00319A C3      9102 JP	XEQ
00319B 99   
00319C 24   
00319D CD      9106 PUT:            CALL	EXPRI		;PORT ADDRESS
00319E 33   
00319F 18   
0031A0 D9      9107 EXX
0031A1 E5      9108 PUSH	HL
0031A2 CD      9109 CALL	COMMA
0031A3 A2   
0031A4 20   
0031A5 CD      9110 CALL	EXPRI		;DATA
0031A6 33   
0031A7 18   
0031A8 D9      9111 EXX
0031A9 C1      9112 POP	BC
0031AA ED      9113 OUT	(C),L		;OUTPUT TO PORT BC
0031AB 69   
0031AC C3      9114 JP	XEQ
0031AD 99   
0031AE 24   
0031AF CD      9125 ASSIGN:         CALL	GETVAR		;VARIABLE
0031B0 E3   
0031B1 41   
0031B2 D8      9126 RET	C		;ILLEGAL VARIABLE
0031B3 C4      9127 CALL	NZ,PUTVAR
0031B4 CD   
0031B5 41   
0031B6 57      9128 LD	D,A		;Type
0031B7 CD      9129 CALL	NXT
0031B8 0B   
0031B9 45   
0031BA FD      9130 INC	IY
0031BB 23   
0031BC 5F      9131 LD	E,A		;Operator (or =)
0031BD FE      9132 CP	'='
0031BE 3D   
0031BF C4      9133 CALL	NZ,EQUALS
0031C0 4F   
0031C1 35   
0031C2 7A      9134 LD	A,D
0031C3 E6      9135 AND	11000000B
0031C4 C0   
0031C5 C0      9136 RET	NZ		;String or array
0031C6 D5      9137 PUSH	DE
0031C7 E5      9138 PUSH	HL
0031C8 CD      9139 CALL	EXPRN
0031C9 2C   
0031CA 18   
0031CB DD      9140 POP	IX
0031CC E1   
0031CD D1      9141 POP	DE
0031CE 7B      9152 MODIFY:         LD	A,E
0031CF FE      9153 CP	'='
0031D0 3D   
0031D1 28      9154 JR	Z,STORE0	;Simple assignment
0031D2 1C   
0031D3 D5      9155 PUSH	DE
0031D4 D9      9156 EXX
0031D5 EB      9157 EX	DE,HL
0031D6 D9      9158 EXX
0031D7 EB      9159 EX	DE,HL
0031D8 41      9160 LD	B,C
0031D9 E3      9161 EX	(SP),HL
0031DA 7C      9162 LD	A,H
0031DB E3      9163 EX	(SP),HL
0031DC CD      9164 CALL	LOADN
0031DD 25   
0031DE 19   
0031DF E3      9165 EX	(SP),HL
0031E0 7D      9166 LD	A,L
0031E1 E3      9167 EX	(SP),HL
0031E2 E6      9168 AND	15
0031E3 0F   
0031E4 DD      9169 PUSH	IX
0031E5 E5   
0031E6 CD      9170 CALL	FPP
0031E7 15   
0031E8 45   
0031E9 DD      9171 POP	IX
0031EA E1   
0031EB D1      9172 POP	DE
0031EC DA      9173 JP	C,ERROR_
0031ED 44   
0031EE 3F   
0031EF 7A      9174 STORE0:         LD	A,D		;Type
0031F0 FE      9175 STOREN:         CP	5
0031F1 05   
0031F2 28      9176 JR	Z,STORE5
0031F3 12   
0031F4 F5      9177 PUSH	AF
0031F5 0C      9178 INC	C		;SPEED - & PRESERVE F'
0031F6 0D      9179 DEC	C		; WHEN CALLED BY FNEND0
0031F7 C4      9180 CALL	NZ,SFIX		;CONVERT TO INTEGER
0031F8 17   
0031F9 1C   
0031FA F1      9181 POP	AF
0031FB FE      9182 CP	4
0031FC 04   
0031FD 28      9183 JR	Z,STORE4
0031FE 0A   
0031FF BF      9184 CP	A		;SET ZERO
003200 D9      9185 STORE1:         EXX
003201 DD      9186 LD	(IX+0),L
003202 75   
003203 00   
003204 D9      9187 EXX
003205 C9      9188 RET
003206 DD      9190 STORE5:         LD	(IX+4),C
003207 71   
003208 04   
003209 D9      9191 STORE4:         EXX
00320A DD      9192 LD	(IX+0),L
00320B 75   
00320C 00   
00320D DD      9193 LD	(IX+1),H
00320E 74   
00320F 01   
003210 D9      9194 EXX
003211 DD      9195 LD	(IX+2),L
003212 75   
003213 02   
003214 DD      9196 LD	(IX+3),H
003215 74   
003216 03   
003217 C9      9197 RET
003218 7D      9206 MODIFS:         LD	A,L		;Operator
003219 FE      9207 CP	'+'
00321A 2B   
00321B 7C      9208 LD	A,H		;Type
00321C 20      9209 JR	NZ,STACCS
00321D 20   
00321E FD      9210 PUSH	IY
00321F E5   
003220 DD      9211 PUSH	IX
003221 E5   
003222 FD      9212 POP	IY
003223 E1   
003224 CD      9213 CALL	PUSHS
003225 19   
003226 20   
003227 FD      9214 PUSH	IY
003228 E5   
003229 DD      9215 POP	IX
00322A E1   
00322B CD      9216 CALL	LOADS
00322C 0E   
00322D 1A   
00322E C1      9217 POP	BC
00322F 78      9218 LD	A,B		;Type
003230 0C      9219 INC	C
003231 0D      9220 DEC	C
003232 28      9221 JR	Z,MODFS1	;Zero length
003233 08   
003234 21      9222 LD	HL,0
003235 00   
003236 00   
003237 44      9223 LD	B,H
003238 39      9224 ADD	HL,SP
003239 ED      9225 LDIR
00323A B0   
00323B F9      9226 LD	SP,HL
00323C FD      9227 MODFS1:         POP	IY
00323D E1   
00323E 21      9231 STACCS:         LD	HL,ACCS
00323F 00   
003240 52   
003241 1F      9232 STORES:         RRA
003242 30      9233 JR	NC,STORS3	;FIXED STRING
003243 4F   
003244 E5      9234 PUSH	HL
003245 CD      9235 CALL	LOAD4
003246 32   
003247 19   
003248 7B      9236 LD	A,E		;LENGTH OF STRING
003249 D9      9237 EXX
00324A 6F      9238 LD	L,A
00324B 7C      9239 LD	A,H		;LENGTH ALLOCATED
00324C D9      9240 EXX
00324D BB      9241 CP	E
00324E 30      9242 JR	NC,STORS1	;ENOUGH ROOM
00324F 24   
003250 D9      9243 EXX
003251 65      9244 LD	H,L
003252 D9      9245 EXX
003253 E5      9246 PUSH	HL
003254 06      9247 LD	B,0
003255 00   
003256 4F      9248 LD	C,A
003257 09      9249 ADD	HL,BC
003258 ED      9250 LD	BC,(FREE)
003259 4B   
00325A E0   
00325B 54   
00325C ED      9251 SBC	HL,BC		;IS STRING LAST?
00325D 42   
00325E E1      9252 POP	HL
00325F 28      9253 JR	Z,STORS0
003260 12   
003261 60      9254 LD	H,B
003262 69      9255 LD	L,C		;DESTINATION
003263 B7      9257 OR	A		;V5 optimisation
003264 28      9258 JR	Z,STORS0
003265 0D   
003266 7B      9259 LD	A,E
003267 5F      9260 STORS2:         LD	E,A
003268 1D      9261 DEC	E
003269 A3      9262 AND	E
00326A 20      9263 JR	NZ,STORS2
00326B FB   
00326C 37      9264 SCF
00326D CB      9265 RL	E
00326E 13   
00326F 7B      9266 LD	A,E
003270 D9      9267 EXX
003271 67      9268 LD	H,A
003272 D9      9269 EXX
003273 37      9271 STORS0:         SCF
003274 CD      9272 STORS1:         CALL	STORE4		;PRESERVES CARRY!
003275 09   
003276 32   
003277 06      9273 LD	B,0
003278 00   
003279 4B      9274 LD	C,E
00327A EB      9275 EX	DE,HL
00327B E1      9276 POP	HL
00327C 0D      9277 DEC	C
00327D 0C      9278 INC	C
00327E C8      9279 RET	Z		;NULL STRING
00327F ED      9280 LDIR
003280 B0   
003281 D0      9281 RET	NC		;STRING REPLACED
003282 ED      9282 LD	(FREE),DE
003283 53   
003284 E0   
003285 54   
003286 E5      9283 CHECK:          PUSH	HL
003287 2A      9284 LD	HL,(FREE)
003288 E0   
003289 54   
00328A 24      9285 INC	H
00328B ED      9286 SBC	HL,SP
00328C 72   
00328D E1      9287 POP	HL
00328E D8      9288 RET	C
00328F AF      9289 XOR	A
003290 C3      9290 JP	ERROR_		;"No room"
003291 44   
003292 3F   
003293 4B      9292 STORS3:         LD	C,E
003294 DD      9293 PUSH	IX
003295 E5   
003296 D1      9294 POP	DE
003297 AF      9295 XOR	A
003298 47      9296 LD	B,A
003299 B9      9297 CP	C
00329A 28      9298 JR	Z,STORS5
00329B 02   
00329C ED      9299 LDIR
00329D B0   
00329E 3E      9300 STORS5:         LD	A,CR
00329F 0D   
0032A0 12      9301 LD	(DE),A
0032A1 C9      9302 RET
0032A2 DD      9306 SAVRET:         LD	(IX+0),L		;Formal VARPTR
0032A3 75   
0032A4 00   
0032A5 DD      9307 LD	(IX+1),H
0032A6 74   
0032A7 01   
0032A8 DD      9308 LD	(IX+2),A
0032A9 77   
0032AA 02   
0032AB FD      9309 EX	(SP),IY
0032AC E3   
0032AD F5      9310 PUSH	AF
0032AE FD      9311 PUSH	IY
0032AF E5   
0032B0 DD      9312 PUSH	IX
0032B1 E5   
0032B2 CD      9313 CALL	NXT
0032B3 0B   
0032B4 45   
0032B5 CD      9314 CALL	VAR_
0032B6 D6   
0032B7 25   
0032B8 DD      9315 POP	IX
0032B9 E1   
0032BA DD      9316 LD	(IX+4),L		;Actual VARPTR
0032BB 75   
0032BC 04   
0032BD DD      9317 LD	(IX+5),H
0032BE 74   
0032BF 05   
0032C0 DD      9318 LD	(IX+6),A
0032C1 77   
0032C2 06   
0032C3 FD      9319 POP	IY
0032C4 E1   
0032C5 F1      9320 POP	AF
0032C6 01      9321 LD	BC,8
0032C7 08   
0032C8 00   
0032C9 DD      9322 ADD	IX,BC
0032CA 09   
0032CB 18      9323 JR	ARGUE0
0032CC 2D   
0032CD 3E      9335 ARGUE:          LD	A,-1
0032CE FF   
0032CF F5      9336 PUSH	AF		;PUT MARKER ON STACK
0032D0 FD      9337 ARGUE1:         INC	IY		;BUMP PAST ( | ,
0032D1 23   
0032D2 13      9338 INC	DE
0032D3 D5      9339 PUSH	DE
0032D4 06      9340 LD	B,0
0032D5 00   
0032D6 CD      9341 CALL	NXT
0032D7 0B   
0032D8 45   
0032D9 FE      9342 CP	TRETURN
0032DA F8   
0032DB 20      9343 JR	NZ,ARGUE9
0032DC 06   
0032DD FD      9344 INC	IY		;SKIP 'RETURN'
0032DE 23   
0032DF CD      9345 CALL	NXT
0032E0 0B   
0032E1 45   
0032E2 04      9346 INC	B		;FLAG 'RETURN'
0032E3 C5      9347 ARGUE9:         PUSH	BC
0032E4 DD      9348 PUSH	IX
0032E5 E5   
0032E6 CD      9349 CALL	GETVAR		;FORMAL PARAMETER
0032E7 E3   
0032E8 41   
0032E9 38      9350 JR	C,ARGERR
0032EA 49   
0032EB C4      9351 CALL	NZ,PUTVAR
0032EC CD   
0032ED 41   
0032EE DD      9352 POP	IX
0032EF E1   
0032F0 C1      9353 POP	BC
0032F1 D1      9354 POP	DE
0032F2 E5      9355 PUSH	HL		;VARPTR
0032F3 F5      9356 PUSH	AF
0032F4 D5      9357 PUSH	DE
0032F5 05      9358 DEC	B
0032F6 28      9359 JR	Z,SAVRET
0032F7 AA   
0032F8 FD      9360 EX	(SP),IY
0032F9 E3   
0032FA CB      9361 ARGUE0:         BIT	6,A		;ARRAY?
0032FB 77   
0032FC 20      9362 JR	NZ,ARGUE3
0032FD 3B   
0032FE B7      9363 OR	A		;TYPE
0032FF FA      9364 JP	M,ARGUE2	;STRING
003300 15   
003301 33   
003302 DD      9365 PUSH	IX
003303 E5   
003304 CD      9366 CALL	EXPRN		;ACTUAL PARAMETER
003305 2C   
003306 18   
003307 DD      9367 POP	IX
003308 E1   
003309 FD      9368 EX	(SP),IY
00330A E3   
00330B D1      9369 POP	DE
00330C F1      9370 POP	AF
00330D D9      9371 EXX
00330E E5      9372 PUSH	HL
00330F D9      9373 EXX
003310 E5      9374 PUSH	HL
003311 47      9375 LD	B,A
003312 C5      9376 PUSH	BC
003313 18      9377 JR	ARGUE4
003314 13   
003315 DD      9379 ARGUE2:         PUSH	IX
003316 E5   
003317 CD      9380 CALL	EXPRS
003318 3C   
003319 18   
00331A D9      9381 EXX
00331B C1      9382 POP	BC
00331C FD      9383 EX	(SP),IY
00331D E3   
00331E D1      9384 POP	DE
00331F D9      9385 EXX
003320 F1      9386 POP	AF
003321 CD      9387 CALL	PUSHS
003322 19   
003323 20   
003324 D9      9388 EXX
003325 C5      9389 PUSH	BC
003326 DD      9390 POP	IX
003327 E1   
003328 CD      9391 ARGUE4:         CALL	NXT
003329 0B   
00332A 45   
00332B FE      9392 CP	','
00332C 2C   
00332D 20      9393 JR	NZ,ARGUE5
00332E 27   
00332F 1A      9394 LD	A,(DE)
003330 FE      9395 CP	','
003331 2C   
003332 28      9396 JR	Z,ARGUE1	;ANOTHER
003333 9C   
003334 3E      9397 ARGERR:         LD	A,31
003335 1F   
003336 C3      9398 JP	ERROR_		;"Bad arguments"
003337 44   
003338 3F   
003339 DD      9400 ARGUE3:         PUSH	IX
00333A E5   
00333B CD      9401 CALL	NXT
00333C 0B   
00333D 45   
00333E CD      9402 CALL	GETVAR
00333F E3   
003340 41   
003341 38      9403 JR	C,ARGERR
003342 F1   
003343 DD      9404 LD	C,(IX+0)
003344 4E   
003345 00   
003346 DD      9405 LD	B,(IX+1)
003347 46   
003348 01   
003349 DD      9406 POP	IX
00334A E1   
00334B CD      9407 CALL	NXT
00334C 0B   
00334D 45   
00334E FD      9408 EX	(SP),IY
00334F E3   
003350 D1      9409 POP	DE
003351 F1      9410 POP	AF
003352 C5      9411 PUSH	BC		;STACK ARRAY POINTER
003353 F5      9412 PUSH	AF		;STACK TYPE
003354 18      9413 JR	ARGUE4
003355 D2   
003356 CD      9415 ARGUE5:         CALL	BRAKET
003357 AE   
003358 20   
003359 1A      9416 LD	A,(DE)
00335A FE      9417 CP	')'
00335B 29   
00335C 20      9418 JR	NZ,ARGERR
00335D D6   
00335E 13      9419 INC	DE
00335F D9      9420 UNSTAK:         EXX
003360 C1      9421 ARGUE6:         POP	BC
003361 78      9422 LD	A,B
003362 3C      9423 INC	A
003363 D9      9424 EXX
003364 C8      9425 RET	Z		;MARKER POPPED
003365 D9      9426 EXX
003366 3D      9427 DEC	A
003367 CB      9428 BIT	6,A		;ARRAY
003368 77   
003369 20      9429 JR	NZ,ARGUE8
00336A 19   
00336B B7      9430 OR	A
00336C FA      9431 JP	M,ARGUE7	;STRING
00336D 7A   
00336E 33   
00336F E1      9432 POP	HL
003370 D9      9433 EXX
003371 E1      9434 POP	HL
003372 D9      9435 EXX
003373 DD      9436 POP	IX
003374 E1   
003375 CD      9437 CALL	STOREN		;WRITE TO DUMMY
003376 F0   
003377 31   
003378 18      9438 JR	ARGUE6
003379 E6   
00337A CD      9440 ARGUE7:         CALL	POPS
00337B 37   
00337C 20   
00337D DD      9441 POP	IX
00337E E1   
00337F CD      9442 CALL	STACCS
003380 3E   
003381 32   
003382 18      9443 JR	ARGUE6
003383 DC   
003384 C1      9445 ARGUE8:         POP	BC		;ARRAY POINTER
003385 DD      9446 POP	IX
003386 E1   
003387 DD      9447 LD	(IX+0),C
003388 71   
003389 00   
00338A DD      9448 LD	(IX+1),B
00338B 70   
00338C 01   
00338D 18      9449 JR	ARGUE6
00338E D1   
00338F 3E      9454 RETXFR:         LD	A,-1
003390 FF   
003391 F5      9455 PUSH	AF		;PUT MARKER ON STACK
003392 D9      9456 RETXF1:         EXX
003393 DD      9457 LD	L,(IX+4)	;Actual parameter (destination)
003394 6E   
003395 04   
003396 DD      9458 LD	H,(IX+5)
003397 66   
003398 05   
003399 E5      9459 PUSH	HL		;STACK VARPTR
00339A DD      9460 LD	L,(IX+0)	;Formal parameter (source)
00339B 6E   
00339C 00   
00339D DD      9461 LD	H,(IX+1)
00339E 66   
00339F 01   
0033A0 DD      9462 LD	A,(IX+2)
0033A1 7E   
0033A2 02   
0033A3 CB      9463 BIT	6,A		;ARRAY?
0033A4 77   
0033A5 20      9464 JR	NZ,RETXF3
0033A6 19   
0033A7 B7      9465 OR	A		;TYPE
0033A8 FA      9466 JP	M,RETXF2	;STRING
0033A9 C6   
0033AA 33   
0033AB E5      9467 PUSH	HL
0033AC DD      9468 EX	(SP),IX
0033AD E3   
0033AE CD      9469 CALL	LOADN
0033AF 25   
0033B0 19   
0033B1 DD      9470 POP	IX
0033B2 E1   
0033B3 D9      9471 EXX			;STACK VALUE
0033B4 E5      9472 PUSH	HL
0033B5 D9      9473 EXX
0033B6 E5      9474 PUSH	HL
0033B7 DD      9475 RETXF6:         LD	B,(IX+6)
0033B8 46   
0033B9 06   
0033BA C5      9476 PUSH	BC		;TYPE & EXPONENT
0033BB CD      9477 RETXF5:         CALL	CHECK		;CHECK ROOM
0033BC 86   
0033BD 32   
0033BE 18      9478 JR	RETXF4
0033BF 1E   
0033C0 5E      9480 RETXF3:         LD	E,(HL)
0033C1 23      9481 INC	HL
0033C2 56      9482 LD	D,(HL)
0033C3 D5      9483 PUSH	DE		;STACK ARRAY POINTER
0033C4 18      9484 JR	RETXF6
0033C5 F1   
0033C6 E5      9486 RETXF2:         PUSH	HL
0033C7 DD      9487 EX	(SP),IX
0033C8 E3   
0033C9 CD      9488 CALL	LOADS
0033CA 0E   
0033CB 1A   
0033CC DD      9489 POP	IX
0033CD E1   
0033CE DD      9490 LD	A,(IX+6)
0033CF 7E   
0033D0 06   
0033D1 D9      9491 EXX
0033D2 DD      9492 PUSH	IX
0033D3 E5   
0033D4 E1      9493 POP	HL
0033D5 D9      9494 EXX
0033D6 CD      9495 CALL	PUSHS
0033D7 19   
0033D8 20   
0033D9 D9      9496 EXX
0033DA E5      9497 PUSH	HL
0033DB DD      9498 POP	IX
0033DC E1   
0033DD D9      9499 EXX
0033DE 11      9500 RETXF4:         LD	DE,8
0033DF 08   
0033E0 00   
0033E1 DD      9501 ADD	IX,DE
0033E2 19   
0033E3 D9      9502 EXX
0033E4 10      9503 DJNZ	RETXF1
0033E5 AC   
0033E6 C3      9504 JP	UNSTAK
0033E7 5F   
0033E8 33   
0033E9 C1      9508 RESRET:         POP	BC		;B = 'RETURN' COUNT
0033EA 26      9509 LD	H,0
0033EB 00   
0033EC 68      9510 LD	L,B
0033ED 29      9511 ADD	HL,HL
0033EE 29      9512 ADD	HL,HL
0033EF 29      9513 ADD	HL,HL		;RETURN COUNT * 8
0033F0 39      9514 ADD	HL,SP
0033F1 DD      9515 LD	IX,0
0033F2 21   
0033F3 00   
0033F4 00   
0033F5 DD      9516 ADD	IX,SP		;ADDRESS PARAMETER LIST
0033F6 39   
0033F7 F5      9517 PUSH	AF
0033F8 D5      9518 PUSH	DE
0033F9 E5      9519 PUSH	HL
0033FA D9      9520 EXX
0033FB C5      9521 PUSH	BC
0033FC D5      9522 PUSH	DE
0033FD D9      9523 EXX
0033FE 78      9524 LD	A,B
0033FF 21      9525 LD	HL,ACCS
003400 00   
003401 52   
003402 11      9526 LD	DE,BUFFER
003403 00   
003404 53   
003405 01      9527 LD	BC,255
003406 FF   
003407 00   
003408 ED      9528 LDIR
003409 B0   
00340A 47      9529 LD	B,A
00340B CD      9530 CALL	RETXFR		;TRANSFER VIA STACK
00340C 8F   
00340D 33   
00340E 21      9531 LD	HL,BUFFER
00340F 00   
003410 53   
003411 11      9532 LD	DE,ACCS
003412 00   
003413 52   
003414 01      9533 LD	BC,255
003415 FF   
003416 00   
003417 ED      9534 LDIR
003418 B0   
003419 D9      9535 EXX
00341A D1      9536 POP	DE
00341B C1      9537 POP	BC
00341C D9      9538 EXX
00341D E1      9539 POP	HL
00341E D1      9540 POP	DE
00341F F1      9541 POP	AF
003420 18      9542 JR	RESAR1
003421 0A   
003422 C1      9546 RESARR:         POP	BC
003423 CB      9547 BIT	7,B		;String array?
003424 78   
003425 E1      9548 POP	HL
003426 C1      9549 POP	BC
003427 09      9550 ADD	HL,BC
003428 39      9551 ADD	HL,SP
003429 C4      9552 CALL	NZ,FREESA	;Free string array
00342A E3   
00342B 36   
00342C F9      9553 RESAR1:         LD	SP,HL
00342D DD      9554 INC	IX		;Flag something restored
00342E 23   
00342F 18      9555 JR	RESLO1
003430 05   
003431 D1      9562 RESLOC:         POP	DE		;Return address
003432 DD      9563 LD	IX,0		;To flag nothing was restored
003433 21   
003434 00   
003435 00   
003436 C1      9564 RESLO1:         POP	BC		;Marker ?
003437 21      9565 LD	HL,LOCCHK
003438 2A   
003439 35   
00343A B7      9566 OR	A
00343B ED      9567 SBC	HL,BC
00343C 42   
00343D 28      9568 JR	Z,RESLO2	;Something to restore
00343E 1A   
00343F B7      9569 OR	A
003440 20      9570 JR	NZ,RESLO8
003441 0F   
003442 21      9571 LD	HL,RETCHK
003443 70   
003444 2A   
003445 ED      9572 SBC	HL,BC
003446 42   
003447 28      9573 JR	Z,RESRET
003448 A0   
003449 21      9574 LD	HL,ARRCHK
00344A DC   
00344B 26   
00344C B7      9575 OR	A
00344D ED      9576 SBC	HL,BC
00344E 42   
00344F 28      9577 JR	Z,RESARR
003450 D1   
003451 DD      9578 RESLO8:         PUSH	IX
003452 E5   
003453 E1      9579 POP	HL
003454 7C      9580 LD	A,H
003455 B5      9581 OR	L
003456 C5      9582 RESLO0:         PUSH	BC		;Put back marker
003457 EB      9583 EX	DE,HL
003458 E9      9584 JP	(HL)		;Return
003459 DD      9586 RESLO2:         POP	IX		;Variable pointer
00345A E1   
00345B B7      9587 OR	A
00345C 28      9588 JR	Z,RESLO3	;Everything allowed
00345D 20   
00345E DD      9589 PUSH	IX
00345F E5   
003460 C1      9590 POP	BC
003461 CB      9591 BIT	0,A
003462 47   
003463 28      9592 JR	Z,RESLO6	;Bit 0 set, so
003464 07   
003465 21      9593 LD	HL,DATPTR	;test for DATPTR
003466 F0   
003467 54   
003468 ED      9594 SBC	HL,BC
003469 42   
00346A 28      9595 JR	Z,RESLO3
00346B 12   
00346C B7      9596 RESLO6:         OR	A
00346D CB      9597 BIT	1,A
00346E 4F   
00346F 28      9598 JR	Z,RESLO7	;Bit 1 set, so
003470 07   
003471 21      9599 LD	HL,ERRTRP	;test for ERRPTR
003472 EA   
003473 54   
003474 ED      9600 SBC	HL,BC
003475 42   
003476 28      9601 JR	Z,RESLO3
003477 06   
003478 C5      9602 RESLO7:         PUSH	BC		;Put back pointer
003479 01      9603 LD	BC,LOCCHK
00347A 2A   
00347B 35   
00347C 18      9604 JR	RESLO0
00347D D8   
00347E C1      9606 RESLO3:         POP	BC		;Type / exponent
00347F CB      9607 BIT	6,B
003480 70   
003481 20      9608 JR	NZ,RESLO4	;Array?
003482 14   
003483 CB      9609 BIT	7,B
003484 78   
003485 20      9610 JR	NZ,RESLO5	;String?
003486 23   
003487 E1      9611 POP	HL
003488 D9      9612 EXX
003489 E1      9613 POP	HL
00348A D9      9614 EXX
00348B CB      9615 BIT	4,B
00348C 60   
00348D 20      9616 JR	NZ,RESLO1
00348E A7   
00348F F5      9617 PUSH	AF
003490 78      9618 LD	A,B
003491 CD      9619 CALL	STOREN		;Numeric
003492 F0   
003493 31   
003494 F1      9620 POP	AF
003495 18      9621 JR	RESLO1
003496 9F   
003497 E1      9623 RESLO4:         POP	HL
003498 CB      9624 BIT	4,B
003499 60   
00349A 20      9625 JR	NZ,RESLO1
00349B 9A   
00349C DD      9626 LD	(IX+0),L	;Array
00349D 75   
00349E 00   
00349F DD      9627 LD	(IX+1),H
0034A0 74   
0034A1 01   
0034A2 18      9628 JR	RESLO1
0034A3 92   
0034A4 06      9630 RESLO9:         LD	B,0
0034A5 00   
0034A6 09      9631 ADD	HL,BC
0034A7 F9      9632 LD	SP,HL
0034A8 18      9633 RESLGO:         JR	RESLO1
0034A9 8C   
0034AA 21      9635 RESLO5:         LD	HL,0
0034AB 00   
0034AC 00   
0034AD 39      9636 ADD	HL,SP
0034AE CB      9637 BIT	4,B
0034AF 60   
0034B0 20      9638 JR	NZ,RESLO9
0034B1 F2   
0034B2 F5      9639 PUSH	AF
0034B3 D5      9640 PUSH	DE
0034B4 59      9641 LD	E,C
0034B5 78      9642 LD	A,B
0034B6 CD      9643 CALL	STORES		;String
0034B7 41   
0034B8 32   
0034B9 D1      9644 POP	DE
0034BA F1      9645 POP	AF
0034BB F9      9646 LD	SP,HL
0034BC 18      9647 JR	RESLGO
0034BD EA   
0034BE D1      9657 SAVLOC:         POP	DE		;RETURN ADDRESS
0034BF FD      9658 SAVLO1:         INC	IY		;BUMP PAST ( | ,
0034C0 23   
0034C1 CD      9659 CALL	NXT
0034C2 0B   
0034C3 45   
0034C4 FE      9660 CP	TRETURN
0034C5 F8   
0034C6 20      9661 JR	NZ,SAVLO6
0034C7 08   
0034C8 08      9662 EX	AF,AF'
0034C9 3C      9663 INC	A		;RETURN counter
0034CA 08      9664 EX	AF,AF'
0034CB FD      9665 INC	IY		;Bump past RETURN
0034CC 23   
0034CD CD      9666 CALL	NXT
0034CE 0B   
0034CF 45   
0034D0 D5      9667 SAVLO6:         PUSH	DE
0034D1 D9      9668 EXX
0034D2 C5      9669 PUSH	BC
0034D3 D5      9670 PUSH	DE
0034D4 E5      9671 PUSH	HL
0034D5 D9      9672 EXX
0034D6 CD      9673 CALL	VAR_		;DUMMY VARIABLE
0034D7 D6   
0034D8 25   
0034D9 D9      9674 EXX
0034DA E1      9675 POP	HL
0034DB D1      9676 POP	DE
0034DC C1      9677 POP	BC
0034DD D9      9678 EXX
0034DE D1      9679 POP	DE
0034DF CB      9680 BIT	6,A		;ARRAY?
0034E0 77   
0034E1 20      9681 JR	NZ,SAVLO3
0034E2 12   
0034E3 B7      9682 OR	A		;TYPE
0034E4 FA      9683 JP	M,SAVLO2	;STRING
0034E5 FF   
0034E6 34   
0034E7 D9      9684 EXX
0034E8 E5      9685 PUSH	HL		;SAVE H'L'
0034E9 D9      9686 EXX
0034EA 47      9687 LD	B,A		;TYPE
0034EB CD      9688 CALL	LOADN
0034EC 25   
0034ED 19   
0034EE D9      9689 EXX
0034EF E3      9690 EX	(SP),HL
0034F0 D9      9691 EXX
0034F1 E5      9692 PUSH	HL
0034F2 C5      9693 PUSH	BC
0034F3 18      9694 JR	SAVLO4
0034F4 30   
0034F5 DD      9696 SAVLO3:         LD	C,(IX+0)	;ARRAY POINTER
0034F6 4E   
0034F7 00   
0034F8 DD      9697 LD	B,(IX+1)
0034F9 46   
0034FA 01   
0034FB C5      9698 PUSH	BC		;SAVE TO STACK
0034FC F5      9699 PUSH	AF		;SAVE TYPE
0034FD 18      9700 JR	SAVLO4
0034FE 26   
0034FF F5      9702 SAVLO2:         PUSH	AF		;STRING TYPE
003500 D5      9703 PUSH	DE
003501 D9      9704 EXX
003502 E5      9705 PUSH	HL
003503 D9      9706 EXX
003504 CD      9707 CALL	LOADS
003505 0E   
003506 1A   
003507 D9      9708 EXX
003508 E1      9709 POP	HL
003509 D9      9710 EXX
00350A 4B      9711 LD	C,E
00350B D1      9712 POP	DE
00350C CD      9713 CALL	CHECK
00350D 86   
00350E 32   
00350F F1      9714 POP	AF		;LEVEL STACK
003510 21      9715 LD	HL,0
003511 00   
003512 00   
003513 45      9716 LD	B,L
003514 ED      9717 SBC	HL,BC
003515 42   
003516 39      9718 ADD	HL,SP
003517 F9      9719 LD	SP,HL
003518 47      9720 LD	B,A		;TYPE
003519 C5      9721 PUSH	BC
00351A 28      9722 JR	Z,SAVLO4
00351B 09   
00351C D5      9723 PUSH	DE
00351D 11      9724 LD	DE,ACCS
00351E 00   
00351F 52   
003520 EB      9725 EX	DE,HL
003521 45      9726 LD	B,L
003522 ED      9727 LDIR			;SAVE STRING ON STACK
003523 B0   
003524 D1      9728 POP	DE
003525 DD      9729 SAVLO4:         PUSH	IX		;VARPTR
003526 E5   
003527 CD      9730 CALL	SAVLO5
003528 2A   
003529 35   
00352A CD      9732 SAVLO5:         CALL	CHECK
00352B 86   
00352C 32   
00352D CD      9733 CALL	NXT
00352E 0B   
00352F 45   
003530 FE      9734 CP	','		;MORE?
003531 2C   
003532 28      9735 JR	Z,SAVLO1
003533 8B   
003534 EB      9736 EX	DE,HL
003535 E9      9737 JP	(HL)		;"RETURN"
003536 CD      9739 TERMQ:          CALL	NXT
003537 0B   
003538 45   
003539 FE      9740 CP	TELSE
00353A 8B   
00353B D0      9741 RET	NC
00353C FE      9742 CP	':'		;ASSEMBLER SEPARATOR
00353D 3A   
00353E D0      9743 RET	NC
00353F FE      9744 CP	CR
003540 0D   
003541 C9      9745 RET
003542 CD      9747 SPAN:           CALL	TERMQ
003543 36   
003544 35   
003545 C8      9748 RET	Z
003546 FD      9749 INC	IY
003547 23   
003548 FE      9750 CP	'"'
003549 22   
00354A CC      9751 CALL	Z,QUOTE
00354B 99   
00354C 36   
00354D 18      9752 JR	SPAN
00354E F3   
00354F CD      9754 EQUALS:         CALL	NXT
003550 0B   
003551 45   
003552 FD      9755 INC	IY
003553 23   
003554 FE      9756 CP	'='
003555 3D   
003556 C8      9757 RET	Z
003557 3E      9758 LD	A,4
003558 04   
003559 C3      9759 JP	ERROR_		;"Mistake"
00355A 44   
00355B 3F   
00355C FE      9761 FORMAT:         CP	TTAB
00355D 8A   
00355E 28      9762 JR	Z,DOTAB
00355F 0C   
003560 FE      9763 CP	TSPC
003561 89   
003562 28      9764 JR	Z,DOSPC
003563 38   
003564 FE      9766 CP	39	; apostrophe
003565 27   
003566 C0      9767 RET	NZ
003567 CD      9768 CALL	CRLF
003568 FB   
003569 40   
00356A AF      9769 XOR	A
00356B C9      9770 RET
00356C C5      9772 DOTAB:          PUSH	BC
00356D CD      9773 CALL	EXPRI
00356E 33   
00356F 18   
003570 D9      9774 EXX
003571 C1      9775 POP	BC
003572 FD      9776 LD	A,(IY)
003573 7E   
003574 00   
003575 FE      9777 CP	','
003576 2C   
003577 28      9778 JR	Z,DOTAB1
003578 11   
003579 CD      9779 CALL	BRAKET
00357A AE   
00357B 20   
00357C 7D      9780 LD	A,L
00357D 21      9781 TABIT:          LD	HL,COUNT
00357E FB   
00357F 54   
003580 BE      9782 CP	(HL)
003581 C8      9783 RET	Z
003582 F5      9784 PUSH	AF
003583 DC      9785 CALL	C,CRLF
003584 FB   
003585 40   
003586 F1      9786 POP	AF
003587 96      9787 SUB	(HL)
003588 18      9788 JR	SPACES
003589 19   
00358A FD      9789 DOTAB1:         INC	IY
00358B 23   
00358C C5      9790 PUSH	BC
00358D E5      9791 PUSH	HL
00358E CD      9792 CALL	EXPRI
00358F 33   
003590 18   
003591 D9      9793 EXX
003592 D1      9794 POP	DE
003593 C1      9795 POP	BC
003594 CD      9796 CALL	BRAKET
003595 AE   
003596 20   
003597 CD      9797 CALL	PUTCSR
003598 9C   
003599 0D   
00359A AF      9798 XOR	A
00359B C9      9799 RET
00359C C5      9801 DOSPC:          PUSH	BC
00359D CD      9802 CALL	ITEMI
00359E 60   
00359F 18   
0035A0 D9      9803 EXX
0035A1 7D      9804 LD	A,L
0035A2 C1      9805 POP	BC
0035A3 B7      9806 SPACES:         OR	A
0035A4 C8      9807 RET	Z
0035A5 C5      9808 PUSH	BC
0035A6 47      9809 LD	B,A
0035A7 3E      9810 FILL1:          LD	A,' '
0035A8 20   
0035A9 CD      9811 CALL	OUTCHR
0035AA 02   
0035AB 41   
0035AC 10      9812 DJNZ	FILL1
0035AD F9   
0035AE C1      9813 POP	BC
0035AF AF      9814 XOR	A
0035B0 C9      9815 RET
0035B1 21      9817 PTEXT:          LD	HL,ACCS
0035B2 00   
0035B3 52   
0035B4 1C      9818 INC	E
0035B5 1D      9819 PTEXT1:         DEC	E
0035B6 C8      9820 RET	Z
0035B7 7E      9821 LD	A,(HL)
0035B8 23      9822 INC	HL
0035B9 CD      9823 CALL	OUTCHR
0035BA 02   
0035BB 41   
0035BC 18      9824 JR	PTEXT1
0035BD F7   
0035BE F5      9826 FETCHS:         PUSH	AF
0035BF C5      9827 PUSH	BC
0035C0 E5      9828 PUSH	HL
0035C1 FD      9829 EX	(SP),IY
0035C2 E3   
0035C3 CD      9830 CALL	XTRACT
0035C4 DB   
0035C5 35   
0035C6 CD      9831 CALL	NXT
0035C7 0B   
0035C8 45   
0035C9 FD      9832 EX	(SP),IY
0035CA E3   
0035CB E1      9833 POP	HL
0035CC C1      9834 POP	BC
0035CD F1      9835 POP	AF
0035CE C9      9836 RET
0035CF 11      9838 LINES:          LD	DE,ACCS
0035D0 00   
0035D1 52   
0035D2 7E      9839 LINE1S:         LD	A,(HL)
0035D3 12      9840 LD	(DE),A
0035D4 FE      9841 CP	CR
0035D5 0D   
0035D6 C8      9842 RET	Z
0035D7 23      9843 INC	HL
0035D8 1C      9844 INC	E
0035D9 18      9845 JR	LINE1S
0035DA F7   
0035DB CD      9847 XTRACT:         CALL	NXT
0035DC 0B   
0035DD 45   
0035DE FE      9848 CP	'"'
0035DF 22   
0035E0 FD      9849 INC	IY
0035E1 23   
0035E2 CA      9850 JP	Z,CONS
0035E3 7A   
0035E4 19   
0035E5 FD      9851 DEC	IY
0035E6 2B   
0035E7 11      9852 LD	DE,ACCS
0035E8 00   
0035E9 52   
0035EA FD      9853 XTRAC1:         LD	A,(IY)
0035EB 7E   
0035EC 00   
0035ED 12      9854 LD	(DE),A
0035EE FE      9855 CP	','
0035EF 2C   
0035F0 C8      9856 RET	Z
0035F1 FE      9857 CP	CR
0035F2 0D   
0035F3 C8      9858 RET	Z
0035F4 FD      9859 INC	IY
0035F5 23   
0035F6 1C      9860 INC	E
0035F7 18      9861 JR	XTRAC1
0035F8 F1   
0035F9 3E      9863 DSRCH:          LD	A,TDATA
0035FA DC   
0035FB 06      9864 SEARCHex:         LD	B,0
0035FC 00   
0035FD 4E      9865 SRCH1:          LD	C,(HL)
0035FE 0C      9866 INC	C
0035FF 0D      9867 DEC	C
003600 28      9868 JR	Z,SRCH2		;FAIL
003601 0C   
003602 23      9869 INC	HL
003603 23      9870 INC	HL
003604 23      9871 INC	HL
003605 BE      9872 CP	(HL)
003606 C8      9873 RET	Z
003607 0D      9874 DEC	C
003608 0D      9875 DEC	C
003609 0D      9876 DEC	C
00360A 09      9877 ADD	HL,BC
00360B C3      9878 JP	SRCH1
00360C FD   
00360D 35   
00360E 2B      9879 SRCH2:          DEC	HL		;POINT TO CR
00360F 37      9880 SCF
003610 C9      9881 RET
003611 2E      9895 NSCAN:          LD	L,0		;nest level
003612 00   
003613 FD      9896 NSCAN1:         LD	A,(IY)		;get line length
003614 7E   
003615 00   
003616 B7      9897 OR	A		;test zero = end of prog
003617 28      9898 JR	Z,NSCAN6
003618 34   
003619 FD      9899 LD	A,(IY+3)	;initial token
00361A 7E   
00361B 03   
00361C B8      9900 CP	B		;test value reqd
00361D 28      9901 JR	Z,NSCAN3	;found (1)
00361E 1D   
00361F B9      9902 CP	C
003620 28      9903 JR	Z,NSCAN3	;found (2)
003621 1A   
003622 BA      9904 NSCAN7:         CP	D		;unnest?
003623 28      9905 JR	Z,NSCAN5
003624 22   
003625 C5      9906 NSCAN2:         PUSH	BC
003626 06      9907 LD	B,0
003627 00   
003628 FD      9908 LD	C,(IY)
003629 4E   
00362A 00   
00362B FD      9909 ADD	IY,BC		;go to next line
00362C 09   
00362D FD      9910 LD	A,(IY-2)
00362E 7E   
00362F FE   
003630 BB      9911 CP	E		;nest?
003631 79      9912 LD	A,C
003632 C1      9913 POP	BC
003633 20      9914 JR	NZ,NSCAN1	;continue
003634 DE   
003635 FE      9915 CP	5		;empty line ?
003636 05   
003637 38      9916 JR	C,NSCAN1	;continue
003638 DA   
003639 2C      9917 INC	L		;increment nest level
00363A 18      9918 JR	NSCAN1		;continue
00363B D7   
00363C 2C      9920 NSCAN3:         INC	L
00363D 2D      9921 DEC	L
00363E 20      9922 JR	NZ,NSCAN7
00363F E2   
003640 01      9923 NSCAN4:         LD	BC,4
003641 04   
003642 00   
003643 FD      9924 ADD	IY,BC
003644 09   
003645 AF      9925 XOR	A		;Z
003646 C9      9926 RET
003647 2D      9928 NSCAN5:         DEC	L		;decrement nest level
003648 F2      9929 JP	P,NSCAN2
003649 25   
00364A 36   
00364B 18      9930 JR	NSCAN4
00364C F3   
00364D F6      9932 NSCAN6:         OR	1		;NZ
00364E 01   
00364F C9      9933 RET
003650 FD      9945 WSRCH:          LD	A,(IY)
003651 7E   
003652 00   
003653 FD      9946 INC	IY
003654 23   
003655 FE      9947 CP	'"'
003656 22   
003657 CC      9948 CALL	Z,QUOTE
003658 99   
003659 36   
00365A FE      9949 CP	TREM
00365B F4   
00365C 28      9950 JR	Z,WSRCHM
00365D 22   
00365E FE      9951 CP	TEXIT
00365F 10   
003660 28      9952 JR	Z,WSRCHE
003661 30   
003662 B8      9953 CP	B
003663 28      9954 JR	Z,WSRCHX
003664 29   
003665 B9      9955 CP	C
003666 28      9956 JR	Z,WSRCHP
003667 23   
003668 FE      9957 CP	CR
003669 0D   
00366A 20      9958 JR	NZ,WSRCH
00366B E4   
00366C FD      9959 WSRCH1:         LD	A,(IY)			;Line length
00366D 7E   
00366E 00   
00366F FD      9960 INC	IY
003670 23   
003671 B7      9961 OR	A
003672 CA      9962 JP	Z,END
003673 D3   
003674 24   
003675 FD      9963 INC	IY
003676 23   
003677 FD      9964 INC	IY			;Skip line number
003678 23   
003679 FD      9965 LD	A,(IY)
00367A 7E   
00367B 00   
00367C FE      9966 CP	TDATA
00367D DC   
00367E 20      9967 JR	NZ,WSRCH
00367F D0   
003680 FD      9968 WSRCHM:         LD	A,(IY)
003681 7E   
003682 00   
003683 FD      9969 INC	IY
003684 23   
003685 FE      9970 CP	CR
003686 0D   
003687 20      9971 JR	NZ,WSRCHM		;Skip to end of line
003688 F7   
003689 18      9972 JR	WSRCH1
00368A E1   
00368B 14      9974 WSRCHP:         INC	D
00368C 18      9975 JR	WSRCH
00368D C2   
00368E 15      9977 WSRCHX:         DEC	D
00368F 20      9978 JR	NZ,WSRCH
003690 BF   
003691 C9      9979 RET
003692 CD      9981 WSRCHE:         CALL	NXT
003693 0B   
003694 45   
003695 FD      9982 INC	IY
003696 23   
003697 18      9983 JR	WSRCH
003698 B7   
003699 FD      9987 QUOTE:          LD	A,(IY)
00369A 7E   
00369B 00   
00369C FD      9988 INC	IY
00369D 23   
00369E FE      9989 CP	CR
00369F 0D   
0036A0 CA      9990 JP	Z,MISQUO
0036A1 A8   
0036A2 36   
0036A3 FE      9991 CP	'"'
0036A4 22   
0036A5 20      9992 JR	NZ,QUOTE
0036A6 F2   
0036A7 C9      9993 RET
0036A8 3E      9995 MISQUO:         LD	A,9
0036A9 09   
0036AA C3      9996 JP	ERROR_		;"Missing quote"
0036AB 44   
0036AC 3F   
0036AD 62     10005 X14OR5:         LD	H,D
0036AE 6B     10006 LD	L,E
0036AF FE     10007 CP	1
0036B0 01   
0036B1 C8     10008 RET	Z
0036B2 FE     10009 CP	5
0036B3 05   
0036B4 29     10010 ADD	HL,HL
0036B5 D8     10011 RET	C
0036B6 29     10012 ADD	HL,HL
0036B7 D8     10013 RET	C
0036B8 EB     10014 EX	DE,HL
0036B9 C0     10015 RET	NZ
0036BA 19     10016 ADD	HL,DE
0036BB EB     10017 EX	DE,HL
0036BC C9     10018 RET
0036BD EB     10027 MUL16:          EX	DE,HL
0036BE 21     10028 LD	HL,0
0036BF 00   
0036C0 00   
0036C1 3E     10029 LD	A,16
0036C2 10   
0036C3 29     10030 MUL161:         ADD	HL,HL
0036C4 D8     10031 RET	C		;OVERFLOW
0036C5 CB     10032 SLA	E
0036C6 23   
0036C7 CB     10033 RL	D
0036C8 12   
0036C9 30     10034 JR	NC,MUL162
0036CA 02   
0036CB 09     10035 ADD	HL,BC
0036CC D8     10036 RET	C
0036CD 3D     10037 MUL162:         DEC	A
0036CE 20     10038 JR	NZ,MUL161
0036CF F3   
0036D0 C9     10039 RET
0036D1 CD     10041 CHANEL:         CALL	NXT
0036D2 0B   
0036D3 45   
0036D4 FE     10042 CP	'#'
0036D5 23   
0036D6 3E     10043 LD	A,45
0036D7 2D   
0036D8 C2     10044 JP	NZ,ERROR_	;"Missing #"
0036D9 44   
0036DA 3F   
0036DB FD     10045 CHNL:           INC	IY		;SKIP '#'
0036DC 23   
0036DD CD     10046 CALL	ITEMI
0036DE 60   
0036DF 18   
0036E0 D9     10047 EXX
0036E1 EB     10048 EX	DE,HL
0036E2 C9     10049 RET
0036E3 F5     10057 FREESA:         PUSH	AF
0036E4 C5     10058 FREES0:         PUSH	BC
0036E5 D5     10059 PUSH	DE
0036E6 E5     10060 PUSH	HL
0036E7 AF     10061 XOR	A
0036E8 50     10062 LD	D,B
0036E9 59     10063 LD	E,C
0036EA 47     10064 LD	B,A
0036EB D5     10065 FREES1:         PUSH	DE
0036EC 2B     10066 DEC	HL
0036ED 56     10067 LD	D,(HL)
0036EE 2B     10068 DEC	HL
0036EF 5E     10069 LD	E,(HL)
0036F0 2B     10070 DEC	HL
0036F1 4E     10071 LD	C,(HL)
0036F2 2B     10072 DEC	HL
0036F3 E5     10073 PUSH	HL
0036F4 2A     10074 LD	HL,(FREE)
0036F5 E0   
0036F6 54   
0036F7 EB     10075 EX	DE,HL
0036F8 09     10076 ADD	HL,BC
0036F9 ED     10077 SBC	HL,DE
0036FA 52   
0036FB 20     10078 JR	NZ,FREES2
0036FC 07   
0036FD 19     10079 ADD	HL,DE
0036FE ED     10080 SBC	HL,BC
0036FF 42   
003700 22     10081 LD	(FREE),HL
003701 E0   
003702 54   
003703 B4     10082 OR	H
003704 D1     10083 FREES2:         POP	DE
003705 E1     10084 POP	HL
003706 0E     10085 LD	C,4
003707 04   
003708 B7     10086 OR	A
003709 ED     10087 SBC	HL,BC
00370A 42   
00370B EB     10088 EX	DE,HL
00370C 20     10089 JR	NZ,FREES1
00370D DD   
00370E B7     10090 OR	A
00370F E1     10091 POP	HL
003710 D1     10092 POP	DE
003711 C1     10093 POP	BC
003712 B7     10094 OR	A
003713 20     10095 JR	NZ,FREES0
003714 CF   
003715 F1     10096 POP	AF
003716 C9     10097 RET
003717             10102   ; --- Begin main.asm ---
003717 C3     10260 START:          JP	COLD
003718 41   
003719 37   
00371A C3     10261 JP	WARM
00371B AF   
00371C 37   
00371D C3     10262 JP	ESCAPE
00371E E3   
00371F 25   
003720 C3     10263 JP	EXTERR
003721 55   
003722 3F   
003723 C3     10264 JP	TELL
003724 FA   
003725 44   
003726 C3     10265 JP	TEXT_
003727 E8   
003728 44   
003729 C3     10266 JP	ITEMI
00372A 60   
00372B 18   
00372C C3     10267 JP	EXPRI
00372D 33   
00372E 18   
00372F C3     10268 JP	EXPRS
003730 3C   
003731 18   
003732 C3     10269 JP	OSCLI
003733 B3   
003734 09   
003735 C3     10270 JP	OSBGET
003736 5B   
003737 06   
003738 C3     10271 JP	OSBPUT
003739 63   
00373A 06   
00373B C3     10272 JP	OSSTAT
00373C 6C   
00373D 06   
00373E C3     10273 JP	OSSHUT
00373F 53   
003740 06   
003741 21     10274 COLD:           LD	HL,STAVAR	;COLD START
003742 00   
003743 54   
003744 F9     10275 LD	SP,HL
003745 36     10276 LD	(HL),10
003746 0A   
003747 2C     10277 INC	L
003748 36     10278 LD	(HL),9
003749 09   
00374A 2C     10279 INC	L
00374B AF     10280 XOR	A
00374C 77     10281 PURGE:          LD	(HL),A		;CLEAR SCRATCHPAD
00374D 2C     10282 INC	L
00374E 20     10283 JR	NZ,PURGE
00374F FC   
003750 3E     10284 LD	A,37H		;V3.0
003751 37   
003752 32     10285 LD	(LISTON),A
003753 FE   
003754 54   
003755 21     10286 LD	HL,NOTICE
003756 8E   
003757 37   
003758 22     10287 LD	(ERRTXT),HL
003759 EE   
00375A 54   
00375B CD     10288 CALL	OSINIT
00375C A0   
00375D 05   
00375E ED     10289 LD	(HIMEM),DE
00375F 53   
003760 E2   
003761 54   
003762 22     10290 LD	(PAGE_),HL
003763 DC   
003764 54   
003765 CD     10291 CALL	NEWIT
003766 3E   
003767 40   
003768 C2     10292 JP	NZ,CHAIN0	;AUTO-RUN
003769 52   
00376A 24   
00376B CD     10293 CALL	TELL
00376C FA   
00376D 44   
00376E 42     10294 VERMSG:         DB	"BBC BASIC (Z80) Version 5.00  "
00376F 42   
003770 43   
003771 20   
003772 42   
003773 41   
003774 53   
003775 49   
003776 43   
003777 20   
003778 28   
003779 5A   
00377A 38   
00377B 30   
00377C 29   
00377D 20   
00377E 56   
00377F 65   
003780 72   
003781 73   
003782 69   
003783 6F   
003784 6E   
003785 20   
003786 35   
003787 2E   
003788 30   
003789 30   
00378A 20   
00378B 20   
00378C 0D     10295 DB	CR
00378D 0A     10296 DB	LF
00378E 28     10297 NOTICE:         DB	"(C) Copyright R.T.Russell 2024"
00378F 43   
003790 29   
003791 20   
003792 43   
003793 6F   
003794 70   
003795 79   
003796 72   
003797 69   
003798 67   
003799 68   
00379A 74   
00379B 20   
00379C 52   
00379D 2E   
00379E 54   
00379F 2E   
0037A0 52   
0037A1 75   
0037A2 73   
0037A3 73   
0037A4 65   
0037A5 6C   
0037A6 6C   
0037A7 20   
0037A8 32   
0037A9 30   
0037AA 32   
0037AB 34   
0037AC 0D     10298 DB	CR
0037AD 0A     10299 DB	LF
0037AE 00     10300 DB	0
0037AF F6     10301 WARM:           DB	0F6H
0037B0 37     10302 CLOOP:          SCF
0037B1 ED     10303 LD	SP,(HIMEM)
0037B2 7B   
0037B3 E2   
0037B4 54   
0037B5 CD     10304 CALL	PROMPT		;PROMPT USER
0037B6 AF   
0037B7 05   
0037B8 21     10305 LD	HL,LISTON
0037B9 FE   
0037BA 54   
0037BB 7E     10306 LD	A,(HL)
0037BC E6     10307 AND	0FH		;LISTO
0037BD 0F   
0037BE F6     10308 OR	30H		;OPT 3
0037BF 30   
0037C0 77     10309 LD	(HL),A
0037C1 ED     10310 SBC	HL,HL		;HL <- 0 (V3.0)
0037C2 62   
0037C3 22     10311 LD	(ERRTRP),HL
0037C4 EA   
0037C5 54   
0037C6 22     10312 LD	(ONERSP),HL
0037C7 EC   
0037C8 54   
0037C9 22     10313 LD	(CURLIN),HL	;For CMOS EDIT->LIST
0037CA F4   
0037CB 54   
0037CC 2A     10314 LD	HL,(AUTONO)
0037CD E8   
0037CE 54   
0037CF E5     10315 PUSH	HL
0037D0 7C     10316 LD	A,H
0037D1 B5     10317 OR	L
0037D2 28     10318 JR	Z,NOAUTO
0037D3 17   
0037D4 E5     10319 PUSH	HL
0037D5 CD     10320 CALL	PBCD		;AUTO NUMBER
0037D6 96   
0037D7 41   
0037D8 E1     10321 POP	HL
0037D9 ED     10322 LD	BC,(INCREM)
0037DA 4B   
0037DB FF   
0037DC 54   
0037DD 06     10323 LD	B,0
0037DE 00   
0037DF 09     10324 ADD	HL,BC
0037E0 DA     10325 JP	C,TOOBIGmn
0037E1 AF   
0037E2 43   
0037E3 22     10326 LD	(AUTONO),HL
0037E4 E8   
0037E5 54   
0037E6 3E     10327 LD	A,' '
0037E7 20   
0037E8 CD     10328 CALL	OUTCHR
0037E9 02   
0037EA 41   
0037EB 21     10329 NOAUTO:         LD	HL,ACCS
0037EC 00   
0037ED 52   
0037EE CD     10330 CALL	OSLINE		;GET CONSOLE INPUT
0037EF E7   
0037F0 05   
0037F1 AF     10331 XOR	A
0037F2 32     10332 LD	(COUNT),A
0037F3 FB   
0037F4 54   
0037F5 FD     10333 LD	IY,ACCS
0037F6 21   
0037F7 00   
0037F8 52   
0037F9 21     10334 LD	HL,COMNDS
0037FA E1   
0037FB 3B   
0037FC CD     10335 CALL	LEX0
0037FD A6   
0037FE 3F   
0037FF E1     10336 POP	HL
003800 20     10337 JR	NZ,NOTCMD
003801 19   
003802 87     10338 ADD	A,A
003803 4F     10339 LD	C,A
003804 7C     10340 LD	A,H
003805 B5     10341 OR	L
003806 20     10342 JR	NZ,INAUTO
003807 0F   
003808 47     10343 LD	B,A
003809 21     10344 LD	HL,CMDTABmn
00380A 11   
00380B 3C   
00380C 09     10345 ADD	HL,BC
00380D 7E     10346 LD	A,(HL)		;TABLE ENTRY
00380E 23     10347 INC	HL
00380F 66     10348 LD	H,(HL)
003810 6F     10349 LD	L,A
003811 FD     10350 INC	IY
003812 23   
003813 CD     10351 CALL	NXT
003814 0B   
003815 45   
003816 E9     10352 JP	(HL)		;EXECUTE COMMAND
003817 FD     10354 INAUTO:         LD	IY,ACCS
003818 21   
003819 00   
00381A 52   
00381B 7C     10355 NOTCMD:         LD	A,H
00381C B5     10356 OR	L
00381D CC     10357 CALL	Z,LINNUM
00381E 8A   
00381F 43   
003820 CD     10358 CALL	NXT
003821 0B   
003822 45   
003823 11     10359 LD	DE,BUFFER
003824 00   
003825 53   
003826 0E     10360 LD	C,1		;LEFT MODE
003827 01   
003828 E5     10361 PUSH	HL
003829 CD     10362 CALL	LEXAN2		;LEXICAL ANALYSIS
00382A 18   
00382B 44   
00382C E1     10363 POP	HL
00382D 12     10364 LD	(DE),A		;TERMINATOR
00382E AF     10365 XOR	A
00382F 47     10366 LD	B,A
003830 4B     10367 LD	C,E		;BC=LINE LENGTH
003831 13     10368 INC	DE
003832 12     10369 LD	(DE),A		;ZERO NEXT
003833 7C     10370 LD	A,H
003834 B5     10371 OR	L
003835 FD     10372 LD	IY,BUFFER	;FOR XEQ
003836 21   
003837 00   
003838 53   
003839 CA     10373 JP	Z,XEQ		;DIRECT MODE
00383A 99   
00383B 24   
00383C C5     10374 PUSH	BC
00383D CD     10375 CALL	FINDL
00383E 43   
00383F 41   
003840 CC     10376 CALL	Z,DEL
003841 E9   
003842 3F   
003843 C1     10377 POP	BC
003844 79     10378 LD	A,C
003845 B7     10379 OR	A
003846 28     10380 JR	Z,CLOOP2	;DELETE LINE ONLY
003847 39   
003848 C6     10381 ADD	A,4
003849 04   
00384A 4F     10382 LD	C,A		;LENGTH INCLUSIVE
00384B D5     10383 PUSH	DE		;LINE NUMBER
00384C C5     10384 PUSH	BC		;SAVE LINE LENGTH
00384D EB     10385 EX	DE,HL
00384E C5     10386 PUSH	BC
00384F CD     10387 CALL	GETTOP
003850 25   
003851 40   
003852 C1     10388 POP	BC
003853 E5     10389 PUSH	HL
003854 09     10390 ADD	HL,BC
003855 E5     10391 PUSH	HL
003856 24     10392 INC	H
003857 AF     10393 XOR	A
003858 ED     10394 SBC	HL,SP
003859 72   
00385A E1     10395 POP	HL
00385B D2     10396 JP	NC,ERROR_	;"No room"
00385C 44   
00385D 3F   
00385E E3     10397 EX	(SP),HL
00385F E5     10398 PUSH	HL
003860 23     10399 INC	HL
003861 B7     10400 OR	A
003862 ED     10401 SBC	HL,DE
003863 52   
003864 44     10402 LD	B,H		;BC=AMOUNT TO MOVE
003865 4D     10403 LD	C,L
003866 E1     10404 POP	HL
003867 D1     10405 POP	DE
003868 28     10406 JR	Z,ATEND
003869 02   
00386A ED     10407 LDDR			;MAKE SPACE
00386B B8   
00386C C1     10408 ATEND:          POP	BC		;LINE LENGTH
00386D D1     10409 POP	DE		;LINE NUMBER
00386E 23     10410 INC	HL
00386F 71     10411 LD	(HL),C		;STORE LENGTH
003870 23     10412 INC	HL
003871 73     10413 LD	(HL),E		;STORE LINE NUMBER
003872 23     10414 INC	HL
003873 72     10415 LD	(HL),D
003874 23     10416 INC	HL
003875 11     10417 LD	DE,BUFFER
003876 00   
003877 53   
003878 EB     10418 EX	DE,HL
003879 0D     10419 DEC	C
00387A 0D     10420 DEC	C
00387B 0D     10421 DEC	C
00387C ED     10422 LDIR			;ADD LINE
00387D B0   
00387E CD     10423 CALL	CLEAN
00387F 1A   
003880 40   
003881 C3     10424 CLOOP2:         JP	CLOOP
003882 B0   
003883 37   
003884 80     10431 KEYWDS:         DB	80H
003885 41     10432 DB	"AND"
003886 4E   
003887 44   
003888 94     10433 DB	94H
003889 41     10434 DB	"ABS"
00388A 42   
00388B 53   
00388C 95     10435 DB	95H
00388D 41     10436 DB	"ACS"
00388E 43   
00388F 53   
003890 96     10437 DB	96H
003891 41     10438 DB	"ADVAL"
003892 44   
003893 56   
003894 41   
003895 4C   
003896 97     10439 DB	97H
003897 41     10440 DB	"ASC"
003898 53   
003899 43   
00389A 98     10441 DB	98H
00389B 41     10442 DB	"ASN"
00389C 53   
00389D 4E   
00389E 99     10443 DB	99H
00389F 41     10444 DB	"ATN"
0038A0 54   
0038A1 4E   
0038A2 9A     10445 DB	9AH
0038A3 42     10446 DB	"BGET "
0038A4 47   
0038A5 45   
0038A6 54   
0038A7 20   
0038A8 D5     10447 DB	0D5H
0038A9 42     10448 DB	"BPUT "
0038AA 50   
0038AB 55   
0038AC 54   
0038AD 20   
0038AE 0F     10449 DB	0FH
0038AF 42     10450 DB	"BY "		; v5
0038B0 59   
0038B1 20   
0038B2 FB     10451 DB	0FBH
0038B3 43     10452 DB	"COLOUR"
0038B4 4F   
0038B5 4C   
0038B6 4F   
0038B7 55   
0038B8 52   
0038B9 FB     10453 DB	0FBH
0038BA 43     10454 DB	"COLOR"
0038BB 4F   
0038BC 4C   
0038BD 4F   
0038BE 52   
0038BF D6     10455 DB	0D6H
0038C0 43     10456 DB	"CALL"
0038C1 41   
0038C2 4C   
0038C3 4C   
0038C4 C8     10457 DB	0C8H
0038C5 43     10458 DB	"CASE"		; v5
0038C6 41   
0038C7 53   
0038C8 45   
0038C9 D7     10459 DB	0D7H
0038CA 43     10460 DB	"CHAIN"
0038CB 48   
0038CC 41   
0038CD 49   
0038CE 4E   
0038CF BD     10461 DB	0BDH
0038D0 43     10462 DB	"CHR$"
0038D1 48   
0038D2 52   
0038D3 24   
0038D4 D8     10463 DB	0D8H
0038D5 43     10464 DB	"CLEAR "
0038D6 4C   
0038D7 45   
0038D8 41   
0038D9 52   
0038DA 20   
0038DB D9     10465 DB	0D9H
0038DC 43     10466 DB	"CLOSE "
0038DD 4C   
0038DE 4F   
0038DF 53   
0038E0 45   
0038E1 20   
0038E2 DA     10467 DB	0DAH
0038E3 43     10468 DB	"CLG "
0038E4 4C   
0038E5 47   
0038E6 20   
0038E7 DB     10469 DB	0DBH
0038E8 43     10470 DB	"CLS "
0038E9 4C   
0038EA 53   
0038EB 20   
0038EC 9B     10471 DB	9BH
0038ED 43     10472 DB	"COS"
0038EE 4F   
0038EF 53   
0038F0 9C     10473 DB	9CH
0038F1 43     10474 DB	"COUNT "
0038F2 4F   
0038F3 55   
0038F4 4E   
0038F5 54   
0038F6 20   
0038F7 01     10475 DB	01H
0038F8 43     10476 DB	"CIRCLE"	; v5
0038F9 49   
0038FA 52   
0038FB 43   
0038FC 4C   
0038FD 45   
0038FE DC     10477 DB	0DCH
0038FF 44     10478 DB	"DATA"
003900 41   
003901 54   
003902 41   
003903 9D     10479 DB	9DH
003904 44     10480 DB	"DEG"
003905 45   
003906 47   
003907 DD     10481 DB	0DDH
003908 44     10482 DB	"DEF"
003909 45   
00390A 46   
00390B 81     10483 DB	81H
00390C 44     10484 DB	"DIV"
00390D 49   
00390E 56   
00390F DE     10485 DB	0DEH
003910 44     10486 DB	"DIM"
003911 49   
003912 4D   
003913 DF     10487 DB	0DFH
003914 44     10488 DB	"DRAW"
003915 52   
003916 41   
003917 57   
003918 E1     10489 DB	0E1H
003919 45     10490 DB	"ENDPROC "
00391A 4E   
00391B 44   
00391C 50   
00391D 52   
00391E 4F   
00391F 43   
003920 20   
003921 CE     10491 DB	0CEH
003922 45     10492 DB	"ENDWHILE "	; v5
003923 4E   
003924 44   
003925 57   
003926 48   
003927 49   
003928 4C   
003929 45   
00392A 20   
00392B CB     10493 DB	0CBH
00392C 45     10494 DB	"ENDCASE "	; v5
00392D 4E   
00392E 44   
00392F 43   
003930 41   
003931 53   
003932 45   
003933 20   
003934 CD     10495 DB	0CDH
003935 45     10496 DB	"ENDIF "	; v5
003936 4E   
003937 44   
003938 49   
003939 46   
00393A 20   
00393B E0     10497 DB	0E0H
00393C 45     10498 DB	"END "
00393D 4E   
00393E 44   
00393F 20   
003940 E2     10499 DB	0E2H
003941 45     10500 DB	"ENVELOPE"
003942 4E   
003943 56   
003944 45   
003945 4C   
003946 4F   
003947 50   
003948 45   
003949 8B     10501 DB	8BH
00394A 45     10502 DB	"ELSE"
00394B 4C   
00394C 53   
00394D 45   
00394E A0     10503 DB	0A0H
00394F 45     10504 DB	"EVAL"
003950 56   
003951 41   
003952 4C   
003953 9E     10505 DB	9EH
003954 45     10506 DB	"ERL "
003955 52   
003956 4C   
003957 20   
003958 85     10507 DB	85H
003959 45     10508 DB	"ERROR"
00395A 52   
00395B 52   
00395C 4F   
00395D 52   
00395E C5     10509 DB	0C5H
00395F 45     10510 DB	"EOF "
003960 4F   
003961 46   
003962 20   
003963 82     10511 DB	82H
003964 45     10512 DB	"EOR"
003965 4F   
003966 52   
003967 9F     10513 DB	9FH
003968 45     10514 DB	"ERR "
003969 52   
00396A 52   
00396B 20   
00396C 10     10515 DB	10H
00396D 45     10516 DB	"EXIT "		; v5
00396E 58   
00396F 49   
003970 54   
003971 20   
003972 A1     10517 DB	0A1H
003973 45     10518 DB	"EXP"
003974 58   
003975 50   
003976 A2     10519 DB	0A2H
003977 45     10520 DB	"EXT "
003978 58   
003979 54   
00397A 20   
00397B 02     10521 DB	02H
00397C 45     10522 DB	"ELLIPSE"	; v5
00397D 4C   
00397E 4C   
00397F 49   
003980 50   
003981 53   
003982 45   
003983 E3     10523 DB	0E3H
003984 46     10524 DB	"FOR"
003985 4F   
003986 52   
003987 A3     10525 DB	0A3H
003988 46     10526 DB	"FALSE "
003989 41   
00398A 4C   
00398B 53   
00398C 45   
00398D 20   
00398E 03     10527 DB	03H
00398F 46     10528 DB	"FILL"		; v5
003990 49   
003991 4C   
003992 4C   
003993 A4     10529 DB	0A4H
003994 46     10530 DB	"FN"
003995 4E   
003996 E5     10531 DB	0E5H
003997 47     10532 DB	"GOTO"
003998 4F   
003999 54   
00399A 4F   
00399B BE     10533 DB	0BEH
00399C 47     10534 DB	"GET$"
00399D 45   
00399E 54   
00399F 24   
0039A0 A5     10535 DB	0A5H
0039A1 47     10536 DB	"GET"
0039A2 45   
0039A3 54   
0039A4 E4     10537 DB	0E4H
0039A5 47     10538 DB	"GOSUB"
0039A6 4F   
0039A7 53   
0039A8 55   
0039A9 42   
0039AA E6     10539 DB	0E6H
0039AB 47     10540 DB	"GCOL"
0039AC 43   
0039AD 4F   
0039AE 4C   
0039AF 93     10541 DB	93H
0039B0 48     10542 DB	"HIMEM "
0039B1 49   
0039B2 4D   
0039B3 45   
0039B4 4D   
0039B5 20   
0039B6 E8     10543 DB	0E8H
0039B7 49     10544 DB	"INPUT"
0039B8 4E   
0039B9 50   
0039BA 55   
0039BB 54   
0039BC E7     10545 DB	0E7H
0039BD 49     10546 DB	"IF"
0039BE 46   
0039BF BF     10547 DB	0BFH
0039C0 49     10548 DB	"INKEY$"
0039C1 4E   
0039C2 4B   
0039C3 45   
0039C4 59   
0039C5 24   
0039C6 A6     10549 DB	0A6H
0039C7 49     10550 DB	"INKEY"
0039C8 4E   
0039C9 4B   
0039CA 45   
0039CB 59   
0039CC A8     10551 DB	0A8H
0039CD 49     10552 DB	"INT"
0039CE 4E   
0039CF 54   
0039D0 A7     10553 DB	0A7H
0039D1 49     10554 DB	"INSTR("
0039D2 4E   
0039D3 53   
0039D4 54   
0039D5 52   
0039D6 28   
0039D7 0C     10555 DB	0CH
0039D8 49     10556 DB	"INSTALL"	; v5
0039D9 4E   
0039DA 53   
0039DB 54   
0039DC 41   
0039DD 4C   
0039DE 4C   
0039DF 86     10557 DB	86H
0039E0 4C     10558 DB	"LINE"
0039E1 49   
0039E2 4E   
0039E3 45   
0039E4 92     10559 DB	92H
0039E5 4C     10560 DB	"LOMEM "
0039E6 4F   
0039E7 4D   
0039E8 45   
0039E9 4D   
0039EA 20   
0039EB EA     10561 DB	0EAH
0039EC 4C     10562 DB	"LOCAL"
0039ED 4F   
0039EE 43   
0039EF 41   
0039F0 4C   
0039F1 C0     10563 DB	0C0H
0039F2 4C     10564 DB	"LEFT$("
0039F3 45   
0039F4 46   
0039F5 54   
0039F6 24   
0039F7 28   
0039F8 A9     10565 DB	0A9H
0039F9 4C     10566 DB	"LEN"
0039FA 45   
0039FB 4E   
0039FC E9     10567 DB	0E9H
0039FD 4C     10568 DB	"LET"
0039FE 45   
0039FF 54   
003A00 AB     10569 DB	0ABH
003A01 4C     10570 DB	"LOG"
003A02 4F   
003A03 47   
003A04 AA     10571 DB	0AAH
003A05 4C     10572 DB	"LN"
003A06 4E   
003A07 C1     10573 DB	0C1H
003A08 4D     10574 DB	"MID$("
003A09 49   
003A0A 44   
003A0B 24   
003A0C 28   
003A0D EB     10575 DB	0EBH
003A0E 4D     10576 DB	"MODE"
003A0F 4F   
003A10 44   
003A11 45   
003A12 83     10577 DB	83H
003A13 4D     10578 DB	"MOD"
003A14 4F   
003A15 44   
003A16 EC     10579 DB	0ECH
003A17 4D     10580 DB	"MOVE"
003A18 4F   
003A19 56   
003A1A 45   
003A1B 04     10581 DB	04H
003A1C 4D     10582 DB	"MOUSE"		; v5
003A1D 4F   
003A1E 55   
003A1F 53   
003A20 45   
003A21 ED     10583 DB	0EDH
003A22 4E     10584 DB	"NEXT"
003A23 45   
003A24 58   
003A25 54   
003A26 AC     10585 DB	0ACH
003A27 4E     10586 DB	"NOT"
003A28 4F   
003A29 54   
003A2A EE     10587 DB	0EEH
003A2B 4F     10588 DB	"ON"
003A2C 4E   
003A2D 87     10589 DB	87H
003A2E 4F     10590 DB	"OFF "
003A2F 46   
003A30 46   
003A31 20   
003A32 CA     10591 DB	0CAH
003A33 4F     10592 DB	"OF "		; v5
003A34 46   
003A35 20   
003A36 05     10593 DB	05H
003A37 4F     10594 DB	"ORIGIN"	; v5
003A38 52   
003A39 49   
003A3A 47   
003A3B 49   
003A3C 4E   
003A3D 84     10595 DB	84H
003A3E 4F     10596 DB	"OR"
003A3F 52   
003A40 8E     10597 DB	8EH
003A41 4F     10598 DB	"OPENIN"
003A42 50   
003A43 45   
003A44 4E   
003A45 49   
003A46 4E   
003A47 AE     10599 DB	0AEH
003A48 4F     10600 DB	"OPENOUT"
003A49 50   
003A4A 45   
003A4B 4E   
003A4C 4F   
003A4D 55   
003A4E 54   
003A4F AD     10601 DB	0ADH
003A50 4F     10602 DB	"OPENUP"
003A51 50   
003A52 45   
003A53 4E   
003A54 55   
003A55 50   
003A56 FF     10603 DB	0FFH
003A57 4F     10604 DB	"OSCLI"
003A58 53   
003A59 43   
003A5A 4C   
003A5B 49   
003A5C CC     10605 DB	0CCH
003A5D 4F     10606 DB	"OTHERWISE"	; v5
003A5E 54   
003A5F 48   
003A60 45   
003A61 52   
003A62 57   
003A63 49   
003A64 53   
003A65 45   
003A66 F1     10607 DB	0F1H
003A67 50     10608 DB	"PRINT"
003A68 52   
003A69 49   
003A6A 4E   
003A6B 54   
003A6C 90     10609 DB	90H
003A6D 50     10610 DB	"PAGE "
003A6E 41   
003A6F 47   
003A70 45   
003A71 20   
003A72 8F     10611 DB	8FH
003A73 50     10612 DB	"PTR "
003A74 54   
003A75 52   
003A76 20   
003A77 AF     10613 DB	0AFH
003A78 50     10614 DB	"PI "
003A79 49   
003A7A 20   
003A7B F0     10615 DB	0F0H
003A7C 50     10616 DB	"PLOT"
003A7D 4C   
003A7E 4F   
003A7F 54   
003A80 B0     10617 DB	0B0H
003A81 50     10618 DB	"POINT("
003A82 4F   
003A83 49   
003A84 4E   
003A85 54   
003A86 28   
003A87 F2     10619 DB	0F2H
003A88 50     10620 DB	"PROC"
003A89 52   
003A8A 4F   
003A8B 43   
003A8C B1     10621 DB	0B1H
003A8D 50     10622 DB	"POS "
003A8E 4F   
003A8F 53   
003A90 20   
003A91 0E     10623 DB	0EH
003A92 50     10624 DB	"PUT"		; Token changed
003A93 55   
003A94 54   
003A95 06     10625 DB	06H
003A96 51     10626 DB	"QUIT "		; v5
003A97 55   
003A98 49   
003A99 54   
003A9A 20   
003A9B F8     10627 DB	0F8H
003A9C 52     10628 DB	"RETURN "
003A9D 45   
003A9E 54   
003A9F 55   
003AA0 52   
003AA1 4E   
003AA2 20   
003AA3 F5     10629 DB	0F5H
003AA4 52     10630 DB	"REPEAT"
003AA5 45   
003AA6 50   
003AA7 45   
003AA8 41   
003AA9 54   
003AAA F6     10631 DB	0F6H
003AAB 52     10632 DB	"REPORT "
003AAC 45   
003AAD 50   
003AAE 4F   
003AAF 52   
003AB0 54   
003AB1 20   
003AB2 F3     10633 DB	0F3H
003AB3 52     10634 DB	"READ"
003AB4 45   
003AB5 41   
003AB6 44   
003AB7 F4     10635 DB	0F4H
003AB8 52     10636 DB	"REM"
003AB9 45   
003ABA 4D   
003ABB F9     10637 DB	0F9H
003ABC 52     10638 DB	"RUN "
003ABD 55   
003ABE 4E   
003ABF 20   
003AC0 B2     10639 DB	0B2H
003AC1 52     10640 DB	"RAD"
003AC2 41   
003AC3 44   
003AC4 F7     10641 DB	0F7H
003AC5 52     10642 DB	"RESTORE"
003AC6 45   
003AC7 53   
003AC8 54   
003AC9 4F   
003ACA 52   
003ACB 45   
003ACC C2     10643 DB	0C2H
003ACD 52     10644 DB	"RIGHT$("
003ACE 49   
003ACF 47   
003AD0 48   
003AD1 54   
003AD2 24   
003AD3 28   
003AD4 B3     10645 DB	0B3H
003AD5 52     10646 DB	"RND "
003AD6 4E   
003AD7 44   
003AD8 20   
003AD9 07     10647 DB	07H
003ADA 52     10648 DB	"RECTANGLE"	; v5
003ADB 45   
003ADC 43   
003ADD 54   
003ADE 41   
003ADF 4E   
003AE0 47   
003AE1 4C   
003AE2 45   
003AE3 88     10649 DB	88H
003AE4 53     10650 DB	"STEP"
003AE5 54   
003AE6 45   
003AE7 50   
003AE8 B4     10651 DB	0B4H
003AE9 53     10652 DB	"SGN"
003AEA 47   
003AEB 4E   
003AEC B5     10653 DB	0B5H
003AED 53     10654 DB	"SIN"
003AEE 49   
003AEF 4E   
003AF0 B6     10655 DB	0B6H
003AF1 53     10656 DB	"SQR"
003AF2 51   
003AF3 52   
003AF4 89     10657 DB	89H
003AF5 53     10658 DB	"SPC"
003AF6 50   
003AF7 43   
003AF8 C3     10659 DB	0C3H
003AF9 53     10660 DB	"STR$"
003AFA 54   
003AFB 52   
003AFC 24   
003AFD C4     10661 DB	0C4H
003AFE 53     10662 DB	"STRING$("
003AFF 54   
003B00 52   
003B01 49   
003B02 4E   
003B03 47   
003B04 24   
003B05 28   
003B06 D4     10663 DB	0D4H
003B07 53     10664 DB	"SOUND"
003B08 4F   
003B09 55   
003B0A 4E   
003B0B 44   
003B0C FA     10665 DB	0FAH
003B0D 53     10666 DB	"STOP "
003B0E 54   
003B0F 4F   
003B10 50   
003B11 20   
003B12 C6     10667 DB	0C6H
003B13 53     10668 DB	"SUM"		; v5
003B14 55   
003B15 4D   
003B16 08     10669 DB	08H
003B17 53     10670 DB	"SWAP"		; v5
003B18 57   
003B19 41   
003B1A 50   
003B1B 09     10671 DB	09H
003B1C 53     10672 DB	"SYS"		; v5
003B1D 59   
003B1E 53   
003B1F B7     10673 DB	0B7H
003B20 54     10674 DB	"TAN"
003B21 41   
003B22 4E   
003B23 8A     10675 DB	8AH
003B24 54     10676 DB	"TAB("
003B25 41   
003B26 42   
003B27 28   
003B28 8C     10677 DB	8CH
003B29 54     10678 DB	"THEN"
003B2A 48   
003B2B 45   
003B2C 4E   
003B2D 91     10679 DB	91H
003B2E 54     10680 DB	"TIME "
003B2F 49   
003B30 4D   
003B31 45   
003B32 20   
003B33 0A     10681 DB	0AH
003B34 54     10682 DB	"TINT"
003B35 49   
003B36 4E   
003B37 54   
003B38 B8     10683 DB	0B8H
003B39 54     10684 DB	"TO"
003B3A 4F   
003B3B FC     10685 DB	0FCH
003B3C 54     10686 DB	"TRACE"
003B3D 52   
003B3E 41   
003B3F 43   
003B40 45   
003B41 B9     10687 DB	0B9H
003B42 54     10688 DB	"TRUE "
003B43 52   
003B44 55   
003B45 45   
003B46 20   
003B47 FD     10689 DB	0FDH
003B48 55     10690 DB	"UNTIL"
003B49 4E   
003B4A 54   
003B4B 49   
003B4C 4C   
003B4D BA     10691 DB	0BAH
003B4E 55     10692 DB	"USR"
003B4F 53   
003B50 52   
003B51 EF     10693 DB	0EFH
003B52 56     10694 DB	"VDU"
003B53 44   
003B54 55   
003B55 BB     10695 DB	0BBH
003B56 56     10696 DB	"VAL"
003B57 41   
003B58 4C   
003B59 BC     10697 DB	0BCH
003B5A 56     10698 DB	"VPOS "
003B5B 50   
003B5C 4F   
003B5D 53   
003B5E 20   
003B5F C7     10699 DB	0C7H
003B60 57     10700 DB	"WHILE"		; v5
003B61 48   
003B62 49   
003B63 4C   
003B64 45   
003B65 C9     10701 DB	0C9H
003B66 57     10702 DB	"WHEN"		; v5
003B67 48   
003B68 45   
003B69 4E   
003B6A 0B     10703 DB	0BH
003B6B 57     10704 DB	"WAIT "		; v5
003B6C 41   
003B6D 49   
003B6E 54   
003B6F 20   
003B70 FE     10705 DB	0FEH
003B71 57     10706 DB	"WIDTH"
003B72 49   
003B73 44   
003B74 54   
003B75 48   
003B76 CF     10708 DB	0CFH
003B77 50     10709 DB	"PTR"
003B78 54   
003B79 52   
003B7A D1     10710 DB	0D1H
003B7B 54     10711 DB	"TIME"
003B7C 49   
003B7D 4D   
003B7E 45   
003B7F D3     10712 DB	0D3H
003B80 48     10713 DB	"HIMEM"
003B81 49   
003B82 4D   
003B83 45   
003B84 4D   
003B85 D2     10714 DB	0D2H
003B86 4C     10715 DB	"LOMEM"
003B87 4F   
003B88 4D   
003B89 45   
003B8A 4D   
003B8B D0     10716 DB	0D0H
003B8C 50     10717 DB	"PAGE"
003B8D 41   
003B8E 47   
003B8F 45   
003B90 11     10719 DB	11H
003B91 4D     10720 DB	"Missing "
003B92 69   
003B93 73   
003B94 73   
003B95 69   
003B96 6E   
003B97 67   
003B98 20   
003B99 12     10721 DB	12H
003B9A 4E     10722 DB	"No such "
003B9B 6F   
003B9C 20   
003B9D 73   
003B9E 75   
003B9F 63   
003BA0 68   
003BA1 20   
003BA2 13     10723 DB	13H
003BA3 42     10724 DB	"Bad "
003BA4 61   
003BA5 64   
003BA6 20   
003BA7 14     10725 DB	14H
003BA8 20     10726 DB	" range"
003BA9 72   
003BAA 61   
003BAB 6E   
003BAC 67   
003BAD 65   
003BAE 15     10727 DB	15H
003BAF 76     10728 DB	"variable"
003BB0 61   
003BB1 72   
003BB2 69   
003BB3 61   
003BB4 62   
003BB5 6C   
003BB6 65   
003BB7 16     10729 DB	16H
003BB8 4F     10730 DB	"Out of"
003BB9 75   
003BBA 74   
003BBB 20   
003BBC 6F   
003BBD 66   
003BBE 17     10731 DB	17H
003BBF 4E     10732 DB	"No "
003BC0 6F   
003BC1 20   
003BC2 18     10733 DB	18H
003BC3 20     10734 DB	" space"
003BC4 73   
003BC5 70   
003BC6 61   
003BC7 63   
003BC8 65   
003BC9 19     10735 DB	19H
003BCA 4E     10736 DB	"Not in a "
003BCB 6F   
003BCC 74   
003BCD 20   
003BCE 69   
003BCF 6E   
003BD0 20   
003BD1 61   
003BD2 20   
003BD3 1A     10737 DB	1AH
003BD4 20     10738 DB	" loop"
003BD5 6C   
003BD6 6F   
003BD7 6F   
003BD8 70   
003BD9 1B     10739 DB	1BH
003BDA 20     10740 DB	" not "
003BDB 6E   
003BDC 6F   
003BDD 74   
003BDE 20   
003BDF FF     10742 DW	-1
003BE0 FF   
003BE1 80     10746 COMNDS:         DB	80H
003BE2 41     10747 DB	"AUTO"
003BE3 55   
003BE4 54   
003BE5 4F   
003BE6 81     10748 DB	81H
003BE7 44     10749 DB	"DELETE"
003BE8 45   
003BE9 4C   
003BEA 45   
003BEB 54   
003BEC 45   
003BED 82     10750 DB	82H
003BEE 4C     10751 DB	"LIST"
003BEF 49   
003BF0 53   
003BF1 54   
003BF2 83     10752 DB	83H
003BF3 4C     10753 DB	"LOAD"
003BF4 4F   
003BF5 41   
003BF6 44   
003BF7 84     10754 DB	84H
003BF8 4E     10755 DB	"NEW "
003BF9 45   
003BFA 57   
003BFB 20   
003BFC 85     10756 DB	85H
003BFD 4F     10757 DB	"OLD "
003BFE 4C   
003BFF 44   
003C00 20   
003C01 86     10758 DB	86H
003C02 52     10759 DB	"RENUMBER"
003C03 45   
003C04 4E   
003C05 55   
003C06 4D   
003C07 42   
003C08 45   
003C09 52   
003C0A 87     10760 DB	87H
003C0B 53     10761 DB	"SAVE"
003C0C 41   
003C0D 56   
003C0E 45   
003C0F FF     10762 DW	-1
003C10 FF   
003C11 E3     10766 CMDTABmn:         DW	AUTO
003C12 3E   
003C13 86     10767 DW	DELETE
003C14 3D   
003C15 AE     10768 DW	LIST
003C16 3D   
003C17 02     10769 DW	LOAD
003C18 3F   
003C19 FD     10770 DW	NEW
003C1A 3E   
003C1B 10     10771 DW	OLD
003C1C 3F   
003C1D 33     10772 DW	RENUM
003C1E 3E   
003C1F 29     10773 DW	SAVE
003C20 3F   
003C21 17     10777 ERRWDS:         DB	17H
003C22 72     10778 DB	"room"
003C23 6F   
003C24 6F   
003C25 6D   
003C26 00     10779 DB	0
003C27 16     10780 DB	16H
003C28 14     10781 DB	14H
003C29 00     10782 DW	0
003C2A 00   
003C2B 4D     10783 DB	"Multiple label"
003C2C 75   
003C2D 6C   
003C2E 74   
003C2F 69   
003C30 70   
003C31 6C   
003C32 65   
003C33 20   
003C34 6C   
003C35 61   
003C36 62   
003C37 65   
003C38 6C   
003C39 00     10784 DB	0
003C3A 4D     10785 DB	"Mistake"
003C3B 69   
003C3C 73   
003C3D 74   
003C3E 61   
003C3F 6B   
003C40 65   
003C41 00     10786 DB	0
003C42 11     10787 DB	11H
003C43 2C     10788 DB	','
003C44 00     10789 DB	0
003C45 54     10790 DB	"Type mismatch"
003C46 79   
003C47 70   
003C48 65   
003C49 20   
003C4A 6D   
003C4B 69   
003C4C 73   
003C4D 6D   
003C4E 61   
003C4F 74   
003C50 63   
003C51 68   
003C52 00     10791 DB	0
003C53 19     10792 DB	19H
003C54 A4     10793 DB	TFN
003C55 00     10794 DW	0
003C56 00   
003C57 11     10795 DB	11H
003C58 22     10796 DB	'"'
003C59 00     10797 DB	0
003C5A 13     10798 DB	13H
003C5B DE     10799 DB	TDIM
003C5C 00     10800 DB	0
003C5D DE     10801 DB	TDIM
003C5E 18     10802 DB	18H
003C5F 00     10803 DB	0
003C60 19     10804 DB	19H
003C61 A4     10805 DB	TFN
003C62 20     10806 DB	" or "
003C63 6F   
003C64 72   
003C65 20   
003C66 F2     10807 DB	TPROC
003C67 00     10808 DB	0
003C68 19     10809 DB	19H
003C69 F2     10810 DB	TPROC
003C6A 00     10811 DB	0
003C6B 13     10812 DB	13H
003C6C 75     10813 DB	"use of array"
003C6D 73   
003C6E 65   
003C6F 20   
003C70 6F   
003C71 66   
003C72 20   
003C73 61   
003C74 72   
003C75 72   
003C76 61   
003C77 79   
003C78 00     10814 DB	0
003C79 13     10815 DB	13H
003C7A 73     10816 DB	"subscript"
003C7B 75   
003C7C 62   
003C7D 73   
003C7E 63   
003C7F 72   
003C80 69   
003C81 70   
003C82 74   
003C83 00     10817 DB	0
003C84 53     10818 DB	"Syntax error"
003C85 79   
003C86 6E   
003C87 74   
003C88 61   
003C89 78   
003C8A 20   
003C8B 65   
003C8C 72   
003C8D 72   
003C8E 6F   
003C8F 72   
003C90 00     10819 DB	0
003C91 45     10820 DB	"Escape"
003C92 73   
003C93 63   
003C94 61   
003C95 70   
003C96 65   
003C97 00     10821 DB	0
003C98 44     10822 DB	"Division by zero"
003C99 69   
003C9A 76   
003C9B 69   
003C9C 73   
003C9D 69   
003C9E 6F   
003C9F 6E   
003CA0 20   
003CA1 62   
003CA2 79   
003CA3 20   
003CA4 7A   
003CA5 65   
003CA6 72   
003CA7 6F   
003CA8 00     10823 DB	0
003CA9 53     10824 DB	"String too long"
003CAA 74   
003CAB 72   
003CAC 69   
003CAD 6E   
003CAE 67   
003CAF 20   
003CB0 74   
003CB1 6F   
003CB2 6F   
003CB3 20   
003CB4 6C   
003CB5 6F   
003CB6 6E   
003CB7 67   
003CB8 00     10825 DB	0
003CB9 4E     10826 DB	"Number too big"
003CBA 75   
003CBB 6D   
003CBC 62   
003CBD 65   
003CBE 72   
003CBF 20   
003CC0 74   
003CC1 6F   
003CC2 6F   
003CC3 20   
003CC4 62   
003CC5 69   
003CC6 67   
003CC7 00     10827 DB	0
003CC8 2D     10828 DB	"-ve root"
003CC9 76   
003CCA 65   
003CCB 20   
003CCC 72   
003CCD 6F   
003CCE 6F   
003CCF 74   
003CD0 00     10829 DB	0
003CD1 4C     10830 DB	"Log"
003CD2 6F   
003CD3 67   
003CD4 14     10831 DB	14H
003CD5 00     10832 DB	0
003CD6 41     10833 DB	"Accuracy lost"
003CD7 63   
003CD8 63   
003CD9 75   
003CDA 72   
003CDB 61   
003CDC 63   
003CDD 79   
003CDE 20   
003CDF 6C   
003CE0 6F   
003CE1 73   
003CE2 74   
003CE3 00     10834 DB	0
003CE4 45     10835 DB	"Exponent"
003CE5 78   
003CE6 70   
003CE7 6F   
003CE8 6E   
003CE9 65   
003CEA 6E   
003CEB 74   
003CEC 14     10836 DB	14H
003CED 00     10837 DW	0
003CEE 00   
003CEF 12     10838 DB	12H
003CF0 15     10839 DB	15H
003CF1 00     10840 DB	0
003CF2 11     10841 DB	11H
003CF3 29     10842 DB	')'
003CF4 00     10843 DB	0
003CF5 13     10844 DB	13H
003CF6 68     10845 DB	"hex or binary"
003CF7 65   
003CF8 78   
003CF9 20   
003CFA 6F   
003CFB 72   
003CFC 20   
003CFD 62   
003CFE 69   
003CFF 6E   
003D00 61   
003D01 72   
003D02 79   
003D03 00     10846 DB	0
003D04 12     10847 DB	12H
003D05 A4     10848 DB	TFN
003D06 2F     10849 DB	'/'
003D07 F2     10850 DB	TPROC
003D08 00     10851 DB	0
003D09 13     10852 DB	13H
003D0A 63     10853 DB	"call"
003D0B 61   
003D0C 6C   
003D0D 6C   
003D0E 00     10854 DB	0
003D0F 13     10855 DB	13H
003D10 61     10856 DB	"arguments"
003D11 72   
003D12 67   
003D13 75   
003D14 6D   
003D15 65   
003D16 6E   
003D17 74   
003D18 73   
003D19 00     10857 DB	0
003D1A 19     10858 DB	19H
003D1B E3     10859 DB	TFOR
003D1C 1A     10860 DB	1AH
003D1D 00     10861 DB	0
003D1E 43     10862 DB	"Can't match "
003D1F 61   
003D20 6E   
003D21 27   
003D22 74   
003D23 20   
003D24 6D   
003D25 61   
003D26 74   
003D27 63   
003D28 68   
003D29 20   
003D2A E3     10863 DB	TFOR
003D2B 00     10864 DB	0
003D2C 13     10865 DB	13H
003D2D E3     10866 DB	TFOR
003D2E 20     10867 DB	' '
003D2F 15     10868 DB	15H
003D30 00     10869 DW	0
003D31 00   
003D32 11     10870 DB	11H
003D33 B8     10871 DB	TTO
003D34 00     10872 DW	0
003D35 00   
003D36 17     10873 DB	17H
003D37 E4     10874 DB	TGOSUB
003D38 00     10875 DB	0
003D39 EE     10876 DB	TON
003D3A 20     10877 DB	" syntax"
003D3B 73   
003D3C 79   
003D3D 6E   
003D3E 74   
003D3F 61   
003D40 78   
003D41 00     10878 DB	0
003D42 EE     10879 DB	TON
003D43 14     10880 DB	14H
003D44 00     10881 DB	0
003D45 12     10882 DB	12H
003D46 6C     10883 DB	"line"
003D47 69   
003D48 6E   
003D49 65   
003D4A 00     10884 DB	0
003D4B 16     10885 DB	16H
003D4C 20     10886 DB	' '
003D4D DC     10887 DB	TDATA
003D4E 00     10888 DB	0
003D4F 19     10889 DB	19H
003D50 F5     10890 DB	TREPEAT
003D51 1A     10891 DB	1AH
003D52 00     10892 DB	0
003D53 13     10893 DB	13H
003D54 10     10894 DB	TEXIT
003D55 00     10895 DB	0
003D56 11     10896 DB	11H
003D57 23     10897 DB	'#'
003D58 00     10898 DB	0
003D59 19     10899 DB	19H		;46 Not in a WHILE loop
003D5A C7     10900 DB	TWHILE
003D5B 1A     10901 DB	1AH
003D5C 00     10902 DB	0
003D5D 11     10903 DB	11H		;47 Missing ENDCASE
003D5E CB     10904 DB	TENDCASE
003D5F 00     10905 DB	0
003D60 CA     10906 DB	TOF		;48 OF not last
003D61 1B     10907 DB	1BH
003D62 6C     10908 DB	"last"
003D63 61   
003D64 73   
003D65 74   
003D66 00     10909 DB	0
003D67 11     10910 DB	11H		;49 Missing ENDIF
003D68 CD     10911 DB	TENDIF
003D69 00     10912 DB	0
003D6A 00     10913 DW	0
003D6B 00   
003D6C 00     10914 DB	0
003D6D EE     10915 DB	TON		;53 ON ERROR not LOCAL
003D6E 20     10916 DB	' '
003D6F 85     10917 DB	TERROR
003D70 1B     10918 DB	1BH
003D71 EA     10919 DB	TLOCAL
003D72 00     10920 DB	0
003D73 DC     10921 DB	TDATA		;54 DATA not LOCAL
003D74 1B     10922 DB	1BH
003D75 EA     10923 DB	TLOCAL
003D76 00     10924 DB	0
003D77 E3     10928 TOKADD:         DB	TFOR
003D78 F5     10929 DB	TREPEAT
003D79 C7     10930 DB	TWHILE
003D7A C8     10931 DB	TCASE
003D7B 8B     10932 DB	TELSE
003D7C C9     10933 DB	TWHEN
003D7D CC     10934 DB	TOTHERWISE
003D7E ED     10939 TOKSUB:         DB	TNEXT
003D7F FD     10940 DB	TUNTIL
003D80 CE     10941 DB	TENDWHILE
003D81 CB     10942 DB	TENDCASE
003D82 CD     10943 DB	TENDIF
003D83 8B     10944 DB	TELSE
003D84 C9     10945 DB	TWHEN
003D85 CC     10946 DB	TOTHERWISE
003D86 CD     10953 DELETE:         CALL	DLPAIR
003D87 D7   
003D88 43   
003D89 7E     10954 DELET1:         LD	A,(HL)
003D8A B7     10955 OR	A
003D8B 28     10956 JR	Z,WARMNC
003D8C 79   
003D8D 23     10957 INC	HL
003D8E 5E     10958 LD	E,(HL)
003D8F 23     10959 INC	HL
003D90 56     10960 LD	D,(HL)
003D91 2B     10961 DEC	HL
003D92 2B     10962 DEC	HL
003D93 EB     10963 EX	DE,HL
003D94 37     10964 SCF
003D95 ED     10965 SBC	HL,BC
003D96 42   
003D97 EB     10966 EX	DE,HL
003D98 30     10967 JR	NC,WARMNC
003D99 6C   
003D9A C5     10968 PUSH	BC
003D9B CD     10969 CALL	DEL
003D9C E9   
003D9D 3F   
003D9E C1     10970 POP	BC
003D9F 18     10971 JR	DELET1
003DA0 E8   
003DA1 FD     10975 LISTO:          INC	IY		;SKIP "O"
003DA2 23   
003DA3 CD     10976 CALL	EXPRI
003DA4 33   
003DA5 18   
003DA6 D9     10977 EXX
003DA7 7D     10978 LD	A,L
003DA8 32     10979 LD	(LISTON),A
003DA9 FE   
003DAA 54   
003DAB C3     10980 JP	CLOOP
003DAC B0   
003DAD 37   
003DAE FE     10988 LIST:           CP	'O'
003DAF 4F   
003DB0 28     10989 JR	Z,LISTO
003DB1 EF   
003DB2 0E     10990 LD	C,1
003DB3 01   
003DB4 11     10991 LD	DE,BUFFER
003DB5 00   
003DB6 53   
003DB7 CD     10992 CALL	LEXAN2
003DB8 18   
003DB9 44   
003DBA 12     10993 LD	(DE),A
003DBB FD     10994 LD	IY,BUFFER
003DBC 21   
003DBD 00   
003DBE 53   
003DBF CD     10995 CALL	DLPAIR
003DC0 D7   
003DC1 43   
003DC2 CD     10996 CALL	NXT
003DC3 0B   
003DC4 45   
003DC5 FE     10997 CP	TIF		;IF CLAUSE ?
003DC6 E7   
003DC7 3E     10998 LD	A,0		;INIT IF-CLAUSE LENGTH
003DC8 00   
003DC9 20     10999 JR	NZ,LISTB
003DCA 15   
003DCB FD     11000 INC	IY		;SKIP IF
003DCC 23   
003DCD CD     11001 CALL	NXT		;SKIP SPACES (IF ANY)
003DCE 0B   
003DCF 45   
003DD0 EB     11002 EX	DE,HL
003DD1 FD     11003 PUSH	IY
003DD2 E5   
003DD3 E1     11004 POP	HL		;HL ADDRESSES IF CLAUSE
003DD4 3E     11005 LD	A,CR
003DD5 0D   
003DD6 C5     11006 PUSH	BC
003DD7 01     11007 LD	BC,256
003DD8 00   
003DD9 01   
003DDA ED     11008 CPIR			;LOCATE CR
003DDB B1   
003DDC 79     11009 LD	A,C
003DDD 2F     11010 CPL			;A = SUBSTRING LENGTH
003DDE C1     11011 POP	BC
003DDF EB     11012 EX	DE,HL
003DE0 5F     11013 LISTB:          LD	E,A		;IF-CLAUSE LENGTH
003DE1 78     11014 LD	A,B
003DE2 B1     11015 OR	C
003DE3 20     11016 JR	NZ,LISTA
003DE4 01   
003DE5 0B     11017 DEC	BC
003DE6 D9     11018 LISTA:          EXX
003DE7 DD     11019 LD	IX,LISTON
003DE8 21   
003DE9 FE   
003DEA 54   
003DEB 1E     11020 LD	E,0		;INDENTATION COUNT
003DEC 00   
003DED D9     11021 EXX
003DEE 3E     11022 LD	A,20
003DEF 14   
003DF0 C5     11024 LISTC:          PUSH	BC		;SAVE HIGH LINE NUMBER
003DF1 D5     11025 PUSH	DE		;SAVE IF-CLAUSE LENGTH
003DF2 E5     11026 PUSH	HL		;SAVE PROGRAM POINTER
003DF3 08     11027 EX	AF,AF'
003DF4 7E     11028 LD	A,(HL)
003DF5 B7     11029 OR	A
003DF6 28     11030 JR	Z,WARMNC
003DF7 0E   
003DF8 7B     11034 LD	A,E		;A = IF-CLAUSE LENGTH
003DF9 23     11035 INC	HL
003DFA 5E     11036 LD	E,(HL)
003DFB 23     11037 INC	HL
003DFC 56     11038 LD	D,(HL)		;DE = LINE NUMBER
003DFD 2B     11039 DEC	HL
003DFE 2B     11040 DEC	HL
003DFF D5     11041 PUSH	DE		;SAVE LINE NUMBER
003E00 EB     11042 EX	DE,HL
003E01 37     11043 SCF
003E02 ED     11044 SBC	HL,BC
003E03 42   
003E04 EB     11045 EX	DE,HL
003E05 D1     11046 POP	DE		;RESTORE LINE NUMBER
003E06 D2     11047 WARMNC:         JP	NC,WARM
003E07 AF   
003E08 37   
003E09 4E     11048 LD	C,(HL)		;C = LINE LENGTH + 4
003E0A 47     11049 LD	B,A		;B = IF-CLAUSE LENGTH
003E0B 23     11053 INC	HL
003E0C 23     11054 INC	HL
003E0D 23     11055 INC	HL		;HL ADDRESSES LINE TEXT
003E0E 0D     11056 DEC	C
003E0F 0D     11057 DEC	C
003E10 0D     11058 DEC	C
003E11 0D     11059 DEC	C		;C = LINE LENGTH
003E12 D5     11060 PUSH	DE		;SAVE LINE NUMBER
003E13 E5     11061 PUSH	HL		;SAVE LINE ADDRESS
003E14 AF     11062 XOR	A		;A <- 0
003E15 B8     11063 CP	B		;WAS THERE AN IF-CLAUSE
003E16 FD     11064 PUSH	IY
003E17 E5   
003E18 D1     11065 POP	DE		;DE ADDRESSES IF-CLAUSE
003E19 C4     11066 CALL	NZ,SEARCH	;SEARCH FOR IF CLAUSE
003E1A F2   
003E1B 1D   
003E1C E1     11067 POP	HL		;RESTORE LINE ADDRESS
003E1D D1     11068 POP	DE		;RESTORE LINE NUMBER
003E1E FD     11069 PUSH	IY
003E1F E5   
003E20 CC     11070 CALL	Z,LISTIT	;LIST IF MATCH
003E21 5D   
003E22 40   
003E23 FD     11071 POP	IY
003E24 E1   
003E25 08     11073 EX	AF,AF'
003E26 3D     11074 DEC	A
003E27 CD     11075 CALL	LTRAP
003E28 36   
003E29 06   
003E2A E1     11076 POP	HL		;RESTORE POINTER
003E2B 5E     11077 LD	E,(HL)
003E2C 16     11078 LD	D,0
003E2D 00   
003E2E 19     11079 ADD	HL,DE		;ADDRESS NEXT LINE
003E2F D1     11080 POP	DE		;RESTORE IF-CLAUSE LEN
003E30 C1     11081 POP	BC		;RESTORE HI LINE NUMBER
003E31 18     11082 JR	LISTC
003E32 BD   
003E33 CD     11089 RENUM:          CALL	CLEAR		;USES DYNAMIC AREA
003E34 43   
003E35 40   
003E36 CD     11090 CALL	PAIR		;LOAD HL,BC
003E37 B4   
003E38 43   
003E39 D9     11091 EXX
003E3A 2A     11092 LD	HL,(PAGE_)
003E3B DC   
003E3C 54   
003E3D ED     11093 LD	DE,(LOMEM)
003E3E 5B   
003E3F DE   
003E40 54   
003E41 7E     11094 RENUM1:         LD	A,(HL)		;BUILD TABLE
003E42 B7     11095 OR	A
003E43 28     11096 JR	Z,RENUM2
003E44 28   
003E45 23     11097 INC	HL
003E46 4E     11098 LD	C,(HL)		;OLD LINE NUMBER
003E47 23     11099 INC	HL
003E48 46     11100 LD	B,(HL)
003E49 EB     11101 EX	DE,HL
003E4A 71     11102 LD	(HL),C
003E4B 23     11103 INC	HL
003E4C 70     11104 LD	(HL),B
003E4D 23     11105 INC	HL
003E4E D9     11106 EXX
003E4F E5     11107 PUSH	HL
003E50 09     11108 ADD	HL,BC		;ADD INCREMENT
003E51 DA     11109 JP	C,TOOBIGmn	;"Too big"
003E52 AF   
003E53 43   
003E54 D9     11110 EXX
003E55 C1     11111 POP	BC
003E56 71     11112 LD	(HL),C
003E57 23     11113 INC	HL
003E58 70     11114 LD	(HL),B
003E59 23     11115 INC	HL
003E5A EB     11116 EX	DE,HL
003E5B 2B     11117 DEC	HL
003E5C 2B     11118 DEC	HL
003E5D AF     11119 XOR	A
003E5E 47     11120 LD	B,A
003E5F 4E     11121 LD	C,(HL)
003E60 09     11122 ADD	HL,BC		;NEXT LINE
003E61 EB     11123 EX	DE,HL
003E62 E5     11124 PUSH	HL
003E63 24     11125 INC	H
003E64 ED     11126 SBC	HL,SP
003E65 72   
003E66 E1     11127 POP	HL
003E67 EB     11128 EX	DE,HL
003E68 38     11129 JR	C,RENUM1	;CONTINUE
003E69 D7   
003E6A C3     11130 JP	ERROR_		;'No room' (A = 0)
003E6B 44   
003E6C 3F   
003E6D EB     11132 RENUM2:         EX	DE,HL
003E6E 36     11133 LD	(HL),-1
003E6F FF   
003E70 23     11134 INC	HL
003E71 36     11135 LD	(HL),-1
003E72 FF   
003E73 ED     11136 LD	DE,(LOMEM)
003E74 5B   
003E75 DE   
003E76 54   
003E77 D9     11137 EXX
003E78 2A     11138 LD	HL,(PAGE_)
003E79 DC   
003E7A 54   
003E7B 4E     11139 RENUM3:         LD	C,(HL)
003E7C 79     11140 LD	A,C
003E7D B7     11141 OR	A
003E7E 28     11142 JR	Z,WARMNC
003E7F 86   
003E80 D9     11143 EXX
003E81 EB     11144 EX	DE,HL
003E82 23     11145 INC	HL
003E83 23     11146 INC	HL
003E84 5E     11147 LD	E,(HL)
003E85 23     11148 INC	HL
003E86 56     11149 LD	D,(HL)
003E87 23     11150 INC	HL
003E88 D5     11151 PUSH	DE
003E89 EB     11152 EX	DE,HL
003E8A D9     11153 EXX
003E8B D1     11154 POP	DE
003E8C 23     11155 INC	HL
003E8D 73     11156 LD	(HL),E		;NEW LINE NUMBER
003E8E 23     11157 INC	HL
003E8F 72     11158 LD	(HL),D
003E90 23     11159 INC	HL
003E91 0D     11160 DEC	C
003E92 0D     11161 DEC	C
003E93 0D     11162 DEC	C
003E94 06     11163 LD	B,0
003E95 00   
003E96 3E     11164 RENUM7:         LD	A,TLINO
003E97 8D   
003E98 ED     11165 CPIR			;SEARCH FOR LINE NUMBER
003E99 B1   
003E9A 20     11166 JR	NZ,RENUM3
003E9B DF   
003E9C C5     11167 PUSH	BC
003E9D E5     11168 PUSH	HL
003E9E E5     11169 PUSH	HL
003E9F FD     11170 POP	IY
003EA0 E1   
003EA1 D9     11171 EXX
003EA2 E5     11172 PUSH	HL
003EA3 CD     11173 CALL	DECODE		;DECODE LINE NUMBER
003EA4 60   
003EA5 1F   
003EA6 E1     11174 POP	HL
003EA7 D9     11175 EXX
003EA8 44     11176 LD	B,H
003EA9 4D     11177 LD	C,L
003EAA 2A     11178 LD	HL,(LOMEM)
003EAB DE   
003EAC 54   
003EAD 5E     11179 RENUM4:         LD	E,(HL)		;CROSS-REFERENCE TABLE
003EAE 23     11180 INC	HL
003EAF 56     11181 LD	D,(HL)
003EB0 23     11182 INC	HL
003EB1 EB     11183 EX	DE,HL
003EB2 B7     11184 OR	A		;CLEAR CARRY
003EB3 ED     11185 SBC	HL,BC
003EB4 42   
003EB5 EB     11186 EX	DE,HL
003EB6 5E     11187 LD	E,(HL)		;NEW NUMBER
003EB7 23     11188 INC	HL
003EB8 56     11189 LD	D,(HL)
003EB9 23     11190 INC	HL
003EBA 38     11191 JR	C,RENUM4
003EBB F1   
003EBC EB     11192 EX	DE,HL
003EBD 28     11193 JR	Z,RENUM5	;FOUND
003EBE 1A   
003EBF CD     11194 CALL	TELL
003EC0 FA   
003EC1 44   
003EC2 46     11195 DB	"Failed at "
003EC3 61   
003EC4 69   
003EC5 6C   
003EC6 65   
003EC7 64   
003EC8 20   
003EC9 61   
003ECA 74   
003ECB 20   
003ECC 00     11196 DB	0
003ECD D9     11197 EXX
003ECE E5     11198 PUSH	HL
003ECF D9     11199 EXX
003ED0 E1     11200 POP	HL
003ED1 CD     11201 CALL	PBCDL
003ED2 92   
003ED3 41   
003ED4 CD     11202 CALL	CRLF
003ED5 FB   
003ED6 40   
003ED7 18     11203 JR	RENUM6
003ED8 06   
003ED9 D1     11204 RENUM5:         POP	DE
003EDA D5     11205 PUSH	DE
003EDB 1B     11206 DEC	DE
003EDC CD     11207 CALL	ENCODE		;RE-WRITE NUMBER
003EDD BF   
003EDE 44   
003EDF E1     11208 RENUM6:         POP	HL
003EE0 C1     11209 POP	BC
003EE1 18     11210 JR	RENUM7
003EE2 B3   
003EE3 CD     11217 AUTO:           CALL	PAIR
003EE4 B4   
003EE5 43   
003EE6 22     11218 LD	(AUTONO),HL
003EE7 E8   
003EE8 54   
003EE9 79     11219 LD	A,C
003EEA 32     11220 LD	(INCREM),A
003EEB FF   
003EEC 54   
003EED 18     11221 JR	CLOOP0
003EEE 37   
003EEF CD     11226 BAD:            CALL	TELL		;"Bad program'
003EF0 FA   
003EF1 44   
003EF2 13     11227 DB	13H
003EF3 70     11228 DB	"program"
003EF4 72   
003EF5 6F   
003EF6 67   
003EF7 72   
003EF8 61   
003EF9 6D   
003EFA 0D     11229 DB	CR
003EFB 0A     11230 DB	LF
003EFC 00     11231 DB	0
003EFD CD     11232 NEW:            CALL	NEWIT
003EFE 3E   
003EFF 40   
003F00 18     11233 JR	CLOOP0
003F01 24   
003F02 CD     11237 LOAD:           CALL	EXPRS		;GET FILENAME
003F03 3C   
003F04 18   
003F05 3E     11238 LD	A,CR
003F06 0D   
003F07 12     11239 LD	(DE),A
003F08 CD     11240 CALL	LOAD0
003F09 00   
003F0A 40   
003F0B CD     11241 CALL	CLEAR
003F0C 43   
003F0D 40   
003F0E 18     11242 JR	WARM0
003F0F 31   
003F10 2A     11246 OLD:            LD	HL,(PAGE_)
003F11 DC   
003F12 54   
003F13 E5     11247 PUSH	HL
003F14 23     11248 INC	HL
003F15 23     11249 INC	HL
003F16 23     11250 INC	HL
003F17 01     11251 LD	BC,252
003F18 FC   
003F19 00   
003F1A 3E     11252 LD	A,CR
003F1B 0D   
003F1C ED     11253 CPIR
003F1D B1   
003F1E 20     11254 JR	NZ,BAD
003F1F CF   
003F20 7D     11255 LD	A,L
003F21 E1     11256 POP	HL
003F22 77     11257 LD	(HL),A
003F23 CD     11258 CALL	CLEAN
003F24 1A   
003F25 40   
003F26 C3     11259 CLOOP0:         JP	CLOOP
003F27 B0   
003F28 37   
003F29 CD     11263 SAVE:           CALL	EXPRS		;FILENAME
003F2A 3C   
003F2B 18   
003F2C 3E     11264 LD	A,CR
003F2D 0D   
003F2E 12     11265 LD	(DE),A
003F2F ED     11266 LD	DE,(PAGE_)
003F30 5B   
003F31 DC   
003F32 54   
003F33 CD     11267 CALL	GETTOP
003F34 25   
003F35 40   
003F36 B7     11268 OR	A
003F37 ED     11269 SBC	HL,DE
003F38 52   
003F39 44     11270 LD	B,H		;LENGTH OF PROGRAM
003F3A 4D     11271 LD	C,L
003F3B 21     11272 LD	HL,ACCS
003F3C 00   
003F3D 52   
003F3E CD     11273 CALL	OSSAVE
003F3F C2   
003F40 07   
003F41 C3     11274 WARM0:          JP	WARM
003F42 AF   
003F43 37   
003F44 21     11279 ERROR_:         LD	HL,ERRWDS
003F45 21   
003F46 3C   
003F47 4F     11280 LD	C,A
003F48 B7     11281 OR	A
003F49 28     11282 JR	Z,ERROR1
003F4A 0C   
003F4B 47     11283 LD	B,A		;ERROR NUMBER
003F4C AF     11284 XOR	A
003F4D BE     11285 ERROR0:         CP	(HL)
003F4E 23     11286 INC	HL
003F4F 20     11287 JR	NZ,ERROR0
003F50 FC   
003F51 10     11288 DJNZ	ERROR0
003F52 FA   
003F53 18     11289 JR	ERROR1		;MUST NOT PUSH HL HERE
003F54 02   
003F55 E1     11291 EXTERR:         POP	HL
003F56 4F     11292 LD	C,A
003F57 22     11293 ERROR1:         LD	(ERRTXT),HL
003F58 EE   
003F59 54   
003F5A 2A     11294 LD	HL,(ONERSP)
003F5B EC   
003F5C 54   
003F5D 7C     11295 LD	A,H
003F5E B5     11296 OR	L
003F5F ED     11297 LD	SP,(HIMEM)	;MUST SET SP BEFORE 'CALL'
003F60 7B   
003F61 E2   
003F62 54   
003F63 28     11298 JR	Z,ERROR4
003F64 01   
003F65 F9     11299 LD	SP,HL
003F66 79     11300 ERROR4:         LD	A,C		;ERROR NUMBER
003F67 CD     11301 CALL	SETLIN		;SP IS SET NOW
003F68 5B   
003F69 41   
003F6A 32     11302 LD	(ERR),A
003F6B FD   
003F6C 54   
003F6D 22     11303 LD	(ERL),HL
003F6E F2   
003F6F 54   
003F70 B7     11304 OR	A
003F71 28     11305 JR	Z,ERROR2	;'FATAL' ERROR
003F72 0B   
003F73 2A     11306 LD	HL,(ERRTRP)
003F74 EA   
003F75 54   
003F76 7C     11307 LD	A,H
003F77 B5     11308 OR	L
003F78 E5     11309 PUSH	HL
003F79 FD     11310 POP	IY
003F7A E1   
003F7B C2     11311 JP	NZ,XEQ		;ERROR TRAPPED
003F7C 99   
003F7D 24   
003F7E ED     11312 ERROR2:         LD	SP,(HIMEM)
003F7F 7B   
003F80 E2   
003F81 54   
003F82 ED     11313 SBC	HL,HL
003F83 62   
003F84 22     11314 LD	(AUTONO),HL
003F85 E8   
003F86 54   
003F87 22     11315 LD	(TRACEN),HL	;CANCEL TRACE
003F88 E6   
003F89 54   
003F8A CD     11316 CALL	RESET		;RESET OPSYS
003F8B 43   
003F8C 06   
003F8D CD     11317 CALL	CRLF
003F8E FB   
003F8F 40   
003F90 CD     11318 CALL	REPORT		;MESSAGE
003F91 E5   
003F92 44   
003F93 2A     11319 LD	HL,(ERL)
003F94 F2   
003F95 54   
003F96 CD     11320 CALL	SAYLN
003F97 82   
003F98 41   
003F99 1E     11321 LD	E,0
003F9A 00   
003F9B DC     11322 CALL	C,OSSHUT	;CLOSE ALL FILES
003F9C 53   
003F9D 06   
003F9E CD     11323 CALL	CRLF
003F9F FB   
003FA0 40   
003FA1 18     11324 JR	CLOOP0
003FA2 83   
003FA3 21     11337 LEX:            LD	HL,KEYWDS
003FA4 84   
003FA5 38   
003FA6 FD     11338 LEX0:           LD	A,(IY)
003FA7 7E   
003FA8 00   
003FA9 46     11339 LD	B,(HL)
003FAA 23     11340 INC	HL
003FAB BE     11341 CP	(HL)
003FAC 28     11342 JR	Z,LEX2
003FAD 0A   
003FAE D8     11343 RET	C		;FAIL EXIT
003FAF 23     11344 LEX1:           INC	HL
003FB0 7E     11345 LD	A,(HL)
003FB1 FE     11346 CP	160
003FB2 A0   
003FB3 EA     11347 JP	PE,LEX1
003FB4 AF   
003FB5 3F   
003FB6 18     11348 JR	LEX0
003FB7 EE   
003FB8 FD     11350 LEX2:           PUSH	IY		;SAVE POINTER
003FB9 E5   
003FBA 23     11351 LEX3:           INC	HL
003FBB 7E     11352 LD	A,(HL)
003FBC FE     11353 CP	160
003FBD A0   
003FBE E2     11354 JP	PO,LEX6		;FOUND
003FBF E5   
003FC0 3F   
003FC1 FD     11355 INC	IY
003FC2 23   
003FC3 FD     11356 LD	A,(IY)
003FC4 7E   
003FC5 00   
003FC6 BE     11357 CP	(HL)
003FC7 20     11358 JR	NZ,LEX7
003FC8 05   
003FC9 FE     11359 CP	161
003FCA A1   
003FCB EA     11360 JP	PE,LEX3
003FCC BA   
003FCD 3F   
003FCE FD     11361 LEX7:           LD	A,(IY)
003FCF 7E   
003FD0 00   
003FD1 FE     11362 CP	'.'
003FD2 2E   
003FD3 28     11363 JR	Z,LEX6		;FOUND (ABBREV.)
003FD4 10   
003FD5 CD     11364 CALL	RANGE1
003FD6 FC   
003FD7 43   
003FD8 38     11365 JR	C,LEX5
003FD9 04   
003FDA FD     11366 LEX4:           POP	IY		;RESTORE POINTER
003FDB E1   
003FDC 18     11367 JR	LEX1
003FDD D1   
003FDE 7E     11369 LEX5:           LD	A,(HL)
003FDF FE     11370 CP	' '
003FE0 20   
003FE1 20     11371 JR	NZ,LEX4
003FE2 F7   
003FE3 FD     11372 DEC	IY
003FE4 2B   
003FE5 F1     11373 LEX6:           POP	AF
003FE6 AF     11374 XOR	A
003FE7 78     11375 LD	A,B
003FE8 C9     11376 RET
003FE9 D5     11382 DEL:            PUSH	DE
003FEA E5     11383 PUSH	HL
003FEB E5     11384 PUSH	HL
003FEC 06     11385 LD	B,0
003FED 00   
003FEE 4E     11386 LD	C,(HL)
003FEF 09     11387 ADD	HL,BC
003FF0 E5     11388 PUSH	HL
003FF1 EB     11389 EX	DE,HL
003FF2 CD     11390 CALL	GETTOP
003FF3 25   
003FF4 40   
003FF5 ED     11391 SBC	HL,DE
003FF6 52   
003FF7 44     11392 LD	B,H
003FF8 4D     11393 LD	C,L
003FF9 E1     11394 POP	HL
003FFA D1     11395 POP	DE
003FFB ED     11396 LDIR			;DELETE LINE
003FFC B0   
003FFD E1     11397 POP	HL
003FFE D1     11398 POP	DE
003FFF C9     11399 RET
004000 ED     11409 LOAD0:          LD	DE,(PAGE_)
004001 5B   
004002 DC   
004003 54   
004004 21     11410 LD	HL,-256
004005 00   
004006 FF   
004007 39     11411 ADD	HL,SP
004008 ED     11412 SBC	HL,DE		;FIND AVAILABLE SPACE
004009 52   
00400A 44     11413 LD	B,H
00400B 4D     11414 LD	C,L
00400C 21     11415 LD	HL,ACCS
00400D 00   
00400E 52   
00400F CD     11416 CALL	OSLOAD		;LOAD
004010 CC   
004011 06   
004012 D4     11417 CALL	NC,NEWIT
004013 3E   
004014 40   
004015 3E     11418 LD	A,0
004016 00   
004017 D2     11419 JP	NC,ERROR_	;"No room"
004018 44   
004019 3F   
00401A CD     11420 CLEAN:          CALL	GETTOP
00401B 25   
00401C 40   
00401D 2B     11421 DEC	HL
00401E 36     11422 LD	(HL),-1		;WRITE &FFFF
00401F FF   
004020 2B     11423 DEC	HL
004021 36     11424 LD	(HL),-1
004022 FF   
004023 18     11425 JR	CLEAR
004024 1E   
004025 2A     11427 GETTOP:         LD	HL,(PAGE_)
004026 DC   
004027 54   
004028 06     11428 LD	B,0
004029 00   
00402A 3E     11429 LD	A,CR
00402B 0D   
00402C 4E     11430 GETOP1:         LD	C,(HL)
00402D 0C     11431 INC	C
00402E 0D     11432 DEC	C
00402F 28     11433 JR	Z,GETOP2
004030 09   
004031 09     11434 ADD	HL,BC
004032 2B     11435 DEC	HL
004033 BE     11436 CP	(HL)
004034 23     11437 INC	HL
004035 28     11438 JR	Z,GETOP1
004036 F5   
004037 C3     11439 JP	BAD
004038 EF   
004039 3E   
00403A 23     11440 GETOP2:         INC	HL		;N.B. CALLED FROM NEWIT
00403B 23     11441 INC	HL
00403C 23     11442 INC	HL
00403D C9     11443 RET
00403E 2A     11452 NEWIT:          LD	HL,(PAGE_)
00403F DC   
004040 54   
004041 36     11453 LD	(HL),0
004042 00   
004043 E5     11454 CLEAR:          PUSH	HL
004044 C5     11455 PUSH	BC
004045 F5     11456 PUSH	AF
004046 CD     11457 CALL	GETTOP
004047 25   
004048 40   
004049 22     11458 LD	(LOMEM),HL
00404A DE   
00404B 54   
00404C 22     11459 LD	(FREE),HL
00404D E0   
00404E 54   
00404F 21     11460 LD	HL,DYNVAR
004050 6C   
004051 54   
004052 06     11462 LD	B,54+2*2
004053 70   
004054 36     11463 CLEAR1:         LD	(HL),0
004055 00   
004056 23     11464 INC	HL
004057 10     11465 DJNZ	CLEAR1
004058 FB   
004059 F1     11466 POP	AF
00405A C1     11467 POP	BC
00405B E1     11468 POP	HL
00405C C9     11469 RET
00405D E5     11478 LISTIT:         PUSH	HL
00405E EB     11479 EX	DE,HL
00405F C5     11480 PUSH	BC
004060 CD     11481 CALL	PBCD
004061 96   
004062 41   
004063 C1     11482 POP	BC
004064 E1     11483 POP	HL
004065 7E     11484 LD	A,(HL)
004066 D9     11485 EXX
004067 21     11486 LD	HL,TOKSUB
004068 7E   
004069 3D   
00406A 01     11487 LD	BC,LENSUB
00406B 08   
00406C 00   
00406D ED     11488 CPIR
00406E B1   
00406F CC     11489 CALL	Z,INDSUB
004070 F5   
004071 40   
004072 FE     11490 CP	TENDCASE
004073 CB   
004074 CC     11491 CALL	Z,INDSUB
004075 F5   
004076 40   
004077 3E     11492 LD	A,' '
004078 20   
004079 DD     11493 BIT	0,(IX)
00407A CB   
00407B 00   
00407C 46   
00407D C4     11494 CALL	NZ,OUTCHR
00407E 02   
00407F 41   
004080 7B     11495 LD	A,E
004081 87     11496 ADD	A,A
004082 DD     11497 BIT	1,(IX)
004083 CB   
004084 00   
004085 4E   
004086 C4     11498 CALL	NZ,SPACES
004087 A3   
004088 35   
004089 D9     11499 EXX
00408A 7E     11500 LD	A,(HL)
00408B 1E     11501 LD	E,0
00408C 00   
00408D D9     11502 EXX
00408E 01     11503 LD	BC,LENADD
00408F 07   
004090 00   
004091 21     11504 LIST5:          LD	HL,TOKADD
004092 77   
004093 3D   
004094 ED     11505 CPIR
004095 B1   
004096 CC     11506 CALL	Z,INDADD
004097 F9   
004098 40   
004099 FE     11507 CP	TCASE
00409A C8   
00409B CC     11508 CALL	Z,INDADD
00409C F9   
00409D 40   
00409E D9     11509 EXX
00409F 7E     11510 LIST8:          LD	A,(HL)
0040A0 23     11511 INC	HL
0040A1 FE     11512 CP	CR
0040A2 0D   
0040A3 28     11513 JR	Z,LIST9
0040A4 25   
0040A5 57     11514 LD	D,A
0040A6 FE     11515 CP	TEXIT
0040A7 10   
0040A8 20     11516 JR	NZ,LIST6
0040A9 02   
0040AA CB     11517 SET	7,E
0040AB FB   
0040AC FE     11518 LIST6:          CP	'"'
0040AD 22   
0040AE 20     11519 JR	NZ,LIST7
0040AF 01   
0040B0 1C     11520 INC	E
0040B1 CD     11521 LIST7:          CALL	LOUT
0040B2 E9   
0040B3 40   
0040B4 7B     11522 LD	A,E
0040B5 E6     11523 AND	81H
0040B6 81   
0040B7 20     11524 JR	NZ,LIST8
0040B8 E6   
0040B9 7E     11525 LD	A,(HL)
0040BA D9     11526 EXX
0040BB 21     11527 LD	HL,TOKSUB
0040BC 7E   
0040BD 3D   
0040BE 01     11528 LD	BC,3
0040BF 03   
0040C0 00   
0040C1 ED     11529 CPIR
0040C2 B1   
0040C3 CC     11530 CALL	Z,INDSUB
0040C4 F5   
0040C5 40   
0040C6 0E     11531 LD	C,4
0040C7 04   
0040C8 18     11532 JR	LIST5
0040C9 C7   
0040CA 7A     11534 LIST9:          LD	A,D
0040CB FE     11535 CP	TTHEN
0040CC 8C   
0040CD D9     11536 EXX
0040CE CC     11537 CALL	Z,INDADD
0040CF F9   
0040D0 40   
0040D1 D9     11538 EXX
0040D2 18     11539 JR	CRLF
0040D3 27   
0040D4 E5     11541 PRLINO:         PUSH	HL
0040D5 FD     11542 POP	IY
0040D6 E1   
0040D7 C5     11543 PUSH	BC
0040D8 CD     11544 CALL	DECODE
0040D9 60   
0040DA 1F   
0040DB C1     11545 POP	BC
0040DC D9     11546 EXX
0040DD C5     11547 PUSH	BC
0040DE D5     11548 PUSH	DE
0040DF CD     11549 CALL	PBCDL
0040E0 92   
0040E1 41   
0040E2 D1     11550 POP	DE
0040E3 C1     11551 POP	BC
0040E4 D9     11552 EXX
0040E5 FD     11553 PUSH	IY
0040E6 E5   
0040E7 E1     11554 POP	HL
0040E8 C9     11555 RET
0040E9 CB     11557 LOUT:           BIT	0,E
0040EA 43   
0040EB 20     11558 JR	NZ,OUTCHR
0040EC 15   
0040ED FE     11559 CP	TLINO
0040EE 8D   
0040EF 28     11560 JR	Z,PRLINO
0040F0 E3   
0040F1 CD     11561 CALL	OUT
0040F2 1B   
0040F3 41   
0040F4 C9     11562 RET
0040F5 1D     11564 INDSUB:         DEC	E
0040F6 F2     11565 JP	P,INDRET
0040F7 FA   
0040F8 40   
0040F9 1C     11566 INDADD:         INC	E
0040FA C9     11567 INDRET:         RET
0040FB 3E     11575 CRLF:           LD	A,CR
0040FC 0D   
0040FD CD     11576 CALL	OUTCHR
0040FE 02   
0040FF 41   
004100 3E     11577 LD	A,LF
004101 0A   
004102 CD     11578 OUTCHR:         CALL	OSWRCH
004103 B1   
004104 05   
004105 D6     11579 SUB	CR
004106 0D   
004107 28     11580 JR	Z,CARRET
004108 05   
004109 D8     11581 RET	C		;NON-PRINTING
00410A 3A     11582 LD	A,(COUNT)
00410B FB   
00410C 54   
00410D 3C     11583 INC	A
00410E 32     11584 CARRET:         LD	(COUNT),A
00410F FB   
004110 54   
004111 C8     11585 RET	Z
004112 E5     11586 PUSH	HL
004113 2A     11587 LD	HL,(WIDTH)
004114 FC   
004115 54   
004116 BD     11588 CP	L
004117 E1     11589 POP	HL
004118 C0     11590 RET	NZ
004119 18     11591 JR	CRLF
00411A E0   
00411B FE     11598 OUT:            CP	160
00411C A0   
00411D EA     11599 JP	PE,OUTCHR
00411E 02   
00411F 41   
004120 C5     11600 PUSH	BC
004121 E5     11601 PUSH	HL
004122 21     11602 LD	HL,KEYWDS
004123 84   
004124 38   
004125 01     11603 LD	BC,KEYWDL
004126 5B   
004127 03   
004128 ED     11604 CPIR
004129 B1   
00412A C4     11605 CALL	NZ,OUTCHR
00412B 02   
00412C 41   
00412D 06     11606 LD	B,160
00412E A0   
00412F FE     11607 CP	145
004130 91   
004131 EA     11608 JP	PE,TOKEN1
004132 35   
004133 41   
004134 04     11609 INC	B
004135 7E     11610 TOKEN1:         LD	A,(HL)
004136 23     11611 INC	HL
004137 B8     11612 CP	B
004138 F5     11613 PUSH	AF
004139 EC     11614 CALL	PE,OUTCHR
00413A 02   
00413B 41   
00413C F1     11615 POP	AF
00413D EA     11616 JP	PE,TOKEN1
00413E 35   
00413F 41   
004140 E1     11617 POP	HL
004141 C1     11618 POP	BC
004142 C9     11619 RET
004143 EB     11628 FINDL:          EX	DE,HL
004144 2A     11629 LD	HL,(PAGE_)
004145 DC   
004146 54   
004147 AF     11630 XOR	A		;A=0
004148 BE     11631 CP	(HL)
004149 3C     11632 INC	A
00414A D0     11633 RET	NC
00414B AF     11634 XOR	A		;CLEAR CARRY
00414C 47     11635 LD	B,A
00414D 4E     11636 FINDL1:         LD	C,(HL)
00414E E5     11637 PUSH	HL
00414F 23     11638 INC	HL
004150 7E     11639 LD	A,(HL)
004151 23     11640 INC	HL
004152 66     11641 LD	H,(HL)
004153 6F     11642 LD	L,A
004154 ED     11643 SBC	HL,DE
004155 52   
004156 E1     11644 POP	HL
004157 D0     11645 RET	NC		;FOUND | PAST
004158 09     11646 ADD	HL,BC
004159 18     11647 JR	FINDL1
00415A F2   
00415B 06     11654 SETLIN:         LD	B,0
00415C 00   
00415D ED     11655 LD	DE,(CURLIN)
00415E 5B   
00415F F4   
004160 54   
004161 2A     11656 LD	HL,(PAGE_)
004162 DC   
004163 54   
004164 B7     11657 OR	A
004165 ED     11658 SBC	HL,DE
004166 52   
004167 19     11659 ADD	HL,DE
004168 30     11660 JR	NC,SET3
004169 13   
00416A 4E     11661 SET1:           LD	C,(HL)
00416B 0C     11662 INC	C
00416C 0D     11663 DEC	C
00416D 28     11664 JR	Z,SET3
00416E 0E   
00416F 09     11665 ADD	HL,BC
004170 ED     11666 SBC	HL,DE
004171 52   
004172 19     11667 ADD	HL,DE
004173 38     11668 JR	C,SET1
004174 F5   
004175 ED     11669 SBC	HL,BC
004176 42   
004177 23     11670 INC	HL
004178 5E     11671 LD	E,(HL)		;LINE NUMBER
004179 23     11672 INC	HL
00417A 56     11673 LD	D,(HL)
00417B EB     11674 EX	DE,HL
00417C C9     11675 SET2:           RET
00417D 21     11677 SET3:           LD	HL,0
00417E 00   
00417F 00   
004180 18     11678 JR	SET2
004181 FA   
004182 7C     11686 SAYLN:          LD	A,H
004183 B5     11687 OR	L
004184 C8     11688 RET	Z
004185 CD     11689 CALL	TELL
004186 FA   
004187 44   
004188 20     11690 DB	" at line "
004189 61   
00418A 74   
00418B 20   
00418C 6C   
00418D 69   
00418E 6E   
00418F 65   
004190 20   
004191 00     11691 DB	0
004192 0E     11692 PBCDL:          LD	C,0
004193 00   
004194 18     11693 JR	PBCD0
004195 02   
004196 0E     11700 PBCD:           LD	C,' '
004197 20   
004198 06     11701 PBCD0:          LD	B,5
004199 05   
00419A 11     11702 LD	DE,10000
00419B 10   
00419C 27   
00419D AF     11703 PBCD1:          XOR	A
00419E ED     11704 PBCD2:          SBC	HL,DE
00419F 52   
0041A0 3C     11705 INC	A
0041A1 30     11706 JR	NC,PBCD2
0041A2 FB   
0041A3 19     11707 ADD	HL,DE
0041A4 3D     11708 DEC	A
0041A5 28     11709 JR	Z,PBCD3
0041A6 04   
0041A7 CB     11710 SET	4,C
0041A8 E1   
0041A9 CB     11711 SET	5,C
0041AA E9   
0041AB B1     11712 PBCD3:          OR	C
0041AC C4     11713 CALL	NZ,OUTCHR
0041AD 02   
0041AE 41   
0041AF 78     11714 LD	A,B
0041B0 FE     11715 CP	5
0041B1 05   
0041B2 28     11716 JR	Z,PBCD4
0041B3 06   
0041B4 29     11717 ADD	HL,HL
0041B5 54     11718 LD	D,H
0041B6 5D     11719 LD	E,L
0041B7 29     11720 ADD	HL,HL
0041B8 29     11721 ADD	HL,HL
0041B9 19     11722 ADD	HL,DE
0041BA 11     11723 PBCD4:          LD	DE,1000
0041BB E8   
0041BC 03   
0041BD 10     11724 DJNZ	PBCD1
0041BE DE   
0041BF 37     11725 SCF
0041C0 C9     11726 RET
0041C1 FD     11730 GETV1:          INC	IY
0041C2 23   
0041C3 FD     11731 INC	IY		;SKIP ()
0041C4 23   
0041C5 E5     11732 PUSH	HL		;SET EXIT CONDITIONS
0041C6 DD     11733 POP	IX
0041C7 E1   
0041C8 7A     11734 LD	A,D
0041C9 F6     11735 OR	64		;FLAG ARRAY
0041CA 40   
0041CB BF     11736 CP	A
0041CC C9     11737 RET
0041CD CD     11744 PUTVAR:         CALL	CREATE
0041CE 3C   
0041CF 43   
0041D0 FD     11745 LD	A,(IY)
0041D1 7E   
0041D2 00   
0041D3 FE     11746 CP	'('
0041D4 28   
0041D5 20     11747 JR	NZ,GETVZ	;SET EXIT CONDITIONS
0041D6 7D   
0041D7 FD     11748 LD	A,(IY+1)
0041D8 7E   
0041D9 01   
0041DA FE     11749 CP	')'		;WHOLE ARRAY?
0041DB 29   
0041DC 28     11750 JR	Z,GETV1
0041DD E3   
0041DE 3E     11751 ARRAY:          LD	A,14		;'Bad use of array'
0041DF 0E   
0041E0 C3     11752 ERROR3:         JP	ERROR_
0041E1 44   
0041E2 3F   
0041E3 FD     11766 GETVAR:         LD	A,(IY)
0041E4 7E   
0041E5 00   
0041E6 FE     11767 CP	'!'
0041E7 21   
0041E8 28     11768 JR	Z,GETV5
0041E9 76   
0041EA FE     11769 CP	'?'
0041EB 3F   
0041EC 28     11770 JR	Z,GETV6
0041ED 76   
0041EE FE     11771 CP	'|'
0041EF 7C   
0041F0 28     11772 JR	Z,GETVF
0041F1 75   
0041F2 FE     11773 CP	'$'
0041F3 24   
0041F4 28     11774 JR	Z,GETV4
0041F5 75   
0041F6 CD     11775 CALL	LOCATE
0041F7 B0   
0041F8 42   
0041F9 C0     11776 RET	NZ
0041FA FD     11777 LD	A,(IY)
0041FB 7E   
0041FC 00   
0041FD FE     11778 CP	'('		;ARRAY?
0041FE 28   
0041FF 20     11779 JR	NZ,GETVX	;EXIT
004200 4B   
004201 FD     11780 LD	A,(IY+1)
004202 7E   
004203 01   
004204 FE     11781 CP	')'		;WHOLE ARRAY?
004205 29   
004206 28     11782 JR	Z,GETV1
004207 B9   
004208 D5     11783 PUSH	DE		;SAVE TYPE
004209 7E     11784 LD	A,(HL)
00420A 23     11785 INC	HL
00420B 66     11786 LD	H,(HL)
00420C 6F     11787 LD	L,A		;INDIRECT LINK
00420D E6     11788 AND	0FEH
00420E FE   
00420F B4     11789 OR	H
004210 28     11790 JR	Z,ARRAY
004211 CC   
004212 7E     11791 LD	A,(HL)		;NO. OF DIMENSIONS
004213 B7     11792 OR	A
004214 28     11793 JR	Z,ARRAY
004215 C8   
004216 23     11794 INC	HL
004217 11     11795 LD	DE,0		;ACCUMULATOR
004218 00   
004219 00   
00421A F5     11796 PUSH	AF
00421B FD     11797 INC	IY		;SKIP (
00421C 23   
00421D E5     11798 GETV3:          PUSH	HL
00421E D5     11799 PUSH	DE
00421F CD     11800 CALL	EXPRI		;SUBSCRIPT
004220 33   
004221 18   
004222 D9     11801 EXX
004223 D1     11802 POP	DE
004224 E3     11803 EX	(SP),HL
004225 4E     11804 LD	C,(HL)
004226 23     11805 INC	HL
004227 46     11806 LD	B,(HL)
004228 23     11807 INC	HL
004229 E3     11808 EX	(SP),HL
00422A EB     11809 EX	DE,HL
00422B D5     11810 PUSH	DE
00422C CD     11811 CALL	MUL16		;HL=HL*BC
00422D BD   
00422E 36   
00422F D1     11812 POP	DE
004230 19     11813 ADD	HL,DE
004231 EB     11814 EX	DE,HL
004232 B7     11815 OR	A
004233 ED     11816 SBC	HL,BC
004234 42   
004235 3E     11817 LD	A,15
004236 0F   
004237 30     11818 JR	NC,ERROR3	;"Subscript"
004238 A7   
004239 E1     11819 POP	HL
00423A F1     11820 POP	AF
00423B 3D     11821 DEC	A		;DIMENSION COUNTER
00423C 20     11822 JR	NZ,GETV2
00423D 1C   
00423E CD     11823 CALL	BRAKET		;CLOSING BRACKET
00423F AE   
004240 20   
004241 F1     11824 POP	AF		;RESTORE TYPE
004242 E5     11825 PUSH	HL
004243 CD     11826 CALL	X14OR5		;DE=DE*n
004244 AD   
004245 36   
004246 E1     11827 POP	HL
004247 19     11828 ADD	HL,DE
004248 57     11829 LD	D,A		;TYPE
004249 FD     11830 LD	A,(IY)
00424A 7E   
00424B 00   
00424C FE     11831 GETVX:          CP	'?'
00424D 3F   
00424E 28     11832 JR	Z,GETV9
00424F 26   
004250 FE     11833 CP	'!'
004251 21   
004252 28     11834 JR	Z,GETV8
004253 1E   
004254 E5     11835 GETVZ:          PUSH	HL		;SET EXIT CONDITIONS
004255 DD     11836 POP	IX
004256 E1   
004257 7A     11837 LD	A,D
004258 BF     11838 CP	A
004259 C9     11839 RET
00425A F5     11841 GETV2:          PUSH	AF
00425B CD     11842 CALL	COMMA
00425C A2   
00425D 20   
00425E 18     11843 JR	GETV3
00425F BD   
004260 3E     11847 GETV5:          LD	A,4		;UNARY 32-BIT INDIRN.
004261 04   
004262 18     11848 JR	GETV7
004263 09   
004264 AF     11849 GETV6:          XOR	A		;UNARY 8-BIT INDIRECTION
004265 18     11850 JR	GETV7
004266 06   
004267 3E     11851 GETVF:          LD	A,5		;VARIANT INDIRECTION
004268 05   
004269 18     11852 JR	GETV7
00426A 02   
00426B 3E     11853 GETV4:          LD	A,128		;STATIC STRING
00426C 80   
00426D ED     11854 GETV7:          SBC	HL,HL
00426E 62   
00426F F5     11855 PUSH	AF
004270 18     11856 JR	GETV0
004271 15   
004272 06     11858 GETV8:          LD	B,4		;32-BIT BINARY INDIRN.
004273 04   
004274 18     11859 JR	GETVA
004275 02   
004276 06     11860 GETV9:          LD	B,0		;8-BIT BINARY INDIRN.
004277 00   
004278 E5     11861 GETVA:          PUSH	HL
004279 DD     11862 POP	IX
00427A E1   
00427B 7A     11863 LD	A,D		;TYPE
00427C FE     11864 CP	129
00427D 81   
00427E C8     11865 RET	Z		;STRING!
00427F C5     11866 PUSH	BC
004280 CD     11867 CALL	LOADN		;LEFT OPERAND
004281 25   
004282 19   
004283 CD     11868 CALL	SFIX
004284 17   
004285 1C   
004286 D9     11869 EXX
004287 E5     11870 GETV0:          PUSH	HL
004288 FD     11871 INC	IY
004289 23   
00428A CD     11872 CALL	ITEMI
00428B 60   
00428C 18   
00428D D9     11873 EXX
00428E D1     11874 POP	DE
00428F F1     11875 POP	AF
004290 19     11876 ADD	HL,DE
004291 E5     11877 PUSH	HL
004292 DD     11878 POP	IX
004293 E1   
004294 BF     11879 CP	A
004295 C9     11880 RET
004296 FD     11890 GETDEF:         LD	A,(IY+1)
004297 7E   
004298 01   
004299 CD     11891 CALL	RANGE1
00429A FC   
00429B 43   
00429C D8     11892 RET	C
00429D FD     11893 LD	A,(IY)
00429E 7E   
00429F 00   
0042A0 21     11894 LD	HL,FNPTR
0042A1 D8   
0042A2 54   
0042A3 FE     11895 CP	TFN
0042A4 A4   
0042A5 28     11896 JR	Z,LOC2
0042A6 43   
0042A7 21     11897 LD	HL,PROPTR
0042A8 DA   
0042A9 54   
0042AA FE     11898 CP	TPROC
0042AB F2   
0042AC 28     11899 JR	Z,LOC2
0042AD 3C   
0042AE 37     11900 SCF
0042AF C9     11901 RET
0042B0 D6     11917 LOCATE:         SUB	'@'
0042B1 40   
0042B2 D8     11918 RET	C
0042B3 26     11919 LD	H,0
0042B4 00   
0042B5 FE     11920 CP	'Z'-'@'+1
0042B6 1B   
0042B7 30     11921 JR	NC,LOC0		;NOT STATIC
0042B8 1D   
0042B9 87     11922 ADD	A,A
0042BA 6F     11923 LD	L,A
0042BB FD     11924 LD	A,(IY+1)	;2nd CHARACTER
0042BC 7E   
0042BD 01   
0042BE FE     11925 CP	'%'
0042BF 25   
0042C0 20     11926 JR	NZ,LOC1		;NOT STATIC
0042C1 20   
0042C2 FD     11927 LD	A,(IY+2)
0042C3 7E   
0042C4 02   
0042C5 FE     11928 CP	'('
0042C6 28   
0042C7 28     11929 JR	Z,LOC1		;NOT STATIC
0042C8 19   
0042C9 29     11930 ADD	HL,HL
0042CA 11     11931 LD	DE,STAVAR	;STATIC VARIABLES
0042CB 00   
0042CC 54   
0042CD 19     11932 ADD	HL,DE
0042CE FD     11933 INC	IY
0042CF 23   
0042D0 FD     11934 INC	IY
0042D1 23   
0042D2 16     11935 LD	D,4		;INTEGER TYPE
0042D3 04   
0042D4 AF     11936 XOR	A
0042D5 C9     11937 RET
0042D6 FE     11939 LOC0:           CP	'_'-'@'
0042D7 1F   
0042D8 D8     11940 RET	C
0042D9 FE     11941 CP	'z'-'@'+1
0042DA 3B   
0042DB 3F     11942 CCF
0042DC 3D     11943 DEC	A		;SET NZ
0042DD D8     11944 RET	C
0042DE D6     11945 SUB	3
0042DF 03   
0042E0 87     11946 ADD	A,A
0042E1 6F     11947 LD	L,A
0042E2 11     11948 LOC1:           LD	DE,DYNVAR	;DYNAMIC VARIABLES
0042E3 6C   
0042E4 54   
0042E5 2D     11949 DEC	L
0042E6 2D     11950 DEC	L
0042E7 37     11951 SCF
0042E8 F8     11952 RET	M
0042E9 19     11953 ADD	HL,DE
0042EA 5E     11954 LOC2:           LD	E,(HL)
0042EB 23     11955 INC	HL
0042EC 56     11956 LD	D,(HL)
0042ED 7A     11957 LD	A,D
0042EE B3     11958 OR	E
0042EF 28     11959 JR	Z,LOC6		;UNDEFINED VARIABLE
0042F0 49   
0042F1 62     11960 LD	H,D
0042F2 6B     11961 LD	L,E
0042F3 23     11962 INC	HL		;SKIP LINK
0042F4 23     11963 INC	HL
0042F5 FD     11964 PUSH	IY
0042F6 E5   
0042F7 7E     11965 LOC3:           LD	A,(HL)		;COMPARE
0042F8 23     11966 INC	HL
0042F9 FD     11967 INC	IY
0042FA 23   
0042FB FD     11968 CP	(IY)
0042FC BE   
0042FD 00   
0042FE 28     11969 JR	Z,LOC3
0042FF F7   
004300 B7     11970 OR	A		;0=TERMINATOR
004301 28     11971 JR	Z,LOC5		;FOUND (MAYBE)
004302 05   
004303 FD     11972 LOC4:           POP	IY
004304 E1   
004305 EB     11973 EX	DE,HL
004306 18     11974 JR	LOC2		;TRY NEXT ENTRY
004307 E2   
004308 FD     11976 LOC5:           DEC	IY
004309 2B   
00430A FD     11977 LD	A,(IY)
00430B 7E   
00430C 00   
00430D FE     11978 CP	'('
00430E 28   
00430F 28     11979 JR	Z,LOCX		;FOUND
004310 13   
004311 FD     11980 INC	IY
004312 23   
004313 CD     11981 CALL	RANGE
004314 EF   
004315 43   
004316 38     11982 JR	C,LOCX		;FOUND
004317 0C   
004318 FE     11983 CP	'('
004319 28   
00431A 28     11984 JR	Z,LOC4		;KEEP LOOKING
00431B E7   
00431C FD     11985 LD	A,(IY-1)
00431D 7E   
00431E FF   
00431F CD     11986 CALL	RANGE1
004320 FC   
004321 43   
004322 30     11987 JR	NC,LOC4		;KEEP LOOKING
004323 DF   
004324 D1     11988 LOCX:           POP	DE
004325 FD     11989 TYPE:           LD	A,(IY-1)
004326 7E   
004327 FF   
004328 FE     11990 CP	'$'
004329 24   
00432A 16     11991 LD	D,129
00432B 81   
00432C C8     11992 RET	Z		;STRING
00432D FE     11993 CP	'&'
00432E 26   
00432F 16     11994 LD	D,1
004330 01   
004331 C8     11995 RET	Z		;BYTE
004332 FE     11996 CP	'%'
004333 25   
004334 16     11997 LD	D,4
004335 04   
004336 C8     11998 RET	Z		;INTEGER
004337 14     11999 INC	D
004338 BF     12000 CP	A
004339 C9     12001 RET
00433A 3C     12003 LOC6:           INC	A		;SET NZ
00433B C9     12004 RET
00433C AF     12011 CREATE:         XOR	A
00433D ED     12012 LD	DE,(FREE)
00433E 5B   
00433F E0   
004340 54   
004341 72     12013 LD	(HL),D
004342 2B     12014 DEC	HL
004343 73     12015 LD	(HL),E
004344 EB     12016 EX	DE,HL
004345 77     12017 LD	(HL),A
004346 23     12018 INC	HL
004347 77     12019 LD	(HL),A
004348 23     12020 INC	HL
004349 FD     12021 LOC7:           INC	IY
00434A 23   
00434B CD     12022 CALL	RANGE		;END OF VARIABLE?
00434C EF   
00434D 43   
00434E 38     12023 JR	C,LOC8
00434F 14   
004350 77     12024 LD	(HL),A
004351 23     12025 INC	HL
004352 CD     12026 CALL	RANGE1
004353 FC   
004354 43   
004355 30     12027 JR	NC,LOC7
004356 F2   
004357 FE     12028 CP	'('
004358 28   
004359 28     12029 JR	Z,LOC8
00435A 09   
00435B FD     12030 LD	A,(IY+1)
00435C 7E   
00435D 01   
00435E FE     12031 CP	'('
00435F 28   
004360 28     12032 JR	Z,LOC7
004361 E7   
004362 FD     12033 INC	IY
004363 23   
004364 36     12034 LOC8:           LD	(HL),0		;TERMINATOR
004365 00   
004366 23     12035 INC	HL
004367 E5     12036 PUSH	HL
004368 CD     12037 CALL	TYPE
004369 25   
00436A 43   
00436B FD     12038 LD	A,(IY)
00436C 7E   
00436D 00   
00436E FE     12039 CP	'('
00436F 28   
004370 3E     12040 LD	A,2		;SIZE OF INDIRECT LINK
004371 02   
004372 28     12041 JR	Z,LOC9
004373 07   
004374 7A     12042 LD	A,D
004375 B7     12043 OR	A		;STRING?
004376 F2     12044 JP	P,LOC9
004377 7B   
004378 43   
004379 3E     12045 LD	A,4
00437A 04   
00437B 36     12046 LOC9:           LD	(HL),0		;INITIALISE TO ZERO
00437C 00   
00437D 23     12047 INC	HL
00437E 3D     12048 DEC	A
00437F 20     12049 JR	NZ,LOC9
004380 FA   
004381 22     12050 LD	(FREE),HL
004382 E0   
004383 54   
004384 CD     12051 CALL	CHECK
004385 86   
004386 32   
004387 E1     12052 POP	HL
004388 AF     12053 XOR	A
004389 C9     12054 RET
00438A CD     12062 LINNUM:         CALL	NXT
00438B 0B   
00438C 45   
00438D 21     12063 LD	HL,0
00438E 00   
00438F 00   
004390 FD     12064 LINNM1:         LD	A,(IY)
004391 7E   
004392 00   
004393 D6     12065 SUB	'0'
004394 30   
004395 D8     12066 RET	C
004396 FE     12067 CP	10
004397 0A   
004398 D0     12068 RET	NC
004399 FD     12069 INC	IY
00439A 23   
00439B 54     12070 LD	D,H
00439C 5D     12071 LD	E,L
00439D 29     12072 ADD	HL,HL		;*2
00439E 38     12073 JR	C,TOOBIGmn
00439F 0F   
0043A0 29     12074 ADD	HL,HL		;*4
0043A1 38     12075 JR	C,TOOBIGmn
0043A2 0C   
0043A3 19     12076 ADD	HL,DE		;*5
0043A4 38     12077 JR	C,TOOBIGmn
0043A5 09   
0043A6 29     12078 ADD	HL,HL		;*10
0043A7 38     12079 JR	C,TOOBIGmn
0043A8 06   
0043A9 5F     12080 LD	E,A
0043AA 16     12081 LD	D,0
0043AB 00   
0043AC 19     12082 ADD	HL,DE		;ADD IN DIGIT
0043AD 30     12083 JR	NC,LINNM1
0043AE E1   
0043AF 3E     12084 TOOBIGmn:         LD	A,20
0043B0 14   
0043B1 C3     12085 JP	ERROR_		;"Too big"
0043B2 44   
0043B3 3F   
0043B4 CD     12093 PAIR:           CALL	LINNUM		;FIRST
0043B5 8A   
0043B6 43   
0043B7 7C     12094 LD	A,H
0043B8 B5     12095 OR	L
0043B9 20     12096 JR	NZ,PAIR1
0043BA 02   
0043BB 2E     12097 LD	L,10
0043BC 0A   
0043BD CD     12098 PAIR1:          CALL	TERMQ
0043BE 36   
0043BF 35   
0043C0 FD     12099 INC	IY
0043C1 23   
0043C2 E5     12100 PUSH	HL
0043C3 21     12101 LD	HL,10
0043C4 0A   
0043C5 00   
0043C6 C4     12102 CALL	NZ,LINNUM	;SECOND
0043C7 8A   
0043C8 43   
0043C9 E3     12103 EX	(SP),HL
0043CA C1     12104 POP	BC
0043CB 78     12105 LD	A,B
0043CC B1     12106 OR	C
0043CD C0     12107 RET	NZ
0043CE CD     12108 CALL	EXTERR
0043CF 55   
0043D0 3F   
0043D1 53     12109 DB	"Silly"
0043D2 69   
0043D3 6C   
0043D4 6C   
0043D5 79   
0043D6 00     12110 DB	0
0043D7 CD     12118 DLPAIR:         CALL	LINNUM
0043D8 8A   
0043D9 43   
0043DA E5     12119 PUSH	HL
0043DB CD     12120 CALL	TERMQ
0043DC 36   
0043DD 35   
0043DE 28     12121 JR	Z,DLP1
0043DF 09   
0043E0 FE     12122 CP	TIF
0043E1 E7   
0043E2 28     12123 JR	Z,DLP1
0043E3 05   
0043E4 FD     12124 INC	IY
0043E5 23   
0043E6 CD     12125 CALL	LINNUM
0043E7 8A   
0043E8 43   
0043E9 E3     12126 DLP1:           EX	(SP),HL
0043EA CD     12127 CALL	FINDL
0043EB 43   
0043EC 41   
0043ED C1     12128 POP	BC
0043EE C9     12129 RET
0043EF FD     12136 RANGE:          LD	A,(IY)
0043F0 7E   
0043F1 00   
0043F2 FE     12137 CP	'$'
0043F3 24   
0043F4 D8     12138 RET	C
0043F5 FE     12139 CP	'&'+1
0043F6 27   
0043F7 3F     12140 CCF
0043F8 D0     12141 RET	NC
0043F9 FE     12142 CP	'('
0043FA 28   
0043FB C8     12143 RET	Z
0043FC FE     12144 RANGE1:         CP	'0'
0043FD 30   
0043FE D8     12145 RET	C
0043FF FE     12146 CP	'9'+1
004400 3A   
004401 3F     12147 CCF
004402 D0     12148 RET	NC
004403 FE     12149 CP	'@'		;V2.4
004404 40   
004405 C8     12150 RET	Z
004406 FE     12151 RANGE2:         CP	'A'
004407 41   
004408 D8     12152 RET	C
004409 FE     12153 CP	'Z'+1
00440A 5B   
00440B 3F     12154 CCF
00440C D0     12155 RET	NC
00440D FE     12156 CP	'_'
00440E 5F   
00440F D8     12157 RET	C
004410 FE     12158 CP	'z'+1
004411 7B   
004412 3F     12159 CCF
004413 C9     12160 RET
004414 12     12176 LEXAN1:         LD	(DE),A		;TRANSFER TO BUFFER
004415 13     12177 INC	DE		;INCREMENT POINTERS
004416 FD     12178 INC	IY
004417 23   
004418 7B     12179 LEXAN2:         LD	A,E		;MAIN ENTRY
004419 FE     12180 CP	252		;TEST LENGTH
00441A FC   
00441B 3E     12181 LD	A,19
00441C 13   
00441D D2     12182 JP	NC,ERROR_	;'String too long'
00441E 44   
00441F 3F   
004420 FD     12183 LD	A,(IY)
004421 7E   
004422 00   
004423 FE     12184 CP	CR
004424 0D   
004425 C8     12185 RET	Z		;END OF LINE
004426 CD     12186 CALL	RANGE1
004427 FC   
004428 43   
004429 30     12187 JR	NC,LEXAN3
00442A 04   
00442B CB     12188 RES	5,C		;NOT IN VARIABLE
00442C A9   
00442D CB     12189 RES	3,C		;NOT IN HEX
00442E 99   
00442F FE     12190 LEXAN3:         CP	' '
004430 20   
004431 28     12191 JR	Z,LEXAN1	;PASS SPACES
004432 E1   
004433 FE     12192 CP	','
004434 2C   
004435 28     12193 JR	Z,LEXAN1	;PASS COMMAS
004436 DD   
004437 FE     12194 CP	'G'
004438 47   
004439 38     12195 JR	C,LEXAN4
00443A 02   
00443B CB     12196 RES	3,C		;NOT IN HEX
00443C 99   
00443D FE     12197 LEXAN4:         CP	'"'
00443E 22   
00443F 20     12198 JR	NZ,LEXAN5
004440 05   
004441 CB     12199 RL	C
004442 11   
004443 3F     12200 CCF			;TOGGLE C7
004444 CB     12201 RR	C
004445 19   
004446 CB     12202 LEXAN5:         BIT	4,C
004447 61   
004448 28     12203 JR	Z,LEXAN6
004449 10   
00444A CB     12204 RES	4,C
00444B A1   
00444C C5     12205 PUSH	BC
00444D D5     12206 PUSH	DE
00444E CD     12207 CALL	LINNUM		;GET LINE NUMBER
00444F 8A   
004450 43   
004451 D1     12208 POP	DE
004452 C1     12209 POP	BC
004453 7C     12210 LD	A,H
004454 B5     12211 OR	L
004455 C4     12212 CALL	NZ,ENCODE	;ENCODE LINE NUMBER
004456 BF   
004457 44   
004458 18     12213 JR	LEXAN2		;CONTINUE
004459 BE   
00445A 0D     12215 LEXAN6:         DEC	C
00445B 28     12216 JR	Z,LEXAN7	;C=1 (LEFT)
00445C 09   
00445D 0C     12217 INC	C
00445E 20     12218 JR	NZ,LEXAN1
00445F B4   
004460 B7     12219 OR	A
004461 F4     12220 CALL	P,LEX		;TOKENISE IF POSS.
004462 A3   
004463 3F   
004464 18     12221 JR	LEXAN8
004465 12   
004466 FE     12223 LEXAN7:         CP	'*'
004467 2A   
004468 28     12224 JR	Z,LEXAN9
004469 16   
00446A B7     12225 OR	A
00446B F4     12226 CALL	P,LEX		;TOKENISE IF POSS.
00446C A3   
00446D 3F   
00446E FE     12227 CP	TOKLO
00446F 8F   
004470 38     12228 JR	C,LEXAN8
004471 06   
004472 FE     12229 CP	TOKHI+1
004473 94   
004474 30     12230 JR	NC,LEXAN8
004475 02   
004476 C6     12231 ADD	A,OFFSET	;LEFT VERSION
004477 40   
004478 FE     12232 LEXAN8:         CP	TREM
004479 F4   
00447A 28     12233 JR	Z,LEXAN9
00447B 04   
00447C FE     12234 CP	TDATA
00447D DC   
00447E 20     12235 JR	NZ,LEXANA
00447F 02   
004480 CB     12236 LEXAN9:         SET	6,C		;QUIT TOKENISING
004481 F1   
004482 FE     12237 LEXANA:         CP	TFN
004483 A4   
004484 28     12238 JR	Z,LEXANB
004485 09   
004486 FE     12239 CP	TPROC
004487 F2   
004488 28     12240 JR	Z,LEXANB
004489 05   
00448A CD     12241 CALL	RANGE2
00448B 06   
00448C 44   
00448D 38     12242 JR	C,LEXANC
00448E 02   
00448F CB     12243 LEXANB:         SET	5,C		;IN VARIABLE/FN/PROC
004490 E9   
004491 FE     12244 LEXANC:         CP	'&'
004492 26   
004493 20     12245 JR	NZ,LEXAND
004494 02   
004495 CB     12246 SET	3,C		;IN HEX
004496 D9   
004497 21     12247 LEXAND:         LD	HL,LIST1
004498 B6   
004499 44   
00449A C5     12248 PUSH	BC
00449B 01     12249 LD	BC,LIST1L
00449C 06   
00449D 00   
00449E ED     12250 CPIR
00449F B1   
0044A0 C1     12251 POP	BC
0044A1 20     12252 JR	NZ,LEXANE
0044A2 02   
0044A3 CB     12253 SET	4,C		;ACCEPT LINE NUMBER
0044A4 E1   
0044A5 21     12254 LEXANE:         LD	HL,LIST2
0044A6 BA   
0044A7 44   
0044A8 C5     12255 PUSH	BC
0044A9 01     12256 LD	BC,LIST2L
0044AA 05   
0044AB 00   
0044AC ED     12257 CPIR
0044AD B1   
0044AE C1     12258 POP	BC
0044AF 20     12259 JR	NZ,LEXANF
0044B0 02   
0044B1 CB     12260 SET	0,C		;ENTER LEFT MODE
0044B2 C1   
0044B3 C3     12261 LEXANF:         JP	LEXAN1
0044B4 14   
0044B5 44   
0044B6 E5     12263 LIST1:          DB	TGOTO
0044B7 E4     12264 DB	TGOSUB
0044B8 F7     12265 DB	TRESTORE
0044B9 FC     12266 DB	TTRACE
0044BA 8C     12267 LIST2:          DB	TTHEN
0044BB 8B     12268 DB	TELSE
0044BC F5     12270 DB	TREPEAT
0044BD 85     12271 DB	TERROR
0044BE 3A     12272 DB	':'
0044BF CB     12280 ENCODE:         SET	4,C
0044C0 E1   
0044C1 EB     12281 EX	DE,HL
0044C2 36     12282 LD	(HL),TLINO
0044C3 8D   
0044C4 23     12283 INC	HL
0044C5 7A     12284 LD	A,D
0044C6 E6     12285 AND	0C0H
0044C7 C0   
0044C8 0F     12286 RRCA
0044C9 0F     12287 RRCA
0044CA 47     12288 LD	B,A
0044CB 7B     12289 LD	A,E
0044CC E6     12290 AND	0C0H
0044CD C0   
0044CE B0     12291 OR	B
0044CF 0F     12292 RRCA
0044D0 0F     12293 RRCA
0044D1 EE     12294 XOR	01010100B
0044D2 54   
0044D3 77     12295 LD	(HL),A
0044D4 23     12296 INC	HL
0044D5 7B     12297 LD	A,E
0044D6 E6     12298 AND	3FH
0044D7 3F   
0044D8 F6     12299 OR	'@'
0044D9 40   
0044DA 77     12300 LD	(HL),A
0044DB 23     12301 INC	HL
0044DC 7A     12302 LD	A,D
0044DD E6     12303 AND	3FH
0044DE 3F   
0044DF F6     12304 OR	'@'
0044E0 40   
0044E1 77     12305 LD	(HL),A
0044E2 23     12306 INC	HL
0044E3 EB     12307 EX	DE,HL
0044E4 C9     12308 RET
0044E5 2A     12315 REPORT:         LD	HL,(ERRTXT)
0044E6 EE   
0044E7 54   
0044E8 7E     12316 TEXT_:          LD	A,(HL)
0044E9 23     12317 INC	HL
0044EA B7     12318 OR	A
0044EB C8     12319 RET	Z
0044EC FE     12320 CP	LF
0044ED 0A   
0044EE 28     12321 JR	Z,TEXTLF	;Token for TINT
0044EF 05   
0044F0 CD     12322 CALL	OUT
0044F1 1B   
0044F2 41   
0044F3 18     12323 JR	TEXT_
0044F4 F3   
0044F5 CD     12325 TEXTLF:         CALL	OUTCHR
0044F6 02   
0044F7 41   
0044F8 18     12326 JR	TEXT_
0044F9 EE   
0044FA E3     12332 TELL:           EX	(SP),HL		;GET RETURN ADDRESS
0044FB CD     12333 CALL	TEXT_
0044FC E8   
0044FD 44   
0044FE E3     12334 EX	(SP),HL
0044FF C9     12335 RET
004500 CD     12339 NLIST:          CALL	NXT
004501 0B   
004502 45   
004503 FE     12340 CP	','		;ANOTHER VARIABLE?
004504 2C   
004505 28     12341 JR	Z,NXT1
004506 0A   
004507 C1     12342 POP	BC		;DITCH RETURN ADDRESS
004508 C3     12343 JP	XEQ
004509 99   
00450A 24   
00450B FD     12345 NXT:            LD	A,(IY)
00450C 7E   
00450D 00   
00450E FE     12346 CP	' '
00450F 20   
004510 C0     12347 RET	NZ
004511 FD     12348 NXT1:           INC	IY
004512 23   
004513 18     12349 JR	NXT
004514 F6   
004515             12354   ; --- Begin math.asm ---
004515 FD     12399 FPP:            PUSH	IY		;Save IY
004516 E5   
004517 FD     12400 LD	IY,0
004518 21   
004519 00   
00451A 00   
00451B FD     12401 ADD	IY,SP		;Save SP in IY
00451C 39   
00451D CD     12402 CALL	OP		;Perform operation
00451E 2C   
00451F 45   
004520 BF     12403 CP	A		;Good return (Z, NC)
004521 FD     12404 EXITmat:           POP	IY		;Restore IY
004522 E1   
004523 C9     12405 RET			;Return to caller
004524 3E     12409 BADmat:            LD	A,BADOP		;"Bad operation code"
004525 01   
004526 FD     12410 ERROR_mat:         LD	SP,IY		;Restore SP from IY
004527 F9   
004528 B7     12411 OR	A		;Set NZ
004529 37     12412 SCF			;Set C
00452A 18     12413 JR	EXITmat
00452B F5   
00452C FE     12418 OP:             CP	RTABLE-DTABLE/2
00452D 2E   
00452E 30     12419 JR	NC,BADmat
00452F F4   
004530 FE     12421 CP	FTABLE-DTABLE/2
004531 10   
004532 30     12422 JR	NC,DISPAT
004533 07   
004534 08     12423 EX	AF,AF'
004535 78     12424 LD	A,B
004536 B1     12425 OR	C		;Both integer?
004537 C4     12426 CALL	NZ,FLOATA	;No, so float both
004538 A5   
004539 4E   
00453A 08     12427 EX	AF,AF'
00453B E5     12428 DISPAT:         PUSH	HL
00453C 21     12429 LD	HL,DTABLE
00453D 4C   
00453E 45   
00453F C5     12430 PUSH	BC
004540 87     12431 ADD	A,A		;A = op-code * 2
004541 4F     12432 LD	C,A
004542 06     12433 LD	B,0		;BC = op-code * 2
004543 00   
004544 09     12434 ADD	HL,BC
004545 7E     12435 LD	A,(HL)		;Get low byte
004546 23     12436 INC	HL
004547 66     12437 LD	H,(HL)		;Get high byte
004548 6F     12438 LD	L,A
004549 C1     12439 POP	BC
00454A E3     12440 EX	(SP),HL
00454B C9     12441 RET			;Off to routine
00454C CB     12445 DTABLE:         DW	IAND		;0  & (INTEGER)
00454D 45   
00454E 18     12446 DW	IBDIV		;1  DIV
00454F 46   
004550 DD     12447 DW	IEOR		;2  EOR
004551 45   
004552 01     12448 DW	IMOD		;3  MOD
004553 46   
004554 EF     12449 DW	IOR		;4  |
004555 45   
004556 16     12450 DW	ILE		;5  <=
004557 48   
004558 23     12451 DW	INE		;6  <>
004559 48   
00455A 0B     12452 DW	IGE		;7  >=
00455B 48   
00455C F4     12453 DW	ILT		;8  <
00455D 47   
00455E 2E     12454 DW	IEQ		;9  =
00455F 48   
004560 E2     12455 DW	IMUL		;10 *
004561 46   
004562 3B     12456 DW	IADD		;11 +
004563 46   
004564 FF     12457 DW	IGT		;12 >
004565 47   
004566 25     12458 DW	ISUB		;13 -
004567 46   
004568 5D     12459 DW	IPOW		;14 ^
004569 47   
00456A 9A     12460 DW	IDIV		;15 /
00456B 46   
00456C 7E     12462 FTABLE:         DW	ABS		;16 ABS
00456D 48   
00456E DA     12463 DW	ACS		;17 ACS
00456F 4B   
004570 36     12464 DW	ASN		;18 ASN
004571 4B   
004572 5B     12465 DW	ATN		;19 ATN
004573 4B   
004574 74     12466 DW	COS		;20 COS
004575 49   
004576 A8     12467 DW	DEG		;21 DEG
004577 48   
004578 19     12468 DW	EXP		;22 EXP
004579 4A   
00457A EE     12469 DW	INT_		;23 INT_
00457B 48   
00457C A4     12470 DW	LN		;24 LN
00457D 4A   
00457E 24     12471 DW	LOG		;25 LOG
00457F 4B   
004580 89     12472 DW	CPL_		;26 NOT
004581 48   
004582 B0     12473 DW	RAD		;27 RAD
004583 48   
004584 C6     12474 DW	SGN		;28 SGN
004585 48   
004586 7F     12475 DW	SIN		;29 SIN
004587 49   
004588 04     12476 DW	SQR		;30 SQR
004589 49   
00458A 57     12477 DW	TAN		;31 TAN
00458B 49   
00458C 21     12479 DW	ZEROmat		;32 ZERO
00458D 4F   
00458E F8     12480 DW	FONE		;33 FONE
00458F 49   
004590 32     12481 DW	TRUE		;34 TRUE
004591 48   
004592 9C     12482 DW	PI		;35 PI
004593 48   
004594 D6     12484 DW	VAL		;36 VAL
004595 48   
004596 E2     12485 DW	STRmat		;37 STR$
004597 4B   
004598 F7     12487 DW	SFIXmat		;38 FIX
004599 4D   
00459A B2     12488 DW	SFLOAT		;39 FLOAT
00459B 4E   
00459C F7     12490 DW	FTEST		;40 TEST
00459D 4E   
00459E 08     12491 DW	FCOMP		;41 COMPARE
00459F 4F   
0045A0 3D     12493 DW	ISHL		;42 <<
0045A1 48   
0045A2 3D     12494 DW	ISHX		;43 <<<
0045A3 48   
0045A4 4A     12495 DW	ISAR		;44 >>
0045A5 48   
0045A6 5C     12496 DW	ISHR		;45 >>>
0045A7 48   
0045A8 C8     12498 RTABLE:         DW	FAND		;& (FLOATING-POINT)
0045A9 45   
0045AA 15     12499 DW	FBDIV		;DIV
0045AB 46   
0045AC DA     12500 DW	FEOR		;EOR
0045AD 45   
0045AE FE     12501 DW	FMOD		;MOD
0045AF 45   
0045B0 EC     12502 DW	FOR		;|
0045B1 45   
0045B2 11     12503 DW	FLE		;<=
0045B3 48   
0045B4 1E     12504 DW	FNE		;<>
0045B5 48   
0045B6 06     12505 DW	FGE		;>=
0045B7 48   
0045B8 EF     12506 DW	FLT		;<
0045B9 47   
0045BA 29     12507 DW	FEQ		;=
0045BB 48   
0045BC 0D     12508 DW	FMUL		;*
0045BD 47   
0045BE 45     12509 DW	FADD		;+
0045BF 46   
0045C0 FA     12510 DW	FGT		;>
0045C1 47   
0045C2 2F     12511 DW	FSUB		;-
0045C3 46   
0045C4 C5     12512 DW	FPOW		;^
0045C5 47   
0045C6 9D     12513 DW	FDIV		;/
0045C7 46   
0045C8 CD     12524 FAND:           CALL	FIX2
0045C9 EE   
0045CA 4D   
0045CB 7C     12525 IAND:           LD	A,H
0045CC A2     12526 AND	D
0045CD 67     12527 LD	H,A
0045CE 7D     12528 LD	A,L
0045CF A3     12529 AND	E
0045D0 6F     12530 LD	L,A
0045D1 D9     12531 EXX
0045D2 7C     12532 LD	A,H
0045D3 A2     12533 AND	D
0045D4 67     12534 LD	H,A
0045D5 7D     12535 LD	A,L
0045D6 A3     12536 AND	E
0045D7 6F     12537 LD	L,A
0045D8 D9     12538 EXX
0045D9 C9     12539 RET
0045DA CD     12544 FEOR:           CALL	FIX2
0045DB EE   
0045DC 4D   
0045DD 7C     12545 IEOR:           LD	A,H
0045DE AA     12546 XOR	D
0045DF 67     12547 LD	H,A
0045E0 7D     12548 LD	A,L
0045E1 AB     12549 XOR	E
0045E2 6F     12550 LD	L,A
0045E3 D9     12551 EXX
0045E4 7C     12552 LD	A,H
0045E5 AA     12553 XOR	D
0045E6 67     12554 LD	H,A
0045E7 7D     12555 LD	A,L
0045E8 AB     12556 XOR	E
0045E9 6F     12557 LD	L,A
0045EA D9     12558 EXX
0045EB C9     12559 RET
0045EC CD     12564 FOR:            CALL	FIX2
0045ED EE   
0045EE 4D   
0045EF 7C     12565 IOR:            LD	A,H
0045F0 B2     12566 OR	D
0045F1 67     12567 LD	H,A
0045F2 7D     12568 LD	A,L
0045F3 B3     12569 OR	E
0045F4 6F     12570 LD	L,A
0045F5 D9     12571 EXX
0045F6 7C     12572 LD	A,H
0045F7 B2     12573 OR	D
0045F8 67     12574 LD	H,A
0045F9 7D     12575 LD	A,L
0045FA B3     12576 OR	E
0045FB 6F     12577 LD	L,A
0045FC D9     12578 EXX
0045FD C9     12579 RET
0045FE CD     12584 FMOD:           CALL	FIX2
0045FF EE   
004600 4D   
004601 7C     12585 IMOD:           LD	A,H
004602 AA     12586 XOR	D		;DIV RESULT SIGN
004603 CB     12587 BIT	7,H
004604 7C   
004605 CD     12588 CALL	ABS2		;MAKE BOTH POSITIVE
004606 F5   
004607 50   
004608 3E     12589 LD	A,-33
004609 DF   
00460A CD     12590 CALL	DIVA		;DIVIDE
00460B 31   
00460C 50   
00460D D9     12591 EXX
00460E 0E     12592 LD	C,0		;INTEGER MARKER
00460F 00   
004610 08     12593 EX	AF,AF'
004611 C8     12594 RET	Z
004612 C3     12595 JP	NEGATE
004613 06   
004614 4E   
004615 CD     12599 FBDIV:          CALL	FIX2
004616 EE   
004617 4D   
004618 CD     12600 IBDIV:          CALL	IMOD
004619 01   
00461A 46   
00461B B7     12601 OR	A
00461C CD     12602 CALL	SWAP
00461D DC   
00461E 4E   
00461F 0E     12603 LD	C,0
004620 00   
004621 F0     12604 RET	P
004622 C3     12605 JP	NEGATE
004623 06   
004624 4E   
004625 CD     12610 ISUB:           CALL	SUB
004626 64   
004627 4F   
004628 E0     12611 RET	PO
004629 CD     12612 CALL	ADD
00462A 5E   
00462B 4F   
00462C CD     12613 CALL	FLOAT2
00462D A9   
00462E 4E   
00462F 7A     12614 FSUB:           LD	A,D
004630 EE     12615 XOR	80H		;CHANGE SIGN THEN ADD
004631 80   
004632 57     12616 LD	D,A
004633 18     12617 JR	FADD
004634 10   
004635 7C     12621 RSUB:           LD	A,H
004636 EE     12622 XOR	80H
004637 80   
004638 67     12623 LD	H,A
004639 18     12624 JR	FADD
00463A 0A   
00463B CD     12629 IADD:           CALL	ADD
00463C 5E   
00463D 4F   
00463E E0     12630 RET	PO
00463F CD     12631 CALL	SUB
004640 64   
004641 4F   
004642 CD     12632 CALL	FLOAT2
004643 A9   
004644 4E   
004645 05     12633 FADD:           DEC	B
004646 04     12634 INC	B
004647 C8     12635 RET	Z		;ARG 2 ZERO
004648 0D     12636 DEC	C
004649 0C     12637 INC	C
00464A CA     12638 JP	Z,SWAP		;ARG 1 ZERO
00464B DC   
00464C 4E   
00464D D9     12639 EXX
00464E 01     12640 LD	BC,0		;INITIALISE
00464F 00   
004650 00   
004651 D9     12641 EXX
004652 7C     12642 LD	A,H
004653 AA     12643 XOR	D		;XOR SIGNS
004654 F5     12644 PUSH	AF
004655 78     12645 LD	A,B
004656 B9     12646 CP	C		;COMPARE EXPONENTS
004657 DC     12647 CALL	C,SWAP		;MAKE DED'E'B LARGEST
004658 DC   
004659 4E   
00465A 78     12648 LD	A,B
00465B CB     12649 SET	7,H		;IMPLIED 1
00465C FC   
00465D C4     12650 CALL	NZ,FIX		;ALIGN
00465E DE   
00465F 4D   
004660 F1     12651 POP	AF
004661 7A     12652 LD	A,D		;SIGN OF LARGER
004662 CB     12653 SET	7,D		;IMPLIED 1
004663 FA   
004664 FA     12654 JP	M,FADD3		;SIGNS DIFFERENT
004665 71   
004666 46   
004667 CD     12655 CALL	ADD		;HLH'L'=HLH'L'+DED'E'
004668 5E   
004669 4F   
00466A DC     12656 CALL	C,DIV2		;NORMALISE
00466B E4   
00466C 4E   
00466D CB     12657 SET	7,H
00466E FC   
00466F 18     12658 JR	FADD4
004670 0A   
004671 CD     12660 FADD3:          CALL	SUB		;HLH'L'=HLH'L'-DED'E'
004672 64   
004673 4F   
004674 DC     12661 CALL	C,NEG		;NEGATE HLH'L'B'C'
004675 1A   
004676 4E   
004677 CD     12662 CALL	FLO48
004678 86   
004679 4E   
00467A 2F     12663 CPL			;CHANGE RESULT SIGN
00467B D9     12664 FADD4:          EXX
00467C EB     12665 EX	DE,HL
00467D 21     12666 LD	HL,8000H
00467E 00   
00467F 80   
004680 B7     12667 OR	A		;CLEAR CARRY
004681 ED     12668 SBC	HL,BC
004682 42   
004683 EB     12669 EX	DE,HL
004684 D9     12670 EXX
004685 CC     12671 CALL	Z,ODD		;ROUND UNBIASSED
004686 D6   
004687 4E   
004688 DC     12672 CALL	C,ADD1		;ROUND UP
004689 C8   
00468A 4E   
00468B DC     12673 CALL	C,INCC
00468C F0   
00468D 4E   
00468E CB     12674 RES	7,H
00468F BC   
004690 0D     12675 DEC	C
004691 0C     12676 INC	C
004692 CA     12677 JP	Z,ZEROmat
004693 21   
004694 4F   
004695 B7     12678 OR	A		;RESULT SIGNQ
004696 F0     12679 RET	P		;POSITIVE
004697 CB     12680 SET	7,H		;NEGATIVE
004698 FC   
004699 C9     12681 RET
00469A CD     12686 IDIV:           CALL	FLOAT2
00469B A9   
00469C 4E   
00469D 05     12687 FDIV:           DEC	B		;TEST FOR ZERO
00469E 04     12688 INC	B
00469F 3E     12689 LD	A,DIVBY0
0046A0 12   
0046A1 CA     12690 JP	Z,ERROR_mat		;"Division by zero"
0046A2 26   
0046A3 45   
0046A4 0D     12691 DEC	C		;TEST FOR ZERO
0046A5 0C     12692 INC	C
0046A6 C8     12693 RET	Z
0046A7 7C     12694 LD	A,H
0046A8 AA     12695 XOR	D		;CALC. RESULT SIGN
0046A9 08     12696 EX	AF,AF'		;SAVE SIGN
0046AA CB     12697 SET	7,D		;REPLACE IMPLIED 1's
0046AB FA   
0046AC CB     12698 SET	7,H
0046AD FC   
0046AE C5     12699 PUSH	BC		;SAVE EXPONENTS
0046AF 42     12700 LD	B,D		;LOAD REGISTERS
0046B0 4B     12701 LD	C,E
0046B1 11     12702 LD	DE,0
0046B2 00   
0046B3 00   
0046B4 D9     12703 EXX
0046B5 42     12704 LD	B,D
0046B6 4B     12705 LD	C,E
0046B7 11     12706 LD	DE,0
0046B8 00   
0046B9 00   
0046BA 3E     12707 LD	A,-32		;LOOP COUNTER
0046BB E0   
0046BC CD     12708 CALL	DIVA		;DIVIDE
0046BD 31   
0046BE 50   
0046BF D9     12709 EXX
0046C0 CB     12710 BIT	7,D
0046C1 7A   
0046C2 D9     12711 EXX
0046C3 CC     12712 CALL	Z,DIVB		;NORMALISE & INC A
0046C4 4C   
0046C5 50   
0046C6 EB     12713 EX	DE,HL
0046C7 D9     12714 EXX
0046C8 CB     12715 SRL	B		;DIVISOR/2
0046C9 38   
0046CA CB     12716 RR	C
0046CB 19   
0046CC B7     12717 OR	A		;CLEAR CARRY
0046CD ED     12718 SBC	HL,BC		;REMAINDER-DIVISOR/2
0046CE 42   
0046CF 3F     12719 CCF
0046D0 EB     12720 EX	DE,HL		;RESULT IN HLH'L'
0046D1 CC     12721 CALL	Z,ODD		;ROUND UNBIASSED
0046D2 D6   
0046D3 4E   
0046D4 DC     12722 CALL	C,ADD1		;ROUND UP
0046D5 C8   
0046D6 4E   
0046D7 C1     12723 POP	BC		;RESTORE EXPONENTS
0046D8 DC     12724 CALL	C,INCC
0046D9 F0   
0046DA 4E   
0046DB 1F     12725 RRA			;LSB OF A TO CARRY
0046DC 79     12726 LD	A,C		;COMPUTE NEW EXPONENT
0046DD 98     12727 SBC	A,B
0046DE 3F     12728 CCF
0046DF C3     12729 JP	CHKOVF
0046E0 46   
0046E1 47   
0046E2 7C     12733 IMUL:           LD	A,H
0046E3 AA     12734 XOR	D
0046E4 CD     12735 CALL	ABS2		;MAKE BOTH POSITIVE
0046E5 F5   
0046E6 50   
0046E7 3E     12736 LD	A,-33
0046E8 DF   
0046E9 CD     12737 CALL	MULA		;MULTIPLY
0046EA 5F   
0046EB 50   
0046EC D9     12738 EXX
0046ED 0E     12739 LD	C,191		;PRESET EXPONENT
0046EE BF   
0046EF CD     12740 CALL	TESTmat		;TEST RANGE
0046F0 01   
0046F1 4F   
0046F2 20     12741 JR	NZ,IMUL1	;TOO BIG
0046F3 0D   
0046F4 CB     12742 BIT	7,D
0046F5 7A   
0046F6 20     12743 JR	NZ,IMUL1
0046F7 09   
0046F8 CD     12744 CALL	SWAP
0046F9 DC   
0046FA 4E   
0046FB 4A     12745 LD	C,D		;INTEGER MARKER
0046FC 08     12746 EX	AF,AF'
0046FD F0     12747 RET	P
0046FE C3     12748 JP	NEGATE
0046FF 06   
004700 4E   
004701 0D     12750 IMUL1:          DEC	C
004702 CD     12751 CALL	SLA8
004703 C8   
004704 50   
004705 F2     12752 JP	P,IMUL1		;NORMALISE
004706 01   
004707 47   
004708 08     12753 EX	AF,AF'
004709 F8     12754 RET	M
00470A CB     12755 RES	7,H		;POSITIVE
00470B BC   
00470C C9     12756 RET
00470D 05     12760 FMUL:           DEC	B		;TEST FOR ZERO
00470E 04     12761 INC	B
00470F CA     12762 JP	Z,ZEROmat
004710 21   
004711 4F   
004712 0D     12763 DEC	C		;TEST FOR ZERO
004713 0C     12764 INC	C
004714 C8     12765 RET	Z
004715 7C     12766 LD	A,H
004716 AA     12767 XOR	D		;CALC. RESULT SIGN
004717 08     12768 EX	AF,AF'
004718 CB     12769 SET	7,D		;REPLACE IMPLIED 1's
004719 FA   
00471A CB     12770 SET	7,H
00471B FC   
00471C C5     12771 PUSH	BC		;SAVE EXPONENTS
00471D 44     12772 LD	B,H		;LOAD REGISTERS
00471E 4D     12773 LD	C,L
00471F 21     12774 LD	HL,0
004720 00   
004721 00   
004722 D9     12775 EXX
004723 44     12776 LD	B,H
004724 4D     12777 LD	C,L
004725 21     12778 LD	HL,0
004726 00   
004727 00   
004728 3E     12779 LD	A,-32		;LOOP COUNTER
004729 E0   
00472A CD     12780 CALL	MULA		;MULTIPLY
00472B 5F   
00472C 50   
00472D DC     12781 CALL	C,MULB		;NORMALISE & INC A
00472E 73   
00472F 50   
004730 D9     12782 EXX
004731 E5     12783 PUSH	HL
004732 21     12784 LD	HL,8000H
004733 00   
004734 80   
004735 B7     12785 OR	A		;CLEAR CARRY
004736 ED     12786 SBC	HL,DE
004737 52   
004738 E1     12787 POP	HL
004739 CC     12788 CALL	Z,ODD		;ROUND UNBIASSED
00473A D6   
00473B 4E   
00473C DC     12789 CALL	C,ADD1		;ROUND UP
00473D C8   
00473E 4E   
00473F C1     12790 POP	BC		;RESTORE EXPONENTS
004740 DC     12791 CALL	C,INCC
004741 F0   
004742 4E   
004743 1F     12792 RRA			;LSB OF A TO CARRY
004744 79     12793 LD	A,C		;COMPUTE NEW EXPONENT
004745 88     12794 ADC	A,B
004746 38     12795 CHKOVF:         JR	C,CHKO1
004747 05   
004748 F2     12796 JP	P,ZEROmat		;UNDERFLOW
004749 21   
00474A 4F   
00474B 18     12797 JR	CHKO2
00474C 03   
00474D FA     12798 CHKO1:          JP	M,OFLOW		;OVERFLOW
00474E F2   
00474F 4E   
004750 C6     12799 CHKO2:          ADD	A,80H
004751 80   
004752 4F     12800 LD	C,A
004753 CA     12801 JP	Z,ZEROmat
004754 21   
004755 4F   
004756 08     12802 EX	AF,AF'		;RESTORE SIGN BIT
004757 CB     12803 RES	7,H
004758 BC   
004759 F0     12804 RET	P
00475A CB     12805 SET	7,H
00475B FC   
00475C C9     12806 RET
00475D CD     12810 IPOW:           CALL	SWAP
00475E DC   
00475F 4E   
004760 CB     12811 BIT	7,H
004761 7C   
004762 F5     12812 PUSH	AF		;SAVE SIGN
004763 C4     12813 CALL	NZ,NEGATE
004764 06   
004765 4E   
004766 48     12814 IPOW0:          LD	C,B
004767 06     12815 LD	B,32		;LOOP COUNTER
004768 20   
004769 CD     12816 IPOW1:          CALL	X2
00476A 7B   
00476B 4F   
00476C 38     12817 JR	C,IPOW2
00476D 08   
00476E 10     12818 DJNZ	IPOW1
00476F F9   
004770 F1     12819 POP	AF
004771 D9     12820 EXX
004772 2C     12821 INC	L		;RESULT=1
004773 D9     12822 EXX
004774 4C     12823 LD	C,H
004775 C9     12824 RET
004776 F1     12826 IPOW2:          POP	AF
004777 C5     12827 PUSH	BC
004778 EB     12828 EX	DE,HL
004779 E5     12829 PUSH	HL
00477A D9     12830 EXX
00477B EB     12831 EX	DE,HL
00477C E5     12832 PUSH	HL
00477D D9     12833 EXX
00477E DD     12834 LD	IX,0
00477F 21   
004780 00   
004781 00   
004782 DD     12835 ADD	IX,SP
004783 39   
004784 28     12836 JR	Z,IPOW4
004785 34   
004786 C5     12837 PUSH	BC
004787 D9     12838 EXX
004788 D5     12839 PUSH	DE
004789 D9     12840 EXX
00478A D5     12841 PUSH	DE
00478B CD     12842 CALL	SFLOAT
00478C B2   
00478D 4E   
00478E CD     12843 CALL	RECIP
00478F 90   
004790 4A   
004791 CD     12844 CALL	STORE5
004792 06   
004793 32   
004794 18     12845 JR	IPOW5
004795 1D   
004796 C5     12847 IPOW3:          PUSH	BC
004797 D9     12848 EXX
004798 CB     12849 SLA	E
004799 23   
00479A CB     12850 RL	D
00479B 12   
00479C D5     12851 PUSH	DE
00479D D9     12852 EXX
00479E CB     12853 RL	E
00479F 13   
0047A0 CB     12854 RL	D
0047A1 12   
0047A2 D5     12855 PUSH	DE
0047A3 3E     12856 LD	A,'*' & 0FH
0047A4 0A   
0047A5 F5     12857 PUSH	AF
0047A6 CD     12858 CALL	COPY
0047A7 8D   
0047A8 4F   
0047A9 CD     12859 CALL	OP		;SQUARE
0047AA 2C   
0047AB 45   
0047AC F1     12860 POP	AF
0047AD CD     12861 CALL	DLOAD5
0047AE F1   
0047AF 19   
0047B0 DC     12862 CALL	C,OP		;MULTIPLY BY X
0047B1 2C   
0047B2 45   
0047B3 D1     12863 IPOW5:          POP	DE
0047B4 D9     12864 EXX
0047B5 D1     12865 POP	DE
0047B6 D9     12866 EXX
0047B7 79     12867 LD	A,C
0047B8 C1     12868 POP	BC
0047B9 4F     12869 LD	C,A
0047BA 10     12870 IPOW4:          DJNZ	IPOW3
0047BB DA   
0047BC F1     12871 POP	AF
0047BD F1     12872 POP	AF
0047BE F1     12873 POP	AF
0047BF C9     12874 RET
0047C0 F1     12876 FPOW0:          POP	AF
0047C1 F1     12877 POP	AF
0047C2 F1     12878 POP	AF
0047C3 18     12879 JR	IPOW0
0047C4 A1   
0047C5 CB     12883 FPOW:           BIT	7,D
0047C6 7A   
0047C7 F5     12884 PUSH	AF
0047C8 CD     12885 CALL	SWAP
0047C9 DC   
0047CA 4E   
0047CB CD     12886 CALL	PUSH5
0047CC 9B   
0047CD 4F   
0047CE 0D     12887 DEC	C
0047CF 0C     12888 INC	C
0047D0 28     12889 JR	Z,FPOW0
0047D1 EE   
0047D2 3E     12890 LD	A,158
0047D3 9E   
0047D4 B9     12891 CP	C
0047D5 38     12892 JR	C,FPOW1
0047D6 08   
0047D7 3C     12893 INC	A
0047D8 CD     12894 CALL	FIX
0047D9 DE   
0047DA 4D   
0047DB 08     12895 EX	AF,AF'
0047DC F2     12896 JP	P,FPOW0
0047DD C0   
0047DE 47   
0047DF CD     12897 FPOW1:          CALL	SWAP
0047E0 DC   
0047E1 4E   
0047E2 CD     12898 CALL	LN0
0047E3 A7   
0047E4 4A   
0047E5 CD     12899 CALL	POP5
0047E6 A4   
0047E7 4F   
0047E8 F1     12900 POP	AF
0047E9 CD     12901 CALL	FMUL
0047EA 0D   
0047EB 47   
0047EC C3     12902 JP	EXP0
0047ED 1C   
0047EE 4A   
0047EF CD     12907 FLT:            CALL	FCP
0047F0 2B   
0047F1 4F   
0047F2 18     12908 JR	ILT1
0047F3 03   
0047F4 CD     12909 ILT:            CALL	ICP
0047F5 1E   
0047F6 4F   
0047F7 D0     12910 ILT1:           RET	NC
0047F8 18     12911 JR	TRUE
0047F9 38   
0047FA CD     12913 FGT:            CALL	FCP
0047FB 2B   
0047FC 4F   
0047FD 18     12914 JR	IGT1
0047FE 03   
0047FF CD     12915 IGT:            CALL	ICP
004800 1E   
004801 4F   
004802 C8     12916 IGT1:           RET	Z
004803 D8     12917 RET	C
004804 18     12918 JR	TRUE
004805 2C   
004806 CD     12920 FGE:            CALL	FCP
004807 2B   
004808 4F   
004809 18     12921 JR	IGE1
00480A 03   
00480B CD     12922 IGE:            CALL	ICP
00480C 1E   
00480D 4F   
00480E D8     12923 IGE1:           RET	C
00480F 18     12924 JR	TRUE
004810 21   
004811 CD     12926 FLE:            CALL	FCP
004812 2B   
004813 4F   
004814 18     12927 JR	ILE1
004815 03   
004816 CD     12928 ILE:            CALL	ICP
004817 1E   
004818 4F   
004819 28     12929 ILE1:           JR	Z,TRUE
00481A 17   
00481B D0     12930 RET	NC
00481C 18     12931 JR	TRUE
00481D 14   
00481E CD     12933 FNE:            CALL	FCP
00481F 2B   
004820 4F   
004821 18     12934 JR	INE1
004822 03   
004823 CD     12935 INE:            CALL	ICP
004824 1E   
004825 4F   
004826 C8     12936 INE1:           RET	Z
004827 18     12937 JR	TRUE
004828 09   
004829 CD     12939 FEQ:            CALL	FCP
00482A 2B   
00482B 4F   
00482C 18     12940 JR	IEQ1
00482D 03   
00482E CD     12941 IEQ:            CALL	ICP
00482F 1E   
004830 4F   
004831 C0     12942 IEQ1:           RET	NZ
004832 21     12943 TRUE:           LD	HL,-1
004833 FF   
004834 FF   
004835 D9     12944 EXX
004836 21     12945 LD	HL,-1
004837 FF   
004838 FF   
004839 D9     12946 EXX
00483A AF     12947 XOR	A
00483B 4F     12948 LD	C,A
00483C C9     12949 RET
00483D CD     12954 ISHL:           CALL	SHIFTS
00483E 6E   
00483F 48   
004840 28     12955 JR	Z,SHRET
004841 07   
004842 D9     12956 ISHL1:          EXX
004843 29     12957 ADD	HL,HL
004844 D9     12958 EXX
004845 ED     12959 ADC	HL,HL
004846 6A   
004847 10     12960 DJNZ	ISHL1
004848 F9   
004849 C9     12961 SHRET:          RET
00484A CD     12963 ISAR:           CALL	SHIFTS
00484B 6E   
00484C 48   
00484D 28     12964 JR	Z,SHRET
00484E FA   
00484F CB     12965 ISAR1:          SRA	H
004850 2C   
004851 CB     12966 RR	L
004852 1D   
004853 D9     12967 EXX
004854 CB     12968 RR	H
004855 1C   
004856 CB     12969 RR	L
004857 1D   
004858 D9     12970 EXX
004859 10     12971 DJNZ	ISAR1
00485A F4   
00485B C9     12972 RET
00485C CD     12974 ISHR:           CALL	SHIFTS
00485D 6E   
00485E 48   
00485F 28     12975 JR	Z,SHRET
004860 E8   
004861 CB     12976 ISHR1:          SRL	H
004862 3C   
004863 CB     12977 RR	L
004864 1D   
004865 D9     12978 EXX
004866 CB     12979 RR	H
004867 1C   
004868 CB     12980 RR	L
004869 1D   
00486A D9     12981 EXX
00486B 10     12982 DJNZ	ISHR1
00486C F4   
00486D C9     12983 RET
00486E CD     12985 SHIFTS:         CALL	FIX2
00486F EE   
004870 4D   
004871 7A     12986 LD	A,D
004872 B3     12987 OR	E
004873 D9     12988 EXX
004874 B2     12989 OR	D
004875 7B     12990 LD	A,E
004876 D9     12991 EXX
004877 06     12992 LD	B,32
004878 20   
004879 20     12993 JR	NZ,SHMAX
00487A 02   
00487B 47     12994 LD	B,A
00487C B7     12995 OR	A
00487D C9     12996 SHMAX:          RET
00487E CB     13007 ABS:            BIT	7,H
00487F 7C   
004880 C8     13008 RET	Z		;POSITIVE/ZERO
004881 0D     13009 DEC	C
004882 0C     13010 INC	C
004883 CA     13011 JP	Z,NEGATE	;INTEGER
004884 06   
004885 4E   
004886 CB     13012 RES	7,H
004887 BC   
004888 C9     13013 RET
004889 CD     13018 CPL_:           CALL	SFIXmat
00488A F7   
00488B 4D   
00488C 7C     13019 LD	A,H
00488D 2F     13020 CPL
00488E 67     13021 LD	H,A
00488F 7D     13022 LD	A,L
004890 2F     13023 CPL
004891 6F     13024 LD	L,A
004892 D9     13025 EXX
004893 7C     13026 LD	A,H
004894 2F     13027 CPL
004895 67     13028 LD	H,A
004896 7D     13029 LD	A,L
004897 2F     13030 CPL
004898 6F     13031 LD	L,A
004899 D9     13032 EXX
00489A AF     13033 XOR	A		;NUMERIC MARKER
00489B C9     13034 RET
00489C 21     13039 PI:             LD	HL,490FH
00489D 0F   
00489E 49   
00489F D9     13040 EXX
0048A0 21     13041 LD	HL,0DAA2H
0048A1 A2   
0048A2 DA   
0048A3 D9     13042 EXX
0048A4 0E     13043 LD	C,81H
0048A5 81   
0048A6 AF     13044 XOR	A		;NUMERIC MARKER
0048A7 C9     13045 RET
0048A8 CD     13050 DEG:            CALL	FPI180
0048A9 B8   
0048AA 48   
0048AB CD     13051 CALL	FMUL
0048AC 0D   
0048AD 47   
0048AE AF     13052 XOR	A
0048AF C9     13053 RET
0048B0 CD     13058 RAD:            CALL	FPI180
0048B1 B8   
0048B2 48   
0048B3 CD     13059 CALL	FDIV
0048B4 9D   
0048B5 46   
0048B6 AF     13060 XOR	A
0048B7 C9     13061 RET
0048B8 CD     13065 FPI180:         CALL	SFLOAT
0048B9 B2   
0048BA 4E   
0048BB 11     13066 LD	DE,652EH
0048BC 2E   
0048BD 65   
0048BE D9     13067 EXX
0048BF 11     13068 LD	DE,0E0D3H
0048C0 D3   
0048C1 E0   
0048C2 D9     13069 EXX
0048C3 06     13070 LD	B,85H
0048C4 85   
0048C5 C9     13071 RET
0048C6 CD     13076 SGN:            CALL	TESTmat
0048C7 01   
0048C8 4F   
0048C9 B1     13077 OR	C
0048CA C8     13078 RET	Z		;ZERO
0048CB CB     13079 BIT	7,H
0048CC 7C   
0048CD C2     13080 JP	NZ,TRUE		;-1
0048CE 32   
0048CF 48   
0048D0 CD     13081 CALL	ZEROmat
0048D1 21   
0048D2 4F   
0048D3 C3     13082 JP	ADD1		;1
0048D4 C8   
0048D5 4E   
0048D6 CD     13088 VAL:            CALL	SIGNQ
0048D7 E3   
0048D8 50   
0048D9 F5     13089 PUSH	AF
0048DA CD     13090 CALL	CON
0048DB 34   
0048DC 4D   
0048DD F1     13091 POP	AF
0048DE FE     13092 CP	'-'
0048DF 2D   
0048E0 3E     13093 LD	A,0		;NUMERIC MARKER
0048E1 00   
0048E2 C0     13094 RET	NZ
0048E3 0D     13095 DEC	C
0048E4 0C     13096 INC	C
0048E5 CA     13097 JP	Z,NEGATE	;ZERO/INTEGER
0048E6 06   
0048E7 4E   
0048E8 7C     13098 LD	A,H
0048E9 EE     13099 XOR	80H		;CHANGE SIGN (FP)
0048EA 80   
0048EB 67     13100 LD	H,A
0048EC AF     13101 XOR	A
0048ED C9     13102 RET
0048EE 0D     13107 INT_:           DEC	C
0048EF 0C     13108 INC	C
0048F0 C8     13109 RET	Z		;ZERO/INTEGER
0048F1 3E     13110 LD	A,159
0048F2 9F   
0048F3 44     13111 LD	B,H		;B7=SIGN BIT
0048F4 CD     13112 CALL	FIX
0048F5 DE   
0048F6 4D   
0048F7 08     13113 EX	AF,AF'
0048F8 A0     13114 AND	B
0048F9 FC     13115 CALL	M,ADD1		;NEGATIVE NON-INTEGER
0048FA C8   
0048FB 4E   
0048FC 78     13116 LD	A,B
0048FD B7     13117 OR	A
0048FE FC     13118 CALL	M,NEGATE
0048FF 06   
004900 4E   
004901 AF     13119 XOR	A
004902 4F     13120 LD	C,A
004903 C9     13121 RET
004904 CD     13126 SQR:            CALL	SFLOAT
004905 B2   
004906 4E   
004907 CB     13127 SQR0:           BIT	7,H
004908 7C   
004909 3E     13128 LD	A,NGROOT
00490A 15   
00490B C2     13129 JP	NZ,ERROR_mat	;"-ve root"
00490C 26   
00490D 45   
00490E 0D     13130 DEC	C
00490F 0C     13131 INC	C
004910 C8     13132 RET	Z		;ZERO
004911 CB     13133 SET	7,H		;IMPLIED 1
004912 FC   
004913 CB     13134 BIT	0,C
004914 41   
004915 CC     13135 CALL	Z,DIV2		;MAKE EXPONENT ODD
004916 E4   
004917 4E   
004918 79     13136 LD	A,C
004919 D6     13137 SUB	80H
00491A 80   
00491B CB     13138 SRA	A		;HALVE EXPONENT
00491C 2F   
00491D C6     13139 ADD	A,80H
00491E 80   
00491F 4F     13140 LD	C,A
004920 C5     13141 PUSH	BC		;SAVE EXPONENT
004921 EB     13142 EX	DE,HL
004922 21     13143 LD	HL,0
004923 00   
004924 00   
004925 44     13144 LD	B,H
004926 4D     13145 LD	C,L
004927 D9     13146 EXX
004928 EB     13147 EX	DE,HL
004929 21     13148 LD	HL,0
00492A 00   
00492B 00   
00492C 44     13149 LD	B,H
00492D 4D     13150 LD	C,L
00492E 3E     13151 LD	A,-31
00492F E1   
004930 CD     13152 CALL	SQRA		;ROOT
004931 92   
004932 50   
004933 D9     13153 EXX
004934 CB     13154 BIT	7,B
004935 78   
004936 D9     13155 EXX
004937 CC     13156 CALL	Z,SQRA		;NORMALISE & INC A
004938 92   
004939 50   
00493A CD     13157 CALL	SQRB
00493B B1   
00493C 50   
00493D B7     13158 OR	A		;CLEAR CARRY
00493E CD     13159 CALL	DIVB
00493F 4C   
004940 50   
004941 CB     13160 RR	E		;LSB TO CARRY
004942 1B   
004943 60     13161 LD	H,B
004944 69     13162 LD	L,C
004945 D9     13163 EXX
004946 60     13164 LD	H,B
004947 69     13165 LD	L,C
004948 DC     13166 CALL	C,ADD1		;ROUND UP
004949 C8   
00494A 4E   
00494B C1     13167 POP	BC		;RESTORE EXPONENT
00494C DC     13168 CALL	C,INCC
00494D F0   
00494E 4E   
00494F 1F     13169 RRA
004950 9F     13170 SBC	A,A
004951 81     13171 ADD	A,C
004952 4F     13172 LD	C,A
004953 CB     13173 RES	7,H		;POSITIVE
004954 BC   
004955 AF     13174 XOR	A
004956 C9     13175 RET
004957 CD     13180 TAN:            CALL	SFLOAT
004958 B2   
004959 4E   
00495A CD     13181 CALL	PUSH5
00495B 9B   
00495C 4F   
00495D CD     13182 CALL	COS0
00495E 77   
00495F 49   
004960 CD     13183 CALL	POP5
004961 A4   
004962 4F   
004963 CD     13184 CALL	PUSH5
004964 9B   
004965 4F   
004966 CD     13185 CALL	SWAP
004967 DC   
004968 4E   
004969 CD     13186 CALL	SIN0
00496A 82   
00496B 49   
00496C CD     13187 CALL	POP5
00496D A4   
00496E 4F   
00496F CD     13188 CALL	FDIV
004970 9D   
004971 46   
004972 AF     13189 XOR	A		;NUMERIC MARKER
004973 C9     13190 RET
004974 CD     13195 COS:            CALL	SFLOAT
004975 B2   
004976 4E   
004977 CD     13196 COS0:           CALL	SCALE
004978 27   
004979 4E   
00497A 1C     13197 INC	E
00497B 1C     13198 INC	E
00497C 7B     13199 LD	A,E
00497D 18     13200 JR	SIN1
00497E 0E   
00497F CD     13205 SIN:            CALL	SFLOAT
004980 B2   
004981 4E   
004982 E5     13206 SIN0:           PUSH	HL		;H7=SIGN
004983 CD     13207 CALL	SCALE
004984 27   
004985 4E   
004986 F1     13208 POP	AF
004987 07     13209 RLCA
004988 07     13210 RLCA
004989 07     13211 RLCA
00498A E6     13212 AND	4
00498B 04   
00498C AB     13213 XOR	E
00498D F5     13214 SIN1:           PUSH	AF		;OCTANT
00498E CB     13215 RES	7,H
00498F BC   
004990 1F     13216 RRA
004991 CD     13217 CALL	PIBY4
004992 0E   
004993 4A   
004994 DC     13218 CALL	C,RSUB		;X=(PI/4)-X
004995 35   
004996 46   
004997 F1     13219 POP	AF
004998 F5     13220 PUSH	AF
004999 E6     13221 AND	3
00499A 03   
00499B E2     13222 JP	PO,SIN2		;USE COSINE APPROX.
00499C CC   
00499D 49   
00499E CD     13223 CALL	PUSH5		;SAVE X
00499F 9B   
0049A0 4F   
0049A1 CD     13224 CALL	SQUARE		;PUSH X*X
0049A2 95   
0049A3 4F   
0049A4 CD     13225 CALL	POLY
0049A5 CE   
0049A6 4F   
0049A7 B7     13226 DW	0A8B7H		;a(8)
0049A8 A8   
0049A9 11     13227 DW	3611H
0049AA 36   
0049AB 6D     13228 DB	6DH
0049AC 26     13229 DW	0DE26H		;a(6)
0049AD DE   
0049AE 05     13230 DW	0D005H
0049AF D0   
0049B0 73     13231 DB	73H
0049B1 C0     13232 DW	80C0H		;a(4)
0049B2 80   
0049B3 88     13233 DW	888H
0049B4 08   
0049B5 79     13234 DB	79H
0049B6 9D     13235 DW	0AA9DH		;a(2)
0049B7 AA   
0049B8 AA     13236 DW	0AAAAH
0049B9 AA   
0049BA 7D     13237 DB	7DH
0049BB 00     13238 DW	0		;a(0)
0049BC 00   
0049BD 00     13239 DW	0
0049BE 00   
0049BF 80     13240 DB	80H
0049C0 CD     13241 CALL	POP5
0049C1 A4   
0049C2 4F   
0049C3 CD     13242 CALL	POP5
0049C4 A4   
0049C5 4F   
0049C6 CD     13243 CALL	FMUL
0049C7 0D   
0049C8 47   
0049C9 C3     13244 JP	SIN3
0049CA EE   
0049CB 49   
0049CC CD     13246 SIN2:           CALL	SQUARE		;PUSH X*X
0049CD 95   
0049CE 4F   
0049CF CD     13247 CALL	POLY
0049D0 CE   
0049D1 4F   
0049D2 71     13248 DW	0D571H		;b(8)
0049D3 D5   
0049D4 78     13249 DW	4C78H
0049D5 4C   
0049D6 70     13250 DB	70H
0049D7 AF     13251 DW	94AFH		;b(6)
0049D8 94   
0049D9 03     13252 DW	0B603H
0049DA B6   
0049DB 76     13253 DB	76H
0049DC C8     13254 DW	9CC8H		;b(4)
0049DD 9C   
0049DE AA     13255 DW	2AAAH
0049DF 2A   
0049E0 7B     13256 DB	7BH
0049E1 DD     13257 DW	0FFDDH		;b(2)
0049E2 FF   
0049E3 FF     13258 DW	0FFFFH
0049E4 FF   
0049E5 7E     13259 DB	7EH
0049E6 00     13260 DW	0		;b(0)
0049E7 00   
0049E8 00     13261 DW	0
0049E9 00   
0049EA 80     13262 DB	80H
0049EB CD     13263 CALL	POP5
0049EC A4   
0049ED 4F   
0049EE F1     13264 SIN3:           POP	AF
0049EF E6     13265 AND	4
0049F0 04   
0049F1 C8     13266 RET	Z
0049F2 0D     13267 DEC	C
0049F3 0C     13268 INC	C
0049F4 C8     13269 RET	Z		;ZERO
0049F5 CB     13270 SET	7,H		;MAKE NEGATIVE
0049F6 FC   
0049F7 C9     13271 RET
0049F8 21     13275 FONE:           LD	HL,0
0049F9 00   
0049FA 00   
0049FB D9     13276 EXX
0049FC 21     13277 LD	HL,0
0049FD 00   
0049FE 00   
0049FF D9     13278 EXX
004A00 0E     13279 LD	C,80H
004A01 80   
004A02 C9     13280 RET
004A03 11     13282 DONE:           LD	DE,0
004A04 00   
004A05 00   
004A06 D9     13283 EXX
004A07 11     13284 LD	DE,0
004A08 00   
004A09 00   
004A0A D9     13285 EXX
004A0B 06     13286 LD	B,80H
004A0C 80   
004A0D C9     13287 RET
004A0E 11     13289 PIBY4:          LD	DE,490FH
004A0F 0F   
004A10 49   
004A11 D9     13290 EXX
004A12 11     13291 LD	DE,0DAA2H
004A13 A2   
004A14 DA   
004A15 D9     13292 EXX
004A16 06     13293 LD	B,7FH
004A17 7F   
004A18 C9     13294 RET
004A19 CD     13299 EXP:            CALL	SFLOAT
004A1A B2   
004A1B 4E   
004A1C CD     13300 EXP0:           CALL	LN2		;LN(2)
004A1D 99   
004A1E 4A   
004A1F D9     13301 EXX
004A20 1D     13302 DEC	E
004A21 01     13303 LD	BC,0D1CFH	;0.6931471805599453
004A22 CF   
004A23 D1   
004A24 D9     13304 EXX
004A25 E5     13305 PUSH	HL		;H7=SIGN
004A26 CD     13306 CALL	MOD48		;"MODULUS"
004A27 37   
004A28 4E   
004A29 F1     13307 POP	AF
004A2A CB     13308 BIT	7,E
004A2B 7B   
004A2C 28     13309 JR	Z,EXP1
004A2D 09   
004A2E 17     13310 RLA
004A2F DA     13311 JP	C,ZEROmat
004A30 21   
004A31 4F   
004A32 3E     13312 LD	A,EXPRNG
004A33 18   
004A34 C3     13313 JP	ERROR_mat		;"Exp range"
004A35 26   
004A36 45   
004A37 E6     13315 EXP1:           AND	80H
004A38 80   
004A39 B3     13316 OR	E
004A3A F5     13317 PUSH	AF		;INTEGER PART
004A3B CB     13318 RES	7,H
004A3C BC   
004A3D CD     13319 CALL	PUSH5		;PUSH X*LN(2)
004A3E 9B   
004A3F 4F   
004A40 CD     13320 CALL	POLY
004A41 CE   
004A42 4F   
004A43 72     13321 DW	4072H		;a(7)
004A44 40   
004A45 2E     13322 DW	942EH
004A46 94   
004A47 73     13323 DB	73H
004A48 65     13324 DW	6F65H		;a(6)
004A49 6F   
004A4A 4F     13325 DW	2E4FH
004A4B 2E   
004A4C 76     13326 DB	76H
004A4D 37     13327 DW	6D37H		;a(5)
004A4E 6D   
004A4F 02     13328 DW	8802H
004A50 88   
004A51 79     13329 DB	79H
004A52 12     13330 DW	0E512H		;a(4)
004A53 E5   
004A54 A0     13331 DW	2AA0H
004A55 2A   
004A56 7B     13332 DB	7BH
004A57 14     13333 DW	4F14H		;a(3)
004A58 4F   
004A59 AA     13334 DW	0AAAAH
004A5A AA   
004A5B 7D     13335 DB	7DH
004A5C 56     13336 DW	0FD56H		;a(2)
004A5D FD   
004A5E FF     13337 DW	7FFFH
004A5F 7F   
004A60 7E     13338 DB	7EH
004A61 FE     13339 DW	0FFFEH		;a(1)
004A62 FF   
004A63 FF     13340 DW	0FFFFH
004A64 FF   
004A65 7F     13341 DB	7FH
004A66 00     13342 DW	0		;a(0)
004A67 00   
004A68 00     13343 DW	0
004A69 00   
004A6A 80     13344 DB	80H
004A6B CD     13345 CALL	POP5
004A6C A4   
004A6D 4F   
004A6E F1     13346 POP	AF
004A6F F5     13347 PUSH	AF
004A70 F4     13348 CALL	P,RECIP		;X=1/X
004A71 90   
004A72 4A   
004A73 F1     13349 POP	AF
004A74 F2     13350 JP	P,EXP4
004A75 7B   
004A76 4A   
004A77 E6     13351 AND	7FH
004A78 7F   
004A79 ED     13352 NEG
004A7A 44   
004A7B C6     13353 EXP4:           ADD	A,80H
004A7C 80   
004A7D 81     13354 ADD	A,C
004A7E 38     13355 JR	C,EXP2
004A7F 05   
004A80 F2     13356 JP	P,ZEROmat		;UNDERFLOW
004A81 21   
004A82 4F   
004A83 18     13357 JR	EXP3
004A84 03   
004A85 FA     13358 EXP2:           JP	M,OFLOW		;OVERFLOW
004A86 F2   
004A87 4E   
004A88 C6     13359 EXP3:           ADD	A,80H
004A89 80   
004A8A CA     13360 JP	Z,ZEROmat
004A8B 21   
004A8C 4F   
004A8D 4F     13361 LD	C,A
004A8E AF     13362 XOR	A		;NUMERIC MARKER
004A8F C9     13363 RET
004A90 CD     13365 RECIP:          CALL	DONE
004A91 03   
004A92 4A   
004A93 CD     13366 RDIV:           CALL	SWAP
004A94 DC   
004A95 4E   
004A96 C3     13367 JP	FDIV		;RECIPROCAL
004A97 9D   
004A98 46   
004A99 11     13369 LN2:            LD	DE,3172H	;LN(2)
004A9A 72   
004A9B 31   
004A9C D9     13370 EXX
004A9D 11     13371 LD	DE,17F8H
004A9E F8   
004A9F 17   
004AA0 D9     13372 EXX
004AA1 06     13373 LD	B,7FH
004AA2 7F   
004AA3 C9     13374 RET
004AA4 CD     13379 LN:             CALL	SFLOAT
004AA5 B2   
004AA6 4E   
004AA7 3E     13380 LN0:            LD	A,LOGRNG
004AA8 16   
004AA9 CB     13381 BIT	7,H
004AAA 7C   
004AAB C2     13382 JP	NZ,ERROR_mat	;"Log range"
004AAC 26   
004AAD 45   
004AAE 0C     13383 INC	C
004AAF 0D     13384 DEC	C
004AB0 CA     13385 JP	Z,ERROR_mat
004AB1 26   
004AB2 45   
004AB3 11     13386 LD	DE,3504H	;SQR(2)
004AB4 04   
004AB5 35   
004AB6 D9     13387 EXX
004AB7 11     13388 LD	DE,0F333H	;1.41421356237
004AB8 33   
004AB9 F3   
004ABA D9     13389 EXX
004ABB CD     13390 CALL	ICP0		;MANTISSA>SQR(2)?
004ABC 33   
004ABD 4F   
004ABE 79     13391 LD	A,C		;EXPONENT
004ABF 0E     13392 LD	C,80H		;1 <= X < 2
004AC0 80   
004AC1 38     13393 JR	C,LN4
004AC2 02   
004AC3 0D     13394 DEC	C
004AC4 3C     13395 INC	A
004AC5 F5     13396 LN4:            PUSH	AF		;SAVE EXPONENT
004AC6 CD     13397 CALL	RATIO		;X=(X-1)/(X+1)
004AC7 B0   
004AC8 4F   
004AC9 CD     13398 CALL	PUSH5
004ACA 9B   
004ACB 4F   
004ACC CD     13399 CALL	SQUARE		;PUSH X*X
004ACD 95   
004ACE 4F   
004ACF CD     13400 CALL	POLY
004AD0 CE   
004AD1 4F   
004AD2 48     13401 DW	0CC48H		;a(9)
004AD3 CC   
004AD4 FB     13402 DW	74FBH
004AD5 74   
004AD6 7D     13403 DB	7DH
004AD7 AF     13404 DW	0AEAFH		;a(7)
004AD8 AE   
004AD9 FF     13405 DW	11FFH
004ADA 11   
004ADB 7E     13406 DB	7EH
004ADC 8C     13407 DW	0D98CH		;a(5)
004ADD D9   
004ADE CD     13408 DW	4CCDH
004ADF 4C   
004AE0 7E     13409 DB	7EH
004AE1 E3     13410 DW	0A9E3H		;a(3)
004AE2 A9   
004AE3 AA     13411 DW	2AAAH
004AE4 2A   
004AE5 7F     13412 DB	7FH
004AE6 00     13413 DW	0		;a(1)
004AE7 00   
004AE8 00     13414 DW	0
004AE9 00   
004AEA 81     13415 DB	81H
004AEB CD     13416 CALL	POP5
004AEC A4   
004AED 4F   
004AEE CD     13417 CALL	POP5
004AEF A4   
004AF0 4F   
004AF1 CD     13418 CALL	FMUL
004AF2 0D   
004AF3 47   
004AF4 F1     13419 POP	AF		;EXPONENT
004AF5 CD     13420 CALL	PUSH5
004AF6 9B   
004AF7 4F   
004AF8 08     13421 EX	AF,AF'
004AF9 CD     13422 CALL	ZEROmat
004AFA 21   
004AFB 4F   
004AFC 08     13423 EX	AF,AF'
004AFD D6     13424 SUB	80H
004AFE 80   
004AFF 28     13425 JR	Z,LN3
004B00 1B   
004B01 30     13426 JR	NC,LN1
004B02 02   
004B03 2F     13427 CPL
004B04 3C     13428 INC	A
004B05 67     13429 LN1:            LD	H,A
004B06 0E     13430 LD	C,87H
004B07 87   
004B08 F5     13431 PUSH	AF
004B09 CD     13432 CALL	FLOAT
004B0A 98   
004B0B 4E   
004B0C CB     13433 RES	7,H
004B0D BC   
004B0E CD     13434 CALL	LN2
004B0F 99   
004B10 4A   
004B11 CD     13435 CALL	FMUL
004B12 0D   
004B13 47   
004B14 F1     13436 POP	AF
004B15 30     13437 JR	NC,LN3
004B16 05   
004B17 FA     13438 JP	M,LN3
004B18 1C   
004B19 4B   
004B1A CB     13439 SET	7,H
004B1B FC   
004B1C CD     13440 LN3:            CALL	POP5
004B1D A4   
004B1E 4F   
004B1F CD     13441 CALL	FADD
004B20 45   
004B21 46   
004B22 AF     13442 XOR	A
004B23 C9     13443 RET
004B24 CD     13448 LOG:            CALL	LN
004B25 A4   
004B26 4A   
004B27 11     13449 LD	DE,5E5BH	;LOG(e)
004B28 5B   
004B29 5E   
004B2A D9     13450 EXX
004B2B 11     13451 LD	DE,0D8A9H
004B2C A9   
004B2D D8   
004B2E D9     13452 EXX
004B2F 06     13453 LD	B,7EH
004B30 7E   
004B31 CD     13454 CALL	FMUL
004B32 0D   
004B33 47   
004B34 AF     13455 XOR	A
004B35 C9     13456 RET
004B36 CD     13461 ASN:            CALL	SFLOAT
004B37 B2   
004B38 4E   
004B39 CD     13462 CALL	PUSH5
004B3A 9B   
004B3B 4F   
004B3C CD     13463 CALL	COPY
004B3D 8D   
004B3E 4F   
004B3F CD     13464 CALL	FMUL
004B40 0D   
004B41 47   
004B42 CD     13465 CALL	DONE
004B43 03   
004B44 4A   
004B45 CD     13466 CALL	RSUB
004B46 35   
004B47 46   
004B48 CD     13467 CALL	SQR0
004B49 07   
004B4A 49   
004B4B CD     13468 CALL	POP5
004B4C A4   
004B4D 4F   
004B4E 0C     13469 INC	C
004B4F 0D     13470 DEC	C
004B50 3E     13471 LD	A,2
004B51 02   
004B52 D5     13472 PUSH	DE
004B53 28     13473 JR	Z,ACS1
004B54 70   
004B55 D1     13474 POP	DE
004B56 CD     13475 CALL	RDIV
004B57 93   
004B58 4A   
004B59 18     13476 JR	ATN0
004B5A 03   
004B5B CD     13481 ATN:            CALL	SFLOAT
004B5C B2   
004B5D 4E   
004B5E E5     13482 ATN0:           PUSH	HL		;SAVE SIGN
004B5F CB     13483 RES	7,H
004B60 BC   
004B61 11     13484 LD	DE,5413H	;TAN(PI/8)=SQR(2)-1
004B62 13   
004B63 54   
004B64 D9     13485 EXX
004B65 11     13486 LD	DE,0CCD0H
004B66 D0   
004B67 CC   
004B68 D9     13487 EXX
004B69 06     13488 LD	B,7EH
004B6A 7E   
004B6B CD     13489 CALL	FCP0		;COMPARE
004B6C 30   
004B6D 4F   
004B6E 06     13490 LD	B,0
004B6F 00   
004B70 38     13491 JR	C,ATN2
004B71 1C   
004B72 11     13492 LD	DE,1A82H	;TAN(3*PI/8)=SQR(2)+1
004B73 82   
004B74 1A   
004B75 D9     13493 EXX
004B76 11     13494 LD	DE,799AH
004B77 9A   
004B78 79   
004B79 D9     13495 EXX
004B7A 06     13496 LD	B,81H
004B7B 81   
004B7C CD     13497 CALL	FCP0		;COMPARE
004B7D 30   
004B7E 4F   
004B7F 38     13498 JR	C,ATN1
004B80 08   
004B81 CD     13499 CALL	RECIP		;X=1/X
004B82 90   
004B83 4A   
004B84 06     13500 LD	B,2
004B85 02   
004B86 C3     13501 JP	ATN2
004B87 8E   
004B88 4B   
004B89 CD     13502 ATN1:           CALL	RATIO		;X=(X-1)/(X+1)
004B8A B0   
004B8B 4F   
004B8C 06     13503 LD	B,1
004B8D 01   
004B8E C5     13504 ATN2:           PUSH	BC		;SAVE FLAG
004B8F CD     13505 CALL	PUSH5
004B90 9B   
004B91 4F   
004B92 CD     13506 CALL	SQUARE		;PUSH X*X
004B93 95   
004B94 4F   
004B95 CD     13507 CALL	POLY
004B96 CE   
004B97 4F   
004B98 35     13508 DW	0F335H		;a(13)
004B99 F3   
004B9A D8     13509 DW	37D8H
004B9B 37   
004B9C 7B     13510 DB	7BH
004B9D 91     13511 DW	6B91H		;a(11)
004B9E 6B   
004B9F B9     13512 DW	0AAB9H
004BA0 AA   
004BA1 7C     13513 DB	7CH
004BA2 DE     13514 DW	41DEH		;a(9)
004BA3 41   
004BA4 97     13515 DW	6197H
004BA5 61   
004BA6 7C     13516 DB	7CH
004BA7 7B     13517 DW	9D7BH		;a(7)
004BA8 9D   
004BA9 37     13518 DW	9237H
004BAA 92   
004BAB 7D     13519 DB	7DH
004BAC 5A     13520 DW	2A5AH		;a(5)
004BAD 2A   
004BAE CC     13521 DW	4CCCH
004BAF 4C   
004BB0 7D     13522 DB	7DH
004BB1 5C     13523 DW	0A95CH		;a(3)
004BB2 A9   
004BB3 AA     13524 DW	0AAAAH
004BB4 AA   
004BB5 7E     13525 DB	7EH
004BB6 00     13526 DW	0		;a(1)
004BB7 00   
004BB8 00     13527 DW	0
004BB9 00   
004BBA 80     13528 DB	80H
004BBB CD     13529 CALL	POP5
004BBC A4   
004BBD 4F   
004BBE CD     13530 CALL	POP5
004BBF A4   
004BC0 4F   
004BC1 CD     13531 CALL	FMUL
004BC2 0D   
004BC3 47   
004BC4 F1     13532 POP	AF
004BC5 CD     13533 ACS1:           CALL	PIBY4		;PI/4
004BC6 0E   
004BC7 4A   
004BC8 1F     13534 RRA
004BC9 F5     13535 PUSH	AF
004BCA DC     13536 CALL	C,FADD
004BCB 45   
004BCC 46   
004BCD F1     13537 POP	AF
004BCE 04     13538 INC	B
004BCF 1F     13539 RRA
004BD0 DC     13540 CALL	C,RSUB
004BD1 35   
004BD2 46   
004BD3 F1     13541 POP	AF
004BD4 B7     13542 OR	A
004BD5 F0     13543 RET	P
004BD6 CB     13544 SET	7,H		;MAKE NEGATIVE
004BD7 FC   
004BD8 AF     13545 XOR	A
004BD9 C9     13546 RET
004BDA CD     13551 ACS:            CALL	ASN
004BDB 36   
004BDC 4B   
004BDD 3E     13552 LD	A,2
004BDE 02   
004BDF F5     13553 PUSH	AF
004BE0 18     13554 JR	ACS1
004BE1 E3   
004BE2 CD     13564 STRmat:            CALL	SFLOAT
004BE3 B2   
004BE4 4E   
004BE5 06     13565 LD	B,0		;DEFAULT PT. POSITION
004BE6 00   
004BE7 CB     13566 BIT	7,H		;NEGATIVE?
004BE8 7C   
004BE9 28     13567 JR	Z,STR10
004BEA 06   
004BEB CB     13568 RES	7,H
004BEC BC   
004BED 3E     13569 LD	A,'-'
004BEE 2D   
004BEF 12     13570 LD	(DE),A		;STORE SIGN
004BF0 13     13571 INC	DE
004BF1 AF     13572 STR10:          XOR	A		;CLEAR A
004BF2 B9     13573 CP	C
004BF3 28     13574 JR	Z,STR2mat		;ZERO
004BF4 47   
004BF5 D5     13575 PUSH	DE		;SAVE TEXT POINTER
004BF6 78     13576 LD	A,B
004BF7 F5     13577 STR11:          PUSH	AF		;SAVE DECIMAL COUNTER
004BF8 79     13578 LD	A,C		;BINARY EXPONENT
004BF9 FE     13579 CP	161
004BFA A1   
004BFB 30     13580 JR	NC,STR14
004BFC 1A   
004BFD FE     13581 CP	155
004BFE 9B   
004BFF 30     13582 JR	NC,STR15
004C00 25   
004C01 2F     13583 CPL
004C02 FE     13584 CP	225
004C03 E1   
004C04 38     13585 JR	C,STR13
004C05 02   
004C06 3E     13586 LD	A,-8
004C07 F8   
004C08 C6     13587 STR13:          ADD	A,28
004C09 1C   
004C0A CD     13588 CALL	POWR10
004C0B F5   
004C0C 4F   
004C0D F5     13589 PUSH	AF
004C0E CD     13590 CALL	FMUL
004C0F 0D   
004C10 47   
004C11 F1     13591 POP	AF
004C12 47     13592 LD	B,A
004C13 F1     13593 POP	AF
004C14 90     13594 SUB	B
004C15 18     13595 JR	STR11
004C16 E0   
004C17 D6     13596 STR14:          SUB	32
004C18 20   
004C19 CD     13597 CALL	POWR10
004C1A F5   
004C1B 4F   
004C1C F5     13598 PUSH	AF
004C1D CD     13599 CALL	FDIV
004C1E 9D   
004C1F 46   
004C20 F1     13600 POP	AF
004C21 47     13601 LD	B,A
004C22 F1     13602 POP	AF
004C23 80     13603 ADD	A,B
004C24 18     13604 JR	STR11
004C25 D1   
004C26 3E     13605 STR15:          LD	A,9
004C27 09   
004C28 CD     13606 CALL	POWR10		;10^9
004C29 F5   
004C2A 4F   
004C2B CD     13607 CALL	FCP0
004C2C 30   
004C2D 4F   
004C2E 79     13608 LD	A,C
004C2F C1     13609 POP	BC
004C30 4F     13610 LD	C,A
004C31 CB     13611 SET	7,H		;IMPLIED 1
004C32 FC   
004C33 DC     13612 CALL	C,X10B		;X10, DEC B
004C34 52   
004C35 4F   
004C36 D1     13613 POP	DE		;RESTORE TEXT POINTER
004C37 CB     13614 RES	7,C
004C38 B9   
004C39 3E     13615 LD	A,0
004C3A 00   
004C3B 17     13616 RLA			;PUT CARRY IN LSB
004C3C 0C     13624 STR2mat:           INC	C
004C3D 08     13625 EX	AF,AF'		;SAVE A
004C3E 78     13626 LD	A,B
004C3F DD     13627 BIT	1,(IX+2)
004C40 CB   
004C41 02   
004C42 4E   
004C43 20     13628 JR	NZ,STR20
004C44 08   
004C45 AF     13629 XOR	A
004C46 DD     13630 CP	(IX+1)
004C47 BE   
004C48 01   
004C49 28     13631 JR	Z,STR21
004C4A 0A   
004C4B 3E     13632 LD	A,-10
004C4C F6   
004C4D DD     13633 STR20:          ADD	A,(IX+1)	;SIG. FIG. COUNT
004C4E 86   
004C4F 01   
004C50 B7     13634 OR	A		;CLEAR CARRY
004C51 FA     13635 JP	M,STR21
004C52 55   
004C53 4C   
004C54 AF     13636 XOR	A
004C55 F5     13637 STR21:          PUSH	AF
004C56 08     13638 EX	AF,AF'		;RESTORE A
004C57 CD     13639 STR22:          CALL	X2		;RL AHLH'L'
004C58 7B   
004C59 4F   
004C5A 8F     13640 ADC	A,A
004C5B FE     13641 CP	10
004C5C 0A   
004C5D 38     13642 JR	C,STR23
004C5E 05   
004C5F D6     13643 SUB	10
004C60 0A   
004C61 D9     13644 EXX
004C62 2C     13645 INC	L		;SET RESULT BIT
004C63 D9     13646 EXX
004C64 0D     13647 STR23:          DEC	C
004C65 20     13648 JR	NZ,STR22	;32 TIMES
004C66 F0   
004C67 4F     13649 LD	C,A		;REMAINDER
004C68 7C     13650 LD	A,H
004C69 E6     13651 AND	3FH		;CLEAR OUT JUNK
004C6A 3F   
004C6B 67     13652 LD	H,A
004C6C F1     13653 POP	AF
004C6D F2     13654 JP	P,STR24
004C6E 7A   
004C6F 4C   
004C70 3C     13655 INC	A
004C71 20     13656 JR	NZ,STR26
004C72 1C   
004C73 3E     13657 LD	A,4
004C74 04   
004C75 B9     13658 CP	C		;ROUND UP?
004C76 3E     13659 LD	A,0
004C77 00   
004C78 18     13660 JR	STR26
004C79 15   
004C7A F5     13661 STR24:          PUSH	AF
004C7B 79     13662 LD	A,C
004C7C CE     13663 ADC	A,'0'		;ADD CARRY
004C7D 30   
004C7E FE     13664 CP	'0'
004C7F 30   
004C80 28     13665 JR	Z,STR25		;SUPPRESS ZERO
004C81 05   
004C82 FE     13666 CP	'9'+1
004C83 3A   
004C84 3F     13667 CCF
004C85 30     13668 JR	NC,STR26
004C86 08   
004C87 E3     13669 STR25:          EX	(SP),HL
004C88 CB     13670 BIT	6,L		;ZERO FLAG
004C89 75   
004C8A E3     13671 EX	(SP),HL
004C8B 20     13672 JR	NZ,STR27
004C8C 05   
004C8D 3E     13673 LD	A,'0'
004C8E 30   
004C8F 3C     13674 STR26:          INC	A		;SET +VE
004C90 3D     13675 DEC	A
004C91 F5     13676 PUSH	AF		;PUT ON STACK + CARRY
004C92 04     13677 STR27:          INC	B
004C93 CD     13678 CALL	TESTmat		;IS HLH'L' ZERO?
004C94 01   
004C95 4F   
004C96 0E     13679 LD	C,32
004C97 20   
004C98 3E     13680 LD	A,0
004C99 00   
004C9A 20     13681 JR	NZ,STR22
004C9B BB   
004C9C F1     13682 POP	AF
004C9D F5     13683 PUSH	AF
004C9E 3E     13684 LD	A,0
004C9F 00   
004CA0 38     13685 JR	C,STR22
004CA1 B5   
004CA2 EB     13693 STR3:           EX	DE,HL		;STRING POINTER
004CA3 0E     13694 LD	C,-1		;FLAG "E"
004CA4 FF   
004CA5 16     13695 LD	D,1
004CA6 01   
004CA7 DD     13696 LD	E,(IX+1)	;f2
004CA8 5E   
004CA9 01   
004CAA DD     13697 BIT	0,(IX+2)
004CAB CB   
004CAC 02   
004CAD 46   
004CAE 20     13698 JR	NZ,STR34	;E MODE
004CAF 32   
004CB0 DD     13699 BIT	1,(IX+2)
004CB1 CB   
004CB2 02   
004CB3 4E   
004CB4 28     13700 JR	Z,STR31
004CB5 11   
004CB6 78     13701 LD	A,B		;F MODE
004CB7 B7     13702 OR	A
004CB8 28     13703 JR	Z,STR30
004CB9 04   
004CBA FA     13704 JP	M,STR30
004CBB BE   
004CBC 4C   
004CBD 50     13705 LD	D,B
004CBE 7A     13706 STR30:          LD	A,D
004CBF DD     13707 ADD	A,(IX+1)
004CC0 86   
004CC1 01   
004CC2 5F     13708 LD	E,A
004CC3 FE     13709 CP	11
004CC4 0B   
004CC5 38     13710 JR	C,STR32
004CC6 17   
004CC7 78     13711 STR31:          LD	A,B		;G MODE
004CC8 11     13712 LD	DE,101H
004CC9 01   
004CCA 01   
004CCB B7     13713 OR	A
004CCC FA     13714 JP	M,STR34
004CCD E2   
004CCE 4C   
004CCF 28     13715 JR	Z,STR32
004CD0 0D   
004CD1 DD     13716 LD	A,(IX+1)
004CD2 7E   
004CD3 01   
004CD4 B7     13717 OR	A
004CD5 20     13718 JR	NZ,STR3A
004CD6 02   
004CD7 3E     13719 LD	A,10
004CD8 0A   
004CD9 B8     13720 STR3A:          CP	B
004CDA 38     13721 JR	C,STR34
004CDB 06   
004CDC 50     13722 LD	D,B
004CDD 58     13723 LD	E,B
004CDE 78     13724 STR32:          LD	A,B
004CDF C6     13725 ADD	A,129
004CE0 81   
004CE1 4F     13726 LD	C,A
004CE2 CB     13727 STR34:          SET	7,D
004CE3 FA   
004CE4 1D     13728 DEC	E
004CE5 7A     13729 STR35:          LD	A,D
004CE6 B9     13730 CP	C
004CE7 30     13731 JR	NC,STR33
004CE8 0C   
004CE9 F1     13732 STR36:          POP	AF
004CEA 28     13733 JR	Z,STR37
004CEB 03   
004CEC F2     13734 JP	P,STR38
004CED F7   
004CEE 4C   
004CEF F5     13735 STR37:          PUSH	AF
004CF0 1C     13736 INC	E
004CF1 1D     13737 DEC	E
004CF2 FA     13738 JP	M,STR4
004CF3 06   
004CF4 4D   
004CF5 3E     13739 STR33:          LD	A,'0'
004CF6 30   
004CF7 15     13740 STR38:          DEC	D
004CF8 E2     13741 JP	PO,STR39
004CF9 FE   
004CFA 4C   
004CFB 36     13742 LD	(HL),'.'
004CFC 2E   
004CFD 23     13743 INC	HL
004CFE 77     13744 STR39:          LD	(HL),A
004CFF 23     13745 INC	HL
004D00 1D     13746 DEC	E
004D01 F2     13747 JP	P,STR35
004D02 E5   
004D03 4C   
004D04 18     13748 JR	STR36
004D05 E3   
004D06 F1     13750 STR4:           POP	AF
004D07 0C     13751 STR40:          INC	C
004D08 4D     13752 LD	C,L
004D09 20     13753 JR	NZ,STR44
004D0A 27   
004D0B 36     13754 LD	(HL),'E'	;EXPONENT
004D0C 45   
004D0D 23     13755 INC	HL
004D0E 78     13756 LD	A,B
004D0F 3D     13757 DEC	A
004D10 F2     13758 JP	P,STR41
004D11 18   
004D12 4D   
004D13 36     13759 LD	(HL),'-'
004D14 2D   
004D15 23     13760 INC	HL
004D16 ED     13761 NEG
004D17 44   
004D18 36     13762 STR41:          LD	(HL),'0'
004D19 30   
004D1A 28     13763 JR	Z,STR47
004D1B 15   
004D1C FE     13764 CP	10
004D1D 0A   
004D1E 47     13765 LD	B,A
004D1F 3E     13766 LD	A,':'
004D20 3A   
004D21 38     13767 JR	C,STR42
004D22 03   
004D23 23     13768 INC	HL
004D24 36     13769 LD	(HL),'0'
004D25 30   
004D26 34     13770 STR42:          INC	(HL)
004D27 BE     13771 CP	(HL)
004D28 20     13772 JR	NZ,STR43
004D29 05   
004D2A 36     13773 LD	(HL),'0'
004D2B 30   
004D2C 2B     13774 DEC	HL
004D2D 34     13775 INC	(HL)
004D2E 23     13776 INC	HL
004D2F 10     13777 STR43:          DJNZ	STR42
004D30 F5   
004D31 23     13778 STR47:          INC	HL
004D32 EB     13779 STR44:          EX	DE,HL
004D33 C9     13780 RET
004D34 CD     13790 CON:            CALL	ZEROmat		;INITIALISE TO ZERO
004D35 21   
004D36 4F   
004D37 0E     13791 LD	C,0		;TRUNCATION COUNTER
004D38 00   
004D39 CD     13792 CALL	NUMBERmat		;GET INTEGER PART
004D3A B9   
004D3B 4D   
004D3C FE     13793 CP	'.'
004D3D 2E   
004D3E 06     13794 LD	B,0		;DECL. PLACE COUNTER
004D3F 00   
004D40 CC     13795 CALL	Z,NUMBIX	;GET FRACTION PART
004D41 B7   
004D42 4D   
004D43 FE     13796 CP	'E'
004D44 45   
004D45 3E     13797 LD	A,0		;INITIALISE EXPONENT
004D46 00   
004D47 CC     13798 CALL	Z,GETEXP	;GET EXPONENT
004D48 88   
004D49 4D   
004D4A CB     13799 BIT	7,H
004D4B 7C   
004D4C 20     13800 JR	NZ,CON0		;INTEGER OVERFLOW
004D4D 08   
004D4E B7     13801 OR	A
004D4F 20     13802 JR	NZ,CON0		;EXPONENT NON-ZERO
004D50 05   
004D51 B8     13803 CP	B
004D52 20     13804 JR	NZ,CON0		;DECIMAL POINT
004D53 02   
004D54 B9     13805 CP	C
004D55 C8     13806 RET	Z		;INTEGER
004D56 90     13807 CON0:           SUB	B
004D57 81     13808 ADD	A,C
004D58 0E     13809 LD	C,159
004D59 9F   
004D5A CD     13810 CALL	FLOAT
004D5B 98   
004D5C 4E   
004D5D CB     13811 RES	7,H		;DITCH IMPLIED 1
004D5E BC   
004D5F B7     13812 OR	A
004D60 C8     13813 RET	Z		;DONE
004D61 FA     13814 JP	M,CON2		;NEGATIVE EXPONENT
004D62 6C   
004D63 4D   
004D64 CD     13815 CALL	POWR10
004D65 F5   
004D66 4F   
004D67 CD     13816 CALL	FMUL		;SCALE
004D68 0D   
004D69 47   
004D6A AF     13817 XOR	A
004D6B C9     13818 RET
004D6C FE     13819 CON2:           CP	-38
004D6D DA   
004D6E 38     13820 JR	C,CON3		;CAN'T SCALE IN ONE GO
004D6F 0A   
004D70 ED     13821 NEG
004D71 44   
004D72 CD     13822 CALL	POWR10
004D73 F5   
004D74 4F   
004D75 CD     13823 CALL	FDIV		;SCALE
004D76 9D   
004D77 46   
004D78 AF     13824 XOR	A
004D79 C9     13825 RET
004D7A F5     13826 CON3:           PUSH	AF
004D7B 3E     13827 LD	A,38
004D7C 26   
004D7D CD     13828 CALL	POWR10
004D7E F5   
004D7F 4F   
004D80 CD     13829 CALL	FDIV
004D81 9D   
004D82 46   
004D83 F1     13830 POP	AF
004D84 C6     13831 ADD	A,38
004D85 26   
004D86 18     13832 JR	CON2
004D87 E4   
004D88 C5     13842 GETEXP:         PUSH	BC		;SAVE REGISTERS
004D89 47     13843 LD	B,A		;INITIAL VALUE
004D8A 0E     13844 LD	C,2		;2 DIGITS MAX
004D8B 02   
004D8C DD     13845 INC	IX		;BUMP PAST 'E'
004D8D 23   
004D8E CD     13846 CALL	SIGNQ
004D8F E3   
004D90 50   
004D91 08     13847 EX	AF,AF'		;SAVE EXPONENT SIGN
004D92 CD     13848 GETEX1:         CALL	DIGITQ
004D93 D9   
004D94 50   
004D95 38     13849 JR	C,GETEX2
004D96 17   
004D97 78     13850 LD	A,B		;B=B*10
004D98 87     13851 ADD	A,A
004D99 87     13852 ADD	A,A
004D9A 80     13853 ADD	A,B
004D9B 87     13854 ADD	A,A
004D9C 47     13855 LD	B,A
004D9D DD     13856 LD	A,(IX)		;GET BACK DIGIT
004D9E 7E   
004D9F 00   
004DA0 DD     13857 INC	IX
004DA1 23   
004DA2 E6     13858 AND	0FH		;MASK UNWANTED BITS
004DA3 0F   
004DA4 80     13859 ADD	A,B		;ADD IN DIGIT
004DA5 47     13860 LD	B,A
004DA6 0D     13861 DEC	C
004DA7 F2     13862 JP	P,GETEX1
004DA8 92   
004DA9 4D   
004DAA 06     13863 LD	B,100		;FORCE OVERFLOW
004DAB 64   
004DAC 18     13864 JR	GETEX1
004DAD E4   
004DAE 08     13865 GETEX2:         EX	AF,AF'		;RESTORE SIGN
004DAF FE     13866 CP	'-'
004DB0 2D   
004DB1 78     13867 LD	A,B
004DB2 C1     13868 POP	BC		;RESTORE
004DB3 C0     13869 RET	NZ
004DB4 ED     13870 NEG			;NEGATE EXPONENT
004DB5 44   
004DB6 C9     13871 RET
004DB7 DD     13884 NUMBIX:         INC	IX
004DB8 23   
004DB9 CD     13885 NUMBERmat:         CALL	DIGITQ
004DBA D9   
004DBB 50   
004DBC D8     13886 RET	C
004DBD 04     13887 INC	B		;INCREMENT DIGIT COUNT
004DBE DD     13888 INC	IX
004DBF 23   
004DC0 CD     13889 CALL	X10		;*10 & COPY OLD VALUE
004DC1 6C   
004DC2 4F   
004DC3 38     13890 JR	C,NUMB1		;OVERFLOW
004DC4 13   
004DC5 0D     13891 DEC	C		;SEE IF TRUNCATED
004DC6 0C     13892 INC	C
004DC7 20     13893 JR	NZ,NUMB1	;IMPORTANT!
004DC8 0F   
004DC9 E6     13894 AND	0FH
004DCA 0F   
004DCB D9     13895 EXX
004DCC 06     13896 LD	B,0
004DCD 00   
004DCE 4F     13897 LD	C,A
004DCF 09     13898 ADD	HL,BC		;ADD IN DIGIT
004DD0 D9     13899 EXX
004DD1 30     13900 JR	NC,NUMBERmat
004DD2 E6   
004DD3 23     13901 INC	HL		;CARRY
004DD4 7C     13902 LD	A,H
004DD5 B5     13903 OR	L
004DD6 20     13904 JR	NZ,NUMBERmat
004DD7 E1   
004DD8 0C     13905 NUMB1:          INC	C		;TRUNCATION COUNTER
004DD9 CD     13906 CALL	SWAP1		;RESTORE PREVIOUS VALUE
004DDA DF   
004DDB 4E   
004DDC 18     13907 JR	NUMBERmat
004DDD DB   
004DDE 08     13917 FIX:            EX	AF,AF'
004DDF AF     13918 XOR	A
004DE0 08     13919 EX	AF,AF'
004DE1 CB     13920 SET	7,H		;IMPLIED 1
004DE2 FC   
004DE3 CD     13921 FIX1:           CALL	DIV2
004DE4 E4   
004DE5 4E   
004DE6 B9     13922 CP	C
004DE7 C8     13923 RET	Z
004DE8 D2     13924 JP	NC,FIX1
004DE9 E3   
004DEA 4D   
004DEB C3     13925 JP	OFLOW
004DEC F2   
004DED 4E   
004DEE CD     13935 FIX2:           CALL	SWAP
004DEF DC   
004DF0 4E   
004DF1 CD     13936 CALL	SFIXmat
004DF2 F7   
004DF3 4D   
004DF4 CD     13937 CALL	SWAP
004DF5 DC   
004DF6 4E   
004DF7 0D     13938 SFIXmat:           DEC	C
004DF8 0C     13939 INC	C
004DF9 C8     13940 RET	Z		;INTEGER/ZERO
004DFA CB     13941 BIT	7,H		;SIGN
004DFB 7C   
004DFC F5     13942 PUSH	AF
004DFD 3E     13943 LD	A,159
004DFE 9F   
004DFF CD     13944 CALL	FIX
004E00 DE   
004E01 4D   
004E02 F1     13945 POP	AF
004E03 0E     13946 LD	C,0
004E04 00   
004E05 C8     13947 RET	Z
004E06 B7     13948 NEGATE:         OR	A		;CLEAR CARRY
004E07 D9     13949 EXX
004E08 D5     13950 NEG0:           PUSH	DE
004E09 EB     13951 EX	DE,HL
004E0A 21     13952 LD	HL,0
004E0B 00   
004E0C 00   
004E0D ED     13953 SBC	HL,DE
004E0E 52   
004E0F D1     13954 POP	DE
004E10 D9     13955 EXX
004E11 D5     13956 PUSH	DE
004E12 EB     13957 EX	DE,HL
004E13 21     13958 LD	HL,0
004E14 00   
004E15 00   
004E16 ED     13959 SBC	HL,DE
004E17 52   
004E18 D1     13960 POP	DE
004E19 C9     13961 RET
004E1A D9     13967 NEG:            EXX
004E1B 2F     13968 CPL
004E1C E5     13969 PUSH	HL
004E1D B7     13970 OR	A		;CLEAR CARRY
004E1E ED     13971 SBC	HL,HL
004E1F 62   
004E20 ED     13972 SBC	HL,BC
004E21 42   
004E22 44     13973 LD	B,H
004E23 4D     13974 LD	C,L
004E24 E1     13975 POP	HL
004E25 18     13976 JR	NEG0
004E26 E1   
004E27 3E     13989 SCALE:          LD	A,150
004E28 96   
004E29 B9     13990 CP	C
004E2A 3E     13991 LD	A,ACLOST
004E2B 17   
004E2C DA     13992 JP	C,ERROR_mat		;"Accuracy lost"
004E2D 26   
004E2E 45   
004E2F CD     13993 CALL	PIBY4
004E30 0E   
004E31 4A   
004E32 D9     13994 EXX
004E33 01     13995 LD	BC,2169H	;3.141592653589793238
004E34 69   
004E35 21   
004E36 D9     13996 EXX
004E37 CB     13997 MOD48:          SET	7,D		;IMPLIED 1
004E38 FA   
004E39 CB     13998 SET	7,H
004E3A FC   
004E3B 79     13999 LD	A,C
004E3C 0E     14000 LD	C,0		;INIT QUOTIENT
004E3D 00   
004E3E DD     14001 LD	IX,0
004E3F 21   
004E40 00   
004E41 00   
004E42 DD     14002 PUSH	IX		;PUT ZERO ON STACK
004E43 E5   
004E44 B8     14003 CP	B
004E45 38     14004 JR	C,MOD485	;DIVIDEND<DIVISOR
004E46 3A   
004E47 D9     14005 MOD481:         EXX			;CARRY=0 HERE
004E48 E3     14006 EX	(SP),HL
004E49 ED     14007 SBC	HL,BC
004E4A 42   
004E4B E3     14008 EX	(SP),HL
004E4C ED     14009 SBC	HL,DE
004E4D 52   
004E4E D9     14010 EXX
004E4F ED     14011 SBC	HL,DE
004E50 52   
004E51 30     14012 JR	NC,MOD482	;DIVIDEND>=DIVISOR
004E52 09   
004E53 D9     14013 EXX
004E54 E3     14014 EX	(SP),HL
004E55 09     14015 ADD	HL,BC
004E56 E3     14016 EX	(SP),HL
004E57 ED     14017 ADC	HL,DE
004E58 5A   
004E59 D9     14018 EXX
004E5A ED     14019 ADC	HL,DE
004E5B 5A   
004E5C 3F     14020 MOD482:         CCF
004E5D CB     14021 RL	C		;QUOTIENT
004E5E 11   
004E5F 30     14022 JR	NC,MOD483
004E60 02   
004E61 CB     14023 SET	7,C		;STICKY BIT
004E62 F9   
004E63 3D     14024 MOD483:         DEC	A
004E64 B8     14025 CP	B
004E65 38     14026 JR	C,MOD484	;DIVIDEND<DIVISOR
004E66 19   
004E67 E3     14027 EX	(SP),HL
004E68 29     14028 ADD	HL,HL		;DIVIDEND * 2
004E69 E3     14029 EX	(SP),HL
004E6A D9     14030 EXX
004E6B ED     14031 ADC	HL,HL
004E6C 6A   
004E6D D9     14032 EXX
004E6E ED     14033 ADC	HL,HL
004E6F 6A   
004E70 30     14034 JR	NC,MOD481	;AGAIN
004E71 D5   
004E72 B7     14035 OR	A
004E73 D9     14036 EXX
004E74 E3     14037 EX	(SP),HL
004E75 ED     14038 SBC	HL,BC		;OVERFLOW, SO SUBTRACT
004E76 42   
004E77 E3     14039 EX	(SP),HL
004E78 ED     14040 SBC	HL,DE
004E79 52   
004E7A D9     14041 EXX
004E7B ED     14042 SBC	HL,DE
004E7C 52   
004E7D B7     14043 OR	A
004E7E 18     14044 JR	MOD482
004E7F DC   
004E80 3C     14046 MOD484:         INC	A
004E81 59     14047 MOD485:         LD	E,C		;QUOTIENT
004E82 4F     14048 LD	C,A		;REMAINDER EXPONENT
004E83 D9     14049 EXX
004E84 C1     14050 POP	BC
004E85 D9     14051 EXX
004E86 CB     14052 FLO48:          BIT	7,H
004E87 7C   
004E88 C0     14053 RET	NZ
004E89 D9     14054 EXX
004E8A CB     14055 SLA	C
004E8B 21   
004E8C CB     14056 RL	B
004E8D 10   
004E8E ED     14057 ADC	HL,HL
004E8F 6A   
004E90 D9     14058 EXX
004E91 ED     14059 ADC	HL,HL
004E92 6A   
004E93 0D     14060 DEC	C
004E94 C2     14061 JP	NZ,FLO48
004E95 86   
004E96 4E   
004E97 C9     14062 RET
004E98 CB     14068 FLOAT:          BIT	7,H
004E99 7C   
004E9A C0     14069 RET	NZ
004E9B D9     14070 EXX			;SAME AS "X2"
004E9C 29     14071 ADD	HL,HL		;TIME-CRITICAL
004E9D D9     14072 EXX			;REGION
004E9E ED     14073 ADC	HL,HL		;(BENCHMARKS)
004E9F 6A   
004EA0 0D     14074 DEC	C
004EA1 C2     14075 JP	NZ,FLOAT
004EA2 98   
004EA3 4E   
004EA4 C9     14076 RET
004EA5 08     14083 FLOATA:         EX	AF,AF'
004EA6 C6     14085 ADD	A,RTABLE-DTABLE/2
004EA7 2E   
004EA8 08     14086 EX	AF,AF'
004EA9 CD     14087 FLOAT2:         CALL	SWAP
004EAA DC   
004EAB 4E   
004EAC CD     14088 CALL	SFLOAT
004EAD B2   
004EAE 4E   
004EAF CD     14089 CALL	SWAP
004EB0 DC   
004EB1 4E   
004EB2 0D     14090 SFLOAT:         DEC	C
004EB3 0C     14091 INC	C
004EB4 C0     14092 RET	NZ		;ALREADY FLOATING-POINT
004EB5 CD     14093 CALL	TESTmat
004EB6 01   
004EB7 4F   
004EB8 C8     14094 RET	Z		;ZERO
004EB9 7C     14095 LD	A,H
004EBA B7     14096 OR	A
004EBB FC     14097 CALL	M,NEGATE
004EBC 06   
004EBD 4E   
004EBE 0E     14098 LD	C,159
004EBF 9F   
004EC0 CD     14099 CALL	FLOAT
004EC1 98   
004EC2 4E   
004EC3 B7     14100 OR	A
004EC4 F8     14101 RET	M		;NEGATIVE
004EC5 CB     14102 RES	7,H
004EC6 BC   
004EC7 C9     14103 RET
004EC8 D9     14109 ADD1:           EXX
004EC9 01     14110 LD	BC,1
004ECA 01   
004ECB 00   
004ECC 09     14111 ADD	HL,BC
004ECD D9     14112 EXX
004ECE D0     14113 RET	NC
004ECF C5     14114 PUSH	BC
004ED0 01     14115 LD	BC,1
004ED1 01   
004ED2 00   
004ED3 09     14116 ADD	HL,BC
004ED4 C1     14117 POP	BC
004ED5 C9     14118 RET
004ED6 B7     14125 ODD:            OR	A		;CLEAR CARRY
004ED7 D9     14126 EXX
004ED8 CB     14127 SET	0,L		;MAKE ODD
004ED9 C5   
004EDA D9     14128 EXX
004EDB C9     14129 RET
004EDC 79     14137 SWAP:           LD	A,C
004EDD 48     14138 LD	C,B
004EDE 47     14139 LD	B,A
004EDF EB     14140 SWAP1:          EX	DE,HL
004EE0 D9     14141 EXX
004EE1 EB     14142 EX	DE,HL
004EE2 D9     14143 EXX
004EE3 C9     14144 RET
004EE4 CD     14150 DIV2:           CALL	D2
004EE5 82   
004EE6 4F   
004EE7 D9     14151 EXX
004EE8 CB     14152 RR	B
004EE9 18   
004EEA CB     14153 RR	C
004EEB 19   
004EEC 08     14154 EX	AF,AF'
004EED B0     14155 OR	B
004EEE 08     14156 EX	AF,AF'
004EEF D9     14157 EXX
004EF0 0C     14158 INCC:           INC	C
004EF1 C0     14159 RET	NZ
004EF2 3E     14160 OFLOW:          LD	A,TOOBIG
004EF3 14   
004EF4 C3     14161 JP	ERROR_mat		;"Too big"
004EF5 26   
004EF6 45   
004EF7 CD     14166 FTEST:          CALL	TESTmat
004EF8 01   
004EF9 4F   
004EFA C8     14167 RET	Z
004EFB 7C     14168 LD	A,H
004EFC E6     14169 AND	10000000B
004EFD 80   
004EFE F6     14170 OR	01000000B
004EFF 40   
004F00 C9     14171 RET
004F01 7C     14177 TESTmat:           LD	A,H
004F02 B5     14178 OR	L
004F03 D9     14179 EXX
004F04 B4     14180 OR	H
004F05 B5     14181 OR	L
004F06 D9     14182 EXX
004F07 C9     14183 RET
004F08 78     14188 FCOMP:          LD	A,B
004F09 B1     14189 OR	C		;Both integer?
004F0A 20     14190 JR	NZ,FCOMP1
004F0B 0A   
004F0C CD     14191 CALL	ICP
004F0D 1E   
004F0E 4F   
004F0F 3E     14192 FCOMP0:         LD	A,0
004F10 00   
004F11 C8     14193 RET	Z		;Equal
004F12 3E     14194 LD	A,80H
004F13 80   
004F14 1F     14195 RRA
004F15 C9     14196 RET
004F16 CD     14198 FCOMP1:         CALL	FLOAT2		;Float both
004F17 A9   
004F18 4E   
004F19 CD     14199 CALL	FCP
004F1A 2B   
004F1B 4F   
004F1C 18     14200 JR	FCOMP0
004F1D F1   
004F1E CD     14210 ICP:            CALL	ICP1
004F1F 4A   
004F20 4F   
004F21 3E     14211 ZEROmat:           LD	A,0
004F22 00   
004F23 D9     14212 EXX
004F24 67     14213 LD	H,A
004F25 6F     14214 LD	L,A
004F26 D9     14215 EXX
004F27 67     14216 LD	H,A
004F28 6F     14217 LD	L,A
004F29 4F     14218 LD	C,A
004F2A C9     14219 RET
004F2B CD     14221 FCP:            CALL	FCP1
004F2C 3D   
004F2D 4F   
004F2E 18     14222 JR	ZEROmat		;PRESET FALSE
004F2F F1   
004F30 79     14224 FCP0:           LD	A,C
004F31 B8     14225 CP	B		;COMPARE EXPONENTS
004F32 C0     14226 RET	NZ
004F33 ED     14227 ICP0:           SBC	HL,DE		;COMP MANTISSA MSB
004F34 52   
004F35 19     14228 ADD	HL,DE
004F36 C0     14229 RET	NZ
004F37 D9     14230 EXX
004F38 ED     14231 SBC	HL,DE		;COMP MANTISSA LSB
004F39 52   
004F3A 19     14232 ADD	HL,DE
004F3B D9     14233 EXX
004F3C C9     14234 RET
004F3D 7C     14236 FCP1:           LD	A,H
004F3E AA     14237 XOR	D
004F3F 7C     14238 LD	A,H
004F40 17     14239 RLA
004F41 F8     14240 RET	M
004F42 30     14241 JR	NC,FCP0
004F43 EC   
004F44 CD     14242 CALL	FCP0
004F45 30   
004F46 4F   
004F47 C8     14243 RET	Z		;** V0.1 BUG FIX
004F48 3F     14244 CCF
004F49 C9     14245 RET
004F4A 7C     14247 ICP1:           LD	A,H
004F4B AA     14248 XOR	D
004F4C F2     14249 JP	P,ICP0
004F4D 33   
004F4E 4F   
004F4F 7C     14250 LD	A,H
004F50 17     14251 RLA
004F51 C9     14252 RET
004F52 05     14258 X10B:           DEC	B
004F53 0C     14259 INC	C
004F54 CD     14260 X5:             CALL	COPY0
004F55 8E   
004F56 4F   
004F57 CD     14261 CALL	D2C
004F58 81   
004F59 4F   
004F5A CD     14262 CALL	D2C
004F5B 81   
004F5C 4F   
004F5D 08     14263 EX	AF,AF'		;SAVE CARRY
004F5E D9     14264 ADD:            EXX
004F5F 19     14265 ADD	HL,DE
004F60 D9     14266 EXX
004F61 ED     14267 ADC	HL,DE
004F62 5A   
004F63 C9     14268 RET
004F64 D9     14274 SUB:            EXX
004F65 B7     14275 OR	A
004F66 ED     14276 SBC	HL,DE
004F67 52   
004F68 D9     14277 EXX
004F69 ED     14278 SBC	HL,DE
004F6A 52   
004F6B C9     14279 RET
004F6C CD     14292 X10:            CALL	COPY0		;DED'E'=HLH'L'
004F6D 8E   
004F6E 4F   
004F6F CD     14293 CALL	X2
004F70 7B   
004F71 4F   
004F72 D8     14294 RET	C		;TOO BIG
004F73 CD     14295 CALL	X2
004F74 7B   
004F75 4F   
004F76 D8     14296 RET	C
004F77 CD     14297 CALL	ADD
004F78 5E   
004F79 4F   
004F7A D8     14298 RET	C
004F7B D9     14299 X2:             EXX
004F7C 29     14300 ADD	HL,HL
004F7D D9     14301 EXX
004F7E ED     14302 ADC	HL,HL
004F7F 6A   
004F80 C9     14303 RET
004F81 0C     14309 D2C:            INC	C
004F82 CB     14310 D2:             SRL	H
004F83 3C   
004F84 CB     14311 RR	L
004F85 1D   
004F86 D9     14312 EXX
004F87 CB     14313 RR	H
004F88 1C   
004F89 CB     14314 RR	L
004F8A 1D   
004F8B D9     14315 EXX
004F8C C9     14316 RET
004F8D 41     14321 COPY:           LD	B,C
004F8E 54     14322 COPY0:          LD	D,H
004F8F 5D     14323 LD	E,L
004F90 D9     14324 EXX
004F91 54     14325 LD	D,H
004F92 5D     14326 LD	E,L
004F93 D9     14327 EXX
004F94 C9     14328 RET
004F95 CD     14334 SQUARE:         CALL	COPY
004F96 8D   
004F97 4F   
004F98 CD     14335 CALL	FMUL
004F99 0D   
004F9A 47   
004F9B DD     14336 PUSH5:          POP	IX		;RETURN ADDRESS
004F9C E1   
004F9D C5     14337 PUSH	BC
004F9E E5     14338 PUSH	HL
004F9F D9     14339 EXX
004FA0 E5     14340 PUSH	HL
004FA1 D9     14341 EXX
004FA2 DD     14342 JP	(IX)		;"RETURN"
004FA3 E9   
004FA4 DD     14347 POP5:           POP	IX		;RETURN ADDRESS
004FA5 E1   
004FA6 D9     14348 EXX
004FA7 D1     14349 POP	DE
004FA8 D9     14350 EXX
004FA9 D1     14351 POP	DE
004FAA 79     14352 LD	A,C
004FAB C1     14353 POP	BC
004FAC 41     14354 LD	B,C
004FAD 4F     14355 LD	C,A
004FAE DD     14356 JP	(IX)		;"RETURN"
004FAF E9   
004FB0 CD     14363 RATIO:          CALL	PUSH5		;SAVE X
004FB1 9B   
004FB2 4F   
004FB3 CD     14364 CALL	DONE
004FB4 03   
004FB5 4A   
004FB6 CD     14365 CALL	FADD
004FB7 45   
004FB8 46   
004FB9 CD     14366 CALL	POP5		;RESTORE X
004FBA A4   
004FBB 4F   
004FBC CD     14367 CALL	PUSH5		;SAVE X+1
004FBD 9B   
004FBE 4F   
004FBF CD     14368 CALL	SWAP
004FC0 DC   
004FC1 4E   
004FC2 CD     14369 CALL	DONE
004FC3 03   
004FC4 4A   
004FC5 CD     14370 CALL	FSUB
004FC6 2F   
004FC7 46   
004FC8 CD     14371 CALL	POP5		;RESTORE X+1
004FC9 A4   
004FCA 4F   
004FCB C3     14372 JP	FDIV
004FCC 9D   
004FCD 46   
004FCE DD     14383 POLY:           LD	IX,2
004FCF 21   
004FD0 02   
004FD1 00   
004FD2 DD     14384 ADD	IX,SP
004FD3 39   
004FD4 DD     14385 EX	(SP),IX
004FD5 E3   
004FD6 CD     14386 CALL	DLOAD5		;FIRST COEFFICIENT
004FD7 F1   
004FD8 19   
004FD9 CD     14387 POLY1:          CALL	FMUL
004FDA 0D   
004FDB 47   
004FDC 11     14388 LD	DE,5
004FDD 05   
004FDE 00   
004FDF DD     14389 ADD	IX,DE
004FE0 19   
004FE1 CD     14390 CALL	DLOAD5		;NEXT COEFFICIENT
004FE2 F1   
004FE3 19   
004FE4 DD     14391 EX	(SP),IX
004FE5 E3   
004FE6 04     14392 INC	B
004FE7 05     14393 DEC	B		;TEST
004FE8 FA     14394 JP	M,FADD
004FE9 45   
004FEA 46   
004FEB CD     14395 CALL	FADD
004FEC 45   
004FED 46   
004FEE CD     14396 CALL	DLOAD5		;X
004FEF F1   
004FF0 19   
004FF1 DD     14397 EX	(SP),IX
004FF2 E3   
004FF3 18     14398 JR	POLY1
004FF4 E4   
004FF5 3C     14407 POWR10:         INC	A
004FF6 08     14408 EX	AF,AF'
004FF7 E5     14409 PUSH	HL
004FF8 D9     14410 EXX
004FF9 E5     14411 PUSH	HL
004FFA D9     14412 EXX
004FFB CD     14413 CALL	DONE
004FFC 03   
004FFD 4A   
004FFE CD     14414 CALL	SWAP
004FFF DC   
005000 4E   
005001 AF     14415 XOR	A
005002 08     14416 POWR11:         EX	AF,AF'
005003 3D     14417 DEC	A
005004 28     14418 JR	Z,POWR14	;EXITmat TYPE 1
005005 20   
005006 F2     14419 JP	P,POWR13
005007 0D   
005008 50   
005009 B9     14420 CP	C
00500A 38     14421 JR	C,POWR14	;EXITmat TYPE 2
00500B 1A   
00500C 3C     14422 INC	A
00500D 08     14423 POWR13:         EX	AF,AF'
00500E 3C     14424 INC	A
00500F CB     14425 SET	7,H
005010 FC   
005011 CD     14426 CALL	X5
005012 54   
005013 4F   
005014 30     14427 JR	NC,POWR12
005015 05   
005016 08     14428 EX	AF,AF'
005017 CD     14429 CALL	D2C
005018 81   
005019 4F   
00501A 08     14430 EX	AF,AF'
00501B 08     14431 POWR12:         EX	AF,AF'
00501C DC     14432 CALL	C,ADD1		;ROUND UP
00501D C8   
00501E 4E   
00501F 0C     14433 INC	C
005020 FA     14434 JP	M,POWR11
005021 02   
005022 50   
005023 C3     14435 JP	OFLOW
005024 F2   
005025 4E   
005026 CD     14436 POWR14:         CALL	SWAP
005027 DC   
005028 4E   
005029 CB     14437 RES	7,D
00502A BA   
00502B D9     14438 EXX
00502C E1     14439 POP	HL
00502D D9     14440 EXX
00502E E1     14441 POP	HL
00502F 08     14442 EX	AF,AF'
005030 C9     14443 RET
005031 B7     14451 DIVA:           OR	A		;CLEAR CARRY
005032 ED     14452 DIV0:           SBC	HL,BC		;DIVIDEND-DIVISOR
005033 42   
005034 D9     14453 EXX
005035 ED     14454 SBC	HL,BC
005036 42   
005037 D9     14455 EXX
005038 30     14456 JR	NC,DIV1
005039 05   
00503A 09     14457 ADD	HL,BC		;DIVIDEND+DIVISOR
00503B D9     14458 EXX
00503C ED     14459 ADC	HL,BC
00503D 4A   
00503E D9     14460 EXX
00503F 3F     14461 DIV1:           CCF
005040 CB     14462 DIVC:           RL	E		;SHIFT RESULT INTO DE
005041 13   
005042 CB     14463 RL	D
005043 12   
005044 D9     14464 EXX
005045 CB     14465 RL	E
005046 13   
005047 CB     14466 RL	D
005048 12   
005049 D9     14467 EXX
00504A 3C     14468 INC	A
00504B F0     14469 RET	P
00504C ED     14470 DIVB:           ADC	HL,HL		;DIVIDEND*2
00504D 6A   
00504E D9     14471 EXX
00504F ED     14472 ADC	HL,HL
005050 6A   
005051 D9     14473 EXX
005052 30     14474 JR	NC,DIV0
005053 DE   
005054 B7     14475 OR	A
005055 ED     14476 SBC	HL,BC		;DIVIDEND-DIVISOR
005056 42   
005057 D9     14477 EXX
005058 ED     14478 SBC	HL,BC
005059 42   
00505A D9     14479 EXX
00505B 37     14480 SCF
00505C C3     14481 JP	DIVC
00505D 40   
00505E 50   
00505F B7     14489 MULA:           OR	A		;CLEAR CARRY
005060 D9     14490 MUL0:           EXX
005061 CB     14491 RR	D		;MULTIPLIER/2
005062 1A   
005063 CB     14492 RR	E
005064 1B   
005065 D9     14493 EXX
005066 CB     14494 RR	D
005067 1A   
005068 CB     14495 RR	E
005069 1B   
00506A 30     14496 JR	NC,MUL1
00506B 05   
00506C 09     14497 ADD	HL,BC		;ADD IN MULTIPLICAND
00506D D9     14498 EXX
00506E ED     14499 ADC	HL,BC
00506F 4A   
005070 D9     14500 EXX
005071 3C     14501 MUL1:           INC	A
005072 F0     14502 RET	P
005073 D9     14503 MULB:           EXX
005074 CB     14504 RR	H		;PRODUCT/2
005075 1C   
005076 CB     14505 RR	L
005077 1D   
005078 D9     14506 EXX
005079 CB     14507 RR	H
00507A 1C   
00507B CB     14508 RR	L
00507C 1D   
00507D C3     14509 JP	MUL0
00507E 60   
00507F 50   
005080 ED     14517 SQR1:           SBC	HL,BC
005081 42   
005082 D9     14518 EXX
005083 ED     14519 SBC	HL,BC
005084 42   
005085 D9     14520 EXX
005086 0C     14521 INC	C
005087 30     14522 JR	NC,SQR2
005088 07   
005089 0D     14523 DEC	C
00508A 09     14524 ADD	HL,BC
00508B D9     14525 EXX
00508C ED     14526 ADC	HL,BC
00508D 4A   
00508E D9     14527 EXX
00508F 0D     14528 DEC	C
005090 3C     14529 SQR2:           INC	A
005091 F0     14530 RET	P
005092 CB     14531 SQRA:           SLA	C
005093 21   
005094 CB     14532 RL	B
005095 10   
005096 0C     14533 INC	C
005097 D9     14534 EXX
005098 CB     14535 RL	C
005099 11   
00509A CB     14536 RL	B
00509B 10   
00509C CD     14537 CALL	SLA8
00509D C8   
00509E 50   
00509F CD     14538 CALL	SLA8
0050A0 C8   
0050A1 50   
0050A2 D9     14539 EXX
0050A3 D2     14540 JP	NC,SQR1
0050A4 80   
0050A5 50   
0050A6 B7     14541 SQR3:           OR	A
0050A7 ED     14542 SBC	HL,BC
0050A8 42   
0050A9 D9     14543 EXX
0050AA ED     14544 SBC	HL,BC
0050AB 42   
0050AC D9     14545 EXX
0050AD 0C     14546 INC	C
0050AE C3     14547 JP	SQR2
0050AF 90   
0050B0 50   
0050B1 29     14549 SQRB:           ADD	HL,HL
0050B2 D9     14550 EXX
0050B3 ED     14551 ADC	HL,HL
0050B4 6A   
0050B5 D9     14552 EXX
0050B6 38     14553 JR	C,SQR3
0050B7 EE   
0050B8 3C     14554 INC	A
0050B9 0C     14555 INC	C
0050BA ED     14556 SBC	HL,BC
0050BB 42   
0050BC D9     14557 EXX
0050BD ED     14558 SBC	HL,BC
0050BE 42   
0050BF D9     14559 EXX
0050C0 D0     14560 RET	NC
0050C1 09     14561 ADD	HL,BC
0050C2 D9     14562 EXX
0050C3 ED     14563 ADC	HL,BC
0050C4 4A   
0050C5 D9     14564 EXX
0050C6 0D     14565 DEC	C
0050C7 C9     14566 RET
0050C8 D9     14568 SLA8:           EXX
0050C9 CB     14569 SLA	E
0050CA 23   
0050CB CB     14570 RL	D
0050CC 12   
0050CD D9     14571 EXX
0050CE CB     14572 RL	E
0050CF 13   
0050D0 CB     14573 RL	D
0050D1 12   
0050D2 D9     14574 EXX
0050D3 ED     14575 ADC	HL,HL
0050D4 6A   
0050D5 D9     14576 EXX
0050D6 ED     14577 ADC	HL,HL
0050D7 6A   
0050D8 C9     14578 RET
0050D9 DD     14580 DIGITQ:         LD	A,(IX)
0050DA 7E   
0050DB 00   
0050DC FE     14581 CP	'9'+1
0050DD 3A   
0050DE 3F     14582 CCF
0050DF D8     14583 RET	C
0050E0 FE     14584 CP	'0'
0050E1 30   
0050E2 C9     14585 RET
0050E3 DD     14587 SIGNQ:          LD	A,(IX)
0050E4 7E   
0050E5 00   
0050E6 DD     14588 INC	IX
0050E7 23   
0050E8 FE     14589 CP	' '
0050E9 20   
0050EA 28     14590 JR	Z,SIGNQ
0050EB F7   
0050EC FE     14591 CP	'+'
0050ED 2B   
0050EE C8     14592 RET	Z
0050EF FE     14593 CP	'-'
0050F0 2D   
0050F1 C8     14594 RET	Z
0050F2 DD     14595 DEC	IX
0050F3 2B   
0050F4 C9     14596 RET
0050F5 08     14598 ABS2:           EX	AF,AF'
0050F6 CB     14599 BIT	7,H
0050F7 7C   
0050F8 C4     14600 CALL	NZ,NEGATE	;MAKE ARGUMENTS +VE
0050F9 06   
0050FA 4E   
0050FB CD     14601 CALL	SWAP
0050FC DC   
0050FD 4E   
0050FE CB     14602 BIT	7,H
0050FF 7C   
005100 C4     14603 CALL	NZ,NEGATE
005101 06   
005102 4E   
005103 44     14604 LD	B,H
005104 4D     14605 LD	C,L
005105 21     14606 LD	HL,0
005106 00   
005107 00   
005108 D9     14607 EXX
005109 44     14608 LD	B,H
00510A 4D     14609 LD	C,L
00510B 21     14610 LD	HL,0
00510C 00   
00510D 00   
00510E C9     14611 RET
00510F             14616   ; --- Begin data.asm ---
00510F FF   
005110 FF   
005111 FF   
005112 FF   
005113 FF   
005114 FF   
005115 FF   
005116 FF   
005117 FF   
005118 FF   
005119 FF   
00511A FF   
00511B FF   
00511C FF   
00511D FF   
00511E FF   
00511F FF   
005120 FF   
005121 FF   
005122 FF   
005123 FF   
005124 FF   
005125 FF   
005126 FF   
005127 FF   
005128 FF   
005129 FF   
00512A FF   
00512B FF   
00512C FF   
00512D FF   
00512E FF   
00512F FF   
005130 FF   
005131 FF   
005132 FF   
005133 FF   
005134 FF   
005135 FF   
005136 FF     14648 ALIGN 256
005137 FF   
005138 FF   
005139 FF   
00513A FF   
00513B FF   
00513C FF   
00513D FF   
00513E FF   
00513F FF   
005140 FF   
005141 FF   
005142 FF   
005143 FF   
005144 FF   
005145 FF   
005146 FF   
005147 FF   
005148 FF   
005149 FF   
00514A FF   
00514B FF   
00514C FF   
00514D FF   
00514E FF   
00514F FF   
005150 FF   
005151 FF   
005152 FF   
005153 FF   
005154 FF   
005155 FF   
005156 FF   
005157 FF   
005158 FF   
005159 FF   
00515A FF   
00515B FF   
00515C FF   
00515D FF   
00515E FF   
00515F FF   
005160 FF   
005161 FF   
005162 FF   
005163 FF   
005164 FF   
005165 FF   
005166 FF   
005167 FF   
005168 FF   
005169 FF   
00516A FF   
00516B FF   
00516C FF   
00516D FF   
00516E FF   
00516F FF   
005170 FF   
005171 FF   
005172 FF   
005173 FF   
005174 FF   
005175 FF   
005176 FF   
005177 FF   
005178 FF   
005179 FF   
00517A FF   
00517B FF   
00517C FF   
00517D FF   
00517E FF   
00517F FF   
005180 FF   
005181 FF   
005182 FF   
005183 FF   
005184 FF   
005185 FF   
005186 FF   
005187 FF   
005188 FF   
005189 FF   
00518A FF   
00518B FF   
00518C FF   
00518D FF   
00518E FF   
00518F FF   
005190 FF   
005191 FF   
005192 FF   
005193 FF   
005194 FF   
005195 FF   
005196 FF   
005197 FF   
005198 FF   
005199 FF   
00519A FF   
00519B FF   
00519C FF   
00519D FF   
00519E FF   
00519F FF   
0051A0 FF   
0051A1 FF   
0051A2 FF   
0051A3 FF   
0051A4 FF   
0051A5 FF   
0051A6 FF   
0051A7 FF   
0051A8 FF   
0051A9 FF   
0051AA FF   
0051AB FF   
0051AC FF   
0051AD FF   
0051AE FF   
0051AF FF   
0051B0 FF   
0051B1 FF   
0051B2 FF   
0051B3 FF   
0051B4 FF   
0051B5 FF   
0051B6 FF   
0051B7 FF   
0051B8 FF   
0051B9 FF   
0051BA FF   
0051BB FF   
0051BC FF   
0051BD FF   
0051BE FF   
0051BF FF   
0051C0 FF   
0051C1 FF   
0051C2 FF   
0051C3 FF   
0051C4 FF   
0051C5 FF   
0051C6 FF   
0051C7 FF   
0051C8 FF   
0051C9 FF   
0051CA FF   
0051CB FF   
0051CC FF   
0051CD FF   
0051CE FF   
0051CF FF   
0051D0 FF   
0051D1 FF   
0051D2 FF   
0051D3 FF   
0051D4 FF   
0051D5 FF   
0051D6 FF   
0051D7 FF   
0051D8 FF   
0051D9 FF   
0051DA FF   
0051DB FF   
0051DC FF   
0051DD FF   
0051DE FF   
0051DF FF   
0051E0 FF   
0051E1 FF   
0051E2 FF   
0051E3 FF   
0051E4 FF   
0051E5 FF   
0051E6 FF   
0051E7 FF   
0051E8 FF   
0051E9 FF   
0051EA FF   
0051EB FF   
0051EC FF   
0051ED FF   
0051EE FF   
0051EF FF   
0051F0 FF   
0051F1 FF   
0051F2 FF   
0051F3 FF   
0051F4 FF   
0051F5 FF   
0051F6 FF   
0051F7 FF   
0051F8 FF   
0051F9 FF   
0051FA FF   
0051FB FF   
0051FC FF   
0051FD FF   
0051FE FF   
0051FF FF   
