        Output     Line 
040000             0001   ; --- Begin mos_api.inc ---
040000             0248   ; --- Begin equs.inc ---
040000             0312   ; --- Begin macros.inc ---
040000             0366   ; --- Begin agon_init.asm ---
000000 C3      0393 JP	_start				; Jump to start
000001 52   
000002 00   
000003 FF   
000004 FF   
000005 FF   
000006 FF   
000007 FF   
000008 49      0396 RST_08:			RST.LIS	08h				; API call
000009 CF   
00000A C9      0397 RET
00000B FF   
00000C FF   
00000D FF   
00000E FF   
00000F FF   
000010 49      0400 RST_10:			RST.LIS 10h				; Output
000011 D7   
000012 C9      0401 RET
000013 FF   
000014 FF   
000015 FF   
000016 FF   
000017 FF   
000018 49      0404 RST_18:			RST.LIS	18h				; Block Output
000019 DF   
00001A C9      0405 RET
00001B FF   
00001C FF   
00001D FF   
00001E FF   
00001F FF   
000020 FF   
000021 FF   
000022 FF   
000023 FF   
000024 FF   
000025 FF   
000026 FF   
000027 FF   
000028 FF   
000029 FF   
00002A FF   
00002B FF   
00002C FF   
00002D FF   
00002E FF   
00002F FF   
000030 FF   
000031 FF   
000032 FF   
000033 FF   
000034 FF   
000035 FF   
000036 FF   
000037 FF   
000038 FB      0415 RST_38:			EI
000039 ED      0416 RETI
00003A 4D   
00003B FF      0420 ALIGN	64
00003C FF   
00003D FF   
00003E FF   
00003F FF   
000040 4D      0422 DB	"MOS"				; Flag for MOS - to confirm this is a valid MOS command
000041 4F   
000042 53   
000043 00      0423 DB	00h				; MOS header version 0
000044 00      0424 DB	00h				; Flag for run mode (0: Z80, 1: ADL)
000045 42      0426 _exec_name:		DB	"BBCBASIC.BIN", 0		; The executable name, only used in argv
000046 42   
000047 43   
000048 42   
000049 41   
00004A 53   
00004B 49   
00004C 43   
00004D 2E   
00004E 42   
00004F 49   
000050 4E   
000051 00   
000052 5B      0431 _start:			PUSH.LIL	IY			; Preserve IY
000053 FD   
000054 E5   
000055 FD      0433 LD		IY, 0			; Preserve SPS
000056 21   
000057 00   
000058 00   
000059 FD      0434 ADD		IY, SP
00005A 39   
00005B 5B      0435 PUSH.LIL	IY
00005C FD   
00005D E5   
00005E E3      0437 EX		(SP), HL		; Get the SPS part of the return address
00005F 5B      0438 PUSH.LIL	HL
000060 E5   
000061 E3      0439 EX		(SP), HL		; And restore it for BASIC
000062 5B      0441 PUSH.LIL	AF			; Preserve the rest of the registers
000063 F5   
000064 5B      0442 PUSH.LIL	BC
000065 C5   
000066 5B      0443 PUSH.LIL	DE
000067 D5   
000068 5B      0444 PUSH.LIL	IX
000069 DD   
00006A E5   
00006B ED      0446 LD		A, MB			; Segment base
00006C 6E   
00006D DD      0447 LD		IX, argv_ptrs		; The argv array pointer address
00006E 21   
00006F 65   
000070 01   
000071 CD      0448 CALL		_set_aix24		; Convert to a 24-bit address
000072 51   
000073 01   
000074 5B      0449 PUSH.LIL	IX
000075 DD   
000076 E5   
000077 CD      0450 CALL		_parse_params		; Parse the parameters
000078 E1   
000079 00   
00007A 5B      0451 POP.LIL		IX			; IX: argv
00007B DD   
00007C E1   
00007D 06      0452 LD		B, 0			;  C: argc
00007E 00   
00007F CD      0453 CALL		_main			; Start user code
000080 9A   
000081 00   
000082 5B      0455 POP.LIL		IX			; Restore the registers
000083 DD   
000084 E1   
000085 5B      0456 POP.LIL		DE
000086 D1   
000087 5B      0457 POP.LIL		BC
000088 C1   
000089 5B      0458 POP.LIL		AF
00008A F1   
00008B EB      0460 EX		DE, HL 			; DE: Return code from BASIC
00008C 5B      0461 POP.LIL		HL 			; The SPS part of the return address
00008D E1   
00008E 5B      0462 POP.LIL		IY			; Get the preserved SPS
00008F FD   
000090 E1   
000091 FD      0463 LD		SP, IY			; Restore SPS
000092 F9   
000093 E3      0464 EX		(SP), HL		; Store the SPS part of the return address on the stack
000094 EB      0465 EX		DE, HL 			; HL: Return code from BASIC
000095 5B      0467 POP.LIL		IY			; Restore IY
000096 FD   
000097 E1   
000098 49      0468 RET.L					; Return to MOS
000099 C9   
00009A 21      0476 _main:			LD	HL, ACCS		; Clear the ACCS
00009B 00   
00009C 53   
00009D 36      0477 LD	(HL), 0
00009E 00   
00009F 79      0478 LD	A, C
0000A0 FE      0479 CP	2
0000A1 02   
0000A2 28      0480 JR	Z, _autoload		; 2 parameters = autoload
0000A3 24   
0000A4 38      0481 JR	C, _startbasic		; 1 parameter = normal start
0000A5 35   
0000A6 CD      0483 CALL	TELL
0000A7 7E   
0000A8 45   
0000A9 55      0484 DB	"Usage:\n\r"
0000AA 73   
0000AB 61   
0000AC 67   
0000AD 65   
0000AE 3A   
0000AF 0A   
0000B0 0D   
0000B1 52      0485 DB	"RUN . <filename>\n\r", 0
0000B2 55   
0000B3 4E   
0000B4 20   
0000B5 2E   
0000B6 20   
0000B7 3C   
0000B8 66   
0000B9 69   
0000BA 6C   
0000BB 65   
0000BC 6E   
0000BD 61   
0000BE 6D   
0000BF 65   
0000C0 3E   
0000C1 0A   
0000C2 0D   
0000C3 00   
0000C4 21      0486 LD	HL, 0			; The error code
0000C5 00   
0000C6 00   
0000C7 C9      0487 RET
0000C8 5B      0489 _autoload:		LD.LIL	HL, (IX+3)		; HLU: Address of filename
0000C9 DD   
0000CA 27   
0000CB 03   
0000CC 11      0490 LD	DE, ACCS		;  DE: Destination address
0000CD 00   
0000CE 53   
0000CF 5B      0491 @@:			LD.LIL	A, (HL)			; Fetch the filename byte
0000D0 7E   
0000D1 12      0492 LD	(DE), A			;
0000D2 5B      0493 INC.LIL	HL			; Increase the source pointer
0000D3 23   
0000D4 1C      0494 INC	E			; We only need to increase E as ACCS is on a page boundary
0000D5 20      0495 JR	NZ, @B			; Loop until we hit a 0 byte
0000D6 F8   
0000D7 1D      0496 DEC	E
0000D8 3E      0497 LD	A, CR
0000D9 0D   
0000DA 12      0498 LD	(DE), A			; Replace the 0 byte with a CR for BBC BASIC
0000DB E1      0500 _startbasic:		POP	 HL			; Pop the return address to init off SPS
0000DC 5B      0501 PUSH.LIL HL 			; Stack it on SPL (*BYE will use this as the return address)
0000DD E5   
0000DE C3      0502 JP	 START			; And start BASIC
0000DF 9B   
0000E0 37   
0000E1 01      0512 _parse_params:		LD		BC, _exec_name		; Get the address of the app name in this segment
0000E2 45   
0000E3 00   
0000E4 CD      0513 CALL		_set_abc24		; Convert it to a 24-bit address based upon segment base
0000E5 3F   
0000E6 01   
0000E7 5B      0514 LD.LIL		(IX+0), BC		; ARGV[0] = the executable name
0000E8 DD   
0000E9 0F   
0000EA 00   
0000EB 5B      0515 INC.LIL		IX
0000EC DD   
0000ED 23   
0000EE 5B      0516 INC.LIL		IX
0000EF DD   
0000F0 23   
0000F1 5B      0517 INC.LIL		IX
0000F2 DD   
0000F3 23   
0000F4 CD      0518 CALL		_skip_spaces		; Skip HL past any leading spaces
0000F5 36   
0000F6 01   
0000F7 01      0520 LD		BC, 1			; C: ARGC = 1 - also clears out top 16 bits of BCU
0000F8 01   
0000F9 00   
0000FA 06      0521 LD		B, argv_ptrs_max - 1	; B: Maximum number of argv_ptrs
0000FB 0F   
0000FC C5      0523 _parse_params_1:	PUSH		BC			; Stack ARGC
0000FD 5B      0524 PUSH.LIL	HL			; Stack start address of token
0000FE E5   
0000FF CD      0525 CALL		_get_token		; Get the next token
000100 25   
000101 01   
000102 79      0526 LD		A, C			; A: Length of the token in characters
000103 5B      0527 POP.LIL		DE			; Start address of token (was in HL)
000104 D1   
000105 C1      0528 POP		BC			; ARGC
000106 B7      0529 OR		A			; Check for A=0 (no token found) OR at end of string
000107 C8      0530 RET		Z
000108 5B      0532 LD.LIL		(IX+0), DE		; Store the pointer to the token
000109 DD   
00010A 1F   
00010B 00   
00010C 5B      0533 PUSH.LIL	HL			; DE=HL
00010D E5   
00010E 5B      0534 POP.LIL		DE
00010F D1   
000110 CD      0535 CALL		_skip_spaces		; And skip HL past any spaces onto the next character
000111 36   
000112 01   
000113 AF      0536 XOR		A
000114 5B      0537 LD.LIL		(DE), A			; Zero-terminate the token
000115 12   
000116 5B      0538 INC.LIL		IX
000117 DD   
000118 23   
000119 5B      0539 INC.LIL		IX
00011A DD   
00011B 23   
00011C 5B      0540 INC.LIL		IX			; Advance to next pointer position
00011D DD   
00011E 23   
00011F 0C      0541 INC		C			; Increment ARGC
000120 79      0542 LD		A, C			; Check for C >= A
000121 B8      0543 CP		B
000122 38      0544 JR		C, _parse_params_1	; And loop
000123 D8   
000124 C9      0545 RET
000125 0E      0554 _get_token:		LD		C, 0			; Initialise length
000126 00   
000127 5B      0555 @@:			LD.LIL		A, (HL)			; Get the character from the parameter string
000128 7E   
000129 B7      0556 OR		A			; Exit if 0 (end of parameter string in MOS)
00012A C8      0557 RET 		Z
00012B FE      0558 CP		13			; Exit if CR (end of parameter string in BBC BASIC)
00012C 0D   
00012D C8      0559 RET		Z
00012E FE      0560 CP		' '			; Exit if space (end of token)
00012F 20   
000130 C8      0561 RET		Z
000131 5B      0562 INC.LIL		HL			; Advance to next character
000132 23   
000133 0C      0563 INC 		C			; Increment length
000134 18      0564 JR		@B
000135 F1   
000136 5B      0573 _skip_spaces:		LD.LIL		A, (HL)			; Get the character from the parameter string
000137 7E   
000138 FE      0574 CP		' '			; Exit if not space
000139 20   
00013A C0      0575 RET		NZ
00013B 5B      0576 INC.LIL		HL			; Advance to next character
00013C 23   
00013D 18      0577 JR		_skip_spaces		; Increment length
00013E F7   
00013F 5B      0586 _set_abc24:		PUSH.LIL	HL			; Preserve HL
000140 E5   
000141 5B      0587 PUSH.LIL	BC			; Stick BC onto SPL
000142 C5   
000143 5B      0588 LD.LIL		HL, 2			; HL: SP+2
000144 21   
000145 02   
000146 00   
000147 00   
000148 5B      0589 ADD.LIL		HL, SP
000149 39   
00014A 5B      0590 LD.LIL		(HL), A			; Store A in it
00014B 77   
00014C 5B      0591 POP.LIL		BC			; Fetch ammended BC
00014D C1   
00014E 5B      0592 POP.LIL		HL			; Restore HL
00014F E1   
000150 C9      0593 RET
000151 5B      0602 _set_aix24:		PUSH.LIL	IX			; Stick IX onto SPL
000152 DD   
000153 E5   
000154 5B      0603 LD.LIL		IX, 2			; IX: SP+2
000155 DD   
000156 21   
000157 02   
000158 00   
000159 00   
00015A 5B      0604 ADD.LIL		IX, SP
00015B DD   
00015C 39   
00015D 5B      0605 LD.LIL		(IX), A			; Store A in it
00015E DD   
00015F 77   
000160 00   
000161 5B      0606 POP.LIL		IX			; Fetch ammended IX
000162 DD   
000163 E1   
000164 C9      0607 RET
000165 00      0611 argv_ptrs:		BLKP	argv_ptrs_max, 0		; Storage for the argv array pointers
000166 00   
000167 00   
000168 00   
000169 00   
00016A 00   
00016B 00   
00016C 00   
00016D 00   
00016E 00   
00016F 00   
000170 00   
000171 00   
000172 00   
000173 00   
000174 00   
000175 00   
000176 00   
000177 00   
000178 00   
000179 00   
00017A 00   
00017B 00   
00017C 00   
00017D 00   
00017E 00   
00017F 00   
000180 00   
000181 00   
000182 00   
000183 00   
000184 00   
000185 00   
000186 00   
000187 00   
000188 00   
000189 00   
00018A 00   
00018B 00   
00018C 00   
00018D 00   
00018E 00   
00018F 00   
000190 00   
000191 00   
000192 00   
000193 00   
000194 00   
000195             0614   ; --- Begin agon_graphics.asm ---
000195 DD      0654 MODE_:			PUSH	IX			; Get the system vars in IX
000196 E5   
000197 3E    0001M1 LD	A, function
000198 08   
000199 49    0002M1 RST.LIS	08h
00019A CF   
00019B 5B      0656 RES.LIL	4, (IX+sysvar_vpd_pflags)
00019C DD   
00019D CB   
00019E 04   
00019F A6   
0001A0 CD      0657 CALL    EXPRI
0001A1 B7   
0001A2 18   
0001A3 D9      0658 EXX
0001A4 3E    0001M1 LD      A, VAL
0001A5 16   
0001A6 CD    0002M1 CALL    OSWRCH
0001A7 97   
0001A8 05   
0001A9 7D    0001M1 LD      A, VAL
0001AA CD    0002M1 CALL    OSWRCH
0001AB 97   
0001AC 05   
0001AD 3E    0001M1 LD	A, function
0001AE 08   
0001AF 49    0002M1 RST.LIS	08h
0001B0 CF   
0001B1 5B      0662 @@:			BIT.LIL	4, (IX+sysvar_vpd_pflags)
0001B2 DD   
0001B3 CB   
0001B4 04   
0001B5 66   
0001B6 28      0663 JR	Z, @B			; Wait for the result
0001B7 F9   
0001B8 DD      0664 POP	IX
0001B9 E1   
0001BA C3      0665 JP	XEQ
0001BB 1D   
0001BC 25   
0001BD DD      0675 GETSCHR:		PUSH	IX			; Get the system vars in IX
0001BE E5   
0001BF 3E    0001M1 LD	A, function
0001C0 08   
0001C1 49    0002M1 RST.LIS	08h
0001C2 CF   
0001C3 5B      0677 RES.LIL	1, (IX+sysvar_vpd_pflags)
0001C4 DD   
0001C5 CB   
0001C6 04   
0001C7 8E   
0001C8 3E    0001M1 LD      A, VAL
0001C9 17   
0001CA CD    0002M1 CALL    OSWRCH
0001CB 97   
0001CC 05   
0001CD 3E    0001M1 LD      A, VAL
0001CE 00   
0001CF CD    0002M1 CALL    OSWRCH
0001D0 97   
0001D1 05   
0001D2 3E    0001M1 LD      A, VAL
0001D3 83   
0001D4 CD    0002M1 CALL    OSWRCH
0001D5 97   
0001D6 05   
0001D7 7B    0001M1 LD      A, VAL
0001D8 CD    0002M1 CALL    OSWRCH
0001D9 97   
0001DA 05   
0001DB 7A    0001M1 LD      A, VAL
0001DC CD    0002M1 CALL    OSWRCH
0001DD 97   
0001DE 05   
0001DF 7D    0001M1 LD      A, VAL
0001E0 CD    0002M1 CALL    OSWRCH
0001E1 97   
0001E2 05   
0001E3 7C    0001M1 LD      A, VAL
0001E4 CD    0002M1 CALL    OSWRCH
0001E5 97   
0001E6 05   
0001E7 5B      0685 @@:			BIT.LIL	1, (IX+sysvar_vpd_pflags)
0001E8 DD   
0001E9 CB   
0001EA 04   
0001EB 4E   
0001EC 28      0686 JR	Z, @B			; Wait for the result
0001ED F9   
0001EE 5B      0687 LD.LIL	A, (IX+sysvar_scrchar)	; Fetch the result in A
0001EF DD   
0001F0 7E   
0001F1 09   
0001F2 B7      0688 OR	A			; Check for 00h
0001F3 37      0689 SCF				; C = character map
0001F4 20      0690 JR	NZ, @F			; We have a character, so skip next bit
0001F5 01   
0001F6 AF      0691 XOR	A			; Clear carry
0001F7 DD      0692 @@:			POP	IX
0001F8 E1   
0001F9 C9      0693 RET
0001FA DD      0702 POINT_:			PUSH	IX			; Get the system vars in IX
0001FB E5   
0001FC 3E    0001M1 LD	A, function
0001FD 08   
0001FE 49    0002M1 RST.LIS	08h
0001FF CF   
000200 5B      0704 RES.LIL	2, (IX+sysvar_vpd_pflags)
000201 DD   
000202 CB   
000203 04   
000204 96   
000205 3E    0001M1 LD      A, VAL
000206 17   
000207 CD    0002M1 CALL    OSWRCH
000208 97   
000209 05   
00020A 3E    0001M1 LD      A, VAL
00020B 00   
00020C CD    0002M1 CALL    OSWRCH
00020D 97   
00020E 05   
00020F 3E    0001M1 LD      A, VAL
000210 84   
000211 CD    0002M1 CALL    OSWRCH
000212 97   
000213 05   
000214 7B    0001M1 LD      A, VAL
000215 CD    0002M1 CALL    OSWRCH
000216 97   
000217 05   
000218 7A    0001M1 LD      A, VAL
000219 CD    0002M1 CALL    OSWRCH
00021A 97   
00021B 05   
00021C 7D    0001M1 LD      A, VAL
00021D CD    0002M1 CALL    OSWRCH
00021E 97   
00021F 05   
000220 7C    0001M1 LD      A, VAL
000221 CD    0002M1 CALL    OSWRCH
000222 97   
000223 05   
000224 5B      0712 @@:			BIT.LIL	2, (IX+sysvar_vpd_pflags)
000225 DD   
000226 CB   
000227 04   
000228 56   
000229 28      0713 JR	Z, @B			; Wait for the result
00022A F9   
00022B 5B      0717 LD.LIL	A, (IX+sysvar_scrpixelIndex)
00022C DD   
00022D 7E   
00022E 16   
00022F DD      0718 POP	IX
000230 E1   
000231 C9      0719 RET
000232 CD      0725 COLOUR_:		CALL	EXPRI			; The colour / mode
000233 B7   
000234 18   
000235 D9      0726 EXX
000236 7D      0727 LD	A, L
000237 32      0728 LD	(VDU_BUFFER+0), A	; Store first parameter
000238 00   
000239 53   
00023A CD      0729 CALL	NXT			; Are there any more parameters?
00023B 8F   
00023C 45   
00023D FE      0730 CP	','
00023E 2C   
00023F 28      0731 JR	Z, COLOUR_1		; Yes, so we're doing a palette change next
000240 0E   
000241 3E    0001M1 LD      A, VAL
000242 11   
000243 CD    0002M1 CALL    OSWRCH
000244 97   
000245 05   
000246 3A    0001M1 LD      A, VAL
000247 00   
000248 53   
000249 CD    0002M1 CALL    OSWRCH
00024A 97   
00024B 05   
00024C C3      0735 JP	XEQ
00024D 1D   
00024E 25   
00024F CD      0737 COLOUR_1:		CALL	COMMA
000250 26   
000251 21   
000252 CD      0738 CALL	EXPRI			; Parse R (OR P)
000253 B7   
000254 18   
000255 D9      0739 EXX
000256 7D      0740 LD	A, L
000257 32      0741 LD	(VDU_BUFFER+1), A
000258 01   
000259 53   
00025A CD      0742 CALL	NXT			; Are there any more parameters?
00025B 8F   
00025C 45   
00025D FE      0743 CP	','
00025E 2C   
00025F 28      0744 JR	Z, COLOUR_2		; Yes, so we're doing COLOUR L,R,G,B
000260 23   
000261 3E    0001M1 LD      A, VAL
000262 13   
000263 CD    0002M1 CALL    OSWRCH
000264 97   
000265 05   
000266 3A    0001M1 LD      A, VAL
000267 00   
000268 53   
000269 CD    0002M1 CALL    OSWRCH
00026A 97   
00026B 05   
00026C 3A    0001M1 LD      A, VAL
00026D 01   
00026E 53   
00026F CD    0002M1 CALL    OSWRCH
000270 97   
000271 05   
000272 3E    0001M1 LD      A, VAL
000273 00   
000274 CD    0002M1 CALL    OSWRCH
000275 97   
000276 05   
000277 3E    0001M1 LD      A, VAL
000278 00   
000279 CD    0002M1 CALL    OSWRCH
00027A 97   
00027B 05   
00027C 3E    0001M1 LD      A, VAL
00027D 00   
00027E CD    0002M1 CALL    OSWRCH
00027F 97   
000280 05   
000281 C3      0752 JP	XEQ
000282 1D   
000283 25   
000284 CD      0754 COLOUR_2:		CALL	COMMA
000285 26   
000286 21   
000287 CD      0755 CALL	EXPRI			; Parse G
000288 B7   
000289 18   
00028A D9      0756 EXX
00028B 7D      0757 LD	A, L
00028C 32      0758 LD	(VDU_BUFFER+2), A
00028D 02   
00028E 53   
00028F CD      0759 CALL	COMMA
000290 26   
000291 21   
000292 CD      0760 CALL	EXPRI			; Parse B
000293 B7   
000294 18   
000295 D9      0761 EXX
000296 7D      0762 LD	A, L
000297 32      0763 LD	(VDU_BUFFER+3), A
000298 03   
000299 53   
00029A 3E    0001M1 LD      A, VAL
00029B 13   
00029C CD    0002M1 CALL    OSWRCH
00029D 97   
00029E 05   
00029F 3A    0001M1 LD      A, VAL
0002A0 00   
0002A1 53   
0002A2 CD    0002M1 CALL    OSWRCH
0002A3 97   
0002A4 05   
0002A5 3E    0001M1 LD      A, VAL
0002A6 FF   
0002A7 CD    0002M1 CALL    OSWRCH
0002A8 97   
0002A9 05   
0002AA 3A    0001M1 LD      A, VAL
0002AB 01   
0002AC 53   
0002AD CD    0002M1 CALL    OSWRCH
0002AE 97   
0002AF 05   
0002B0 3A    0001M1 LD      A, VAL
0002B1 02   
0002B2 53   
0002B3 CD    0002M1 CALL    OSWRCH
0002B4 97   
0002B5 05   
0002B6 3A    0001M1 LD      A, VAL
0002B7 03   
0002B8 53   
0002B9 CD    0002M1 CALL    OSWRCH
0002BA 97   
0002BB 05   
0002BC C3      0770 JP	XEQ; --- End agon_graphics.asm ---
0002BD 1D   
0002BE 25   
0002BF             0772   ; --- Begin agon_gpio.asm ---
0002BF CD      0796 GPIOB_SETMODE:		CALL	SWITCH_A
0002C0 18   
0002C1 05   
0002C2 D6      0797 DW	GPIOB_M0	; Output
0002C3 02   
0002C4 FB      0798 DW	GPIOB_M1	; Input
0002C5 02   
0002C6 1B      0799 DW	GPIOB_M2	; Open Drain IO
0002C7 03   
0002C8 3B      0800 DW	GPIOB_M3	; Open Source IO
0002C9 03   
0002CA 56      0801 DW	GPIOB_M4	; Interrupt, Dual Edge
0002CB 03   
0002CC 82      0802 DW	GPIOB_M5	; Alt Function
0002CD 03   
0002CE 9D      0803 DW	GPIOB_M6	; Interrupt, Active Low
0002CF 03   
0002D0 C4      0804 DW	GPIOB_M7	; Interrupt, Active High
0002D1 03   
0002D2 E6      0805 DW	GPIOB_M8	; Interrupt, Falling Edge
0002D3 03   
0002D4 08      0806 DW	GPIOB_M9	; Interrupt, Rising Edge
0002D5 04   
0002D6 C5    0001M1 PUSH    BC
0002D7 78    0002M1 LD      A, VAL
0002D8 2F    0003M1 CPL
0002D9 4F    0004M1 LD      C, A
0002DA ED    0005M1 IN0     A, (REG)
0002DB 38   
0002DC 9B   
0002DD A1    0006M1 AND     C
0002DE ED    0007M1 OUT0    (REG), A
0002DF 39   
0002E0 9B   
0002E1 C1    0008M1 POP     BC
0002E2 C5    0001M1 PUSH    BC
0002E3 78    0002M1 LD      A, VAL
0002E4 2F    0003M1 CPL
0002E5 4F    0004M1 LD      C, A
0002E6 ED    0005M1 IN0     A, (REG)
0002E7 38   
0002E8 9C   
0002E9 A1    0006M1 AND     C
0002EA ED    0007M1 OUT0    (REG), A
0002EB 39   
0002EC 9C   
0002ED C1    0008M1 POP     BC
0002EE C5    0001M1 PUSH    BC
0002EF 78    0002M1 LD      A, VAL
0002F0 2F    0003M1 CPL
0002F1 4F    0004M1 LD      C, A
0002F2 ED    0005M1 IN0     A, (REG)
0002F3 38   
0002F4 9D   
0002F5 A1    0006M1 AND     C
0002F6 ED    0007M1 OUT0    (REG), A
0002F7 39   
0002F8 9D   
0002F9 C1    0008M1 POP     BC
0002FA C9      0813 RET
0002FB ED    0001M1 IN0     A, (REG)
0002FC 38   
0002FD 9B   
0002FE B0    0002M1 OR      VAL
0002FF ED    0003M1 OUT0    (REG), A
000300 39   
000301 9B   
000302 C5    0001M1 PUSH    BC
000303 78    0002M1 LD      A, VAL
000304 2F    0003M1 CPL
000305 4F    0004M1 LD      C, A
000306 ED    0005M1 IN0     A, (REG)
000307 38   
000308 9C   
000309 A1    0006M1 AND     C
00030A ED    0007M1 OUT0    (REG), A
00030B 39   
00030C 9C   
00030D C1    0008M1 POP     BC
00030E C5    0001M1 PUSH    BC
00030F 78    0002M1 LD      A, VAL
000310 2F    0003M1 CPL
000311 4F    0004M1 LD      C, A
000312 ED    0005M1 IN0     A, (REG)
000313 38   
000314 9D   
000315 A1    0006M1 AND     C
000316 ED    0007M1 OUT0    (REG), A
000317 39   
000318 9D   
000319 C1    0008M1 POP     BC
00031A C9      0820 RET
00031B C5    0001M1 PUSH    BC
00031C 78    0002M1 LD      A, VAL
00031D 2F    0003M1 CPL
00031E 4F    0004M1 LD      C, A
00031F ED    0005M1 IN0     A, (REG)
000320 38   
000321 9B   
000322 A1    0006M1 AND     C
000323 ED    0007M1 OUT0    (REG), A
000324 39   
000325 9B   
000326 C1    0008M1 POP     BC
000327 ED    0001M1 IN0     A, (REG)
000328 38   
000329 9C   
00032A B0    0002M1 OR      VAL
00032B ED    0003M1 OUT0    (REG), A
00032C 39   
00032D 9C   
00032E C5    0001M1 PUSH    BC
00032F 78    0002M1 LD      A, VAL
000330 2F    0003M1 CPL
000331 4F    0004M1 LD      C, A
000332 ED    0005M1 IN0     A, (REG)
000333 38   
000334 9D   
000335 A1    0006M1 AND     C
000336 ED    0007M1 OUT0    (REG), A
000337 39   
000338 9D   
000339 C1    0008M1 POP     BC
00033A C9      0827 RET
00033B ED    0001M1 IN0     A, (REG)
00033C 38   
00033D 9B   
00033E B0    0002M1 OR      VAL
00033F ED    0003M1 OUT0    (REG), A
000340 39   
000341 9B   
000342 ED    0001M1 IN0     A, (REG)
000343 38   
000344 9C   
000345 B0    0002M1 OR      VAL
000346 ED    0003M1 OUT0    (REG), A
000347 39   
000348 9C   
000349 C5    0001M1 PUSH    BC
00034A 78    0002M1 LD      A, VAL
00034B 2F    0003M1 CPL
00034C 4F    0004M1 LD      C, A
00034D ED    0005M1 IN0     A, (REG)
00034E 38   
00034F 9D   
000350 A1    0006M1 AND     C
000351 ED    0007M1 OUT0    (REG), A
000352 39   
000353 9D   
000354 C1    0008M1 POP     BC
000355 C9      0834 RET
000356 ED    0001M1 IN0     A, (REG)
000357 38   
000358 9A   
000359 B0    0002M1 OR      VAL
00035A ED    0003M1 OUT0    (REG), A
00035B 39   
00035C 9A   
00035D C5    0001M1 PUSH    BC
00035E 78    0002M1 LD      A, VAL
00035F 2F    0003M1 CPL
000360 4F    0004M1 LD      C, A
000361 ED    0005M1 IN0     A, (REG)
000362 38   
000363 9B   
000364 A1    0006M1 AND     C
000365 ED    0007M1 OUT0    (REG), A
000366 39   
000367 9B   
000368 C1    0008M1 POP     BC
000369 C5    0001M1 PUSH    BC
00036A 78    0002M1 LD      A, VAL
00036B 2F    0003M1 CPL
00036C 4F    0004M1 LD      C, A
00036D ED    0005M1 IN0     A, (REG)
00036E 38   
00036F 9C   
000370 A1    0006M1 AND     C
000371 ED    0007M1 OUT0    (REG), A
000372 39   
000373 9C   
000374 C1    0008M1 POP     BC
000375 C5    0001M1 PUSH    BC
000376 78    0002M1 LD      A, VAL
000377 2F    0003M1 CPL
000378 4F    0004M1 LD      C, A
000379 ED    0005M1 IN0     A, (REG)
00037A 38   
00037B 9D   
00037C A1    0006M1 AND     C
00037D ED    0007M1 OUT0    (REG), A
00037E 39   
00037F 9D   
000380 C1    0008M1 POP     BC
000381 C9      0842 RET
000382 ED    0001M1 IN0     A, (REG)
000383 38   
000384 9B   
000385 B0    0002M1 OR      VAL
000386 ED    0003M1 OUT0    (REG), A
000387 39   
000388 9B   
000389 C5    0001M1 PUSH    BC
00038A 78    0002M1 LD      A, VAL
00038B 2F    0003M1 CPL
00038C 4F    0004M1 LD      C, A
00038D ED    0005M1 IN0     A, (REG)
00038E 38   
00038F 9C   
000390 A1    0006M1 AND     C
000391 ED    0007M1 OUT0    (REG), A
000392 39   
000393 9C   
000394 C1    0008M1 POP     BC
000395 ED    0001M1 IN0     A, (REG)
000396 38   
000397 9D   
000398 B0    0002M1 OR      VAL
000399 ED    0003M1 OUT0    (REG), A
00039A 39   
00039B 9D   
00039C C9      0849 RET
00039D C5    0001M1 PUSH    BC
00039E 78    0002M1 LD      A, VAL
00039F 2F    0003M1 CPL
0003A0 4F    0004M1 LD      C, A
0003A1 ED    0005M1 IN0     A, (REG)
0003A2 38   
0003A3 9A   
0003A4 A1    0006M1 AND     C
0003A5 ED    0007M1 OUT0    (REG), A
0003A6 39   
0003A7 9A   
0003A8 C1    0008M1 POP     BC
0003A9 C5    0001M1 PUSH    BC
0003AA 78    0002M1 LD      A, VAL
0003AB 2F    0003M1 CPL
0003AC 4F    0004M1 LD      C, A
0003AD ED    0005M1 IN0     A, (REG)
0003AE 38   
0003AF 9B   
0003B0 A1    0006M1 AND     C
0003B1 ED    0007M1 OUT0    (REG), A
0003B2 39   
0003B3 9B   
0003B4 C1    0008M1 POP     BC
0003B5 ED    0001M1 IN0     A, (REG)
0003B6 38   
0003B7 9C   
0003B8 B0    0002M1 OR      VAL
0003B9 ED    0003M1 OUT0    (REG), A
0003BA 39   
0003BB 9C   
0003BC ED    0001M1 IN0     A, (REG)
0003BD 38   
0003BE 9D   
0003BF B0    0002M1 OR      VAL
0003C0 ED    0003M1 OUT0    (REG), A
0003C1 39   
0003C2 9D   
0003C3 C9      0857 RET
0003C4 ED    0001M1 IN0     A, (REG)
0003C5 38   
0003C6 9A   
0003C7 B0    0002M1 OR      VAL
0003C8 ED    0003M1 OUT0    (REG), A
0003C9 39   
0003CA 9A   
0003CB C5    0001M1 PUSH    BC
0003CC 78    0002M1 LD      A, VAL
0003CD 2F    0003M1 CPL
0003CE 4F    0004M1 LD      C, A
0003CF ED    0005M1 IN0     A, (REG)
0003D0 38   
0003D1 9B   
0003D2 A1    0006M1 AND     C
0003D3 ED    0007M1 OUT0    (REG), A
0003D4 39   
0003D5 9B   
0003D6 C1    0008M1 POP     BC
0003D7 ED    0001M1 IN0     A, (REG)
0003D8 38   
0003D9 9C   
0003DA B0    0002M1 OR      VAL
0003DB ED    0003M1 OUT0    (REG), A
0003DC 39   
0003DD 9C   
0003DE ED    0001M1 IN0     A, (REG)
0003DF 38   
0003E0 9D   
0003E1 B0    0002M1 OR      VAL
0003E2 ED    0003M1 OUT0    (REG), A
0003E3 39   
0003E4 9D   
0003E5 C9      0866 RET
0003E6 C5    0001M1 PUSH    BC
0003E7 78    0002M1 LD      A, VAL
0003E8 2F    0003M1 CPL
0003E9 4F    0004M1 LD      C, A
0003EA ED    0005M1 IN0     A, (REG)
0003EB 38   
0003EC 9A   
0003ED A1    0006M1 AND     C
0003EE ED    0007M1 OUT0    (REG), A
0003EF 39   
0003F0 9A   
0003F1 C1    0008M1 POP     BC
0003F2 ED    0001M1 IN0     A, (REG)
0003F3 38   
0003F4 9B   
0003F5 B0    0002M1 OR      VAL
0003F6 ED    0003M1 OUT0    (REG), A
0003F7 39   
0003F8 9B   
0003F9 ED    0001M1 IN0     A, (REG)
0003FA 38   
0003FB 9C   
0003FC B0    0002M1 OR      VAL
0003FD ED    0003M1 OUT0    (REG), A
0003FE 39   
0003FF 9C   
000400 ED    0001M1 IN0     A, (REG)
000401 38   
000402 9D   
000403 B0    0002M1 OR      VAL
000404 ED    0003M1 OUT0    (REG), A
000405 39   
000406 9D   
000407 C9      0875 RET
000408 ED    0001M1 IN0     A, (REG)
000409 38   
00040A 9A   
00040B B0    0002M1 OR      VAL
00040C ED    0003M1 OUT0    (REG), A
00040D 39   
00040E 9A   
00040F ED    0001M1 IN0     A, (REG)
000410 38   
000411 9B   
000412 B0    0002M1 OR      VAL
000413 ED    0003M1 OUT0    (REG), A
000414 39   
000415 9B   
000416 ED    0001M1 IN0     A, (REG)
000417 38   
000418 9C   
000419 B0    0002M1 OR      VAL
00041A ED    0003M1 OUT0    (REG), A
00041B 39   
00041C 9C   
00041D ED    0001M1 IN0     A, (REG)
00041E 38   
00041F 9D   
000420 B0    0002M1 OR      VAL
000421 ED    0003M1 OUT0    (REG), A
000422 39   
000423 9D   
000424 C9      0883 RET
000425             0886   ; --- Begin agon_interrupt.asm ---
000425 F3      0915 VBLANK_INIT:		DI
000426 ED      0917 LD		A, MB 				; Get a 24-bit pointer to
000427 6E   
000428 21      0918 LD		HL, VBLANK_HANDLER		; this interrupt handler routine who's
000429 A3   
00042A 04   
00042B CD      0919 CALL		SET_AHL16 			; address is a 16-bit pointer in BBC BASIC's segment
00042C 65   
00042D 04   
00042E 1E      0921 LD		E, 32h				; Set up the VBlank Interrupt Vector
00042F 32   
000430 3E    0001M1 LD	A, function
000431 14   
000432 49    0002M1 RST.LIS	08h
000433 CF   
000434 5B      0924 PUSH.LIL	HL				; HLU: Pointer to the MOS interrupt vector
000435 E5   
000436 5B      0925 POP.LIL		DE 				; DEU: Pointer to the MOS interrupt vector
000437 D1   
000438 21      0927 LD		HL, VBLANK_HANDLER_JP + 1	; Pointer to the JP address in this segment
000439 BB   
00043A 04   
00043B ED      0928 LD		A, MB	 			; Get the segment BBC BASIC is running in
00043C 6E   
00043D 32      0929 LD		(VBLANK_HANDLER_MB + 1), A 	; Store in the interrupt handler
00043E AC   
00043F 04   
000440 CD      0930 CALL		SET_AHL16 			; Convert pointer to an absolute 24-bit address
000441 65   
000442 04   
000443 5B      0931 LD.LIL		(HL), DE			; Self-modify the code
000444 ED   
000445 1F   
000446 FB      0932 EI
000447 C9      0933 RET
000448 F3      0937 VBLANK_STOP:		DI
000449 21      0938 LD		HL, VBLANK_HANDLER_JP + 1	; Pointer to the JP address in this segment
00044A BB   
00044B 04   
00044C 3A      0939 LD		A, (VBLANK_HANDLER_MB + 1)	; The stored MB of the segment BBC BASIC is running in
00044D AC   
00044E 04   
00044F F5      0940 PUSH		AF 				; Stack the MB for later
000450 CD      0941 CALL		SET_AHL16			; Convert pointer to an absolute 24-bit address
000451 65   
000452 04   
000453 5B      0942 LD.LIL		DE, (HL)			; DEU: Address of MOS interrupt vector
000454 ED   
000455 17   
000456 5B      0943 PUSH.LIL	DE				; Transfer to HL
000457 D5   
000458 5B      0944 POP.LIL		HL
000459 E1   
00045A 1E      0945 LD		E, 32h
00045B 32   
00045C 3E    0001M1 LD	A, function
00045D 14   
00045E 49    0002M1 RST.LIS	08h
00045F CF   
000460 F1      0947 POP		AF 				; Restore MB to this segment
000461 ED      0948 LD		MB, A
000462 6D   
000463 FB      0949 EI
000464 C9      0950 RET
000465 5B      0954 SET_AHL16:		PUSH.LIL	HL
000466 E5   
000467 5B      0955 LD.LIL		HL, 2
000468 21   
000469 02   
00046A 00   
00046B 00   
00046C 5B      0956 ADD.LIL		HL, SP
00046D 39   
00046E 5B      0957 LD.LIL		(HL), A
00046F 77   
000470 5B      0958 POP.LIL		HL
000471 E1   
000472 C9      0959 RET
000473 3E    0001M1 LD	A, function
000474 08   
000475 49    0002M1 RST.LIS	08h
000476 CF   
000477 21      0964 LD		HL, KEYCOUNT 			; Check whether the keycount has changed
000478 07   
000479 52   
00047A 5B      0965 LD.LIL		A, (IX + sysvar_vkeycount)	; by comparing the MOS copy
00047B DD   
00047C 7E   
00047D 19   
00047E BE      0966 CP 		(HL)				; with our local copy
00047F 20      0967 JR		NZ, DO_KEYBOARD_1		; Yes it has, so jump to the next bit
000480 09   
000481 AF      0969 DO_KEYBOARD_0:		XOR		A 				; Clear the keyboard values
000482 32      0970 LD		(KEYASCII), A
000483 06   
000484 52   
000485 32      0971 LD		(KEYDOWN), A
000486 05   
000487 52   
000488 5B      0972 RET.LIL 					; And return
000489 C9   
00048A 77      0974 DO_KEYBOARD_1:		LD		(HL), A 			; Store the updated local copy of keycount
00048B 5B      0975 LD.LIL		A, (IX + sysvar_vkeydown)	; Fetch key down value (1 = key down, 0 = key up)
00048C DD   
00048D 7E   
00048E 18   
00048F B7      0976 OR		A
000490 28      0977 JR		Z, DO_KEYBOARD_0		; If it is key up, then clear the keyboard values
000491 EF   
000492 32      0979 LD		(KEYDOWN), A 			; Store the keydown value
000493 05   
000494 52   
000495 5B      0980 LD.LIL		A, (IX + sysvar_keyascii)	; Fetch key ASCII value
000496 DD   
000497 7E   
000498 05   
000499 32      0981 LD		(KEYASCII), A 			; Store locally
00049A 06   
00049B 52   
00049C FE      0982 CP		1Bh				; Is it escape?
00049D 1B   
00049E CC      0983 CALL		Z, ESCSET			; Yes, so set the escape flags
00049F 18   
0004A0 06   
0004A1 49      0984 RET.LIS						; Return to the interrupt handler
0004A2 C9   
0004A3 F3      0991 VBLANK_HANDLER:		DI
0004A4 F5      0992 PUSH		AF
0004A5 E5      0993 PUSH		HL
0004A6 DD      0994 PUSH		IX
0004A7 E5   
0004A8 ED      0995 LD		A, MB
0004A9 6E   
0004AA F5      0996 PUSH		AF
0004AB 3E      0997 VBLANK_HANDLER_MB:	LD		A, 0				; This is self-modified by VBLANK_INIT
0004AC 00   
0004AD ED      0998 LD		MB, A
0004AE 6D   
0004AF 49      0999 CALL.LIS	DO_KEYBOARD
0004B0 CD   
0004B1 73   
0004B2 04   
0004B3 F1      1000 POP		AF
0004B4 ED      1001 LD		MB, A
0004B5 6D   
0004B6 DD      1002 POP		IX
0004B7 E1   
0004B8 E1      1003 POP		HL
0004B9 F1      1004 POP		AF
0004BA C3      1008 VBLANK_HANDLER_JP:	JP		0				; This is self-modified by VBLANK_INIT
0004BB 00   
0004BC 00   
0004BD 00   
0004BE             1011   ; --- Begin agon_misc.asm ---
0004BE C5      1050 ASC_TO_NUMBER:		PUSH	BC			; Preserve BC
0004BF 11      1051 LD	DE, 0			; Initialise DE
0004C0 00   
0004C1 00   
0004C2 CD      1052 CALL	SKIPSPmisc			; Skip whitespace
0004C3 02   
0004C4 05   
0004C5 7E      1053 LD	A, (HL)			; Read first character
0004C6 FE      1054 CP	'&'			; Is it prefixed with '&' (HEX number)?
0004C7 26   
0004C8 20      1055 JR	NZ, ASC_TO_NUMBER3	; Jump to decimal parser if not
0004C9 1E   
0004CA 23      1056 INC	HL			; Otherwise fall through to ASC_TO_HEX
0004CB 7E      1058 ASC_TO_NUMBER1:		LD	A, (HL)			; Fetch the character
0004CC CD      1059 CALL    UPPRCmisc			; Convert to uppercase
0004CD 10   
0004CE 05   
0004CF D6      1060 SUB	'0'			; Normalise to 0
0004D0 30   
0004D1 38      1061 JR 	C, ASC_TO_NUMBER4	; Return if < ASCII '0'
0004D2 2E   
0004D3 FE      1062 CP 	10			; Check if >= 10
0004D4 0A   
0004D5 38      1063 JR 	C,ASC_TO_NUMBER2	; No, so skip next bit
0004D6 06   
0004D7 D6      1064 SUB 	7			; Adjust ASCII A-F to nibble
0004D8 07   
0004D9 FE      1065 CP 	16			; Check for > F
0004DA 10   
0004DB 30      1066 JR 	NC, ASC_TO_NUMBER4	; Return if out of range
0004DC 24   
0004DD EB      1067 ASC_TO_NUMBER2:		EX 	DE, HL 			; Shift DE left 4 times
0004DE 29      1068 ADD	HL, HL
0004DF 29      1069 ADD	HL, HL
0004E0 29      1070 ADD	HL, HL
0004E1 29      1071 ADD	HL, HL
0004E2 EB      1072 EX	DE, HL
0004E3 B3      1073 OR      E			; OR the new digit in to the least significant nibble
0004E4 5F      1074 LD      E, A
0004E5 23      1075 INC     HL			; Onto the next character
0004E6 18      1076 JR      ASC_TO_NUMBER1		; And loop
0004E7 E3   
0004E8 7E      1078 ASC_TO_NUMBER3:		LD	A, (HL)
0004E9 D6      1079 SUB	'0'			; Normalise to 0
0004EA 30   
0004EB 38      1080 JR	C, ASC_TO_NUMBER4	; Return if < ASCII '0'
0004EC 14   
0004ED FE      1081 CP	10			; Check if >= 10
0004EE 0A   
0004EF 30      1082 JR	NC, ASC_TO_NUMBER4	; Return if >= 10
0004F0 10   
0004F1 EB      1083 EX 	DE, HL 			; Stick DE in HL
0004F2 44      1084 LD	B, H 			; And copy HL into BC
0004F3 4D      1085 LD	C, L
0004F4 29      1086 ADD	HL, HL 			; x 2
0004F5 29      1087 ADD	HL, HL 			; x 4
0004F6 09      1088 ADD	HL, BC 			; x 5
0004F7 29      1089 ADD	HL, HL 			; x 10
0004F8 EB      1090 EX	DE, HL
0004F9 83    0001M1 ADD     A, E
0004FA 5F    0002M1 LD      E, A
0004FB 8A    0003M1 ADC     A, D
0004FC 93    0004M1 SUB     E
0004FD 57    0005M1 LD      D, A
0004FE 23      1092 INC	HL
0004FF 18      1093 JR	ASC_TO_NUMBER3
000500 E7   
000501 C1      1094 ASC_TO_NUMBER4:		POP	BC 			; Fall through to SKIPSP here
000502 7E      1099 SKIPSPmisc:			LD      A, (HL)
000503 FE      1100 CP      ' '
000504 20   
000505 C0      1101 RET     NZ
000506 23      1102 INC     HL
000507 18      1103 JR      SKIPSPmisc
000508 F9   
000509 7E      1108 SKIPNOTSP:		LD	A, (HL)
00050A FE      1109 CP	' '
00050B 20   
00050C C8      1110 RET	Z
00050D 23      1111 INC	HL
00050E 18      1112 JR	SKIPNOTSP
00050F F9   
000510 E6      1117 UPPRCmisc:  		AND     7FH
000511 7F   
000512 FE      1118 CP      '`'
000513 60   
000514 D8      1119 RET     C
000515 E6      1120 AND     5FH			; Convert to upper case
000516 5F   
000517 C9      1121 RET
000518 E3      1126 SWITCH_A:		EX	(SP), HL		; Swap HL with the contents of the top of the stack
000519 87      1127 ADD	A, A			; Multiply A by two
00051A 85    0001M1 ADD     A, L
00051B 6F    0002M1 LD      L, A
00051C 8C    0003M1 ADC     A, H
00051D 95    0004M1 SUB     L
00051E 67    0005M1 LD      H, A
00051F 7E      1129 LD	A, (HL)			; follow the call. Fetch an address from the
000520 23      1130 INC	HL 			; table.
000521 66      1131 LD	H, (HL)
000522 6F      1132 LD	L, A
000523 E3      1133 EX	(SP), HL		; Swap this new address back, restores HL
000524 C9      1134 RET				; Return program control to this new address
000525 C5      1139 NULLTOCR:		PUSH 	BC
000526 06      1140 LD	B, 0
000527 00   
000528 0E      1141 LD	C, CR
000529 0D   
00052A 18      1142 JR	CRTONULL0
00052B 05   
00052C C5      1144 CRTONULL:		PUSH	BC
00052D 06      1145 LD	B, CR
00052E 0D   
00052F 0E      1146 LD	C, 0
000530 00   
000531 E5      1148 CRTONULL0:		PUSH	HL
000532 7E      1149 CRTONULL1:		LD	A, (HL)
000533 B8      1150 CP 	B
000534 28      1151 JR	Z, CRTONULL2
000535 03   
000536 23      1152 INC	HL
000537 18      1153 JR	CRTONULL1
000538 F9   
000539 71      1154 CRTONULL2:		LD	(HL), C
00053A E1      1155 POP 	HL
00053B C1      1156 POP	BC
00053C C9      1157 RET
00053D 7E      1163 CSTR_FNAME:		LD	A, (HL)			; Get source
00053E FE      1164 CP	32			; Is it space
00053F 20   
000540 28      1165 JR	Z, @F
000541 09   
000542 FE      1166 CP	CR			; Or is it CR
000543 0D   
000544 28      1167 JR	Z, @F
000545 05   
000546 12      1168 LD	(DE), A			; No, so store
000547 23      1169 INC	HL			; Increment
000548 13      1170 INC	DE
000549 18      1171 JR	CSTR_FNAME		; And loop
00054A F2   
00054B AF      1172 @@:			XOR	A			; Zero terminate the target string
00054C 12      1173 LD	(DE), A
00054D 13      1174 INC	DE			; And point to next free address
00054E C9      1175 RET
00054F 7E      1181 CSTR_LINE:		LD	A, (HL)			; Get source
000550 FE      1182 CP	CR			; Is it CR
000551 0D   
000552 28      1183 JR	Z, @F
000553 05   
000554 12      1184 LD	(DE), A			; No, so store
000555 23      1185 INC	HL			; Increment
000556 13      1186 INC	DE
000557 18      1187 JR	CSTR_LINE		; And loop
000558 F6   
000559 AF      1188 @@:			XOR	A			; Zero terminate the target string
00055A 12      1189 LD	(DE), A
00055B 13      1190 INC	DE			; And point to next free address
00055C C9      1191 RET
00055D 7E      1199 CSTR_FINDCH:		LD	A, (HL)			; Get source
00055E B9      1200 CP	C			; Is it our character?
00055F C8      1201 RET	Z			; Yes, so exit
000560 B7      1202 OR	A			; Is it the end of string?
000561 C8      1203 RET	Z			; Yes, so exit
000562 23      1204 INC	HL
000563 18      1205 JR	CSTR_FINDCH
000564 F8   
000565 7E      1213 CSTR_ENDSWITH:		LD	A, (HL)			; Get the source string byte
000566 CD      1214 CALL	UPPRCmisc			; Convert to upper case
000567 10   
000568 05   
000569 4F      1215 LD	C, A
00056A 1A      1216 LD	A, (DE)			; Get the substring byte
00056B B9      1217 CP	C
00056C C0      1218 RET	NZ			; Return NZ if at any point the strings don't match
00056D B1      1219 OR	C			; Check whether both bytes are zero
00056E C8      1220 RET	Z			; If so, return, as we have reached the end of both strings
00056F 23      1221 INC	HL
000570 13      1222 INC	DE
000571 18      1223 JR	CSTR_ENDSWITH		; And loop
000572 F2   
000573 7E      1229 CSTR_CAT:		LD	A, (HL)			; Loop until we find the end of the first string
000574 B7      1230 OR	A
000575 28      1231 JR	Z, CSTR_CAT_1
000576 03   
000577 23      1232 INC	HL
000578 18      1233 JR	CSTR_CAT
000579 F9   
00057A 1A      1235 CSTR_CAT_1:		LD	A, (DE)			; Copy the second string onto the end of the first string
00057B 77      1236 LD	(HL), A
00057C B7      1237 OR	A			; Check for end of string
00057D C8      1238 RET	Z			; And return
00057E 23      1239 INC	HL
00057F 13      1240 INC	DE
000580 18      1241 JR	CSTR_CAT_1		; Loop until finished
000581 F8   
000582             1244   ; --- Begin agon_os.asm ---
000582 CD      1348 OSINIT:			CALL	VBLANK_INIT
000583 25   
000584 04   
000585 AF      1349 XOR	A
000586 32      1350 LD	(FLAGS), A		; Clear flags and set F = Z
000587 00   
000588 52   
000589 21      1351 LD 	HL, USER
00058A 00   
00058B 56   
00058C 11      1352 LD	DE, RAM_Top
00058D 00   
00058E FF   
00058F 5F      1353 LD	E, A			; Page boundary
000590 3A      1354 LD	A, (ACCS)		; Return NZ if there is a file to chain
000591 00   
000592 53   
000593 B7      1355 OR	A
000594 C9      1356 RET
000595 3E      1360 PROMPT: 		LD	A,'>'			; Falls through to OSWRCH
000596 3E   
000597 E5      1366 OSWRCH:			PUSH	HL
000598 21      1367 LD	HL, LISTON		; Fetch the LISTON variable
000599 FE   
00059A 55   
00059B CB      1368 BIT	3, (HL)			; Check whether we are in *EDIT mode
00059C 5E   
00059D 20      1369 JR	NZ, OSWRCH_BUFFER	; Yes, so just output to buffer
00059E 0A   
00059F 2A      1371 LD	HL, (OSWRCHCH)		; L: Channel #
0005A0 03   
0005A1 52   
0005A2 2D      1372 DEC	L			; If it is 1
0005A3 28      1373 JR	Z, OSWRCH_FILE		; Then we are outputting to a file
0005A4 17   
0005A5 E1      1375 POP	HL			; Otherwise
0005A6 49      1376 RST.LIS	10h			; Output the character to MOS
0005A7 D7   
0005A8 C9      1377 RET
0005A9 2A      1379 OSWRCH_BUFFER:		LD	HL, (OSWRCHPT)		; Fetch the pointer buffer
0005AA 01   
0005AB 52   
0005AC FE      1380 CP	0AH			; Just ignore this
0005AD 0A   
0005AE 28      1381 JR	Z, OSWRCH_BUFFER2
0005AF 0A   
0005B0 FE      1382 CP	0DH			; Is it the end of line?
0005B1 0D   
0005B2 20      1383 JR	NZ, OSWRCH_BUFFER1	; No, so carry on
0005B3 01   
0005B4 AF      1384 XOR	A			; Turn it into a NUL character
0005B5 77      1385 OSWRCH_BUFFER1:		LD	(HL), A			; Echo the character into the buffer
0005B6 23      1386 INC	HL			; Increment pointer
0005B7 22      1387 LD	(OSWRCHPT), HL		; Write pointer back
0005B8 01   
0005B9 52   
0005BA E1      1388 OSWRCH_BUFFER2:		POP	HL
0005BB C9      1389 RET
0005BC D5      1391 OSWRCH_FILE:		PUSH	DE
0005BD 5C      1392 LD	E, H			; Filehandle to E
0005BE CD      1393 CALL	OSBPUT			; Write the byte out
0005BF 65   
0005C0 06   
0005C1 D1      1394 POP	DE
0005C2 E1      1395 POP	HL
0005C3 C9      1396 RET
0005C4 CD      1400 OSRDCH:			CALL    NXT			; Check if we are doing GET$(x,y)
0005C5 8F   
0005C6 45   
0005C7 FE      1401 CP      '('
0005C8 28   
0005C9 28      1402 JR	Z, @F 			; Yes, so skip to that functionality
0005CA 09   
0005CB 3E    0001M1 LD	A, function
0005CC 00   
0005CD 49    0002M1 RST.LIS	08h
0005CE CF   
0005CF FE      1404 CP	1Bh
0005D0 1B   
0005D1 28      1405 JR	Z, LTRAP1
0005D2 6A   
0005D3 C9      1406 RET
0005D4 FD      1408 @@:			INC	IY			; Skip '('
0005D5 23   
0005D6 CD      1409 CALL    EXPRI         	  	; Get the first parameter
0005D7 B7   
0005D8 18   
0005D9 D9      1410 EXX
0005DA E5      1411 PUSH	HL
0005DB CD      1412 CALL	COMMA			; Get the second parameter
0005DC 26   
0005DD 21   
0005DE CD      1413 CALL	EXPRI
0005DF B7   
0005E0 18   
0005E1 D9      1414 EXX
0005E2 D1      1415 POP	DE 			; DE: X coordinate
0005E3 CD      1416 CALL	BRAKET 			; Check for trailing bracket
0005E4 32   
0005E5 21   
0005E6 C3      1417 JP 	GETSCHR			; Read the character
0005E7 BD   
0005E8 01   
0005E9 1E      1421 OSLINE:			LD 	E, 1			; Default is to clear the buffer
0005EA 01   
0005EB FD      1430 OSLINE1:		PUSH	IY
0005EC E5   
0005ED E5      1431 PUSH	HL			; Buffer address
0005EE 01      1432 LD	BC, 256			; Buffer length
0005EF 00   
0005F0 01   
0005F1 3E    0001M1 LD	A, function
0005F2 09   
0005F3 49    0002M1 RST.LIS	08h
0005F4 CF   
0005F5 E1      1434 POP	HL			; Pop the address
0005F6 FD      1435 POP	IY
0005F7 E1   
0005F8 F5      1436 PUSH	AF			; Stack the return value (key pressed)
0005F9 CD      1437 CALL	NULLTOCR		; Turn the 0 character to a CR
0005FA 25   
0005FB 05   
0005FC CD      1438 CALL	CRLF			; Display CRLF
0005FD 7F   
0005FE 41   
0005FF F1      1439 POP	AF
000600 FE      1440 CP	1Bh 			; Check if ESC terminated the input
000601 1B   
000602 CA      1441 JP	Z, LTRAP1 		; Yes, so do the ESC thing
000603 3D   
000604 06   
000605 3A      1442 LD	A, (FLAGS)		; Otherwise
000606 00   
000607 52   
000608 CB      1443 RES	7, A 			; Clear the escape flag
000609 BF   
00060A 32      1444 LD	(FLAGS), A
00060B 00   
00060C 52   
00060D CD      1445 CALL	WAIT_VBLANK 		; Wait a frame
00060E 0F   
00060F 0B   
000610 AF      1446 XOR	A			; Return A = 0
000611 32      1447 LD	(KEYDOWN), A
000612 05   
000613 52   
000614 32      1448 LD	(KEYASCII), A
000615 06   
000616 52   
000617 C9      1449 RET
000618 E5      1455 ESCSET: 		PUSH    HL
000619 21      1456 LD      HL,FLAGS		; Pointer to FLAGS
00061A 00   
00061B 52   
00061C CB      1457 BIT     6,(HL)			; If bit 6 is set, then
00061D 76   
00061E 20      1458 JR      NZ,ESCDIS		; escape is disabled, so skip
00061F 02   
000620 CB      1459 SET     7,(HL)			; Set bit 7, the escape flag
000621 FE   
000622 E1      1460 ESCDIS: 		POP     HL
000623 C9      1461 RET
000624 CD      1467 ESCTEST:		CALL	READKEY			; Read the keyboard
000625 2D   
000626 06   
000627 C0      1468 RET	NZ			; Skip if no key is pressed
000628 FE      1469 CP	1BH			; If ESC pressed then
000629 1B   
00062A 28      1470 JR	Z,ESCSET		; jump to the escape set routine
00062B EC   
00062C C9      1471 RET
00062D 3A      1478 READKEY:		LD	A, (KEYDOWN)		; Get key down
00062E 05   
00062F 52   
000630 3D      1479 DEC	A 			; Set Z flag if keydown is 1
000631 3A      1480 LD	A, (KEYASCII)		; Get key ASCII value
000632 06   
000633 52   
000634 C9      1481 RET
000635 CD      1486 TRAP:			CALL	ESCTEST			; Read keyboard, test for ESC, set FLAGS
000636 24   
000637 06   
000638 3A      1488 LTRAP:			LD	A,(FLAGS)		; Get FLAGS
000639 00   
00063A 52   
00063B B7      1489 OR	A			; This checks for bit 7; if it is not set then the result will
00063C F0      1490 RET	P			; be positive (bit 7 is the sign bit in Z80), so return
00063D 21      1491 LTRAP1:			LD	HL,FLAGS 		; Escape is pressed at this point, so
00063E 00   
00063F 52   
000640 CB      1492 RES	7,(HL)			; Clear the escape pressed flag and
000641 BE   
000642 C3      1493 JP	ESCAPE			; Jump to the ESCAPE error routine in exec.asm
000643 67   
000644 26   
000645 C9      1497 RESET:			RET				; Yes this is fine
000646 0E      1508 OSOPEN:			LD	C, fa_read
000647 01   
000648 28      1509 JR	Z, @F
000649 06   
00064A 0E      1510 LD	C, fa_write | fa_open_append
00064B 32   
00064C 38      1511 JR	C, @F
00064D 02   
00064E 0E      1512 LD	C, fa_write | fa_create_always
00064F 0A   
000650 3E    0001M1 LD	A, function
000651 0A   
000652 49    0002M1 RST.LIS	08h
000653 CF   
000654 C9      1514 RET
000655 C5      1521 OSSHUT:			PUSH	BC
000656 4B      1522 LD	C, E
000657 3E    0001M1 LD	A, function
000658 0B   
000659 49    0002M1 RST.LIS	08h
00065A CF   
00065B C1      1524 POP	BC
00065C C9      1525 RET
00065D C5      1534 OSBGET:			PUSH	BC
00065E 4B      1535 LD	C, E
00065F 3E    0001M1 LD	A, function
000660 0C   
000661 49    0002M1 RST.LIS	08h
000662 CF   
000663 C1      1537 POP	BC
000664 C9      1538 RET
000665 C5      1545 OSBPUT:			PUSH	BC
000666 4B      1546 LD	C, E
000667 47      1547 LD	B, A
000668 3E    0001M1 LD	A, function
000669 0D   
00066A 49    0002M1 RST.LIS	08h
00066B CF   
00066C C1      1549 POP	BC
00066D C9      1550 RET
00066E C5      1559 OSSTAT:			PUSH	BC
00066F 4B      1560 LD	C, E
000670 3E    0001M1 LD	A, function
000671 0E   
000672 49    0002M1 RST.LIS	08h
000673 CF   
000674 C1      1562 POP	BC
000675 FE      1563 CP	1
000676 01   
000677 C9      1564 RET
000678 FD      1572 GETPTR:			PUSH		IY
000679 E5   
00067A 4B      1573 LD		C, E
00067B 3E    0001M1 LD	A, function
00067C 19   
00067D 49    0002M1 RST.LIS	08h
00067E CF   
00067F 5B      1575 PUSH.LIL	HL
000680 E5   
000681 5B      1576 POP.LIL		IY		; IYU: Pointer to FIL structure
000682 FD   
000683 E1   
000684 5B      1577 LD.LIL		L, (IY + FIL.fptr + 0)
000685 FD   
000686 6E   
000687 11   
000688 5B      1578 LD.LIL		H, (IY + FIL.fptr + 1)
000689 FD   
00068A 66   
00068B 12   
00068C 5B      1579 LD.LIL		E, (IY + FIL.fptr + 2)
00068D FD   
00068E 5E   
00068F 13   
000690 5B      1580 LD.LIL		D, (IY + FIL.fptr + 3)
000691 FD   
000692 56   
000693 14   
000694 FD      1581 POP		IY
000695 E1   
000696 C9      1582 RET
000697 FD      1589 PUTPTR:			PUSH		IY
000698 E5   
000699 4F      1590 LD		C, A  		; C: Filehandle
00069A 5B      1591 PUSH.LIL	HL
00069B E5   
00069C 5B      1592 LD.LIL		HL, 2
00069D 21   
00069E 02   
00069F 00   
0006A0 00   
0006A1 5B      1593 ADD.LIL		HL, SP
0006A2 39   
0006A3 5B      1594 LD.LIL		(HL), E 	; 3rd byte of DWORD set to E
0006A4 73   
0006A5 5B      1595 POP.LIL		HL
0006A6 E1   
0006A7 5A      1596 LD		E, D  		; 4th byte passed as E
0006A8 3E    0001M1 LD	A, function
0006A9 1C   
0006AA 49    0002M1 RST.LIS	08h
0006AB CF   
0006AC FD      1598 POP		IY
0006AD E1   
0006AE C9      1599 RET
0006AF FD      1607 GETEXT:			PUSH		IY
0006B0 E5   
0006B1 4B      1608 LD		C, E
0006B2 3E    0001M1 LD	A, function
0006B3 19   
0006B4 49    0002M1 RST.LIS	08h
0006B5 CF   
0006B6 5B      1610 PUSH.LIL	HL
0006B7 E5   
0006B8 5B      1611 POP.LIL		IY		; IYU: Pointer to FIL structure
0006B9 FD   
0006BA E1   
0006BB 5B      1612 LD.LIL		L, (IY + FFOBJID.objsize + 0)
0006BC FD   
0006BD 6E   
0006BE 0B   
0006BF 5B      1613 LD.LIL		H, (IY + FFOBJID.objsize + 1)
0006C0 FD   
0006C1 66   
0006C2 0C   
0006C3 5B      1614 LD.LIL		E, (IY + FFOBJID.objsize + 2)
0006C4 FD   
0006C5 5E   
0006C6 0D   
0006C7 5B      1615 LD.LIL		D, (IY + FFOBJID.objsize + 3)
0006C8 FD   
0006C9 56   
0006CA 0E   
0006CB FD      1616 POP		IY
0006CC E1   
0006CD C9      1617 RET
0006CE C5      1626 OSLOAD:			PUSH	BC			; Stack the size
0006CF D5      1627 PUSH	DE			; Stack the load address
0006D0 11      1628 LD	DE, ACCS		; Buffer address for filename
0006D1 00   
0006D2 53   
0006D3 CD      1629 CALL	CSTR_FNAME		; Fetch filename from MOS into buffer
0006D4 3D   
0006D5 05   
0006D6 21      1630 LD	HL, ACCS		; HL: Filename
0006D7 00   
0006D8 53   
0006D9 CD      1631 CALL	EXT_DEFAULT		; Tack on the extension .BBC if not specified
0006DA 17   
0006DB 08   
0006DC CD      1632 CALL	EXT_HANDLER		; Get the default handler
0006DD 28   
0006DE 08   
0006DF D1      1633 POP	DE			; Restore the load address
0006E0 C1      1634 POP	BC			; Restore the size
0006E1 B7      1635 OR	A
0006E2 CA      1636 JP 	Z, OSLOAD_BBC
0006E3 A9   
0006E4 07   
0006E5 AF      1640 OSLOAD_TXT:		XOR	A			; Set file attributes to read
0006E6 CD      1641 CALL	OSOPEN			; Open the file
0006E7 46   
0006E8 06   
0006E9 5F      1642 LD 	E, A 			; The filehandle
0006EA B7      1643 OR	A
0006EB 3E      1644 LD	A, 4			; File not found error
0006EC 04   
0006ED CA      1645 JP	Z, OSERROR		; Jump to error handler
0006EE B1   
0006EF 07   
0006F0 CD      1646 CALL	NEWIT			; Call NEW to clear the program space
0006F1 C2   
0006F2 40   
0006F3 21      1648 OSLOAD_TXT1:		LD	HL, ACCS 		; Where the input is going to be stored
0006F4 00   
0006F5 53   
0006F6 CD      1652 @@:			CALL	OSBGET			; Read the byte into A
0006F7 5D   
0006F8 06   
0006F9 38      1653 JR	C, OSLOAD_TXT3		; Is it EOF?
0006FA 1C   
0006FB FE      1654 CP	LF 			; Is it LF?
0006FC 0A   
0006FD 28      1655 JR	Z, OSLOAD_TXT3 		; Yes, so skip to the next line
0006FE 18   
0006FF FE      1656 CP	21h			; Is it less than or equal to ASCII space?
000700 21   
000701 38      1657 JR	C, @B 			; Yes, so keep looping
000702 F3   
000703 77      1658 LD	(HL), A 		; Store the first character
000704 2C      1659 INC	L
000705 CD      1663 OSLOAD_TXT2:		CALL	OSBGET			; Read the byte into A
000706 5D   
000707 06   
000708 38      1664 JR	C, OSLOAD_TXT4		; Is it EOF?
000709 26   
00070A FE      1665 CP	20h			; Skip if not an ASCII character
00070B 20   
00070C 38      1666 JR	C, @F
00070D 05   
00070E 77      1667 LD	(HL), A 		; Store in the input buffer
00070F 2C      1668 INC	L			; Increment the buffer pointer
000710 CA      1669 JP	Z, BAD			; If the buffer is full (wrapped to 0) then jump to Bad Program error
000711 73   
000712 3F   
000713 FE      1670 @@:			CP	LF			; Check for LF
000714 0A   
000715 20      1671 JR	NZ, OSLOAD_TXT2		; If not, then loop to read the rest of the characters in
000716 EE   
000717 36      1675 OSLOAD_TXT3:		LD	(HL), CR		; Store a CR for BBC BASIC
000718 0D   
000719 7D      1676 LD	A, L			; Check for minimum line length
00071A FE      1677 CP	2			; If it is 2 characters or less (including CR)
00071B 02   
00071C 38      1678 JR	C, @F			; Then don't bother entering it
00071D 08   
00071E D5      1679 PUSH	DE			; Preserve the filehandle
00071F CD      1680 CALL	OSEDIT			; Enter the line in memory
000720 3B   
000721 07   
000722 DC      1681 CALL	C,CLEAN			; If a new line has been entered, then call CLEAN to set TOP and write &FFFF end of program marker
000723 9E   
000724 40   
000725 D1      1682 POP	DE
000726 CD      1683 @@:			CALL	OSSTAT			; End of file?
000727 6E   
000728 06   
000729 20      1684 JR	NZ, OSLOAD_TXT1		; No, so loop
00072A C8   
00072B CD      1685 CALL	OSSHUT			; Close the file
00072C 55   
00072D 06   
00072E 37      1686 SCF				; Flag to BASIC that we're good
00072F C9      1687 RET
000730 FE      1691 OSLOAD_TXT4:		CP	20h			; Skip if not an ASCII character
000731 20   
000732 38      1692 JR	C, @F
000733 05   
000734 77      1693 LD	(HL), A			; Store the character
000735 2C      1694 INC	L
000736 CA      1695 JP	Z, BAD
000737 73   
000738 3F   
000739 18      1696 @@:			JR	OSLOAD_TXT3
00073A DC   
00073B AF      1703 OSEDIT:			XOR	A			; Entry point after *EDIT
00073C 32      1704 LD      (COUNT),A
00073D FB   
00073E 55   
00073F FD      1705 LD      IY,ACCS
000740 21   
000741 00   
000742 53   
000743 CD      1706 CALL    LINNUM			; HL: The line number from the input buffer
000744 0E   
000745 44   
000746 CD      1707 CALL    NXT			; Skip spaces
000747 8F   
000748 45   
000749 7C      1708 LD      A,H			; HL: The line number will be 0 for immediate mode or when auto line numbering is used
00074A B5      1709 OR      L
00074B 28      1710 JR      Z,LNZERO        	; Skip if there is no line number in the input buffer
00074C 00   
00074D 11      1714 LNZERO:			LD	DE,BUFFER
00074E 00   
00074F 54   
000750 0E      1715 LD	C,1			; LEFT MODE
000751 01   
000752 E5      1716 PUSH	HL
000753 CD      1717 CALL	LEXAN2			; LEXICAL ANALYSIS
000754 9C   
000755 44   
000756 E1      1718 POP	HL
000757 12      1719 LD	(DE),A			; TERMINATOR
000758 AF      1720 XOR	A
000759 47      1721 LD	B,A
00075A 4B      1722 LD	C,E			; BC=LINE LENGTH
00075B 13      1723 INC	DE
00075C 12      1724 LD	(DE),A			; ZERO NEXT
00075D 7C      1725 LD	A,H
00075E B5      1726 OR	L
00075F FD      1727 LD	IY,BUFFER		; FOR XEQ
000760 21   
000761 00   
000762 54   
000763 CA      1728 JP	Z,XEQ			; DIRECT MODE
000764 1D   
000765 25   
000766 C5      1729 PUSH	BC
000767 CD      1730 CALL	FINDL
000768 C7   
000769 41   
00076A CC      1731 CALL	Z,DEL
00076B 6D   
00076C 40   
00076D C1      1732 POP	BC
00076E 79      1733 LD	A,C
00076F B7      1734 OR	A
000770 C8      1735 RET	Z
000771 C6      1736 ADD	A,4
000772 04   
000773 4F      1737 LD	C,A			; LENGTH INCLUSIVE
000774 D5      1738 PUSH	DE			; LINE NUMBER
000775 C5      1739 PUSH	BC			; SAVE LINE LENGTH
000776 EB      1740 EX	DE,HL
000777 C5      1741 PUSH	BC
000778 CD      1742 CALL	GETTOP
000779 A9   
00077A 40   
00077B C1      1743 POP	BC
00077C E5      1744 PUSH	HL
00077D 09      1745 ADD	HL,BC
00077E E5      1746 PUSH	HL
00077F 24      1747 INC	H
000780 AF      1748 XOR	A
000781 ED      1749 SBC	HL,SP
000782 72   
000783 E1      1750 POP	HL
000784 D2      1751 JP	NC,ERROR_		; "No room"
000785 C8   
000786 3F   
000787 E3      1752 EX	(SP),HL
000788 E5      1753 PUSH	HL
000789 23      1754 INC	HL
00078A B7      1755 OR	A
00078B ED      1756 SBC	HL,DE
00078C 52   
00078D 44      1757 LD	B,H			; BC=AMOUNT TO MOVE
00078E 4D      1758 LD	C,L
00078F E1      1759 POP	HL
000790 D1      1760 POP	DE
000791 28      1761 JR	Z,ATENDos
000792 02   
000793 ED      1762 LDDR				; MAKE SPACE
000794 B8   
000795 C1      1763 ATENDos:          	POP	BC			; LINE LENGTH
000796 D1      1764 POP	DE			; LINE NUMBER
000797 23      1765 INC	HL
000798 71      1766 LD	(HL),C			; STORE LENGTH
000799 23      1767 INC	HL
00079A 73      1768 LD	(HL),E			; STORE LINE NUMBER
00079B 23      1769 INC	HL
00079C 72      1770 LD	(HL),D
00079D 23      1771 INC	HL
00079E 11      1772 LD	DE,BUFFER
00079F 00   
0007A0 54   
0007A1 EB      1773 EX	DE,HL
0007A2 0D      1774 DEC	C
0007A3 0D      1775 DEC	C
0007A4 0D      1776 DEC	C
0007A5 ED      1777 LDIR				; ADD LINE
0007A6 B0   
0007A7 37      1778 SCF
0007A8 C9      1779 RET
0007A9 3E    0001M1 LD	A, function
0007AA 01   
0007AB 49    0002M1 RST.LIS	08h
0007AC CF   
0007AD D0      1784 RET	NC			; If load returns with carry reset - NO ROOM
0007AE B7      1785 OR	A			; If there is no error (A=0)
0007AF 37      1786 SCF				; Need to set carry indicating there was room
0007B0 C8      1787 RET	Z			; Return
0007B1 F5      1789 OSERROR:		PUSH	AF			; Handle the MOS error
0007B2 21      1790 LD	HL, ACCS		; Address of the buffer
0007B3 00   
0007B4 53   
0007B5 01      1791 LD	BC, 256			; Length of the buffer
0007B6 00   
0007B7 01   
0007B8 5F      1792 LD	E, A			; The error code
0007B9 3E    0001M1 LD	A, function
0007BA 0F   
0007BB 49    0002M1 RST.LIS	08h
0007BC CF   
0007BD F1      1794 POP	AF
0007BE E5      1795 PUSH	HL			; Stack the address of the error (now in ACCS)
0007BF C6      1796 ADD	A, 127			; Add 127 to the error code (MOS errors start at 128, and are trappable)
0007C0 7F   
0007C1 C3      1797 JP	EXTERR			; Trigger an external error
0007C2 D9   
0007C3 3F   
0007C4 C5      1805 OSSAVE:			PUSH	BC			; Stack the size
0007C5 D5      1806 PUSH	DE			; Stack the save address
0007C6 11      1807 LD	DE, ACCS		; Buffer address for filename
0007C7 00   
0007C8 53   
0007C9 CD      1808 CALL	CSTR_FNAME		; Fetch filename from MOS into buffer
0007CA 3D   
0007CB 05   
0007CC 21      1809 LD	HL, ACCS		; HL: Filename
0007CD 00   
0007CE 53   
0007CF CD      1810 CALL	EXT_DEFAULT		; Tack on the extension .BBC if not specified
0007D0 17   
0007D1 08   
0007D2 CD      1811 CALL	EXT_HANDLER		; Get the default handler
0007D3 28   
0007D4 08   
0007D5 D1      1812 POP	DE			; Restore the save address
0007D6 C1      1813 POP	BC			; Restore the size
0007D7 B7      1814 OR	A			; Is the extension .BBC
0007D8 28      1815 JR	Z, OSSAVE_BBC		; Yes, so use that
0007D9 35   
0007DA 3A      1819 OSSAVE_TXT:		LD 	A, (OSWRCHCH)		; Stack the current channel
0007DB 03   
0007DC 52   
0007DD F5      1820 PUSH	AF
0007DE AF      1821 XOR	A
0007DF 3C      1822 INC	A			; Make sure C is clear, A is 1, for OPENOUT
0007E0 32      1823 LD	(OSWRCHCH), A
0007E1 03   
0007E2 52   
0007E3 CD      1824 CALL	OSOPEN			; Open the file
0007E4 46   
0007E5 06   
0007E6 32      1825 LD	(OSWRCHFH), A		; Store the file handle for OSWRCH
0007E7 04   
0007E8 52   
0007E9 DD      1826 LD	IX, LISTON		; Required for LISTIT
0007EA 21   
0007EB FE   
0007EC 55   
0007ED 2A      1827 LD	HL, (PAGE_)		; Get start of program area
0007EE DC   
0007EF 55   
0007F0 D9      1828 EXX
0007F1 01      1829 LD	BC, 0			; Set the initial indent counters
0007F2 00   
0007F3 00   
0007F4 D9      1830 EXX
0007F5 7E      1831 OSSAVE_TXT1:		LD	A, (HL)			; Check for end of program marker
0007F6 B7      1832 OR	A
0007F7 28      1833 JR	Z, OSSAVE_TXT2
0007F8 0A   
0007F9 23      1834 INC	HL			; Skip the length byte
0007FA 5E      1835 LD	E, (HL)			; Get the line number
0007FB 23      1836 INC	HL
0007FC 56      1837 LD	D, (HL)
0007FD 23      1838 INC	HL
0007FE CD      1839 CALL	LISTIT			; List the line
0007FF E1   
000800 40   
000801 18      1840 JR	OSSAVE_TXT1
000802 F2   
000803 3A      1841 OSSAVE_TXT2:		LD	A, (OSWRCHFH)		; Get the file handle
000804 04   
000805 52   
000806 5F      1842 LD	E, A
000807 CD      1843 CALL	OSSHUT			; Close it
000808 55   
000809 06   
00080A F1      1844 POP	AF			; Restore the channel
00080B 32      1845 LD	(OSWRCHCH), A
00080C 03   
00080D 52   
00080E C9      1846 RET
00080F 3E    0001M1 LD	A, function
000810 02   
000811 49    0002M1 RST.LIS	08h
000812 CF   
000813 B7      1851 OR	A			; If there is no error (A=0)
000814 C8      1852 RET	Z			; Just return
000815 18      1853 JR	OSERROR			; Trip an error
000816 9A   
000817 E5      1859 EXT_DEFAULT:		PUSH	HL			; Stack the filename pointer
000818 0E      1860 LD	C, '.'			; Search for dot (marks start of extension)
000819 2E   
00081A CD      1861 CALL	CSTR_FINDCH
00081B 5D   
00081C 05   
00081D B7      1862 OR	A			; Check for end of string marker
00081E 20      1863 JR	NZ, @F			; No, so skip as we have an extension at this point
00081F 06   
000820 11      1864 LD	DE, EXT_LOOKUP		; Get the first (default extension)
000821 54   
000822 08   
000823 CD      1865 CALL	CSTR_CAT		; Concat it to string pointed to by HL
000824 73   
000825 05   
000826 E1      1866 @@:			POP	HL			; Restore the filename pointer
000827 C9      1867 RET
000828 E5      1874 EXT_HANDLER:		PUSH	HL			; Stack the filename pointer
000829 0E      1875 LD	C, '.'			; Find the '.'
00082A 2E   
00082B CD      1876 CALL	CSTR_FINDCH
00082C 5D   
00082D 05   
00082E 11      1877 LD	DE, EXT_LOOKUP		; The lookup table
00082F 54   
000830 08   
000831 E5      1879 EXT_HANDLER_1:		PUSH	HL			; Stack the pointer to the extension
000832 CD      1880 CALL	CSTR_ENDSWITH		; Check whether the string ends with the entry in the lookup
000833 65   
000834 05   
000835 E1      1881 POP	HL			; Restore the pointer to the extension
000836 28      1882 JR	Z, EXT_HANDLER_2	; We have a match!
000837 18   
000838 1A      1884 @@:			LD	A, (DE)			; Skip to the end of the entry in the lookup
000839 13      1885 INC	DE
00083A B7      1886 OR	A
00083B 20      1887 JR	NZ, @B
00083C FB   
00083D 13      1888 INC	DE			; Skip the file extension # byte
00083E 1A      1890 LD	A, (DE)			; Are we at the end of the table?
00083F B7      1891 OR	A
000840 20      1892 JR	NZ, EXT_HANDLER_1	; No, so loop
000841 EF   
000842 3E      1894 LD      A,204			; Throw a "Bad name" error
000843 CC   
000844 CD      1895 CALL    EXTERR
000845 D9   
000846 3F   
000847 42      1896 DB    	"Bad name", 0
000848 61   
000849 64   
00084A 20   
00084B 6E   
00084C 61   
00084D 6D   
00084E 65   
00084F 00   
000850 13      1898 EXT_HANDLER_2:		INC	DE			; Skip to the file extension # byte
000851 1A      1899 LD	A, (DE)
000852 E1      1900 POP	HL			; Restore the filename pointer
000853 C9      1901 RET
000854 2E      1908 EXT_LOOKUP:		DB	".BBC", 0, 0		; First entry is the default extension
000855 42   
000856 42   
000857 43   
000858 00   
000859 00   
00085A 2E      1909 DB	".TXT", 0, 1
00085B 54   
00085C 58   
00085D 54   
00085E 00   
00085F 01   
000860 2E      1910 DB	".ASC", 0, 1
000861 41   
000862 53   
000863 43   
000864 00   
000865 01   
000866 2E      1911 DB	".BAS", 0, 1
000867 42   
000868 41   
000869 53   
00086A 00   
00086B 01   
00086C 00      1912 DB	0			; End of table
00086D FE      1915 OSWORD:			CP	01H			; GETIME
00086E 01   
00086F 28      1916 JR	Z, OSWORD_01
000870 1D   
000871 FE      1917 CP	02H			; PUTIME
000872 02   
000873 28      1918 JR	Z, OSWORD_02
000874 2F   
000875 FE      1919 CP	0EH			; GETIMS
000876 0E   
000877 28      1920 JR	Z, OSWORD_0E
000878 4F   
000879 FE      1921 CP	0FH			; PUTIMS
00087A 0F   
00087B 28      1922 JR	Z, @F
00087C 10   
00087D FE      1923 CP	07H			; SOUND
00087E 07   
00087F CA      1925 JP Z, SOUND_ ; REALTIVE JUMP TOO FAR
000880 22   
000881 0B   
000882 FE      1926 CP	08H			; ENVELOPE
000883 08   
000884 28      1927 JR	Z, @F
000885 07   
000886 FE      1928 CP	09H			; POINT
000887 09   
000888 28      1929 JR	Z, OSWORD_09
000889 30   
00088A C3      1930 JP	HUH			; Anything else trips an error
00088B F5   
00088C 08   
00088D C9      1931 @@:			RET				; Dummy return for unimplemented functions
00088E DD      1935 OSWORD_01:		PUSH 	IX
00088F E5   
000890 3E    0001M1 LD	A, function
000891 08   
000892 49    0002M1 RST.LIS	08h
000893 CF   
000894 06      1937 LD	B, 4
000895 04   
000896 5B      1938 @@:			LD.LIL	A, (IX + sysvar_time)
000897 DD   
000898 7E   
000899 00   
00089A 77      1939 LD	(HL), A
00089B 23      1940 INC	HL
00089C 5B      1941 INC.LIL	IX
00089D DD   
00089E 23   
00089F 10      1942 DJNZ 	@B
0008A0 F5   
0008A1 DD      1943 POP	IX
0008A2 E1   
0008A3 C9      1944 RET
0008A4 DD      1948 OSWORD_02:		PUSH 	IX
0008A5 E5   
0008A6 3E    0001M1 LD	A, function
0008A7 08   
0008A8 49    0002M1 RST.LIS	08h
0008A9 CF   
0008AA 06      1950 LD	B, 4
0008AB 04   
0008AC 7E      1951 @@:			LD	A, (HL)
0008AD 5B      1952 LD.LIL 	(IX + sysvar_time), A
0008AE DD   
0008AF 77   
0008B0 00   
0008B1 23      1953 INC	HL
0008B2 5B      1954 INC.LIL IX
0008B3 DD   
0008B4 23   
0008B5 10      1955 DJNZ 	@B
0008B6 F5   
0008B7 DD      1956 POP	IX
0008B8 E1   
0008B9 C9      1957 RET
0008BA ED      1976 OSWORD_09:		LD	DE,(SCRAP+0)
0008BB 5B   
0008BC 08   
0008BD 52   
0008BE 2A      1977 LD	HL,(SCRAP+2)
0008BF 0A   
0008C0 52   
0008C1 CD      1978 CALL	POINT_
0008C2 FA   
0008C3 01   
0008C4 32      1979 LD	(SCRAP+4),A
0008C5 0C   
0008C6 52   
0008C7 C9      1980 RET
0008C8 FD      1984 OSWORD_0E:		PUSH	IY
0008C9 E5   
0008CA 3E    0001M1 LD	A, function
0008CB 12   
0008CC 49    0002M1 RST.LIS	08h
0008CD CF   
0008CE FD      1986 POP	IY
0008CF E1   
0008D0 C9      1987 RET
0008D1 FE      1996 OSBYTE:			CP	0BH			; Keyboard auto-repeat delay
0008D2 0B   
0008D3 28      1997 JR	Z, OSBYTE_0B
0008D4 31   
0008D5 FE      1998 CP	0CH			; Keyboard auto-repeat rate
0008D6 0C   
0008D7 28      1999 JR	Z, OSBYTE_0C
0008D8 54   
0008D9 FE      2000 CP	13H			; Wait for vblank
0008DA 13   
0008DB 28      2001 JR	Z, OSBYTE_13
0008DC 77   
0008DD FE      2002 CP	76H			; Set keyboard LED
0008DE 76   
0008DF 28      2003 JR	Z, OSBYTE_76
0008E0 7B   
0008E1 FE      2004 CP	81H			; Read the keyboard
0008E2 81   
0008E3 CA      2005 JP	Z, OSBYTE_81
0008E4 84   
0008E5 09   
0008E6 FE      2006 CP	86H			; Get cursor coordinates
0008E7 86   
0008E8 CA      2007 JP	Z, OSBYTE_86
0008E9 DD   
0008EA 09   
0008EB FE      2008 CP	87H			; Fetch current mode and character under cursor
0008EC 87   
0008ED CA      2009 JP	Z, OSBYTE_87
0008EE 09   
0008EF 0A   
0008F0 FE      2010 CP	A0H			; Fetch system variable
0008F1 A0   
0008F2 CA      2011 JP	Z, OSBYTE_A0
0008F3 1F   
0008F4 0A   
0008F5 3E      2015 HUH:    		LD      A,254			; Bad command error
0008F6 FE   
0008F7 CD      2016 CALL    EXTERR
0008F8 D9   
0008F9 3F   
0008FA 42      2017 DB    	"Bad command"
0008FB 61   
0008FC 64   
0008FD 20   
0008FE 63   
0008FF 6F   
000900 6D   
000901 6D   
000902 61   
000903 6E   
000904 64   
000905 00      2018 DEFB    0
000906 3E    0001M1 LD      A, VAL
000907 17   
000908 CD    0002M1 CALL    OSWRCH
000909 97   
00090A 05   
00090B 3E    0001M1 LD      A, VAL
00090C 00   
00090D CD    0002M1 CALL    OSWRCH
00090E 97   
00090F 05   
000910 3E    0001M1 LD      A, VAL
000911 88   
000912 CD    0002M1 CALL    OSWRCH
000913 97   
000914 05   
000915 7D    0001M1 LD      A, VAL
000916 CD    0002M1 CALL    OSWRCH
000917 97   
000918 05   
000919 7C    0001M1 LD      A, VAL
00091A CD    0002M1 CALL    OSWRCH
00091B 97   
00091C 05   
00091D 3E    0001M1 LD      A, VAL
00091E 00   
00091F CD    0002M1 CALL    OSWRCH
000920 97   
000921 05   
000922 3E    0001M1 LD      A, VAL
000923 00   
000924 CD    0002M1 CALL    OSWRCH
000925 97   
000926 05   
000927 3E    0001M1 LD      A, VAL
000928 FF   
000929 CD    0002M1 CALL    OSWRCH
00092A 97   
00092B 05   
00092C C9      2032 RET
00092D 3E    0001M1 LD      A, VAL
00092E 17   
00092F CD    0002M1 CALL    OSWRCH
000930 97   
000931 05   
000932 3E    0001M1 LD      A, VAL
000933 00   
000934 CD    0002M1 CALL    OSWRCH
000935 97   
000936 05   
000937 3E    0001M1 LD      A, VAL
000938 88   
000939 CD    0002M1 CALL    OSWRCH
00093A 97   
00093B 05   
00093C 3E    0001M1 LD      A, VAL
00093D 00   
00093E CD    0002M1 CALL    OSWRCH
00093F 97   
000940 05   
000941 3E    0001M1 LD      A, VAL
000942 00   
000943 CD    0002M1 CALL    OSWRCH
000944 97   
000945 05   
000946 7D    0001M1 LD      A, VAL
000947 CD    0002M1 CALL    OSWRCH
000948 97   
000949 05   
00094A 7C    0001M1 LD      A, VAL
00094B CD    0002M1 CALL    OSWRCH
00094C 97   
00094D 05   
00094E 3E    0001M1 LD      A, VAL
00094F FF   
000950 CD    0002M1 CALL    OSWRCH
000951 97   
000952 05   
000953 C9      2046 RET
000954 CD      2050 OSBYTE_13:		CALL	WAIT_VBLANK
000955 0F   
000956 0B   
000957 2E      2051 LD	L, 0			; Returns 0
000958 00   
000959 C3      2052 JP	COUNT0
00095A D2   
00095B 1B   
00095C 3E    0001M1 LD      A, VAL
00095D 17   
00095E CD    0002M1 CALL    OSWRCH
00095F 97   
000960 05   
000961 3E    0001M1 LD      A, VAL
000962 00   
000963 CD    0002M1 CALL    OSWRCH
000964 97   
000965 05   
000966 3E    0001M1 LD      A, VAL
000967 88   
000968 CD    0002M1 CALL    OSWRCH
000969 97   
00096A 05   
00096B 3E    0001M1 LD      A, VAL
00096C 00   
00096D CD    0002M1 CALL    OSWRCH
00096E 97   
00096F 05   
000970 3E    0001M1 LD      A, VAL
000971 00   
000972 CD    0002M1 CALL    OSWRCH
000973 97   
000974 05   
000975 3E    0001M1 LD      A, VAL
000976 00   
000977 CD    0002M1 CALL    OSWRCH
000978 97   
000979 05   
00097A 3E    0001M1 LD      A, VAL
00097B 00   
00097C CD    0002M1 CALL    OSWRCH
00097D 97   
00097E 05   
00097F 7D    0001M1 LD      A, VAL
000980 CD    0002M1 CALL    OSWRCH
000981 97   
000982 05   
000983 C9      2066 RET
000984 D9      2077 OSBYTE_81:		EXX
000985 CB      2078 BIT 	7, H 			; Check for minus numbers
000986 7C   
000987 D9      2079 EXX
000988 20      2080 JR	NZ, OSBYTE_81_1		; Yes, so do INKEY(-n)
000989 1C   
00098A CD      2081 CALL	READKEY			; Read the keyboard
00098B 2D   
00098C 06   
00098D 28      2082 JR	Z, @F 			; Skip if we have a key
00098E 09   
00098F CD      2083 CALL	WAIT_VBLANK 		; Wait a frame
000990 0F   
000991 0B   
000992 7C      2084 LD	A, H 			; Check loop counter
000993 B5      2085 OR 	L
000994 2B      2086 DEC 	HL			; Decrement
000995 20      2087 JR	NZ, OSBYTE_81		; And loop
000996 ED   
000997 C9      2088 RET 				; H: Will be set to 255 to flag timeout
000998 21      2090 @@:			LD	HL, KEYDOWN		; We have a key, so
000999 05   
00099A 52   
00099B 36      2091 LD	(HL), 0			; clear the keydown flag
00099C 00   
00099D FE      2092 CP	1BH			; If we are pressing ESC,
00099E 1B   
00099F CA      2093 JP	Z, ESCSET 		; Then handle ESC
0009A0 18   
0009A1 06   
0009A2 26      2094 LD	H, 0			; H: Not timed out
0009A3 00   
0009A4 6F      2095 LD	L, A			; L: The character
0009A5 C9      2096 RET
0009A6 3E    0001M1 LD	A, function
0009A7 1E   
0009A8 49    0002M1 RST.LIS	08h
0009A9 CF   
0009AA 23      2103 INC	HL			; Index from 0
0009AB 7D      2104 LD	A, L			; Negate the LSB of the answer
0009AC ED      2105 NEG
0009AD 44   
0009AE 4F      2106 LD	C, A			;  E: The positive keycode value
0009AF 3E      2107 LD	A, 1			; Throw an "Out of range" error
0009B0 01   
0009B1 FA      2108 JP	M, ERROR_		; if the argument < - 128
0009B2 C8   
0009B3 3F   
0009B4 21      2110 LD	HL, BITLOOKUP		; HL: The bit lookup table
0009B5 D5   
0009B6 09   
0009B7 11      2111 LD	DE, 0
0009B8 00   
0009B9 00   
0009BA 79      2112 LD	A, C
0009BB E6      2113 AND	00000111b		; Just need the first three bits
0009BC 07   
0009BD 5F      2114 LD	E, A			; DE: The bit number
0009BE 19      2115 ADD	HL, DE
0009BF 46      2116 LD	B, (HL)			;  B: The mask
0009C0 79      2118 LD	A, C			; Fetch the keycode again
0009C1 E6      2119 AND	01111000b		; And divide by 8
0009C2 78   
0009C3 0F      2120 RRCA
0009C4 0F      2121 RRCA
0009C5 0F      2122 RRCA
0009C6 5F      2123 LD	E, A			; DE: The offset (the MSW has already been cleared previously)
0009C7 5B      2124 ADD.LIL	IX, DE			; IX: The address
0009C8 DD   
0009C9 19   
0009CA 5B      2125 LD.LIL	A, (IX+0)		;  A: The keypress
0009CB DD   
0009CC 7E   
0009CD 00   
0009CE A0      2126 AND	B			; Check whether the bit is set
0009CF CA      2127 JP	Z, ZERO			; No, so return 0
0009D0 7C   
0009D1 20   
0009D2 C3      2128 JP	TRUEev			; Otherwise return -1
0009D3 41   
0009D4 1C   
0009D5 01      2132 BITLOOKUP:		DB	01h, 02h, 04h, 08h
0009D6 02   
0009D7 04   
0009D8 08   
0009D9 10      2133 DB	10h, 20h, 40h, 80h
0009DA 20   
0009DB 40   
0009DC 80   
0009DD DD      2140 OSBYTE_86:		PUSH	IX			; Get the system vars in IX
0009DE E5   
0009DF 3E    0001M1 LD	A, function
0009E0 08   
0009E1 49    0002M1 RST.LIS	08h
0009E2 CF   
0009E3 5B      2142 RES.LIL	0, (IX+sysvar_vpd_pflags)
0009E4 DD   
0009E5 CB   
0009E6 04   
0009E7 86   
0009E8 3E    0001M1 LD      A, VAL
0009E9 17   
0009EA CD    0002M1 CALL    OSWRCH
0009EB 97   
0009EC 05   
0009ED 3E    0001M1 LD      A, VAL
0009EE 00   
0009EF CD    0002M1 CALL    OSWRCH
0009F0 97   
0009F1 05   
0009F2 3E    0001M1 LD      A, VAL
0009F3 82   
0009F4 CD    0002M1 CALL    OSWRCH
0009F5 97   
0009F6 05   
0009F7 5B      2146 @@:			BIT.LIL	0, (IX+sysvar_vpd_pflags)
0009F8 DD   
0009F9 CB   
0009FA 04   
0009FB 46   
0009FC 28      2147 JR	Z, @B			; Wait for the result
0009FD F9   
0009FE 5B      2148 LD.LIL	L, (IX + sysvar_cursorX)
0009FF DD   
000A00 6E   
000A01 07   
000A02 5B      2149 LD.LIL	H, (IX + sysvar_cursorY)
000A03 DD   
000A04 66   
000A05 08   
000A06 DD      2150 POP	IX
000A07 E1   
000A08 C9      2151 RET
000A09 DD      2155 OSBYTE_87:		PUSH	IX
000A0A E5   
000A0B CD      2156 CALL	GETCSR			; Get the current screen position
000A0C 2D   
000A0D 0E   
000A0E CD      2157 CALL	GETSCHR			; Read character from screen
000A0F BD   
000A10 01   
000A11 6F      2158 LD	L, A
000A12 3E    0001M1 LD	A, function
000A13 08   
000A14 49    0002M1 RST.LIS	08h
000A15 CF   
000A16 5B      2160 LD.LIL	H, (IX+sysvar_scrMode)	; H: Screen mode
000A17 DD   
000A18 66   
000A19 27   
000A1A DD      2161 POP	IX
000A1B E1   
000A1C C3      2162 JP	COUNT1
000A1D D4   
000A1E 1B   
000A1F DD      2168 OSBYTE_A0:		PUSH	IX
000A20 E5   
000A21 3E    0001M1 LD	A, function
000A22 08   
000A23 49    0002M1 RST.LIS	08h
000A24 CF   
000A25 5B      2170 LD.LIL	BC, 0
000A26 01   
000A27 00   
000A28 00   
000A29 00   
000A2A 4D      2171 LD	C, L			; BCU = L
000A2B 5B      2172 ADD.LIL	IX, BC			; Add to IX
000A2C DD   
000A2D 09   
000A2E 5B      2173 LD.LIL	L, (IX + 0)		; Fetch the return value
000A2F DD   
000A30 6E   
000A31 00   
000A32 DD      2174 POP	IX
000A33 E1   
000A34 C3      2175 JP 	COUNT0
000A35 D2   
000A36 1B   
000A37 CD      2182 OSCLI: 			CALL    SKIPSP
000A38 91   
000A39 0A   
000A3A FE      2183 CP      CR
000A3B 0D   
000A3C C8      2184 RET     Z
000A3D FE      2185 CP      '|'
000A3E 7C   
000A3F C8      2186 RET     Z
000A40 EB      2187 EX      DE,HL
000A41 21      2188 LD      HL,COMDS
000A42 A0   
000A43 0A   
000A44 1A      2189 OSCLI0:			LD      A,(DE)
000A45 CD      2190 CALL    UPPRC
000A46 98   
000A47 0A   
000A48 BE      2191 CP      (HL)
000A49 28      2192 JR      Z,OSCLI2
000A4A 0B   
000A4B 38      2193 JR      C,OSCLI6
000A4C 2E   
000A4D CB      2194 OSCLI1:			BIT     7,(HL)
000A4E 7E   
000A4F 23      2195 INC     HL
000A50 28      2196 JR      Z,OSCLI1
000A51 FB   
000A52 23      2197 INC     HL
000A53 23      2198 INC     HL
000A54 18      2199 JR      OSCLI0
000A55 EE   
000A56 D5      2201 OSCLI2:			PUSH    DE
000A57 13      2202 OSCLI3:			INC     DE
000A58 23      2203 INC     HL
000A59 1A      2204 LD      A,(DE)
000A5A CD      2205 CALL    UPPRC
000A5B 98   
000A5C 0A   
000A5D FE      2206 CP      '.'			; ABBREVIATED?
000A5E 2E   
000A5F 28      2207 JR      Z,OSCLI4
000A60 0A   
000A61 AE      2208 XOR     (HL)
000A62 28      2209 JR      Z,OSCLI3
000A63 F3   
000A64 FE      2210 CP      80H
000A65 80   
000A66 28      2211 JR      Z,OSCLI4
000A67 03   
000A68 D1      2212 POP     DE
000A69 18      2213 JR      OSCLI1
000A6A E2   
000A6B F1      2215 OSCLI4:			POP     AF
000A6C 13      2216 INC     DE
000A6D CB      2217 OSCLI5:			BIT     7,(HL)
000A6E 7E   
000A6F 23      2218 INC     HL
000A70 28      2219 JR      Z,OSCLI5
000A71 FB   
000A72 7E      2220 LD      A,(HL)
000A73 23      2221 INC     HL
000A74 66      2222 LD      H,(HL)
000A75 6F      2223 LD      L,A
000A76 E5      2224 PUSH    HL
000A77 EB      2225 EX      DE,HL
000A78 C3      2226 JP      SKIPSP
000A79 91   
000A7A 0A   
000A7B EB      2228 OSCLI6:			EX	DE, HL			; HL: Buffer for command
000A7C 11      2229 LD	DE, ACCS		; Buffer for command string is ACCS (the string accumulator)
000A7D 00   
000A7E 53   
000A7F D5      2230 PUSH	DE			; Store buffer address
000A80 CD      2231 CALL	CSTR_LINE		; Fetch the line
000A81 4F   
000A82 05   
000A83 E1      2232 POP	HL			; HL: Pointer to command string in ACCS
000A84 FD      2233 PUSH	IY
000A85 E5   
000A86 3E    0001M1 LD	A, function
000A87 10   
000A88 49    0002M1 RST.LIS	08h
000A89 CF   
000A8A FD      2235 POP	IY
000A8B E1   
000A8C B7      2236 OR	A			; 0 means MOS returned OK
000A8D C8      2237 RET	Z			; So don't do anything
000A8E C3      2238 JP 	OSERROR			; Otherwise it's a MOS error
000A8F B1   
000A90 07   
000A91 7E      2240 SKIPSP:			LD      A,(HL)
000A92 FE      2241 CP      ' '
000A93 20   
000A94 C0      2242 RET     NZ
000A95 23      2243 INC     HL
000A96 18      2244 JR      SKIPSP
000A97 F9   
000A98 E6      2246 UPPRC:  		AND     7FH
000A99 7F   
000A9A FE      2247 CP      '`'
000A9B 60   
000A9C D8      2248 RET     C
000A9D E6      2249 AND     5FH			; CONVERT TO UPPER CASE
000A9E 5F   
000A9F C9      2250 RET
000AA0 42      2255 COMDS:  		DB	"BY",'E'+80h		; BYE
000AA1 59   
000AA2 C5   
000AA3 B0      2256 DW	BYE
000AA4 0A   
000AA5 45      2257 DB	"EDI",'T'+80h		; EDIT
000AA6 44   
000AA7 49   
000AA8 D4   
000AA9 BB      2258 DW	STAR_EDIT
000AAA 0A   
000AAB 46      2259 DB	'F','X'+80h		; FX
000AAC D8   
000AAD F7      2260 DW	STAR_FX
000AAE 0A   
000AAF FF      2263 DB	FFh
000AB0 CD      2267 BYE:			CALL	VBLANK_STOP		; Restore MOS interrupts
000AB1 48   
000AB2 04   
000AB3 5B      2268 POP.LIL	IX 			; The return address to init
000AB4 DD   
000AB5 E1   
000AB6 21      2269 LD	HL, 0			; The return code
000AB7 00   
000AB8 00   
000AB9 DD      2270 JP	(IX)
000ABA E9   
000ABB CD      2274 STAR_EDIT:		CALL	ASC_TO_NUMBER		; DE: Line number to edit
000ABC BE   
000ABD 04   
000ABE EB      2275 EX	DE, HL			; HL: Line number
000ABF CD      2276 CALL	FINDL			; HL: Address in RAM of tokenised line
000AC0 C7   
000AC1 41   
000AC2 3E      2277 LD	A, 41			; F:NZ If the line is not found
000AC3 29   
000AC4 C2      2278 JP	NZ, ERROR_		; Do error 41: No such line in that case
000AC5 C8   
000AC6 3F   
000AC7 23      2282 INC	HL			; Skip the length byte
000AC8 5E      2283 LD	E, (HL)			; Fetch the line number
000AC9 23      2284 INC	HL
000ACA 56      2285 LD	D, (HL)
000ACB 23      2286 INC	HL
000ACC DD      2287 LD	IX, ACCS		; Pointer to where the copy is to be stored
000ACD 21   
000ACE 00   
000ACF 53   
000AD0 DD      2288 LD	(OSWRCHPT), IX
000AD1 22   
000AD2 01   
000AD3 52   
000AD4 DD      2289 LD	IX, LISTON		; Pointer to LISTON variable in RAM
000AD5 21   
000AD6 FE   
000AD7 55   
000AD8 DD      2290 LD	A, (IX)			; Store that variable
000AD9 7E   
000ADA 00   
000ADB F5      2291 PUSH	AF
000ADC DD      2292 LD	(IX), 09h		; Set to echo to buffer
000ADD 36   
000ADE 00   
000ADF 09   
000AE0 CD      2293 CALL	LISTIT
000AE1 E1   
000AE2 40   
000AE3 F1      2294 POP	AF
000AE4 DD      2295 LD	(IX), A			; Restore the original LISTON variable
000AE5 77   
000AE6 00   
000AE7 21      2296 LD	HL, ACCS		; HL: ACCS
000AE8 00   
000AE9 53   
000AEA 5D      2297 LD	E, L			;  E: 0 - Don't clear the buffer; ACCS is on a page boundary so L is 0
000AEB CD      2298 CALL	OSLINE1			; Invoke the editor
000AEC EB   
000AED 05   
000AEE CD      2299 CALL	OSEDIT
000AEF 3B   
000AF0 07   
000AF1 DC      2300 CALL    C,CLEAN			; Set TOP, write out &FFFF end of program marker
000AF2 9E   
000AF3 40   
000AF4 C3      2301 JP      CLOOP			; Jump back to immediate mode
000AF5 34   
000AF6 38   
000AF7 CD      2305 STAR_FX:		CALL	ASC_TO_NUMBER
000AF8 BE   
000AF9 04   
000AFA 4B      2306 LD	C, E			; C: Save FX #
000AFB CD      2307 CALL	ASC_TO_NUMBER
000AFC BE   
000AFD 04   
000AFE 7A      2308 LD	A, D  			; Is first parameter > 255?
000AFF B7      2309 OR 	A
000B00 28      2310 JR	Z, STAR_FX1		; Yes, so skip next bit
000B01 03   
000B02 EB      2311 EX	DE, HL 			; Parameter is 16-bit
000B03 18      2312 JR	STAR_FX2
000B04 06   
000B05 43      2314 STAR_FX1:		LD	B, E 			; B: Save First parameter
000B06 CD      2315 CALL	ASC_TO_NUMBER		; Fetch second parameter
000B07 BE   
000B08 04   
000B09 68      2316 LD	L, B 			; L: First parameter
000B0A 63      2317 LD	H, E 			; H: Second parameter
000B0B 79      2319 STAR_FX2:		LD	A, C 			; A: FX #
000B0C C3      2320 JP	OSBYTE
000B0D D1   
000B0E 08   
000B0F DD      2324 WAIT_VBLANK:		PUSH 	IX			; Wait for VBLANK interrupt
000B10 E5   
000B11 3E    0001M1 LD	A, function
000B12 08   
000B13 49    0002M1 RST.LIS	08h
000B14 CF   
000B15 5B      2326 LD.LIL	A, (IX + sysvar_time + 0)
000B16 DD   
000B17 7E   
000B18 00   
000B19 5B      2327 @@:			CP.LIL 	A, (IX + sysvar_time + 0)
000B1A DD   
000B1B BE   
000B1C 00   
000B1D 28      2328 JR	Z, @B
000B1E FA   
000B1F DD      2329 POP	IX
000B20 E1   
000B21 C9      2330 RET; --- End agon_os.asm ---
000B22             2332   ; --- Begin agon_sound.asm ---
000B22 7E      2365 SOUND_:			LD	A, (HL)			; Channel
000B23 32      2366 LD	(VDU_BUFFER+0), A
000B24 00   
000B25 53   
000B26 AF      2367 XOR	A			; Waveform
000B27 32      2368 LD	(VDU_BUFFER+1), A
000B28 01   
000B29 53   
000B2A 23      2369 INC	HL
000B2B 23      2370 INC	HL
000B2C 4E      2374 LD	C, (HL)			; Volume
000B2D 06      2375 LD	B, 6			; C already contains the volume
000B2E 06   
000B2F ED      2376 MLT	BC			; Multiply by 6 (0-15 scales to 0-90)
000B30 4C   
000B31 79      2377 LD	A, C
000B32 32      2378 LD	(VDU_BUFFER+2), A
000B33 02   
000B34 53   
000B35 23      2379 INC	HL
000B36 23      2380 INC	HL
000B37 E5      2384 PUSH	HL
000B38 6E      2385 LD	L, (HL)
000B39 26      2386 LD	H, 0
000B3A 00   
000B3B 11      2387 LD	DE, SOUND_FREQ_LOOKUP
000B3C AD   
000B3D 0B   
000B3E 29      2388 ADD	HL, HL
000B3F 19      2389 ADD	HL, DE
000B40 7E      2390 LD	A, (HL)
000B41 32      2391 LD	(VDU_BUFFER+3), A
000B42 03   
000B43 53   
000B44 23      2392 INC	HL
000B45 7E      2393 LD	A, (HL)
000B46 32      2394 LD	(VDU_BUFFER+4), A
000B47 04   
000B48 53   
000B49 E1      2395 POP	HL
000B4A 23      2396 INC	HL
000B4B 23      2397 INC	HL
000B4C 4E      2401 LD	C, (HL)
000B4D 06      2402 LD	B, 50			; C contains the duration, so MLT by 50
000B4E 32   
000B4F ED      2403 MLT	BC
000B50 4C   
000B51 ED      2404 LD	(VDU_BUFFER+5), BC
000B52 43   
000B53 05   
000B54 53   
000B55 DD      2406 PUSH	IX			; Get the system vars in IX
000B56 E5   
000B57 3E    0001M1 LD	A, function
000B58 08   
000B59 49    0002M1 RST.LIS	08h
000B5A CF   
000B5B 5B      2408 SOUND0:			RES.LIL	3, (IX+sysvar_vpd_pflags)
000B5C DD   
000B5D CB   
000B5E 04   
000B5F 9E   
000B60 3E    0001M1 LD      A, VAL
000B61 17   
000B62 CD    0002M1 CALL    OSWRCH
000B63 97   
000B64 05   
000B65 3E    0001M1 LD      A, VAL
000B66 00   
000B67 CD    0002M1 CALL    OSWRCH
000B68 97   
000B69 05   
000B6A 3E    0001M1 LD      A, VAL
000B6B 85   
000B6C CD    0002M1 CALL    OSWRCH
000B6D 97   
000B6E 05   
000B6F 3A    0001M1 LD      A, VAL
000B70 00   
000B71 53   
000B72 CD    0002M1 CALL    OSWRCH
000B73 97   
000B74 05   
000B75 3A    0001M1 LD      A, VAL
000B76 01   
000B77 53   
000B78 CD    0002M1 CALL    OSWRCH
000B79 97   
000B7A 05   
000B7B 3A    0001M1 LD      A, VAL
000B7C 02   
000B7D 53   
000B7E CD    0002M1 CALL    OSWRCH
000B7F 97   
000B80 05   
000B81 3A    0001M1 LD      A, VAL
000B82 03   
000B83 53   
000B84 CD    0002M1 CALL    OSWRCH
000B85 97   
000B86 05   
000B87 3A    0001M1 LD      A, VAL
000B88 04   
000B89 53   
000B8A CD    0002M1 CALL    OSWRCH
000B8B 97   
000B8C 05   
000B8D 3A    0001M1 LD      A, VAL
000B8E 05   
000B8F 53   
000B90 CD    0002M1 CALL    OSWRCH
000B91 97   
000B92 05   
000B93 3A    0001M1 LD      A, VAL
000B94 06   
000B95 53   
000B96 CD    0002M1 CALL    OSWRCH
000B97 97   
000B98 05   
000B99 5B      2423 @@:			BIT.LIL	3, (IX+sysvar_vpd_pflags)
000B9A DD   
000B9B CB   
000B9C 04   
000B9D 5E   
000B9E 28      2424 JR	Z, @B			; Wait for the result
000B9F F9   
000BA0 CD      2425 CALL	LTRAP			; Check for ESC
000BA1 38   
000BA2 06   
000BA3 5B      2426 LD.LIL	A, (IX+sysvar_audioSuccess)
000BA4 DD   
000BA5 7E   
000BA6 0E   
000BA7 A7      2427 AND	A			; Check if VDP has queued the note
000BA8 28      2428 JR	Z, SOUND0		; No, so loop back and send again
000BA9 B1   
000BAA DD      2430 POP	IX
000BAB E1   
000BAC C9      2431 RET
000BAD 75      2455 SOUND_FREQ_LOOKUP:	DW	 117,  118,  120,  122,  123,  131,  133,  135
000BAE 00   
000BAF 76   
000BB0 00   
000BB1 78   
000BB2 00   
000BB3 7A   
000BB4 00   
000BB5 7B   
000BB6 00   
000BB7 83   
000BB8 00   
000BB9 85   
000BBA 00   
000BBB 87   
000BBC 00   
000BBD 89      2456 DW	 137,  139,  141,  143,  145,  147,  149,  151
000BBE 00   
000BBF 8B   
000BC0 00   
000BC1 8D   
000BC2 00   
000BC3 8F   
000BC4 00   
000BC5 91   
000BC6 00   
000BC7 93   
000BC8 00   
000BC9 95   
000BCA 00   
000BCB 97   
000BCC 00   
000BCD 99      2457 DW	 153,  156,  158,  160,  162,  165,  167,  170
000BCE 00   
000BCF 9C   
000BD0 00   
000BD1 9E   
000BD2 00   
000BD3 A0   
000BD4 00   
000BD5 A2   
000BD6 00   
000BD7 A5   
000BD8 00   
000BD9 A7   
000BDA 00   
000BDB AA   
000BDC 00   
000BDD AC      2458 DW	 172,  175,  177,  180,  182,  185,  188,  190
000BDE 00   
000BDF AF   
000BE0 00   
000BE1 B1   
000BE2 00   
000BE3 B4   
000BE4 00   
000BE5 B6   
000BE6 00   
000BE7 B9   
000BE8 00   
000BE9 BC   
000BEA 00   
000BEB BE   
000BEC 00   
000BED C1      2459 DW	 193,  196,  199,  202,  205,  208,  211,  214
000BEE 00   
000BEF C4   
000BF0 00   
000BF1 C7   
000BF2 00   
000BF3 CA   
000BF4 00   
000BF5 CD   
000BF6 00   
000BF7 D0   
000BF8 00   
000BF9 D3   
000BFA 00   
000BFB D6   
000BFC 00   
000BFD D9      2460 DW	 217,  220,  223,  226,  230,  233,  236,  240
000BFE 00   
000BFF DC   
000C00 00   
000C01 DF   
000C02 00   
000C03 E2   
000C04 00   
000C05 E6   
000C06 00   
000C07 E9   
000C08 00   
000C09 EC   
000C0A 00   
000C0B F0   
000C0C 00   
000C0D F3      2461 DW	 243,  247,  251,  254,  258,  262,  265,  269
000C0E 00   
000C0F F7   
000C10 00   
000C11 FB   
000C12 00   
000C13 FE   
000C14 00   
000C15 02   
000C16 01   
000C17 06   
000C18 01   
000C19 09   
000C1A 01   
000C1B 0D   
000C1C 01   
000C1D 11      2462 DW	 273,  277,  281,  285,  289,  294,  298,  302
000C1E 01   
000C1F 15   
000C20 01   
000C21 19   
000C22 01   
000C23 1D   
000C24 01   
000C25 21   
000C26 01   
000C27 26   
000C28 01   
000C29 2A   
000C2A 01   
000C2B 2E   
000C2C 01   
000C2D 33      2463 DW	 307,  311,  316,  320,  325,  330,  334,  339
000C2E 01   
000C2F 37   
000C30 01   
000C31 3C   
000C32 01   
000C33 40   
000C34 01   
000C35 45   
000C36 01   
000C37 4A   
000C38 01   
000C39 4E   
000C3A 01   
000C3B 53   
000C3C 01   
000C3D 58      2464 DW	 344,  349,  354,  359,  365,  370,  375,  381
000C3E 01   
000C3F 5D   
000C40 01   
000C41 62   
000C42 01   
000C43 67   
000C44 01   
000C45 6D   
000C46 01   
000C47 72   
000C48 01   
000C49 77   
000C4A 01   
000C4B 7D   
000C4C 01   
000C4D 82      2465 DW	 386,  392,  398,  403,  409,  415,  421,  427
000C4E 01   
000C4F 88   
000C50 01   
000C51 8E   
000C52 01   
000C53 93   
000C54 01   
000C55 99   
000C56 01   
000C57 9F   
000C58 01   
000C59 A5   
000C5A 01   
000C5B AB   
000C5C 01   
000C5D B2      2466 DW	 434,  440,  446,  453,  459,  466,  473,  480
000C5E 01   
000C5F B8   
000C60 01   
000C61 BE   
000C62 01   
000C63 C5   
000C64 01   
000C65 CB   
000C66 01   
000C67 D2   
000C68 01   
000C69 D9   
000C6A 01   
000C6B E0   
000C6C 01   
000C6D E7      2467 DW	 487,  494,  501,  508,  516,  523,  531,  539
000C6E 01   
000C6F EE   
000C70 01   
000C71 F5   
000C72 01   
000C73 FC   
000C74 01   
000C75 04   
000C76 02   
000C77 0B   
000C78 02   
000C79 13   
000C7A 02   
000C7B 1B   
000C7C 02   
000C7D 22      2468 DW	 546,  554,  562,  571,  579,  587,  596,  605
000C7E 02   
000C7F 2A   
000C80 02   
000C81 32   
000C82 02   
000C83 3B   
000C84 02   
000C85 43   
000C86 02   
000C87 4B   
000C88 02   
000C89 54   
000C8A 02   
000C8B 5D   
000C8C 02   
000C8D 65      2469 DW	 613,  622,  631,  641,  650,  659,  669,  679
000C8E 02   
000C8F 6E   
000C90 02   
000C91 77   
000C92 02   
000C93 81   
000C94 02   
000C95 8A   
000C96 02   
000C97 93   
000C98 02   
000C99 9D   
000C9A 02   
000C9B A7   
000C9C 02   
000C9D B1      2470 DW	 689,  699,  709,  719,  729,  740,  751,  762
000C9E 02   
000C9F BB   
000CA0 02   
000CA1 C5   
000CA2 02   
000CA3 CF   
000CA4 02   
000CA5 D9   
000CA6 02   
000CA7 E4   
000CA8 02   
000CA9 EF   
000CAA 02   
000CAB FA   
000CAC 02   
000CAD 05      2471 DW	 773,  784,  795,  807,  819,  831,  843,  855
000CAE 03   
000CAF 10   
000CB0 03   
000CB1 1B   
000CB2 03   
000CB3 27   
000CB4 03   
000CB5 33   
000CB6 03   
000CB7 3F   
000CB8 03   
000CB9 4B   
000CBA 03   
000CBB 57   
000CBC 03   
000CBD 63      2472 DW	 867,  880,  893,  906,  919,  932,  946,  960
000CBE 03   
000CBF 70   
000CC0 03   
000CC1 7D   
000CC2 03   
000CC3 8A   
000CC4 03   
000CC5 97   
000CC6 03   
000CC7 A4   
000CC8 03   
000CC9 B2   
000CCA 03   
000CCB C0   
000CCC 03   
000CCD CE      2473 DW	 974,  988, 1002, 1017, 1032, 1047, 1062, 1078
000CCE 03   
000CCF DC   
000CD0 03   
000CD1 EA   
000CD2 03   
000CD3 F9   
000CD4 03   
000CD5 08   
000CD6 04   
000CD7 17   
000CD8 04   
000CD9 26   
000CDA 04   
000CDB 36   
000CDC 04   
000CDD 45      2474 DW	1093, 1109, 1125, 1142, 1158, 1175, 1192, 1210
000CDE 04   
000CDF 55   
000CE0 04   
000CE1 65   
000CE2 04   
000CE3 76   
000CE4 04   
000CE5 86   
000CE6 04   
000CE7 97   
000CE8 04   
000CE9 A8   
000CEA 04   
000CEB BA   
000CEC 04   
000CED CB      2475 DW	1227, 1245, 1263, 1282, 1300, 1319, 1338, 1358
000CEE 04   
000CEF DD   
000CF0 04   
000CF1 EF   
000CF2 04   
000CF3 02   
000CF4 05   
000CF5 14   
000CF6 05   
000CF7 27   
000CF8 05   
000CF9 3A   
000CFA 05   
000CFB 4E   
000CFC 05   
000CFD 62      2476 DW	1378, 1398, 1418, 1439, 1459, 1481, 1502, 1524
000CFE 05   
000CFF 76   
000D00 05   
000D01 8A   
000D02 05   
000D03 9F   
000D04 05   
000D05 B3   
000D06 05   
000D07 C9   
000D08 05   
000D09 DE   
000D0A 05   
000D0B F4   
000D0C 05   
000D0D 0A      2477 DW	1546, 1569, 1592, 1615, 1638, 1662, 1686, 1711
000D0E 06   
000D0F 21   
000D10 06   
000D11 38   
000D12 06   
000D13 4F   
000D14 06   
000D15 66   
000D16 06   
000D17 7E   
000D18 06   
000D19 96   
000D1A 06   
000D1B AF   
000D1C 06   
000D1D C8      2478 DW	1736, 1761, 1786, 1812, 1839, 1866, 1893, 1920
000D1E 06   
000D1F E1   
000D20 06   
000D21 FA   
000D22 06   
000D23 14   
000D24 07   
000D25 2F   
000D26 07   
000D27 4A   
000D28 07   
000D29 65   
000D2A 07   
000D2B 80   
000D2C 07   
000D2D 9C      2479 DW	1948, 1976, 2005, 2034, 2064, 2093, 2123, 2154
000D2E 07   
000D2F B8   
000D30 07   
000D31 D5   
000D32 07   
000D33 F2   
000D34 07   
000D35 10   
000D36 08   
000D37 2D   
000D38 08   
000D39 4B   
000D3A 08   
000D3B 6A   
000D3C 08   
000D3D 8A      2480 DW	2186, 2217, 2250, 2282, 2316, 2349, 2383, 2418
000D3E 08   
000D3F A9   
000D40 08   
000D41 CA   
000D42 08   
000D43 EA   
000D44 08   
000D45 0C   
000D46 09   
000D47 2D   
000D48 09   
000D49 4F   
000D4A 09   
000D4B 72   
000D4C 09   
000D4D 95      2481 DW	2453, 2489, 2525, 2562, 2599, 2637, 2675, 2714
000D4E 09   
000D4F B9   
000D50 09   
000D51 DD   
000D52 09   
000D53 02   
000D54 0A   
000D55 27   
000D56 0A   
000D57 4D   
000D58 0A   
000D59 73   
000D5A 0A   
000D5B 9A   
000D5C 0A   
000D5D C2      2482 DW	2754, 2794, 2834, 2876, 2918, 2960, 3003, 3047
000D5E 0A   
000D5F EA   
000D60 0A   
000D61 12   
000D62 0B   
000D63 3C   
000D64 0B   
000D65 66   
000D66 0B   
000D67 90   
000D68 0B   
000D69 BB   
000D6A 0B   
000D6B E7   
000D6C 0B   
000D6D 13      2483 DW	3091, 3136, 3182, 3228, 3275, 3322, 3371, 3420
000D6E 0C   
000D6F 40   
000D70 0C   
000D71 6E   
000D72 0C   
000D73 9C   
000D74 0C   
000D75 CB   
000D76 0C   
000D77 FA   
000D78 0C   
000D79 2B   
000D7A 0D   
000D7B 5C   
000D7C 0D   
000D7D 8E      2484 DW	3470, 3520, 3571, 3623, 3676, 3729, 3784, 3839
000D7E 0D   
000D7F C0   
000D80 0D   
000D81 F3   
000D82 0D   
000D83 27   
000D84 0E   
000D85 5C   
000D86 0E   
000D87 91   
000D88 0E   
000D89 C8   
000D8A 0E   
000D8B FF   
000D8C 0E   
000D8D 36      2485 DW	3894, 3951, 4009, 4067, 4126, 4186, 4247, 4309
000D8E 0F   
000D8F 6F   
000D90 0F   
000D91 A9   
000D92 0F   
000D93 E3   
000D94 0F   
000D95 1E   
000D96 10   
000D97 5A   
000D98 10   
000D99 97   
000D9A 10   
000D9B D5   
000D9C 10   
000D9D 13      2486 DW	4371, 4435, 4499, 4565, 4631, 4699, 4767, 4836
000D9E 11   
000D9F 53   
000DA0 11   
000DA1 93   
000DA2 11   
000DA3 D5   
000DA4 11   
000DA5 17   
000DA6 12   
000DA7 5B   
000DA8 12   
000DA9 9F   
000DAA 12   
000DAB E4   
000DAC 12   
000DAD             2489   ; --- Begin acorn.asm ---
000DAD 3E      2571 GETIME:         LD	A,1
000DAE 01   
000DAF 21      2572 LD	HL,SCRAP
000DB0 08   
000DB1 52   
000DB2 CD      2573 CALL	OSWORD
000DB3 6D   
000DB4 08   
000DB5 21      2574 LD	HL,SCRAP
000DB6 08   
000DB7 52   
000DB8 5E      2575 LD	E,(HL)
000DB9 23      2576 INC	HL
000DBA 56      2577 LD	D,(HL)
000DBB 23      2578 INC	HL
000DBC 7E      2579 LD	A,(HL)
000DBD 23      2580 INC	HL
000DBE 66      2581 LD	H,(HL)
000DBF 6F      2582 LD	L,A
000DC0 EB      2583 EX	DE,HL
000DC1 C9      2584 RET
000DC2 3E      2591 GETIMS:         LD	A,14
000DC3 0E   
000DC4 21      2592 LD	HL,SCRAP
000DC5 08   
000DC6 52   
000DC7 36      2593 LD	(HL),0
000DC8 00   
000DC9 CD      2594 CALL	OSWORD
000DCA 6D   
000DCB 08   
000DCC 21      2595 LD	HL,SCRAP
000DCD 08   
000DCE 52   
000DCF 11      2596 LD	DE,ACCS
000DD0 00   
000DD1 53   
000DD2 7E      2597 LD	A,(HL)
000DD3 BB      2598 CP	E
000DD4 C8      2599 RET	Z
000DD5 01      2600 LD	BC,25
000DD6 19   
000DD7 00   
000DD8 ED      2601 LDIR
000DD9 B0   
000DDA C9      2602 RET
000DDB DD      2609 PUTIME:         PUSH	IX
000DDC E5   
000DDD DD      2610 LD	IX,SCRAP
000DDE 21   
000DDF 08   
000DE0 52   
000DE1 DD      2611 LD	(IX+0),L
000DE2 75   
000DE3 00   
000DE4 DD      2612 LD	(IX+1),H
000DE5 74   
000DE6 01   
000DE7 DD      2613 LD	(IX+2),E
000DE8 73   
000DE9 02   
000DEA DD      2614 LD	(IX+3),D
000DEB 72   
000DEC 03   
000DED 3E      2615 LD	A,2
000DEE 02   
000DEF 21      2616 LD	HL,SCRAP
000DF0 08   
000DF1 52   
000DF2 CD      2617 CALL	OSWORD
000DF3 6D   
000DF4 08   
000DF5 DD      2618 POP	IX
000DF6 E1   
000DF7 C9      2619 RET
000DF8 7B      2626 PUTIMS:         LD	A,E		;Length
000DF9 FE      2627 CP	26
000DFA 1A   
000DFB D0      2628 RET	NC
000DFC 06      2629 LD	B,0
000DFD 00   
000DFE 4F      2630 LD	C,A
000DFF 11      2631 LD	DE,SCRAP+1
000E00 09   
000E01 52   
000E02 21      2632 LD	HL,ACCS
000E03 00   
000E04 53   
000E05 ED      2633 LDIR
000E06 B0   
000E07 21      2634 LD	HL,SCRAP
000E08 08   
000E09 52   
000E0A 77      2635 LD	(HL),A
000E0B 3E      2636 LD	A,15
000E0C 0F   
000E0D C3      2637 JP	OSWORD
000E0E 6D   
000E0F 08   
000E10 3E      2643 CLRSCN:         LD	A,0CH
000E11 0C   
000E12 C3      2644 JP	OSWRCH
000E13 97   
000E14 05   
000E15 3E      2653 OSKEY:          LD	A,129
000E16 81   
000E17 CD      2654 CALL	OSBYTE
000E18 D1   
000E19 08   
000E1A 7C      2655 LD	A,H
000E1B B7      2656 OR	A
000E1C C0      2657 RET	NZ		;TIME-OUT, CARRY RESET
000E1D 7D      2658 LD	A,L
000E1E 37      2659 SCF
000E1F C9      2660 RET			;NORMAL, CARRY SET
000E20 3E      2667 PUTCSR:         LD	A,1FH
000E21 1F   
000E22 CD      2668 CALL	OSWRCH
000E23 97   
000E24 05   
000E25 7B      2669 LD	A,E
000E26 CD      2670 CALL	OSWRCH
000E27 97   
000E28 05   
000E29 7D      2671 LD	A,L
000E2A C3      2672 JP	OSWRCH
000E2B 97   
000E2C 05   
000E2D 3E      2679 GETCSR:         LD	A,134
000E2E 86   
000E2F CD      2680 CALL	OSBYTE
000E30 D1   
000E31 08   
000E32 5D      2681 LD	E,L
000E33 6C      2682 LD	L,H
000E34 16      2683 LD	D,0
000E35 00   
000E36 62      2684 LD	H,D
000E37 C9      2685 RET
000E38 CD      2689 POINT:          CALL	EXPRI
000E39 B7   
000E3A 18   
000E3B D9      2690 EXX
000E3C E5      2691 PUSH	HL
000E3D CD      2692 CALL	CEXPRI
000E3E 75   
000E3F 11   
000E40 D9      2693 EXX
000E41 D1      2694 POP	DE
000E42 CD      2695 CALL	BRAKET
000E43 32   
000E44 21   
000E45 DD      2696 LD	IX,SCRAP
000E46 21   
000E47 08   
000E48 52   
000E49 DD      2697 LD	(IX+0),E
000E4A 73   
000E4B 00   
000E4C DD      2698 LD	(IX+1),D
000E4D 72   
000E4E 01   
000E4F DD      2699 LD	(IX+2),L
000E50 75   
000E51 02   
000E52 DD      2700 LD	(IX+3),H
000E53 74   
000E54 03   
000E55 21      2701 LD	HL,SCRAP
000E56 08   
000E57 52   
000E58 3E      2702 LD	A,9
000E59 09   
000E5A CD      2703 CALL	OSWORD
000E5B 6D   
000E5C 08   
000E5D DD      2704 LD	A,(IX+4)
000E5E 7E   
000E5F 04   
000E60 6F      2705 LD	L,A
000E61 C6      2706 ADD	A,1
000E62 01   
000E63 9F      2707 SBC	A,A
000E64 67      2708 LD	H,A
000E65 D9      2709 RETEXX:         EXX
000E66 67      2710 LD	H,A
000E67 6F      2711 LD	L,A
000E68 AF      2712 XOR	A
000E69 4F      2713 LD	C,A
000E6A C9      2714 RET
000E6B CD      2718 ADVAL:          CALL	ITEMI
000E6C E4   
000E6D 18   
000E6E D9      2719 EXX
000E6F 3E      2720 LD	A,128
000E70 80   
000E71 CD      2721 CALL	OSBYTE
000E72 D1   
000E73 08   
000E74 AF      2722 XOR	A
000E75 18      2723 JR	RETEXX
000E76 EE   
000E77 3E      2727 MODEFN:         LD	A,135
000E78 87   
000E79 CD      2728 CALL	OSBYTE
000E7A D1   
000E7B 08   
000E7C 6C      2729 LD	L,H
000E7D AF      2730 RETU8:          XOR	A
000E7E 67      2731 LD	H,A
000E7F 18      2732 JR	RETEXX
000E80 E4   
000E81 3A      2736 WIDFN:          LD	A,(WIDTH)
000E82 FC   
000E83 55   
000E84 6F      2737 LD	L,A
000E85 18      2738 JR	RETU8
000E86 F6   
000E87 06      2743 ENVEL:          LD	B,0
000E88 00   
000E89 DD      2744 LD	IX,SCRAP
000E8A 21   
000E8B 08   
000E8C 52   
000E8D C5      2745 PUSH	BC
000E8E DD      2746 PUSH	IX
000E8F E5   
000E90 CD      2747 ENVEL1:         CALL	EXPRI
000E91 B7   
000E92 18   
000E93 D9      2748 EXX
000E94 DD      2749 POP	IX
000E95 E1   
000E96 C1      2750 POP	BC
000E97 DD      2751 LD	(IX),L
000E98 75   
000E99 00   
000E9A 78      2752 LD	A,B
000E9B FE      2753 CP	13
000E9C 0D   
000E9D 28      2754 JR	Z,ENVEL2
000E9E 0B   
000E9F 04      2755 INC	B
000EA0 DD      2756 INC	IX
000EA1 23   
000EA2 C5      2757 PUSH	BC
000EA3 DD      2758 PUSH	IX
000EA4 E5   
000EA5 CD      2759 CALL	COMMA
000EA6 26   
000EA7 21   
000EA8 18      2760 JR	ENVEL1
000EA9 E6   
000EAA 21      2761 ENVEL2:         LD	HL,SCRAP
000EAB 08   
000EAC 52   
000EAD 3E      2762 LD	A,8
000EAE 08   
000EAF CD      2763 CALL	OSWORD
000EB0 6D   
000EB1 08   
000EB2 C3      2764 JP	XEQ
000EB3 1D   
000EB4 25   
000EB5 06      2768 SOUND:          LD	B,0
000EB6 00   
000EB7 DD      2769 LD	IX,SCRAP
000EB8 21   
000EB9 08   
000EBA 52   
000EBB C5      2770 PUSH	BC
000EBC DD      2771 PUSH	IX
000EBD E5   
000EBE CD      2772 SOUND1:         CALL	EXPRI
000EBF B7   
000EC0 18   
000EC1 D9      2773 EXX
000EC2 DD      2774 POP	IX
000EC3 E1   
000EC4 C1      2775 POP	BC
000EC5 DD      2776 LD	(IX+0),L
000EC6 75   
000EC7 00   
000EC8 DD      2777 LD	(IX+1),H
000EC9 74   
000ECA 01   
000ECB DD      2778 INC	IX
000ECC 23   
000ECD DD      2779 INC	IX
000ECE 23   
000ECF 04      2780 INC	B
000ED0 04      2781 INC	B
000ED1 78      2782 LD	A,B
000ED2 FE      2783 CP	8
000ED3 08   
000ED4 28      2784 JR	Z,SOUND2
000ED5 08   
000ED6 C5      2785 PUSH	BC
000ED7 DD      2786 PUSH	IX
000ED8 E5   
000ED9 CD      2787 CALL	COMMA
000EDA 26   
000EDB 21   
000EDC 18      2788 JR	SOUND1
000EDD E0   
000EDE 21      2789 SOUND2:         LD	HL,SCRAP
000EDF 08   
000EE0 52   
000EE1 3E      2790 LD	A,7
000EE2 07   
000EE3 CD      2791 CALL	OSWORD
000EE4 6D   
000EE5 08   
000EE6 C3      2792 JP	XEQ
000EE7 1D   
000EE8 25   
000EE9 CD      2796 MODE:           CALL	EXPRI
000EEA B7   
000EEB 18   
000EEC AF      2797 XOR	A
000EED 32      2798 LD	(COUNT),A
000EEE FB   
000EEF 55   
000EF0 D9      2799 EXX
000EF1 65      2800 LD	H,L
000EF2 2E      2801 LD	L,22
000EF3 16   
000EF4 CD      2802 CALL	WRCH2
000EF5 5C   
000EF6 11   
000EF7 18      2803 JR	XEQGO1
000EF8 72   
000EF9 3E      2807 CLG:            LD	A,16
000EFA 10   
000EFB CD      2808 CALL	OSWRCH
000EFC 97   
000EFD 05   
000EFE 18      2809 JR	XEQGO1
000EFF 6B   
000F00 CD      2813 ORIGIN:         CALL    EXPRI
000F01 B7   
000F02 18   
000F03 D9      2814 EXX
000F04 E5      2815 PUSH	HL
000F05 CD      2816 CALL    CEXPRI
000F06 75   
000F07 11   
000F08 D9      2817 EXX
000F09 D1      2818 POP	DE
000F0A 0E      2819 LD	C,29
000F0B 1D   
000F0C CD      2820 CALL	WRCH5
000F0D 50   
000F0E 11   
000F0F 18      2821 JR	XEQGO1
000F10 5A   
000F11 CD      2827 COLOUR:         CALL	EXPRI		;n
000F12 B7   
000F13 18   
000F14 D9      2828 EXX
000F15 FD      2829 LD	A,(IY)
000F16 7E   
000F17 00   
000F18 FE      2830 CP	','
000F19 2C   
000F1A 28      2831 JR      Z,PALCOL
000F1B 08   
000F1C 65      2832 LD	H,L
000F1D 2E      2833 LD	L,17
000F1E 11   
000F1F CD      2834 CALL	WRCH2
000F20 5C   
000F21 11   
000F22 18      2835 JR	XEQGO1
000F23 47   
000F24 E5      2837 PALCOL:         PUSH	HL
000F25 CD      2838 CALL	CEXPRI		;p or r
000F26 75   
000F27 11   
000F28 D9      2839 EXX
000F29 EB      2840 EX	DE,HL
000F2A 21      2841 LD	HL,0
000F2B 00   
000F2C 00   
000F2D FD      2842 LD	A,(IY)
000F2E 7E   
000F2F 00   
000F30 FE      2843 CP	','
000F31 2C   
000F32 20      2844 JR	NZ,PALET1
000F33 15   
000F34 D5      2845 PUSH	DE
000F35 CD      2846 CALL	CEXPRI		;g
000F36 75   
000F37 11   
000F38 D9      2847 EXX
000F39 E5      2848 PUSH	HL
000F3A CD      2849 CALL	CEXPRI		;b
000F3B 75   
000F3C 11   
000F3D D9      2850 EXX
000F3E D1      2851 POP	DE
000F3F C1      2852 POP	BC
000F40 7D      2853 LD	A,L
000F41 E1      2854 POP	HL
000F42 51      2855 LD	D,C		;r
000F43 4D      2856 LD	C,L		;n
000F44 6B      2857 LD	L,E		;g
000F45 67      2858 LD	H,A		;b
000F46 1E      2859 LD	E,16
000F47 10   
000F48 C5      2860 PUSH	BC
000F49 C1      2861 PALET1:         POP	BC
000F4A 06      2862 LD	B,19
000F4B 13   
000F4C CD      2863 CALL	WRCH6
000F4D 4C   
000F4E 11   
000F4F 18      2864 JR	XEQGO1
000F50 1A   
000F51 CD      2868 GCOL:           CALL	EXPRI
000F52 B7   
000F53 18   
000F54 D9      2869 EXX
000F55 1E      2870 LD	E,0
000F56 00   
000F57 FD      2871 LD	A,(IY)
000F58 7E   
000F59 00   
000F5A FE      2872 CP	','
000F5B 2C   
000F5C 20      2873 JR	NZ,GCOL0
000F5D 06   
000F5E E5      2874 PUSH	HL
000F5F CD      2875 CALL	CEXPRI
000F60 75   
000F61 11   
000F62 D9      2876 EXX
000F63 D1      2877 POP	DE
000F64 65      2878 GCOL0:          LD	H,L
000F65 6B      2879 LD	L,E
000F66 16      2880 LD	D,18
000F67 12   
000F68 CD      2881 CALL	WRCH3		;DLH
000F69 58   
000F6A 11   
000F6B C3      2882 XEQGO1:         JP	XEQ
000F6C 1D   
000F6D 25   
000F6E 0E      2887 CSRON:          LD	C,1
000F6F 01   
000F70 18      2888 JR	CSRGO
000F71 02   
000F72 0E      2890 CSROFF:         LD	C,0
000F73 00   
000F74 3E      2891 CSRGO:          LD	A,23
000F75 17   
000F76 CD      2892 CALL	OSWRCH
000F77 97   
000F78 05   
000F79 3E      2893 LD	A,1
000F7A 01   
000F7B CD      2894 CALL	OSWRCH
000F7C 97   
000F7D 05   
000F7E 79      2895 LD	A,C
000F7F 06      2896 LD	B,8
000F80 08   
000F81 CD      2897 CSRGO1:         CALL	OSWRCH
000F82 97   
000F83 05   
000F84 AF      2898 XOR	A
000F85 10      2899 DJNZ	CSRGO1
000F86 FA   
000F87 18      2900 JR	XEQGO1
000F88 E2   
000F89 CD      2904 LINE:           CALL	EXPRI
000F8A B7   
000F8B 18   
000F8C D9      2905 EXX
000F8D E5      2906 PUSH	HL
000F8E CD      2907 CALL	EXPR3
000F8F 64   
000F90 11   
000F91 E3      2908 EX	(SP),HL		;HL <- x1, (SP) <- y2
000F92 C5      2909 PUSH	BC
000F93 EB      2910 EX	DE,HL
000F94 0E      2911 LD	C,4
000F95 04   
000F96 CD      2912 CALL	VDU25
000F97 4A   
000F98 11   
000F99 D1      2913 POP	DE
000F9A E1      2914 POP	HL
000F9B 0E      2915 LD	C,5
000F9C 05   
000F9D 18      2916 JR	PLOT4A
000F9E 2A   
000F9F FE      2920 CIRCLE:         CP	TFILL
000FA0 03   
000FA1 F5      2921 PUSH	AF
000FA2 20      2922 JR	NZ,CIRCL0
000FA3 02   
000FA4 FD      2923 INC	IY
000FA5 23   
000FA6 CD      2924 CIRCL0:         CALL	EXPRI
000FA7 B7   
000FA8 18   
000FA9 D9      2925 EXX
000FAA E5      2926 PUSH	HL
000FAB CD      2927 CALL	CEXPRI
000FAC 75   
000FAD 11   
000FAE D9      2928 EXX
000FAF E5      2929 PUSH	HL
000FB0 CD      2930 CALL	CEXPRI
000FB1 75   
000FB2 11   
000FB3 D9      2931 EXX
000FB4 C1      2932 POP	BC		;y
000FB5 D1      2933 POP	DE		;x
000FB6 E5      2934 PUSH	HL
000FB7 69      2935 LD	L,C
000FB8 60      2936 LD	H,B
000FB9 0E      2937 LD	C,4		; PLOT 4 = MOVE
000FBA 04   
000FBB CD      2938 CALL	VDU25
000FBC 4A   
000FBD 11   
000FBE D1      2939 POP	DE		;r
000FBF 21      2940 LD	HL,0
000FC0 00   
000FC1 00   
000FC2 F1      2941 POP	AF
000FC3 0E      2942 LD	C,145		; PLOT 145 = outline circle
000FC4 91   
000FC5 20      2943 JR	NZ,PLOT4A
000FC6 02   
000FC7 0E      2944 LD	C,153		; PLOT 153 = filled circle
000FC8 99   
000FC9 18      2945 PLOT4A:         JR	PLOT4
000FCA 6C   
000FCB FE      2949 ELLIPS:         CP	TFILL
000FCC 03   
000FCD F5      2950 PUSH	AF
000FCE 20      2951 JR	NZ,ELLIP0
000FCF 02   
000FD0 FD      2952 INC	IY
000FD1 23   
000FD2 CD      2953 ELLIP0:         CALL	EXPRI
000FD3 B7   
000FD4 18   
000FD5 D9      2954 EXX
000FD6 E5      2955 PUSH	HL
000FD7 CD      2956 CALL	EXPR3
000FD8 64   
000FD9 11   
000FDA E3      2957 EX	(SP),HL		;HL <- x, (SP) <- b
000FDB C5      2958 PUSH	BC
000FDC EB      2959 EX	DE,HL
000FDD 0E      2960 LD	C,4		; PLOT 4 = Move absolute
000FDE 04   
000FDF CD      2961 CALL	VDU25
000FE0 4A   
000FE1 11   
000FE2 D1      2962 POP	DE		;a
000FE3 D5      2963 PUSH	DE
000FE4 21      2964 LD	HL,0
000FE5 00   
000FE6 00   
000FE7 4D      2965 LD	C,L		; PLOT 0 - Move relative
000FE8 CD      2966 CALL	VDU25
000FE9 4A   
000FEA 11   
000FEB D1      2967 POP	DE		;a
000FEC AF      2968 XOR	A
000FED 6F      2969 LD	L,A
000FEE 67      2970 LD	H,A
000FEF ED      2971 SBC	HL,DE
000FF0 52   
000FF1 EB      2972 EX	DE,HL
000FF2 E1      2973 POP	HL		;b
000FF3 F1      2974 POP	AF
000FF4 0E      2975 LD	C,193		; PLOT 193 = outline ellipse
000FF5 C1   
000FF6 20      2976 JR	NZ,PLOT4
000FF7 3F   
000FF8 0E      2977 LD	C,201		; PLOT 201 = filled ellipse
000FF9 C9   
000FFA 18      2978 JR	PLOT4
000FFB 3B   
000FFC 0E      2985 MOVE:           LD	C,4
000FFD 04   
000FFE 18      2986 JR	PLOT1
000FFF 23   
001000 0E      2988 DRAW:           LD	C,5
001001 05   
001002 18      2989 JR	PLOT1
001003 1F   
001004 0E      2991 FILL:           LD	C,133
001005 85   
001006 18      2992 JR	PLOT1
001007 1B   
001008 0E      2994 PLOT:           LD	C,69
001009 45   
00100A FE      2995 CP	TBY
00100B 0F   
00100C 28      2996 JR	Z,PLOT1
00100D 15   
00100E CD      2997 CALL	EXPRI
00100F B7   
001010 18   
001011 D9      2998 EXX
001012 E5      2999 PUSH	HL
001013 CD      3000 CALL	CEXPRI
001014 75   
001015 11   
001016 D9      3001 EXX
001017 FD      3002 LD	A,(IY)
001018 7E   
001019 00   
00101A FE      3003 CP	','
00101B 2C   
00101C 28      3004 JR	Z,PLOT3
00101D 12   
00101E D1      3005 POP	DE
00101F 0E      3006 LD	C,69
001020 45   
001021 18      3007 JR	PLOT4
001022 14   
001023 FE      3009 PLOT1:          CP	TBY
001024 0F   
001025 20      3010 JR	NZ,PLOT2
001026 04   
001027 FD      3011 INC	IY
001028 23   
001029 CB      3012 RES	2,C		;Change absolute to relative
00102A 91   
00102B C5      3013 PLOT2:          PUSH	BC
00102C CD      3014 CALL	EXPRI
00102D B7   
00102E 18   
00102F D9      3015 EXX
001030 E5      3016 PLOT3:          PUSH	HL
001031 CD      3017 CALL	CEXPRI
001032 75   
001033 11   
001034 D9      3018 EXX
001035 D1      3019 POP	DE
001036 C1      3020 POP	BC
001037 CD      3021 PLOT4:          CALL	VDU25
001038 4A   
001039 11   
00103A C3      3022 JP	XEQ
00103B 1D   
00103C 25   
00103D FE      3026 RECTAN:         CP	TFILL
00103E 03   
00103F F5      3027 PUSH	AF
001040 20      3028 JR	NZ,RECT0
001041 02   
001042 FD      3029 INC	IY
001043 23   
001044 CD      3030 RECT0:          CALL	EXPRI
001045 B7   
001046 18   
001047 D9      3031 EXX
001048 E5      3032 PUSH	HL
001049 CD      3033 CALL	CEXPRI
00104A 75   
00104B 11   
00104C D9      3034 EXX
00104D E5      3035 PUSH	HL
00104E CD      3036 CALL	CEXPRI
00104F 75   
001050 11   
001051 D9      3037 EXX
001052 E5      3038 PUSH	HL
001053 FD      3039 LD	A,(IY)
001054 7E   
001055 00   
001056 FE      3040 CP	','
001057 2C   
001058 20      3041 JR	NZ,RECT1
001059 04   
00105A CD      3042 CALL	CEXPRI
00105B 75   
00105C 11   
00105D D9      3043 EXX
00105E C1      3044 RECT1:          POP	BC		;w
00105F D1      3045 POP	DE		;y
001060 E3      3046 EX	(SP),HL		;HL <- x, (SP) <- h
001061 C5      3047 PUSH	BC
001062 EB      3048 EX	DE,HL
001063 0E      3049 LD	C,4
001064 04   
001065 CD      3050 CALL	VDU25
001066 4A   
001067 11   
001068 FD      3051 LD	A,(IY)
001069 7E   
00106A 00   
00106B FE      3052 CP	TTO
00106C B8   
00106D 28      3053 JR	Z,RECTTO
00106E 09   
00106F D1      3054 POP	DE		;w
001070 E1      3055 POP	HL		;h
001071 F1      3056 POP	AF
001072 20      3057 JR	NZ,OUTLIN
001073 22   
001074 0E      3058 LD	C,97
001075 61   
001076 18      3059 JR	PLOT4
001077 BF   
001078 FD      3063 RECTTO:         INC	IY		; Bump over TO
001079 23   
00107A CD      3064 CALL	EXPRI
00107B B7   
00107C 18   
00107D D9      3065 EXX
00107E E5      3066 PUSH	HL
00107F CD      3067 CALL	CEXPRI
001080 75   
001081 11   
001082 D9      3068 EXX
001083 C1      3069 POP	BC		;newx
001084 D1      3070 POP	DE		;w
001085 E3      3071 EX	(SP),HL		;HL <- h, (SP) <- newy
001086 C5      3072 PUSH	BC
001087 0E      3073 LD	C,0
001088 00   
001089 CD      3074 CALL	VDU25
00108A 4A   
00108B 11   
00108C D1      3075 POP	DE		;newx
00108D E1      3076 POP	HL		;newy
00108E F1      3077 POP	AF
00108F 0E      3078 LD	C,190		; PLOT 190 - Block copy
001090 BE   
001091 20      3079 JR	NZ,PLOT4B
001092 01   
001093 0D      3080 DEC	C		; PLOT 189 - Block move
001094 18      3081 PLOT4B:         JR	PLOT4
001095 A1   
001096 0E      3085 OUTLIN:         LD	C,9		; PLOT 9 - draw relative
001097 09   
001098 E5      3086 PUSH	HL
001099 21      3087 LD	HL,0
00109A 00   
00109B 00   
00109C CD      3088 CALL	VDU25		; side 1
00109D 4A   
00109E 11   
00109F E1      3089 POP	HL
0010A0 D5      3090 PUSH	DE
0010A1 11      3091 LD	DE,0
0010A2 00   
0010A3 00   
0010A4 CD      3092 CALL	VDU25		; side 2
0010A5 4A   
0010A6 11   
0010A7 D1      3093 POP	DE
0010A8 E5      3094 PUSH	HL
0010A9 AF      3095 XOR	A
0010AA 6F      3096 LD	L,A
0010AB 67      3097 LD	H,A
0010AC ED      3098 SBC	HL,DE
0010AD 52   
0010AE EB      3099 EX	DE,HL
0010AF 6F      3100 LD	L,A
0010B0 67      3101 LD	H,A
0010B1 CD      3102 CALL 	VDU25		; side 3
0010B2 4A   
0010B3 11   
0010B4 D1      3103 POP	DE
0010B5 AF      3104 XOR	A
0010B6 6F      3105 LD	L,A
0010B7 67      3106 LD	H,A
0010B8 ED      3107 SBC	HL,DE
0010B9 52   
0010BA 5F      3108 LD	E,A
0010BB 57      3109 LD	D,A
0010BC 18      3110 JR	PLOT4B
0010BD D6   
0010BE 3E      3114 MOUSE:          LD	A,128
0010BF 80   
0010C0 21      3115 LD	HL,9
0010C1 09   
0010C2 00   
0010C3 CD      3116 CALL	OSBYTE
0010C4 D1   
0010C5 08   
0010C6 E5      3117 PUSH	HL
0010C7 3E      3118 LD	A,128
0010C8 80   
0010C9 21      3119 LD	HL,8
0010CA 08   
0010CB 00   
0010CC CD      3120 CALL	OSBYTE
0010CD D1   
0010CE 08   
0010CF E5      3121 PUSH	HL
0010D0 3E      3122 LD	A,128
0010D1 80   
0010D2 21      3123 LD	HL,7
0010D3 07   
0010D4 00   
0010D5 CD      3124 CALL	OSBYTE
0010D6 D1   
0010D7 08   
0010D8 E5      3125 PUSH	HL
0010D9 CD      3126 CALL	VAR_
0010DA 5A   
0010DB 26   
0010DC E1      3127 POP	HL
0010DD CD      3128 CALL	STOREI
0010DE 7B   
0010DF 11   
0010E0 CD      3129 CALL	COMMA
0010E1 26   
0010E2 21   
0010E3 CD      3130 CALL	NXT
0010E4 8F   
0010E5 45   
0010E6 CD      3131 CALL	VAR_
0010E7 5A   
0010E8 26   
0010E9 E1      3132 POP	HL
0010EA CD      3133 CALL	STOREI
0010EB 7B   
0010EC 11   
0010ED CD      3134 CALL	COMMA
0010EE 26   
0010EF 21   
0010F0 CD      3135 CALL	NXT
0010F1 8F   
0010F2 45   
0010F3 CD      3136 CALL	VAR_
0010F4 5A   
0010F5 26   
0010F6 E1      3137 POP	HL
0010F7 CD      3138 CALL	STOREI
0010F8 7B   
0010F9 11   
0010FA C3      3139 XEQGO2:         JP	XEQ
0010FB 1D   
0010FC 25   
0010FD CD      3143 WAIT:           CALL	TERMQ
0010FE BA   
0010FF 35   
001100 28      3144 JR	Z,XEQGO2
001101 F8   
001102 CD      3145 CALL	EXPRI
001103 B7   
001104 18   
001105 D9      3146 EXX
001106 44      3147 LD	B,H
001107 4D      3148 LD	C,L
001108 CD      3149 CALL	GETIME
001109 AD   
00110A 0D   
00110B 09      3150 ADD	HL,BC
00110C 01      3151 LD	BC,0
00110D 00   
00110E 00   
00110F EB      3152 EX	DE,HL
001110 ED      3153 ADC	HL,BC
001111 4A   
001112 EB      3154 EX	DE,HL
001113 CD      3155 WAIT1:          CALL	TRAP
001114 35   
001115 06   
001116 D5      3156 PUSH	DE
001117 E5      3157 PUSH	HL
001118 CD      3158 CALL	GETIME
001119 AD   
00111A 0D   
00111B C1      3159 POP	BC
00111C B7      3160 OR	A
00111D ED      3161 SBC	HL,BC
00111E 42   
00111F 60      3162 LD	H,B
001120 69      3163 LD	L,C
001121 EB      3164 EX	DE,HL
001122 C1      3165 POP	BC
001123 ED      3166 SBC	HL,BC
001124 42   
001125 30      3167 JR	NC,XEQGO2
001126 D3   
001127 EB      3168 EX	DE,HL
001128 50      3169 LD	D,B
001129 59      3170 LD	E,C
00112A 18      3171 JR	WAIT1
00112B E7   
00112C E1      3175 OSCALL:         POP	HL		;DITCH RETURN ADDRESS
00112D 21      3176 LD	HL,OSRET
00112E 3F   
00112F 11   
001130 E5      3177 PUSH	HL		;NEW RETURN ADDRESS
001131 DD      3178 LD	A,(IX+4)	;A%
001132 7E   
001133 04   
001134 DD      3179 LD	E,(IX+20)	;E%
001135 5E   
001136 14   
001137 DD      3180 LD	H,(IX+100)	;Y%
001138 66   
001139 64   
00113A DD      3181 LD	L,(IX+96)	;X%
00113B 6E   
00113C 60   
00113D FD      3182 JP	(IY)
00113E E9   
00113F F5      3183 OSRET:          PUSH	AF
001140 7D      3184 LD	A,L		;F  H  L  A
001141 6C      3185 LD	L,H		;|  |  |  |
001142 D9      3186 EXX			;|  |  |  |
001143 C1      3187 POP	BC		;|  |  |  |
001144 67      3188 LD	H,A		;|  |  |  |
001145 68      3189 LD	L,B		;H  L  H' L'
001146 79      3190 LD	A,C
001147 D9      3191 EXX
001148 67      3192 LD	H,A
001149 C9      3193 RET
00114A 06      3195 VDU25:          LD	B,25
00114B 19   
00114C 78      3196 WRCH6:          LD	A,B
00114D CD      3197 CALL	OSWRCH
00114E 97   
00114F 05   
001150 79      3198 WRCH5:          LD	A,C
001151 CD      3199 CALL	OSWRCH
001152 97   
001153 05   
001154 7B      3200 WRCH4:          LD	A,E
001155 CD      3201 CALL	OSWRCH
001156 97   
001157 05   
001158 7A      3202 WRCH3:          LD	A,D
001159 CD      3203 CALL	OSWRCH
00115A 97   
00115B 05   
00115C 7D      3204 WRCH2:          LD	A,L
00115D CD      3205 CALL	OSWRCH
00115E 97   
00115F 05   
001160 7C      3206 LD	A,H
001161 C3      3207 JP	OSWRCH
001162 97   
001163 05   
001164 CD      3209 EXPR3:          CALL	CEXPRI
001165 75   
001166 11   
001167 D9      3210 EXX
001168 E5      3211 PUSH	HL
001169 CD      3212 CALL	CEXPRI
00116A 75   
00116B 11   
00116C D9      3213 EXX
00116D E5      3214 PUSH	HL
00116E CD      3215 CALL	CEXPRI
00116F 75   
001170 11   
001171 D9      3216 EXX
001172 C1      3217 POP	BC		;x2
001173 D1      3218 POP	DE		;y1
001174 C9      3219 RET
001175 CD      3221 CEXPRI:         CALL	COMMA
001176 26   
001177 21   
001178 C3      3222 JP	EXPRI
001179 B7   
00117A 18   
00117B CB      3224 STOREI:         BIT	7,A
00117C 7F   
00117D 20      3225 JR	NZ,EEK
00117E 0C   
00117F CB      3226 BIT	6,A
001180 77   
001181 20      3227 JR	NZ,EEK
001182 08   
001183 D9      3228 EXX
001184 21      3229 LD	HL,0
001185 00   
001186 00   
001187 4D      3230 LD	C,L
001188 C3      3231 JP	STOREN
001189 74   
00118A 32   
00118B 3E      3233 EEK:            LD	A,50
00118C 32   
00118D CD      3234 CALL	EXTERR
00118E D9   
00118F 3F   
001190 13      3235 DB	13H		;'Bad '
001191 04      3236 DB	04H		;'MOUSE'
001192 20      3237 DB	20H
001193 15      3238 DB	15H		;'variable'
001194 00      3239 DB	0
001195 AF      3244 XOR	A
001196 CD      3245 CALL	EXTERR
001197 D9   
001198 3F   
001199 53      3246 DB	"Sorry"
00119A 6F   
00119B 72   
00119C 72   
00119D 79   
00119E 00      3247 DB	0
00119F             3252   ; --- Begin asmb.asm ---
00119F CD      3299 ASSEM:          CALL	SKIP
0011A0 27   
0011A1 15   
0011A2 FD      3300 INC	IY
0011A3 23   
0011A4 FE      3301 CP	':'
0011A5 3A   
0011A6 28      3302 JR	Z,ASSEM
0011A7 F7   
0011A8 FE      3303 CP	']'
0011A9 5D   
0011AA C8      3304 RET	Z
0011AB FE      3305 CP	CR
0011AC 0D   
0011AD C8      3306 RET	Z
0011AE FD      3307 DEC	IY
0011AF 2B   
0011B0 DD      3308 LD	IX,(PC)		;PROGRAM COUNTER
0011B1 2A   
0011B2 40   
0011B3 55   
0011B4 21      3309 LD	HL,LISTON
0011B5 FE   
0011B6 55   
0011B7 CB      3310 BIT	6,(HL)
0011B8 76   
0011B9 28      3311 JR	Z,ASSEM0
0011BA 04   
0011BB DD      3312 LD	IX,(OC)		;ORIGIN of CODE
0011BC 2A   
0011BD 3C   
0011BE 55   
0011BF DD      3313 ASSEM0:         PUSH	IX
0011C0 E5   
0011C1 FD      3314 PUSH	IY
0011C2 E5   
0011C3 CD      3315 CALL	ASMB
0011C4 53   
0011C5 12   
0011C6 C1      3316 POP	BC
0011C7 D1      3317 POP	DE
0011C8 D8      3318 RET	C
0011C9 CD      3319 CALL	SKIP
0011CA 27   
0011CB 15   
0011CC 37      3320 SCF
0011CD C0      3321 RET	NZ
0011CE FD      3322 DEC	IY
0011CF 2B   
0011D0 FD      3323 ASSEM3:         INC	IY
0011D1 23   
0011D2 FD      3324 LD	A,(IY)
0011D3 7E   
0011D4 00   
0011D5 CD      3325 CALL	TERM0
0011D6 4B   
0011D7 15   
0011D8 20      3326 JR	NZ,ASSEM3
0011D9 F6   
0011DA 3A      3327 LD	A,(LISTON)
0011DB FE   
0011DC 55   
0011DD DD      3328 PUSH	IX
0011DE E5   
0011DF E1      3329 POP	HL
0011E0 B7      3330 OR	A
0011E1 ED      3331 SBC	HL,DE
0011E2 52   
0011E3 EB      3332 EX	DE,HL		;DE= NO. OF BYTES
0011E4 E5      3333 PUSH	HL
0011E5 2A      3334 LD	HL,(PC)
0011E6 40   
0011E7 55   
0011E8 E5      3335 PUSH	HL
0011E9 19      3336 ADD	HL,DE
0011EA 22      3337 LD	(PC),HL		;UPDATE PC
0011EB 40   
0011EC 55   
0011ED CB      3338 BIT	6,A
0011EE 77   
0011EF 28      3339 JR	Z,ASSEM5
0011F0 07   
0011F1 2A      3340 LD	HL,(OC)
0011F2 3C   
0011F3 55   
0011F4 19      3341 ADD	HL,DE
0011F5 22      3342 LD	(OC),HL		;UPDATE OC
0011F6 3C   
0011F7 55   
0011F8 E1      3343 ASSEM5:         POP	HL		;OLD PC
0011F9 DD      3344 POP	IX		;CODE HERE
0011FA E1   
0011FB CB      3345 BIT	4,A
0011FC 67   
0011FD 28      3346 JR	Z,ASSEM
0011FE A0   
0011FF 7C      3347 LD	A,H
001200 CD      3348 CALL	HEX
001201 3F   
001202 12   
001203 7D      3349 LD	A,L
001204 CD      3350 CALL	HEXSP
001205 38   
001206 12   
001207 AF      3351 XOR	A
001208 BB      3352 CP	E
001209 28      3353 JR	Z,ASSEM2
00120A 15   
00120B 3A      3354 ASSEM1:         LD	A,(COUNT)
00120C FB   
00120D 55   
00120E FE      3355 CP	17
00120F 11   
001210 3E      3356 LD	A,5
001211 05   
001212 D4      3357 CALL	NC,TABIT	;NEXT LINE
001213 01   
001214 36   
001215 DD      3358 LD	A,(IX)
001216 7E   
001217 00   
001218 CD      3359 CALL	HEXSP
001219 38   
00121A 12   
00121B DD      3360 INC	IX
00121C 23   
00121D 1D      3361 DEC	E
00121E 20      3362 JR	NZ,ASSEM1
00121F EB   
001220 3E      3363 ASSEM2:         LD	A,18
001221 12   
001222 CD      3364 CALL	TABIT
001223 01   
001224 36   
001225 FD      3365 PUSH	IY
001226 E5   
001227 E1      3366 POP	HL
001228 ED      3367 SBC	HL,BC
001229 42   
00122A 0A      3368 ASSEM4:         LD	A,(BC)
00122B CD      3369 CALL	OUT
00122C 9F   
00122D 41   
00122E 03      3370 INC	BC
00122F 2D      3371 DEC	L
001230 20      3372 JR	NZ,ASSEM4
001231 F8   
001232 CD      3373 CALL	CRLF
001233 7F   
001234 41   
001235 C3      3374 JP	ASSEM
001236 9F   
001237 11   
001238 CD      3376 HEXSP:          CALL	HEX
001239 3F   
00123A 12   
00123B 3E      3377 LD	A,' '
00123C 20   
00123D 18      3378 JR	OUTCH1
00123E 11   
00123F F5      3379 HEX:            PUSH	AF
001240 0F      3380 RRCA
001241 0F      3381 RRCA
001242 0F      3382 RRCA
001243 0F      3383 RRCA
001244 CD      3384 CALL	HEXOUT
001245 48   
001246 12   
001247 F1      3385 POP	AF
001248 E6      3386 HEXOUT:         AND	0FH
001249 0F   
00124A C6      3387 ADD	A,90H
00124B 90   
00124C 27      3388 DAA
00124D CE      3389 ADC	A,40H
00124E 40   
00124F 27      3390 DAA
001250 C3      3391 OUTCH1:         JP	OUT
001251 9F   
001252 41   
001253 FE      3405 ASMB:           CP	'.'
001254 2E   
001255 20      3406 JR	NZ,ASMB1
001256 28   
001257 FD      3407 INC	IY
001258 23   
001259 DD      3408 PUSH	IX
00125A E5   
00125B CD      3409 CALL	VAR_
00125C 5A   
00125D 26   
00125E F5      3410 PUSH	AF
00125F CD      3411 CALL	ZERO
001260 7C   
001261 20   
001262 D9      3412 EXX
001263 2A      3413 LD	HL,(PC)
001264 40   
001265 55   
001266 D9      3414 EXX
001267 3A      3415 LD	A,(LISTON)
001268 FE   
001269 55   
00126A E6      3416 AND	20H
00126B 20   
00126C 20      3417 JR	NZ,ASMB0
00126D 0B   
00126E DD      3418 LD	A,(IX)
00126F 7E   
001270 00   
001271 DD      3419 OR	(IX+1)
001272 B6   
001273 01   
001274 3E      3420 LD	A,3
001275 03   
001276 C2      3421 JP	NZ,ERROR_	;Multiple label
001277 C8   
001278 3F   
001279 F1      3422 ASMB0:          POP	AF
00127A CD      3423 CALL	STOREN
00127B 74   
00127C 32   
00127D DD      3424 POP	IX
00127E E1   
00127F CD      3425 ASMB1:          CALL	SKIP
001280 27   
001281 15   
001282 C8      3426 RET	Z
001283 FE      3427 CP	TCALL
001284 D6   
001285 0E      3428 LD	C,0C4H
001286 C4   
001287 FD      3429 INC	IY
001288 23   
001289 CA      3430 JP	Z,GRPC
00128A 76   
00128B 13   
00128C FD      3431 DEC	IY
00128D 2B   
00128E 21      3432 LD	HL,OPCODS
00128F 51   
001290 15   
001291 CD      3433 CALL	FIND
001292 DE   
001293 14   
001294 D8      3434 RET	C
001295 48      3435 LD	C,B	;ROOT OPCODE
001296 16      3436 LD	D,0	;CLEAR IX/IY FLAG
001297 00   
001298 D6      3441 SUB	39
001299 27   
00129A 30      3442 JR	NC,GROUP2
00129B 07   
00129C FE      3443 CP	15-39
00129D E8   
00129E D4      3444 CALL	NC,ED
00129F 44   
0012A0 14   
0012A1 18      3445 JR	BYTE0
0012A2 68   
0012A3 D6      3450 GROUP2:         SUB	10
0012A4 0A   
0012A5 30      3451 JR	NC,GROUP4
0012A6 0F   
0012A7 FE      3452 CP	3-10
0012A8 F9   
0012A9 DC      3453 CALL	C,BIT
0012AA CE   
0012AB 14   
0012AC D8      3454 RET	C
0012AD CD      3455 CALL	REGLO
0012AE A3   
0012AF 14   
0012B0 D8      3456 RET	C
0012B1 CD      3457 CALL	CB
0012B2 48   
0012B3 14   
0012B4 18      3458 JR	BYTE0
0012B5 55   
0012B6 D6      3462 GROUP4:         SUB	3
0012B7 03   
0012B8 30      3463 JR	NC,GROUP5
0012B9 06   
0012BA CD      3464 G4:             CALL	PAIRasm
0012BB C2   
0012BC 14   
0012BD D8      3465 RET	C
0012BE 18      3466 JR	BYTE0
0012BF 4B   
0012C0 D6      3471 GROUP5:         SUB	8+2
0012C1 0A   
0012C2 30      3472 JR	NC,GROUP7
0012C3 32   
0012C4 FE      3473 CP	5-8
0012C5 FD   
0012C6 06      3474 LD	B,7
0012C7 07   
0012C8 D4      3475 CALL	NC,OPND
0012C9 56   
0012CA 14   
0012CB 78      3476 LD	A,B
0012CC FE      3477 CP	7
0012CD 07   
0012CE 20      3478 JR	NZ,G6HL
0012CF 10   
0012D0 CD      3479 G6:             CALL	REGLO
0012D1 A3   
0012D2 14   
0012D3 79      3480 LD	A,C
0012D4 30      3481 JR	NC,BIND1
0012D5 28   
0012D6 EE      3482 XOR	46H
0012D7 46   
0012D8 CD      3483 CALL	BIND
0012D9 4A   
0012DA 14   
0012DB CD      3484 DB:             CALL	NUMBER
0012DC 86   
0012DD 14   
0012DE 18      3485 JR	VAL8
0012DF 78   
0012E0 E6      3487 G6HL:           AND	3FH
0012E1 3F   
0012E2 FE      3488 CP	12
0012E3 0C   
0012E4 37      3489 SCF
0012E5 C0      3490 RET	NZ
0012E6 79      3491 LD	A,C
0012E7 FE      3492 CP	80H
0012E8 80   
0012E9 0E      3493 LD	C,9
0012EA 09   
0012EB 28      3494 JR	Z,G4
0012EC CD   
0012ED EE      3495 XOR	1CH
0012EE 1C   
0012EF 0F      3496 RRCA
0012F0 4F      3497 LD	C,A
0012F1 CD      3498 CALL	ED
0012F2 44   
0012F3 14   
0012F4 18      3499 JR	G4
0012F5 C4   
0012F6 D6      3503 GROUP7:         SUB	2
0012F7 02   
0012F8 30      3504 JR	NC,GROUP8
0012F9 14   
0012FA CD      3505 CALL	REGHI
0012FB A9   
0012FC 14   
0012FD 79      3506 LD	A,C
0012FE D2      3507 BIND1:          JP	NC,BIND
0012FF 4A   
001300 14   
001301 EE      3508 XOR	64H
001302 64   
001303 07      3509 RLCA
001304 07      3510 RLCA
001305 07      3511 RLCA
001306 4F      3512 LD	C,A
001307 CD      3513 CALL	PAIR1asm
001308 C6   
001309 14   
00130A D8      3514 RET	C
00130B 79      3515 BYTE0:          LD	A,C
00130C 18      3516 JR	BYTE2
00130D 7F   
00130E D6      3521 GROUP8:         SUB	2
00130F 02   
001310 30      3522 JR	NC,GROUPA
001311 21   
001312 FE      3523 CP	1-2
001313 FF   
001314 CC      3524 CALL	Z,CORN
001315 39   
001316 14   
001317 08      3525 EX	AF,AF'
001318 CD      3526 CALL	REGHI
001319 A9   
00131A 14   
00131B D8      3527 RET	C
00131C 08      3528 EX	AF,AF'
00131D DC      3529 CALL	C,CORN
00131E 39   
00131F 14   
001320 24      3530 INC	H
001321 28      3531 JR	Z,BYTE0
001322 E8   
001323 78      3532 LD	A,B
001324 FE      3533 CP	7
001325 07   
001326 37      3534 SCF
001327 C0      3535 RET	NZ
001328 79      3536 LD	A,C
001329 EE      3537 XOR	3
00132A 03   
00132B 07      3538 RLCA
00132C 07      3539 RLCA
00132D 07      3540 RLCA
00132E CD      3541 CALL	BYTE
00132F 76   
001330 14   
001331 18      3542 JR	VAL8
001332 25   
001333 D6      3546 GROUPA:         SUB	2
001334 02   
001335 30      3547 JR	NC,GROUPB
001336 24   
001337 FE      3548 CP	1-2
001338 FF   
001339 C4      3549 CALL	NZ,COND_
00133A AF   
00133B 14   
00133C 79      3550 LD	A,C
00133D 30      3551 JR	NC,GRPA
00133E 02   
00133F 3E      3552 LD	A,18H
001340 18   
001341 CD      3553 GRPA:           CALL	BYTE
001342 76   
001343 14   
001344 CD      3554 CALL	NUMBER
001345 86   
001346 14   
001347 ED      3555 LD	DE,(PC)
001348 5B   
001349 40   
00134A 55   
00134B 13      3556 INC	DE
00134C 37      3557 SCF
00134D ED      3558 SBC	HL,DE
00134E 52   
00134F 7D      3559 LD	A,L
001350 17      3560 RLA
001351 9F      3561 SBC	A,A
001352 BC      3562 CP	H
001353 3E      3563 TOOFAR:         LD	A,1
001354 01   
001355 C2      3564 JP	NZ,ERROR_	;"Out of range"
001356 C8   
001357 3F   
001358 7D      3565 VAL8:           LD	A,L
001359 18      3566 JR	BYTE2
00135A 32   
00135B 47      3570 GROUPB:         LD	B,A
00135C 20      3571 JR	NZ,GROUPC
00135D 16   
00135E CD      3572 CALL	COND_
00135F AF   
001360 14   
001361 79      3573 LD	A,C
001362 30      3574 JR	NC,GRPB
001363 0B   
001364 78      3575 LD	A,B
001365 E6      3576 AND	3FH
001366 3F   
001367 FE      3577 CP	6
001368 06   
001369 3E      3578 LD	A,0E9H
00136A E9   
00136B 28      3579 JR	Z,BYTE2
00136C 20   
00136D 3E      3580 LD	A,0C3H
00136E C3   
00136F CD      3581 GRPB:           CALL	BYTE
001370 76   
001371 14   
001372 18      3582 JR	ADDR_
001373 05   
001374 10      3586 GROUPC:         DJNZ	GROUPD
001375 0C   
001376 CD      3587 GRPC:           CALL	GRPE
001377 91   
001378 13   
001379 CD      3588 ADDR_:          CALL	NUMBER
00137A 86   
00137B 14   
00137C CD      3589 VAL16:          CALL	VAL8
00137D 58   
00137E 13   
00137F 7C      3590 LD	A,H
001380 18      3591 JR	BYTE2
001381 0B   
001382 10      3595 GROUPD:         DJNZ	GROUPE
001383 0B   
001384 CD      3596 CALL	NUMBER
001385 86   
001386 14   
001387 A1      3597 AND	C
001388 B4      3598 OR	H
001389 20      3599 JR	NZ,TOOFAR
00138A C8   
00138B 7D      3600 LD	A,L
00138C B1      3601 OR	C
00138D 18      3602 BYTE2:          JR	BYTE1
00138E 78   
00138F 10      3606 GROUPE:         DJNZ	GROUPF
001390 0A   
001391 CD      3607 GRPE:           CALL	COND_
001392 AF   
001393 14   
001394 79      3608 LD	A,C
001395 30      3609 JR	NC,BYTE1
001396 70   
001397 F6      3610 OR	9
001398 09   
001399 18      3611 JR	BYTE1
00139A 6C   
00139B 10      3615 GROUPF:         DJNZ	MISC
00139C 6C   
00139D CD      3616 CALL	LDOP
00139E DB   
00139F 14   
0013A0 30      3617 JR	NC,LDA
0013A1 5F   
0013A2 CD      3618 CALL	REGHI
0013A3 A9   
0013A4 14   
0013A5 08      3619 EX	AF,AF'
0013A6 CD      3620 CALL	SKIP
0013A7 27   
0013A8 15   
0013A9 FE      3621 CP	'('
0013AA 28   
0013AB 28      3622 JR	Z,LDIN
0013AC 1D   
0013AD 08      3623 EX	AF,AF'
0013AE D2      3624 JP	NC,G6
0013AF D0   
0013B0 12   
0013B1 0E      3625 LD	C,1
0013B2 01   
0013B3 CD      3626 CALL	PAIR1asm
0013B4 C6   
0013B5 14   
0013B6 D8      3627 RET	C
0013B7 3E      3628 LD	A,14
0013B8 0E   
0013B9 B8      3629 CP	B
0013BA 47      3630 LD	B,A
0013BB CC      3631 CALL	Z,PAIRasm
0013BC C2   
0013BD 14   
0013BE 78      3632 LD	A,B
0013BF E6      3633 AND	3FH
0013C0 3F   
0013C1 FE      3634 CP	12
0013C2 0C   
0013C3 79      3635 LD	A,C
0013C4 20      3636 JR	NZ,GRPB
0013C5 A9   
0013C6 3E      3637 LD	A,0F9H
0013C7 F9   
0013C8 18      3638 JR	BYTE1
0013C9 3D   
0013CA 08      3640 LDIN:           EX	AF,AF'
0013CB C5      3641 PUSH	BC
0013CC D4      3642 CALL	NC,REGLO
0013CD A3   
0013CE 14   
0013CF 79      3643 LD	A,C
0013D0 C1      3644 POP	BC
0013D1 30      3645 JR	NC,BIND
0013D2 77   
0013D3 0E      3646 LD	C,0AH
0013D4 0A   
0013D5 CD      3647 CALL	PAIR1asm
0013D6 C6   
0013D7 14   
0013D8 CD      3648 CALL	LD16
0013D9 20   
0013DA 14   
0013DB 30      3649 JR	NC,GRPB
0013DC 92   
0013DD CD      3650 CALL	NUMBER
0013DE 86   
0013DF 14   
0013E0 0E      3651 LD	C,2
0013E1 02   
0013E2 CD      3652 CALL	PAIRasm
0013E3 C2   
0013E4 14   
0013E5 CD      3653 CALL	LD16
0013E6 20   
0013E7 14   
0013E8 D8      3654 RET	C
0013E9 CD      3655 CALL	BYTE
0013EA 76   
0013EB 14   
0013EC 18      3656 JR	VAL16
0013ED 8E   
0013EE 05      3660 OPT:            DEC	B
0013EF CA      3661 JP	Z,DB
0013F0 DB   
0013F1 12   
0013F2 10      3662 DJNZ	ADDR_
0013F3 85   
0013F4 CD      3663 CALL	NUMBER
0013F5 86   
0013F6 14   
0013F7 21      3664 LD	HL,LISTON
0013F8 FE   
0013F9 55   
0013FA 4F      3665 LD	C,A
0013FB ED      3666 RLD
0013FC 6F   
0013FD 79      3667 LD	A,C
0013FE ED      3668 RRD
0013FF 67   
001400 C9      3669 RET
001401 FE      3671 LDA:            CP	4
001402 04   
001403 DC      3672 CALL	C,ED
001404 44   
001405 14   
001406 78      3673 LD	A,B
001407 18      3674 BYTE1:          JR	BYTE
001408 6D   
001409 10      3678 MISC:           DJNZ	OPT
00140A E3   
00140B DD      3679 PUSH	IX
00140C E5   
00140D CD      3680 CALL	EXPRS
00140E C0   
00140F 18   
001410 DD      3681 POP	IX
001411 E1   
001412 21      3682 LD	HL,ACCS
001413 00   
001414 53   
001415 AF      3683 DEFM1:          XOR	A
001416 BB      3684 CP	E
001417 C8      3685 RET	Z
001418 7E      3686 LD	A,(HL)
001419 23      3687 INC	HL
00141A CD      3688 CALL	BYTE
00141B 76   
00141C 14   
00141D 1D      3689 DEC	E
00141E 18      3690 JR	DEFM1
00141F F5   
001420 78      3694 LD16:           LD	A,B
001421 38      3695 JR	C,LD8
001422 0E   
001423 78      3696 LD	A,B
001424 E6      3697 AND	3FH
001425 3F   
001426 FE      3698 CP	12
001427 0C   
001428 79      3699 LD	A,C
001429 C8      3700 RET	Z
00142A CD      3701 CALL	ED
00142B 44   
00142C 14   
00142D 79      3702 LD	A,C
00142E F6      3703 OR	43H
00142F 43   
001430 C9      3704 RET
001431 FE      3706 LD8:            CP	7
001432 07   
001433 37      3707 SCF
001434 C0      3708 RET	NZ
001435 79      3709 LD	A,C
001436 F6      3710 OR	30H
001437 30   
001438 C9      3711 RET
001439 C5      3713 CORN:           PUSH	BC
00143A CD      3714 CALL	OPND
00143B 56   
00143C 14   
00143D CB      3715 BIT	5,B
00143E 68   
00143F C1      3716 POP	BC
001440 28      3717 JR	Z,NUMBER
001441 44   
001442 26      3718 LD	H,-1
001443 FF   
001444 3E      3719 ED:             LD	A,0EDH
001445 ED   
001446 18      3720 JR	BYTE
001447 2E   
001448 3E      3722 CB:             LD	A,0CBH
001449 CB   
00144A FE      3723 BIND:           CP	76H
00144B 76   
00144C 37      3724 SCF
00144D C8      3725 RET	Z		;REJECT LD (HL),(HL)
00144E CD      3726 CALL	BYTE
00144F 76   
001450 14   
001451 14      3727 INC	D
001452 F0      3728 RET	P
001453 7B      3729 LD	A,E
001454 18      3730 JR	BYTE
001455 20   
001456 E5      3732 OPND:           PUSH	HL
001457 21      3733 LD	HL,OPRNDS
001458 98   
001459 16   
00145A CD      3734 CALL	FIND
00145B DE   
00145C 14   
00145D E1      3735 POP	HL
00145E D8      3736 RET	C
00145F CB      3737 BIT	7,B
001460 78   
001461 C8      3738 RET	Z
001462 CB      3739 BIT	3,B
001463 58   
001464 E5      3740 PUSH	HL
001465 CC      3741 CALL	Z,OFFSETasm
001466 7D   
001467 14   
001468 5D      3742 LD	E,L
001469 E1      3743 POP	HL
00146A 3E      3744 LD	A,0DDH
00146B DD   
00146C CB      3745 BIT	6,B
00146D 70   
00146E 28      3746 JR	Z,OP1
00146F 02   
001470 3E      3747 LD	A,0FDH
001471 FD   
001472 B7      3748 OP1:            OR	A
001473 14      3749 INC	D
001474 57      3750 LD	D,A
001475 F8      3751 RET	M
001476 DD      3752 BYTE:           LD	(IX),A
001477 77   
001478 00   
001479 DD      3753 INC	IX
00147A 23   
00147B B7      3754 OR	A
00147C C9      3755 RET
00147D FD      3757 OFFSETasm:         LD	A,(IY)
00147E 7E   
00147F 00   
001480 FE      3758 CP	')'
001481 29   
001482 21      3759 LD	HL,0
001483 00   
001484 00   
001485 C8      3760 RET	Z
001486 CD      3761 NUMBER:         CALL	SKIP
001487 27   
001488 15   
001489 C5      3762 PUSH	BC
00148A D5      3763 PUSH	DE
00148B DD      3764 PUSH	IX
00148C E5   
00148D CD      3765 CALL	EXPRI
00148E B7   
00148F 18   
001490 DD      3766 POP	IX
001491 E1   
001492 D9      3767 EXX
001493 D1      3768 POP	DE
001494 C1      3769 POP	BC
001495 7D      3770 LD	A,L
001496 B7      3771 OR	A
001497 C9      3772 RET
001498 CD      3774 REG:            CALL	OPND
001499 56   
00149A 14   
00149B D8      3775 RET	C
00149C 78      3776 LD	A,B
00149D E6      3777 AND	3FH
00149E 3F   
00149F FE      3778 CP	8
0014A0 08   
0014A1 3F      3779 CCF
0014A2 C9      3780 RET
0014A3 CD      3782 REGLO:          CALL	REG
0014A4 98   
0014A5 14   
0014A6 D8      3783 RET	C
0014A7 18      3784 JR	ORC
0014A8 2F   
0014A9 CD      3786 REGHI:          CALL	REG
0014AA 98   
0014AB 14   
0014AC D8      3787 RET	C
0014AD 18      3788 JR	SHL3
0014AE 26   
0014AF CD      3790 COND_:          CALL	OPND
0014B0 56   
0014B1 14   
0014B2 D8      3791 RET	C
0014B3 78      3792 LD	A,B
0014B4 E6      3793 AND	1FH
0014B5 1F   
0014B6 D6      3794 SUB	16
0014B7 10   
0014B8 30      3795 JR	NC,SHL3
0014B9 1B   
0014BA FE      3796 CP	-15
0014BB F1   
0014BC 37      3797 SCF
0014BD C0      3798 RET	NZ
0014BE 3E      3799 LD	A,3
0014BF 03   
0014C0 18      3800 JR	SHL3
0014C1 13   
0014C2 CD      3802 PAIRasm:           CALL	OPND
0014C3 56   
0014C4 14   
0014C5 D8      3803 RET	C
0014C6 78      3804 PAIR1asm:          LD	A,B
0014C7 E6      3805 AND	0FH
0014C8 0F   
0014C9 D6      3806 SUB	8
0014CA 08   
0014CB D8      3807 RET	C
0014CC 18      3808 JR	SHL3
0014CD 07   
0014CE CD      3810 BIT:            CALL	NUMBER
0014CF 86   
0014D0 14   
0014D1 FE      3811 CP	8
0014D2 08   
0014D3 3F      3812 CCF
0014D4 D8      3813 RET	C
0014D5 07      3814 SHL3:           RLCA
0014D6 07      3815 RLCA
0014D7 07      3816 RLCA
0014D8 B1      3817 ORC:            OR	C
0014D9 4F      3818 LD	C,A
0014DA C9      3819 RET
0014DB 21      3821 LDOP:           LD	HL,LDOPS
0014DC DD   
0014DD 16   
0014DE CD      3822 FIND:           CALL	SKIP
0014DF 27   
0014E0 15   
0014E1 06      3823 EXIT:           LD	B,0
0014E2 00   
0014E3 37      3824 SCF
0014E4 C8      3825 RET	Z
0014E5 FE      3826 CP	TDEF
0014E6 DD   
0014E7 28      3827 JR	Z,FIND0
0014E8 04   
0014E9 FE      3828 CP	TOR+1
0014EA 85   
0014EB 3F      3829 CCF
0014EC D8      3830 RET	C
0014ED 7E      3831 FIND0:          LD	A,(HL)
0014EE B7      3832 OR	A
0014EF 28      3833 JR	Z,EXIT
0014F0 F0   
0014F1 FD      3834 XOR	(IY)
0014F2 AE   
0014F3 00   
0014F4 E6      3835 AND	01011111B
0014F5 5F   
0014F6 28      3836 JR	Z,FIND2
0014F7 09   
0014F8 CB      3837 FIND1:          BIT	7,(HL)
0014F9 7E   
0014FA 23      3838 INC	HL
0014FB 28      3839 JR	Z,FIND1
0014FC FB   
0014FD 23      3840 INC	HL
0014FE 04      3841 INC	B
0014FF 18      3842 JR	FIND0
001500 EC   
001501 FD      3844 FIND2:          PUSH	IY
001502 E5   
001503 CB      3845 FIND3:          BIT	7,(HL)
001504 7E   
001505 FD      3846 INC	IY
001506 23   
001507 23      3847 INC	HL
001508 20      3848 JR	NZ,FIND5
001509 10   
00150A BE      3849 CP	(HL)
00150B CC      3850 CALL	Z,SKIP0
00150C 26   
00150D 15   
00150E 7E      3851 LD	A,(HL)
00150F FD      3852 XOR	(IY)
001510 AE   
001511 00   
001512 E6      3853 AND	01011111B
001513 5F   
001514 28      3854 JR	Z,FIND3
001515 ED   
001516 FD      3855 FIND4:          POP	IY
001517 E1   
001518 18      3856 JR	FIND1
001519 DE   
00151A CD      3858 FIND5:          CALL	DELIM
00151B 39   
00151C 15   
00151D C4      3859 CALL	NZ,SIGN
00151E 33   
00151F 15   
001520 20      3860 JR	NZ,FIND4
001521 F4   
001522 78      3861 FIND6:          LD	A,B
001523 46      3862 LD	B,(HL)
001524 E1      3863 POP	HL
001525 C9      3864 RET
001526 23      3866 SKIP0:          INC	HL
001527 CD      3867 SKIP:           CALL	DELIM
001528 39   
001529 15   
00152A C0      3868 RET	NZ
00152B CD      3869 CALL	TERM
00152C 45   
00152D 15   
00152E C8      3870 RET	Z
00152F FD      3871 INC	IY
001530 23   
001531 18      3872 JR	SKIP
001532 F4   
001533 FE      3874 SIGN:           CP	'+'
001534 2B   
001535 C8      3875 RET	Z
001536 FE      3876 CP	'-'
001537 2D   
001538 C9      3877 RET
001539 FD      3879 DELIM:          LD	A,(IY)		;ASSEMBLER DELIMITER
00153A 7E   
00153B 00   
00153C FE      3880 CP	' '
00153D 20   
00153E C8      3881 RET	Z
00153F FE      3882 CP	','
001540 2C   
001541 C8      3883 RET	Z
001542 FE      3884 CP	')'
001543 29   
001544 C8      3885 RET	Z
001545 FE      3886 TERM:           CP	';'		;ASSEMBLER TERMINATOR
001546 3B   
001547 C8      3887 RET	Z
001548 FE      3888 CP	'\'
001549 5C   
00154A C8      3889 RET	Z
00154B FE      3890 TERM0:          CP	':'		;ASSEMBLER SEPARATOR
00154C 3A   
00154D D0      3891 RET	NC
00154E FE      3892 CP	CR
00154F 0D   
001550 C9      3893 RET
001551 4E      3895 OPCODS:         DB	"NO"
001552 4F   
001553 D0      3896 DB	'P'+80H
001554 00      3897 DB	0
001555 52      3898 DB	"RLC"
001556 4C   
001557 43   
001558 C1      3899 DB	'A'+80H
001559 07      3900 DB	7
00155A 45      3901 DB	"EX"
00155B 58   
00155C 00      3902 DB	0
00155D 41      3903 DB	"AF"
00155E 46   
00155F 00      3904 DB	0
001560 41      3905 DB	"AF"
001561 46   
001562 A7      3906 DB	27H+80H ; APOSTROPHE
001563 08      3907 DB	8
001564 52      3908 DB	"RRC"
001565 52   
001566 43   
001567 C1      3909 DB	'A'+80H
001568 0F      3910 DB	0FH
001569 52      3911 DB	"RL"
00156A 4C   
00156B C1      3912 DB	'A'+80H
00156C 17      3913 DB	17H
00156D 52      3914 DB	"RR"
00156E 52   
00156F C1      3915 DB	'A'+80H
001570 1F      3916 DB	1FH
001571 44      3917 DB	"DA"
001572 41   
001573 C1      3918 DB	'A'+80H
001574 27      3919 DB	27H
001575 43      3920 DB	"CP"
001576 50   
001577 CC      3921 DB	'L'+80H
001578 2F      3922 DB	2FH
001579 53      3923 DB	"SC"
00157A 43   
00157B C6      3924 DB	'F'+80H
00157C 37      3925 DB	37H
00157D 43      3926 DB	"CC"
00157E 43   
00157F C6      3927 DB	'F'+80H
001580 3F      3928 DB	3FH
001581 48      3929 DB	"HAL"
001582 41   
001583 4C   
001584 D4      3930 DB	'T'+80H
001585 76      3931 DB	76H
001586 45      3932 DB	"EX"
001587 58   
001588 D8      3933 DB	'X'+80H
001589 D9      3934 DB	0D9H
00158A 45      3935 DB	"EX"
00158B 58   
00158C 00      3936 DB	0
00158D 44      3937 DB	"DE"
00158E 45   
00158F 00      3938 DB	0
001590 48      3939 DB	'H'
001591 CC      3940 DB	'L'+80H
001592 EB      3941 DB	0EBH
001593 44      3942 DB	'D'
001594 C9      3943 DB	'I'+80H
001595 F3      3944 DB	0F3H
001596 45      3945 DB	'E'
001597 C9      3946 DB	'I'+80H
001598 FB      3947 DB	0FBH
001599 4E      3949 DB	"NE"
00159A 45   
00159B C7      3950 DB	'G'+80H
00159C 44      3951 DB	44H
00159D 49      3952 DB	"IM"
00159E 4D   
00159F 00      3953 DB	0
0015A0 B0      3954 DB	'0'+80H
0015A1 46      3955 DB	46H
0015A2 52      3956 DB	"RET"
0015A3 45   
0015A4 54   
0015A5 CE      3957 DB	'N'+80H
0015A6 45      3958 DB	45H
0015A7 52      3959 DB	"RET"
0015A8 45   
0015A9 54   
0015AA C9      3960 DB	'I'+80H
0015AB 4D      3961 DB	4DH
0015AC 49      3962 DB	"IM"
0015AD 4D   
0015AE 00      3963 DB	0
0015AF B1      3964 DB	'1'+80H
0015B0 56      3965 DB	56H
0015B1 49      3966 DB	"IM"
0015B2 4D   
0015B3 00      3967 DB	0
0015B4 B2      3968 DB	'2'+80H
0015B5 5E      3969 DB	5EH
0015B6 52      3970 DB	"RR"
0015B7 52   
0015B8 C4      3971 DB	'D'+80H
0015B9 67      3972 DB	67H
0015BA 52      3973 DB	"RL"
0015BB 4C   
0015BC C4      3974 DB	'D'+80H
0015BD 6F      3975 DB	6FH
0015BE 4C      3976 DB	"LD"
0015BF 44   
0015C0 C9      3977 DB	'I'+80H
0015C1 A0      3978 DB	0A0H
0015C2 43      3979 DB	"CP"
0015C3 50   
0015C4 C9      3980 DB	'I'+80H
0015C5 A1      3981 DB	0A1H
0015C6 49      3982 DB	"IN"
0015C7 4E   
0015C8 C9      3983 DB	'I'+80H
0015C9 A2      3984 DB	0A2H
0015CA 4F      3985 DB	"OUT"
0015CB 55   
0015CC 54   
0015CD C9      3986 DB	'I'+80H
0015CE A3      3987 DB	0A3H
0015CF 4C      3988 DB	"LD"
0015D0 44   
0015D1 C4      3989 DB	'D'+80H
0015D2 A8      3990 DB	0A8H
0015D3 43      3991 DB	"CP"
0015D4 50   
0015D5 C4      3992 DB	'D'+80H
0015D6 A9      3993 DB	0A9H
0015D7 49      3994 DB	"IN"
0015D8 4E   
0015D9 C4      3995 DB	'D'+80H
0015DA AA      3996 DB	0AAH
0015DB 4F      3997 DB	"OUT"
0015DC 55   
0015DD 54   
0015DE C4      3998 DB	'D'+80H
0015DF AB      3999 DB	0ABH
0015E0 4C      4000 DB	"LDI"
0015E1 44   
0015E2 49   
0015E3 D2      4001 DB	'R'+80H
0015E4 B0      4002 DB	0B0H
0015E5 43      4003 DB	"CPI"
0015E6 50   
0015E7 49   
0015E8 D2      4004 DB	'R'+80H
0015E9 B1      4005 DB	0B1H
0015EA 49      4006 DB	"INI"
0015EB 4E   
0015EC 49   
0015ED D2      4007 DB	'R'+80H
0015EE B2      4008 DB	0B2H
0015EF 4F      4009 DB	"OTI"
0015F0 54   
0015F1 49   
0015F2 D2      4010 DB	'R'+80H
0015F3 B3      4011 DB	0B3H
0015F4 4C      4012 DB	"LDD"
0015F5 44   
0015F6 44   
0015F7 D2      4013 DB	'R'+80H
0015F8 B8      4014 DB	0B8H
0015F9 43      4015 DB	"CPD"
0015FA 50   
0015FB 44   
0015FC D2      4016 DB	'R'+80H
0015FD B9      4017 DB	0B9H
0015FE 49      4018 DB	"IND"
0015FF 4E   
001600 44   
001601 D2      4019 DB	'R'+80H
001602 BA      4020 DB	0BAH
001603 4F      4021 DB	"OTD"
001604 54   
001605 44   
001606 D2      4022 DB	'R'+80H
001607 BB      4023 DB	0BBH
001608 42      4025 DB	"BI"
001609 49   
00160A D4      4026 DB	'T'+80H
00160B 40      4027 DB	40H
00160C 52      4028 DB	"RE"
00160D 45   
00160E D3      4029 DB	'S'+80H
00160F 80      4030 DB	80H
001610 53      4031 DB	"SE"
001611 45   
001612 D4      4032 DB	'T'+80H
001613 C0      4033 DB	0C0H
001614 52      4035 DB	"RL"
001615 4C   
001616 C3      4036 DB	'C'+80H
001617 00      4037 DB	0
001618 52      4038 DB	"RR"
001619 52   
00161A C3      4039 DB	'C'+80H
00161B 08      4040 DB	8
00161C 52      4041 DB	'R'
00161D CC      4042 DB	'L'+80H
00161E 10      4043 DB	10H
00161F 52      4044 DB	'R'
001620 D2      4045 DB	'R'+80H
001621 18      4046 DB	18H
001622 53      4047 DB	"SL"
001623 4C   
001624 C1      4048 DB	'A'+80H
001625 20      4049 DB	20H
001626 53      4050 DB	"SR"
001627 52   
001628 C1      4051 DB	'A'+80H
001629 28      4052 DB	28H
00162A 53      4053 DB	"SR"
00162B 52   
00162C CC      4054 DB	'L'+80H
00162D 38      4055 DB	38H
00162E 50      4057 DB	"PO"
00162F 4F   
001630 D0      4058 DB	'P'+80H
001631 C1      4059 DB	0C1H
001632 50      4060 DB	"PUS"
001633 55   
001634 53   
001635 C8      4061 DB	'H'+80H
001636 C5      4062 DB	0C5H
001637 45      4063 DB	"EX"
001638 58   
001639 00      4064 DB	0
00163A 28      4065 DB	"(S"
00163B 53   
00163C D0      4066 DB	'P'+80H
00163D E3      4067 DB	0E3H
00163E 53      4069 DB	"SU"
00163F 55   
001640 C2      4070 DB	'B'+80H
001641 90      4071 DB	90H
001642 41      4072 DB	"AN"
001643 4E   
001644 C4      4073 DB	'D'+80H
001645 A0      4074 DB	0A0H
001646 58      4075 DB	"XO"
001647 4F   
001648 D2      4076 DB	'R'+80H
001649 A8      4077 DB	0A8H
00164A 4F      4078 DB	'O'
00164B D2      4079 DB	'R'+80H
00164C B0      4080 DB	0B0H
00164D 43      4081 DB	'C'
00164E D0      4082 DB	'P'+80H
00164F B8      4083 DB	0B8H
001650 80      4084 DB	TAND
001651 A0      4085 DB	0A0H
001652 84      4086 DB	TOR
001653 B0      4087 DB	0B0H
001654 41      4089 DB	"AD"
001655 44   
001656 C4      4090 DB	'D'+80H
001657 80      4091 DB	80H
001658 41      4092 DB	"AD"
001659 44   
00165A C3      4093 DB	'C'+80H
00165B 88      4094 DB	88H
00165C 53      4095 DB	"SB"
00165D 42   
00165E C3      4096 DB	'C'+80H
00165F 98      4097 DB	98H
001660 49      4099 DB	"IN"
001661 4E   
001662 C3      4100 DB	'C'+80H
001663 04      4101 DB	4
001664 44      4102 DB	"DE"
001665 45   
001666 C3      4103 DB	'C'+80H
001667 05      4104 DB	5
001668 49      4106 DB	'I'
001669 CE      4107 DB	'N'+80H
00166A 40      4108 DB	40H
00166B 4F      4109 DB	"OU"
00166C 55   
00166D D4      4110 DB	'T'+80H
00166E 41      4111 DB	41H
00166F 4A      4113 DB	'J'
001670 D2      4114 DB	'R'+80H
001671 20      4115 DB	20H
001672 44      4116 DB	"DJN"
001673 4A   
001674 4E   
001675 DA      4117 DB	'Z'+80H
001676 10      4118 DB	10H
001677 4A      4120 DB	'J'
001678 D0      4121 DB	'P'+80H
001679 C2      4122 DB	0C2H
00167A 43      4124 DB	"CAL"
00167B 41   
00167C 4C   
00167D CC      4125 DB	'L'+80H
00167E C4      4126 DB	0C4H
00167F 52      4128 DB	"RS"
001680 53   
001681 D4      4129 DB	'T'+80H
001682 C7      4130 DB	0C7H
001683 52      4132 DB	"RE"
001684 45   
001685 D4      4133 DB	'T'+80H
001686 C0      4134 DB	0C0H
001687 4C      4136 DB	'L'
001688 C4      4137 DB	'D'+80H
001689 40      4138 DB	40H
00168A 5D      4140 DB	TDEF & 7FH
00168B CD      4141 DB	'M'+80H
00168C 00      4142 DB	0
00168D 5D      4144 DB	TDEF & 7FH
00168E C2      4145 DB	'B'+80H
00168F 00      4146 DB	0
001690 4F      4148 DB	"OP"
001691 50   
001692 D4      4149 DB	'T'+80H
001693 00      4150 DB	0
001694 5D      4152 DB	TDEF & 7FH
001695 D7      4153 DB	'W'+80H
001696 00      4154 DB	0
001697 00      4156 DB	0
001698 C2      4158 OPRNDS:         DB	'B'+80H
001699 00      4159 DB	0
00169A C3      4160 DB	'C'+80H
00169B 01      4161 DB	1
00169C C4      4162 DB	'D'+80H
00169D 02      4163 DB	2
00169E C5      4164 DB	'E'+80H
00169F 03      4165 DB	3
0016A0 C8      4166 DB	'H'+80H
0016A1 04      4167 DB	4
0016A2 CC      4168 DB	'L'+80H
0016A3 05      4169 DB	5
0016A4 28      4170 DB	"(H"
0016A5 48   
0016A6 CC      4171 DB	'L'+80H
0016A7 06      4172 DB	6
0016A8 C1      4173 DB	'A'+80H
0016A9 07      4174 DB	7
0016AA 28      4175 DB	"(I"
0016AB 49   
0016AC D8      4176 DB	'X'+80H
0016AD 86      4177 DB	86H
0016AE 28      4178 DB	"(I"
0016AF 49   
0016B0 D9      4179 DB	'Y'+80H
0016B1 C6      4180 DB	0C6H
0016B2 42      4182 DB	'B'
0016B3 C3      4183 DB	'C'+80H
0016B4 08      4184 DB	8
0016B5 44      4185 DB	'D'
0016B6 C5      4186 DB	'E'+80H
0016B7 0A      4187 DB	10
0016B8 48      4188 DB	'H'
0016B9 CC      4189 DB	'L'+80H
0016BA 0C      4190 DB	12
0016BB 49      4191 DB	'I'
0016BC D8      4192 DB	'X'+80H
0016BD 8C      4193 DB	8CH
0016BE 49      4194 DB	'I'
0016BF D9      4195 DB	'Y'+80H
0016C0 CC      4196 DB	0CCH
0016C1 41      4197 DB	'A'
0016C2 C6      4198 DB	'F'+80H
0016C3 0E      4199 DB	14
0016C4 53      4200 DB	'S'
0016C5 D0      4201 DB	'P'+80H
0016C6 0E      4202 DB	14
0016C7 4E      4204 DB	'N'
0016C8 DA      4205 DB	'Z'+80H
0016C9 10      4206 DB	16
0016CA DA      4207 DB	'Z'+80H
0016CB 11      4208 DB	17
0016CC 4E      4209 DB	'N'
0016CD C3      4210 DB	'C'+80H
0016CE 12      4211 DB	18
0016CF 50      4212 DB	'P'
0016D0 CF      4213 DB	'O'+80H
0016D1 14      4214 DB	20
0016D2 50      4215 DB	'P'
0016D3 C5      4216 DB	'E'+80H
0016D4 15      4217 DB	21
0016D5 D0      4218 DB	'P'+80H
0016D6 16      4219 DB	22
0016D7 CD      4220 DB	'M'+80H
0016D8 17      4221 DB	23
0016D9 28      4223 DB	'('
0016DA C3      4224 DB	'C'+80H
0016DB 20      4225 DB	20H
0016DC 00      4227 DB	0
0016DD 49      4229 LDOPS:          DB	'I'
0016DE 00      4230 DB	0
0016DF C1      4231 DB	'A'+80H
0016E0 47      4232 DB	47H
0016E1 52      4233 DB	'R'
0016E2 00      4234 DB	0
0016E3 C1      4235 DB	'A'+80H
0016E4 4F      4236 DB	4FH
0016E5 41      4237 DB	'A'
0016E6 00      4238 DB	0
0016E7 C9      4239 DB	'I'+80H
0016E8 57      4240 DB	57H
0016E9 41      4241 DB	'A'
0016EA 00      4242 DB	0
0016EB D2      4243 DB	'R'+80H
0016EC 5F      4244 DB	5FH
0016ED 28      4245 DB	"(BC"
0016EE 42   
0016EF 43   
0016F0 00      4246 DB	0
0016F1 C1      4247 DB	'A'+80H
0016F2 02      4248 DB	2
0016F3 28      4249 DB	"(DE"
0016F4 44   
0016F5 45   
0016F6 00      4250 DB	0
0016F7 C1      4251 DB	'A'+80H
0016F8 12      4252 DB	12H
0016F9 41      4253 DB	'A'
0016FA 00      4254 DB	0
0016FB 28      4255 DB	"(B"
0016FC 42   
0016FD C3      4256 DB	'C'+80H
0016FE 0A      4257 DB	0AH
0016FF 41      4258 DB	'A'
001700 00      4259 DB	0
001701 28      4260 DB	"(D"
001702 44   
001703 C5      4261 DB	'E'+80H
001704 1A      4262 DB	1AH
001705 00      4264 DB	0
001706             4269   ; --- Begin eval.asm ---
001706 E4      4406 FUNTBL:         DW	DECODE		;Line number
001707 1F   
001708 DF      4407 DW	OPENIN		;OPENIN
001709 1B   
00170A FC      4408 DW	PTRev		;PTR
00170B 1B   
00170C B1      4409 DW	PAGEVev		;PAGE
00170D 1B   
00170E 04      4410 DW	TIMEVev		;TIME
00170F 1C   
001710 A7      4411 DW	LOMEMVev		;LOMEM
001711 1B   
001712 AC      4412 DW	HIMEMVev		;HIMEM
001713 1B   
001714 50      4413 DW	ABSev		;ABS
001715 1C   
001716 8C      4414 DW	ACSev		;ACS
001717 1C   
001718 6B      4415 DW	ADVAL		;ADVAL
001719 0E   
00171A 94      4416 DW	ASC		;ASC
00171B 1B   
00171C 84      4417 DW	ASNev		;ASN
00171D 1C   
00171E 88      4418 DW	ATNev		;ATN
00171F 1C   
001720 70      4419 DW	BGET		;BGET
001721 1B   
001722 70      4420 DW	COSev		;COS
001723 1C   
001724 CF      4421 DW	COUNTV		;COUNT
001725 1B   
001726 58      4422 DW	DEGev		;DEG
001727 1C   
001728 C5      4423 DW	ERLV		;ERL
001729 1B   
00172A CA      4424 DW	ERRV		;ERR
00172B 1B   
00172C B0      4425 DW	EVAL_		;EVAL_
00172D 1C   
00172E 78      4426 DW	EXPev		;EXP
00172F 1C   
001730 F4      4427 DW	EXTev		;EXT
001731 1B   
001732 7C      4428 DW	ZERO		;FALSE
001733 20   
001734 67      4429 DW	FN		;FN
001735 2A   
001736 7E      4430 DW	GET		;GET
001737 1B   
001738 79      4431 DW	INKEY		;INKEY
001739 1B   
00173A 29      4432 DW	INSTR		;INSTR(
00173B 1E   
00173C 64      4433 DW	INT_ev		;INT_
00173D 1C   
00173E A1      4434 DW	LEN		;LEN
00173F 1B   
001740 7C      4435 DW	LNev		;LN
001741 1C   
001742 80      4436 DW	LOGev		;LOG
001743 1C   
001744 54      4437 DW	CPL_ev		;NOT
001745 1C   
001746 DC      4438 DW	OPENUP		;OPENUP
001747 1B   
001748 DA      4439 DW	OPENOT		;OPENOUT
001749 1B   
00174A 4C      4440 DW	PIev		;PI
00174B 1C   
00174C 38      4441 DW	POINT		;POINT(
00174D 0E   
00174E 59      4442 DW	POS		;POS
00174F 1B   
001750 5C      4443 DW	RADev		;RAD
001751 1C   
001752 DD      4444 DW	RND		;RND
001753 1C   
001754 60      4445 DW	SGNev		;SGN
001755 1C   
001756 74      4446 DW	SINev		;SIN
001757 1C   
001758 68      4447 DW	SQRev		;SQR
001759 1C   
00175A 6C      4448 DW	TANev		;TAN
00175B 1C   
00175C B6      4449 DW	TOPV		;TO(P)
00175D 1B   
00175E 41      4450 DW	TRUEev		;TRUE
00175F 1C   
001760 C3      4451 DW	USR		;USR
001761 30   
001762 A3      4452 DW	VALev		;VAL
001763 1C   
001764 5F      4453 DW	VPOS		;VPOS
001765 1B   
001766 AA      4454 DW	CHRS		;CHR$
001767 1E   
001768 B1      4455 DW	GETS		;GET$
001769 1E   
00176A 12      4456 DW	INKEYS		;INKEY$
00176B 1F   
00176C 52      4457 DW	LEFTS		;LEFT$(
00176D 1F   
00176E 22      4458 DW	MIDS		;MID$(
00176F 1F   
001770 80      4459 DW	RIGHTS		;RIGHT$(
001771 1F   
001772 3C      4460 DW	STRS		;STR$
001773 20   
001774 AA      4461 DW	STRING_		;STRING_$(
001775 1F   
001776 64      4462 DW	EOF		;EOF
001777 1B   
001778 6D      4463 DW	SUM		;SUM
001779 1D   
00177A 2F      4476 SOPTBL:         DW	SLE		;<= (STRING)
00177B 1C   
00177C 37      4477 DW	SNE		;<>
00177D 1C   
00177E 29      4478 DW	SGE		;>=
00177F 1C   
001780 1C      4479 DW	SLT		;<
001781 1C   
001782 3D      4480 DW	SEQ		;=
001783 1C   
001784 22      4481 DW	SGT		;>
001785 1C   
001786 CD      4500 EXPR:           CALL	EXPR1		;GET FIRST OPERAND
001787 9B   
001788 17   
001789 FE      4501 EXPR0A:         CP	EOR		;CHECK OPERATOR
00178A 82   
00178B 28      4502 JR	Z,EXPR0B
00178C 03   
00178D FE      4503 CP	OR_
00178E 84   
00178F C0      4504 RET	NZ
001790 CD      4505 EXPR0B:         CALL	SAVEev		;SAVE FIRST OPERAND
001791 F7   
001792 20   
001793 CD      4506 CALL	EXPR1		;GET SECOND OPERAND
001794 9B   
001795 17   
001796 CD      4507 CALL	DOIT		;DO OPERATION
001797 07   
001798 21   
001799 18      4508 JR	EXPR0A		;CONTINUE
00179A EE   
00179B CD      4510 EXPR1:          CALL	EXPR2
00179C AC   
00179D 17   
00179E FE      4511 EXPR1A:         CP	AND_
00179F 80   
0017A0 C0      4512 RET	NZ
0017A1 CD      4513 CALL	SAVEev
0017A2 F7   
0017A3 20   
0017A4 CD      4514 CALL	EXPR2
0017A5 AC   
0017A6 17   
0017A7 CD      4515 CALL	DOIT
0017A8 07   
0017A9 21   
0017AA 18      4516 JR	EXPR1A
0017AB F2   
0017AC CD      4518 EXPR2:          CALL	EXPR3ev
0017AD 24   
0017AE 18   
0017AF CD      4519 CALL	RELOPQ
0017B0 EE   
0017B1 20   
0017B2 C0      4520 RET	NZ
0017B3 47      4521 LD	B,A
0017B4 FD      4522 INC	IY		;BUMP OVER OPERATOR
0017B5 23   
0017B6 CD      4523 CALL	NXT
0017B7 8F   
0017B8 45   
0017B9 CD      4524 CALL	RELOPQ		;COMPOUND OPERATOR?
0017BA EE   
0017BB 20   
0017BC 20      4525 JR	NZ,EXPR2B
0017BD 07   
0017BE FD      4526 INC	IY
0017BF 23   
0017C0 B8      4527 CP	B
0017C1 28      4528 JR	Z,SHIFT		;SHIFT | ==
0017C2 1C   
0017C3 80      4529 ADD	A,B
0017C4 47      4530 LD	B,A
0017C5 78      4531 EXPR2B:         LD	A,B
0017C6 08      4532 EX	AF,AF'
0017C7 FA      4533 JP	M,EXPR2S
0017C8 F7   
0017C9 17   
0017CA 08      4534 EX	AF,AF'
0017CB D6      4535 SUB	4
0017CC 04   
0017CD FE      4536 CP	'>'-4
0017CE 3A   
0017CF 20      4537 JR	NZ,EXPR2C
0017D0 02   
0017D1 C6      4538 ADD	A,2
0017D2 02   
0017D3 E6      4539 EXPR2C:         AND	0FH
0017D4 0F   
0017D5 CD      4540 EXPR2D:         CALL	SAVE1
0017D6 FB   
0017D7 20   
0017D8 CD      4541 CALL	EXPR3ev
0017D9 24   
0017DA 18   
0017DB CD      4542 CALL	DOIT		;Must NOT be "JP DOIT"
0017DC 07   
0017DD 21   
0017DE C9      4543 RET
0017DF FE      4545 SHIFT:          CP	'='
0017E0 3D   
0017E1 28      4546 JR	Z,EXPR2B	;==
0017E2 E2   
0017E3 CD      4547 CALL	NXT
0017E4 8F   
0017E5 45   
0017E6 CD      4548 CALL	RELOPQ
0017E7 EE   
0017E8 20   
0017E9 20      4549 JR	NZ,SHIFT1
0017EA 07   
0017EB B8      4550 CP	B
0017EC C2      4551 JP	NZ,SYNTAX
0017ED 64   
0017EE 26   
0017EF FD      4552 INC	IY
0017F0 23   
0017F1 04      4553 INC	B
0017F2 78      4554 SHIFT1:         LD	A,B
0017F3 D6      4555 SUB	18
0017F4 12   
0017F5 18      4556 JR	EXPR2D
0017F6 DE   
0017F7 08      4558 EXPR2S:         EX	AF,AF'
0017F8 3D      4559 DEC	A
0017F9 E6      4560 AND	7
0017FA 07   
0017FB CD      4561 CALL	PUSHS		;SAVE STRING ON STACK
0017FC 9D   
0017FD 20   
0017FE F5      4562 PUSH	AF		;SAVE OPERATOR
0017FF CD      4563 CALL	EXPR3ev		;SECOND STRING
001800 24   
001801 18   
001802 08      4564 EX	AF,AF'
001803 F2      4565 JP	P,MISMATev
001804 F2   
001805 18   
001806 F1      4566 POP	AF
001807 4B      4567 LD	C,E		;LENGTH OF STRING #2
001808 D1      4568 POP	DE
001809 21      4569 LD	HL,0
00180A 00   
00180B 00   
00180C 39      4570 ADD	HL,SP
00180D 43      4571 LD	B,E		;LENGTH OF STRING #1
00180E D5      4572 PUSH	DE
00180F 11      4573 LD	DE,ACCS
001810 00   
001811 53   
001812 EB      4574 EX	DE,HL
001813 CD      4575 CALL	DISPT2
001814 3F   
001815 21   
001816 D1      4576 POP	DE
001817 EB      4577 EX	DE,HL
001818 26      4578 LD	H,0
001819 00   
00181A 39      4579 ADD	HL,SP
00181B F9      4580 LD	SP,HL
00181C EB      4581 EX	DE,HL
00181D AF      4582 XOR	A		;NUMERIC MARKER
00181E 4F      4583 LD	C,A		;INTEGER MARKER
00181F 08      4584 EX	AF,AF'
001820 FD      4585 LD	A,(IY)
001821 7E   
001822 00   
001823 C9      4586 RET
001824 CD      4588 EXPR3ev:          CALL	EXPR4
001825 72   
001826 18   
001827 FE      4589 EXPR3A:         CP	'-'
001828 2D   
001829 28      4590 JR	Z,EXPR3B
00182A 08   
00182B FE      4591 CP	'+'
00182C 2B   
00182D C0      4592 RET	NZ
00182E 08      4593 EX	AF,AF'
00182F FA      4594 JP	M,EXPR3S
001830 3E   
001831 18   
001832 08      4595 EX	AF,AF'
001833 CD      4596 EXPR3B:         CALL	SAVEev
001834 F7   
001835 20   
001836 CD      4597 CALL	EXPR4
001837 72   
001838 18   
001839 CD      4598 CALL	DOIT
00183A 07   
00183B 21   
00183C 18      4599 JR	EXPR3A
00183D E9   
00183E 08      4601 EXPR3S:         EX	AF,AF'
00183F FD      4602 INC	IY		;BUMP PAST '+'
001840 23   
001841 CD      4603 CALL	PUSHS		;SAVE STRING ON STACK
001842 9D   
001843 20   
001844 CD      4604 CALL	EXPR4		;SECOND STRING
001845 72   
001846 18   
001847 08      4605 EX	AF,AF'
001848 F2      4606 JP	P,MISMATev
001849 F2   
00184A 18   
00184B 4B      4607 LD	C,E		;C=LENGTH
00184C D1      4608 POP	DE
00184D D5      4609 PUSH	DE
00184E 21      4610 LD	HL,ACCS
00184F 00   
001850 53   
001851 54      4611 LD	D,H
001852 79      4612 LD	A,C
001853 B7      4613 OR	A
001854 28      4614 JR	Z,EXP3S3
001855 0E   
001856 45      4615 LD	B,L
001857 6F      4616 LD	L,A		;SOURCE
001858 83      4617 ADD	A,E
001859 5F      4618 LD	E,A		;DESTINATION
00185A 3E      4619 LD	A,19
00185B 13   
00185C 38      4620 JR	C,ERROR2ev	;"String too long"
00185D 6B   
00185E D5      4621 PUSH	DE
00185F 1D      4622 DEC	E
001860 2D      4623 DEC	L
001861 ED      4624 LDDR			;COPY
001862 B8   
001863 D1      4625 POP	DE
001864 D9      4626 EXP3S3:         EXX
001865 C1      4627 POP	BC
001866 CD      4628 CALL	POPS		;RESTORE FROM STACK
001867 BB   
001868 20   
001869 D9      4629 EXX
00186A F6      4630 OR	80H		;FLAG STRING
00186B 80   
00186C 08      4631 EX	AF,AF'
00186D FD      4632 LD	A,(IY)
00186E 7E   
00186F 00   
001870 18      4633 JR	EXPR3A
001871 B5   
001872 CD      4635 EXPR4:          CALL	EXPR5
001873 98   
001874 18   
001875 FE      4636 EXPR4A:         CP	'*'
001876 2A   
001877 28      4637 JR	Z,EXPR4B
001878 0B   
001879 FE      4638 CP	'/'
00187A 2F   
00187B 28      4639 JR	Z,EXPR4B
00187C 07   
00187D FE      4640 CP	MOD_
00187E 83   
00187F 28      4641 JR	Z,EXPR4B
001880 03   
001881 FE      4642 CP	DIV_
001882 81   
001883 C0      4643 RET	NZ
001884 CD      4644 EXPR4B:         CALL	SAVEev
001885 F7   
001886 20   
001887 CD      4645 CALL	EXPR5
001888 98   
001889 18   
00188A CD      4646 CALL	DOIT
00188B 07   
00188C 21   
00188D 18      4647 JR	EXPR4A
00188E E6   
00188F 7B      4649 EXPR45:         LD	A,E
001890 FE      4650 CP	'+'
001891 2B   
001892 28      4651 JR	Z,EXPR4
001893 DE   
001894 FE      4652 CP	'-'
001895 2D   
001896 28      4653 JR	Z,EXPR4
001897 DA   
001898 CD      4654 EXPR5:          CALL	ITEM
001899 54   
00189A 19   
00189B B7      4655 OR	A		;TEST TYPE
00189C 08      4656 EX	AF,AF'		;SAVE TYPE
00189D CD      4657 EXPR5A:         CALL	NXT
00189E 8F   
00189F 45   
0018A0 FE      4658 CP	'^'
0018A1 5E   
0018A2 C0      4659 RET	NZ
0018A3 CD      4660 CALL	SAVEev
0018A4 F7   
0018A5 20   
0018A6 CD      4661 CALL	ITEM
0018A7 54   
0018A8 19   
0018A9 B7      4662 OR	A
0018AA 08      4663 EX	AF,AF'
0018AB CD      4664 CALL	DOIT
0018AC 07   
0018AD 21   
0018AE 18      4665 JR	EXPR5A
0018AF ED   
0018B0 CD      4667 EXPRN:          CALL	EXPR
0018B1 86   
0018B2 17   
0018B3 08      4668 EX	AF,AF'
0018B4 F0      4669 RET	P
0018B5 18      4670 JR	MISMATev
0018B6 3B   
0018B7 CD      4672 EXPRI:          CALL	EXPR
0018B8 86   
0018B9 17   
0018BA 08      4673 EX	AF,AF'
0018BB F2      4674 JP	P,SFIX
0018BC 9B   
0018BD 1C   
0018BE 18      4675 JR	MISMATev
0018BF 32   
0018C0 CD      4677 EXPRS:          CALL	EXPR
0018C1 86   
0018C2 17   
0018C3 08      4678 EX	AF,AF'
0018C4 F8      4679 RET	M
0018C5 18      4680 JR	MISMATev
0018C6 2B   
0018C7 3E      4682 BADHEX:         LD	A,28
0018C8 1C   
0018C9 C3      4683 ERROR2ev:         JP	ERROR_		;"Bad HEX or binary"
0018CA C8   
0018CB 3F   
0018CC D9      4685 NEGATEev:         EXX
0018CD 7C      4686 LD	A,H
0018CE 2F      4687 CPL
0018CF 67      4688 LD	H,A
0018D0 7D      4689 LD	A,L
0018D1 2F      4690 CPL
0018D2 6F      4691 LD	L,A
0018D3 D9      4692 EXX
0018D4 7C      4693 LD	A,H
0018D5 2F      4694 CPL
0018D6 67      4695 LD	H,A
0018D7 7D      4696 LD	A,L
0018D8 2F      4697 CPL
0018D9 6F      4698 LD	L,A
0018DA D9      4699 ADD1ev:           EXX
0018DB 23      4700 INC	HL
0018DC 7C      4701 LD	A,H
0018DD B5      4702 OR	L
0018DE D9      4703 EXX
0018DF 3E      4704 LD	A,0		;NUMERIC MARKER
0018E0 00   
0018E1 C0      4705 RET	NZ
0018E2 23      4706 INC	HL
0018E3 C9      4707 RET
0018E4 CD      4709 ITEMI:          CALL	ITEM
0018E5 54   
0018E6 19   
0018E7 B7      4710 OR	A
0018E8 F2      4711 JP	P,SFIX
0018E9 9B   
0018EA 1C   
0018EB 18      4712 JR	MISMATev
0018EC 05   
0018ED CD      4714 ITEMS:          CALL	ITEM
0018EE 54   
0018EF 19   
0018F0 B7      4715 OR	A
0018F1 F8      4716 RET	M
0018F2 3E      4717 MISMATev:         LD	A,6
0018F3 06   
0018F4 18      4718 JR	ERROR2ev		;"Type mismatch"
0018F5 D3   
0018F6 CD      4720 ITEM1:          CALL	EXPR		;BRACKETED EXPR
0018F7 86   
0018F8 17   
0018F9 CD      4721 CALL	BRAKET
0018FA 32   
0018FB 21   
0018FC 08      4722 EX	AF,AF'
0018FD C9      4723 RET
0018FE CD      4725 ITEMN:          CALL	ITEM
0018FF 54   
001900 19   
001901 B7      4726 OR	A
001902 F0      4727 RET	P
001903 18      4728 JR	MISMATev
001904 ED   
001905 CD      4735 HEXev:            CALL	ZERO
001906 7C   
001907 20   
001908 CD      4736 CALL	HEXDIG
001909 DB   
00190A 20   
00190B 38      4737 JR	C,BADHEX
00190C BA   
00190D FD      4738 HEX1:           INC	IY
00190E 23   
00190F E6      4739 AND	0FH
001910 0F   
001911 06      4740 LD	B,4
001912 04   
001913 D9      4741 HEX2:           EXX
001914 29      4742 ADD	HL,HL
001915 D9      4743 EXX
001916 ED      4744 ADC	HL,HL
001917 6A   
001918 10      4745 DJNZ	HEX2
001919 F9   
00191A D9      4746 EXX
00191B B5      4747 OR	L
00191C 6F      4748 LD	L,A
00191D D9      4749 EXX
00191E CD      4750 CALL	HEXDIG
00191F DB   
001920 20   
001921 30      4751 JR	NC,HEX1
001922 EA   
001923 AF      4752 XOR	A
001924 C9      4753 RET
001925 CD      4760 BIN:            CALL	ZERO
001926 7C   
001927 20   
001928 CD      4761 CALL	BINDIG
001929 CE   
00192A 20   
00192B 38      4762 JR	C,BADHEX
00192C 9A   
00192D FD      4763 BIN1:           INC	IY
00192E 23   
00192F CB      4764 RR	A
001930 1F   
001931 D9      4765 EXX
001932 ED      4766 ADC	HL,HL
001933 6A   
001934 D9      4767 EXX
001935 ED      4768 ADC	HL,HL
001936 6A   
001937 CD      4769 CALL	BINDIG
001938 CE   
001939 20   
00193A 30      4770 JR	NC,BIN1
00193B F1   
00193C AF      4771 XOR	A
00193D C9      4772 RET
00193E CD      4779 MINUS:          CALL	ITEMN
00193F FE   
001940 18   
001941 0D      4780 MINUS0:         DEC	C
001942 0C      4781 INC	C
001943 28      4782 JR	Z,NEGATEev	;ZERO/INTEGER
001944 87   
001945 7C      4783 LD	A,H
001946 EE      4784 XOR	80H		;CHANGE SIGN (FP)
001947 80   
001948 67      4785 LD	H,A
001949 AF      4786 XOR	A		;NUMERIC MARKER
00194A C9      4787 RET
00194B CD      4789 ADDROF:         CALL	VAR_
00194C 5A   
00194D 26   
00194E E5      4790 PUSH	HL
00194F D9      4791 EXX
001950 E1      4792 POP	HL
001951 C3      4793 JP	COUNT1
001952 D4   
001953 1B   
001954 CD      4802 ITEM:           CALL	CHECK
001955 0A   
001956 33   
001957 CD      4803 CALL	NXT
001958 8F   
001959 45   
00195A FD      4804 INC	IY
00195B 23   
00195C FE      4805 CP	FUNTOK
00195D 8D   
00195E 38      4806 JR	C,ITEM0
00195F 08   
001960 FE      4807 CP	TCMDev
001961 C7   
001962 DA      4808 JP	C,DISPATev	;FUNCTIONS
001963 45   
001964 21   
001965 C3      4809 JP	EXTRASev		;DIM, END, MODE, REPORT$, WIDTH
001966 B4   
001967 1A   
001968 FE      4811 ITEM0:          CP	':'
001969 3A   
00196A 30      4812 JR	NC,ITEM2	;VARIABLES
00196B 25   
00196C FE      4813 CP	'0'
00196D 30   
00196E 30      4814 JR	NC,CONev		;NUMERIC CONSTANT
00196F 7B   
001970 FE      4815 CP	'('
001971 28   
001972 28      4816 JR	Z,ITEM1		;EXPRESSION
001973 82   
001974 FE      4817 CP	'-'
001975 2D   
001976 28      4818 JR	Z,MINUS		;UNARY MINUS
001977 C6   
001978 FE      4819 CP	'+'
001979 2B   
00197A 28      4820 JR	Z,ITEMN		;UNARY PLUS
00197B 82   
00197C FE      4821 CP	'.'
00197D 2E   
00197E 28      4822 JR	Z,CONev		;NUMERIC CONSTANT
00197F 6B   
001980 FE      4823 CP	'&'
001981 26   
001982 28      4824 JR	Z,HEXev		;HEX CONSTANT
001983 81   
001984 FE      4825 CP	'%'
001985 25   
001986 28      4826 JR	Z,BIN		;BINARY CONSTANT
001987 9D   
001988 FE      4827 CP	'"'
001989 22   
00198A 28      4828 JR	Z,CONS		;STRING CONSTANT
00198B 72   
00198C FE      4829 CP	TTINT
00198D 0A   
00198E CA      4830 JP	Z,TINTev		;TINT FUNCTION
00198F 54   
001990 1B   
001991 FE      4831 ITEM2:          CP	TMOD
001992 83   
001993 CA      4832 JP	Z,MODFUN	;MOD
001994 D1   
001995 1D   
001996 FE      4833 CP	'^'
001997 5E   
001998 28      4834 JR	Z,ADDROF	;^ OPERATOR
001999 B1   
00199A FD      4835 DEC	IY
00199B 2B   
00199C CD      4836 CALL	GETVAR		;VARIABLE
00199D 67   
00199E 42   
00199F 20      4837 JR	NZ,NOSUCHev
0019A0 2F   
0019A1 CB      4838 BIT	6,A
0019A2 77   
0019A3 20      4839 JR	NZ,ARRAYev
0019A4 7E   
0019A5 B7      4840 OR	A
0019A6 FA      4841 JP	M,LOADS		;STRING VARIABLE
0019A7 92   
0019A8 1A   
0019A9 CB      4842 LOADN:          BIT	2,A
0019AA 57   
0019AB 0E      4843 LD	C,0
0019AC 00   
0019AD 28      4844 JR	Z,LOAD1		;BYTE VARIABLE
0019AE 16   
0019AF CB      4845 BIT	0,A
0019B0 47   
0019B1 28      4846 JR	Z,LOAD4		;INTEGER VARIABLE
0019B2 03   
0019B3 DD      4847 LOAD5:          LD	C,(IX+4)
0019B4 4E   
0019B5 04   
0019B6 D9      4848 LOAD4:          EXX
0019B7 DD      4849 LD	L,(IX+0)
0019B8 6E   
0019B9 00   
0019BA DD      4850 LD	H,(IX+1)
0019BB 66   
0019BC 01   
0019BD D9      4851 EXX
0019BE DD      4852 LD	L,(IX+2)
0019BF 6E   
0019C0 02   
0019C1 DD      4853 LD	H,(IX+3)
0019C2 66   
0019C3 03   
0019C4 C9      4854 RET
0019C5 21      4856 LOAD1:          LD	HL,0
0019C6 00   
0019C7 00   
0019C8 D9      4857 EXX
0019C9 26      4858 LD	H,0
0019CA 00   
0019CB DD      4859 LD	L,(IX+0)
0019CC 6E   
0019CD 00   
0019CE D9      4860 EXX
0019CF C9      4861 RET
0019D0 DA      4863 NOSUCHev:         JP	C,SYNTAX
0019D1 64   
0019D2 26   
0019D3 3A      4864 LD	A,(LISTON)
0019D4 FE   
0019D5 55   
0019D6 CB      4865 BIT	5,A
0019D7 6F   
0019D8 3E      4866 LD	A,26
0019D9 1A   
0019DA 20      4867 JR	NZ,ERROR0ev	;"No such variable"
0019DB 36   
0019DC FD      4868 NOS1:           INC	IY
0019DD 23   
0019DE CD      4869 CALL	RANGE
0019DF 73   
0019E0 44   
0019E1 30      4870 JR	NC,NOS1
0019E2 F9   
0019E3 DD      4871 LD	IX,PC
0019E4 21   
0019E5 40   
0019E6 55   
0019E7 AF      4872 XOR	A
0019E8 4F      4873 LD	C,A
0019E9 18      4874 JR	LOAD4
0019EA CB   
0019EB FD      4882 CONev:            DEC	IY
0019EC 2B   
0019ED FD      4883 PUSH	IY
0019EE E5   
0019EF DD      4884 POP	IX
0019F0 E1   
0019F1 3E      4885 LD	A,36
0019F2 24   
0019F3 CD      4886 CALL	FPP
0019F4 99   
0019F5 45   
0019F6 38      4887 JR	C,ERROR0ev
0019F7 1A   
0019F8 DD      4888 PUSH	IX
0019F9 E5   
0019FA FD      4889 POP	IY
0019FB E1   
0019FC AF      4890 XOR	A
0019FD C9      4891 RET
0019FE 11      4900 CONS:           LD	DE,ACCS
0019FF 00   
001A00 53   
001A01 FD      4901 CONS3:          LD	A,(IY)
001A02 7E   
001A03 00   
001A04 FD      4902 INC	IY
001A05 23   
001A06 FE      4903 CP	'"'
001A07 22   
001A08 28      4904 JR	Z,CONS2
001A09 0B   
001A0A 12      4905 CONS1:          LD	(DE),A
001A0B 1C      4906 INC	E
001A0C FE      4907 CP	CR
001A0D 0D   
001A0E 20      4908 JR	NZ,CONS3
001A0F F1   
001A10 3E      4909 LD	A,9
001A11 09   
001A12 C3      4910 ERROR0ev:         JP	ERROR_		;"Missing """
001A13 C8   
001A14 3F   
001A15 FD      4912 CONS2:          LD	A,(IY)
001A16 7E   
001A17 00   
001A18 FE      4913 CP	'"'
001A19 22   
001A1A FD      4914 INC	IY
001A1B 23   
001A1C 28      4915 JR	Z,CONS1
001A1D EC   
001A1E FD      4916 DEC	IY
001A1F 2B   
001A20 3E      4917 LD	A,80H		;STRING MARKER
001A21 80   
001A22 C9      4918 RET
001A23 3E      4920 ARRAYev:          LD	A,14		;'Bad use of array'
001A24 0E   
001A25 C3      4921 JP	ERROR_
001A26 C8   
001A27 3F   
001A28 7E      4930 ARRLEN:         LD	A,(HL)		;Number of dimensions
001A29 23      4931 INC	HL
001A2A B7      4932 OR	A
001A2B 28      4933 JR	Z,ARRAYev
001A2C F6   
001A2D 11      4934 LD	DE,1
001A2E 01   
001A2F 00   
001A30 4E      4935 ARLOOP:         LD	C,(HL)
001A31 23      4936 INC	HL
001A32 46      4937 LD	B,(HL)		;BC = size of this dimension
001A33 23      4938 INC	HL
001A34 EB      4939 EX	DE,HL
001A35 F5      4940 PUSH	AF
001A36 D5      4941 PUSH	DE
001A37 CD      4942 CALL	MUL16		;HL=HL*BC
001A38 41   
001A39 37   
001A3A D1      4943 POP	DE
001A3B F1      4944 POP	AF
001A3C EB      4945 EX	DE,HL
001A3D 3D      4946 DEC	A
001A3E 20      4947 JR	NZ,ARLOOP
001A3F F0   
001A40 C9      4948 RET
001A41 CD      4950 GETARR:         CALL	NXT
001A42 8F   
001A43 45   
001A44 CD      4951 CALL	GETVAR
001A45 67   
001A46 42   
001A47 20      4952 JR	NZ,NOSUCHev
001A48 87   
001A49 CB      4953 BIT	6,A
001A4A 77   
001A4B 37      4954 SCF
001A4C 28      4955 JR	Z,NOSUCHev
001A4D 82   
001A4E E6      4956 AND	8FH
001A4F 8F   
001A50 47      4957 LD	B,A		;Type + size
001A51 7E      4958 GETAR1:         LD	A,(HL)
001A52 23      4959 INC	HL
001A53 66      4960 LD	H,(HL)
001A54 6F      4961 LD	L,A
001A55 E6      4962 AND	0FEH
001A56 FE   
001A57 B4      4963 OR	H
001A58 28      4964 JR	Z,ARRAYev		;Bad use of array
001A59 C9   
001A5A C9      4965 RET
001A5B CD      4967 GETARB:         CALL	NXT
001A5C 8F   
001A5D 45   
001A5E FE      4968 CP	'('
001A5F 28   
001A60 20      4969 JR	NZ,GETARR
001A61 DF   
001A62 FD      4970 INC	IY
001A63 23   
001A64 CD      4971 CALL	GETARR
001A65 41   
001A66 1A   
001A67 CD      4972 CALL	BRAKET
001A68 32   
001A69 21   
001A6A C9      4973 RET
001A6B CB      4975 DLOADN:         BIT	2,A
001A6C 57   
001A6D 06      4976 LD	B,0
001A6E 00   
001A6F 28      4977 JR	Z,DLOAD1	;BYTE VARIABLE
001A70 16   
001A71 CB      4978 BIT	0,A
001A72 47   
001A73 28      4979 JR	Z,DLOAD4	;INTEGER VARIABLE
001A74 03   
001A75 DD      4980 DLOAD5:         LD	B,(IX+4)
001A76 46   
001A77 04   
001A78 D9      4981 DLOAD4:         EXX
001A79 DD      4982 LD	E,(IX+0)
001A7A 5E   
001A7B 00   
001A7C DD      4983 LD	D,(IX+1)
001A7D 56   
001A7E 01   
001A7F D9      4984 EXX
001A80 DD      4985 LD	E,(IX+2)
001A81 5E   
001A82 02   
001A83 DD      4986 LD	D,(IX+3)
001A84 56   
001A85 03   
001A86 C9      4987 RET
001A87 11      4989 DLOAD1:         LD	DE,0
001A88 00   
001A89 00   
001A8A D9      4990 EXX
001A8B 16      4991 LD	D,0
001A8C 00   
001A8D DD      4992 LD	E,(IX+0)
001A8E 5E   
001A8F 00   
001A90 D9      4993 EXX
001A91 C9      4994 RET
001A92 11      4996 LOADS:          LD	DE,ACCS
001A93 00   
001A94 53   
001A95 1F      4997 RRA
001A96 30      4998 JR	NC,LOADS2	;FIXED STRING
001A97 10   
001A98 CD      4999 CALL	LOAD4
001A99 B6   
001A9A 19   
001A9B D9      5000 EXX
001A9C 7D      5001 LD	A,L
001A9D D9      5002 EXX
001A9E B7      5003 OR	A
001A9F 4F      5004 LD	C,A
001AA0 3E      5005 LD	A,80H		;STRING MARKER
001AA1 80   
001AA2 C8      5006 RET	Z
001AA3 06      5007 LD	B,0
001AA4 00   
001AA5 ED      5008 LDIR
001AA6 B0   
001AA7 C9      5009 RET
001AA8 7E      5011 LOADS2:         LD	A,(HL)
001AA9 12      5012 LD	(DE),A
001AAA 23      5013 INC	HL
001AAB FE      5014 CP	CR
001AAC 0D   
001AAD 3E      5015 REPDUN:         LD	A,80H		;STRING MARKER
001AAE 80   
001AAF C8      5016 RET	Z
001AB0 1C      5017 INC	E
001AB1 20      5018 JR	NZ,LOADS2
001AB2 F5   
001AB3 C9      5019 RET			;RETURN NULL STRING
001AB4 FE      5023 EXTRASev:         CP	TMODE
001AB5 EB   
001AB6 CA      5024 JP	Z,MODEFN	;MODE
001AB7 77   
001AB8 0E   
001AB9 FE      5025 CP	TWIDTH
001ABA FE   
001ABB CA      5026 JP	Z,WIDFN		;WIDTH
001ABC 81   
001ABD 0E   
001ABE FE      5027 CP	TREPORT
001ABF F6   
001AC0 28      5028 JR	Z,REPORS	;REPORT$
001AC1 11   
001AC2 FE      5029 CP	TEND
001AC3 E0   
001AC4 28      5030 JR	Z,ENDFUN	;END
001AC5 07   
001AC6 FE      5031 CP	TDIM
001AC7 DE   
001AC8 28      5032 JR	Z,DIMFUN	;DIM
001AC9 44   
001ACA C3      5033 SYNERR:         JP	SYNTAX		; 'Syntax error'
001ACB 64   
001ACC 26   
001ACD 2A      5037 ENDFUN:         LD	HL,(FREE)
001ACE E0   
001ACF 55   
001AD0 C3      5038 JP	COUNT1
001AD1 D4   
001AD2 1B   
001AD3 FD      5042 REPORS:         LD	A,(IY)
001AD4 7E   
001AD5 00   
001AD6 FE      5043 CP	'$'
001AD7 24   
001AD8 20      5044 JR	NZ,SYNERR
001AD9 F0   
001ADA FD      5045 INC	IY
001ADB 23   
001ADC 2A      5046 LD	HL,(ERRTXT)
001ADD EE   
001ADE 55   
001ADF 11      5047 LD	DE,ACCS
001AE0 00   
001AE1 53   
001AE2 7E      5048 REPCPY:         LD	A,(HL)
001AE3 B7      5049 OR	A
001AE4 28      5050 JR	Z,REPDUN
001AE5 C7   
001AE6 ED      5051 LDI
001AE7 A0   
001AE8 FE      5052 CP	160
001AE9 A0   
001AEA EA      5053 JP	PE,REPCPY
001AEB E2   
001AEC 1A   
001AED FE      5054 CP	LF
001AEE 0A   
001AEF 28      5055 JR	Z,REPCPY
001AF0 F1   
001AF1 1D      5056 DEC	E
001AF2 E5      5057 PUSH	HL
001AF3 21      5058 LD	HL,KEYWDS
001AF4 08   
001AF5 39   
001AF6 01      5059 LD	BC,KEYWDL
001AF7 5B   
001AF8 03   
001AF9 ED      5060 CPIR
001AFA B1   
001AFB 06      5061 LD	B,160
001AFC A0   
001AFD FE      5062 CP	145
001AFE 91   
001AFF EA      5063 JP	PE,REPTOK
001B00 03   
001B01 1B   
001B02 04      5064 INC	B
001B03 7E      5065 REPTOK:         LD	A,(HL)
001B04 ED      5066 LDI
001B05 A0   
001B06 B8      5067 CP	B
001B07 EA      5068 JP	PE,REPTOK
001B08 03   
001B09 1B   
001B0A E1      5069 POP	HL
001B0B 1D      5070 DEC	E
001B0C 18      5071 JR	REPCPY
001B0D D4   
001B0E CD      5075 DIMFUN:         CALL	NXT
001B0F 8F   
001B10 45   
001B11 FE      5076 CP	'('
001B12 28   
001B13 20      5077 JR	NZ,DIMF0
001B14 09   
001B15 FD      5078 INC	IY
001B16 23   
001B17 CD      5079 CALL	DIMF0
001B18 1E   
001B19 1B   
001B1A CD      5080 CALL	BRAKET
001B1B 32   
001B1C 21   
001B1D C9      5081 RET
001B1E CD      5083 DIMF0:          CALL	GETARR
001B1F 41   
001B20 1A   
001B21 E5      5084 PUSH	HL
001B22 CD      5085 CALL	NXT
001B23 8F   
001B24 45   
001B25 1E      5086 LD	E,0
001B26 00   
001B27 FE      5087 CP	','
001B28 2C   
001B29 20      5088 JR	NZ,DIMF1
001B2A 0B   
001B2B FD      5089 INC	IY
001B2C 23   
001B2D CD      5090 CALL	EXPRI
001B2E B7   
001B2F 18   
001B30 D9      5091 EXX
001B31 EB      5092 EX	DE,HL
001B32 1C      5093 INC	E
001B33 1D      5094 DEC	E
001B34 28      5095 JR	Z,BADSUB
001B35 19   
001B36 E1      5096 DIMF1:          POP	HL
001B37 7E      5097 LD	A,(HL)
001B38 23      5098 INC	HL
001B39 BB      5099 CP	E
001B3A 38      5100 JR	C,BADSUB
001B3B 13   
001B3C 1D      5101 DEC	E
001B3D FA      5102 JP	M,DIMF3
001B3E 4A   
001B3F 1B   
001B40 19      5103 ADD	HL,DE
001B41 19      5104 ADD	HL,DE
001B42 7E      5105 LD	A,(HL)
001B43 23      5106 INC	HL
001B44 66      5107 LD	H,(HL)
001B45 6F      5108 LD	L,A
001B46 2B      5109 DEC	HL
001B47 C3      5110 DIMF2:          JP	COUNT1
001B48 D4   
001B49 1B   
001B4A 6F      5111 DIMF3:          LD	L,A
001B4B 26      5112 LD	H,0
001B4C 00   
001B4D 18      5113 JR	DIMF2
001B4E F8   
001B4F 3E      5115 BADSUB:         LD	A,15
001B50 0F   
001B51 C3      5116 JP	ERROR_			;"Bad subscript"
001B52 C8   
001B53 3F   
001B54 CD      5146 TINTev:           CALL	TINTFN
001B55 95   
001B56 11   
001B57 18      5147 JR	COUNT1
001B58 7B   
001B59 CD      5148 POS:            CALL	GETCSR
001B5A 2D   
001B5B 0E   
001B5C EB      5149 EX	DE,HL
001B5D 18      5150 JR	COUNT1
001B5E 75   
001B5F CD      5151 VPOS:           CALL	GETCSR
001B60 2D   
001B61 0E   
001B62 18      5152 JR	COUNT1
001B63 70   
001B64 CD      5153 EOF:            CALL	CHANEL
001B65 55   
001B66 37   
001B67 CD      5154 CALL	OSSTAT
001B68 6E   
001B69 06   
001B6A CA      5155 JP	Z,TRUEev
001B6B 41   
001B6C 1C   
001B6D C3      5156 JP	ZERO
001B6E 7C   
001B6F 20   
001B70 CD      5157 BGET:           CALL	CHANEL		;CHANNEL NUMBER
001B71 55   
001B72 37   
001B73 CD      5158 CALL	OSBGET
001B74 5D   
001B75 06   
001B76 6F      5159 LD	L,A
001B77 18      5160 JR	COUNT0
001B78 59   
001B79 CD      5161 INKEY:          CALL	INKEYS
001B7A 12   
001B7B 1F   
001B7C 18      5162 JR	ASC0
001B7D 19   
001B7E CD      5163 GET:            CALL	NXT
001B7F 8F   
001B80 45   
001B81 FE      5164 CP	'('
001B82 28   
001B83 20      5165 JR	NZ,GET0
001B84 0A   
001B85 CD      5166 CALL	ITEMI		;PORT ADDRESS
001B86 E4   
001B87 18   
001B88 D9      5167 EXX
001B89 44      5168 LD	B,H
001B8A 4D      5169 LD	C,L
001B8B ED      5170 IN	L,(C)		;INPUT FROM PORT BC
001B8C 68   
001B8D 18      5171 JR	COUNT0
001B8E 43   
001B8F CD      5172 GET0:           CALL	GETS
001B90 B1   
001B91 1E   
001B92 18      5173 JR	ASC1
001B93 08   
001B94 CD      5174 ASC:            CALL	ITEMS
001B95 ED   
001B96 18   
001B97 AF      5175 ASC0:           XOR	A
001B98 BB      5176 CP	E
001B99 CA      5177 JP	Z,TRUEev		;NULL STRING
001B9A 41   
001B9B 1C   
001B9C 2A      5178 ASC1:           LD	HL,(ACCS)
001B9D 00   
001B9E 53   
001B9F 18      5179 JR	COUNT0
001BA0 31   
001BA1 CD      5180 LEN:            CALL	ITEMS
001BA2 ED   
001BA3 18   
001BA4 EB      5181 EX	DE,HL
001BA5 18      5182 JR	COUNT0
001BA6 2B   
001BA7 2A      5183 LOMEMVev:         LD	HL,(LOMEM)
001BA8 DE   
001BA9 55   
001BAA 18      5184 JR	COUNT1
001BAB 28   
001BAC 2A      5185 HIMEMVev:         LD	HL,(HIMEM)
001BAD E2   
001BAE 55   
001BAF 18      5186 JR	COUNT1
001BB0 23   
001BB1 2A      5187 PAGEVev:          LD	HL,(PAGE_)
001BB2 DC   
001BB3 55   
001BB4 18      5188 JR	COUNT1
001BB5 1E   
001BB6 FD      5189 TOPV:           LD	A,(IY)
001BB7 7E   
001BB8 00   
001BB9 FD      5190 INC	IY		;SKIP "P"
001BBA 23   
001BBB FE      5191 CP	'P'
001BBC 50   
001BBD C2      5192 JP	NZ,SYNTAX	;"Syntax Error"
001BBE 64   
001BBF 26   
001BC0 CD      5193 CALL	GETTOP
001BC1 A9   
001BC2 40   
001BC3 18      5194 JR	COUNT1
001BC4 0F   
001BC5 2A      5195 ERLV:           LD	HL,(ERL)
001BC6 F2   
001BC7 55   
001BC8 18      5196 JR	COUNT1
001BC9 0A   
001BCA 2A      5197 ERRV:           LD	HL,(ERR)
001BCB FD   
001BCC 55   
001BCD 18      5198 JR	COUNT0
001BCE 03   
001BCF 2A      5199 COUNTV:         LD	HL,(COUNT)
001BD0 FB   
001BD1 55   
001BD2 26      5200 COUNT0:         LD	H,0
001BD3 00   
001BD4 D9      5201 COUNT1:         EXX
001BD5 AF      5202 XOR	A
001BD6 4F      5203 LD	C,A		;INTEGER MARKER
001BD7 67      5204 LD	H,A
001BD8 6F      5205 LD	L,A
001BD9 C9      5206 RET
001BDA AF      5213 OPENOT:         XOR	A
001BDB 21      5214 DB	21H		;SKIP NEXT 2 BYTES
001BDC 3E      5215 OPENUP:         LD	A,2
001BDD 02   
001BDE 21      5216 DB	21H		;SKIP NEXT 2 BYTES
001BDF 3E      5217 OPENIN:         LD	A,1
001BE0 01   
001BE1 F5      5218 PUSH	AF		;SAVE OPEN TYPE
001BE2 CD      5219 CALL	ITEMS		;FILENAME
001BE3 ED   
001BE4 18   
001BE5 3E      5220 LD	A,CR
001BE6 0D   
001BE7 12      5221 LD	(DE),A
001BE8 F1      5222 POP	AF		;RESTORE OPEN TYPE
001BE9 C6      5223 ADD	A,-1		;AFFECT FLAGS
001BEA FF   
001BEB 21      5224 LD	HL,ACCS
001BEC 00   
001BED 53   
001BEE CD      5225 CALL	OSOPEN
001BEF 46   
001BF0 06   
001BF1 6F      5226 LD	L,A
001BF2 18      5227 JR	COUNT0
001BF3 DE   
001BF4 CD      5233 EXTev:            CALL	CHANEL
001BF5 55   
001BF6 37   
001BF7 CD      5234 CALL	GETEXT
001BF8 AF   
001BF9 06   
001BFA 18      5235 JR	TIME0
001BFB 12   
001BFC CD      5237 PTRev:            CALL	CHANEL
001BFD 55   
001BFE 37   
001BFF CD      5238 CALL	GETPTR
001C00 78   
001C01 06   
001C02 18      5239 JR	TIME0
001C03 0A   
001C04 FD      5244 TIMEVev:          LD	A,(IY)
001C05 7E   
001C06 00   
001C07 FE      5245 CP	'$'
001C08 24   
001C09 28      5246 JR	Z,TIMEVSev
001C0A 09   
001C0B CD      5247 CALL	GETIME
001C0C AD   
001C0D 0D   
001C0E D5      5248 TIME0:          PUSH	DE
001C0F D9      5249 EXX
001C10 E1      5250 POP	HL
001C11 AF      5251 XOR	A
001C12 4F      5252 LD	C,A
001C13 C9      5253 RET
001C14 FD      5258 TIMEVSev:         INC	IY		;SKIP $
001C15 23   
001C16 CD      5259 CALL	GETIMS
001C17 C2   
001C18 0D   
001C19 3E      5260 LD	A,80H		;MARK STRING
001C1A 80   
001C1B C9      5261 RET
001C1C CD      5265 SLT:            CALL	SCP
001C1D 79   
001C1E 20   
001C1F D0      5266 RET	NC
001C20 18      5267 JR	TRUEev
001C21 1F   
001C22 CD      5269 SGT:            CALL	SCP
001C23 79   
001C24 20   
001C25 C8      5270 RET	Z
001C26 D8      5271 RET	C
001C27 18      5272 JR	TRUEev
001C28 18   
001C29 CD      5274 SGE:            CALL	SCP
001C2A 79   
001C2B 20   
001C2C D8      5275 RET	C
001C2D 18      5276 JR	TRUEev
001C2E 12   
001C2F CD      5278 SLE:            CALL	SCP
001C30 79   
001C31 20   
001C32 28      5279 JR	Z,TRUEev
001C33 0D   
001C34 D0      5280 RET	NC
001C35 18      5281 JR	TRUEev
001C36 0A   
001C37 CD      5283 SNE:            CALL	SCP
001C38 79   
001C39 20   
001C3A C8      5284 RET	Z
001C3B 18      5285 JR	TRUEev
001C3C 04   
001C3D CD      5287 SEQ:            CALL	SCP
001C3E 79   
001C3F 20   
001C40 C0      5288 RET	NZ
001C41 3E      5289 TRUEev:           LD	A,-1
001C42 FF   
001C43 D9      5290 EXX
001C44 67      5291 LD	H,A
001C45 6F      5292 LD	L,A
001C46 D9      5293 EXX
001C47 67      5294 LD	H,A
001C48 6F      5295 LD	L,A
001C49 3C      5296 INC	A
001C4A 4F      5297 LD	C,A
001C4B C9      5298 RET
001C4C 3E      5303 PIev:             LD	A,35
001C4D 23   
001C4E 18      5304 JR	FPP1
001C4F 43   
001C50 3E      5309 ABSev:            LD	A,16
001C51 10   
001C52 18      5310 JR	FPPN
001C53 3A   
001C54 3E      5315 CPL_ev:           LD	A,26
001C55 1A   
001C56 18      5316 JR	FPPN
001C57 36   
001C58 3E      5321 DEGev:            LD	A,21
001C59 15   
001C5A 18      5322 JR	FPPN
001C5B 32   
001C5C 3E      5327 RADev:            LD	A,27
001C5D 1B   
001C5E 18      5328 JR	FPPN
001C5F 2E   
001C60 3E      5333 SGNev:            LD	A,28
001C61 1C   
001C62 18      5334 JR	FPPN
001C63 2A   
001C64 3E      5339 INT_ev:           LD	A,23
001C65 17   
001C66 18      5340 JR	FPPN
001C67 26   
001C68 3E      5345 SQRev:            LD	A,30
001C69 1E   
001C6A 18      5346 JR	FPPN
001C6B 22   
001C6C 3E      5351 TANev:            LD	A,31
001C6D 1F   
001C6E 18      5352 JR	FPPN
001C6F 1E   
001C70 3E      5357 COSev:            LD	A,20
001C71 14   
001C72 18      5358 JR	FPPN
001C73 1A   
001C74 3E      5363 SINev:            LD	A,29
001C75 1D   
001C76 18      5364 JR	FPPN
001C77 16   
001C78 3E      5369 EXPev:            LD	A,22
001C79 16   
001C7A 18      5370 JR	FPPN
001C7B 12   
001C7C 3E      5375 LNev:             LD	A,24
001C7D 18   
001C7E 18      5376 JR	FPPN
001C7F 0E   
001C80 3E      5381 LOGev:            LD	A,25
001C81 19   
001C82 18      5382 JR	FPPN
001C83 0A   
001C84 3E      5387 ASNev:            LD	A,18
001C85 12   
001C86 18      5388 JR	FPPN
001C87 06   
001C88 3E      5393 ATNev:            LD	A,19
001C89 13   
001C8A 18      5394 JR	FPPN
001C8B 02   
001C8C 3E      5399 ACSev:            LD	A,17
001C8D 11   
001C8E F5      5400 FPPN:           PUSH	AF
001C8F CD      5401 CALL	ITEMN
001C90 FE   
001C91 18   
001C92 F1      5402 POP	AF
001C93 CD      5403 FPP1:           CALL	FPP
001C94 99   
001C95 45   
001C96 DA      5404 JP	C,ERROR_
001C97 C8   
001C98 3F   
001C99 AF      5405 XOR	A
001C9A C9      5406 RET
001C9B 3E      5410 SFIX:           LD	A,38
001C9C 26   
001C9D 18      5411 JR	FPP1
001C9E F4   
001C9F 3E      5415 SFLOATev:         LD	A,39
001CA0 27   
001CA1 18      5416 JR	FPP1
001CA2 F0   
001CA3 CD      5421 VALev:            CALL	ITEMS
001CA4 ED   
001CA5 18   
001CA6 AF      5422 VAL0:           XOR	A
001CA7 12      5423 LD	(DE),A
001CA8 DD      5424 LD	IX,ACCS
001CA9 21   
001CAA 00   
001CAB 53   
001CAC 3E      5425 LD	A,36
001CAD 24   
001CAE 18      5426 JR	FPP1
001CAF E3   
001CB0 CD      5431 EVAL_:          CALL	ITEMS
001CB1 ED   
001CB2 18   
001CB3 3E      5432 LD	A,CR
001CB4 0D   
001CB5 12      5433 LD	(DE),A
001CB6 FD      5434 PUSH	IY
001CB7 E5   
001CB8 11      5435 LD	DE,ACCS
001CB9 00   
001CBA 53   
001CBB FD      5436 LD	IY,ACCS
001CBC 21   
001CBD 00   
001CBE 53   
001CBF 0E      5437 LD	C,0
001CC0 00   
001CC1 CD      5438 CALL	LEXAN2		;TOKENISE
001CC2 9C   
001CC3 44   
001CC4 12      5439 LD	(DE),A
001CC5 13      5440 INC	DE
001CC6 AF      5441 XOR	A
001CC7 CD      5442 CALL	PUSHS		;PUT ON STACK
001CC8 9D   
001CC9 20   
001CCA FD      5443 LD	IY,2
001CCB 21   
001CCC 02   
001CCD 00   
001CCE FD      5444 ADD	IY,SP
001CCF 39   
001CD0 CD      5445 CALL	EXPR
001CD1 86   
001CD2 17   
001CD3 FD      5446 POP	IY
001CD4 E1   
001CD5 FD      5447 ADD	IY,SP
001CD6 39   
001CD7 FD      5448 LD	SP,IY		;ADJUST STACK POINTER
001CD8 F9   
001CD9 FD      5449 POP	IY
001CDA E1   
001CDB 08      5450 EX	AF,AF'
001CDC C9      5451 RET
001CDD DD      5460 RND:            LD	IX,RANDOM
001CDE 21   
001CDF F6   
001CE0 55   
001CE1 CD      5461 CALL	NXT
001CE2 8F   
001CE3 45   
001CE4 FE      5462 CP	'('
001CE5 28   
001CE6 28      5463 JR	Z,RND5		;ARGUMENT FOLLOWS
001CE7 1C   
001CE8 CD      5464 CALL	LOAD5
001CE9 B3   
001CEA 19   
001CEB CB      5465 RND1:           RR	C
001CEC 19   
001CED 06      5466 LD	B,32
001CEE 20   
001CEF D9      5467 RND2:           EXX			;CALCULATE NEXT
001CF0 ED      5468 ADC	HL,HL
001CF1 6A   
001CF2 D9      5469 EXX
001CF3 ED      5470 ADC	HL,HL
001CF4 6A   
001CF5 CB      5471 BIT	3,L
001CF6 5D   
001CF7 28      5472 JR	Z,RND3
001CF8 01   
001CF9 3F      5473 CCF
001CFA 10      5474 RND3:           DJNZ	RND2
001CFB F3   
001CFC CB      5475 RND4:           RL	C		;SAVE CARRY
001CFD 11   
001CFE CD      5476 CALL	STORE5		;STORE NEW NUMBER
001CFF 8A   
001D00 32   
001D01 AF      5477 XOR	A
001D02 4F      5478 LD	C,A
001D03 C9      5479 RET
001D04 CD      5480 RND5:           CALL	ITEMI
001D05 E4   
001D06 18   
001D07 DD      5481 LD	IX,RANDOM
001D08 21   
001D09 F6   
001D0A 55   
001D0B CB      5482 BIT	7,H		;NEGATIVE?
001D0C 7C   
001D0D 37      5483 SCF
001D0E 20      5484 JR	NZ,RND4		;SEED
001D0F EC   
001D10 CD      5485 CALL	TEST
001D11 DD   
001D12 1F   
001D13 F5      5486 PUSH	AF
001D14 41      5487 LD	B,C
001D15 EB      5488 EX	DE,HL
001D16 D9      5489 EXX
001D17 EB      5490 EX	DE,HL
001D18 CD      5491 CALL	LOAD5
001D19 B3   
001D1A 19   
001D1B C4      5492 CALL	NZ,RND1		;NEXT IF NON-ZERO
001D1C EB   
001D1D 1C   
001D1E D9      5493 EXX			;SCRAMBLE (CARE!)
001D1F 0E      5494 LD	C,7FH
001D20 7F   
001D21 CB      5495 RND6:           BIT	7,H		;FLOAT
001D22 7C   
001D23 20      5496 JR	NZ,RND7
001D24 08   
001D25 D9      5497 EXX
001D26 29      5498 ADD	HL,HL
001D27 D9      5499 EXX
001D28 ED      5500 ADC	HL,HL
001D29 6A   
001D2A 0D      5501 DEC	C
001D2B 20      5502 JR	NZ,RND6
001D2C F4   
001D2D CB      5503 RND7:           RES	7,H		;POSITIVE 0-0.999999
001D2E BC   
001D2F F1      5504 POP	AF
001D30 C8      5505 RET	Z		;ZERO ARGUMENT
001D31 D9      5506 EXX
001D32 7B      5507 LD	A,E
001D33 3D      5508 DEC	A
001D34 B2      5509 OR	D
001D35 D9      5510 EXX
001D36 B3      5511 OR	E
001D37 B2      5512 OR	D
001D38 C8      5513 RET	Z		;ARGUMENT=1
001D39 06      5514 LD	B,0		;INTEGER MARKER
001D3A 00   
001D3B 3E      5515 LD	A,10
001D3C 0A   
001D3D CD      5516 CALL	FPP		;MULTIPLY
001D3E 99   
001D3F 45   
001D40 DA      5517 JP	C,ERROR_
001D41 C8   
001D42 3F   
001D43 CD      5518 CALL	SFIX
001D44 9B   
001D45 1C   
001D46 C3      5519 JP	ADD1ev
001D47 DA   
001D48 18   
001D49 FD      5523 SUMLEN:         INC	IY		;Skip LEN
001D4A 23   
001D4B CD      5524 CALL	GETARB
001D4C 5B   
001D4D 1A   
001D4E CB      5525 BIT	7,B
001D4F 78   
001D50 CA      5526 JP	Z,MISMATev	;Type mismatch
001D51 F2   
001D52 18   
001D53 CD      5527 CALL	ARRLEN
001D54 28   
001D55 1A   
001D56 E5      5528 PUSH	HL
001D57 DD      5529 POP	IX		;IX addresses array
001D58 E1   
001D59 AF      5530 XOR	A
001D5A 67      5531 LD	H,A
001D5B 6F      5532 LD	L,A
001D5C 47      5533 LD	B,A
001D5D DD      5534 SUMLN1:         LD	C,(IX)
001D5E 4E   
001D5F 00   
001D60 09      5535 ADD	HL,BC
001D61 0E      5536 LD	C,4
001D62 04   
001D63 DD      5537 ADD	IX,BC
001D64 09   
001D65 1B      5538 DEC	DE		;Count elements
001D66 7A      5539 LD	A,D
001D67 B3      5540 OR	E
001D68 20      5541 JR	NZ,SUMLN1
001D69 F3   
001D6A C3      5542 JP	COUNT1
001D6B D4   
001D6C 1B   
001D6D CD      5546 SUM:            CALL	NXT
001D6E 8F   
001D6F 45   
001D70 FE      5547 CP	TLEN
001D71 A9   
001D72 28      5548 JR	Z,SUMLEN
001D73 D5   
001D74 CD      5549 CALL	GETARB
001D75 5B   
001D76 1A   
001D77 CB      5550 BIT	7,B
001D78 78   
001D79 20      5551 JR	NZ,SUMSTR
001D7A 27   
001D7B C5      5552 PUSH	BC
001D7C CD      5553 CALL	ARRLEN
001D7D 28   
001D7E 1A   
001D7F E5      5554 PUSH	HL
001D80 DD      5555 POP	IX		;IX addresses array
001D81 E1   
001D82 CD      5556 CALL	ZERO
001D83 7C   
001D84 20   
001D85 F1      5557 POP	AF		;A = element size
001D86 D5      5558 SUMUP:          PUSH	DE
001D87 F5      5559 PUSH	AF
001D88 CD      5560 CALL	DLOADN
001D89 6B   
001D8A 1A   
001D8B 3E      5561 LD	A,11
001D8C 0B   
001D8D CD      5562 CALL	FPP
001D8E 99   
001D8F 45   
001D90 DA      5563 JP	C,ERROR_
001D91 C8   
001D92 3F   
001D93 F1      5564 POP	AF
001D94 16      5565 LD	D,0
001D95 00   
001D96 5F      5566 LD	E,A
001D97 DD      5567 ADD	IX,DE		;Bump to next element
001D98 19   
001D99 D1      5568 POP	DE
001D9A 1B      5569 DEC	DE		;Count elements
001D9B 47      5570 LD	B,A
001D9C 7A      5571 LD	A,D
001D9D B3      5572 OR	E
001D9E 78      5573 LD	A,B
001D9F 20      5574 JR	NZ,SUMUP
001DA0 E5   
001DA1 C9      5575 RET
001DA2 CD      5579 SUMSTR:         CALL	ARRLEN
001DA3 28   
001DA4 1A   
001DA5 E5      5580 PUSH	HL
001DA6 DD      5581 POP	IX		;IX addresses array
001DA7 E1   
001DA8 EB      5582 EX	DE,HL
001DA9 11      5583 LD	DE,ACCS
001DAA 00   
001DAB 53   
001DAC 06      5584 LD	B,0
001DAD 00   
001DAE E5      5585 SUMST1:         PUSH	HL
001DAF DD      5586 LD	C,(IX)
001DB0 4E   
001DB1 00   
001DB2 79      5587 LD	A,C
001DB3 B7      5588 OR	A
001DB4 28      5589 JR	Z,SUMST2
001DB5 0E   
001DB6 83      5590 ADD	A,E
001DB7 3E      5591 LD	A,19
001DB8 13   
001DB9 DA      5592 JP	C,ERROR_		;"String too long"
001DBA C8   
001DBB 3F   
001DBC DD      5593 LD	L,(IX+2)
001DBD 6E   
001DBE 02   
001DBF DD      5594 LD	H,(IX+3)
001DC0 66   
001DC1 03   
001DC2 ED      5595 LDIR
001DC3 B0   
001DC4 E1      5596 SUMST2:         POP	HL
001DC5 0E      5597 LD	C,4
001DC6 04   
001DC7 DD      5598 ADD	IX,BC
001DC8 09   
001DC9 2B      5599 DEC	HL		;Count elements
001DCA 7C      5600 LD	A,H
001DCB B5      5601 OR	L
001DCC 20      5602 JR	NZ,SUMST1
001DCD E0   
001DCE F6      5603 OR	80H
001DCF 80   
001DD0 C9      5604 RET
001DD1 CD      5608 MODFUN:         CALL	GETARB
001DD2 5B   
001DD3 1A   
001DD4 CB      5609 BIT	7,B
001DD5 78   
001DD6 C2      5610 JP	NZ,MISMATev
001DD7 F2   
001DD8 18   
001DD9 C5      5611 PUSH	BC
001DDA CD      5612 CALL	ARRLEN
001DDB 28   
001DDC 1A   
001DDD E5      5613 PUSH	HL
001DDE DD      5614 POP	IX		;IX addresses array
001DDF E1   
001DE0 CD      5615 CALL	ZERO
001DE1 7C   
001DE2 20   
001DE3 F1      5616 POP	AF		;A = element size
001DE4 D5      5617 MODUP:          PUSH	DE
001DE5 F5      5618 PUSH	AF
001DE6 C5      5619 PUSH	BC
001DE7 E5      5620 PUSH	HL
001DE8 D9      5621 EXX
001DE9 E5      5622 PUSH	HL
001DEA D9      5623 EXX
001DEB CD      5624 CALL	LOADN
001DEC A9   
001DED 19   
001DEE AF      5625 XOR	A
001DEF 47      5626 LD	B,A
001DF0 57      5627 LD	D,A
001DF1 5F      5628 LD	E,A
001DF2 D9      5629 EXX
001DF3 57      5630 LD	D,A
001DF4 1E      5631 LD	E,2
001DF5 02   
001DF6 D9      5632 EXX
001DF7 3E      5633 LD	A,14
001DF8 0E   
001DF9 DD      5634 PUSH	IX
001DFA E5   
001DFB CD      5635 CALL	FPP		;Square
001DFC 99   
001DFD 45   
001DFE DD      5636 POP	IX
001DFF E1   
001E00 DA      5637 JP	C,ERROR_
001E01 C8   
001E02 3F   
001E03 D9      5638 EXX
001E04 EB      5639 EX	DE,HL
001E05 E1      5640 POP	HL
001E06 D9      5641 EXX
001E07 EB      5642 EX	DE,HL
001E08 E1      5643 POP	HL
001E09 79      5644 LD	A,C
001E0A C1      5645 POP	BC
001E0B 47      5646 LD	B,A
001E0C 3E      5647 LD	A,11
001E0D 0B   
001E0E CD      5648 CALL	FPP		;Accumulate
001E0F 99   
001E10 45   
001E11 DA      5649 JP	C,ERROR_
001E12 C8   
001E13 3F   
001E14 F1      5650 POP	AF
001E15 16      5651 LD	D,0
001E16 00   
001E17 5F      5652 LD	E,A
001E18 DD      5653 ADD	IX,DE		;Bump to next element
001E19 19   
001E1A D1      5654 POP	DE
001E1B 1B      5655 DEC	DE		;Count elements
001E1C 47      5656 LD	B,A
001E1D 7A      5657 LD	A,D
001E1E B3      5658 OR	E
001E1F 78      5659 LD	A,B
001E20 20      5660 JR	NZ,MODUP
001E21 C2   
001E22 3E      5661 LD	A,30
001E23 1E   
001E24 CD      5662 CALL	FPP		;Square root
001E25 99   
001E26 45   
001E27 AF      5663 XOR	A
001E28 C9      5664 RET
001E29 CD      5669 INSTR:          CALL	EXPRS		;STRING TO SEARCH
001E2A C0   
001E2B 18   
001E2C CD      5670 CALL	COMMA
001E2D 26   
001E2E 21   
001E2F CD      5671 CALL	PUSHS		;SAVE STRING ON STACK
001E30 9D   
001E31 20   
001E32 CD      5672 CALL	EXPRS		;SUB-STRING
001E33 C0   
001E34 18   
001E35 C1      5673 POP	BC
001E36 21      5674 LD	HL,0
001E37 00   
001E38 00   
001E39 39      5675 ADD	HL,SP		;HL ADDRESSES MAIN
001E3A C5      5676 PUSH	BC		;C = MAIN STRING LENGTH
001E3B 43      5677 LD	B,E		;B = SUB-STRING LENGTH
001E3C CD      5678 CALL	NXT
001E3D 8F   
001E3E 45   
001E3F FE      5679 CP	','
001E40 2C   
001E41 3E      5680 LD	A,0
001E42 00   
001E43 20      5681 JR	NZ,INSTR1
001E44 17   
001E45 FD      5682 INC	IY		;SKIP COMMA
001E46 23   
001E47 C5      5683 PUSH	BC		;SAVE LENGTHS
001E48 E5      5684 PUSH	HL		;SAVE MAIN ADDRESS
001E49 CD      5685 CALL	PUSHS
001E4A 9D   
001E4B 20   
001E4C CD      5686 CALL	EXPRI
001E4D B7   
001E4E 18   
001E4F C1      5687 POP	BC
001E50 CD      5688 CALL	POPS
001E51 BB   
001E52 20   
001E53 E1      5689 POP	HL		;RESTORE MAIN ADDRESS
001E54 C1      5690 POP	BC		;RESTORE LENGTHS
001E55 D9      5691 EXX
001E56 7D      5692 LD	A,L
001E57 D9      5693 EXX
001E58 B7      5694 OR	A
001E59 28      5695 JR	Z,INSTR1
001E5A 01   
001E5B 3D      5696 DEC	A
001E5C 11      5697 INSTR1:         LD	DE,ACCS		;DE ADDRESSES SUB
001E5D 00   
001E5E 53   
001E5F CD      5698 CALL	SEARCH
001E60 76   
001E61 1E   
001E62 D1      5699 POP	DE
001E63 28      5700 JR	Z,INSTR2	;N.B. CARRY CLEARED
001E64 03   
001E65 ED      5701 SBC	HL,HL
001E66 62   
001E67 39      5702 ADD	HL,SP
001E68 ED      5703 INSTR2:         SBC	HL,SP
001E69 72   
001E6A EB      5704 EX	DE,HL
001E6B 26      5705 LD	H,0
001E6C 00   
001E6D 39      5706 ADD	HL,SP
001E6E F9      5707 LD	SP,HL
001E6F EB      5708 EX	DE,HL
001E70 CD      5709 CALL	BRAKET
001E71 32   
001E72 21   
001E73 C3      5710 JP	COUNT1
001E74 D4   
001E75 1B   
001E76 C5      5720 SEARCH:         PUSH	BC
001E77 06      5721 LD	B,0
001E78 00   
001E79 4F      5722 LD	C,A
001E7A 09      5723 ADD	HL,BC		;NEW START ADDRESS
001E7B C1      5724 POP	BC
001E7C 91      5725 SUB	C
001E7D 30      5726 JR	NC,SRCH4
001E7E 28   
001E7F ED      5727 NEG
001E80 44   
001E81 4F      5728 LD	C,A		;REMAINING LENGTH
001E82 1A      5729 SRCH1ev:          LD	A,(DE)
001E83 C5      5730 PUSH	BC
001E84 06      5731 LD	B,0
001E85 00   
001E86 ED      5732 CPIR			;FIND FIRST CHARACTER
001E87 B1   
001E88 79      5733 LD	A,C
001E89 C1      5734 POP	BC
001E8A 20      5735 JR	NZ,SRCH4
001E8B 1B   
001E8C 4F      5736 LD	C,A
001E8D 05      5737 DEC	B		;Bug fix
001E8E B8      5738 CP	B		;Bug fix
001E8F 04      5739 INC	B		;Bug fix
001E90 38      5740 JR	C,SRCH4		;Bug fix
001E91 15   
001E92 C5      5741 PUSH	BC
001E93 D5      5742 PUSH	DE
001E94 E5      5743 PUSH	HL
001E95 05      5744 DEC	B
001E96 28      5745 JR	Z,SRCH3		;FOUND !
001E97 08   
001E98 13      5746 SRCH2ev:          INC	DE
001E99 1A      5747 LD	A,(DE)
001E9A BE      5748 CP	(HL)
001E9B 20      5749 JR	NZ,SRCH3
001E9C 03   
001E9D 23      5750 INC	HL
001E9E 10      5751 DJNZ	SRCH2ev
001E9F F8   
001EA0 E1      5752 SRCH3:          POP	HL
001EA1 D1      5753 POP	DE
001EA2 C1      5754 POP	BC
001EA3 20      5755 JR	NZ,SRCH1ev
001EA4 DD   
001EA5 AF      5756 XOR	A		;Z, NC
001EA6 C9      5757 RET			;FOUND
001EA7 F6      5759 SRCH4:          OR	0FFH		;NZ, NC
001EA8 FF   
001EA9 C9      5760 RET			;NOT FOUND
001EAA CD      5765 CHRS:           CALL	ITEMI
001EAB E4   
001EAC 18   
001EAD D9      5766 EXX
001EAE 7D      5767 LD	A,L
001EAF 18      5768 JR	GET1
001EB0 0A   
001EB1 CD      5773 GETS:           CALL	NXT
001EB2 8F   
001EB3 45   
001EB4 FE      5774 CP	'#'
001EB5 23   
001EB6 28      5775 JR	Z,GET2
001EB7 06   
001EB8 CD      5776 CALL	OSRDCH
001EB9 C4   
001EBA 05   
001EBB 37      5777 GET1:           SCF
001EBC 18      5778 JR	INKEY1
001EBD 5B   
001EBE CD      5780 GET2:           CALL	CHNL		;File channel
001EBF 5F   
001EC0 37   
001EC1 CD      5781 CALL	NXT
001EC2 8F   
001EC3 45   
001EC4 FE      5782 CP	TBY
001EC5 0F   
001EC6 28      5783 JR	Z,GET3
001EC7 04   
001EC8 FE      5784 CP	TTO
001EC9 B8   
001ECA 20      5785 JR	NZ,GET4
001ECB 0C   
001ECC FD      5786 GET3:           INC	IY
001ECD 23   
001ECE F5      5787 PUSH	AF
001ECF D5      5788 PUSH	DE
001ED0 CD      5789 CALL	ITEMI		;Get BY or TO qualifier
001ED1 E4   
001ED2 18   
001ED3 D9      5790 EXX
001ED4 44      5791 LD	B,H
001ED5 4D      5792 LD	C,L
001ED6 D1      5793 POP	DE
001ED7 F1      5794 POP	AF
001ED8 21      5795 GET4:           LD	HL,ACCS
001ED9 00   
001EDA 53   
001EDB FE      5796 CP	TTO
001EDC B8   
001EDD 28      5797 JR	Z,GET5
001EDE 08   
001EDF 51      5798 LD	D,C		;Maximum count
001EE0 01      5799 LD	BC,100H		;Default
001EE1 00   
001EE2 01   
001EE3 FE      5800 CP	TBY
001EE4 0F   
001EE5 28      5801 JR	Z,GET6
001EE6 04   
001EE7 16      5802 GET5:           LD	D,0
001EE8 00   
001EE9 CB      5803 SET	1,B		;Flag no count
001EEA C8   
001EEB C5      5804 GET6:           PUSH	BC
001EEC CD      5805 CALL	OSBGET
001EED 5D   
001EEE 06   
001EEF C1      5806 POP	BC
001EF0 38      5807 JR	C,GET9		;EOF
001EF1 1C   
001EF2 CB      5808 BIT	1,B
001EF3 48   
001EF4 28      5809 JR	Z,GET8
001EF5 13   
001EF6 B9      5810 CP	C
001EF7 28      5811 JR	Z,GET9		;NUL (or supplied term)
001EF8 15   
001EF9 CB      5812 BIT	7,B
001EFA 78   
001EFB 20      5813 JR	NZ,GET7
001EFC 08   
001EFD CB      5814 BIT	0,B
001EFE 40   
001EFF 28      5815 JR	Z,GET8
001F00 08   
001F01 FE      5816 CP	LF
001F02 0A   
001F03 28      5817 JR	Z,GET9		;LF
001F04 09   
001F05 FE      5818 GET7:           CP	CR
001F06 0D   
001F07 28      5819 JR	Z,GET9		;CR
001F08 05   
001F09 77      5820 GET8:           LD	(HL),A
001F0A 2C      5821 INC	L
001F0B 15      5822 DEC	D
001F0C 20      5823 JR	NZ,GET6
001F0D DD   
001F0E EB      5824 GET9:           EX	DE,HL
001F0F 3E      5825 LD	A,80H
001F10 80   
001F11 C9      5826 RET
001F12 CD      5833 INKEYS:         CALL	ITEMI
001F13 E4   
001F14 18   
001F15 D9      5834 EXX
001F16 CD      5835 CALL	OSKEY
001F17 15   
001F18 0E   
001F19 11      5836 INKEY1:         LD	DE,ACCS
001F1A 00   
001F1B 53   
001F1C 12      5837 LD	(DE),A
001F1D 3E      5838 LD	A,80H
001F1E 80   
001F1F D0      5839 RET	NC
001F20 1C      5840 INC	E
001F21 C9      5841 RET
001F22 CD      5846 MIDS:           CALL	EXPRS
001F23 C0   
001F24 18   
001F25 CD      5847 CALL	COMMA
001F26 26   
001F27 21   
001F28 CD      5848 CALL	PUSHS		;SAVE STRING ON STACK
001F29 9D   
001F2A 20   
001F2B CD      5849 CALL	EXPRI
001F2C B7   
001F2D 18   
001F2E C1      5850 POP	BC
001F2F CD      5851 CALL	POPS
001F30 BB   
001F31 20   
001F32 D9      5852 EXX
001F33 7D      5853 LD	A,L
001F34 D9      5854 EXX
001F35 B7      5855 OR	A
001F36 28      5856 JR	Z,MIDS1
001F37 0D   
001F38 3D      5857 DEC	A
001F39 6F      5858 LD	L,A
001F3A 93      5859 SUB	E
001F3B 1E      5860 LD	E,0
001F3C 00   
001F3D 30      5861 JR	NC,MIDS1
001F3E 06   
001F3F ED      5862 NEG
001F40 44   
001F41 4F      5863 LD	C,A
001F42 CD      5864 CALL	RIGHT1
001F43 A1   
001F44 1F   
001F45 CD      5865 MIDS1:          CALL	NXT
001F46 8F   
001F47 45   
001F48 FE      5866 CP	','
001F49 2C   
001F4A 28      5867 JR	Z,LEFT1
001F4B 1A   
001F4C CD      5868 CALL	BRAKET
001F4D 32   
001F4E 21   
001F4F 3E      5869 LD	A,80H
001F50 80   
001F51 C9      5870 RET
001F52 CD      5876 LEFTS:          CALL	EXPRS
001F53 C0   
001F54 18   
001F55 CD      5877 CALL	NXT
001F56 8F   
001F57 45   
001F58 FE      5878 CP	','
001F59 2C   
001F5A 28      5879 JR	Z,LEFT1
001F5B 0A   
001F5C CD      5880 CALL	BRAKET
001F5D 32   
001F5E 21   
001F5F 7B      5881 LD	A,E
001F60 B7      5882 OR	A
001F61 28      5883 JR	Z,LEFT3
001F62 1A   
001F63 1D      5884 DEC	E
001F64 18      5885 JR	LEFT3
001F65 17   
001F66 FD      5887 LEFT1:          INC	IY
001F67 23   
001F68 CD      5888 CALL	PUSHS		;SAVE STRING ON STACK
001F69 9D   
001F6A 20   
001F6B CD      5889 CALL	EXPRI
001F6C B7   
001F6D 18   
001F6E C1      5890 POP	BC
001F6F CD      5891 CALL	POPS
001F70 BB   
001F71 20   
001F72 CD      5892 CALL	BRAKET
001F73 32   
001F74 21   
001F75 D9      5893 EXX
001F76 7D      5894 LD	A,L
001F77 D9      5895 EXX
001F78 BB      5896 CP	E
001F79 30      5897 JR	NC,LEFT3
001F7A 02   
001F7B 6B      5898 LD	L,E		;FOR RIGHT$
001F7C 5F      5899 LEFT2:          LD	E,A
001F7D 3E      5900 LEFT3:          LD	A,80H		;STRING MARKER
001F7E 80   
001F7F C9      5901 RET
001F80 CD      5906 RIGHTS:         CALL	EXPRS
001F81 C0   
001F82 18   
001F83 CD      5907 CALL	NXT
001F84 8F   
001F85 45   
001F86 FE      5908 CP	','
001F87 2C   
001F88 28      5909 JR	Z,RIGHT0
001F89 0C   
001F8A CD      5910 CALL	BRAKET
001F8B 32   
001F8C 21   
001F8D 7B      5911 LD	A,E
001F8E B7      5912 OR	A
001F8F 28      5913 JR	Z,LEFT3
001F90 EC   
001F91 3D      5914 DEC	A
001F92 0E      5915 LD	C,1
001F93 01   
001F94 18      5916 JR	RIGHT2
001F95 0A   
001F96 CD      5918 RIGHT0:         CALL	LEFT1
001F97 66   
001F98 1F   
001F99 D0      5919 RET	NC
001F9A 1C      5920 INC	E
001F9B 1D      5921 DEC	E
001F9C C8      5922 RET	Z
001F9D 4B      5923 LD	C,E
001F9E 7D      5924 LD	A,L
001F9F 93      5925 SUB	E
001FA0 6F      5926 RIGHT2:         LD	L,A
001FA1 06      5927 RIGHT1:         LD	B,0
001FA2 00   
001FA3 62      5928 LD	H,D
001FA4 58      5929 LD	E,B
001FA5 ED      5930 LDIR			;MOVE
001FA6 B0   
001FA7 3E      5931 LD	A,80H
001FA8 80   
001FA9 C9      5932 RET
001FAA CD      5937 STRING_:        CALL	EXPRI
001FAB B7   
001FAC 18   
001FAD CD      5938 CALL	COMMA
001FAE 26   
001FAF 21   
001FB0 D9      5939 EXX
001FB1 7D      5940 LD	A,L
001FB2 D9      5941 EXX
001FB3 F5      5942 PUSH	AF
001FB4 CD      5943 CALL	EXPRS
001FB5 C0   
001FB6 18   
001FB7 CD      5944 CALL	BRAKET
001FB8 32   
001FB9 21   
001FBA F1      5945 POP	AF
001FBB B7      5946 OR	A
001FBC 28      5947 JR	Z,LEFT2		;N=0
001FBD BE   
001FBE 3D      5948 DEC	A
001FBF 4F      5949 LD	C,A
001FC0 3E      5950 LD	A,80H		;STRING MARKER
001FC1 80   
001FC2 C8      5951 RET	Z
001FC3 1C      5952 INC	E
001FC4 1D      5953 DEC	E
001FC5 C8      5954 RET	Z		;NULL STRING
001FC6 43      5955 LD	B,E
001FC7 62      5956 LD	H,D
001FC8 2E      5957 LD	L,0
001FC9 00   
001FCA C5      5958 STRIN1:         PUSH	BC
001FCB 7E      5959 STRIN2:         LD	A,(HL)
001FCC 23      5960 INC	HL
001FCD 12      5961 LD	(DE),A
001FCE 1C      5962 INC	E
001FCF 3E      5963 LD	A,19
001FD0 13   
001FD1 CA      5964 JP	Z,ERROR_		;"String too long"
001FD2 C8   
001FD3 3F   
001FD4 10      5965 DJNZ	STRIN2
001FD5 F5   
001FD6 C1      5966 POP	BC
001FD7 0D      5967 DEC	C
001FD8 20      5968 JR	NZ,STRIN1
001FD9 F0   
001FDA 3E      5969 LD	A,80H
001FDB 80   
001FDC C9      5970 RET
001FDD 7C      5978 TEST:           LD	A,H
001FDE B5      5979 OR	L
001FDF D9      5980 EXX
001FE0 B4      5981 OR	H
001FE1 B5      5982 OR	L
001FE2 D9      5983 EXX
001FE3 C9      5984 RET
001FE4 D9      5991 DECODE:         EXX
001FE5 FD      5992 LD	A,(IY)
001FE6 7E   
001FE7 00   
001FE8 FD      5993 INC	IY
001FE9 23   
001FEA 17      5994 RLA
001FEB 17      5995 RLA
001FEC 67      5996 LD	H,A
001FED E6      5997 AND	0C0H
001FEE C0   
001FEF FD      5998 XOR	(IY)
001FF0 AE   
001FF1 00   
001FF2 FD      5999 INC	IY
001FF3 23   
001FF4 6F      6000 LD	L,A
001FF5 7C      6001 LD	A,H
001FF6 17      6002 RLA
001FF7 17      6003 RLA
001FF8 E6      6004 AND	0C0H
001FF9 C0   
001FFA FD      6005 XOR	(IY)
001FFB AE   
001FFC 00   
001FFD FD      6006 INC	IY
001FFE 23   
001FFF 67      6007 LD	H,A
002000 D9      6008 EXX
002001 AF      6009 XOR	A
002002 4F      6010 LD	C,A
002003 67      6011 LD	H,A
002004 6F      6012 LD	L,A
002005 C9      6013 RET
002006 FD      6020 HEXSTS:         INC	IY		;SKIP TILDE
002007 23   
002008 CD      6021 CALL	ITEMN
002009 FE   
00200A 18   
00200B CD      6022 CALL	HEXSTR
00200C 11   
00200D 20   
00200E 3E      6023 LD	A,80H
00200F 80   
002010 C9      6024 RET
002011 CD      6026 HEXSTR:         CALL	SFIX
002012 9B   
002013 1C   
002014 01      6027 LD	BC,8
002015 08   
002016 00   
002017 11      6028 LD	DE,ACCS
002018 00   
002019 53   
00201A C5      6029 HEXST1:         PUSH	BC
00201B 06      6030 LD	B,4
00201C 04   
00201D AF      6031 XOR	A
00201E D9      6032 HEXST2:         EXX
00201F 29      6033 ADD	HL,HL
002020 D9      6034 EXX
002021 ED      6035 ADC	HL,HL
002022 6A   
002023 17      6036 RLA
002024 10      6037 DJNZ	HEXST2
002025 F8   
002026 C1      6038 POP	BC
002027 0D      6039 DEC	C
002028 F8      6040 RET	M
002029 28      6041 JR	Z,HEXST3
00202A 06   
00202B B7      6042 OR	A
00202C 20      6043 JR	NZ,HEXST3
00202D 03   
00202E B8      6044 CP	B
00202F 28      6045 JR	Z,HEXST1
002030 E9   
002031 C6      6046 HEXST3:         ADD	A,90H
002032 90   
002033 27      6047 DAA
002034 CE      6048 ADC	A,40H
002035 40   
002036 27      6049 DAA
002037 12      6050 LD	(DE),A
002038 13      6051 INC	DE
002039 47      6052 LD	B,A
00203A 18      6053 JR	HEXST1
00203B DE   
00203C CD      6063 STRS:           CALL	NXT
00203D 8F   
00203E 45   
00203F FE      6064 CP	'~'
002040 7E   
002041 28      6065 JR	Z,HEXSTS
002042 C3   
002043 CD      6066 CALL	ITEMN
002044 FE   
002045 18   
002046 DD      6067 LD	IX,STAVAR
002047 21   
002048 00   
002049 55   
00204A DD      6068 LD	A,(IX+3)
00204B 7E   
00204C 03   
00204D B7      6069 OR	A
00204E DD      6070 LD	IX,G9-1		;G9 FORMAT
00204F 21   
002050 76   
002051 20   
002052 28      6071 JR	Z,STR0
002053 04   
002054 DD      6072 STR:            LD	IX,STAVAR
002055 21   
002056 00   
002057 55   
002058 11      6073 STR0:           LD	DE,ACCS
002059 00   
00205A 53   
00205B 3E      6074 LD	A,37
00205C 25   
00205D CD      6075 CALL	FPP
00205E 99   
00205F 45   
002060 DA      6076 JP	C,ERROR_
002061 C8   
002062 3F   
002063 DD      6077 BIT	0,(IX+2)
002064 CB   
002065 02   
002066 46   
002067 3E      6078 STR1:           LD	A,80H		;STRING MARKER
002068 80   
002069 C8      6079 RET	Z
00206A 79      6080 LD	A,C
00206B C6      6081 ADD	A,4
00206C 04   
00206D BB      6082 STR2:           CP	E
00206E 28      6083 JR	Z,STR1
00206F F7   
002070 EB      6084 EX	DE,HL
002071 36      6085 LD	(HL),' '	;TRAILING SPACE
002072 20   
002073 23      6086 INC	HL
002074 EB      6087 EX	DE,HL
002075 18      6088 JR	STR2
002076 F6   
002077 09      6090 G9:             DW	9
002078 00   
002079 CD      6096 SCP:            CALL	SCP0
00207A 86   
00207B 20   
00207C 3E      6097 ZERO:           LD	A,0
00207D 00   
00207E D9      6098 EXX
00207F 67      6099 LD	H,A
002080 6F      6100 LD	L,A
002081 D9      6101 EXX
002082 67      6102 LD	H,A
002083 6F      6103 LD	L,A
002084 4F      6104 LD	C,A
002085 C9      6105 RET
002086 04      6107 SCP0:           INC	B
002087 0C      6108 INC	C
002088 05      6109 SCP1:           DEC	B
002089 28      6110 JR	Z,SCP2
00208A 0A   
00208B 0D      6111 DEC	C
00208C 28      6112 JR	Z,SCP3
00208D 0C   
00208E 1A      6113 LD	A,(DE)
00208F BE      6114 CP	(HL)
002090 C0      6115 RET	NZ
002091 13      6116 INC	DE
002092 23      6117 INC	HL
002093 18      6118 JR	SCP1
002094 F3   
002095 B7      6119 SCP2:           OR	A
002096 0D      6120 DEC	C
002097 C8      6121 RET	Z
002098 37      6122 SCF
002099 C9      6123 RET
00209A B7      6124 SCP3:           OR	A
00209B 0C      6125 INC	C
00209C C9      6126 RET
00209D 21      6134 PUSHS:          LD	HL,ACCS
00209E 00   
00209F 53   
0020A0 CD      6135 CALL	CHECK
0020A1 0A   
0020A2 33   
0020A3 DD      6136 POP	IX		;RETURN ADDRESS
0020A4 E1   
0020A5 B7      6137 OR	A		;CLEAR CARRY
0020A6 54      6138 LD	D,H
0020A7 4B      6139 LD	C,E
0020A8 ED      6140 SBC	HL,DE
0020A9 52   
0020AA 39      6141 ADD	HL,SP
0020AB F9      6142 LD	SP,HL
0020AC 47      6143 LD	B,A
0020AD C5      6144 PUSH	BC
0020AE 28      6145 JR	Z,PUSHS1	;ZERO LENGTH
0020AF 09   
0020B0 EB      6146 EX	DE,HL
0020B1 06      6147 LD	B,0
0020B2 00   
0020B3 68      6148 LD	L,B		;L=0
0020B4 ED      6149 LDIR			;COPY TO STACK
0020B5 B0   
0020B6 CD      6150 CALL	CHECK
0020B7 0A   
0020B8 33   
0020B9 DD      6151 PUSHS1:         JP	(IX)		;"RETURN"
0020BA E9   
0020BB DD      6159 POPS:           POP	IX		;RETURN ADDRESS
0020BC E1   
0020BD 21      6160 LD	HL,0
0020BE 00   
0020BF 00   
0020C0 44      6161 LD	B,H		;B=0
0020C1 39      6162 ADD	HL,SP
0020C2 11      6163 LD	DE,ACCS
0020C3 00   
0020C4 53   
0020C5 0C      6164 INC	C
0020C6 0D      6165 DEC	C
0020C7 28      6166 JR	Z,POPS1		;ZERO LENGTH
0020C8 02   
0020C9 ED      6167 LDIR			;COPY FROM STACK
0020CA B0   
0020CB F9      6168 POPS1:          LD	SP,HL
0020CC DD      6169 JP	(IX)		;"RETURN"
0020CD E9   
0020CE FD      6171 BINDIG:         LD	A,(IY)
0020CF 7E   
0020D0 00   
0020D1 FE      6172 CP	'0'
0020D2 30   
0020D3 D8      6173 RET	C
0020D4 FE      6174 CP	'1'+1
0020D5 32   
0020D6 3F      6175 CCF
0020D7 D8      6176 RET	C
0020D8 D6      6177 SUB	'0'
0020D9 30   
0020DA C9      6178 RET
0020DB FD      6180 HEXDIG:         LD	A,(IY)
0020DC 7E   
0020DD 00   
0020DE FE      6181 CP	'0'
0020DF 30   
0020E0 D8      6182 RET	C
0020E1 FE      6183 CP	'9'+1
0020E2 3A   
0020E3 3F      6184 CCF
0020E4 D0      6185 RET	NC
0020E5 FE      6186 CP	'A'
0020E6 41   
0020E7 D8      6187 RET	C
0020E8 D6      6188 SUB	'A'-10
0020E9 37   
0020EA FE      6189 CP	16
0020EB 10   
0020EC 3F      6190 CCF
0020ED C9      6191 RET
0020EE FE      6193 RELOPQ:         CP	'>'
0020EF 3E   
0020F0 D0      6194 RET	NC
0020F1 FE      6195 CP	'='
0020F2 3D   
0020F3 D0      6196 RET	NC
0020F4 FE      6197 CP	'<'
0020F5 3C   
0020F6 C9      6198 RET
0020F7 FD      6200 SAVEev:           INC	IY
0020F8 23   
0020F9 E6      6201 AND	0FH
0020FA 0F   
0020FB 08      6202 SAVE1:          EX	AF,AF'
0020FC FA      6203 JP	M,MISMATev
0020FD F2   
0020FE 18   
0020FF 08      6204 EX	AF,AF'
002100 E3      6205 EX	(SP),HL
002101 D9      6206 EXX
002102 E5      6207 PUSH	HL
002103 D9      6208 EXX
002104 F5      6209 PUSH	AF
002105 C5      6210 PUSH	BC
002106 E9      6211 JP	(HL)
002107 08      6213 DOIT:           EX	AF,AF'
002108 FA      6214 JP	M,MISMATev
002109 F2   
00210A 18   
00210B D9      6215 EXX
00210C C1      6216 POP	BC		;RETURN ADDRESS
00210D D9      6217 EXX
00210E 79      6218 LD	A,C
00210F C1      6219 POP	BC
002110 47      6220 LD	B,A
002111 F1      6221 POP	AF		;OPERATOR
002112 D9      6222 EXX
002113 EB      6223 EX	DE,HL
002114 E1      6224 POP	HL
002115 D9      6225 EXX
002116 EB      6226 EX	DE,HL
002117 E1      6227 POP	HL
002118 D9      6228 EXX
002119 C5      6229 PUSH	BC
00211A D9      6230 EXX
00211B CD      6231 CALL	FPP
00211C 99   
00211D 45   
00211E 38      6232 JR	C,ERROR1ev
00211F 1C   
002120 AF      6233 XOR	A
002121 08      6234 EX	AF,AF'		;TYPE
002122 FD      6235 LD	A,(IY)
002123 7E   
002124 00   
002125 C9      6236 RET
002126 CD      6238 COMMA:          CALL	NXT
002127 8F   
002128 45   
002129 FD      6239 INC	IY
00212A 23   
00212B FE      6240 CP	','
00212C 2C   
00212D C8      6241 RET	Z
00212E 3E      6242 LD	A,5
00212F 05   
002130 18      6243 JR	ERROR1ev		;"Missing ,"
002131 0A   
002132 CD      6245 BRAKET:         CALL	NXT
002133 8F   
002134 45   
002135 FD      6246 INC	IY
002136 23   
002137 FE      6247 CP	')'
002138 29   
002139 C8      6248 RET	Z
00213A 3E      6249 LD	A,27
00213B 1B   
00213C C3      6250 ERROR1ev:         JP	ERROR_		;"Missing )"
00213D C8   
00213E 3F   
00213F E5      6252 DISPT2:         PUSH	HL
002140 21      6253 LD	HL,SOPTBL
002141 7A   
002142 17   
002143 18      6254 JR	DISPT0
002144 06   
002145 E5      6256 DISPATev:         PUSH	HL
002146 D6      6257 SUB	FUNTOK
002147 8D   
002148 21      6258 LD	HL,FUNTBL
002149 06   
00214A 17   
00214B C5      6259 DISPT0:         PUSH	BC
00214C 87      6260 ADD	A,A
00214D 4F      6261 LD	C,A
00214E 06      6262 LD	B,0
00214F 00   
002150 09      6263 ADD	HL,BC
002151 7E      6264 LD	A,(HL)
002152 23      6265 INC	HL
002153 66      6266 LD	H,(HL)
002154 6F      6267 LD	L,A
002155 C1      6268 POP	BC
002156 E3      6269 EX	(SP),HL
002157 C9      6270 RET			;OFF TO ROUTINE
002158 7A      6272 STOREA:         LD	A,D
002159 D5      6273 PUSH	DE
00215A E5      6274 PUSH	HL
00215B DD      6275 EX	(SP),IX
00215C E3   
00215D B7      6276 OR	A
00215E FA      6277 JP	M,STORA1
00215F 6F   
002160 21   
002161 CD      6278 CALL	LOADN
002162 A9   
002163 19   
002164 DD      6279 EX	(SP),IX
002165 E3   
002166 CD      6280 CALL	MODIFY
002167 52   
002168 32   
002169 E1      6281 POP	HL
00216A D1      6282 POP	DE
00216B 4A      6283 LD	C,D
00216C 06      6284 LD	B,0
00216D 00   
00216E C9      6285 RET
00216F D5      6287 STORA1:         PUSH	DE
002170 CD      6288 CALL	LOADS
002171 92   
002172 1A   
002173 E1      6289 POP	HL
002174 DD      6290 EX	(SP),IX
002175 E3   
002176 CD      6291 CALL	MODIFS
002177 9C   
002178 32   
002179 E1      6292 POP	HL
00217A D1      6293 POP	DE
00217B 01      6294 LD	BC,4
00217C 04   
00217D 00   
00217E C9      6295 RET
00217F CB      6307 LETARR:         RES	6,D		;Lose array marker
002180 B2   
002181 D5      6308 PUSH	DE		;Save type & opcode
002182 CD      6309 CALL	GETAR1		;Get and check indirect link
002183 51   
002184 1A   
002185 CD      6310 CALL	ARRLEN		;DE = elements, HL addresses first
002186 28   
002187 1A   
002188 C1      6311 POP	BC
002189 78      6312 LD	A,B		;A = type
00218A D5      6313 PUSH	DE
00218B C5      6314 PUSH	BC
00218C E5      6315 PUSH	HL
00218D CD      6316 CALL	X14OR5		;DE = size in bytes
00218E 31   
00218F 37   
002190 42      6317 LD	B,D
002191 4B      6318 LD	C,E
002192 DD      6319 POP	IX
002193 E1   
002194 D1      6320 POP	DE
002195 AF      6329 XOR	A		;Clear carry and zero error code
002196 ED      6330 SBC	HL,HL
002197 62   
002198 39      6331 ADD	HL,SP		;HL = SP
002199 ED      6332 SBC	HL,BC
00219A 42   
00219B 38      6333 JR	C,ERROR1ev	;'No room'
00219C 9F   
00219D C5      6334 PUSH	BC
00219E ED      6335 LD	BC,(FREE)
00219F 4B   
0021A0 E0   
0021A1 55   
0021A2 04      6336 INC	B		;Safety margin
0021A3 ED      6337 SBC	HL,BC
0021A4 42   
0021A5 09      6338 ADD	HL,BC
0021A6 C1      6339 POP	BC
0021A7 38      6340 JR	C,ERROR1ev	;'No room'
0021A8 93   
0021A9 F9      6341 LD	SP,HL
0021AA 36      6342 LETA0:          LD	(HL),0
0021AB 00   
0021AC 23      6343 INC	HL
0021AD 0B      6344 DEC	BC
0021AE 78      6345 LD	A,B
0021AF B1      6346 OR	C
0021B0 20      6347 JR	NZ,LETA0	;Clear allocated stack
0021B1 F8   
0021B2 4E      6348 LD	C,(HL)
0021B3 23      6349 INC	HL
0021B4 46      6350 LD	B,(HL)
0021B5 67      6351 LD	H,A
0021B6 6F      6352 LD	L,A
0021B7 39      6353 ADD	HL,SP
0021B8 CD      6358 CALL	EXPRA
0021B9 C0   
0021BA 21   
0021BB F9      6359 LD	SP,HL		;Update stack pointer
0021BC C1      6360 POP	BC		;Level stack
0021BD C3      6361 JP	XEQ
0021BE 1D   
0021BF 25   
0021C0 3E      6373 EXPRA:          LD	A,'='
0021C1 3D   
0021C2 FD      6374 DEC	IY
0021C3 2B   
0021C4 FD      6375 EXPRA1:         INC	IY
0021C5 23   
0021C6 D5      6376 PUSH	DE
0021C7 C5      6377 PUSH	BC
0021C8 E5      6378 PUSH	HL
0021C9 DD      6379 PUSH	IX
0021CA E5   
0021CB 5F      6380 LD	E,A		;Operator
0021CC CD      6381 CALL	ITEMA
0021CD 3A   
0021CE 22   
0021CF DD      6382 POP	IX
0021D0 E1   
0021D1 E1      6383 POP	HL
0021D2 C1      6384 POP	BC
0021D3 D1      6385 POP	DE
0021D4 CD      6386 CALL	NXT
0021D5 8F   
0021D6 45   
0021D7 FE      6387 CP	','		;List?
0021D8 2C   
0021D9 28      6388 JR	Z,EXPRA3
0021DA 13   
0021DB CD      6389 CALL	TERMQ
0021DC BA   
0021DD 35   
0021DE 20      6390 JR	NZ,EXPRA1
0021DF E4   
0021E0 C5      6394 EXPRA2:         PUSH	BC
0021E1 CD      6395 CALL	STOREA		;(IX) <- (HL)
0021E2 58   
0021E3 21   
0021E4 09      6396 ADD	HL,BC
0021E5 DD      6397 ADD	IX,BC
0021E6 09   
0021E7 C1      6398 POP	BC
0021E8 0B      6399 DEC	BC
0021E9 78      6400 LD	A,B
0021EA B1      6401 OR	C
0021EB 20      6402 JR	NZ,EXPRA2
0021EC F3   
0021ED C9      6403 RET
0021EE C5      6407 EXPRA3:         PUSH	BC
0021EF CD      6408 CALL	STOREA		;(IX) <- (HL)
0021F0 58   
0021F1 21   
0021F2 FD      6409 EXPRA4:         INC	IY		;Bump past comma
0021F3 23   
0021F4 09      6410 ADD	HL,BC
0021F5 DD      6411 ADD	IX,BC
0021F6 09   
0021F7 C1      6412 POP	BC
0021F8 0B      6413 DEC	BC
0021F9 78      6414 LD	A,B
0021FA B1      6415 OR	C
0021FB C8      6416 RET	Z
0021FC C5      6417 PUSH	BC
0021FD D5      6418 PUSH	DE
0021FE E5      6419 PUSH	HL
0021FF DD      6420 PUSH	IX
002200 E5   
002201 CB      6421 BIT	7,D
002202 7A   
002203 20      6422 JR	NZ,EXPRA5
002204 0E   
002205 D5      6423 PUSH	DE
002206 CD      6424 CALL	EXPRN
002207 B0   
002208 18   
002209 D1      6425 POP	DE
00220A DD      6426 POP	IX
00220B E1   
00220C DD      6427 PUSH	IX
00220D E5   
00220E CD      6428 CALL	MODIFY
00220F 52   
002210 32   
002211 18      6429 JR	EXPRA6
002212 0C   
002213 D5      6431 EXPRA5:         PUSH	DE
002214 CD      6432 CALL	EXPRS
002215 C0   
002216 18   
002217 E1      6433 POP	HL
002218 DD      6434 POP	IX
002219 E1   
00221A DD      6435 PUSH	IX
00221B E5   
00221C CD      6436 CALL	MODIFS
00221D 9C   
00221E 32   
00221F DD      6437 EXPRA6:         POP	IX
002220 E1   
002221 E1      6438 POP	HL
002222 D1      6439 POP	DE
002223 01      6440 LD	BC,4
002224 04   
002225 00   
002226 CB      6441 BIT	7,D
002227 7A   
002228 20      6442 JR	NZ,EXPRA7
002229 01   
00222A 4A      6443 LD	C,D
00222B CD      6444 EXPRA7:         CALL	NXT
00222C 8F   
00222D 45   
00222E FE      6445 CP	','
00222F 2C   
002230 28      6446 JR	Z,EXPRA4
002231 C0   
002232 D1      6447 POP	DE
002233 09      6448 EXPRA8:         ADD	HL,BC		;Skip remaining elements
002234 1B      6449 DEC	DE
002235 7A      6450 LD	A,D
002236 B3      6451 OR	E
002237 20      6452 JR	NZ,EXPRA8
002238 FA   
002239 C9      6453 RET
00223A CD      6464 ITEMA:          CALL	NXT
00223B 8F   
00223C 45   
00223D E5      6465 PUSH	HL		;Pointer to destination
00223E C5      6466 PUSH	BC		;Number of elements
00223F FD      6467 PUSH	IY		;In case normal expression
002240 E5   
002241 D5      6468 PUSH	DE		;Ditto
002242 FE      6469 CP	'-'
002243 2D   
002244 20      6470 JR	NZ,ITEMA1	;Not unary minus
002245 0C   
002246 7B      6471 LD	A,E
002247 FE      6472 CP	'='
002248 3D   
002249 20      6473 JR	NZ,ITEMA1	;Not unary minus
00224A 07   
00224B FD      6474 INC	IY		;Bump past '-'
00224C 23   
00224D CD      6475 CALL	NXT
00224E 8F   
00224F 45   
002250 1E      6476 LD	E,'-'		;Unary minus
002251 2D   
002252 D5      6477 ITEMA1:         PUSH	DE		;Type and operator
002253 CD      6478 CALL	GETVAR
002254 67   
002255 42   
002256 D1      6479 POP	DE		;Type & operator
002257 20      6480 JR	NZ,ITEMA4	;Non-array expression
002258 56   
002259 CB      6481 BIT	6,A
00225A 77   
00225B 28      6482 JR	Z,ITEMA4	;Not a whole array
00225C 52   
00225D C1      6483 POP	BC		;Junk saved original op
00225E C1      6484 POP	BC		;Junk saved text pointer
00225F CB      6485 RES	6,A
002260 B7   
002261 BA      6486 CP	D
002262 C2      6487 JP	NZ,MISMATev	;'Type mismatch'
002263 F2   
002264 18   
002265 D5      6488 PUSH	DE		;Save type & operator again
002266 CD      6489 CALL	GETAR1
002267 51   
002268 1A   
002269 CD      6490 CALL	ARRLEN
00226A 28   
00226B 1A   
00226C 42      6491 LD	B,D		;BC = number of elements
00226D 4B      6492 LD	C,E
00226E D1      6493 POP	DE		;Restore type & operator
00226F E3      6494 EX	(SP),HL
002270 CD      6495 CALL	NXT
002271 8F   
002272 45   
002273 DD      6496 POP	IX		;Pointer to source
002274 E1   
002275 FE      6497 CP	'.'
002276 2E   
002277 CA      6498 JP	Z,ARRDOT	;Dot product
002278 07   
002279 23   
00227A B7      6499 OR	A
00227B ED      6500 SBC	HL,BC		;Same number of elements?
00227C 42   
00227D C2      6501 JP	NZ,MISMATev	;'Type mismatch'
00227E F2   
00227F 18   
002280 E1      6502 POP	HL		;Pointer to destination
002281 CB      6503 BIT	7,D
002282 7A   
002283 20      6504 JR	NZ,ITEMA3
002284 1D   
002285 C5      6508 ITEMA2:         PUSH	BC
002286 E5      6509 PUSH	HL
002287 7A      6510 LD	A,D
002288 CD      6511 CALL	LOADN
002289 A9   
00228A 19   
00228B DD      6512 EX	(SP),IX
00228C E3   
00228D D5      6513 PUSH	DE
00228E CD      6514 CALL	MODIFY
00228F 52   
002290 32   
002291 D1      6515 POP	DE
002292 DD      6516 EX	(SP),IX
002293 E3   
002294 E1      6517 POP	HL
002295 4A      6518 LD	C,D
002296 06      6519 LD	B,0
002297 00   
002298 DD      6520 ADD	IX,BC
002299 09   
00229A 09      6521 ADD	HL,BC
00229B C1      6522 POP	BC
00229C 0B      6523 DEC	BC
00229D 78      6524 LD	A,B
00229E B1      6525 OR	C
00229F 20      6526 JR	NZ,ITEMA2
0022A0 E4   
0022A1 C9      6527 RET
0022A2 EB      6531 ITEMA3:         EX	DE,HL		;DE = destination
0022A3 60      6532 LD	H,B
0022A4 69      6533 LD	L,C
0022A5 29      6534 ADD	HL,HL
0022A6 29      6535 ADD	HL,HL
0022A7 44      6536 LD	B,H
0022A8 4D      6537 LD	C,L
0022A9 DD      6538 PUSH	IX
0022AA E5   
0022AB E1      6539 POP	HL		;HL = source
0022AC ED      6540 LDIR
0022AD B0   
0022AE C9      6541 RET
0022AF D1      6545 ITEMA4:         POP	DE		;Restore original operator
0022B0 FD      6546 POP	IY		;Restore original text pointer
0022B1 E1   
0022B2 CB      6547 BIT	7,D
0022B3 7A   
0022B4 20      6548 JR	NZ,ITEMA5
0022B5 28   
0022B6 D5      6549 PUSH	DE
0022B7 CD      6550 CALL	EXPR45		;; should be EXP345
0022B8 8F   
0022B9 18   
0022BA 79      6551 LD	A,C		;Exponent
0022BB D1      6552 POP	DE		;Type / operator
0022BC C1      6553 POP	BC		;Count
0022BD DD      6554 POP	IX
0022BE E1   
0022BF E5      6555 ITEMA7:         PUSH	HL
0022C0 C5      6556 PUSH	BC
0022C1 D5      6557 PUSH	DE
0022C2 D9      6558 EXX
0022C3 E5      6559 PUSH	HL
0022C4 D9      6560 EXX
0022C5 F5      6561 PUSH	AF
0022C6 4F      6562 LD	C,A
0022C7 CD      6563 CALL	MODIFY
0022C8 52   
0022C9 32   
0022CA F1      6564 POP	AF
0022CB D9      6565 EXX
0022CC E1      6566 POP	HL
0022CD D9      6567 EXX
0022CE D1      6568 POP	DE
0022CF 4A      6569 LD	C,D
0022D0 06      6570 LD	B,0
0022D1 00   
0022D2 DD      6571 ADD	IX,BC
0022D3 09   
0022D4 C1      6572 POP	BC
0022D5 0B      6573 DEC	BC
0022D6 ED      6574 SBC	HL,HL
0022D7 62   
0022D8 ED      6575 SBC	HL,BC
0022D9 42   
0022DA E1      6576 POP	HL
0022DB 20      6577 JR	NZ,ITEMA7	;Copy into every element!
0022DC E2   
0022DD C9      6578 RET
0022DE CD      6582 ITEMA5:         CALL	EXPRS
0022DF C0   
0022E0 18   
0022E1 7B      6583 LD	A,E
0022E2 B7      6584 OR	A
0022E3 28      6585 JR	Z,ITEMA0
0022E4 0B   
0022E5 21      6586 LD	HL,ACCS
0022E6 00   
0022E7 53   
0022E8 11      6587 LD	DE,BUFFER
0022E9 00   
0022EA 54   
0022EB 4F      6588 LD	C,A
0022EC 06      6589 LD	B,0
0022ED 00   
0022EE ED      6590 LDIR
0022EF B0   
0022F0 C1      6591 ITEMA0:         POP	BC
0022F1 DD      6592 POP	IX
0022F2 E1   
0022F3 D9      6593 EXX
0022F4 6F      6594 LD	L,A
0022F5 D9      6595 EXX
0022F6 11      6596 LD	DE,4
0022F7 04   
0022F8 00   
0022F9 21      6597 LD	HL,BUFFER
0022FA 00   
0022FB 54   
0022FC CD      6598 ITEMA6:         CALL	STORE4
0022FD 8D   
0022FE 32   
0022FF DD      6599 ADD	IX,DE
002300 19   
002301 0B      6600 DEC	BC
002302 78      6601 LD	A,B
002303 B1      6602 OR	C
002304 20      6603 JR	NZ,ITEMA6	;Copy into every element!
002305 F6   
002306 C9      6604 RET
002307 FD      6608 ARRDOT:         INC	IY		;Bump past dot
002308 23   
002309 7A      6609 LD	A,D		;Type
00230A B7      6610 OR	A
00230B FA      6611 JP	M,MISMATev	;'Type mismatch'
00230C F2   
00230D 18   
00230E EB      6612 EX	DE,HL
00230F E1      6613 POP	HL
002310 D5      6621 PUSH	DE
002311 E5      6622 PUSH	HL
002312 DD      6623 PUSH	IX
002313 E5   
002314 F5      6624 PUSH	AF
002315 CD      6625 CALL	GETARR
002316 41   
002317 1A   
002318 CD      6626 CALL	ARRLEN
002319 28   
00231A 1A   
00231B F1      6627 POP	AF
00231C EB      6628 EX	DE,HL
00231D DD      6629 LD	L,(IX)
00231E 6E   
00231F 00   
002320 DD      6630 LD	H,(IX+1)	;Indirect pointer
002321 66   
002322 01   
002323 6E      6631 LD	L,(HL)		;No. of dimensions
002324 2D      6632 DEC	L
002325 EB      6633 EX	DE,HL
002326 DD      6634 POP	IX
002327 E1   
002328 C1      6635 POP	BC
002329 D1      6636 POP	DE
00232A FD      6638 PUSH	IY		;Save text pointer
00232B E5   
00232C C5      6639 PUSH	BC		;Save destination pointer
00232D E5      6640 PUSH	HL
00232E FD      6641 POP	IY
00232F E1   
002330 21      6645 LD	HL,1
002331 01   
002332 00   
002333 28      6646 JR	Z,ARR1D
002334 06   
002335 FD      6647 LD	H,(IY-1)
002336 66   
002337 FF   
002338 FD      6648 LD	L,(IY-2)
002339 6E   
00233A FE   
00233B D5      6649 ARR1D:          PUSH	DE
00233C EB      6650 EX	DE,HL
00233D CD      6651 CALL	X14OR5
00233E 31   
00233F 37   
002340 EB      6652 EX	DE,HL
002341 D1      6653 POP	DE
002342 DD      6654 LD	B,(IX-1)
002343 46   
002344 FF   
002345 DD      6655 LD	C,(IX-2)
002346 4E   
002347 FE   
002348 C5      6667 OUTER:          PUSH	BC		;1
002349 D5      6668 PUSH	DE		;2
00234A E5      6669 PUSH	HL		;3
00234B DD      6670 PUSH	IX		;4
00234C E5   
00234D FD      6671 PUSH	IY		;5
00234E E5   
00234F 50      6672 LD	D,B
002350 59      6673 LD	E,C
002351 F5      6674 PUSH	AF
002352 CD      6675 CALL	ZERO		;Zero accumulator
002353 7C   
002354 20   
002355 F1      6676 POP	AF
002356 D5      6677 INNER:          PUSH	DE		;6
002357 C5      6678 PUSH	BC		;Save accumulator
002358 E5      6679 PUSH	HL
002359 D9      6680 EXX
00235A E5      6681 PUSH	HL
00235B D9      6682 EXX
00235C CD      6684 CALL	LOADN		;Load from (IX)
00235D A9   
00235E 19   
00235F DD      6685 PUSH	IX
002360 E5   
002361 FD      6686 EX	(SP),IY
002362 E3   
002363 DD      6687 POP	IX
002364 E1   
002365 CD      6689 CALL	DLOADN		;Load from (IY)
002366 6B   
002367 1A   
002368 DD      6690 PUSH	IX
002369 E5   
00236A FD      6691 EX	(SP),IY
00236B E3   
00236C DD      6692 POP	IX
00236D E1   
00236E F5      6694 PUSH	AF
00236F 3E      6695 LD	A,10
002370 0A   
002371 CD      6696 CALL	FPP		;Multiply
002372 99   
002373 45   
002374 DA      6697 JP	C,ERROR_
002375 C8   
002376 3F   
002377 F1      6698 POP	AF
002378 D9      6700 EXX			;Restore accumulator
002379 EB      6701 EX	DE,HL
00237A E1      6702 POP	HL
00237B D9      6703 EXX
00237C EB      6704 EX	DE,HL
00237D E1      6705 POP	HL
00237E 08      6706 EX	AF,AF'
00237F 79      6707 LD	A,C
002380 C1      6708 POP	BC
002381 47      6709 LD	B,A
002382 08      6710 EX	AF,AF'
002383 F5      6712 PUSH	AF
002384 3E      6713 LD	A,11
002385 0B   
002386 CD      6714 CALL	FPP		;Accumulate
002387 99   
002388 45   
002389 DA      6715 JP	C,ERROR_
00238A C8   
00238B 3F   
00238C F1      6716 POP	AF
00238D D1      6720 POP	DE		;5
00238E D9      6722 EXX
00238F 4F      6723 LD	C,A
002390 06      6724 LD	B,0
002391 00   
002392 DD      6725 ADD	IX,BC
002393 09   
002394 D1      6726 POP	DE
002395 C1      6727 POP	BC
002396 E3      6728 EX	(SP),HL
002397 EB      6729 EX	DE,HL
002398 FD      6730 ADD	IY,DE
002399 19   
00239A EB      6731 EX	DE,HL
00239B E3      6732 EX	(SP),HL
00239C C5      6733 PUSH	BC
00239D D5      6734 PUSH	DE
00239E D9      6735 EXX
00239F 1B      6739 DEC	DE		;Inner loop counter
0023A0 1C      6740 INC	E
0023A1 1D      6741 DEC	E
0023A2 20      6742 JR	NZ,INNER
0023A3 B2   
0023A4 14      6743 INC	D
0023A5 15      6744 DEC	D
0023A6 20      6745 JR	NZ,INNER
0023A7 AE   
0023A8 FD      6747 POP	IY		;4
0023A9 E1   
0023AA DD      6748 POP	IX		;3
0023AB E1   
0023AC D9      6752 EXX
0023AD 08      6753 EX	AF,AF'
0023AE F1      6754 POP	AF
0023AF C1      6755 POP	BC
0023B0 D1      6756 POP	DE
0023B1 DD      6757 EX	(SP),IX
0023B2 E3   
0023B3 D5      6758 PUSH	DE
0023B4 C5      6759 PUSH	BC
0023B5 F5      6760 PUSH	AF
0023B6 08      6761 EX	AF,AF'
0023B7 D9      6762 EXX
0023B8 F5      6766 PUSH	AF
0023B9 D5      6767 PUSH	DE
0023BA CD      6768 CALL	STOREN
0023BB 74   
0023BC 32   
0023BD D1      6769 POP	DE
0023BE F1      6770 POP	AF
0023BF 4F      6771 LD	C,A
0023C0 06      6772 LD	B,0
0023C1 00   
0023C2 DD      6773 ADD	IX,BC
0023C3 09   
0023C4 D9      6777 EXX
0023C5 08      6778 EX	AF,AF'
0023C6 F1      6779 POP	AF
0023C7 C1      6780 POP	BC
0023C8 D1      6781 POP	DE
0023C9 DD      6782 EX	(SP),IX
0023CA E3   
0023CB D5      6783 PUSH	DE
0023CC C5      6784 PUSH	BC
0023CD F5      6785 PUSH	AF
0023CE 08      6786 EX	AF,AF'
0023CF D9      6787 EXX
0023D0 E1      6789 POP	HL		;2
0023D1 D1      6790 POP	DE		;1 Outer loop counter
0023D2 C1      6791 POP	BC		;0
0023D3 1B      6792 DEC	DE		;Count outer loops
0023D4 C5      6796 PUSH	BC
0023D5 D5      6797 PUSH	DE
0023D6 E5      6798 PUSH	HL
0023D7 4F      6799 LD	C,A
0023D8 06      6800 LD	B,0
0023D9 00   
0023DA FD      6801 ADD	IY,BC
0023DB 09   
0023DC F5      6802 PUSH	AF
0023DD E5      6803 PUSH	HL
0023DE CD      6804 CALL	X14OR5
0023DF 31   
0023E0 37   
0023E1 C1      6805 POP	BC
0023E2 CD      6806 CALL	MOD16
0023E3 14   
0023E4 24   
0023E5 F1      6807 POP	AF
0023E6 B7      6808 OR	A
0023E7 01      6809 LD	BC,0
0023E8 00   
0023E9 00   
0023EA ED      6810 SBC	HL,BC
0023EB 42   
0023EC E1      6811 POP	HL
0023ED D1      6812 POP	DE
0023EE C1      6813 POP	BC
0023EF 20      6814 JR	NZ,MODNZ
0023F0 15   
0023F1 D5      6815 PUSH	DE
0023F2 E5      6816 PUSH	HL
0023F3 EB      6817 EX	DE,HL
0023F4 FD      6818 PUSH	IY
0023F5 E5   
0023F6 E1      6819 POP	HL
0023F7 B7      6820 OR	A
0023F8 ED      6821 SBC	HL,DE
0023F9 52   
0023FA E5      6822 PUSH	HL
0023FB FD      6823 POP	IY
0023FC E1   
0023FD 50      6824 LD	D,B
0023FE 59      6825 LD	E,C
0023FF CD      6826 CALL	X14OR5
002400 31   
002401 37   
002402 DD      6827 ADD	IX,DE
002403 19   
002404 E1      6828 POP	HL
002405 D1      6829 POP	DE
002406 1C      6834 INC	E
002407 1D      6835 DEC	E
002408 C2      6836 JP	NZ,OUTER
002409 48   
00240A 23   
00240B 14      6837 INC	D
00240C 15      6838 DEC	D
00240D C2      6839 JP	NZ,OUTER
00240E 48   
00240F 23   
002410 E1      6843 POP	HL
002411 FD      6844 POP	IY
002412 E1   
002413 C9      6845 RET
002414 AF      6849 MOD16:          XOR	A
002415 67      6850 LD	H,A
002416 6F      6851 LD	L,A
002417 3E      6852 LD	A,17
002418 11   
002419 ED      6853 MOD160:         SBC	HL,BC
00241A 42   
00241B 30      6854 JR	NC,MOD161
00241C 01   
00241D 09      6855 ADD	HL,BC
00241E 3F      6856 MOD161:         CCF
00241F CB      6857 RL	E
002420 13   
002421 CB      6858 RL	D
002422 12   
002423 3D      6859 DEC	A
002424 C8      6860 RET	Z
002425 ED      6861 ADC	HL,HL
002426 6A   
002427 18      6862 JR	MOD160
002428 F0   
002429             6867   ; --- Begin exec.asm ---
002429 FB      7054 CMDTAB:         DW	LEFTSL
00242A 30   
00242B 0F      7055 DW	MIDSL
00242C 31   
00242D 05      7056 DW	RITESL
00242E 31   
00242F 64      7057 DW	SYNTAX	;STR$
002430 26   
002431 64      7058 DW	SYNTAX	;STRING$
002432 26   
002433 64      7059 DW	SYNTAX	;EOF
002434 26   
002435 64      7060 DW	SYNTAX	;SUM
002436 26   
002437 AA      7061 DW	WHILE
002438 2E   
002439 DB      7062 DW	CASE
00243A 2D   
00243B 64      7063 DW	SYNTAX	;WHEN
00243C 26   
00243D 64      7064 DW	SYNTAX	;OF
00243E 26   
00243F 1D      7065 DW	XEQ	;ENDCASE
002440 25   
002441 64      7066 DW	SYNTAX	;OTHERWISE
002442 26   
002443 1D      7067 DW	XEQ	;ENDIF
002444 25   
002445 C7      7068 DW	ENDWHI	;ENDWHILE
002446 2E   
002447 85      7069 DW	PTR
002448 2F   
002449 99      7070 DW	PAGEV
00244A 2F   
00244B A7      7071 DW	TIMEV
00244C 2F   
00244D C6      7072 DW	LOMEMV
00244E 2F   
00244F D8      7073 DW	HIMEMV
002450 2F   
002451 B5      7074 DW	SOUND
002452 0E   
002453 57      7075 DW	BPUT
002454 30   
002455 90      7076 DW	CALL
002456 30   
002457 D0      7077 DW	CHAIN
002458 24   
002459 1A      7078 DW	CLR
00245A 2F   
00245B 4F      7079 DW	CLOSE
00245C 30   
00245D F9      7080 DW	CLG
00245E 0E   
00245F F9      7081 DW	CLS
002460 2E   
002461 B5      7082 DW	REM		;DATA
002462 25   
002463 B5      7083 DW	REM		;DEF
002464 25   
002465 C2      7084 DW	DIM
002466 26   
002467 00      7085 DW	DRAW
002468 10   
002469 57      7086 DW	END
00246A 25   
00246B 01      7087 DW	ENDPRO
00246C 2C   
00246D 87      7088 DW	ENVEL
00246E 0E   
00246F 98      7089 DW	FORex
002470 29   
002471 4F      7090 DW	GOSUB
002472 29   
002473 38      7091 DW	GOTO
002474 29   
002475 51      7092 DW	GCOL
002476 0F   
002477 4D      7093 DW	IF_
002478 2D   
002479 66      7094 DW	INPUT
00247A 2C   
00247B 25      7095 DW	LET
00247C 26   
00247D 97      7096 DW	LOCAL
00247E 2B   
00247F E9      7097 DW	MODE
002480 0E   
002481 FC      7098 DW	MOVE
002482 0F   
002483 E5      7099 DW	NEXT
002484 29   
002485 BE      7100 DW	ON
002486 28   
002487 20      7101 DW	VDU
002488 30   
002489 08      7102 DW	PLOT
00248A 10   
00248B CA      7103 DW	PRINT
00248C 27   
00248D 6B      7104 DW	PROC
00248E 2A   
00248F 04      7105 DW	READ
002490 2D   
002491 B5      7106 DW	REM
002492 25   
002493 69      7107 DW	REPEAT
002494 29   
002495 15      7108 DW	REPOR
002496 2F   
002497 40      7109 DW	RESTOR
002498 2F   
002499 5A      7110 DW	RETURN
00249A 29   
00249B CB      7111 DW	RUN
00249C 24   
00249D 02      7112 DW	STOP
00249E 2F   
00249F 11      7113 DW	COLOUR
0024A0 0F   
0024A1 07      7114 DW	TRACE
0024A2 30   
0024A3 71      7115 DW	UNTIL
0024A4 29   
0024A5 FD      7116 DW	WIDTHV
0024A6 2F   
0024A7 8C      7117 DW	CLI		;OSCLI
0024A8 25   
0024A9 B5      7118 DW	REM		;NUL
0024AA 25   
0024AB 9F      7119 DW	CIRCLE
0024AC 0F   
0024AD CB      7120 DW	ELLIPS
0024AE 0F   
0024AF 04      7121 DW	FILL
0024B0 10   
0024B1 BE      7122 DW	MOUSE
0024B2 10   
0024B3 00      7123 DW	ORIGIN
0024B4 0F   
0024B5 B0      7124 DW	BYE		;QUIT
0024B6 0A   
0024B7 3D      7125 DW	RECTAN
0024B8 10   
0024B9 E2      7126 DW	SWAPex
0024BA 25   
0024BB 95      7127 DW	SYS
0024BC 11   
0024BD 95      7128 DW	TINT
0024BE 11   
0024BF FD      7129 DW	WAIT
0024C0 10   
0024C1 64      7130 DW	SYNTAX		;INSTALL
0024C2 26   
0024C3 B5      7131 DW	REM		;CR
0024C4 25   
0024C5 21      7132 DW	PUT		;Token changed
0024C6 32   
0024C7 64      7133 DW	SYNTAX		;BY
0024C8 26   
0024C9 A7      7134 DW	EXITex
0024CA 31   
0024CB CD      7139 RUN:            CALL	TERMQ
0024CC BA   
0024CD 35   
0024CE 28      7140 JR	Z,RUN0
0024CF 0D   
0024D0 CD      7141 CHAIN:          CALL	EXPRS
0024D1 C0   
0024D2 18   
0024D3 3E      7142 LD	A,CR
0024D4 0D   
0024D5 12      7143 LD	(DE),A
0024D6 ED      7144 CHAIN0:         LD	SP,(HIMEM)
0024D7 7B   
0024D8 E2   
0024D9 55   
0024DA CD      7145 CALL	LOAD0
0024DB 84   
0024DC 40   
0024DD ED      7146 RUN0:           LD	SP,(HIMEM)	;PREPARE FOR RUN
0024DE 7B   
0024DF E2   
0024E0 55   
0024E1 DD      7147 LD	IX,RANDOM
0024E2 21   
0024E3 F6   
0024E4 55   
0024E5 ED      7148 RAND:           LD	A,R		;RANDOMISE (CARE!)
0024E6 5F   
0024E7 28      7149 JR	Z,RAND
0024E8 FC   
0024E9 07      7150 RLCA
0024EA 07      7151 RLCA
0024EB DD      7152 LD	(IX+3),A
0024EC 77   
0024ED 03   
0024EE 9F      7153 SBC	A,A
0024EF DD      7154 LD	(IX+4),A
0024F0 77   
0024F1 04   
0024F2 CD      7155 CALL	CLEAR
0024F3 C7   
0024F4 40   
0024F5 21      7156 LD	HL,0
0024F6 00   
0024F7 00   
0024F8 22      7157 LD	(ERRTRP),HL
0024F9 EA   
0024FA 55   
0024FB 2A      7158 LD	HL,(PAGE_)
0024FC DC   
0024FD 55   
0024FE CD      7159 CALL	DSRCH		;LOOK FOR "DATA"
0024FF 7D   
002500 36   
002501 22      7160 LD	(DATPTR),HL	;SET DATA POINTER
002502 F0   
002503 55   
002504 FD      7161 LD	IY,(PAGE_)
002505 2A   
002506 DC   
002507 55   
002508 CD      7162 XEQ0:           CALL	NEWLIN
002509 5F   
00250A 25   
00250B FD      7163 LD	A,(IY)
00250C 7E   
00250D 00   
00250E FE      7164 CP	TELSE
00250F 8B   
002510 CA      7165 JP	Z,MELSE		;ELSE
002511 B4   
002512 2D   
002513 FE      7166 CP	TWHEN
002514 C9   
002515 CA      7167 JP	Z,WHEN		;WHEN
002516 C7   
002517 2D   
002518 FE      7168 CP	TOTHERWISE
002519 CC   
00251A CA      7169 JP	Z,WHEN
00251B C7   
00251C 2D   
00251D FD      7170 XEQ:            LD	(CURLIN),IY	;ERROR POINTER
00251E 22   
00251F F4   
002520 55   
002521 CD      7171 CALL	TRAP		;CHECK KEYBOARD
002522 35   
002523 06   
002524 CD      7172 XEQ1:           CALL	NXT
002525 8F   
002526 45   
002527 FD      7173 INC	IY
002528 23   
002529 FE      7174 CP	':'		;SEPARATOR
00252A 3A   
00252B 28      7175 JR	Z,XEQ1
00252C F7   
00252D FE      7176 CP	CR
00252E 0D   
00252F 28      7177 JR	Z,XEQ0		;NEW PROGRAM LINE
002530 D7   
002531 FE      7178 CP	TLAST
002532 91   
002533 EA      7179 JP	PE,LET0		;IMPLIED LET
002534 17   
002535 26   
002536 D6      7180 SUB	TCMD
002537 C0   
002538 FA      7181 JP	M,EXTRAS
002539 9A   
00253A 25   
00253B 87      7182 ADD	A,A
00253C 4F      7183 LD	C,A
00253D 06      7184 LD	B,0
00253E 00   
00253F 21      7185 LD	HL,CMDTAB
002540 29   
002541 24   
002542 09      7186 ADD	HL,BC
002543 7E      7187 LD	A,(HL)		;TABLE ENTRY
002544 23      7188 INC	HL
002545 66      7189 LD	H,(HL)
002546 6F      7190 LD	L,A
002547 CD      7191 CALL	NXT
002548 8F   
002549 45   
00254A E9      7192 JP	(HL)		;EXECUTE STATEMENT
00254B FD      7196 ENDIM:          PUSH	IY
00254C E5   
00254D E1      7197 POP	HL
00254E ED      7198 LD	BC,(PAGE_)
00254F 4B   
002550 DC   
002551 55   
002552 ED      7199 SBC	HL,BC		;IMMEDIATE MODE ?
002553 42   
002554 DA      7200 JP	C,CLOOP
002555 34   
002556 38   
002557 1E      7201 END:            LD	E,0
002558 00   
002559 CD      7202 CALL	OSSHUT		;CLOSE ALL FILES
00255A 55   
00255B 06   
00255C C3      7203 JP	WARM		;"Ready"
00255D 33   
00255E 38   
00255F FD      7205 NEWLIN:         LD	A,(IY+0)	;A=LINE LENGTH
002560 7E   
002561 00   
002562 01      7206 LD	BC,3
002563 03   
002564 00   
002565 FD      7207 ADD	IY,BC
002566 09   
002567 B7      7208 OR	A
002568 28      7209 JR	Z,ENDIM		;LENGTH=0, EXITex
002569 E1   
00256A 2A      7210 LD	HL,(TRACEN)
00256B E6   
00256C 55   
00256D 7C      7211 LD	A,H
00256E B5      7212 OR	L
00256F C8      7213 RET	Z
002570 FD      7214 LD	D,(IY-1)	;DE = LINE NUMBER
002571 56   
002572 FF   
002573 FD      7215 LD	E,(IY-2)
002574 5E   
002575 FE   
002576 ED      7216 SBC	HL,DE
002577 52   
002578 D8      7217 RET	C
002579 EB      7218 EX	DE,HL
00257A 3E      7219 LD	A,'['		;TRACE
00257B 5B   
00257C CD      7220 CALL	OUTCHR
00257D 86   
00257E 41   
00257F CD      7221 CALL	PBCDL
002580 16   
002581 42   
002582 3E      7222 LD	A,']'
002583 5D   
002584 CD      7223 CALL	OUTCHR
002585 86   
002586 41   
002587 3E      7224 LD	A,' '
002588 20   
002589 C3      7225 JP	OUTCHR
00258A 86   
00258B 41   
00258C CD      7231 CLI:            CALL	EXPRS
00258D C0   
00258E 18   
00258F 3E      7232 LD	A,CR
002590 0D   
002591 12      7233 LD	(DE),A
002592 21      7234 LD	HL,ACCS
002593 00   
002594 53   
002595 CD      7235 CALL	OSCLI
002596 37   
002597 0A   
002598 18      7236 JR	XEQ
002599 83   
00259A FE      7238 EXTRAS:         CP	TELSE-TCMD
00259B CB   
00259C 28      7239 JR	Z,REM		;ELSE
00259D 17   
00259E FE      7240 CP	TERROR-TCMD
00259F C5   
0025A0 28      7241 JR	Z,THROW		;ERROR
0025A1 21   
0025A2 FE      7242 CP	TLINE-TCMD
0025A3 C6   
0025A4 CA      7243 JP	Z,LINE		;LINE
0025A5 89   
0025A6 0F   
0025A7 FE      7244 CP	TOFF-TCMD
0025A8 C7   
0025A9 CA      7245 JP	Z,CSROFF	;OFF
0025AA 72   
0025AB 0F   
0025AC C3      7246 JP	SYNTAX
0025AD 64   
0025AE 26   
0025AF FD      7250 EXT:            PUSH	IY
0025B0 E5   
0025B1 E1      7251 POP	HL
0025B2 CD      7252 CALL	OSCLI
0025B3 37   
0025B4 0A   
0025B5 FD      7253 REM:            PUSH	IY
0025B6 E5   
0025B7 E1      7254 POP	HL
0025B8 3E      7255 LD	A,CR
0025B9 0D   
0025BA 47      7256 LD	B,A
0025BB ED      7257 CPIR			;FIND LINE END
0025BC B1   
0025BD E5      7258 PUSH	HL
0025BE FD      7259 POP	IY
0025BF E1   
0025C0 C3      7260 JP	XEQ0
0025C1 08   
0025C2 25   
0025C3 CD      7264 THROW:          CALL	EXPRI
0025C4 B7   
0025C5 18   
0025C6 D9      7265 EXX
0025C7 E5      7266 PUSH	HL
0025C8 D9      7267 EXX
0025C9 CD      7268 CALL	COMMA
0025CA 26   
0025CB 21   
0025CC CD      7269 CALL	EXPRS
0025CD C0   
0025CE 18   
0025CF E1      7270 POP	HL
0025D0 AF      7271 XOR	A
0025D1 12      7272 LD	(DE),A
0025D2 7D      7273 LD	A,L
0025D3 21      7274 LD	HL,ACCS
0025D4 00   
0025D5 53   
0025D6 11      7275 LD	DE,BUFFER
0025D7 00   
0025D8 54   
0025D9 D5      7276 PUSH	DE
0025DA 01      7277 LD	BC,256
0025DB 00   
0025DC 01   
0025DD ED      7278 LDIR
0025DE B0   
0025DF C3      7279 JP	EXTERR
0025E0 D9   
0025E1 3F   
0025E2 CD      7283 SWAPex:           CALL	GETVAR
0025E3 67   
0025E4 42   
0025E5 20      7284 JR	NZ,SWAPNZ
0025E6 0B   
0025E7 F5      7285 PUSH	AF
0025E8 E5      7286 PUSH	HL
0025E9 CD      7287 CALL	COMMA
0025EA 26   
0025EB 21   
0025EC CD      7288 CALL	NXT
0025ED 8F   
0025EE 45   
0025EF CD      7289 CALL	GETVAR
0025F0 67   
0025F1 42   
0025F2 20      7290 SWAPNZ:         JR	NZ,NOSUCH
0025F3 6D   
0025F4 D1      7291 POP	DE
0025F5 C1      7292 POP	BC
0025F6 B8      7293 CP	B
0025F7 20      7294 JR	NZ,MISMAT
0025F8 74   
0025F9 E6      7295 AND	00001111B
0025FA 0F   
0025FB 28      7296 JR	Z,MISMAT
0025FC 70   
0025FD 78      7297 LD	A,B
0025FE E6      7298 AND	11000000B
0025FF C0   
002600 28      7299 JR	Z,SWAP1ex
002601 0A   
002602 06      7300 LD	B,2
002603 02   
002604 F2      7301 JP	P,SWAP1ex
002605 0C   
002606 26   
002607 EA      7302 JP	PE,SWAP1ex
002608 0C   
002609 26   
00260A 06      7303 LD	B,4
00260B 04   
00260C 4E      7304 SWAP1ex:          LD	C,(HL)
00260D 1A      7305 LD	A,(DE)
00260E 77      7306 LD	(HL),A
00260F 79      7307 LD	A,C
002610 12      7308 LD	(DE),A
002611 13      7309 INC	DE
002612 23      7310 INC	HL
002613 10      7311 DJNZ	SWAP1ex
002614 F7   
002615 18      7312 JR	XEQGO4
002616 28   
002617 FE      7316 LET0:           CP	'*'
002618 2A   
002619 28      7317 JR	Z,EXT
00261A 94   
00261B FE      7318 CP	'='
00261C 3D   
00261D 28      7319 JR	Z,FNEND
00261E 71   
00261F FE      7320 CP	'['
002620 5B   
002621 28      7321 JR	Z,ASM
002622 52   
002623 FD      7322 DEC	IY
002624 2B   
002625 CD      7323 LET:            CALL	ASSIGN
002626 33   
002627 32   
002628 CA      7324 JP	Z,XEQ
002629 1D   
00262A 25   
00262B 38      7325 JR	C,SYNTAX	;"Syntax error"
00262C 37   
00262D F2      7326 JP	P,LETARR	;Numeric array
00262E 7F   
00262F 21   
002630 EA      7327 JP	PE,LETARR	;String array
002631 7F   
002632 21   
002633 7A      7328 LD	A,D		;Type
002634 D5      7329 PUSH	DE
002635 E5      7330 PUSH	HL
002636 CD      7331 CALL	EXPRS
002637 C0   
002638 18   
002639 DD      7332 POP	IX
00263A E1   
00263B E1      7333 POP	HL
00263C CD      7334 CALL	MODIFS
00263D 9C   
00263E 32   
00263F C3      7335 XEQGO4:         JP	XEQ
002640 1D   
002641 25   
002642 CD      7342 GETSTR:         CALL	GETVAR
002643 67   
002644 42   
002645 20      7343 JR	NZ,NOSUCH
002646 1A   
002647 47      7344 LD	B,A
002648 E6      7345 AND	11000000B
002649 C0   
00264A F2      7346 JP	P,MISMAT
00264B 6D   
00264C 26   
00264D EA      7347 JP	PE,BADUSE
00264E 6A   
00264F 26   
002650 CB      7348 BIT	0,B
002651 40   
002652 28      7349 JR	Z,MISMAT
002653 19   
002654 CD      7350 CALL	NXT
002655 8F   
002656 45   
002657 FE      7351 CP	','
002658 2C   
002659 C9      7352 RET
00265A CD      7354 VAR_:           CALL	GETVAR
00265B 67   
00265C 42   
00265D C8      7355 RET	Z
00265E D2      7356 JP	NC,PUTVAR
00265F 51   
002660 42   
002661 3E      7357 NOSUCH:         LD	A,26		;'No such variable'
002662 1A   
002663 21      7358 DB	21H
002664 3E      7359 SYNTAX:         LD	A,16		;"Syntax error"
002665 10   
002666 21      7360 DB	21H
002667 3E      7361 ESCAPE:         LD	A,17		;"Escape"
002668 11   
002669 21      7362 DB	21H
00266A 3E      7363 BADUSE:         LD	A,14		;'Bad use of array'
00266B 0E   
00266C 21      7364 DB	21H
00266D 3E      7365 MISMAT:         LD	A,6		;'Type mismatch'
00266E 06   
00266F C3      7366 ERROR0ex:         JP	ERROR_
002670 C8   
002671 3F   
002672 CD      7368 ASM0:           CALL	NEWLIN
002673 5F   
002674 25   
002675 FD      7369 ASM:            LD	(CURLIN),IY
002676 22   
002677 F4   
002678 55   
002679 CD      7370 CALL	TRAP
00267A 35   
00267B 06   
00267C CD      7371 CALL	ASSEM
00267D 9F   
00267E 11   
00267F 38      7372 JR	C,SYNTAX
002680 E3   
002681 FE      7373 CP	CR
002682 0D   
002683 28      7374 JR	Z,ASM0
002684 ED   
002685 21      7375 LD	HL,LISTON
002686 FE   
002687 55   
002688 7E      7376 LD	A,(HL)
002689 E6      7377 AND	0FH
00268A 0F   
00268B F6      7378 OR	30H
00268C 30   
00268D 77      7379 LD	(HL),A
00268E 18      7380 JR	XEQGO4
00268F AF   
002690 CD      7384 FNEND:          CALL	EXPR		;FUNCTION RESULT
002691 86   
002692 17   
002693 08      7385 EX	AF,AF'
002694 87      7386 ADD	A,A
002695 7B      7387 LD	A,E
002696 38      7388 JR	C,FNEND1
002697 01   
002698 79      7389 LD	A,C
002699 08      7390 FNEND1:         EX	AF,AF'
00269A E5      7391 PUSH	HL
00269B D9      7392 EXX
00269C C1      7393 POP	BC
00269D EB      7394 EX	DE,HL		;SAVE RESULT IN A'B'C'D'E'
00269E D9      7395 EXX
00269F C1      7396 FNEND2:         POP	BC
0026A0 21      7397 LD	HL,FNCHK
0026A1 6B   
0026A2 2A   
0026A3 AF      7398 XOR	A
0026A4 ED      7399 SBC	HL,BC
0026A5 42   
0026A6 28      7400 JR	Z,FNEND3
0026A7 0A   
0026A8 C5      7401 PUSH	BC
0026A9 CD      7402 CALL	RESLOC
0026AA B5   
0026AB 34   
0026AC 20      7403 JR	NZ,FNEND2
0026AD F1   
0026AE 3E      7404 LD	A,7
0026AF 07   
0026B0 18      7405 JR	ERROR0ex		;"No FN"
0026B1 BD   
0026B2 FD      7407 FNEND3:         POP	IY
0026B3 E1   
0026B4 FD      7408 LD	(CURLIN),IY	;IN CASE OF ERROR
0026B5 22   
0026B6 F4   
0026B7 55   
0026B8 D9      7409 EXX
0026B9 EB      7410 EX	DE,HL
0026BA C5      7411 PUSH	BC
0026BB D9      7412 EXX
0026BC E1      7413 POP	HL
0026BD 08      7414 EX	AF,AF'
0026BE 5F      7415 LD	E,A
0026BF 4F      7416 LD	C,A
0026C0 1F      7417 RRA
0026C1 C9      7418 RET
0026C2 FD      7423 DIM:            PUSH	IY
0026C3 E5   
0026C4 FE      7424 CP	'!'
0026C5 21   
0026C6 CA      7425 JP	Z,DIM4
0026C7 93   
0026C8 27   
0026C9 CD      7426 CALL	LOCATE		;VARIABLE
0026CA 34   
0026CB 43   
0026CC DA      7427 JP	C,BADDIM
0026CD 7D   
0026CE 27   
0026CF C4      7428 CALL	NZ,CREATE
0026D0 C0   
0026D1 43   
0026D2 FD      7429 LD	A,(IY)
0026D3 7E   
0026D4 00   
0026D5 FE      7430 CP	'('
0026D6 28   
0026D7 C2      7431 JP	NZ,DIM4
0026D8 93   
0026D9 27   
0026DA E5      7432 PUSH	HL
0026DB DD      7433 POP	IX
0026DC E1   
0026DD 7E      7434 LD	A,(HL)
0026DE E6      7435 AND	0FEH
0026DF FE   
0026E0 23      7436 INC	HL
0026E1 B6      7437 OR	(HL)
0026E2 C2      7438 JP	NZ,DIM4
0026E3 93   
0026E4 27   
0026E5 C1      7439 POP	BC		;LEVEL STACK
0026E6 7A      7440 LD	A,D
0026E7 2A      7441 LD	HL,(FREE)
0026E8 E0   
0026E9 55   
0026EA E5      7442 PUSH	HL
0026EB DD      7443 EX	(SP),IX
0026EC E3   
0026ED E5      7444 PUSH	HL
0026EE F5      7445 PUSH	AF		;SAVE TYPE
0026EF 11      7446 LD	DE,1
0026F0 01   
0026F1 00   
0026F2 42      7447 LD	B,D		;DIMENSION COUNTER
0026F3 FD      7448 DIM1:           INC	IY
0026F4 23   
0026F5 C5      7449 PUSH	BC
0026F6 D5      7450 PUSH	DE
0026F7 DD      7451 PUSH	IX
0026F8 E5   
0026F9 CD      7452 CALL	EXPRI		;DIMENSION SIZE
0026FA B7   
0026FB 18   
0026FC CB      7453 BIT	7,H
0026FD 7C   
0026FE 20      7454 JR	NZ,BADDIM
0026FF 7D   
002700 D9      7455 EXX
002701 23      7456 INC	HL
002702 DD      7457 POP	IX
002703 E1   
002704 DD      7458 INC	IX
002705 23   
002706 DD      7459 LD	(IX),L		;SAVE SIZE
002707 75   
002708 00   
002709 DD      7460 INC	IX
00270A 23   
00270B DD      7461 LD	(IX),H
00270C 74   
00270D 00   
00270E C1      7462 POP	BC
00270F CD      7463 CALL	MUL16		;HL=HL*BC
002710 41   
002711 37   
002712 38      7464 JR	C,NOROOM	;TOO LARGE
002713 6C   
002714 EB      7465 EX	DE,HL		;DE=PRODUCT
002715 C1      7466 POP	BC
002716 04      7467 INC	B		;DIMENSION COUNTER
002717 FD      7468 LD	A,(IY)
002718 7E   
002719 00   
00271A FE      7469 CP	','		;ANOTHER
00271B 2C   
00271C 28      7470 JR	Z,DIM1
00271D D5   
00271E DD      7471 INC	IX
00271F 23   
002720 CD      7472 CALL	BRAKET		;CLOSING BRACKET
002721 32   
002722 21   
002723 F1      7473 POP	AF		;RESTORE TYPE
002724 CD      7474 CALL	X14OR5		;DE=DE*n
002725 31   
002726 37   
002727 38      7475 JR	C,NOROOM
002728 57   
002729 E1      7476 POP	HL
00272A 70      7477 LD	(HL),B		;NO. OF DIMENSIONS
00272B DD      7478 EX	(SP),IX
00272C E3   
00272D E1      7479 POP	HL
00272E E6      7480 AND	80H
00272F 80   
002730 DD      7481 OR	(IX)		;FLAGS
002731 B6   
002732 00   
002733 E5      7489 DIM3:           PUSH	HL
002734 24      7490 INC	H		;Safety margin
002735 19      7491 ADD	HL,DE
002736 38      7492 JR	C,NOROOM
002737 48   
002738 ED      7493 SBC	HL,SP
002739 72   
00273A 30      7494 JR	NC,NOROOM
00273B 44   
00273C E1      7495 POP	HL
00273D E5      7496 PUSH	HL
00273E ED      7497 LD	BC,(FREE)
00273F 4B   
002740 E0   
002741 55   
002742 B7      7498 OR	A
002743 ED      7499 SBC	HL,BC
002744 42   
002745 44      7500 LD	B,H
002746 4D      7501 LD	C,L
002747 E1      7502 POP	HL
002748 ED      7503 SBC	HL,BC
002749 42   
00274A CB      7504 BIT	0,A
00274B 47   
00274C 28      7505 JR	Z,ARRCHK	;NOT LOCAL
00274D 12   
00274E 21      7506 LD	HL,0
00274F 00   
002750 00   
002751 ED      7507 SBC	HL,DE
002752 52   
002753 B7      7508 OR	A
002754 ED      7509 SBC	HL,BC
002755 42   
002756 39      7510 ADD	HL,SP
002757 28      7511 JR	Z,ARRCHK	;RESERVE NOTHING
002758 07   
002759 F9      7512 LD	SP,HL
00275A D5      7513 PUSH	DE
00275B C5      7514 PUSH	BC
00275C F5      7515 PUSH	AF
00275D CD      7516 CALL	ARRCHK
00275E 60   
00275F 27   
002760 DD      7517 ARRCHK:         LD	(IX+0),L	;SAVE POINTER
002761 75   
002762 00   
002763 DD      7518 LD	(IX+1),H
002764 74   
002765 01   
002766 78      7519 LD	A,B
002767 B1      7520 OR	C
002768 28      7521 JR	Z,DIM2
002769 09   
00276A D5      7522 PUSH	DE
00276B EB      7523 EX	DE,HL
00276C 2A      7524 LD	HL,(FREE)
00276D E0   
00276E 55   
00276F ED      7525 LDIR			;COPY DESCRIPTOR
002770 B0   
002771 EB      7526 EX	DE,HL
002772 D1      7527 POP	DE
002773 7A      7528 DIM2:           LD	A,D
002774 B3      7529 OR	E
002775 28      7530 JR	Z,DIM5
002776 0E   
002777 36      7531 LD	(HL),0		;INITIALISE ARRAY
002778 00   
002779 23      7532 INC	HL
00277A 1B      7533 DEC	DE
00277B 18      7534 JR	DIM2
00277C F6   
00277D 3E      7536 BADDIM:         LD	A,10		;"Bad DIM"
00277E 0A   
00277F 21      7537 DB	21H
002780 3E      7538 NOROOM:         LD	A,11		;"DIM space"
002781 0B   
002782 C3      7539 ERROR1ex:         JP	ERROR_
002783 C8   
002784 3F   
002785 ED      7541 DIM5:           SBC	HL,SP
002786 72   
002787 30      7542 JR	NC,DIM7		;LOCAL
002788 04   
002789 39      7543 ADD	HL,SP
00278A 22      7544 LD	(FREE),HL
00278B E0   
00278C 55   
00278D CD      7545 DIM7:           CALL	NLIST		;ANOTHER VARIABLE?
00278E 84   
00278F 45   
002790 C3      7546 JP	DIM
002791 C2   
002792 26   
002793 FD      7548 DIM4:           POP	IY
002794 E1   
002795 CD      7549 CALL	VAR_
002796 5A   
002797 26   
002798 B7      7550 OR	A
002799 28      7551 JR	Z,BADDIM
00279A E2   
00279B FA      7552 JP	M,BADDIM
00279C 7D   
00279D 27   
00279E CB      7553 BIT	6,A
00279F 77   
0027A0 20      7554 JR	NZ,BADDIM
0027A1 DB   
0027A2 47      7555 LD	B,A		;TYPE
0027A3 CD      7556 CALL	NXT
0027A4 8F   
0027A5 45   
0027A6 FE      7557 CP	TLOCAL
0027A7 EA   
0027A8 3E      7558 LD	A,0		;PRESET TO NOT LOCAL
0027A9 00   
0027AA 20      7559 JR	NZ,DIM8
0027AB 03   
0027AC FD      7560 INC	IY
0027AD 23   
0027AE 3C      7561 INC	A		;FLAG LOCAL
0027AF F5      7562 DIM8:           PUSH	AF
0027B0 78      7563 LD	A,B		;TYPE
0027B1 D9      7564 EXX
0027B2 21      7565 LD	HL,0
0027B3 00   
0027B4 00   
0027B5 4C      7566 LD	C,H
0027B6 CD      7567 CALL	STOREN		;RESERVED AREA
0027B7 74   
0027B8 32   
0027B9 DD      7568 PUSH	IX
0027BA E5   
0027BB CD      7569 CALL	EXPRI
0027BC B7   
0027BD 18   
0027BE DD      7570 POP	IX
0027BF E1   
0027C0 D9      7571 EXX
0027C1 23      7572 INC	HL
0027C2 EB      7573 EX	DE,HL
0027C3 2A      7574 LD	HL,(FREE)
0027C4 E0   
0027C5 55   
0027C6 F1      7575 POP	AF		;LOCAL FLAG
0027C7 C3      7576 JP	DIM3
0027C8 33   
0027C9 27   
0027CA FE      7581 PRINT:          CP	'#'
0027CB 23   
0027CC 20      7582 JR	NZ,PRINT0
0027CD 64   
0027CE CD      7583 CALL	CHNL		;CHANNEL NO. = E
0027CF 5F   
0027D0 37   
0027D1 CD      7584 PRNTN1:         CALL	NLIST
0027D2 84   
0027D3 45   
0027D4 D5      7585 PUSH	DE
0027D5 CD      7586 CALL	EXPR		;ITEM TO PRINT
0027D6 86   
0027D7 17   
0027D8 08      7587 EX	AF,AF'
0027D9 FA      7588 JP	M,PRNTN2	;STRING
0027DA F9   
0027DB 27   
0027DC D1      7589 POP	DE
0027DD C5      7590 PUSH	BC
0027DE D9      7591 EXX
0027DF 7D      7592 LD	A,L
0027E0 D9      7593 EXX
0027E1 CD      7594 CALL	OSBPUT
0027E2 65   
0027E3 06   
0027E4 D9      7595 EXX
0027E5 7C      7596 LD	A,H
0027E6 D9      7597 EXX
0027E7 CD      7598 CALL	OSBPUT
0027E8 65   
0027E9 06   
0027EA 7D      7599 LD	A,L
0027EB CD      7600 CALL	OSBPUT
0027EC 65   
0027ED 06   
0027EE 7C      7601 LD	A,H
0027EF CD      7602 CALL	OSBPUT
0027F0 65   
0027F1 06   
0027F2 C1      7603 POP	BC
0027F3 79      7604 LD	A,C
0027F4 CD      7605 CALL	OSBPUT
0027F5 65   
0027F6 06   
0027F7 18      7606 JR	PRNTN1
0027F8 D8   
0027F9 4B      7607 PRNTN2:         LD	C,E
0027FA D1      7608 POP	DE
0027FB 21      7609 LD	HL,ACCS
0027FC 00   
0027FD 53   
0027FE 0C      7610 INC	C
0027FF 0D      7611 PRNTN3:         DEC	C
002800 28      7612 JR	Z,PRNTN4
002801 09   
002802 7E      7613 LD	A,(HL)
002803 23      7614 INC	HL
002804 C5      7615 PUSH	BC
002805 CD      7616 CALL	OSBPUT
002806 65   
002807 06   
002808 C1      7617 POP	BC
002809 18      7618 JR	PRNTN3
00280A F4   
00280B 3E      7619 PRNTN4:         LD	A,CR
00280C 0D   
00280D CD      7620 CALL	OSBPUT
00280E 65   
00280F 06   
002810 18      7621 JR	PRNTN1
002811 BF   
002812 06      7623 PRINT6:         LD	B,2
002813 02   
002814 18      7624 JR	PRINTC
002815 22   
002816 01      7625 PRINT8:         LD	BC,100H
002817 00   
002818 01   
002819 18      7626 JR	PRINTC
00281A 1D   
00281B 21      7627 PRINT9:         LD	HL,STAVAR
00281C 00   
00281D 55   
00281E AF      7628 XOR	A
00281F BE      7629 CP	(HL)
002820 28      7630 JR	Z,PRINT0
002821 10   
002822 3A      7631 LD	A,(COUNT)
002823 FB   
002824 55   
002825 B7      7632 OR	A
002826 28      7633 JR	Z,PRINT0
002827 0A   
002828 96      7634 PRINTA:         SUB	(HL)
002829 28      7635 JR	Z,PRINT0
00282A 07   
00282B 30      7636 JR	NC,PRINTA
00282C FB   
00282D ED      7637 NEG
00282E 44   
00282F CD      7638 CALL	SPACES
002830 27   
002831 36   
002832 3A      7639 PRINT0:         LD	A,(STAVAR)
002833 00   
002834 55   
002835 4F      7640 LD	C,A		;PRINTS
002836 06      7641 LD	B,0		;PRINTF
002837 00   
002838 CD      7642 PRINTC:         CALL	TERMQ
002839 BA   
00283A 35   
00283B 28      7643 JR	Z,PRINT4
00283C 38   
00283D CB      7644 RES	0,B
00283E 80   
00283F FD      7645 INC	IY
002840 23   
002841 FE      7646 CP	'~'
002842 7E   
002843 28      7647 JR	Z,PRINT6
002844 CD   
002845 FE      7648 CP	';'
002846 3B   
002847 28      7649 JR	Z,PRINT8
002848 CD   
002849 FE      7650 CP	','
00284A 2C   
00284B 28      7651 JR	Z,PRINT9
00284C CE   
00284D CD      7652 CALL	FORMAT		;SPC, TAB, '
00284E E0   
00284F 35   
002850 28      7653 JR	Z,PRINTC
002851 E6   
002852 FD      7654 DEC	IY
002853 2B   
002854 C5      7655 PUSH	BC
002855 CD      7656 CALL	EXPR		;VARIABLE TYPE
002856 86   
002857 17   
002858 08      7657 EX	AF,AF'
002859 FA      7658 JP	M,PRINT3	;STRING
00285A 6F   
00285B 28   
00285C D1      7659 POP	DE
00285D D5      7660 PUSH	DE
00285E CB      7661 BIT	1,D
00285F 4A   
002860 F5      7662 PUSH	AF
002861 CC      7663 CALL	Z,STR		;DECIMAL
002862 54   
002863 20   
002864 F1      7664 POP	AF
002865 C4      7665 CALL	NZ,HEXSTR	;HEX
002866 11   
002867 20   
002868 C1      7666 POP	BC
002869 C5      7667 PUSH	BC
00286A 79      7668 LD	A,C
00286B 93      7669 SUB	E
00286C D4      7670 CALL	NC,SPACES		;RIGHT JUSTIFY
00286D 27   
00286E 36   
00286F C1      7671 PRINT3:         POP	BC
002870 CD      7672 CALL	PTEXT		;PRINT
002871 35   
002872 36   
002873 18      7673 JR	PRINTC
002874 C3   
002875 CB      7674 PRINT4:         BIT	0,B
002876 40   
002877 CC      7675 CALL	Z,CRLF
002878 7F   
002879 41   
00287A 18      7676 JR	XEQGO3
00287B 3F   
00287C FD      7678 ONERR:          INC	IY		;SKIP "ERROR"
00287D 23   
00287E CD      7679 CALL	NXT
00287F 8F   
002880 45   
002881 21      7680 LD	HL,0		;FLAG NOT LOCAL
002882 00   
002883 00   
002884 FE      7681 CP	TLOCAL
002885 EA   
002886 20      7682 JR	NZ,ONERR1
002887 1D   
002888 FD      7683 INC	IY		;SKIP "LOCAL"
002889 23   
00288A 2A      7684 LD	HL,(ERRTRP)
00288B EA   
00288C 55   
00288D E5      7685 PUSH	HL
00288E 2A      7686 LD	HL,(ONERSP)
00288F EC   
002890 55   
002891 E5      7687 PUSH	HL
002892 21      7688 LD	HL,400H		;TYPE = 4, 'EXPONENT' = 0
002893 00   
002894 04   
002895 E5      7689 PUSH	HL
002896 21      7690 LD	HL,ERRTRP
002897 EA   
002898 55   
002899 E5      7691 PUSH	HL
00289A 21      7692 LD	HL,LOCCHK
00289B AE   
00289C 35   
00289D E5      7693 PUSH	HL
00289E 21      7694 LD	HL,0
00289F 00   
0028A0 00   
0028A1 39      7695 ADD	HL,SP
0028A2 CD      7696 CALL	NXT
0028A3 8F   
0028A4 45   
0028A5 22      7697 ONERR1:         LD	(ONERSP),HL
0028A6 EC   
0028A7 55   
0028A8 FD      7698 LD	(ERRTRP),IY
0028A9 22   
0028AA EA   
0028AB 55   
0028AC FE      7699 CP	TOFF
0028AD 87   
0028AE C2      7700 JP	NZ,REM
0028AF B5   
0028B0 25   
0028B1 FD      7701 INC	IY		;SKIP "OFF"
0028B2 23   
0028B3 ED      7702 SBC	HL,HL
0028B4 62   
0028B5 22      7703 LD	(ONERSP),HL
0028B6 EC   
0028B7 55   
0028B8 22      7704 LD	(ERRTRP),HL
0028B9 EA   
0028BA 55   
0028BB C3      7705 XEQGO3:         JP	XEQ
0028BC 1D   
0028BD 25   
0028BE CD      7715 ON:             CALL	TERMQ
0028BF BA   
0028C0 35   
0028C1 CA      7716 JP	Z,CSRON
0028C2 6E   
0028C3 0F   
0028C4 FE      7717 CP	TERROR
0028C5 85   
0028C6 28      7718 JR	Z,ONERR		;"ON ERROR"
0028C7 B4   
0028C8 CD      7719 CALL	EXPRI
0028C9 B7   
0028CA 18   
0028CB FD      7720 LD	A,(IY)
0028CC 7E   
0028CD 00   
0028CE FD      7721 INC	IY
0028CF 23   
0028D0 1E      7722 LD	E,','		;SEPARATOR
0028D1 2C   
0028D2 FE      7723 CP	TGOTO
0028D3 E5   
0028D4 28      7724 JR	Z,ON1
0028D5 0B   
0028D6 FE      7725 CP	TGOSUB
0028D7 E4   
0028D8 28      7726 JR	Z,ON1
0028D9 07   
0028DA 1E      7727 LD	E,TPROC
0028DB F2   
0028DC BB      7728 CP	E
0028DD 3E      7729 LD	A,39
0028DE 27   
0028DF 20      7730 JR	NZ,ERROR2ex	;"ON syntax"
0028E0 4F   
0028E1 57      7731 ON1:            LD	D,A
0028E2 D9      7732 EXX
0028E3 E5      7733 PUSH	HL
0028E4 D9      7734 EXX
0028E5 C1      7735 POP	BC		;ON INDEX
0028E6 78      7736 LD	A,B
0028E7 B4      7737 OR	H
0028E8 B5      7738 OR	L
0028E9 20      7739 JR	NZ,ON4		;OUT OF RANGE
0028EA 32   
0028EB B1      7740 OR	C
0028EC 28      7741 JR	Z,ON4
0028ED 2F   
0028EE 0D      7742 DEC	C
0028EF 28      7743 JR	Z,ON3		;INDEX=1
0028F0 11   
0028F1 CD      7744 ON2:            CALL	TERMQ
0028F2 BA   
0028F3 35   
0028F4 28      7745 JR	Z,ON4		;OUT OF RANGE
0028F5 27   
0028F6 FD      7746 INC	IY		;SKIP DELIMITER
0028F7 23   
0028F8 FE      7747 CP	'"'
0028F9 22   
0028FA 28      7748 JR	Z,ON5
0028FB 1A   
0028FC BB      7749 CP	E
0028FD 20      7750 JR	NZ,ON2
0028FE F2   
0028FF 0D      7751 DEC	C
002900 20      7752 JR	NZ,ON2
002901 EF   
002902 7B      7753 ON3:            LD	A,E
002903 FE      7754 CP	TPROC
002904 F2   
002905 28      7755 JR	Z,ONPROC
002906 2C   
002907 D5      7756 PUSH	DE
002908 CD      7757 CALL	ITEMI		;LINE NUMBER
002909 E4   
00290A 18   
00290B D1      7758 POP	DE
00290C 7A      7759 LD	A,D
00290D FE      7760 CP	TGOTO
00290E E5   
00290F 28      7761 JR	Z,GOTO2
002910 30   
002911 CD      7762 CALL	SPAN		;SKIP REST OF LIST
002912 C6   
002913 35   
002914 18      7763 JR	GOSUB1
002915 3C   
002916 CD      7765 ON5:            CALL	QUOTE
002917 1D   
002918 37   
002919 FD      7766 INC	IY
00291A 23   
00291B 18      7767 JR	ON2
00291C D4   
00291D FD      7769 ON4:            LD	A,(IY)
00291E 7E   
00291F 00   
002920 FD      7770 INC	IY
002921 23   
002922 FE      7771 CP	TELSE
002923 8B   
002924 CA      7772 JP	Z,IF1		;ELSE CLAUSE
002925 66   
002926 2D   
002927 FE      7773 CP	CR
002928 0D   
002929 20      7774 JR	NZ,ON4
00292A F2   
00292B 3E      7775 LD	A,40		;'ON range'
00292C 28   
00292D 21      7776 DB	21H
00292E 3E      7777 FORVAR:         LD	A,34		;'FOR variable'
00292F 22   
002930 C3      7778 ERROR2ex:         JP	ERROR_
002931 C8   
002932 3F   
002933 3E      7780 ONPROC:         LD	A,TON
002934 EE   
002935 C3      7781 JP	PROC
002936 6B   
002937 2A   
002938 CD      7785 GOTO:           CALL	ITEMI		;LINE NUMBER
002939 E4   
00293A 18   
00293B CD      7786 GOTO1:          CALL	TERMQ
00293C BA   
00293D 35   
00293E C2      7787 JP	NZ,SYNTAX
00293F 64   
002940 26   
002941 D9      7788 GOTO2:          EXX
002942 CD      7789 CALL	FINDL
002943 C7   
002944 41   
002945 E5      7790 PUSH	HL
002946 FD      7791 POP	IY
002947 E1   
002948 CA      7792 JP	Z,XEQ0
002949 08   
00294A 25   
00294B 3E      7793 LD	A,41
00294C 29   
00294D 18      7794 JR	ERROR2ex		;"No such line"
00294E E1   
00294F CD      7798 GOSUB:          CALL	ITEMI		;LINE NUMBER
002950 E4   
002951 18   
002952 FD      7799 GOSUB1:         PUSH	IY		;TEXT POINTER
002953 E5   
002954 CD      7800 CALL	CHECK		;CHECK ROOM
002955 0A   
002956 33   
002957 CD      7801 CALL	GOTO1		;SAVE MARKER
002958 3B   
002959 29   
00295A D1      7806 RETURN:         POP	DE		;MARKER
00295B 21      7807 LD	HL,GOSCHK
00295C 5A   
00295D 29   
00295E B7      7808 OR	A
00295F ED      7809 SBC	HL,DE
002960 52   
002961 FD      7810 POP	IY
002962 E1   
002963 28      7811 JR	Z,XEQGO2ex
002964 30   
002965 3E      7812 LD	A,38
002966 26   
002967 18      7813 JR	ERROR2ex		;"No GOSUB"
002968 C7   
002969 FD      7817 REPEAT:         PUSH	IY
00296A E5   
00296B CD      7818 CALL	CHECK
00296C 0A   
00296D 33   
00296E CD      7819 CALL	XEQ
00296F 1D   
002970 25   
002971 C1      7824 UNTIL:          POP	BC
002972 C5      7825 PUSH	BC
002973 21      7826 LD	HL,REPCHK
002974 71   
002975 29   
002976 B7      7827 OR	A
002977 ED      7828 SBC	HL,BC
002978 42   
002979 28      7829 JR	Z,UNTIL1
00297A 0B   
00297B 3E      7830 LD	A,3
00297C 03   
00297D CD      7831 CALL	RESLOC
00297E B5   
00297F 34   
002980 20      7832 JR	NZ,UNTIL
002981 EF   
002982 3E      7833 LD	A,43
002983 2B   
002984 18      7834 JR	ERROR2ex		;"Not in a REPEAT loop"
002985 AA   
002986 CD      7836 UNTIL1:         CALL	EXPRI
002987 B7   
002988 18   
002989 CD      7837 CALL	TEST
00298A DD   
00298B 1F   
00298C C1      7838 POP	BC
00298D D1      7839 POP	DE
00298E 20      7840 JR	NZ,XEQGO2ex		;TRUE
00298F 05   
002990 D5      7841 PUSH	DE
002991 C5      7842 PUSH	BC
002992 D5      7843 PUSH	DE
002993 FD      7844 POP	IY
002994 E1   
002995 C3      7845 XEQGO2ex:         JP	XEQ
002996 1D   
002997 25   
002998 CD      7849 FORex:            CALL	ASSIGN
002999 33   
00299A 32   
00299B 20      7850 JR	NZ,FORVAR	;"FOR variable"
00299C 91   
00299D F5      7851 PUSH	AF		;SAVE TYPE
00299E FD      7852 LD	A,(IY)
00299F 7E   
0029A0 00   
0029A1 FE      7853 CP	TTO
0029A2 B8   
0029A3 3E      7854 LD	A,36
0029A4 24   
0029A5 20      7855 JR	NZ,ERROR2ex	;"No TO"
0029A6 89   
0029A7 FD      7856 INC	IY
0029A8 23   
0029A9 DD      7857 PUSH	IX
0029AA E5   
0029AB CD      7858 CALL	EXPRN		;LIMIT
0029AC B0   
0029AD 18   
0029AE DD      7859 POP	IX
0029AF E1   
0029B0 F1      7860 POP	AF
0029B1 47      7861 LD	B,A		;TYPE
0029B2 C5      7862 PUSH	BC		;SAVE ON STACK
0029B3 E5      7863 PUSH	HL
0029B4 21      7864 LD	HL,0
0029B5 00   
0029B6 00   
0029B7 4C      7865 LD	C,H
0029B8 D9      7866 EXX
0029B9 E5      7867 PUSH	HL
0029BA 21      7868 LD	HL,1		;PRESET STEP
0029BB 01   
0029BC 00   
0029BD D9      7869 EXX
0029BE FD      7870 LD	A,(IY)
0029BF 7E   
0029C0 00   
0029C1 FE      7871 CP	TSTEP
0029C2 88   
0029C3 20      7872 JR	NZ,FOR1
0029C4 09   
0029C5 FD      7873 INC	IY
0029C6 23   
0029C7 DD      7874 PUSH	IX
0029C8 E5   
0029C9 CD      7875 CALL	EXPRN		;STEP
0029CA B0   
0029CB 18   
0029CC DD      7876 POP	IX
0029CD E1   
0029CE 06      7877 FOR1:           LD	B,8		;FPP '>'
0029CF 08   
0029D0 CB      7878 BIT	7,H
0029D1 7C   
0029D2 20      7879 JR	NZ,FOR2		;STEP SIGN
0029D3 02   
0029D4 06      7880 LD	B,12		;FPP '<'
0029D5 0C   
0029D6 C5      7881 FOR2:           PUSH	BC
0029D7 E5      7882 PUSH	HL
0029D8 D9      7883 EXX
0029D9 E5      7884 PUSH	HL
0029DA D9      7885 EXX
0029DB FD      7886 PUSH	IY		;SAVE TEXT POINTER
0029DC E5   
0029DD DD      7887 PUSH	IX		;LOOP VARIABLE
0029DE E5   
0029DF CD      7888 CALL	CHECK
0029E0 0A   
0029E1 33   
0029E2 CD      7889 CALL	XEQ
0029E3 1D   
0029E4 25   
0029E5 C1      7894 NEXT:           POP	BC		;MARKER
0029E6 21      7895 LD	HL,FORCHK
0029E7 E5   
0029E8 29   
0029E9 B7      7896 OR	A
0029EA ED      7897 SBC	HL,BC
0029EB 42   
0029EC 28      7898 JR	Z,NEXT2
0029ED 0C   
0029EE C5      7899 PUSH	BC
0029EF 3E      7900 LD	A,3
0029F0 03   
0029F1 CD      7901 CALL	RESLOC
0029F2 B5   
0029F3 34   
0029F4 20      7902 JR	NZ,NEXT
0029F5 EF   
0029F6 3E      7903 LD	A,32
0029F7 20   
0029F8 18      7904 JR	ERROR3ex		;"Not in a FOR loop"
0029F9 6A   
0029FA CD      7906 NEXT2:          CALL	TERMQ
0029FB BA   
0029FC 35   
0029FD E1      7907 POP	HL
0029FE E5      7908 PUSH	HL
0029FF C5      7909 PUSH	BC
002A00 E5      7910 PUSH	HL
002A01 C4      7911 CALL	NZ,GETVAR	;VARIABLE
002A02 67   
002A03 42   
002A04 D1      7912 POP	DE
002A05 EB      7913 EX	DE,HL
002A06 B7      7914 OR	A
002A07 ED      7915 NEXT0:          SBC	HL,DE
002A08 52   
002A09 20      7916 JR	NZ,NEXT1
002A0A 47   
002A0B D5      7917 PUSH	DE
002A0C DD      7918 LD	IX,6+2
002A0D 21   
002A0E 08   
002A0F 00   
002A10 DD      7919 ADD	IX,SP
002A11 39   
002A12 CD      7920 CALL	DLOAD5		;STEP
002A13 75   
002A14 1A   
002A15 DD      7921 LD	A,(IX+11)	;TYPE
002A16 7E   
002A17 0B   
002A18 DD      7922 POP	IX
002A19 E1   
002A1A CD      7923 CALL	LOADN		;LOOP VARIABLE
002A1B A9   
002A1C 19   
002A1D F5      7924 PUSH	AF
002A1E 3E      7925 LD	A,'+' & 0FH
002A1F 0B   
002A20 CD      7926 CALL	FPP		;ADD STEP
002A21 99   
002A22 45   
002A23 38      7927 JR	C,ERROR3ex
002A24 3F   
002A25 F1      7928 POP	AF		;RESTORE TYPE
002A26 CD      7929 CALL	STOREN		;UPDATE VARIABLE
002A27 74   
002A28 32   
002A29 DD      7930 LD	IX,12
002A2A 21   
002A2B 0C   
002A2C 00   
002A2D DD      7931 ADD	IX,SP
002A2E 39   
002A2F CD      7932 CALL	DLOAD5		;LIMIT
002A30 75   
002A31 1A   
002A32 DD      7933 LD	A,(IX-1)
002A33 7E   
002A34 FF   
002A35 CD      7934 CALL	FPP		;TEST AGAINST LIMIT
002A36 99   
002A37 45   
002A38 38      7935 JR	C,ERROR3ex
002A39 2A   
002A3A 24      7936 INC	H
002A3B 20      7937 JR	NZ,LOOP		;KEEP LOOPING
002A3C 0A   
002A3D 21      7938 LD	HL,18
002A3E 12   
002A3F 00   
002A40 39      7939 ADD	HL,SP
002A41 F9      7940 LD	SP,HL
002A42 CD      7941 CALL	NLIST
002A43 84   
002A44 45   
002A45 18      7942 JR	NEXT
002A46 9E   
002A47 C1      7944 LOOP:           POP	BC
002A48 D1      7945 POP	DE
002A49 FD      7946 POP	IY
002A4A E1   
002A4B FD      7947 PUSH	IY
002A4C E5   
002A4D D5      7948 PUSH	DE
002A4E C5      7949 PUSH	BC
002A4F C3      7950 JP	XEQ
002A50 1D   
002A51 25   
002A52 21      7952 NEXT1:          LD	HL,18
002A53 12   
002A54 00   
002A55 39      7953 ADD	HL,SP
002A56 F9      7954 LD	SP,HL		;"POP" THE STACK
002A57 C1      7955 POP	BC
002A58 21      7956 LD	HL,FORCHK
002A59 E5   
002A5A 29   
002A5B ED      7957 SBC	HL,BC
002A5C 42   
002A5D E1      7958 POP	HL		;VARIABLE POINTER
002A5E E5      7959 PUSH	HL
002A5F C5      7960 PUSH	BC
002A60 28      7961 JR	Z,NEXT0
002A61 A5   
002A62 3E      7962 LD	A,33
002A63 21   
002A64 C3      7963 ERROR3ex:         JP	ERROR_		;"Can't match FOR"
002A65 C8   
002A66 3F   
002A67 F5      7968 FN:             PUSH	AF		;MAKE SPACE ON STACK
002A68 CD      7969 CALL	PROC1
002A69 6F   
002A6A 2A   
002A6B F5      7975 PROC:           PUSH	AF		;MAKE SPACE ON STACK
002A6C CD      7976 CALL	PROC1
002A6D 6F   
002A6E 2A   
002A6F CD      7978 PROC1:          CALL	CHECK
002A70 0A   
002A71 33   
002A72 FD      7979 DEC	IY
002A73 2B   
002A74 FD      7980 PUSH	IY
002A75 E5   
002A76 CD      7981 CALL	GETDEF
002A77 1A   
002A78 43   
002A79 C1      7982 POP	BC
002A7A 28      7983 JR	Z,PROC4
002A7B 39   
002A7C 3E      7984 LD	A,30
002A7D 1E   
002A7E 38      7985 JR	C,ERROR3ex	;"Bad call"
002A7F E4   
002A80 C5      7986 PUSH	BC
002A81 2A      7987 LD	HL,(PAGE_)
002A82 DC   
002A83 55   
002A84 3E      7988 PROC2:          LD	A,TDEF
002A85 DD   
002A86 CD      7989 CALL	SEARCHex		;LOOK FOR "DEF"
002A87 7F   
002A88 36   
002A89 38      7990 JR	C,PROC3
002A8A 21   
002A8B E5      7991 PUSH	HL
002A8C FD      7992 POP	IY
002A8D E1   
002A8E FD      7993 INC	IY		;SKIP DEF
002A8F 23   
002A90 CD      7994 CALL	NXT
002A91 8F   
002A92 45   
002A93 CD      7995 CALL	GETDEF
002A94 1A   
002A95 43   
002A96 FD      7996 PUSH	IY
002A97 E5   
002A98 D1      7997 POP	DE
002A99 38      7998 JR	C,PROC6
002A9A 09   
002A9B C4      7999 CALL	NZ,CREATE
002A9C C0   
002A9D 43   
002A9E FD      8000 PUSH	IY
002A9F E5   
002AA0 D1      8001 POP	DE
002AA1 73      8002 LD	(HL),E
002AA2 23      8003 INC	HL
002AA3 72      8004 LD	(HL),D		;SAVE ADDRESS
002AA4 EB      8005 PROC6:          EX	DE,HL
002AA5 3E      8006 LD	A,CR
002AA6 0D   
002AA7 47      8007 LD	B,A
002AA8 ED      8008 CPIR			;SKIP TO END OF LINE
002AA9 B1   
002AAA 18      8009 JR	PROC2
002AAB D8   
002AAC FD      8010 PROC3:          POP	IY		;RESTORE TEXT POINTER
002AAD E1   
002AAE CD      8011 CALL	GETDEF
002AAF 1A   
002AB0 43   
002AB1 3E      8012 LD	A,29
002AB2 1D   
002AB3 20      8013 JR	NZ,ERROR3ex	;"No such FN/PROC"
002AB4 AF   
002AB5 5E      8014 PROC4:          LD	E,(HL)
002AB6 23      8015 INC	HL
002AB7 56      8016 LD	D,(HL)		;GET ADDRESS
002AB8 21      8017 LD	HL,2
002AB9 02   
002ABA 00   
002ABB 39      8018 ADD	HL,SP
002ABC CD      8019 CALL	NXT		;ALLOW SPACE BEFORE (
002ABD 8F   
002ABE 45   
002ABF D5      8020 PUSH	DE		;EXCHANGE DE,IY
002AC0 FD      8021 EX	(SP),IY
002AC1 E3   
002AC2 D1      8022 POP	DE
002AC3 FE      8023 CP	'('		;ARGUMENTS?
002AC4 28   
002AC5 C2      8024 JP	NZ,PROC5
002AC6 69   
002AC7 2B   
002AC8 CD      8025 CALL	NXT		;ALLOW SPACE BEFORE (
002AC9 8F   
002ACA 45   
002ACB FE      8026 CP	'('
002ACC 28   
002ACD C2      8027 JP	NZ,SYNTAX	;"Syntax error"
002ACE 64   
002ACF 26   
002AD0 FD      8028 PUSH	IY
002AD1 E5   
002AD2 C1      8029 POP	BC		;SAVE IY IN BC
002AD3 D9      8030 EXX
002AD4 08      8031 EX	AF,AF'
002AD5 AF      8032 XOR	A		;INITIALISE RETURN COUNT
002AD6 08      8033 EX	AF,AF'
002AD7 CD      8034 CALL	SAVLOC		;SAVE DUMMY VARIABLES
002AD8 42   
002AD9 35   
002ADA 08      8035 EX	AF,AF'
002ADB B7      8036 OR	A
002ADC 28      8037 JR	Z,RETCHK	;NO RETURNS
002ADD 16   
002ADE E5      8038 PUSH	HL
002ADF ED      8039 NEG
002AE0 44   
002AE1 6F      8040 LD	L,A
002AE2 ED      8041 NEG
002AE3 44   
002AE4 26      8042 LD	H,-1		;HL = -RETURNS
002AE5 FF   
002AE6 29      8043 ADD	HL,HL
002AE7 29      8044 ADD	HL,HL
002AE8 29      8045 ADD	HL,HL		;-RETURNS * 8
002AE9 E3      8046 EX	(SP),HL
002AEA DD      8047 POP	IX
002AEB E1   
002AEC DD      8048 ADD	IX,SP
002AED 39   
002AEE DD      8049 LD	SP,IX
002AEF F9   
002AF0 F5      8050 PUSH	AF		;PUSH RETURN COUNT
002AF1 CD      8051 CALL	RETCHK		;PUSH MARKER
002AF2 F4   
002AF3 2A   
002AF4 08      8052 RETCHK:         EX	AF,AF'
002AF5 CD      8053 CALL	BRAKET		;CLOSING BRACKET
002AF6 32   
002AF7 21   
002AF8 D9      8054 EXX
002AF9 C5      8055 PUSH	BC
002AFA FD      8056 POP	IY		;RESTORE IY
002AFB E1   
002AFC E5      8057 PUSH	HL
002AFD CD      8058 CALL	ARGUE		;TRANSFER ARGUMENTS
002AFE 51   
002AFF 33   
002B00 E1      8059 POP	HL
002B01 E3      8067 EX	(SP),HL
002B02 B7      8068 OR	A
002B03 01      8069 LD	BC,RETCHK
002B04 F4   
002B05 2A   
002B06 ED      8070 SBC	HL,BC
002B07 42   
002B08 09      8071 ADD	HL,BC
002B09 E3      8072 EX	(SP),HL
002B0A 20      8073 JR	NZ,PROC5	;No RETURNs
002B0B 5D   
002B0C D5      8075 PUSH	DE
002B0D E5      8076 PUSH	HL
002B0E 21      8077 LD	HL,7		;Skip two PUSHes and RETCHK
002B0F 07   
002B10 00   
002B11 39      8078 ADD	HL,SP
002B12 7E      8079 LD	A,(HL)		;RETURN count
002B13 23      8080 INC	HL
002B14 E5      8081 PUSH	HL
002B15 DD      8082 POP	IX		;Address RETURNs table
002B16 E1   
002B17 5F      8083 PROC0:          LD	E,A
002B18 16      8084 LD	D,0
002B19 00   
002B1A EB      8085 EX	DE,HL
002B1B 29      8086 ADD	HL,HL
002B1C 29      8087 ADD	HL,HL
002B1D 29      8088 ADD	HL,HL
002B1E 19      8089 ADD	HL,DE		;HL addresses SAVLOC stack
002B1F 23      8090 INC	HL
002B20 23      8091 INC	HL		;Bump past LOCCHK
002B21 5E      8092 PROC7:          LD	E,(HL)
002B22 23      8093 INC	HL
002B23 56      8094 LD	D,(HL)		;DE = SAVLOC VARPTR
002B24 23      8095 INC	HL
002B25 4E      8096 LD	C,(HL)		;Length (if string)
002B26 23      8097 INC	HL
002B27 46      8098 LD	B,(HL)		;Variable type
002B28 C5      8102 PUSH	BC		;Save type
002B29 E5      8103 PUSH	HL
002B2A DD      8104 PUSH	IX
002B2B E5   
002B2C 47      8105 LD	B,A		;B = RETURN count
002B2D DD      8106 PROC8:          LD	L,(IX+4)
002B2E 6E   
002B2F 04   
002B30 DD      8107 LD	H,(IX+5)	;HL = RETURNed VARPTR
002B31 66   
002B32 05   
002B33 B7      8108 OR	A
002B34 ED      8109 SBC	HL,DE
002B35 52   
002B36 28      8110 JR	Z,PROC9
002B37 09   
002B38 EB      8111 EX	DE,HL
002B39 11      8112 LD	DE,8
002B3A 08   
002B3B 00   
002B3C DD      8113 ADD	IX,DE
002B3D 19   
002B3E EB      8114 EX	DE,HL
002B3F 10      8115 DJNZ	PROC8
002B40 EC   
002B41 DD      8116 PROC9:          POP	IX
002B42 E1   
002B43 E1      8117 POP	HL
002B44 C1      8118 POP	BC		;Restore type
002B45 20      8122 JR	NZ,PROCA
002B46 02   
002B47 CB      8123 SET	4,(HL)		;Flag don't restore
002B48 E6   
002B49 11      8127 PROCA:          LD	DE,3
002B4A 03   
002B4B 00   
002B4C CB      8128 BIT	6,B
002B4D 70   
002B4E 20      8129 JR	NZ,PROCB	;Whole array
002B4F 08   
002B50 1E      8130 LD	E,5
002B51 05   
002B52 CB      8131 BIT	7,B
002B53 78   
002B54 28      8132 JR	Z,PROCB		;Numeric
002B55 02   
002B56 59      8133 LD	E,C
002B57 13      8134 INC	DE
002B58 19      8135 PROCB:          ADD	HL,DE
002B59 4E      8136 LD	C,(HL)
002B5A 23      8137 INC	HL
002B5B 46      8138 LD	B,(HL)
002B5C 23      8139 INC	HL		; BC = marker ?
002B5D EB      8140 EX	DE,HL
002B5E 21      8141 LD	HL,LOCCHK
002B5F AE   
002B60 35   
002B61 B7      8142 OR	A
002B62 ED      8143 SBC	HL,BC
002B63 42   
002B64 EB      8144 EX	DE,HL
002B65 28      8145 JR	Z,PROC7		;Another
002B66 BA   
002B67 E1      8146 POP	HL
002B68 D1      8147 POP	DE
002B69 73      8149 PROC5:          LD	(HL),E		;SAVE "RETURN ADDRESS"
002B6A 23      8150 INC	HL
002B6B 7E      8151 LD	A,(HL)
002B6C 72      8152 LD	(HL),D
002B6D FE      8153 CP	TON		;WAS IT "ON PROC" ?
002B6E EE   
002B6F 20      8154 JR	NZ,XEQGO
002B70 0C   
002B71 D5      8155 PUSH	DE
002B72 FD      8156 EX	(SP),IY
002B73 E3   
002B74 CD      8157 CALL	SPAN		;SKIP REST OF ON LIST
002B75 C6   
002B76 35   
002B77 FD      8158 EX	(SP),IY
002B78 E3   
002B79 D1      8159 POP	DE
002B7A 72      8160 LD	(HL),D
002B7B 2B      8161 DEC	HL
002B7C 73      8162 LD	(HL),E
002B7D C3      8163 XEQGO:          JP	XEQ
002B7E 1D   
002B7F 25   
002B80 FD      8165 LOCERR:         INC	IY
002B81 23   
002B82 18      8166 JR	XEQGO
002B83 F9   
002B84 FD      8170 LOCDAT:         INC	IY
002B85 23   
002B86 2A      8171 LD	HL,(DATPTR)
002B87 F0   
002B88 55   
002B89 E5      8172 PUSH	HL
002B8A 3E      8173 LD	A,40H
002B8B 40   
002B8C F5      8174 PUSH	AF
002B8D 21      8175 LD	HL,DATPTR
002B8E F0   
002B8F 55   
002B90 E5      8176 PUSH	HL
002B91 21      8177 LD	HL,LOCCHK
002B92 AE   
002B93 35   
002B94 E5      8178 PUSH	HL
002B95 18      8179 JR	XEQGO
002B96 E6   
002B97 FE      8183 LOCAL:          CP	TERROR
002B98 85   
002B99 28      8184 JR	Z,LOCERR
002B9A E5   
002B9B FE      8185 CP	TDATA
002B9C DC   
002B9D 28      8186 JR	Z,LOCDAT
002B9E E5   
002B9F C1      8187 POP	BC
002BA0 C5      8188 PUSH	BC
002BA1 21      8189 LD	HL,FNCHK
002BA2 6B   
002BA3 2A   
002BA4 B7      8190 OR	A
002BA5 ED      8191 SBC	HL,BC
002BA6 42   
002BA7 28      8192 JR	Z,LOCAL1
002BA8 23   
002BA9 21      8193 LD	HL,PROCHK
002BAA 6F   
002BAB 2A   
002BAC B7      8194 OR	A
002BAD ED      8195 SBC	HL,BC
002BAE 42   
002BAF 28      8196 JR	Z,LOCAL1
002BB0 1B   
002BB1 21      8197 LD	HL,LOCCHK
002BB2 AE   
002BB3 35   
002BB4 B7      8198 OR	A
002BB5 ED      8199 SBC	HL,BC
002BB6 42   
002BB7 28      8200 JR	Z,LOCAL1
002BB8 13   
002BB9 21      8201 LD	HL,ARRCHK
002BBA 60   
002BBB 27   
002BBC B7      8202 OR	A
002BBD ED      8203 SBC	HL,BC
002BBE 42   
002BBF 28      8204 JR	Z,LOCAL1
002BC0 0B   
002BC1 21      8205 LD	HL,RETCHK
002BC2 F4   
002BC3 2A   
002BC4 B7      8206 OR	A
002BC5 ED      8207 SBC	HL,BC
002BC6 42   
002BC7 3E      8208 LD	A,12
002BC8 0C   
002BC9 C2      8209 JP	NZ,ERROR_	;"Not LOCAL"
002BCA C8   
002BCB 3F   
002BCC FD      8210 LOCAL1:         PUSH	IY
002BCD E5   
002BCE C1      8211 POP	BC
002BCF D9      8212 EXX
002BD0 FD      8213 DEC	IY
002BD1 2B   
002BD2 CD      8214 CALL	SAVLOC
002BD3 42   
002BD4 35   
002BD5 D9      8215 EXX
002BD6 C5      8216 PUSH	BC
002BD7 FD      8217 POP	IY
002BD8 E1   
002BD9 CD      8218 LOCAL2:         CALL	GETVAR
002BDA 67   
002BDB 42   
002BDC C2      8219 JP	NZ,SYNTAX
002BDD 64   
002BDE 26   
002BDF CB      8220 BIT	6,A		;ARRAY?
002BE0 77   
002BE1 20      8221 JR	NZ,LOCAL4
002BE2 14   
002BE3 B7      8222 OR	A		;TYPE
002BE4 08      8223 EX	AF,AF'
002BE5 CD      8224 CALL	ZERO
002BE6 7C   
002BE7 20   
002BE8 08      8225 EX	AF,AF'
002BE9 F5      8226 PUSH	AF
002BEA F4      8227 CALL	P,STOREN	;ZERO
002BEB 74   
002BEC 32   
002BED F1      8228 POP	AF
002BEE 59      8229 LD	E,C
002BEF FC      8230 CALL	M,STORES
002BF0 C5   
002BF1 32   
002BF2 CD      8231 LOCAL3:         CALL	NLIST
002BF3 84   
002BF4 45   
002BF5 18      8232 JR	LOCAL2
002BF6 E2   
002BF7 DD      8234 LOCAL4:         LD	(IX+0),1	;FLAG LOCAL ARRAY
002BF8 36   
002BF9 00   
002BFA 01   
002BFB DD      8235 LD	(IX+1),0
002BFC 36   
002BFD 01   
002BFE 00   
002BFF 18      8236 JR	LOCAL3
002C00 F1   
002C01 C1      8240 ENDPRO:         POP	BC
002C02 21      8241 LD	HL,PROCHK	;PROC MARKER
002C03 6F   
002C04 2A   
002C05 AF      8242 XOR	A
002C06 ED      8243 SBC	HL,BC
002C07 42   
002C08 28      8244 JR	Z,ENDPR1
002C09 0B   
002C0A C5      8245 PUSH	BC		;PUT BACK
002C0B CD      8246 CALL	RESLOC
002C0C B5   
002C0D 34   
002C0E 20      8247 JR	NZ,ENDPRO
002C0F F1   
002C10 3E      8248 LD	A,13
002C11 0D   
002C12 C3      8249 JP	ERROR_		;"No PROC"
002C13 C8   
002C14 3F   
002C15 FD      8251 ENDPR1:         POP	IY
002C16 E1   
002C17 C3      8252 XEQGO6:         JP	XEQ
002C18 1D   
002C19 25   
002C1A CD      8256 INPUTN:         CALL	CHNL		;E = CHANNEL NUMBER
002C1B 5F   
002C1C 37   
002C1D CD      8257 INPN1:          CALL	NLIST
002C1E 84   
002C1F 45   
002C20 D5      8258 PUSH	DE
002C21 CD      8259 CALL	VAR_
002C22 5A   
002C23 26   
002C24 D1      8260 POP	DE
002C25 F5      8261 PUSH	AF		;SAVE TYPE
002C26 E5      8262 PUSH	HL		;VARPTR
002C27 B7      8263 OR	A
002C28 FA      8264 JP	M,INPN2		;STRING
002C29 4D   
002C2A 2C   
002C2B CD      8265 CALL	OSBGET
002C2C 5D   
002C2D 06   
002C2E D9      8266 EXX
002C2F 6F      8267 LD	L,A
002C30 D9      8268 EXX
002C31 CD      8269 CALL	OSBGET
002C32 5D   
002C33 06   
002C34 D9      8270 EXX
002C35 67      8271 LD	H,A
002C36 D9      8272 EXX
002C37 CD      8273 CALL	OSBGET
002C38 5D   
002C39 06   
002C3A 6F      8274 LD	L,A
002C3B CD      8275 CALL	OSBGET
002C3C 5D   
002C3D 06   
002C3E 67      8276 LD	H,A
002C3F CD      8277 CALL	OSBGET
002C40 5D   
002C41 06   
002C42 4F      8278 LD	C,A
002C43 DD      8279 POP	IX
002C44 E1   
002C45 F1      8280 POP	AF		;RESTORE TYPE
002C46 D5      8281 PUSH	DE		;SAVE CHANNEL
002C47 CD      8282 CALL	STOREN
002C48 74   
002C49 32   
002C4A D1      8283 POP	DE
002C4B 18      8284 JR	INPN1
002C4C D0   
002C4D 21      8285 INPN2:          LD	HL,ACCS
002C4E 00   
002C4F 53   
002C50 CD      8286 INPN3:          CALL	OSBGET
002C51 5D   
002C52 06   
002C53 FE      8287 CP	CR
002C54 0D   
002C55 28      8288 JR	Z,INPN4
002C56 04   
002C57 77      8289 LD	(HL),A
002C58 2C      8290 INC	L
002C59 20      8291 JR	NZ,INPN3
002C5A F5   
002C5B DD      8292 INPN4:          POP	IX
002C5C E1   
002C5D F1      8293 POP	AF
002C5E D5      8294 PUSH	DE
002C5F EB      8295 EX	DE,HL
002C60 CD      8296 CALL	STACCS
002C61 C2   
002C62 32   
002C63 D1      8297 POP	DE
002C64 18      8298 JR	INPN1
002C65 B7   
002C66 FE      8303 INPUT:          CP	'#'
002C67 23   
002C68 28      8304 JR	Z,INPUTN
002C69 B0   
002C6A 0E      8305 LD	C,0		;FLAG PROMPT
002C6B 00   
002C6C FE      8306 CP	TLINE
002C6D 86   
002C6E 20      8307 JR	NZ,INPUT0
002C6F 04   
002C70 FD      8308 INC	IY		;SKIP "LINE"
002C71 23   
002C72 0E      8309 LD	C,80H
002C73 80   
002C74 21      8310 INPUT0:         LD	HL,BUFFER
002C75 00   
002C76 54   
002C77 36      8311 LD	(HL),CR		;INITIALISE EMPTY
002C78 0D   
002C79 CD      8312 INPUT1:         CALL	TERMQ
002C7A BA   
002C7B 35   
002C7C 28      8313 JR	Z,XEQGO6	;DONE
002C7D 99   
002C7E FD      8314 INC	IY
002C7F 23   
002C80 FE      8315 CP	','
002C81 2C   
002C82 28      8316 JR	Z,INPUT3	;SKIP COMMA
002C83 51   
002C84 FE      8317 CP	';'
002C85 3B   
002C86 28      8318 JR	Z,INPUT3
002C87 4D   
002C88 E5      8319 PUSH	HL		;SAVE BUFFER POINTER
002C89 FE      8320 CP	'"'
002C8A 22   
002C8B 20      8321 JR	NZ,INPUT6
002C8C 0A   
002C8D C5      8322 PUSH	BC
002C8E CD      8323 CALL	CONS
002C8F FE   
002C90 19   
002C91 C1      8324 POP	BC
002C92 CD      8325 CALL	PTEXT		;PRINT PROMPT
002C93 35   
002C94 36   
002C95 18      8326 JR	INPUT9
002C96 05   
002C97 CD      8327 INPUT6:         CALL	FORMAT		;SPC, TAB, '
002C98 E0   
002C99 35   
002C9A 20      8328 JR	NZ,INPUT2
002C9B 05   
002C9C E1      8329 INPUT9:         POP	HL
002C9D CB      8330 SET	0,C		;FLAG NO PROMPT
002C9E C1   
002C9F 18      8331 JR	INPUT0
002CA0 D3   
002CA1 FD      8332 INPUT2:         DEC	IY
002CA2 2B   
002CA3 C5      8333 PUSH	BC
002CA4 CD      8334 CALL	VAR_
002CA5 5A   
002CA6 26   
002CA7 C1      8335 POP	BC
002CA8 E1      8336 POP	HL
002CA9 F5      8337 PUSH	AF		;SAVE TYPE
002CAA 7E      8338 LD	A,(HL)
002CAB 23      8339 INC	HL
002CAC FE      8340 CP	CR		;BUFFER EMPTY?
002CAD 0D   
002CAE CC      8341 CALL	Z,REFILL
002CAF D9   
002CB0 2C   
002CB1 CB      8342 BIT	7,C
002CB2 79   
002CB3 F5      8343 PUSH	AF
002CB4 C4      8344 CALL	NZ,LINES
002CB5 53   
002CB6 36   
002CB7 F1      8345 POP	AF
002CB8 CC      8346 CALL	Z,FETCHS
002CB9 42   
002CBA 36   
002CBB F1      8347 POP	AF		;RESTORE TYPE
002CBC C5      8348 PUSH	BC
002CBD E5      8349 PUSH	HL
002CBE B7      8350 OR	A
002CBF FA      8351 JP	M,INPUT4	;STRING
002CC0 D0   
002CC1 2C   
002CC2 F5      8352 PUSH	AF
002CC3 DD      8353 PUSH	IX
002CC4 E5   
002CC5 CD      8354 CALL	VAL0
002CC6 A6   
002CC7 1C   
002CC8 DD      8355 POP	IX
002CC9 E1   
002CCA F1      8356 POP	AF
002CCB CD      8357 CALL	STOREN
002CCC 74   
002CCD 32   
002CCE 18      8358 JR	INPUT5
002CCF 03   
002CD0 CD      8359 INPUT4:         CALL	STACCS
002CD1 C2   
002CD2 32   
002CD3 E1      8360 INPUT5:         POP	HL
002CD4 C1      8361 POP	BC
002CD5 CB      8362 INPUT3:         RES	0,C
002CD6 81   
002CD7 18      8363 JR	INPUT1
002CD8 A0   
002CD9 CB      8365 REFILL:         BIT	0,C
002CDA 41   
002CDB 20      8366 JR	NZ,REFIL0	;NO PROMPT
002CDC 0A   
002CDD 3E      8367 LD	A,'?'
002CDE 3F   
002CDF CD      8368 CALL	OUTCHR		;PROMPT
002CE0 86   
002CE1 41   
002CE2 3E      8369 LD	A,' '
002CE3 20   
002CE4 CD      8370 CALL	OUTCHR
002CE5 86   
002CE6 41   
002CE7 21      8371 REFIL0:         LD	HL,BUFFER
002CE8 00   
002CE9 54   
002CEA C5      8372 PUSH	BC
002CEB E5      8373 PUSH	HL
002CEC DD      8374 PUSH	IX
002CED E5   
002CEE CD      8375 CALL	OSLINE
002CEF E9   
002CF0 05   
002CF1 DD      8376 POP	IX
002CF2 E1   
002CF3 E1      8377 POP	HL
002CF4 C1      8378 POP	BC
002CF5 47      8379 LD	B,A		;POS AT ENTRY
002CF6 AF      8380 XOR	A
002CF7 32      8381 LD	(COUNT),A
002CF8 FB   
002CF9 55   
002CFA B8      8382 CP	B
002CFB C8      8383 RET	Z
002CFC 7E      8384 REFIL1:         LD	A,(HL)
002CFD FE      8385 CP	CR
002CFE 0D   
002CFF C8      8386 RET	Z
002D00 23      8387 INC	HL
002D01 10      8388 DJNZ	REFIL1
002D02 F9   
002D03 C9      8389 RET
002D04 FE      8393 READ:           CP	'#'
002D05 23   
002D06 CA      8394 JP	Z,INPUTN
002D07 1A   
002D08 2C   
002D09 2A      8395 LD	HL,(DATPTR)
002D0A F0   
002D0B 55   
002D0C 7E      8396 READ0:          LD	A,(HL)
002D0D FE      8397 CP	':'
002D0E 3A   
002D0F CC      8398 CALL	Z,REFIL1
002D10 FC   
002D11 2C   
002D12 23      8399 INC	HL		;SKIP COMMA | "DATA"
002D13 FE      8400 CP	CR		;END OF DATA STMT?
002D14 0D   
002D15 CC      8401 CALL	Z,GETDAT
002D16 44   
002D17 2D   
002D18 E5      8402 PUSH	HL
002D19 CD      8403 CALL	VAR_
002D1A 5A   
002D1B 26   
002D1C E1      8404 POP	HL
002D1D B7      8405 OR	A
002D1E FA      8406 JP	M,READ1		;STRING
002D1F 34   
002D20 2D   
002D21 E5      8407 PUSH	HL
002D22 FD      8408 EX	(SP),IY
002D23 E3   
002D24 F5      8409 PUSH	AF		;SAVE TYPE
002D25 DD      8410 PUSH	IX
002D26 E5   
002D27 CD      8411 CALL	EXPRN
002D28 B0   
002D29 18   
002D2A DD      8412 POP	IX
002D2B E1   
002D2C F1      8413 POP	AF
002D2D CD      8414 CALL	STOREN
002D2E 74   
002D2F 32   
002D30 FD      8415 EX	(SP),IY
002D31 E3   
002D32 18      8416 JR	READ2
002D33 07   
002D34 CD      8417 READ1:          CALL	FETCHS
002D35 42   
002D36 36   
002D37 E5      8418 PUSH	HL
002D38 CD      8419 CALL	STACCS
002D39 C2   
002D3A 32   
002D3B E1      8420 READ2:          POP	HL
002D3C 22      8421 LD	(DATPTR),HL
002D3D F0   
002D3E 55   
002D3F CD      8422 CALL	NLIST
002D40 84   
002D41 45   
002D42 18      8423 JR	READ0
002D43 C8   
002D44 CD      8425 GETDAT:         CALL	DSRCH
002D45 7D   
002D46 36   
002D47 23      8426 INC	HL
002D48 D0      8427 RET	NC
002D49 3E      8428 LD	A,42
002D4A 2A   
002D4B 18      8429 JR	ERROR4ex		;"Out of DATA"
002D4C 64   
002D4D CD      8436 IF_:            CALL	EXPRI
002D4E B7   
002D4F 18   
002D50 CD      8437 CALL	TEST
002D51 DD   
002D52 1F   
002D53 28      8438 JR	Z,IFNOT		;FALSE
002D54 2A   
002D55 FD      8439 LD	A,(IY)
002D56 7E   
002D57 00   
002D58 FE      8440 CP	TTHEN
002D59 8C   
002D5A C2      8441 JP	NZ,XEQ
002D5B 1D   
002D5C 25   
002D5D FD      8442 IF0:            INC	IY		;SKIP "THEN"
002D5E 23   
002D5F FD      8443 LD	A,(IY)
002D60 7E   
002D61 00   
002D62 FE      8444 CP	';'
002D63 3B   
002D64 28      8445 JR	Z,IF0
002D65 F7   
002D66 CD      8446 IF1:            CALL	NXT
002D67 8F   
002D68 45   
002D69 FE      8447 CP	TLINO
002D6A 8D   
002D6B C2      8448 JP	NZ,XEQ		;STATEMENT FOLLOWS
002D6C 1D   
002D6D 25   
002D6E C3      8449 JP	GOTO		;LINE NO. FOLLOWS
002D6F 38   
002D70 29   
002D71 FD      8451 IFELSE:         LD	A,(IY)
002D72 7E   
002D73 00   
002D74 FD      8452 INC	IY
002D75 23   
002D76 FE      8453 CP	';'
002D77 3B   
002D78 20      8454 JR	NZ,IFNEXT
002D79 0A   
002D7A 18      8455 JR	IFTHEN
002D7B 1E   
002D7C CD      8457 IF2:            CALL	QUOTE		;SKIP STRING
002D7D 1D   
002D7E 37   
002D7F FD      8458 IFNOT:          LD	A,(IY)
002D80 7E   
002D81 00   
002D82 FD      8459 INC	IY
002D83 23   
002D84 FE      8460 IFNEXT:         CP	'"'
002D85 22   
002D86 28      8461 JR	Z,IF2		;QUOTED STRING
002D87 F4   
002D88 FE      8462 CP	TREM
002D89 F4   
002D8A CA      8463 JP	Z,REM		;REM
002D8B B5   
002D8C 25   
002D8D FE      8464 CP	CR
002D8E 0D   
002D8F CA      8465 JP	Z,XEQ0		;END OF LINE
002D90 08   
002D91 25   
002D92 FE      8466 CP	TELSE
002D93 8B   
002D94 28      8467 JR	Z,IF1		;ELSE CLAUSE
002D95 D0   
002D96 FE      8468 CP	TTHEN
002D97 8C   
002D98 20      8469 JR	NZ,IFNOT	;TRY FOR END AGAIN
002D99 E5   
002D9A FD      8470 IFTHEN:         LD	A,(IY)
002D9B 7E   
002D9C 00   
002D9D FE      8471 CP	CR
002D9E 0D   
002D9F 20      8472 JR	NZ,IFELSE
002DA0 D0   
002DA1 01      8473 LD	BC,TELSE
002DA2 8B   
002DA3 00   
002DA4 11      8474 LD	DE,TENDIF*256+TTHEN
002DA5 8C   
002DA6 CD   
002DA7 FD      8475 INC	IY
002DA8 23   
002DA9 CD      8476 CALL	NSCAN
002DAA 95   
002DAB 36   
002DAC CA      8477 JP	Z,XEQ1
002DAD 24   
002DAE 25   
002DAF 3E      8478 NENDIF:         LD	A,49
002DB0 31   
002DB1 C3      8479 ERROR4ex:         JP	ERROR_		;"Missing ENDIF"
002DB2 C8   
002DB3 3F   
002DB4 01      8483 MELSE:          LD	BC,-3
002DB5 FD   
002DB6 FF   
002DB7 FD      8484 ADD	IY,BC
002DB8 09   
002DB9 01      8485 LD	BC,TENDIF
002DBA CD   
002DBB 00   
002DBC 11      8486 LD	DE,TENDIF*256+TTHEN
002DBD 8C   
002DBE CD   
002DBF CD      8487 CALL	NSCAN
002DC0 95   
002DC1 36   
002DC2 20      8488 JR	NZ,NENDIF
002DC3 EB   
002DC4 C3      8489 XEQGO7:         JP	XEQ
002DC5 1D   
002DC6 25   
002DC7 01      8493 WHEN:           LD	BC,-3
002DC8 FD   
002DC9 FF   
002DCA FD      8494 ADD	IY,BC
002DCB 09   
002DCC 01      8495 LD	BC,TENDCASE
002DCD CB   
002DCE 00   
002DCF 11      8496 LD	DE,TENDCASE*256+TOF
002DD0 CA   
002DD1 CB   
002DD2 CD      8497 CALL	NSCAN
002DD3 95   
002DD4 36   
002DD5 28      8498 JR	Z,XEQGO7
002DD6 ED   
002DD7 3E      8499 LD	A,47
002DD8 2F   
002DD9 18      8500 JR	ERROR4ex		;"Missing ENDCASE"
002DDA D6   
002DDB CD      8504 CASE:           CALL	EXPR		;String or numeric
002DDC 86   
002DDD 17   
002DDE 08      8505 EX	AF,AF'
002DDF 06      8506 LD	B,0		;Flag numeric
002DE0 00   
002DE1 F2      8507 JP	P,CASE6		;numeric
002DE2 EA   
002DE3 2D   
002DE4 CD      8508 CALL	PUSHS		;put string on stack
002DE5 9D   
002DE6 20   
002DE7 C1      8509 POP	BC		;C = length
002DE8 06      8510 LD	B,1		;Flag string
002DE9 01   
002DEA FD      8511 CASE6:          LD	A,(IY)
002DEB 7E   
002DEC 00   
002DED FD      8512 INC	IY
002DEE 23   
002DEF FE      8513 CP	TOF
002DF0 CA   
002DF1 3E      8514 LD	A,37
002DF2 25   
002DF3 20      8515 JR	NZ,ERROR4ex	;"Missing OF"
002DF4 BC   
002DF5 FD      8516 LD	A,(IY)
002DF6 7E   
002DF7 00   
002DF8 FD      8517 INC	IY		;Address line-length byte
002DF9 23   
002DFA FE      8518 CP	CR
002DFB 0D   
002DFC 3E      8519 LD	A,48
002DFD 30   
002DFE 20      8520 JR	NZ,ERROR4ex	;"OF not last"
002DFF B1   
002E00 AF      8521 CASE1:          XOR	A		;Level
002E01 D9      8522 CASE0:          EXX
002E02 E5      8523 PUSH	HL		;Push to stack
002E03 D9      8524 EXX
002E04 E5      8525 PUSH	HL
002E05 C5      8526 PUSH	BC
002E06 6F      8527 LD	L,A		;Level
002E07 01      8528 LD	BC,TOTHERWISE*256+TWHEN
002E08 C9   
002E09 CC   
002E0A 11      8529 LD	DE,TENDCASE*256+TOF
002E0B CA   
002E0C CB   
002E0D CD      8530 CALL	NSCAN1
002E0E 97   
002E0F 36   
002E10 C1      8531 POP	BC		;Restore from stack
002E11 E1      8532 POP	HL
002E12 D9      8533 EXX
002E13 E1      8534 POP	HL
002E14 D9      8535 EXX
002E15 3E      8536 LD	A,47
002E16 2F   
002E17 C2      8537 JP	NZ,ERROR_	;Missing ENDCASE
002E18 C8   
002E19 3F   
002E1A FD      8538 LD	A,(IY-1)
002E1B 7E   
002E1C FF   
002E1D FE      8539 CP	TENDCASE
002E1E CB   
002E1F 28      8540 JR	Z,CASE9
002E20 56   
002E21 FE      8541 CP	TOTHERWISE
002E22 CC   
002E23 28      8542 JR	Z,CASE9
002E24 52   
002E25 CB      8543 CASE4:          BIT	0,B		;Numeric or string?
002E26 40   
002E27 20      8544 JR	NZ,CASE3
002E28 69   
002E29 C5      8545 PUSH	BC		;Type/exponent/length
002E2A E5      8546 PUSH	HL		;MS 32 bits
002E2B D9      8547 EXX
002E2C E5      8548 PUSH	HL		;LS 32 bits
002E2D D9      8549 EXX
002E2E CD      8550 CALL	EXPRN
002E2F B0   
002E30 18   
002E31 DD      8551 LD	IX,0
002E32 21   
002E33 00   
002E34 00   
002E35 DD      8552 ADD	IX,SP		;Address stack
002E36 39   
002E37 D9      8553 EXX
002E38 DD      8554 LD	E,(IX+0)	;Get LS 32-bits
002E39 5E   
002E3A 00   
002E3B DD      8555 LD	D,(IX+1)
002E3C 56   
002E3D 01   
002E3E D9      8556 EXX
002E3F DD      8557 LD	E,(IX+2)
002E40 5E   
002E41 02   
002E42 DD      8558 LD	D,(IX+3)	;Get MS 32-bits
002E43 56   
002E44 03   
002E45 DD      8559 LD	B,(IX+4)	;Get exponent
002E46 46   
002E47 04   
002E48 3E      8560 LD	A,9
002E49 09   
002E4A CD      8561 CALL	FPP		;In case integer vs float
002E4B 99   
002E4C 45   
002E4D 7D      8562 LD	A,L
002E4E B7      8563 OR	A		;NZ if equal
002E4F D9      8564 EXX
002E50 E1      8565 POP	HL
002E51 D9      8566 EXX
002E52 E1      8567 POP	HL
002E53 C1      8568 POP	BC
002E54 20      8569 JR	NZ,CASE5	;Match found
002E55 2C   
002E56 FD      8570 CASE2:          LD	A,(IY)
002E57 7E   
002E58 00   
002E59 FD      8571 INC	IY
002E5A 23   
002E5B FE      8572 CP	','
002E5C 2C   
002E5D 28      8573 JR	Z,CASE4		;Not found, try another
002E5E C6   
002E5F D9      8574 EXX
002E60 FD      8575 PUSH	IY
002E61 E5   
002E62 E3      8576 EX	(SP),HL
002E63 3E      8577 LD	A,CR
002E64 0D   
002E65 47      8578 LD	B,A
002E66 ED      8579 CPIR			;Find CR
002E67 B1   
002E68 E3      8580 EX	(SP),HL
002E69 FD      8581 POP	IY
002E6A E1   
002E6B D9      8582 EXX
002E6C FD      8583 LD	A,(IY-2)	;Last token in previous line
002E6D 7E   
002E6E FE   
002E6F FE      8584 CP	TOF		;CASE statement in WHEN line
002E70 CA   
002E71 20      8585 JR	NZ,CASE1
002E72 8D   
002E73 3E      8586 LD	A,1
002E74 01   
002E75 18      8587 JR	CASE0
002E76 8A   
002E77 CB      8591 CASE9:          BIT	0,B
002E78 40   
002E79 28      8592 JR	Z,XEQGO5
002E7A 49   
002E7B 26      8593 LD	H,0
002E7C 00   
002E7D 69      8594 LD	L,C
002E7E 39      8595 ADD	HL,SP
002E7F F9      8596 LD	SP,HL
002E80 18      8597 JR	XEQGO5
002E81 42   
002E82 CD      8601 CASE5:          CALL	NXT
002E83 8F   
002E84 45   
002E85 FE      8602 CP	','
002E86 2C   
002E87 20      8603 JR	NZ,CASE9	;End of list
002E88 EE   
002E89 FD      8604 INC	IY
002E8A 23   
002E8B C5      8605 PUSH	BC		;Save type and string length
002E8C CD      8606 CALL	EXPR		;Evaluate but discard
002E8D 86   
002E8E 17   
002E8F C1      8607 POP	BC
002E90 18      8608 JR	CASE5
002E91 F0   
002E92 C5      8612 CASE3:          PUSH	BC
002E93 CD      8613 CALL	EXPRS
002E94 C0   
002E95 18   
002E96 C1      8614 POP	BC
002E97 21      8615 LD	HL,0
002E98 00   
002E99 00   
002E9A 39      8616 ADD	HL,SP
002E9B 43      8617 LD	B,E
002E9C 11      8618 LD	DE,ACCS
002E9D 00   
002E9E 53   
002E9F C5      8619 PUSH	BC
002EA0 CD      8620 CALL	SCP		;String compare
002EA1 79   
002EA2 20   
002EA3 C1      8621 POP	BC
002EA4 06      8622 LD	B,1
002EA5 01   
002EA6 20      8623 JR	NZ,CASE2
002EA7 AE   
002EA8 18      8624 JR	CASE5
002EA9 D8   
002EAA FD      8628 WHILE:          PUSH	IY		;Save current position
002EAB E5   
002EAC CD      8629 CALL	CHECK
002EAD 0A   
002EAE 33   
002EAF CD      8630 CALL	WHICHK		;Push marker
002EB0 B2   
002EB1 2E   
002EB2 CD      8631 WHICHK:         CALL	EXPRI
002EB3 B7   
002EB4 18   
002EB5 CD      8632 CALL	TEST
002EB6 DD   
002EB7 1F   
002EB8 20      8633 JR	NZ,XEQGO5
002EB9 0A   
002EBA C1      8634 POP	BC		;Pop marker
002EBB C1      8635 POP	BC		;Level stack
002EBC 01      8636 LD	BC,TWHILE+[TENDWHILE*256]
002EBD C7   
002EBE CE   
002EBF 16      8637 LD	D,1
002EC0 01   
002EC1 CD      8638 CALL	WSRCH
002EC2 D4   
002EC3 36   
002EC4 C3      8639 XEQGO5:         JP	XEQ
002EC5 1D   
002EC6 25   
002EC7 C1      8643 ENDWHI:         POP	BC		;Marker
002EC8 D1      8644 POP	DE		;Saved text pointer
002EC9 D5      8645 PUSH	DE
002ECA C5      8646 PUSH	BC
002ECB B7      8647 OR	A
002ECC 21      8648 LD	HL,WHICHK
002ECD B2   
002ECE 2E   
002ECF ED      8649 SBC	HL,BC
002ED0 42   
002ED1 28      8650 JR	Z,ENDWH1
002ED2 0B   
002ED3 3E      8651 LD	A,3
002ED4 03   
002ED5 CD      8652 CALL	RESLOC
002ED6 B5   
002ED7 34   
002ED8 20      8653 JR	NZ,ENDWHI
002ED9 ED   
002EDA 3E      8654 LD	A,46
002EDB 2E   
002EDC 18      8655 JR	ERROR5		;"Not in a WHILE loop"
002EDD 4F   
002EDE FD      8657 ENDWH1:         PUSH	IY
002EDF E5   
002EE0 FD      8658 LD	IY,0
002EE1 21   
002EE2 00   
002EE3 00   
002EE4 FD      8659 ADD	IY,DE
002EE5 19   
002EE6 CD      8660 CALL	EXPRI
002EE7 B7   
002EE8 18   
002EE9 CD      8661 CALL	TEST
002EEA DD   
002EEB 1F   
002EEC D1      8662 POP	DE		;Text pointer
002EED 20      8663 JR	NZ,XEQGO5
002EEE D5   
002EEF C1      8664 POP	BC		;Junk marker
002EF0 C1      8665 POP	BC		;Junk pointer
002EF1 FD      8666 LD	IY,0
002EF2 21   
002EF3 00   
002EF4 00   
002EF5 FD      8667 ADD	IY,DE
002EF6 19   
002EF7 18      8668 JR	XEQGO5
002EF8 CB   
002EF9 CD      8672 CLS:            CALL	CLRSCN
002EFA 10   
002EFB 0E   
002EFC AF      8673 XOR	A
002EFD 32      8674 LD	(COUNT),A
002EFE FB   
002EFF 55   
002F00 18      8675 JR	XEQGO5
002F01 C2   
002F02 CD      8679 STOP:           CALL	TELL
002F03 7E   
002F04 45   
002F05 0D      8680 DB	CR
002F06 0A      8681 DB	LF
002F07 FA      8682 DB	TSTOP
002F08 00      8683 DB	0
002F09 CD      8684 CALL	SETLIN		;FIND CURRENT LINE
002F0A DF   
002F0B 41   
002F0C CD      8685 CALL	SAYLN
002F0D 06   
002F0E 42   
002F0F CD      8686 CALL	CRLF
002F10 7F   
002F11 41   
002F12 C3      8687 JP	CLOOP
002F13 34   
002F14 38   
002F15 CD      8691 REPOR:          CALL	REPORT
002F16 69   
002F17 45   
002F18 18      8692 JR	XEQGO5
002F19 AA   
002F1A CD      8696 CLR:            CALL	CLEAR
002F1B C7   
002F1C 40   
002F1D 2A      8697 LD	HL,(PAGE_)
002F1E DC   
002F1F 55   
002F20 18      8698 JR	RESTR1
002F21 3B   
002F22 FD      8702 RESERR:         INC	IY
002F23 23   
002F24 3E      8703 LD	A,2
002F25 02   
002F26 CD      8704 CALL	RESLOC
002F27 B5   
002F28 34   
002F29 20      8705 JR	NZ,XEQGO5
002F2A 99   
002F2B 3E      8706 LD	A,53		;ON ERROR not LOCAL
002F2C 35   
002F2D C3      8707 ERROR5:         JP	ERROR_
002F2E C8   
002F2F 3F   
002F30 FD      8711 RESDAT:         INC	IY
002F31 23   
002F32 3E      8712 LD	A,1
002F33 01   
002F34 CD      8713 CALL	RESLOC
002F35 B5   
002F36 34   
002F37 20      8714 JR	NZ,XEQGO5
002F38 8B   
002F39 3E      8715 LD	A,54		;'DATA not LOCAL'
002F3A 36   
002F3B 21      8716 DB	21H
002F3C 3E      8717 NOLINE:         LD	A,41		;'No such line'
002F3D 29   
002F3E 18      8718 JR	ERROR5
002F3F ED   
002F40 FE      8722 RESTOR:         CP	TERROR
002F41 85   
002F42 28      8723 JR	Z,RESERR
002F43 DE   
002F44 FE      8724 CP	TDATA
002F45 DC   
002F46 28      8725 JR	Z,RESDAT
002F47 E8   
002F48 FE      8726 CP	'+'
002F49 2B   
002F4A 28      8727 JR	Z,RESREL
002F4B 1A   
002F4C 2A      8728 LD	HL,(PAGE_)
002F4D DC   
002F4E 55   
002F4F CD      8729 CALL	TERMQ
002F50 BA   
002F51 35   
002F52 28      8730 JR	Z,RESTR1
002F53 09   
002F54 CD      8731 CALL	ITEMI
002F55 E4   
002F56 18   
002F57 D9      8732 EXX
002F58 CD      8733 CALL	FINDL		;SEARCH FOR LINE
002F59 C7   
002F5A 41   
002F5B 20      8734 JR	NZ,NOLINE
002F5C DF   
002F5D CD      8735 RESTR1:         CALL	DSRCH
002F5E 7D   
002F5F 36   
002F60 22      8736 LD	(DATPTR),HL
002F61 F0   
002F62 55   
002F63 C3      8737 JP	XEQ
002F64 1D   
002F65 25   
002F66 CD      8739 RESREL:         CALL	EXPRI
002F67 B7   
002F68 18   
002F69 D9      8740 EXX
002F6A EB      8741 EX	DE,HL
002F6B FD      8742 PUSH	IY
002F6C E5   
002F6D E1      8743 POP	HL
002F6E 3E      8744 LD	A,CR
002F6F 0D   
002F70 47      8745 LD	B,A
002F71 ED      8746 CPIR			;FIND LINE END
002F72 B1   
002F73 1D      8747 DEC	E
002F74 28      8748 JR	Z,RESTR1
002F75 E7   
002F76 FA      8749 JP	M,RESTR1
002F77 5D   
002F78 2F   
002F79 AF      8750 XOR	A
002F7A 47      8751 LD	B,A
002F7B 4E      8752 RESTR2:         LD	C,(HL)
002F7C B9      8753 CP	C
002F7D 28      8754 JR	Z,NOLINE
002F7E BD   
002F7F 09      8755 ADD	HL,BC
002F80 1D      8756 DEC	E
002F81 20      8757 JR	NZ,RESTR2
002F82 F8   
002F83 18      8758 JR	RESTR1
002F84 D8   
002F85 CD      8766 PTR:            CALL	CHANEL
002F86 55   
002F87 37   
002F88 CD      8767 CALL	EQUALS
002F89 D3   
002F8A 35   
002F8B 7B      8768 LD	A,E
002F8C F5      8769 PUSH	AF
002F8D CD      8770 CALL	EXPRI
002F8E B7   
002F8F 18   
002F90 E5      8771 PUSH	HL
002F91 D9      8772 EXX
002F92 D1      8773 POP	DE
002F93 F1      8774 POP	AF
002F94 CD      8775 CALL	PUTPTR
002F95 97   
002F96 06   
002F97 18      8776 JR	XEQGO1ex
002F98 61   
002F99 CD      8778 PAGEV:          CALL	EQUALS
002F9A D3   
002F9B 35   
002F9C CD      8779 CALL	EXPRI
002F9D B7   
002F9E 18   
002F9F D9      8780 EXX
002FA0 2E      8781 LD	L,0
002FA1 00   
002FA2 22      8782 LD	(PAGE_),HL
002FA3 DC   
002FA4 55   
002FA5 18      8783 JR	XEQGO1ex
002FA6 53   
002FA7 FE      8785 TIMEV:          CP	'$'
002FA8 24   
002FA9 28      8786 JR	Z,TIMEVS
002FAA 0E   
002FAB CD      8787 CALL	EQUALS
002FAC D3   
002FAD 35   
002FAE CD      8788 CALL	EXPRI
002FAF B7   
002FB0 18   
002FB1 E5      8789 PUSH	HL
002FB2 D9      8790 EXX
002FB3 D1      8791 POP	DE
002FB4 CD      8792 CALL	PUTIME
002FB5 DB   
002FB6 0D   
002FB7 18      8793 JR	XEQGO1ex
002FB8 41   
002FB9 FD      8795 TIMEVS:         INC	IY		;SKIP '$'
002FBA 23   
002FBB CD      8796 CALL	EQUALS
002FBC D3   
002FBD 35   
002FBE CD      8797 CALL	EXPRS
002FBF C0   
002FC0 18   
002FC1 CD      8798 CALL	PUTIMS
002FC2 F8   
002FC3 0D   
002FC4 18      8799 JR	XEQGO1ex
002FC5 34   
002FC6 CD      8801 LOMEMV:         CALL	EQUALS
002FC7 D3   
002FC8 35   
002FC9 CD      8802 CALL	EXPRI
002FCA B7   
002FCB 18   
002FCC CD      8803 CALL	CLEAR
002FCD C7   
002FCE 40   
002FCF D9      8804 EXX
002FD0 22      8805 LD	(LOMEM),HL
002FD1 DE   
002FD2 55   
002FD3 22      8806 LD	(FREE),HL
002FD4 E0   
002FD5 55   
002FD6 18      8807 JR	XEQGO1ex
002FD7 22   
002FD8 CD      8809 HIMEMV:         CALL	EQUALS
002FD9 D3   
002FDA 35   
002FDB CD      8810 CALL	EXPRI
002FDC B7   
002FDD 18   
002FDE D9      8811 EXX
002FDF ED      8812 LD	DE,(FREE)
002FE0 5B   
002FE1 E0   
002FE2 55   
002FE3 14      8813 INC	D
002FE4 AF      8814 XOR	A
002FE5 ED      8815 SBC	HL,DE
002FE6 52   
002FE7 19      8816 ADD	HL,DE
002FE8 DA      8817 JP	C,ERROR_		;"No room"
002FE9 C8   
002FEA 3F   
002FEB ED      8818 LD	DE,(HIMEM)
002FEC 5B   
002FED E2   
002FEE 55   
002FEF 22      8819 LD	(HIMEM),HL
002FF0 E2   
002FF1 55   
002FF2 EB      8820 EX	DE,HL
002FF3 ED      8821 SBC	HL,SP
002FF4 72   
002FF5 C2      8822 JP	NZ,XEQ
002FF6 1D   
002FF7 25   
002FF8 EB      8823 EX	DE,HL
002FF9 F9      8824 LD	SP,HL		;LOAD STACK POINTER
002FFA C3      8825 XEQGO1ex:         JP	XEQ
002FFB 1D   
002FFC 25   
002FFD CD      8829 WIDTHV:         CALL	EXPRI
002FFE B7   
002FFF 18   
003000 D9      8830 EXX
003001 7D      8831 LD	A,L
003002 32      8832 LD	(WIDTH),A
003003 FC   
003004 55   
003005 18      8833 JR	XEQGO1ex
003006 F3   
003007 FD      8839 TRACE:          INC	IY
003008 23   
003009 21      8840 LD	HL,0
00300A 00   
00300B 00   
00300C FE      8841 CP	TON
00300D EE   
00300E 28      8842 JR	Z,TRACE0
00300F 0A   
003010 FE      8843 CP	TOFF
003011 87   
003012 28      8844 JR	Z,TRACE1
003013 07   
003014 FD      8845 DEC	IY
003015 2B   
003016 CD      8846 CALL	EXPRI
003017 B7   
003018 18   
003019 D9      8847 EXX
00301A 2B      8848 TRACE0:         DEC	HL
00301B 22      8849 TRACE1:         LD	(TRACEN),HL
00301C E6   
00301D 55   
00301E 18      8850 JR	XEQGO1ex
00301F DA   
003020 CD      8854 VDU:            CALL	EXPRI
003021 B7   
003022 18   
003023 D9      8855 EXX
003024 7D      8856 LD	A,L
003025 06      8857 LD	B,1
003026 01   
003027 CD      8858 VDU1:           CALL	OSWRCH
003028 97   
003029 05   
00302A 10      8859 DJNZ	VDU1
00302B FB   
00302C FD      8860 LD	A,(IY)
00302D 7E   
00302E 00   
00302F FE      8861 CP	'|'
003030 7C   
003031 28      8862 JR	Z,VDU4
003032 15   
003033 FE      8863 CP	','
003034 2C   
003035 28      8864 JR	Z,VDU2
003036 08   
003037 FE      8865 CP	';'
003038 3B   
003039 20      8866 JR	NZ,VDU3
00303A 06   
00303B 7C      8867 LD	A,H
00303C CD      8868 CALL	OSWRCH
00303D 97   
00303E 05   
00303F FD      8869 VDU2:           INC	IY
003040 23   
003041 CD      8870 VDU3:           CALL	TERMQ
003042 BA   
003043 35   
003044 20      8871 JR	NZ,VDU
003045 DA   
003046 18      8872 JR	XEQGO1ex
003047 B2   
003048 FD      8874 VDU4:           INC	IY
003049 23   
00304A AF      8875 XOR	A
00304B 06      8876 LD	B,9
00304C 09   
00304D 18      8877 JR	VDU1
00304E D8   
00304F CD      8881 CLOSE:          CALL	CHANEL
003050 55   
003051 37   
003052 CD      8882 CALL	OSSHUT
003053 55   
003054 06   
003055 18      8883 JR	XEQGO1ex
003056 A3   
003057 CD      8888 BPUT:           CALL	CHANEL		;CHANNEL NUMBER
003058 55   
003059 37   
00305A D5      8889 PUSH	DE
00305B CD      8890 CALL	COMMA
00305C 26   
00305D 21   
00305E CD      8891 CALL	EXPR
00305F 86   
003060 17   
003061 08      8892 EX	AF,AF'
003062 FA      8893 JP	M,BPUTS
003063 70   
003064 30   
003065 CD      8894 CALL	SFIX
003066 9B   
003067 1C   
003068 D9      8895 EXX
003069 7D      8896 LD	A,L
00306A D1      8897 POP	DE
00306B CD      8898 CALL	OSBPUT
00306C 65   
00306D 06   
00306E 18      8899 BPUTX:          JR	XEQGO1ex
00306F 8A   
003070 7B      8901 BPUTS:          LD	A,E
003071 D1      8902 POP	DE
003072 57      8903 LD	D,A
003073 21      8904 LD	HL,ACCS
003074 00   
003075 53   
003076 7E      8905 BPUTS1:         LD	A,(HL)
003077 23      8906 INC	HL
003078 CD      8907 CALL	OSBPUT
003079 65   
00307A 06   
00307B 15      8908 DEC	D
00307C 20      8909 JR	NZ,BPUTS1
00307D F8   
00307E CD      8910 CALL	NXT
00307F 8F   
003080 45   
003081 FE      8911 CP	';'
003082 3B   
003083 FD      8912 INC	IY
003084 23   
003085 28      8913 JR	Z,BPUTX
003086 E7   
003087 3E      8914 LD	A,LF
003088 0A   
003089 CD      8915 CALL	OSBPUT
00308A 65   
00308B 06   
00308C FD      8916 DEC	IY
00308D 2B   
00308E 18      8917 JR	BPUTX
00308F DE   
003090 CD      8921 CALL:           CALL	EXPRI		;ADDRESS
003091 B7   
003092 18   
003093 D9      8922 EXX
003094 E5      8923 PUSH	HL		;SAVE IT
003095 06      8924 LD	B,0		;PARAMETER COUNTER
003096 00   
003097 11      8925 LD	DE,BUFFER	;VECTOR
003098 00   
003099 54   
00309A CD      8926 CALL1:          CALL	NXT
00309B 8F   
00309C 45   
00309D FE      8927 CP	','
00309E 2C   
00309F 20      8928 JR	NZ,CALL2
0030A0 17   
0030A1 FD      8929 INC	IY
0030A2 23   
0030A3 04      8930 INC	B
0030A4 CD      8931 CALL	NXT
0030A5 8F   
0030A6 45   
0030A7 C5      8932 PUSH	BC
0030A8 D5      8933 PUSH	DE
0030A9 CD      8934 CALL	VAR_
0030AA 5A   
0030AB 26   
0030AC D1      8935 POP	DE
0030AD C1      8936 POP	BC
0030AE 13      8937 INC	DE
0030AF 12      8938 LD	(DE),A		;PARAMETER TYPE
0030B0 13      8939 INC	DE
0030B1 EB      8940 EX	DE,HL
0030B2 73      8941 LD	(HL),E		;PARAMETER ADDRESS
0030B3 23      8942 INC	HL
0030B4 72      8943 LD	(HL),D
0030B5 EB      8944 EX	DE,HL
0030B6 18      8945 JR	CALL1
0030B7 E2   
0030B8 78      8946 CALL2:          LD	A,B
0030B9 32      8947 LD	(BUFFER),A	;PARAMETER COUNT
0030BA 00   
0030BB 54   
0030BC E1      8948 POP	HL		;RESTORE ADDRESS
0030BD CD      8949 CALL	USR1
0030BE C7   
0030BF 30   
0030C0 C3      8950 JP	XEQ
0030C1 1D   
0030C2 25   
0030C3 CD      8954 USR:            CALL	ITEMI
0030C4 E4   
0030C5 18   
0030C6 D9      8955 EXX
0030C7 E5      8956 USR1:           PUSH	HL		;ADDRESS ON STACK
0030C8 FD      8957 EX	(SP),IY
0030C9 E3   
0030CA 24      8958 INC	H		;PAGE &FF?
0030CB 21      8959 LD	HL,USR2		;RETURN ADDRESS
0030CC F6   
0030CD 30   
0030CE E5      8960 PUSH	HL
0030CF DD      8961 LD	IX,STAVAR
0030D0 21   
0030D1 00   
0030D2 55   
0030D3 CC      8962 CALL	Z,OSCALL	;INTERCEPT PAGE &FF
0030D4 2C   
0030D5 11   
0030D6 DD      8963 LD	C,(IX+24)
0030D7 4E   
0030D8 18   
0030D9 C5      8964 PUSH	BC
0030DA F1      8965 POP	AF		;LOAD FLAGS
0030DB DD      8966 LD	A,(IX+4)	;LOAD Z80 REGISTERS
0030DC 7E   
0030DD 04   
0030DE DD      8967 LD	B,(IX+8)
0030DF 46   
0030E0 08   
0030E1 DD      8968 LD	C,(IX+12)
0030E2 4E   
0030E3 0C   
0030E4 DD      8969 LD	D,(IX+16)
0030E5 56   
0030E6 10   
0030E7 DD      8970 LD	E,(IX+20)
0030E8 5E   
0030E9 14   
0030EA DD      8971 LD	H,(IX+32)
0030EB 66   
0030EC 20   
0030ED DD      8972 LD	L,(IX+48)
0030EE 6E   
0030EF 30   
0030F0 DD      8973 LD	IX,BUFFER
0030F1 21   
0030F2 00   
0030F3 54   
0030F4 FD      8974 JP	(IY)		;OFF TO USER ROUTINE
0030F5 E9   
0030F6 FD      8975 USR2:           POP	IY
0030F7 E1   
0030F8 AF      8976 XOR	A
0030F9 4F      8977 LD	C,A
0030FA C9      8978 RET
0030FB CD      8984 LEFTSL:         CALL    GETSTR
0030FC 42   
0030FD 26   
0030FE 21      8985 LD	HL,0FF00H	;Default all but last
0030FF 00   
003100 FF   
003101 20      8986 JR	NZ,MIDSL1
003102 48   
003103 18      8987 JR	MIDSL0
003104 26   
003105 CD      8989 RITESL:         CALL	GETSTR
003106 42   
003107 26   
003108 21      8990 LD	HL,0FFFFH	;Default last char only
003109 FF   
00310A FF   
00310B 20      8991 JR	NZ,MIDSL1
00310C 3E   
00310D 18      8992 JR	MIDSL0
00310E 1C   
00310F CD      8994 MIDSL:          CALL	GETSTR
003110 42   
003111 26   
003112 3E      8995 LD	A,5
003113 05   
003114 C2      8996 JP	NZ,ERROR_	;'Missing comma'
003115 C8   
003116 3F   
003117 FD      8997 INC	IY
003118 23   
003119 DD      8998 PUSH	IX
00311A E5   
00311B CD      8999 CALL	EXPRI
00311C B7   
00311D 18   
00311E DD      9000 POP	IX
00311F E1   
003120 D9      9001 EXX
003121 CD      9002 CALL	NXT
003122 8F   
003123 45   
003124 2D      9003 DEC	L
003125 26      9004 LD	H,254		;Default rest of string
003126 FE   
003127 FE      9005 CP	','
003128 2C   
003129 20      9006 JR	NZ,MIDSL1
00312A 20   
00312B FD      9007 MIDSL0:         INC	IY
00312C 23   
00312D E5      9008 PUSH	HL
00312E DD      9009 PUSH	IX
00312F E5   
003130 CD      9010 CALL	EXPRI
003131 B7   
003132 18   
003133 DD      9011 POP	IX
003134 E1   
003135 D9      9012 EXX
003136 7D      9013 LD	A,L
003137 E1      9014 POP	HL
003138 B7      9015 OR	A
003139 28      9016 JR	Z,MIDSL2	;Zero length
00313A 0D   
00313B 3D      9017 DEC	A
00313C 85      9018 ADD	A,L
00313D 67      9019 LD	H,A
00313E 30      9020 JR	NC,MIDSL1
00313F 0B   
003140 7D      9021 LD	A,L
003141 3C      9022 INC	A
003142 28      9023 JR	Z,MIDSL1
003143 07   
003144 26      9024 LD	H,254
003145 FE   
003146 18      9025 JR	MIDSL1
003147 03   
003148 21      9027 MIDSL2:         LD	HL,1
003149 01   
00314A 00   
00314B CD      9028 MIDSL1:         CALL	BRAKET
00314C 32   
00314D 21   
00314E CD      9029 CALL	EQUALS
00314F D3   
003150 35   
003151 E5      9030 PUSH	HL
003152 DD      9031 PUSH	IX
003153 E5   
003154 CD      9032 CALL	EXPRS
003155 C0   
003156 18   
003157 DD      9033 POP	IX
003158 E1   
003159 E1      9034 POP	HL
00315A 4B      9035 LD	C,E
00315B DD      9036 LD	B,(IX+0)
00315C 46   
00315D 00   
00315E DD      9037 LD	E,(IX+2)
00315F 5E   
003160 02   
003161 DD      9038 LD	D,(IX+3)
003162 56   
003163 03   
003164 7D      9049 LD	A,L
003165 3C      9050 INC	A
003166 20      9051 JR	NZ,SUBSL1
003167 0F   
003168 24      9052 INC	H
003169 24      9053 INC	H
00316A 79      9054 LD	A,C
00316B BC      9055 CP	H
00316C 30      9056 JR	NC,SUBSL0
00316D 01   
00316E 67      9057 LD	H,A
00316F 78      9058 SUBSL0:         LD	A,B
003170 94      9059 SUB	H
003171 30      9060 JR	NC,SUBSL6
003172 01   
003173 AF      9061 XOR	A
003174 6F      9062 SUBSL6:         LD	L,A
003175 18      9063 JR	SUBSL5
003176 12   
003177 7C      9065 SUBSL1:         LD	A,H
003178 3C      9066 INC	A
003179 20      9067 JR	NZ,SUBSL2
00317A 06   
00317B 78      9068 LD	A,B
00317C D6      9069 SUB	2
00317D 02   
00317E 38      9070 JR	C,SUBSL9
00317F 24   
003180 67      9071 LD	H,A
003181 7D      9072 SUBSL2:         LD	A,L
003182 B8      9073 CP	B
003183 30      9074 JR	NC,SUBSL9
003184 1F   
003185 7C      9075 LD	A,H
003186 B8      9076 CP	B
003187 38      9077 JR	C,SUBSL3
003188 03   
003189 78      9078 SUBSL5:         LD	A,B
00318A 3D      9079 DEC	A
00318B 67      9080 LD	H,A
00318C 7C      9081 SUBSL3:         LD	A,H
00318D 95      9082 SUB	L
00318E 38      9083 JR	C,SUBSL9
00318F 14   
003190 3C      9084 INC	A
003191 B9      9085 CP	C
003192 38      9086 JR	C,SUBSL4
003193 01   
003194 79      9087 LD	A,C
003195 06      9088 SUBSL4:         LD	B,0
003196 00   
003197 60      9089 LD	H,B
003198 4F      9090 LD	C,A
003199 B7      9091 OR	A
00319A 28      9092 JR	Z,SUBSL9
00319B 08   
00319C EB      9093 EX	DE,HL
00319D 19      9094 ADD	HL,DE
00319E EB      9095 EX	DE,HL
00319F 21      9096 LD	HL,ACCS
0031A0 00   
0031A1 53   
0031A2 ED      9097 LDIR
0031A3 B0   
0031A4 C3      9098 SUBSL9:         JP	XEQ
0031A5 1D   
0031A6 25   
0031A7 FD      9104 EXITex:           INC	IY		;Skip FOR/REPEAT/WHILE
0031A8 23   
0031A9 FE      9105 CP	TFOR
0031AA E3   
0031AB 20      9106 JR	NZ,EXIT0
0031AC 0C   
0031AD DD      9107 LD	IX,0		;For EXITex FOR <var>
0031AE 21   
0031AF 00   
0031B0 00   
0031B1 CD      9108 CALL	TERMQ
0031B2 BA   
0031B3 35   
0031B4 C4      9109 CALL	NZ,GETVAR
0031B5 67   
0031B6 42   
0031B7 3E      9110 LD	A,TFOR
0031B8 E3   
0031B9 16      9111 EXIT0:          LD	D,1		;Level for WSRCH
0031BA 01   
0031BB 5F      9112 LD	E,A
0031BC 7B      9113 EXIT1:          LD	A,E
0031BD C1      9114 POP	BC		;Marker
0031BE 21      9115 LD	HL,FORCHK
0031BF E5   
0031C0 29   
0031C1 B7      9116 OR	A
0031C2 ED      9117 SBC	HL,BC
0031C3 42   
0031C4 28      9118 JR	Z,EXIT4
0031C5 25   
0031C6 21      9119 LD	HL,REPCHK
0031C7 71   
0031C8 29   
0031C9 B7      9120 OR	A
0031CA ED      9121 SBC	HL,BC
0031CB 42   
0031CC 28      9122 JR	Z,EXIT6
0031CD 38   
0031CE 21      9123 LD	HL,WHICHK
0031CF B2   
0031D0 2E   
0031D1 B7      9124 OR	A
0031D2 ED      9125 SBC	HL,BC
0031D3 42   
0031D4 28      9126 JR	Z,EXIT7
0031D5 3A   
0031D6 C5      9127 PUSH	BC		;Put back marker
0031D7 DD      9128 PUSH	IX
0031D8 E5   
0031D9 C1      9129 POP	BC
0031DA D9      9130 EXX
0031DB 3E      9131 LD	A,3
0031DC 03   
0031DD CD      9132 CALL	RESLOC
0031DE B5   
0031DF 34   
0031E0 D9      9133 EXX
0031E1 C5      9134 PUSH	BC
0031E2 DD      9135 POP	IX
0031E3 E1   
0031E4 20      9136 JR	NZ,EXIT1
0031E5 D6   
0031E6 3E      9137 LD	A,44
0031E7 2C   
0031E8 C3      9138 JP	ERROR_		;'Bad EXITex'
0031E9 C8   
0031EA 3F   
0031EB C1      9140 EXIT4:          POP	BC		;VARPTR
0031EC 21      9141 LD	HL,14		;Skip text pointer, limit & step
0031ED 0E   
0031EE 00   
0031EF 39      9142 ADD	HL,SP
0031F0 F9      9143 LD	SP,HL		;Pop FOR record
0031F1 FE      9144 CP	TFOR
0031F2 E3   
0031F3 20      9145 JR	NZ,EXIT1
0031F4 C7   
0031F5 DD      9146 PUSH	IX
0031F6 E5   
0031F7 E1      9147 POP	HL
0031F8 7C      9148 LD	A,H
0031F9 B5      9149 OR	L
0031FA 28      9150 JR	Z,EXIT5
0031FB 02   
0031FC ED      9151 SBC	HL,BC
0031FD 42   
0031FE 01      9152 EXIT5:          LD	BC,TFOR+[TNEXT*256]
0031FF E3   
003200 ED   
003201 28      9153 JR	Z,EXIT8
003202 15   
003203 14      9154 INC	D		;Count nested FOR loops
003204 18      9155 JR	EXIT1
003205 B6   
003206 C1      9157 EXIT6:          POP	BC		;Text pointer
003207 FE      9158 CP	TREPEAT
003208 F5   
003209 20      9159 JR	NZ,EXIT1
00320A B1   
00320B 01      9160 LD	BC,TREPEAT+[TUNTIL*256]
00320C F5   
00320D FD   
00320E 18      9161 JR	EXIT8
00320F 08   
003210 C1      9163 EXIT7:          POP	BC		;Text pointer
003211 FE      9164 CP	TWHILE
003212 C7   
003213 20      9165 JR	NZ,EXIT1
003214 A7   
003215 01      9166 LD	BC,TWHILE+[TENDWHILE*256]
003216 C7   
003217 CE   
003218 CD      9167 EXIT8:          CALL	WSRCH
003219 D4   
00321A 36   
00321B CD      9168 CALL	SPAN		;Skip UNTIL expression
00321C C6   
00321D 35   
00321E C3      9169 JP	XEQ
00321F 1D   
003220 25   
003221 CD      9173 PUT:            CALL	EXPRI		;PORT ADDRESS
003222 B7   
003223 18   
003224 D9      9174 EXX
003225 E5      9175 PUSH	HL
003226 CD      9176 CALL	COMMA
003227 26   
003228 21   
003229 CD      9177 CALL	EXPRI		;DATA
00322A B7   
00322B 18   
00322C D9      9178 EXX
00322D C1      9179 POP	BC
00322E ED      9180 OUT	(C),L		;OUTPUT TO PORT BC
00322F 69   
003230 C3      9181 JP	XEQ
003231 1D   
003232 25   
003233 CD      9192 ASSIGN:         CALL	GETVAR		;VARIABLE
003234 67   
003235 42   
003236 D8      9193 RET	C		;ILLEGAL VARIABLE
003237 C4      9194 CALL	NZ,PUTVAR
003238 51   
003239 42   
00323A 57      9195 LD	D,A		;Type
00323B CD      9196 CALL	NXT
00323C 8F   
00323D 45   
00323E FD      9197 INC	IY
00323F 23   
003240 5F      9198 LD	E,A		;Operator (or =)
003241 FE      9199 CP	'='
003242 3D   
003243 C4      9200 CALL	NZ,EQUALS
003244 D3   
003245 35   
003246 7A      9201 LD	A,D
003247 E6      9202 AND	11000000B
003248 C0   
003249 C0      9203 RET	NZ		;String or array
00324A D5      9204 PUSH	DE
00324B E5      9205 PUSH	HL
00324C CD      9206 CALL	EXPRN
00324D B0   
00324E 18   
00324F DD      9207 POP	IX
003250 E1   
003251 D1      9208 POP	DE
003252 7B      9219 MODIFY:         LD	A,E
003253 FE      9220 CP	'='
003254 3D   
003255 28      9221 JR	Z,STORE0	;Simple assignment
003256 1C   
003257 D5      9222 PUSH	DE
003258 D9      9223 EXX
003259 EB      9224 EX	DE,HL
00325A D9      9225 EXX
00325B EB      9226 EX	DE,HL
00325C 41      9227 LD	B,C
00325D E3      9228 EX	(SP),HL
00325E 7C      9229 LD	A,H
00325F E3      9230 EX	(SP),HL
003260 CD      9231 CALL	LOADN
003261 A9   
003262 19   
003263 E3      9232 EX	(SP),HL
003264 7D      9233 LD	A,L
003265 E3      9234 EX	(SP),HL
003266 E6      9235 AND	15
003267 0F   
003268 DD      9236 PUSH	IX
003269 E5   
00326A CD      9237 CALL	FPP
00326B 99   
00326C 45   
00326D DD      9238 POP	IX
00326E E1   
00326F D1      9239 POP	DE
003270 DA      9240 JP	C,ERROR_
003271 C8   
003272 3F   
003273 7A      9241 STORE0:         LD	A,D		;Type
003274 FE      9242 STOREN:         CP	5
003275 05   
003276 28      9243 JR	Z,STORE5
003277 12   
003278 F5      9244 PUSH	AF
003279 0C      9245 INC	C		;SPEED - & PRESERVE F'
00327A 0D      9246 DEC	C		; WHEN CALLED BY FNEND0
00327B C4      9247 CALL	NZ,SFIX		;CONVERT TO INTEGER
00327C 9B   
00327D 1C   
00327E F1      9248 POP	AF
00327F FE      9249 CP	4
003280 04   
003281 28      9250 JR	Z,STORE4
003282 0A   
003283 BF      9251 CP	A		;SET ZERO
003284 D9      9252 STORE1:         EXX
003285 DD      9253 LD	(IX+0),L
003286 75   
003287 00   
003288 D9      9254 EXX
003289 C9      9255 RET
00328A DD      9257 STORE5:         LD	(IX+4),C
00328B 71   
00328C 04   
00328D D9      9258 STORE4:         EXX
00328E DD      9259 LD	(IX+0),L
00328F 75   
003290 00   
003291 DD      9260 LD	(IX+1),H
003292 74   
003293 01   
003294 D9      9261 EXX
003295 DD      9262 LD	(IX+2),L
003296 75   
003297 02   
003298 DD      9263 LD	(IX+3),H
003299 74   
00329A 03   
00329B C9      9264 RET
00329C 7D      9273 MODIFS:         LD	A,L		;Operator
00329D FE      9274 CP	'+'
00329E 2B   
00329F 7C      9275 LD	A,H		;Type
0032A0 20      9276 JR	NZ,STACCS
0032A1 20   
0032A2 FD      9277 PUSH	IY
0032A3 E5   
0032A4 DD      9278 PUSH	IX
0032A5 E5   
0032A6 FD      9279 POP	IY
0032A7 E1   
0032A8 CD      9280 CALL	PUSHS
0032A9 9D   
0032AA 20   
0032AB FD      9281 PUSH	IY
0032AC E5   
0032AD DD      9282 POP	IX
0032AE E1   
0032AF CD      9283 CALL	LOADS
0032B0 92   
0032B1 1A   
0032B2 C1      9284 POP	BC
0032B3 78      9285 LD	A,B		;Type
0032B4 0C      9286 INC	C
0032B5 0D      9287 DEC	C
0032B6 28      9288 JR	Z,MODFS1	;Zero length
0032B7 08   
0032B8 21      9289 LD	HL,0
0032B9 00   
0032BA 00   
0032BB 44      9290 LD	B,H
0032BC 39      9291 ADD	HL,SP
0032BD ED      9292 LDIR
0032BE B0   
0032BF F9      9293 LD	SP,HL
0032C0 FD      9294 MODFS1:         POP	IY
0032C1 E1   
0032C2 21      9298 STACCS:         LD	HL,ACCS
0032C3 00   
0032C4 53   
0032C5 1F      9299 STORES:         RRA
0032C6 30      9300 JR	NC,STORS3	;FIXED STRING
0032C7 4F   
0032C8 E5      9301 PUSH	HL
0032C9 CD      9302 CALL	LOAD4
0032CA B6   
0032CB 19   
0032CC 7B      9303 LD	A,E		;LENGTH OF STRING
0032CD D9      9304 EXX
0032CE 6F      9305 LD	L,A
0032CF 7C      9306 LD	A,H		;LENGTH ALLOCATED
0032D0 D9      9307 EXX
0032D1 BB      9308 CP	E
0032D2 30      9309 JR	NC,STORS1	;ENOUGH ROOM
0032D3 24   
0032D4 D9      9310 EXX
0032D5 65      9311 LD	H,L
0032D6 D9      9312 EXX
0032D7 E5      9313 PUSH	HL
0032D8 06      9314 LD	B,0
0032D9 00   
0032DA 4F      9315 LD	C,A
0032DB 09      9316 ADD	HL,BC
0032DC ED      9317 LD	BC,(FREE)
0032DD 4B   
0032DE E0   
0032DF 55   
0032E0 ED      9318 SBC	HL,BC		;IS STRING LAST?
0032E1 42   
0032E2 E1      9319 POP	HL
0032E3 28      9320 JR	Z,STORS0
0032E4 12   
0032E5 60      9321 LD	H,B
0032E6 69      9322 LD	L,C		;DESTINATION
0032E7 B7      9324 OR	A		;V5 optimisation
0032E8 28      9325 JR	Z,STORS0
0032E9 0D   
0032EA 7B      9326 LD	A,E
0032EB 5F      9327 STORS2:         LD	E,A
0032EC 1D      9328 DEC	E
0032ED A3      9329 AND	E
0032EE 20      9330 JR	NZ,STORS2
0032EF FB   
0032F0 37      9331 SCF
0032F1 CB      9332 RL	E
0032F2 13   
0032F3 7B      9333 LD	A,E
0032F4 D9      9334 EXX
0032F5 67      9335 LD	H,A
0032F6 D9      9336 EXX
0032F7 37      9338 STORS0:         SCF
0032F8 CD      9339 STORS1:         CALL	STORE4		;PRESERVES CARRY!
0032F9 8D   
0032FA 32   
0032FB 06      9340 LD	B,0
0032FC 00   
0032FD 4B      9341 LD	C,E
0032FE EB      9342 EX	DE,HL
0032FF E1      9343 POP	HL
003300 0D      9344 DEC	C
003301 0C      9345 INC	C
003302 C8      9346 RET	Z		;NULL STRING
003303 ED      9347 LDIR
003304 B0   
003305 D0      9348 RET	NC		;STRING REPLACED
003306 ED      9349 LD	(FREE),DE
003307 53   
003308 E0   
003309 55   
00330A E5      9350 CHECK:          PUSH	HL
00330B 2A      9351 LD	HL,(FREE)
00330C E0   
00330D 55   
00330E 24      9352 INC	H
00330F ED      9353 SBC	HL,SP
003310 72   
003311 E1      9354 POP	HL
003312 D8      9355 RET	C
003313 AF      9356 XOR	A
003314 C3      9357 JP	ERROR_		;"No room"
003315 C8   
003316 3F   
003317 4B      9359 STORS3:         LD	C,E
003318 DD      9360 PUSH	IX
003319 E5   
00331A D1      9361 POP	DE
00331B AF      9362 XOR	A
00331C 47      9363 LD	B,A
00331D B9      9364 CP	C
00331E 28      9365 JR	Z,STORS5
00331F 02   
003320 ED      9366 LDIR
003321 B0   
003322 3E      9367 STORS5:         LD	A,CR
003323 0D   
003324 12      9368 LD	(DE),A
003325 C9      9369 RET
003326 DD      9373 SAVRET:         LD	(IX+0),L		;Formal VARPTR
003327 75   
003328 00   
003329 DD      9374 LD	(IX+1),H
00332A 74   
00332B 01   
00332C DD      9375 LD	(IX+2),A
00332D 77   
00332E 02   
00332F FD      9376 EX	(SP),IY
003330 E3   
003331 F5      9377 PUSH	AF
003332 FD      9378 PUSH	IY
003333 E5   
003334 DD      9379 PUSH	IX
003335 E5   
003336 CD      9380 CALL	NXT
003337 8F   
003338 45   
003339 CD      9381 CALL	VAR_
00333A 5A   
00333B 26   
00333C DD      9382 POP	IX
00333D E1   
00333E DD      9383 LD	(IX+4),L		;Actual VARPTR
00333F 75   
003340 04   
003341 DD      9384 LD	(IX+5),H
003342 74   
003343 05   
003344 DD      9385 LD	(IX+6),A
003345 77   
003346 06   
003347 FD      9386 POP	IY
003348 E1   
003349 F1      9387 POP	AF
00334A 01      9388 LD	BC,8
00334B 08   
00334C 00   
00334D DD      9389 ADD	IX,BC
00334E 09   
00334F 18      9390 JR	ARGUE0
003350 2D   
003351 3E      9402 ARGUE:          LD	A,-1
003352 FF   
003353 F5      9403 PUSH	AF		;PUT MARKER ON STACK
003354 FD      9404 ARGUE1:         INC	IY		;BUMP PAST ( | ,
003355 23   
003356 13      9405 INC	DE
003357 D5      9406 PUSH	DE
003358 06      9407 LD	B,0
003359 00   
00335A CD      9408 CALL	NXT
00335B 8F   
00335C 45   
00335D FE      9409 CP	TRETURN
00335E F8   
00335F 20      9410 JR	NZ,ARGUE9
003360 06   
003361 FD      9411 INC	IY		;SKIP 'RETURN'
003362 23   
003363 CD      9412 CALL	NXT
003364 8F   
003365 45   
003366 04      9413 INC	B		;FLAG 'RETURN'
003367 C5      9414 ARGUE9:         PUSH	BC
003368 DD      9415 PUSH	IX
003369 E5   
00336A CD      9416 CALL	GETVAR		;FORMAL PARAMETER
00336B 67   
00336C 42   
00336D 38      9417 JR	C,ARGERR
00336E 49   
00336F C4      9418 CALL	NZ,PUTVAR
003370 51   
003371 42   
003372 DD      9419 POP	IX
003373 E1   
003374 C1      9420 POP	BC
003375 D1      9421 POP	DE
003376 E5      9422 PUSH	HL		;VARPTR
003377 F5      9423 PUSH	AF
003378 D5      9424 PUSH	DE
003379 05      9425 DEC	B
00337A 28      9426 JR	Z,SAVRET
00337B AA   
00337C FD      9427 EX	(SP),IY
00337D E3   
00337E CB      9428 ARGUE0:         BIT	6,A		;ARRAY?
00337F 77   
003380 20      9429 JR	NZ,ARGUE3
003381 3B   
003382 B7      9430 OR	A		;TYPE
003383 FA      9431 JP	M,ARGUE2	;STRING
003384 99   
003385 33   
003386 DD      9432 PUSH	IX
003387 E5   
003388 CD      9433 CALL	EXPRN		;ACTUAL PARAMETER
003389 B0   
00338A 18   
00338B DD      9434 POP	IX
00338C E1   
00338D FD      9435 EX	(SP),IY
00338E E3   
00338F D1      9436 POP	DE
003390 F1      9437 POP	AF
003391 D9      9438 EXX
003392 E5      9439 PUSH	HL
003393 D9      9440 EXX
003394 E5      9441 PUSH	HL
003395 47      9442 LD	B,A
003396 C5      9443 PUSH	BC
003397 18      9444 JR	ARGUE4
003398 13   
003399 DD      9446 ARGUE2:         PUSH	IX
00339A E5   
00339B CD      9447 CALL	EXPRS
00339C C0   
00339D 18   
00339E D9      9448 EXX
00339F C1      9449 POP	BC
0033A0 FD      9450 EX	(SP),IY
0033A1 E3   
0033A2 D1      9451 POP	DE
0033A3 D9      9452 EXX
0033A4 F1      9453 POP	AF
0033A5 CD      9454 CALL	PUSHS
0033A6 9D   
0033A7 20   
0033A8 D9      9455 EXX
0033A9 C5      9456 PUSH	BC
0033AA DD      9457 POP	IX
0033AB E1   
0033AC CD      9458 ARGUE4:         CALL	NXT
0033AD 8F   
0033AE 45   
0033AF FE      9459 CP	','
0033B0 2C   
0033B1 20      9460 JR	NZ,ARGUE5
0033B2 27   
0033B3 1A      9461 LD	A,(DE)
0033B4 FE      9462 CP	','
0033B5 2C   
0033B6 28      9463 JR	Z,ARGUE1	;ANOTHER
0033B7 9C   
0033B8 3E      9464 ARGERR:         LD	A,31
0033B9 1F   
0033BA C3      9465 JP	ERROR_		;"Bad arguments"
0033BB C8   
0033BC 3F   
0033BD DD      9467 ARGUE3:         PUSH	IX
0033BE E5   
0033BF CD      9468 CALL	NXT
0033C0 8F   
0033C1 45   
0033C2 CD      9469 CALL	GETVAR
0033C3 67   
0033C4 42   
0033C5 38      9470 JR	C,ARGERR
0033C6 F1   
0033C7 DD      9471 LD	C,(IX+0)
0033C8 4E   
0033C9 00   
0033CA DD      9472 LD	B,(IX+1)
0033CB 46   
0033CC 01   
0033CD DD      9473 POP	IX
0033CE E1   
0033CF CD      9474 CALL	NXT
0033D0 8F   
0033D1 45   
0033D2 FD      9475 EX	(SP),IY
0033D3 E3   
0033D4 D1      9476 POP	DE
0033D5 F1      9477 POP	AF
0033D6 C5      9478 PUSH	BC		;STACK ARRAY POINTER
0033D7 F5      9479 PUSH	AF		;STACK TYPE
0033D8 18      9480 JR	ARGUE4
0033D9 D2   
0033DA CD      9482 ARGUE5:         CALL	BRAKET
0033DB 32   
0033DC 21   
0033DD 1A      9483 LD	A,(DE)
0033DE FE      9484 CP	')'
0033DF 29   
0033E0 20      9485 JR	NZ,ARGERR
0033E1 D6   
0033E2 13      9486 INC	DE
0033E3 D9      9487 UNSTAK:         EXX
0033E4 C1      9488 ARGUE6:         POP	BC
0033E5 78      9489 LD	A,B
0033E6 3C      9490 INC	A
0033E7 D9      9491 EXX
0033E8 C8      9492 RET	Z		;MARKER POPPED
0033E9 D9      9493 EXX
0033EA 3D      9494 DEC	A
0033EB CB      9495 BIT	6,A		;ARRAY
0033EC 77   
0033ED 20      9496 JR	NZ,ARGUE8
0033EE 19   
0033EF B7      9497 OR	A
0033F0 FA      9498 JP	M,ARGUE7	;STRING
0033F1 FE   
0033F2 33   
0033F3 E1      9499 POP	HL
0033F4 D9      9500 EXX
0033F5 E1      9501 POP	HL
0033F6 D9      9502 EXX
0033F7 DD      9503 POP	IX
0033F8 E1   
0033F9 CD      9504 CALL	STOREN		;WRITE TO DUMMY
0033FA 74   
0033FB 32   
0033FC 18      9505 JR	ARGUE6
0033FD E6   
0033FE CD      9507 ARGUE7:         CALL	POPS
0033FF BB   
003400 20   
003401 DD      9508 POP	IX
003402 E1   
003403 CD      9509 CALL	STACCS
003404 C2   
003405 32   
003406 18      9510 JR	ARGUE6
003407 DC   
003408 C1      9512 ARGUE8:         POP	BC		;ARRAY POINTER
003409 DD      9513 POP	IX
00340A E1   
00340B DD      9514 LD	(IX+0),C
00340C 71   
00340D 00   
00340E DD      9515 LD	(IX+1),B
00340F 70   
003410 01   
003411 18      9516 JR	ARGUE6
003412 D1   
003413 3E      9521 RETXFR:         LD	A,-1
003414 FF   
003415 F5      9522 PUSH	AF		;PUT MARKER ON STACK
003416 D9      9523 RETXF1:         EXX
003417 DD      9524 LD	L,(IX+4)	;Actual parameter (destination)
003418 6E   
003419 04   
00341A DD      9525 LD	H,(IX+5)
00341B 66   
00341C 05   
00341D E5      9526 PUSH	HL		;STACK VARPTR
00341E DD      9527 LD	L,(IX+0)	;Formal parameter (source)
00341F 6E   
003420 00   
003421 DD      9528 LD	H,(IX+1)
003422 66   
003423 01   
003424 DD      9529 LD	A,(IX+2)
003425 7E   
003426 02   
003427 CB      9530 BIT	6,A		;ARRAY?
003428 77   
003429 20      9531 JR	NZ,RETXF3
00342A 19   
00342B B7      9532 OR	A		;TYPE
00342C FA      9533 JP	M,RETXF2	;STRING
00342D 4A   
00342E 34   
00342F E5      9534 PUSH	HL
003430 DD      9535 EX	(SP),IX
003431 E3   
003432 CD      9536 CALL	LOADN
003433 A9   
003434 19   
003435 DD      9537 POP	IX
003436 E1   
003437 D9      9538 EXX			;STACK VALUE
003438 E5      9539 PUSH	HL
003439 D9      9540 EXX
00343A E5      9541 PUSH	HL
00343B DD      9542 RETXF6:         LD	B,(IX+6)
00343C 46   
00343D 06   
00343E C5      9543 PUSH	BC		;TYPE & EXPONENT
00343F CD      9544 RETXF5:         CALL	CHECK		;CHECK ROOM
003440 0A   
003441 33   
003442 18      9545 JR	RETXF4
003443 1E   
003444 5E      9547 RETXF3:         LD	E,(HL)
003445 23      9548 INC	HL
003446 56      9549 LD	D,(HL)
003447 D5      9550 PUSH	DE		;STACK ARRAY POINTER
003448 18      9551 JR	RETXF6
003449 F1   
00344A E5      9553 RETXF2:         PUSH	HL
00344B DD      9554 EX	(SP),IX
00344C E3   
00344D CD      9555 CALL	LOADS
00344E 92   
00344F 1A   
003450 DD      9556 POP	IX
003451 E1   
003452 DD      9557 LD	A,(IX+6)
003453 7E   
003454 06   
003455 D9      9558 EXX
003456 DD      9559 PUSH	IX
003457 E5   
003458 E1      9560 POP	HL
003459 D9      9561 EXX
00345A CD      9562 CALL	PUSHS
00345B 9D   
00345C 20   
00345D D9      9563 EXX
00345E E5      9564 PUSH	HL
00345F DD      9565 POP	IX
003460 E1   
003461 D9      9566 EXX
003462 11      9567 RETXF4:         LD	DE,8
003463 08   
003464 00   
003465 DD      9568 ADD	IX,DE
003466 19   
003467 D9      9569 EXX
003468 10      9570 DJNZ	RETXF1
003469 AC   
00346A C3      9571 JP	UNSTAK
00346B E3   
00346C 33   
00346D C1      9575 RESRET:         POP	BC		;B = 'RETURN' COUNT
00346E 26      9576 LD	H,0
00346F 00   
003470 68      9577 LD	L,B
003471 29      9578 ADD	HL,HL
003472 29      9579 ADD	HL,HL
003473 29      9580 ADD	HL,HL		;RETURN COUNT * 8
003474 39      9581 ADD	HL,SP
003475 DD      9582 LD	IX,0
003476 21   
003477 00   
003478 00   
003479 DD      9583 ADD	IX,SP		;ADDRESS PARAMETER LIST
00347A 39   
00347B F5      9584 PUSH	AF
00347C D5      9585 PUSH	DE
00347D E5      9586 PUSH	HL
00347E D9      9587 EXX
00347F C5      9588 PUSH	BC
003480 D5      9589 PUSH	DE
003481 D9      9590 EXX
003482 78      9591 LD	A,B
003483 21      9592 LD	HL,ACCS
003484 00   
003485 53   
003486 11      9593 LD	DE,BUFFER
003487 00   
003488 54   
003489 01      9594 LD	BC,255
00348A FF   
00348B 00   
00348C ED      9595 LDIR
00348D B0   
00348E 47      9596 LD	B,A
00348F CD      9597 CALL	RETXFR		;TRANSFER VIA STACK
003490 13   
003491 34   
003492 21      9598 LD	HL,BUFFER
003493 00   
003494 54   
003495 11      9599 LD	DE,ACCS
003496 00   
003497 53   
003498 01      9600 LD	BC,255
003499 FF   
00349A 00   
00349B ED      9601 LDIR
00349C B0   
00349D D9      9602 EXX
00349E D1      9603 POP	DE
00349F C1      9604 POP	BC
0034A0 D9      9605 EXX
0034A1 E1      9606 POP	HL
0034A2 D1      9607 POP	DE
0034A3 F1      9608 POP	AF
0034A4 18      9609 JR	RESAR1
0034A5 0A   
0034A6 C1      9613 RESARR:         POP	BC
0034A7 CB      9614 BIT	7,B		;String array?
0034A8 78   
0034A9 E1      9615 POP	HL
0034AA C1      9616 POP	BC
0034AB 09      9617 ADD	HL,BC
0034AC 39      9618 ADD	HL,SP
0034AD C4      9619 CALL	NZ,FREESA	;Free string array
0034AE 67   
0034AF 37   
0034B0 F9      9620 RESAR1:         LD	SP,HL
0034B1 DD      9621 INC	IX		;Flag something restored
0034B2 23   
0034B3 18      9622 JR	RESLO1
0034B4 05   
0034B5 D1      9629 RESLOC:         POP	DE		;Return address
0034B6 DD      9630 LD	IX,0		;To flag nothing was restored
0034B7 21   
0034B8 00   
0034B9 00   
0034BA C1      9631 RESLO1:         POP	BC		;Marker ?
0034BB 21      9632 LD	HL,LOCCHK
0034BC AE   
0034BD 35   
0034BE B7      9633 OR	A
0034BF ED      9634 SBC	HL,BC
0034C0 42   
0034C1 28      9635 JR	Z,RESLO2	;Something to restore
0034C2 1A   
0034C3 B7      9636 OR	A
0034C4 20      9637 JR	NZ,RESLO8
0034C5 0F   
0034C6 21      9638 LD	HL,RETCHK
0034C7 F4   
0034C8 2A   
0034C9 ED      9639 SBC	HL,BC
0034CA 42   
0034CB 28      9640 JR	Z,RESRET
0034CC A0   
0034CD 21      9641 LD	HL,ARRCHK
0034CE 60   
0034CF 27   
0034D0 B7      9642 OR	A
0034D1 ED      9643 SBC	HL,BC
0034D2 42   
0034D3 28      9644 JR	Z,RESARR
0034D4 D1   
0034D5 DD      9645 RESLO8:         PUSH	IX
0034D6 E5   
0034D7 E1      9646 POP	HL
0034D8 7C      9647 LD	A,H
0034D9 B5      9648 OR	L
0034DA C5      9649 RESLO0:         PUSH	BC		;Put back marker
0034DB EB      9650 EX	DE,HL
0034DC E9      9651 JP	(HL)		;Return
0034DD DD      9653 RESLO2:         POP	IX		;Variable pointer
0034DE E1   
0034DF B7      9654 OR	A
0034E0 28      9655 JR	Z,RESLO3	;Everything allowed
0034E1 20   
0034E2 DD      9656 PUSH	IX
0034E3 E5   
0034E4 C1      9657 POP	BC
0034E5 CB      9658 BIT	0,A
0034E6 47   
0034E7 28      9659 JR	Z,RESLO6	;Bit 0 set, so
0034E8 07   
0034E9 21      9660 LD	HL,DATPTR	;test for DATPTR
0034EA F0   
0034EB 55   
0034EC ED      9661 SBC	HL,BC
0034ED 42   
0034EE 28      9662 JR	Z,RESLO3
0034EF 12   
0034F0 B7      9663 RESLO6:         OR	A
0034F1 CB      9664 BIT	1,A
0034F2 4F   
0034F3 28      9665 JR	Z,RESLO7	;Bit 1 set, so
0034F4 07   
0034F5 21      9666 LD	HL,ERRTRP	;test for ERRPTR
0034F6 EA   
0034F7 55   
0034F8 ED      9667 SBC	HL,BC
0034F9 42   
0034FA 28      9668 JR	Z,RESLO3
0034FB 06   
0034FC C5      9669 RESLO7:         PUSH	BC		;Put back pointer
0034FD 01      9670 LD	BC,LOCCHK
0034FE AE   
0034FF 35   
003500 18      9671 JR	RESLO0
003501 D8   
003502 C1      9673 RESLO3:         POP	BC		;Type / exponent
003503 CB      9674 BIT	6,B
003504 70   
003505 20      9675 JR	NZ,RESLO4	;Array?
003506 14   
003507 CB      9676 BIT	7,B
003508 78   
003509 20      9677 JR	NZ,RESLO5	;String?
00350A 23   
00350B E1      9678 POP	HL
00350C D9      9679 EXX
00350D E1      9680 POP	HL
00350E D9      9681 EXX
00350F CB      9682 BIT	4,B
003510 60   
003511 20      9683 JR	NZ,RESLO1
003512 A7   
003513 F5      9684 PUSH	AF
003514 78      9685 LD	A,B
003515 CD      9686 CALL	STOREN		;Numeric
003516 74   
003517 32   
003518 F1      9687 POP	AF
003519 18      9688 JR	RESLO1
00351A 9F   
00351B E1      9690 RESLO4:         POP	HL
00351C CB      9691 BIT	4,B
00351D 60   
00351E 20      9692 JR	NZ,RESLO1
00351F 9A   
003520 DD      9693 LD	(IX+0),L	;Array
003521 75   
003522 00   
003523 DD      9694 LD	(IX+1),H
003524 74   
003525 01   
003526 18      9695 JR	RESLO1
003527 92   
003528 06      9697 RESLO9:         LD	B,0
003529 00   
00352A 09      9698 ADD	HL,BC
00352B F9      9699 LD	SP,HL
00352C 18      9700 RESLGO:         JR	RESLO1
00352D 8C   
00352E 21      9702 RESLO5:         LD	HL,0
00352F 00   
003530 00   
003531 39      9703 ADD	HL,SP
003532 CB      9704 BIT	4,B
003533 60   
003534 20      9705 JR	NZ,RESLO9
003535 F2   
003536 F5      9706 PUSH	AF
003537 D5      9707 PUSH	DE
003538 59      9708 LD	E,C
003539 78      9709 LD	A,B
00353A CD      9710 CALL	STORES		;String
00353B C5   
00353C 32   
00353D D1      9711 POP	DE
00353E F1      9712 POP	AF
00353F F9      9713 LD	SP,HL
003540 18      9714 JR	RESLGO
003541 EA   
003542 D1      9724 SAVLOC:         POP	DE		;RETURN ADDRESS
003543 FD      9725 SAVLO1:         INC	IY		;BUMP PAST ( | ,
003544 23   
003545 CD      9726 CALL	NXT
003546 8F   
003547 45   
003548 FE      9727 CP	TRETURN
003549 F8   
00354A 20      9728 JR	NZ,SAVLO6
00354B 08   
00354C 08      9729 EX	AF,AF'
00354D 3C      9730 INC	A		;RETURN counter
00354E 08      9731 EX	AF,AF'
00354F FD      9732 INC	IY		;Bump past RETURN
003550 23   
003551 CD      9733 CALL	NXT
003552 8F   
003553 45   
003554 D5      9734 SAVLO6:         PUSH	DE
003555 D9      9735 EXX
003556 C5      9736 PUSH	BC
003557 D5      9737 PUSH	DE
003558 E5      9738 PUSH	HL
003559 D9      9739 EXX
00355A CD      9740 CALL	VAR_		;DUMMY VARIABLE
00355B 5A   
00355C 26   
00355D D9      9741 EXX
00355E E1      9742 POP	HL
00355F D1      9743 POP	DE
003560 C1      9744 POP	BC
003561 D9      9745 EXX
003562 D1      9746 POP	DE
003563 CB      9747 BIT	6,A		;ARRAY?
003564 77   
003565 20      9748 JR	NZ,SAVLO3
003566 12   
003567 B7      9749 OR	A		;TYPE
003568 FA      9750 JP	M,SAVLO2	;STRING
003569 83   
00356A 35   
00356B D9      9751 EXX
00356C E5      9752 PUSH	HL		;SAVE H'L'
00356D D9      9753 EXX
00356E 47      9754 LD	B,A		;TYPE
00356F CD      9755 CALL	LOADN
003570 A9   
003571 19   
003572 D9      9756 EXX
003573 E3      9757 EX	(SP),HL
003574 D9      9758 EXX
003575 E5      9759 PUSH	HL
003576 C5      9760 PUSH	BC
003577 18      9761 JR	SAVLO4
003578 30   
003579 DD      9763 SAVLO3:         LD	C,(IX+0)	;ARRAY POINTER
00357A 4E   
00357B 00   
00357C DD      9764 LD	B,(IX+1)
00357D 46   
00357E 01   
00357F C5      9765 PUSH	BC		;SAVE TO STACK
003580 F5      9766 PUSH	AF		;SAVE TYPE
003581 18      9767 JR	SAVLO4
003582 26   
003583 F5      9769 SAVLO2:         PUSH	AF		;STRING TYPE
003584 D5      9770 PUSH	DE
003585 D9      9771 EXX
003586 E5      9772 PUSH	HL
003587 D9      9773 EXX
003588 CD      9774 CALL	LOADS
003589 92   
00358A 1A   
00358B D9      9775 EXX
00358C E1      9776 POP	HL
00358D D9      9777 EXX
00358E 4B      9778 LD	C,E
00358F D1      9779 POP	DE
003590 CD      9780 CALL	CHECK
003591 0A   
003592 33   
003593 F1      9781 POP	AF		;LEVEL STACK
003594 21      9782 LD	HL,0
003595 00   
003596 00   
003597 45      9783 LD	B,L
003598 ED      9784 SBC	HL,BC
003599 42   
00359A 39      9785 ADD	HL,SP
00359B F9      9786 LD	SP,HL
00359C 47      9787 LD	B,A		;TYPE
00359D C5      9788 PUSH	BC
00359E 28      9789 JR	Z,SAVLO4
00359F 09   
0035A0 D5      9790 PUSH	DE
0035A1 11      9791 LD	DE,ACCS
0035A2 00   
0035A3 53   
0035A4 EB      9792 EX	DE,HL
0035A5 45      9793 LD	B,L
0035A6 ED      9794 LDIR			;SAVE STRING ON STACK
0035A7 B0   
0035A8 D1      9795 POP	DE
0035A9 DD      9796 SAVLO4:         PUSH	IX		;VARPTR
0035AA E5   
0035AB CD      9797 CALL	SAVLO5
0035AC AE   
0035AD 35   
0035AE CD      9799 SAVLO5:         CALL	CHECK
0035AF 0A   
0035B0 33   
0035B1 CD      9800 CALL	NXT
0035B2 8F   
0035B3 45   
0035B4 FE      9801 CP	','		;MORE?
0035B5 2C   
0035B6 28      9802 JR	Z,SAVLO1
0035B7 8B   
0035B8 EB      9803 EX	DE,HL
0035B9 E9      9804 JP	(HL)		;"RETURN"
0035BA CD      9806 TERMQ:          CALL	NXT
0035BB 8F   
0035BC 45   
0035BD FE      9807 CP	TELSE
0035BE 8B   
0035BF D0      9808 RET	NC
0035C0 FE      9809 CP	':'		;ASSEMBLER SEPARATOR
0035C1 3A   
0035C2 D0      9810 RET	NC
0035C3 FE      9811 CP	CR
0035C4 0D   
0035C5 C9      9812 RET
0035C6 CD      9814 SPAN:           CALL	TERMQ
0035C7 BA   
0035C8 35   
0035C9 C8      9815 RET	Z
0035CA FD      9816 INC	IY
0035CB 23   
0035CC FE      9817 CP	'"'
0035CD 22   
0035CE CC      9818 CALL	Z,QUOTE
0035CF 1D   
0035D0 37   
0035D1 18      9819 JR	SPAN
0035D2 F3   
0035D3 CD      9821 EQUALS:         CALL	NXT
0035D4 8F   
0035D5 45   
0035D6 FD      9822 INC	IY
0035D7 23   
0035D8 FE      9823 CP	'='
0035D9 3D   
0035DA C8      9824 RET	Z
0035DB 3E      9825 LD	A,4
0035DC 04   
0035DD C3      9826 JP	ERROR_		;"Mistake"
0035DE C8   
0035DF 3F   
0035E0 FE      9828 FORMAT:         CP	TTAB
0035E1 8A   
0035E2 28      9829 JR	Z,DOTAB
0035E3 0C   
0035E4 FE      9830 CP	TSPC
0035E5 89   
0035E6 28      9831 JR	Z,DOSPC
0035E7 38   
0035E8 FE      9833 CP	39	; apostrophe
0035E9 27   
0035EA C0      9834 RET	NZ
0035EB CD      9835 CALL	CRLF
0035EC 7F   
0035ED 41   
0035EE AF      9836 XOR	A
0035EF C9      9837 RET
0035F0 C5      9839 DOTAB:          PUSH	BC
0035F1 CD      9840 CALL	EXPRI
0035F2 B7   
0035F3 18   
0035F4 D9      9841 EXX
0035F5 C1      9842 POP	BC
0035F6 FD      9843 LD	A,(IY)
0035F7 7E   
0035F8 00   
0035F9 FE      9844 CP	','
0035FA 2C   
0035FB 28      9845 JR	Z,DOTAB1
0035FC 11   
0035FD CD      9846 CALL	BRAKET
0035FE 32   
0035FF 21   
003600 7D      9847 LD	A,L
003601 21      9848 TABIT:          LD	HL,COUNT
003602 FB   
003603 55   
003604 BE      9849 CP	(HL)
003605 C8      9850 RET	Z
003606 F5      9851 PUSH	AF
003607 DC      9852 CALL	C,CRLF
003608 7F   
003609 41   
00360A F1      9853 POP	AF
00360B 96      9854 SUB	(HL)
00360C 18      9855 JR	SPACES
00360D 19   
00360E FD      9856 DOTAB1:         INC	IY
00360F 23   
003610 C5      9857 PUSH	BC
003611 E5      9858 PUSH	HL
003612 CD      9859 CALL	EXPRI
003613 B7   
003614 18   
003615 D9      9860 EXX
003616 D1      9861 POP	DE
003617 C1      9862 POP	BC
003618 CD      9863 CALL	BRAKET
003619 32   
00361A 21   
00361B CD      9864 CALL	PUTCSR
00361C 20   
00361D 0E   
00361E AF      9865 XOR	A
00361F C9      9866 RET
003620 C5      9868 DOSPC:          PUSH	BC
003621 CD      9869 CALL	ITEMI
003622 E4   
003623 18   
003624 D9      9870 EXX
003625 7D      9871 LD	A,L
003626 C1      9872 POP	BC
003627 B7      9873 SPACES:         OR	A
003628 C8      9874 RET	Z
003629 C5      9875 PUSH	BC
00362A 47      9876 LD	B,A
00362B 3E      9877 FILL1:          LD	A,' '
00362C 20   
00362D CD      9878 CALL	OUTCHR
00362E 86   
00362F 41   
003630 10      9879 DJNZ	FILL1
003631 F9   
003632 C1      9880 POP	BC
003633 AF      9881 XOR	A
003634 C9      9882 RET
003635 21      9884 PTEXT:          LD	HL,ACCS
003636 00   
003637 53   
003638 1C      9885 INC	E
003639 1D      9886 PTEXT1:         DEC	E
00363A C8      9887 RET	Z
00363B 7E      9888 LD	A,(HL)
00363C 23      9889 INC	HL
00363D CD      9890 CALL	OUTCHR
00363E 86   
00363F 41   
003640 18      9891 JR	PTEXT1
003641 F7   
003642 F5      9893 FETCHS:         PUSH	AF
003643 C5      9894 PUSH	BC
003644 E5      9895 PUSH	HL
003645 FD      9896 EX	(SP),IY
003646 E3   
003647 CD      9897 CALL	XTRACT
003648 5F   
003649 36   
00364A CD      9898 CALL	NXT
00364B 8F   
00364C 45   
00364D FD      9899 EX	(SP),IY
00364E E3   
00364F E1      9900 POP	HL
003650 C1      9901 POP	BC
003651 F1      9902 POP	AF
003652 C9      9903 RET
003653 11      9905 LINES:          LD	DE,ACCS
003654 00   
003655 53   
003656 7E      9906 LINE1S:         LD	A,(HL)
003657 12      9907 LD	(DE),A
003658 FE      9908 CP	CR
003659 0D   
00365A C8      9909 RET	Z
00365B 23      9910 INC	HL
00365C 1C      9911 INC	E
00365D 18      9912 JR	LINE1S
00365E F7   
00365F CD      9914 XTRACT:         CALL	NXT
003660 8F   
003661 45   
003662 FE      9915 CP	'"'
003663 22   
003664 FD      9916 INC	IY
003665 23   
003666 CA      9917 JP	Z,CONS
003667 FE   
003668 19   
003669 FD      9918 DEC	IY
00366A 2B   
00366B 11      9919 LD	DE,ACCS
00366C 00   
00366D 53   
00366E FD      9920 XTRAC1:         LD	A,(IY)
00366F 7E   
003670 00   
003671 12      9921 LD	(DE),A
003672 FE      9922 CP	','
003673 2C   
003674 C8      9923 RET	Z
003675 FE      9924 CP	CR
003676 0D   
003677 C8      9925 RET	Z
003678 FD      9926 INC	IY
003679 23   
00367A 1C      9927 INC	E
00367B 18      9928 JR	XTRAC1
00367C F1   
00367D 3E      9930 DSRCH:          LD	A,TDATA
00367E DC   
00367F 06      9931 SEARCHex:         LD	B,0
003680 00   
003681 4E      9932 SRCH1:          LD	C,(HL)
003682 0C      9933 INC	C
003683 0D      9934 DEC	C
003684 28      9935 JR	Z,SRCH2		;FAIL
003685 0C   
003686 23      9936 INC	HL
003687 23      9937 INC	HL
003688 23      9938 INC	HL
003689 BE      9939 CP	(HL)
00368A C8      9940 RET	Z
00368B 0D      9941 DEC	C
00368C 0D      9942 DEC	C
00368D 0D      9943 DEC	C
00368E 09      9944 ADD	HL,BC
00368F C3      9945 JP	SRCH1
003690 81   
003691 36   
003692 2B      9946 SRCH2:          DEC	HL		;POINT TO CR
003693 37      9947 SCF
003694 C9      9948 RET
003695 2E      9962 NSCAN:          LD	L,0		;nest level
003696 00   
003697 FD      9963 NSCAN1:         LD	A,(IY)		;get line length
003698 7E   
003699 00   
00369A B7      9964 OR	A		;test zero = end of prog
00369B 28      9965 JR	Z,NSCAN6
00369C 34   
00369D FD      9966 LD	A,(IY+3)	;initial token
00369E 7E   
00369F 03   
0036A0 B8      9967 CP	B		;test value reqd
0036A1 28      9968 JR	Z,NSCAN3	;found (1)
0036A2 1D   
0036A3 B9      9969 CP	C
0036A4 28      9970 JR	Z,NSCAN3	;found (2)
0036A5 1A   
0036A6 BA      9971 NSCAN7:         CP	D		;unnest?
0036A7 28      9972 JR	Z,NSCAN5
0036A8 22   
0036A9 C5      9973 NSCAN2:         PUSH	BC
0036AA 06      9974 LD	B,0
0036AB 00   
0036AC FD      9975 LD	C,(IY)
0036AD 4E   
0036AE 00   
0036AF FD      9976 ADD	IY,BC		;go to next line
0036B0 09   
0036B1 FD      9977 LD	A,(IY-2)
0036B2 7E   
0036B3 FE   
0036B4 BB      9978 CP	E		;nest?
0036B5 79      9979 LD	A,C
0036B6 C1      9980 POP	BC
0036B7 20      9981 JR	NZ,NSCAN1	;continue
0036B8 DE   
0036B9 FE      9982 CP	5		;empty line ?
0036BA 05   
0036BB 38      9983 JR	C,NSCAN1	;continue
0036BC DA   
0036BD 2C      9984 INC	L		;increment nest level
0036BE 18      9985 JR	NSCAN1		;continue
0036BF D7   
0036C0 2C      9987 NSCAN3:         INC	L
0036C1 2D      9988 DEC	L
0036C2 20      9989 JR	NZ,NSCAN7
0036C3 E2   
0036C4 01      9990 NSCAN4:         LD	BC,4
0036C5 04   
0036C6 00   
0036C7 FD      9991 ADD	IY,BC
0036C8 09   
0036C9 AF      9992 XOR	A		;Z
0036CA C9      9993 RET
0036CB 2D      9995 NSCAN5:         DEC	L		;decrement nest level
0036CC F2      9996 JP	P,NSCAN2
0036CD A9   
0036CE 36   
0036CF 18      9997 JR	NSCAN4
0036D0 F3   
0036D1 F6      9999 NSCAN6:         OR	1		;NZ
0036D2 01   
0036D3 C9     10000 RET
0036D4 FD     10012 WSRCH:          LD	A,(IY)
0036D5 7E   
0036D6 00   
0036D7 FD     10013 INC	IY
0036D8 23   
0036D9 FE     10014 CP	'"'
0036DA 22   
0036DB CC     10015 CALL	Z,QUOTE
0036DC 1D   
0036DD 37   
0036DE FE     10016 CP	TREM
0036DF F4   
0036E0 28     10017 JR	Z,WSRCHM
0036E1 22   
0036E2 FE     10018 CP	TEXIT
0036E3 10   
0036E4 28     10019 JR	Z,WSRCHE
0036E5 30   
0036E6 B8     10020 CP	B
0036E7 28     10021 JR	Z,WSRCHX
0036E8 29   
0036E9 B9     10022 CP	C
0036EA 28     10023 JR	Z,WSRCHP
0036EB 23   
0036EC FE     10024 CP	CR
0036ED 0D   
0036EE 20     10025 JR	NZ,WSRCH
0036EF E4   
0036F0 FD     10026 WSRCH1:         LD	A,(IY)			;Line length
0036F1 7E   
0036F2 00   
0036F3 FD     10027 INC	IY
0036F4 23   
0036F5 B7     10028 OR	A
0036F6 CA     10029 JP	Z,END
0036F7 57   
0036F8 25   
0036F9 FD     10030 INC	IY
0036FA 23   
0036FB FD     10031 INC	IY			;Skip line number
0036FC 23   
0036FD FD     10032 LD	A,(IY)
0036FE 7E   
0036FF 00   
003700 FE     10033 CP	TDATA
003701 DC   
003702 20     10034 JR	NZ,WSRCH
003703 D0   
003704 FD     10035 WSRCHM:         LD	A,(IY)
003705 7E   
003706 00   
003707 FD     10036 INC	IY
003708 23   
003709 FE     10037 CP	CR
00370A 0D   
00370B 20     10038 JR	NZ,WSRCHM		;Skip to end of line
00370C F7   
00370D 18     10039 JR	WSRCH1
00370E E1   
00370F 14     10041 WSRCHP:         INC	D
003710 18     10042 JR	WSRCH
003711 C2   
003712 15     10044 WSRCHX:         DEC	D
003713 20     10045 JR	NZ,WSRCH
003714 BF   
003715 C9     10046 RET
003716 CD     10048 WSRCHE:         CALL	NXT
003717 8F   
003718 45   
003719 FD     10049 INC	IY
00371A 23   
00371B 18     10050 JR	WSRCH
00371C B7   
00371D FD     10054 QUOTE:          LD	A,(IY)
00371E 7E   
00371F 00   
003720 FD     10055 INC	IY
003721 23   
003722 FE     10056 CP	CR
003723 0D   
003724 CA     10057 JP	Z,MISQUO
003725 2C   
003726 37   
003727 FE     10058 CP	'"'
003728 22   
003729 20     10059 JR	NZ,QUOTE
00372A F2   
00372B C9     10060 RET
00372C 3E     10062 MISQUO:         LD	A,9
00372D 09   
00372E C3     10063 JP	ERROR_		;"Missing quote"
00372F C8   
003730 3F   
003731 62     10072 X14OR5:         LD	H,D
003732 6B     10073 LD	L,E
003733 FE     10074 CP	1
003734 01   
003735 C8     10075 RET	Z
003736 FE     10076 CP	5
003737 05   
003738 29     10077 ADD	HL,HL
003739 D8     10078 RET	C
00373A 29     10079 ADD	HL,HL
00373B D8     10080 RET	C
00373C EB     10081 EX	DE,HL
00373D C0     10082 RET	NZ
00373E 19     10083 ADD	HL,DE
00373F EB     10084 EX	DE,HL
003740 C9     10085 RET
003741 EB     10094 MUL16:          EX	DE,HL
003742 21     10095 LD	HL,0
003743 00   
003744 00   
003745 3E     10096 LD	A,16
003746 10   
003747 29     10097 MUL161:         ADD	HL,HL
003748 D8     10098 RET	C		;OVERFLOW
003749 CB     10099 SLA	E
00374A 23   
00374B CB     10100 RL	D
00374C 12   
00374D 30     10101 JR	NC,MUL162
00374E 02   
00374F 09     10102 ADD	HL,BC
003750 D8     10103 RET	C
003751 3D     10104 MUL162:         DEC	A
003752 20     10105 JR	NZ,MUL161
003753 F3   
003754 C9     10106 RET
003755 CD     10108 CHANEL:         CALL	NXT
003756 8F   
003757 45   
003758 FE     10109 CP	'#'
003759 23   
00375A 3E     10110 LD	A,45
00375B 2D   
00375C C2     10111 JP	NZ,ERROR_	;"Missing #"
00375D C8   
00375E 3F   
00375F FD     10112 CHNL:           INC	IY		;SKIP '#'
003760 23   
003761 CD     10113 CALL	ITEMI
003762 E4   
003763 18   
003764 D9     10114 EXX
003765 EB     10115 EX	DE,HL
003766 C9     10116 RET
003767 F5     10124 FREESA:         PUSH	AF
003768 C5     10125 FREES0:         PUSH	BC
003769 D5     10126 PUSH	DE
00376A E5     10127 PUSH	HL
00376B AF     10128 XOR	A
00376C 50     10129 LD	D,B
00376D 59     10130 LD	E,C
00376E 47     10131 LD	B,A
00376F D5     10132 FREES1:         PUSH	DE
003770 2B     10133 DEC	HL
003771 56     10134 LD	D,(HL)
003772 2B     10135 DEC	HL
003773 5E     10136 LD	E,(HL)
003774 2B     10137 DEC	HL
003775 4E     10138 LD	C,(HL)
003776 2B     10139 DEC	HL
003777 E5     10140 PUSH	HL
003778 2A     10141 LD	HL,(FREE)
003779 E0   
00377A 55   
00377B EB     10142 EX	DE,HL
00377C 09     10143 ADD	HL,BC
00377D ED     10144 SBC	HL,DE
00377E 52   
00377F 20     10145 JR	NZ,FREES2
003780 07   
003781 19     10146 ADD	HL,DE
003782 ED     10147 SBC	HL,BC
003783 42   
003784 22     10148 LD	(FREE),HL
003785 E0   
003786 55   
003787 B4     10149 OR	H
003788 D1     10150 FREES2:         POP	DE
003789 E1     10151 POP	HL
00378A 0E     10152 LD	C,4
00378B 04   
00378C B7     10153 OR	A
00378D ED     10154 SBC	HL,BC
00378E 42   
00378F EB     10155 EX	DE,HL
003790 20     10156 JR	NZ,FREES1
003791 DD   
003792 B7     10157 OR	A
003793 E1     10158 POP	HL
003794 D1     10159 POP	DE
003795 C1     10160 POP	BC
003796 B7     10161 OR	A
003797 20     10162 JR	NZ,FREES0
003798 CF   
003799 F1     10163 POP	AF
00379A C9     10164 RET
00379B             10169   ; --- Begin main.asm ---
00379B C3     10327 START:          JP	COLD
00379C C5   
00379D 37   
00379E C3     10328 JP	WARM
00379F 33   
0037A0 38   
0037A1 C3     10329 JP	ESCAPE
0037A2 67   
0037A3 26   
0037A4 C3     10330 JP	EXTERR
0037A5 D9   
0037A6 3F   
0037A7 C3     10331 JP	TELL
0037A8 7E   
0037A9 45   
0037AA C3     10332 JP	TEXT_
0037AB 6C   
0037AC 45   
0037AD C3     10333 JP	ITEMI
0037AE E4   
0037AF 18   
0037B0 C3     10334 JP	EXPRI
0037B1 B7   
0037B2 18   
0037B3 C3     10335 JP	EXPRS
0037B4 C0   
0037B5 18   
0037B6 C3     10336 JP	OSCLI
0037B7 37   
0037B8 0A   
0037B9 C3     10337 JP	OSBGET
0037BA 5D   
0037BB 06   
0037BC C3     10338 JP	OSBPUT
0037BD 65   
0037BE 06   
0037BF C3     10339 JP	OSSTAT
0037C0 6E   
0037C1 06   
0037C2 C3     10340 JP	OSSHUT
0037C3 55   
0037C4 06   
0037C5 21     10341 COLD:           LD	HL,STAVAR	;COLD START
0037C6 00   
0037C7 55   
0037C8 F9     10342 LD	SP,HL
0037C9 36     10343 LD	(HL),10
0037CA 0A   
0037CB 2C     10344 INC	L
0037CC 36     10345 LD	(HL),9
0037CD 09   
0037CE 2C     10346 INC	L
0037CF AF     10347 XOR	A
0037D0 77     10348 PURGE:          LD	(HL),A		;CLEAR SCRATCHPAD
0037D1 2C     10349 INC	L
0037D2 20     10350 JR	NZ,PURGE
0037D3 FC   
0037D4 3E     10351 LD	A,37H		;V3.0
0037D5 37   
0037D6 32     10352 LD	(LISTON),A
0037D7 FE   
0037D8 55   
0037D9 21     10353 LD	HL,NOTICE
0037DA 12   
0037DB 38   
0037DC 22     10354 LD	(ERRTXT),HL
0037DD EE   
0037DE 55   
0037DF CD     10355 CALL	OSINIT
0037E0 82   
0037E1 05   
0037E2 ED     10356 LD	(HIMEM),DE
0037E3 53   
0037E4 E2   
0037E5 55   
0037E6 22     10357 LD	(PAGE_),HL
0037E7 DC   
0037E8 55   
0037E9 CD     10358 CALL	NEWIT
0037EA C2   
0037EB 40   
0037EC C2     10359 JP	NZ,CHAIN0	;AUTO-RUN
0037ED D6   
0037EE 24   
0037EF CD     10360 CALL	TELL
0037F0 7E   
0037F1 45   
0037F2 42     10361 VERMSG:         DB	"BBC BASIC (Z80) Version 5.00  "
0037F3 42   
0037F4 43   
0037F5 20   
0037F6 42   
0037F7 41   
0037F8 53   
0037F9 49   
0037FA 43   
0037FB 20   
0037FC 28   
0037FD 5A   
0037FE 38   
0037FF 30   
003800 29   
003801 20   
003802 56   
003803 65   
003804 72   
003805 73   
003806 69   
003807 6F   
003808 6E   
003809 20   
00380A 35   
00380B 2E   
00380C 30   
00380D 30   
00380E 20   
00380F 20   
003810 0D     10362 DB	CR
003811 0A     10363 DB	LF
003812 28     10364 NOTICE:         DB	"(C) Copyright R.T.Russell 2024"
003813 43   
003814 29   
003815 20   
003816 43   
003817 6F   
003818 70   
003819 79   
00381A 72   
00381B 69   
00381C 67   
00381D 68   
00381E 74   
00381F 20   
003820 52   
003821 2E   
003822 54   
003823 2E   
003824 52   
003825 75   
003826 73   
003827 73   
003828 65   
003829 6C   
00382A 6C   
00382B 20   
00382C 32   
00382D 30   
00382E 32   
00382F 34   
003830 0D     10365 DB	CR
003831 0A     10366 DB	LF
003832 00     10367 DB	0
003833 F6     10368 WARM:           DB	0F6H
003834 37     10369 CLOOP:          SCF
003835 ED     10370 LD	SP,(HIMEM)
003836 7B   
003837 E2   
003838 55   
003839 CD     10371 CALL	PROMPT		;PROMPT USER
00383A 95   
00383B 05   
00383C 21     10372 LD	HL,LISTON
00383D FE   
00383E 55   
00383F 7E     10373 LD	A,(HL)
003840 E6     10374 AND	0FH		;LISTO
003841 0F   
003842 F6     10375 OR	30H		;OPT 3
003843 30   
003844 77     10376 LD	(HL),A
003845 ED     10377 SBC	HL,HL		;HL <- 0 (V3.0)
003846 62   
003847 22     10378 LD	(ERRTRP),HL
003848 EA   
003849 55   
00384A 22     10379 LD	(ONERSP),HL
00384B EC   
00384C 55   
00384D 22     10380 LD	(CURLIN),HL	;For CMOS EDIT->LIST
00384E F4   
00384F 55   
003850 2A     10381 LD	HL,(AUTONO)
003851 E8   
003852 55   
003853 E5     10382 PUSH	HL
003854 7C     10383 LD	A,H
003855 B5     10384 OR	L
003856 28     10385 JR	Z,NOAUTO
003857 17   
003858 E5     10386 PUSH	HL
003859 CD     10387 CALL	PBCD		;AUTO NUMBER
00385A 1A   
00385B 42   
00385C E1     10388 POP	HL
00385D ED     10389 LD	BC,(INCREM)
00385E 4B   
00385F FF   
003860 55   
003861 06     10390 LD	B,0
003862 00   
003863 09     10391 ADD	HL,BC
003864 DA     10392 JP	C,TOOBIGmn
003865 33   
003866 44   
003867 22     10393 LD	(AUTONO),HL
003868 E8   
003869 55   
00386A 3E     10394 LD	A,' '
00386B 20   
00386C CD     10395 CALL	OUTCHR
00386D 86   
00386E 41   
00386F 21     10396 NOAUTO:         LD	HL,ACCS
003870 00   
003871 53   
003872 CD     10397 CALL	OSLINE		;GET CONSOLE INPUT
003873 E9   
003874 05   
003875 AF     10398 XOR	A
003876 32     10399 LD	(COUNT),A
003877 FB   
003878 55   
003879 FD     10400 LD	IY,ACCS
00387A 21   
00387B 00   
00387C 53   
00387D 21     10401 LD	HL,COMNDS
00387E 65   
00387F 3C   
003880 CD     10402 CALL	LEX0
003881 2A   
003882 40   
003883 E1     10403 POP	HL
003884 20     10404 JR	NZ,NOTCMD
003885 19   
003886 87     10405 ADD	A,A
003887 4F     10406 LD	C,A
003888 7C     10407 LD	A,H
003889 B5     10408 OR	L
00388A 20     10409 JR	NZ,INAUTO
00388B 0F   
00388C 47     10410 LD	B,A
00388D 21     10411 LD	HL,CMDTABmn
00388E 95   
00388F 3C   
003890 09     10412 ADD	HL,BC
003891 7E     10413 LD	A,(HL)		;TABLE ENTRY
003892 23     10414 INC	HL
003893 66     10415 LD	H,(HL)
003894 6F     10416 LD	L,A
003895 FD     10417 INC	IY
003896 23   
003897 CD     10418 CALL	NXT
003898 8F   
003899 45   
00389A E9     10419 JP	(HL)		;EXECUTE COMMAND
00389B FD     10421 INAUTO:         LD	IY,ACCS
00389C 21   
00389D 00   
00389E 53   
00389F 7C     10422 NOTCMD:         LD	A,H
0038A0 B5     10423 OR	L
0038A1 CC     10424 CALL	Z,LINNUM
0038A2 0E   
0038A3 44   
0038A4 CD     10425 CALL	NXT
0038A5 8F   
0038A6 45   
0038A7 11     10426 LD	DE,BUFFER
0038A8 00   
0038A9 54   
0038AA 0E     10427 LD	C,1		;LEFT MODE
0038AB 01   
0038AC E5     10428 PUSH	HL
0038AD CD     10429 CALL	LEXAN2		;LEXICAL ANALYSIS
0038AE 9C   
0038AF 44   
0038B0 E1     10430 POP	HL
0038B1 12     10431 LD	(DE),A		;TERMINATOR
0038B2 AF     10432 XOR	A
0038B3 47     10433 LD	B,A
0038B4 4B     10434 LD	C,E		;BC=LINE LENGTH
0038B5 13     10435 INC	DE
0038B6 12     10436 LD	(DE),A		;ZERO NEXT
0038B7 7C     10437 LD	A,H
0038B8 B5     10438 OR	L
0038B9 FD     10439 LD	IY,BUFFER	;FOR XEQ
0038BA 21   
0038BB 00   
0038BC 54   
0038BD CA     10440 JP	Z,XEQ		;DIRECT MODE
0038BE 1D   
0038BF 25   
0038C0 C5     10441 PUSH	BC
0038C1 CD     10442 CALL	FINDL
0038C2 C7   
0038C3 41   
0038C4 CC     10443 CALL	Z,DEL
0038C5 6D   
0038C6 40   
0038C7 C1     10444 POP	BC
0038C8 79     10445 LD	A,C
0038C9 B7     10446 OR	A
0038CA 28     10447 JR	Z,CLOOP2	;DELETE LINE ONLY
0038CB 39   
0038CC C6     10448 ADD	A,4
0038CD 04   
0038CE 4F     10449 LD	C,A		;LENGTH INCLUSIVE
0038CF D5     10450 PUSH	DE		;LINE NUMBER
0038D0 C5     10451 PUSH	BC		;SAVE LINE LENGTH
0038D1 EB     10452 EX	DE,HL
0038D2 C5     10453 PUSH	BC
0038D3 CD     10454 CALL	GETTOP
0038D4 A9   
0038D5 40   
0038D6 C1     10455 POP	BC
0038D7 E5     10456 PUSH	HL
0038D8 09     10457 ADD	HL,BC
0038D9 E5     10458 PUSH	HL
0038DA 24     10459 INC	H
0038DB AF     10460 XOR	A
0038DC ED     10461 SBC	HL,SP
0038DD 72   
0038DE E1     10462 POP	HL
0038DF D2     10463 JP	NC,ERROR_	;"No room"
0038E0 C8   
0038E1 3F   
0038E2 E3     10464 EX	(SP),HL
0038E3 E5     10465 PUSH	HL
0038E4 23     10466 INC	HL
0038E5 B7     10467 OR	A
0038E6 ED     10468 SBC	HL,DE
0038E7 52   
0038E8 44     10469 LD	B,H		;BC=AMOUNT TO MOVE
0038E9 4D     10470 LD	C,L
0038EA E1     10471 POP	HL
0038EB D1     10472 POP	DE
0038EC 28     10473 JR	Z,ATEND
0038ED 02   
0038EE ED     10474 LDDR			;MAKE SPACE
0038EF B8   
0038F0 C1     10475 ATEND:          POP	BC		;LINE LENGTH
0038F1 D1     10476 POP	DE		;LINE NUMBER
0038F2 23     10477 INC	HL
0038F3 71     10478 LD	(HL),C		;STORE LENGTH
0038F4 23     10479 INC	HL
0038F5 73     10480 LD	(HL),E		;STORE LINE NUMBER
0038F6 23     10481 INC	HL
0038F7 72     10482 LD	(HL),D
0038F8 23     10483 INC	HL
0038F9 11     10484 LD	DE,BUFFER
0038FA 00   
0038FB 54   
0038FC EB     10485 EX	DE,HL
0038FD 0D     10486 DEC	C
0038FE 0D     10487 DEC	C
0038FF 0D     10488 DEC	C
003900 ED     10489 LDIR			;ADD LINE
003901 B0   
003902 CD     10490 CALL	CLEAN
003903 9E   
003904 40   
003905 C3     10491 CLOOP2:         JP	CLOOP
003906 34   
003907 38   
003908 80     10498 KEYWDS:         DB	80H
003909 41     10499 DB	"AND"
00390A 4E   
00390B 44   
00390C 94     10500 DB	94H
00390D 41     10501 DB	"ABS"
00390E 42   
00390F 53   
003910 95     10502 DB	95H
003911 41     10503 DB	"ACS"
003912 43   
003913 53   
003914 96     10504 DB	96H
003915 41     10505 DB	"ADVAL"
003916 44   
003917 56   
003918 41   
003919 4C   
00391A 97     10506 DB	97H
00391B 41     10507 DB	"ASC"
00391C 53   
00391D 43   
00391E 98     10508 DB	98H
00391F 41     10509 DB	"ASN"
003920 53   
003921 4E   
003922 99     10510 DB	99H
003923 41     10511 DB	"ATN"
003924 54   
003925 4E   
003926 9A     10512 DB	9AH
003927 42     10513 DB	"BGET "
003928 47   
003929 45   
00392A 54   
00392B 20   
00392C D5     10514 DB	0D5H
00392D 42     10515 DB	"BPUT "
00392E 50   
00392F 55   
003930 54   
003931 20   
003932 0F     10516 DB	0FH
003933 42     10517 DB	"BY "		; v5
003934 59   
003935 20   
003936 FB     10518 DB	0FBH
003937 43     10519 DB	"COLOUR"
003938 4F   
003939 4C   
00393A 4F   
00393B 55   
00393C 52   
00393D FB     10520 DB	0FBH
00393E 43     10521 DB	"COLOR"
00393F 4F   
003940 4C   
003941 4F   
003942 52   
003943 D6     10522 DB	0D6H
003944 43     10523 DB	"CALL"
003945 41   
003946 4C   
003947 4C   
003948 C8     10524 DB	0C8H
003949 43     10525 DB	"CASE"		; v5
00394A 41   
00394B 53   
00394C 45   
00394D D7     10526 DB	0D7H
00394E 43     10527 DB	"CHAIN"
00394F 48   
003950 41   
003951 49   
003952 4E   
003953 BD     10528 DB	0BDH
003954 43     10529 DB	"CHR$"
003955 48   
003956 52   
003957 24   
003958 D8     10530 DB	0D8H
003959 43     10531 DB	"CLEAR "
00395A 4C   
00395B 45   
00395C 41   
00395D 52   
00395E 20   
00395F D9     10532 DB	0D9H
003960 43     10533 DB	"CLOSE "
003961 4C   
003962 4F   
003963 53   
003964 45   
003965 20   
003966 DA     10534 DB	0DAH
003967 43     10535 DB	"CLG "
003968 4C   
003969 47   
00396A 20   
00396B DB     10536 DB	0DBH
00396C 43     10537 DB	"CLS "
00396D 4C   
00396E 53   
00396F 20   
003970 9B     10538 DB	9BH
003971 43     10539 DB	"COS"
003972 4F   
003973 53   
003974 9C     10540 DB	9CH
003975 43     10541 DB	"COUNT "
003976 4F   
003977 55   
003978 4E   
003979 54   
00397A 20   
00397B 01     10542 DB	01H
00397C 43     10543 DB	"CIRCLE"	; v5
00397D 49   
00397E 52   
00397F 43   
003980 4C   
003981 45   
003982 DC     10544 DB	0DCH
003983 44     10545 DB	"DATA"
003984 41   
003985 54   
003986 41   
003987 9D     10546 DB	9DH
003988 44     10547 DB	"DEG"
003989 45   
00398A 47   
00398B DD     10548 DB	0DDH
00398C 44     10549 DB	"DEF"
00398D 45   
00398E 46   
00398F 81     10550 DB	81H
003990 44     10551 DB	"DIV"
003991 49   
003992 56   
003993 DE     10552 DB	0DEH
003994 44     10553 DB	"DIM"
003995 49   
003996 4D   
003997 DF     10554 DB	0DFH
003998 44     10555 DB	"DRAW"
003999 52   
00399A 41   
00399B 57   
00399C E1     10556 DB	0E1H
00399D 45     10557 DB	"ENDPROC "
00399E 4E   
00399F 44   
0039A0 50   
0039A1 52   
0039A2 4F   
0039A3 43   
0039A4 20   
0039A5 CE     10558 DB	0CEH
0039A6 45     10559 DB	"ENDWHILE "	; v5
0039A7 4E   
0039A8 44   
0039A9 57   
0039AA 48   
0039AB 49   
0039AC 4C   
0039AD 45   
0039AE 20   
0039AF CB     10560 DB	0CBH
0039B0 45     10561 DB	"ENDCASE "	; v5
0039B1 4E   
0039B2 44   
0039B3 43   
0039B4 41   
0039B5 53   
0039B6 45   
0039B7 20   
0039B8 CD     10562 DB	0CDH
0039B9 45     10563 DB	"ENDIF "	; v5
0039BA 4E   
0039BB 44   
0039BC 49   
0039BD 46   
0039BE 20   
0039BF E0     10564 DB	0E0H
0039C0 45     10565 DB	"END "
0039C1 4E   
0039C2 44   
0039C3 20   
0039C4 E2     10566 DB	0E2H
0039C5 45     10567 DB	"ENVELOPE"
0039C6 4E   
0039C7 56   
0039C8 45   
0039C9 4C   
0039CA 4F   
0039CB 50   
0039CC 45   
0039CD 8B     10568 DB	8BH
0039CE 45     10569 DB	"ELSE"
0039CF 4C   
0039D0 53   
0039D1 45   
0039D2 A0     10570 DB	0A0H
0039D3 45     10571 DB	"EVAL"
0039D4 56   
0039D5 41   
0039D6 4C   
0039D7 9E     10572 DB	9EH
0039D8 45     10573 DB	"ERL "
0039D9 52   
0039DA 4C   
0039DB 20   
0039DC 85     10574 DB	85H
0039DD 45     10575 DB	"ERROR"
0039DE 52   
0039DF 52   
0039E0 4F   
0039E1 52   
0039E2 C5     10576 DB	0C5H
0039E3 45     10577 DB	"EOF "
0039E4 4F   
0039E5 46   
0039E6 20   
0039E7 82     10578 DB	82H
0039E8 45     10579 DB	"EOR"
0039E9 4F   
0039EA 52   
0039EB 9F     10580 DB	9FH
0039EC 45     10581 DB	"ERR "
0039ED 52   
0039EE 52   
0039EF 20   
0039F0 10     10582 DB	10H
0039F1 45     10583 DB	"EXIT "		; v5
0039F2 58   
0039F3 49   
0039F4 54   
0039F5 20   
0039F6 A1     10584 DB	0A1H
0039F7 45     10585 DB	"EXP"
0039F8 58   
0039F9 50   
0039FA A2     10586 DB	0A2H
0039FB 45     10587 DB	"EXT "
0039FC 58   
0039FD 54   
0039FE 20   
0039FF 02     10588 DB	02H
003A00 45     10589 DB	"ELLIPSE"	; v5
003A01 4C   
003A02 4C   
003A03 49   
003A04 50   
003A05 53   
003A06 45   
003A07 E3     10590 DB	0E3H
003A08 46     10591 DB	"FOR"
003A09 4F   
003A0A 52   
003A0B A3     10592 DB	0A3H
003A0C 46     10593 DB	"FALSE "
003A0D 41   
003A0E 4C   
003A0F 53   
003A10 45   
003A11 20   
003A12 03     10594 DB	03H
003A13 46     10595 DB	"FILL"		; v5
003A14 49   
003A15 4C   
003A16 4C   
003A17 A4     10596 DB	0A4H
003A18 46     10597 DB	"FN"
003A19 4E   
003A1A E5     10598 DB	0E5H
003A1B 47     10599 DB	"GOTO"
003A1C 4F   
003A1D 54   
003A1E 4F   
003A1F BE     10600 DB	0BEH
003A20 47     10601 DB	"GET$"
003A21 45   
003A22 54   
003A23 24   
003A24 A5     10602 DB	0A5H
003A25 47     10603 DB	"GET"
003A26 45   
003A27 54   
003A28 E4     10604 DB	0E4H
003A29 47     10605 DB	"GOSUB"
003A2A 4F   
003A2B 53   
003A2C 55   
003A2D 42   
003A2E E6     10606 DB	0E6H
003A2F 47     10607 DB	"GCOL"
003A30 43   
003A31 4F   
003A32 4C   
003A33 93     10608 DB	93H
003A34 48     10609 DB	"HIMEM "
003A35 49   
003A36 4D   
003A37 45   
003A38 4D   
003A39 20   
003A3A E8     10610 DB	0E8H
003A3B 49     10611 DB	"INPUT"
003A3C 4E   
003A3D 50   
003A3E 55   
003A3F 54   
003A40 E7     10612 DB	0E7H
003A41 49     10613 DB	"IF"
003A42 46   
003A43 BF     10614 DB	0BFH
003A44 49     10615 DB	"INKEY$"
003A45 4E   
003A46 4B   
003A47 45   
003A48 59   
003A49 24   
003A4A A6     10616 DB	0A6H
003A4B 49     10617 DB	"INKEY"
003A4C 4E   
003A4D 4B   
003A4E 45   
003A4F 59   
003A50 A8     10618 DB	0A8H
003A51 49     10619 DB	"INT"
003A52 4E   
003A53 54   
003A54 A7     10620 DB	0A7H
003A55 49     10621 DB	"INSTR("
003A56 4E   
003A57 53   
003A58 54   
003A59 52   
003A5A 28   
003A5B 0C     10622 DB	0CH
003A5C 49     10623 DB	"INSTALL"	; v5
003A5D 4E   
003A5E 53   
003A5F 54   
003A60 41   
003A61 4C   
003A62 4C   
003A63 86     10624 DB	86H
003A64 4C     10625 DB	"LINE"
003A65 49   
003A66 4E   
003A67 45   
003A68 92     10626 DB	92H
003A69 4C     10627 DB	"LOMEM "
003A6A 4F   
003A6B 4D   
003A6C 45   
003A6D 4D   
003A6E 20   
003A6F EA     10628 DB	0EAH
003A70 4C     10629 DB	"LOCAL"
003A71 4F   
003A72 43   
003A73 41   
003A74 4C   
003A75 C0     10630 DB	0C0H
003A76 4C     10631 DB	"LEFT$("
003A77 45   
003A78 46   
003A79 54   
003A7A 24   
003A7B 28   
003A7C A9     10632 DB	0A9H
003A7D 4C     10633 DB	"LEN"
003A7E 45   
003A7F 4E   
003A80 E9     10634 DB	0E9H
003A81 4C     10635 DB	"LET"
003A82 45   
003A83 54   
003A84 AB     10636 DB	0ABH
003A85 4C     10637 DB	"LOG"
003A86 4F   
003A87 47   
003A88 AA     10638 DB	0AAH
003A89 4C     10639 DB	"LN"
003A8A 4E   
003A8B C1     10640 DB	0C1H
003A8C 4D     10641 DB	"MID$("
003A8D 49   
003A8E 44   
003A8F 24   
003A90 28   
003A91 EB     10642 DB	0EBH
003A92 4D     10643 DB	"MODE"
003A93 4F   
003A94 44   
003A95 45   
003A96 83     10644 DB	83H
003A97 4D     10645 DB	"MOD"
003A98 4F   
003A99 44   
003A9A EC     10646 DB	0ECH
003A9B 4D     10647 DB	"MOVE"
003A9C 4F   
003A9D 56   
003A9E 45   
003A9F 04     10648 DB	04H
003AA0 4D     10649 DB	"MOUSE"		; v5
003AA1 4F   
003AA2 55   
003AA3 53   
003AA4 45   
003AA5 ED     10650 DB	0EDH
003AA6 4E     10651 DB	"NEXT"
003AA7 45   
003AA8 58   
003AA9 54   
003AAA AC     10652 DB	0ACH
003AAB 4E     10653 DB	"NOT"
003AAC 4F   
003AAD 54   
003AAE EE     10654 DB	0EEH
003AAF 4F     10655 DB	"ON"
003AB0 4E   
003AB1 87     10656 DB	87H
003AB2 4F     10657 DB	"OFF "
003AB3 46   
003AB4 46   
003AB5 20   
003AB6 CA     10658 DB	0CAH
003AB7 4F     10659 DB	"OF "		; v5
003AB8 46   
003AB9 20   
003ABA 05     10660 DB	05H
003ABB 4F     10661 DB	"ORIGIN"	; v5
003ABC 52   
003ABD 49   
003ABE 47   
003ABF 49   
003AC0 4E   
003AC1 84     10662 DB	84H
003AC2 4F     10663 DB	"OR"
003AC3 52   
003AC4 8E     10664 DB	8EH
003AC5 4F     10665 DB	"OPENIN"
003AC6 50   
003AC7 45   
003AC8 4E   
003AC9 49   
003ACA 4E   
003ACB AE     10666 DB	0AEH
003ACC 4F     10667 DB	"OPENOUT"
003ACD 50   
003ACE 45   
003ACF 4E   
003AD0 4F   
003AD1 55   
003AD2 54   
003AD3 AD     10668 DB	0ADH
003AD4 4F     10669 DB	"OPENUP"
003AD5 50   
003AD6 45   
003AD7 4E   
003AD8 55   
003AD9 50   
003ADA FF     10670 DB	0FFH
003ADB 4F     10671 DB	"OSCLI"
003ADC 53   
003ADD 43   
003ADE 4C   
003ADF 49   
003AE0 CC     10672 DB	0CCH
003AE1 4F     10673 DB	"OTHERWISE"	; v5
003AE2 54   
003AE3 48   
003AE4 45   
003AE5 52   
003AE6 57   
003AE7 49   
003AE8 53   
003AE9 45   
003AEA F1     10674 DB	0F1H
003AEB 50     10675 DB	"PRINT"
003AEC 52   
003AED 49   
003AEE 4E   
003AEF 54   
003AF0 90     10676 DB	90H
003AF1 50     10677 DB	"PAGE "
003AF2 41   
003AF3 47   
003AF4 45   
003AF5 20   
003AF6 8F     10678 DB	8FH
003AF7 50     10679 DB	"PTR "
003AF8 54   
003AF9 52   
003AFA 20   
003AFB AF     10680 DB	0AFH
003AFC 50     10681 DB	"PI "
003AFD 49   
003AFE 20   
003AFF F0     10682 DB	0F0H
003B00 50     10683 DB	"PLOT"
003B01 4C   
003B02 4F   
003B03 54   
003B04 B0     10684 DB	0B0H
003B05 50     10685 DB	"POINT("
003B06 4F   
003B07 49   
003B08 4E   
003B09 54   
003B0A 28   
003B0B F2     10686 DB	0F2H
003B0C 50     10687 DB	"PROC"
003B0D 52   
003B0E 4F   
003B0F 43   
003B10 B1     10688 DB	0B1H
003B11 50     10689 DB	"POS "
003B12 4F   
003B13 53   
003B14 20   
003B15 0E     10690 DB	0EH
003B16 50     10691 DB	"PUT"		; Token changed
003B17 55   
003B18 54   
003B19 06     10692 DB	06H
003B1A 51     10693 DB	"QUIT "		; v5
003B1B 55   
003B1C 49   
003B1D 54   
003B1E 20   
003B1F F8     10694 DB	0F8H
003B20 52     10695 DB	"RETURN "
003B21 45   
003B22 54   
003B23 55   
003B24 52   
003B25 4E   
003B26 20   
003B27 F5     10696 DB	0F5H
003B28 52     10697 DB	"REPEAT"
003B29 45   
003B2A 50   
003B2B 45   
003B2C 41   
003B2D 54   
003B2E F6     10698 DB	0F6H
003B2F 52     10699 DB	"REPORT "
003B30 45   
003B31 50   
003B32 4F   
003B33 52   
003B34 54   
003B35 20   
003B36 F3     10700 DB	0F3H
003B37 52     10701 DB	"READ"
003B38 45   
003B39 41   
003B3A 44   
003B3B F4     10702 DB	0F4H
003B3C 52     10703 DB	"REM"
003B3D 45   
003B3E 4D   
003B3F F9     10704 DB	0F9H
003B40 52     10705 DB	"RUN "
003B41 55   
003B42 4E   
003B43 20   
003B44 B2     10706 DB	0B2H
003B45 52     10707 DB	"RAD"
003B46 41   
003B47 44   
003B48 F7     10708 DB	0F7H
003B49 52     10709 DB	"RESTORE"
003B4A 45   
003B4B 53   
003B4C 54   
003B4D 4F   
003B4E 52   
003B4F 45   
003B50 C2     10710 DB	0C2H
003B51 52     10711 DB	"RIGHT$("
003B52 49   
003B53 47   
003B54 48   
003B55 54   
003B56 24   
003B57 28   
003B58 B3     10712 DB	0B3H
003B59 52     10713 DB	"RND "
003B5A 4E   
003B5B 44   
003B5C 20   
003B5D 07     10714 DB	07H
003B5E 52     10715 DB	"RECTANGLE"	; v5
003B5F 45   
003B60 43   
003B61 54   
003B62 41   
003B63 4E   
003B64 47   
003B65 4C   
003B66 45   
003B67 88     10716 DB	88H
003B68 53     10717 DB	"STEP"
003B69 54   
003B6A 45   
003B6B 50   
003B6C B4     10718 DB	0B4H
003B6D 53     10719 DB	"SGN"
003B6E 47   
003B6F 4E   
003B70 B5     10720 DB	0B5H
003B71 53     10721 DB	"SIN"
003B72 49   
003B73 4E   
003B74 B6     10722 DB	0B6H
003B75 53     10723 DB	"SQR"
003B76 51   
003B77 52   
003B78 89     10724 DB	89H
003B79 53     10725 DB	"SPC"
003B7A 50   
003B7B 43   
003B7C C3     10726 DB	0C3H
003B7D 53     10727 DB	"STR$"
003B7E 54   
003B7F 52   
003B80 24   
003B81 C4     10728 DB	0C4H
003B82 53     10729 DB	"STRING$("
003B83 54   
003B84 52   
003B85 49   
003B86 4E   
003B87 47   
003B88 24   
003B89 28   
003B8A D4     10730 DB	0D4H
003B8B 53     10731 DB	"SOUND"
003B8C 4F   
003B8D 55   
003B8E 4E   
003B8F 44   
003B90 FA     10732 DB	0FAH
003B91 53     10733 DB	"STOP "
003B92 54   
003B93 4F   
003B94 50   
003B95 20   
003B96 C6     10734 DB	0C6H
003B97 53     10735 DB	"SUM"		; v5
003B98 55   
003B99 4D   
003B9A 08     10736 DB	08H
003B9B 53     10737 DB	"SWAP"		; v5
003B9C 57   
003B9D 41   
003B9E 50   
003B9F 09     10738 DB	09H
003BA0 53     10739 DB	"SYS"		; v5
003BA1 59   
003BA2 53   
003BA3 B7     10740 DB	0B7H
003BA4 54     10741 DB	"TAN"
003BA5 41   
003BA6 4E   
003BA7 8A     10742 DB	8AH
003BA8 54     10743 DB	"TAB("
003BA9 41   
003BAA 42   
003BAB 28   
003BAC 8C     10744 DB	8CH
003BAD 54     10745 DB	"THEN"
003BAE 48   
003BAF 45   
003BB0 4E   
003BB1 91     10746 DB	91H
003BB2 54     10747 DB	"TIME "
003BB3 49   
003BB4 4D   
003BB5 45   
003BB6 20   
003BB7 0A     10748 DB	0AH
003BB8 54     10749 DB	"TINT"
003BB9 49   
003BBA 4E   
003BBB 54   
003BBC B8     10750 DB	0B8H
003BBD 54     10751 DB	"TO"
003BBE 4F   
003BBF FC     10752 DB	0FCH
003BC0 54     10753 DB	"TRACE"
003BC1 52   
003BC2 41   
003BC3 43   
003BC4 45   
003BC5 B9     10754 DB	0B9H
003BC6 54     10755 DB	"TRUE "
003BC7 52   
003BC8 55   
003BC9 45   
003BCA 20   
003BCB FD     10756 DB	0FDH
003BCC 55     10757 DB	"UNTIL"
003BCD 4E   
003BCE 54   
003BCF 49   
003BD0 4C   
003BD1 BA     10758 DB	0BAH
003BD2 55     10759 DB	"USR"
003BD3 53   
003BD4 52   
003BD5 EF     10760 DB	0EFH
003BD6 56     10761 DB	"VDU"
003BD7 44   
003BD8 55   
003BD9 BB     10762 DB	0BBH
003BDA 56     10763 DB	"VAL"
003BDB 41   
003BDC 4C   
003BDD BC     10764 DB	0BCH
003BDE 56     10765 DB	"VPOS "
003BDF 50   
003BE0 4F   
003BE1 53   
003BE2 20   
003BE3 C7     10766 DB	0C7H
003BE4 57     10767 DB	"WHILE"		; v5
003BE5 48   
003BE6 49   
003BE7 4C   
003BE8 45   
003BE9 C9     10768 DB	0C9H
003BEA 57     10769 DB	"WHEN"		; v5
003BEB 48   
003BEC 45   
003BED 4E   
003BEE 0B     10770 DB	0BH
003BEF 57     10771 DB	"WAIT "		; v5
003BF0 41   
003BF1 49   
003BF2 54   
003BF3 20   
003BF4 FE     10772 DB	0FEH
003BF5 57     10773 DB	"WIDTH"
003BF6 49   
003BF7 44   
003BF8 54   
003BF9 48   
003BFA CF     10775 DB	0CFH
003BFB 50     10776 DB	"PTR"
003BFC 54   
003BFD 52   
003BFE D1     10777 DB	0D1H
003BFF 54     10778 DB	"TIME"
003C00 49   
003C01 4D   
003C02 45   
003C03 D3     10779 DB	0D3H
003C04 48     10780 DB	"HIMEM"
003C05 49   
003C06 4D   
003C07 45   
003C08 4D   
003C09 D2     10781 DB	0D2H
003C0A 4C     10782 DB	"LOMEM"
003C0B 4F   
003C0C 4D   
003C0D 45   
003C0E 4D   
003C0F D0     10783 DB	0D0H
003C10 50     10784 DB	"PAGE"
003C11 41   
003C12 47   
003C13 45   
003C14 11     10786 DB	11H
003C15 4D     10787 DB	"Missing "
003C16 69   
003C17 73   
003C18 73   
003C19 69   
003C1A 6E   
003C1B 67   
003C1C 20   
003C1D 12     10788 DB	12H
003C1E 4E     10789 DB	"No such "
003C1F 6F   
003C20 20   
003C21 73   
003C22 75   
003C23 63   
003C24 68   
003C25 20   
003C26 13     10790 DB	13H
003C27 42     10791 DB	"Bad "
003C28 61   
003C29 64   
003C2A 20   
003C2B 14     10792 DB	14H
003C2C 20     10793 DB	" range"
003C2D 72   
003C2E 61   
003C2F 6E   
003C30 67   
003C31 65   
003C32 15     10794 DB	15H
003C33 76     10795 DB	"variable"
003C34 61   
003C35 72   
003C36 69   
003C37 61   
003C38 62   
003C39 6C   
003C3A 65   
003C3B 16     10796 DB	16H
003C3C 4F     10797 DB	"Out of"
003C3D 75   
003C3E 74   
003C3F 20   
003C40 6F   
003C41 66   
003C42 17     10798 DB	17H
003C43 4E     10799 DB	"No "
003C44 6F   
003C45 20   
003C46 18     10800 DB	18H
003C47 20     10801 DB	" space"
003C48 73   
003C49 70   
003C4A 61   
003C4B 63   
003C4C 65   
003C4D 19     10802 DB	19H
003C4E 4E     10803 DB	"Not in a "
003C4F 6F   
003C50 74   
003C51 20   
003C52 69   
003C53 6E   
003C54 20   
003C55 61   
003C56 20   
003C57 1A     10804 DB	1AH
003C58 20     10805 DB	" loop"
003C59 6C   
003C5A 6F   
003C5B 6F   
003C5C 70   
003C5D 1B     10806 DB	1BH
003C5E 20     10807 DB	" not "
003C5F 6E   
003C60 6F   
003C61 74   
003C62 20   
003C63 FF     10809 DW	-1
003C64 FF   
003C65 80     10813 COMNDS:         DB	80H
003C66 41     10814 DB	"AUTO"
003C67 55   
003C68 54   
003C69 4F   
003C6A 81     10815 DB	81H
003C6B 44     10816 DB	"DELETE"
003C6C 45   
003C6D 4C   
003C6E 45   
003C6F 54   
003C70 45   
003C71 82     10817 DB	82H
003C72 4C     10818 DB	"LIST"
003C73 49   
003C74 53   
003C75 54   
003C76 83     10819 DB	83H
003C77 4C     10820 DB	"LOAD"
003C78 4F   
003C79 41   
003C7A 44   
003C7B 84     10821 DB	84H
003C7C 4E     10822 DB	"NEW "
003C7D 45   
003C7E 57   
003C7F 20   
003C80 85     10823 DB	85H
003C81 4F     10824 DB	"OLD "
003C82 4C   
003C83 44   
003C84 20   
003C85 86     10825 DB	86H
003C86 52     10826 DB	"RENUMBER"
003C87 45   
003C88 4E   
003C89 55   
003C8A 4D   
003C8B 42   
003C8C 45   
003C8D 52   
003C8E 87     10827 DB	87H
003C8F 53     10828 DB	"SAVE"
003C90 41   
003C91 56   
003C92 45   
003C93 FF     10829 DW	-1
003C94 FF   
003C95 67     10833 CMDTABmn:         DW	AUTO
003C96 3F   
003C97 0A     10834 DW	DELETE
003C98 3E   
003C99 32     10835 DW	LIST
003C9A 3E   
003C9B 86     10836 DW	LOAD
003C9C 3F   
003C9D 81     10837 DW	NEW
003C9E 3F   
003C9F 94     10838 DW	OLD
003CA0 3F   
003CA1 B7     10839 DW	RENUM
003CA2 3E   
003CA3 AD     10840 DW	SAVE
003CA4 3F   
003CA5 17     10844 ERRWDS:         DB	17H
003CA6 72     10845 DB	"room"
003CA7 6F   
003CA8 6F   
003CA9 6D   
003CAA 00     10846 DB	0
003CAB 16     10847 DB	16H
003CAC 14     10848 DB	14H
003CAD 00     10849 DW	0
003CAE 00   
003CAF 4D     10850 DB	"Multiple label"
003CB0 75   
003CB1 6C   
003CB2 74   
003CB3 69   
003CB4 70   
003CB5 6C   
003CB6 65   
003CB7 20   
003CB8 6C   
003CB9 61   
003CBA 62   
003CBB 65   
003CBC 6C   
003CBD 00     10851 DB	0
003CBE 4D     10852 DB	"Mistake"
003CBF 69   
003CC0 73   
003CC1 74   
003CC2 61   
003CC3 6B   
003CC4 65   
003CC5 00     10853 DB	0
003CC6 11     10854 DB	11H
003CC7 2C     10855 DB	','
003CC8 00     10856 DB	0
003CC9 54     10857 DB	"Type mismatch"
003CCA 79   
003CCB 70   
003CCC 65   
003CCD 20   
003CCE 6D   
003CCF 69   
003CD0 73   
003CD1 6D   
003CD2 61   
003CD3 74   
003CD4 63   
003CD5 68   
003CD6 00     10858 DB	0
003CD7 19     10859 DB	19H
003CD8 A4     10860 DB	TFN
003CD9 00     10861 DW	0
003CDA 00   
003CDB 11     10862 DB	11H
003CDC 22     10863 DB	'"'
003CDD 00     10864 DB	0
003CDE 13     10865 DB	13H
003CDF DE     10866 DB	TDIM
003CE0 00     10867 DB	0
003CE1 DE     10868 DB	TDIM
003CE2 18     10869 DB	18H
003CE3 00     10870 DB	0
003CE4 19     10871 DB	19H
003CE5 A4     10872 DB	TFN
003CE6 20     10873 DB	" or "
003CE7 6F   
003CE8 72   
003CE9 20   
003CEA F2     10874 DB	TPROC
003CEB 00     10875 DB	0
003CEC 19     10876 DB	19H
003CED F2     10877 DB	TPROC
003CEE 00     10878 DB	0
003CEF 13     10879 DB	13H
003CF0 75     10880 DB	"use of array"
003CF1 73   
003CF2 65   
003CF3 20   
003CF4 6F   
003CF5 66   
003CF6 20   
003CF7 61   
003CF8 72   
003CF9 72   
003CFA 61   
003CFB 79   
003CFC 00     10881 DB	0
003CFD 13     10882 DB	13H
003CFE 73     10883 DB	"subscript"
003CFF 75   
003D00 62   
003D01 73   
003D02 63   
003D03 72   
003D04 69   
003D05 70   
003D06 74   
003D07 00     10884 DB	0
003D08 53     10885 DB	"Syntax error"
003D09 79   
003D0A 6E   
003D0B 74   
003D0C 61   
003D0D 78   
003D0E 20   
003D0F 65   
003D10 72   
003D11 72   
003D12 6F   
003D13 72   
003D14 00     10886 DB	0
003D15 45     10887 DB	"Escape"
003D16 73   
003D17 63   
003D18 61   
003D19 70   
003D1A 65   
003D1B 00     10888 DB	0
003D1C 44     10889 DB	"Division by zero"
003D1D 69   
003D1E 76   
003D1F 69   
003D20 73   
003D21 69   
003D22 6F   
003D23 6E   
003D24 20   
003D25 62   
003D26 79   
003D27 20   
003D28 7A   
003D29 65   
003D2A 72   
003D2B 6F   
003D2C 00     10890 DB	0
003D2D 53     10891 DB	"String too long"
003D2E 74   
003D2F 72   
003D30 69   
003D31 6E   
003D32 67   
003D33 20   
003D34 74   
003D35 6F   
003D36 6F   
003D37 20   
003D38 6C   
003D39 6F   
003D3A 6E   
003D3B 67   
003D3C 00     10892 DB	0
003D3D 4E     10893 DB	"Number too big"
003D3E 75   
003D3F 6D   
003D40 62   
003D41 65   
003D42 72   
003D43 20   
003D44 74   
003D45 6F   
003D46 6F   
003D47 20   
003D48 62   
003D49 69   
003D4A 67   
003D4B 00     10894 DB	0
003D4C 2D     10895 DB	"-ve root"
003D4D 76   
003D4E 65   
003D4F 20   
003D50 72   
003D51 6F   
003D52 6F   
003D53 74   
003D54 00     10896 DB	0
003D55 4C     10897 DB	"Log"
003D56 6F   
003D57 67   
003D58 14     10898 DB	14H
003D59 00     10899 DB	0
003D5A 41     10900 DB	"Accuracy lost"
003D5B 63   
003D5C 63   
003D5D 75   
003D5E 72   
003D5F 61   
003D60 63   
003D61 79   
003D62 20   
003D63 6C   
003D64 6F   
003D65 73   
003D66 74   
003D67 00     10901 DB	0
003D68 45     10902 DB	"Exponent"
003D69 78   
003D6A 70   
003D6B 6F   
003D6C 6E   
003D6D 65   
003D6E 6E   
003D6F 74   
003D70 14     10903 DB	14H
003D71 00     10904 DW	0
003D72 00   
003D73 12     10905 DB	12H
003D74 15     10906 DB	15H
003D75 00     10907 DB	0
003D76 11     10908 DB	11H
003D77 29     10909 DB	')'
003D78 00     10910 DB	0
003D79 13     10911 DB	13H
003D7A 68     10912 DB	"hex or binary"
003D7B 65   
003D7C 78   
003D7D 20   
003D7E 6F   
003D7F 72   
003D80 20   
003D81 62   
003D82 69   
003D83 6E   
003D84 61   
003D85 72   
003D86 79   
003D87 00     10913 DB	0
003D88 12     10914 DB	12H
003D89 A4     10915 DB	TFN
003D8A 2F     10916 DB	'/'
003D8B F2     10917 DB	TPROC
003D8C 00     10918 DB	0
003D8D 13     10919 DB	13H
003D8E 63     10920 DB	"call"
003D8F 61   
003D90 6C   
003D91 6C   
003D92 00     10921 DB	0
003D93 13     10922 DB	13H
003D94 61     10923 DB	"arguments"
003D95 72   
003D96 67   
003D97 75   
003D98 6D   
003D99 65   
003D9A 6E   
003D9B 74   
003D9C 73   
003D9D 00     10924 DB	0
003D9E 19     10925 DB	19H
003D9F E3     10926 DB	TFOR
003DA0 1A     10927 DB	1AH
003DA1 00     10928 DB	0
003DA2 43     10929 DB	"Can't match "
003DA3 61   
003DA4 6E   
003DA5 27   
003DA6 74   
003DA7 20   
003DA8 6D   
003DA9 61   
003DAA 74   
003DAB 63   
003DAC 68   
003DAD 20   
003DAE E3     10930 DB	TFOR
003DAF 00     10931 DB	0
003DB0 13     10932 DB	13H
003DB1 E3     10933 DB	TFOR
003DB2 20     10934 DB	' '
003DB3 15     10935 DB	15H
003DB4 00     10936 DW	0
003DB5 00   
003DB6 11     10937 DB	11H
003DB7 B8     10938 DB	TTO
003DB8 00     10939 DW	0
003DB9 00   
003DBA 17     10940 DB	17H
003DBB E4     10941 DB	TGOSUB
003DBC 00     10942 DB	0
003DBD EE     10943 DB	TON
003DBE 20     10944 DB	" syntax"
003DBF 73   
003DC0 79   
003DC1 6E   
003DC2 74   
003DC3 61   
003DC4 78   
003DC5 00     10945 DB	0
003DC6 EE     10946 DB	TON
003DC7 14     10947 DB	14H
003DC8 00     10948 DB	0
003DC9 12     10949 DB	12H
003DCA 6C     10950 DB	"line"
003DCB 69   
003DCC 6E   
003DCD 65   
003DCE 00     10951 DB	0
003DCF 16     10952 DB	16H
003DD0 20     10953 DB	' '
003DD1 DC     10954 DB	TDATA
003DD2 00     10955 DB	0
003DD3 19     10956 DB	19H
003DD4 F5     10957 DB	TREPEAT
003DD5 1A     10958 DB	1AH
003DD6 00     10959 DB	0
003DD7 13     10960 DB	13H
003DD8 10     10961 DB	TEXIT
003DD9 00     10962 DB	0
003DDA 11     10963 DB	11H
003DDB 23     10964 DB	'#'
003DDC 00     10965 DB	0
003DDD 19     10966 DB	19H		;46 Not in a WHILE loop
003DDE C7     10967 DB	TWHILE
003DDF 1A     10968 DB	1AH
003DE0 00     10969 DB	0
003DE1 11     10970 DB	11H		;47 Missing ENDCASE
003DE2 CB     10971 DB	TENDCASE
003DE3 00     10972 DB	0
003DE4 CA     10973 DB	TOF		;48 OF not last
003DE5 1B     10974 DB	1BH
003DE6 6C     10975 DB	"last"
003DE7 61   
003DE8 73   
003DE9 74   
003DEA 00     10976 DB	0
003DEB 11     10977 DB	11H		;49 Missing ENDIF
003DEC CD     10978 DB	TENDIF
003DED 00     10979 DB	0
003DEE 00     10980 DW	0
003DEF 00   
003DF0 00     10981 DB	0
003DF1 EE     10982 DB	TON		;53 ON ERROR not LOCAL
003DF2 20     10983 DB	' '
003DF3 85     10984 DB	TERROR
003DF4 1B     10985 DB	1BH
003DF5 EA     10986 DB	TLOCAL
003DF6 00     10987 DB	0
003DF7 DC     10988 DB	TDATA		;54 DATA not LOCAL
003DF8 1B     10989 DB	1BH
003DF9 EA     10990 DB	TLOCAL
003DFA 00     10991 DB	0
003DFB E3     10995 TOKADD:         DB	TFOR
003DFC F5     10996 DB	TREPEAT
003DFD C7     10997 DB	TWHILE
003DFE C8     10998 DB	TCASE
003DFF 8B     10999 DB	TELSE
003E00 C9     11000 DB	TWHEN
003E01 CC     11001 DB	TOTHERWISE
003E02 ED     11006 TOKSUB:         DB	TNEXT
003E03 FD     11007 DB	TUNTIL
003E04 CE     11008 DB	TENDWHILE
003E05 CB     11009 DB	TENDCASE
003E06 CD     11010 DB	TENDIF
003E07 8B     11011 DB	TELSE
003E08 C9     11012 DB	TWHEN
003E09 CC     11013 DB	TOTHERWISE
003E0A CD     11020 DELETE:         CALL	DLPAIR
003E0B 5B   
003E0C 44   
003E0D 7E     11021 DELET1:         LD	A,(HL)
003E0E B7     11022 OR	A
003E0F 28     11023 JR	Z,WARMNC
003E10 79   
003E11 23     11024 INC	HL
003E12 5E     11025 LD	E,(HL)
003E13 23     11026 INC	HL
003E14 56     11027 LD	D,(HL)
003E15 2B     11028 DEC	HL
003E16 2B     11029 DEC	HL
003E17 EB     11030 EX	DE,HL
003E18 37     11031 SCF
003E19 ED     11032 SBC	HL,BC
003E1A 42   
003E1B EB     11033 EX	DE,HL
003E1C 30     11034 JR	NC,WARMNC
003E1D 6C   
003E1E C5     11035 PUSH	BC
003E1F CD     11036 CALL	DEL
003E20 6D   
003E21 40   
003E22 C1     11037 POP	BC
003E23 18     11038 JR	DELET1
003E24 E8   
003E25 FD     11042 LISTO:          INC	IY		;SKIP "O"
003E26 23   
003E27 CD     11043 CALL	EXPRI
003E28 B7   
003E29 18   
003E2A D9     11044 EXX
003E2B 7D     11045 LD	A,L
003E2C 32     11046 LD	(LISTON),A
003E2D FE   
003E2E 55   
003E2F C3     11047 JP	CLOOP
003E30 34   
003E31 38   
003E32 FE     11055 LIST:           CP	'O'
003E33 4F   
003E34 28     11056 JR	Z,LISTO
003E35 EF   
003E36 0E     11057 LD	C,1
003E37 01   
003E38 11     11058 LD	DE,BUFFER
003E39 00   
003E3A 54   
003E3B CD     11059 CALL	LEXAN2
003E3C 9C   
003E3D 44   
003E3E 12     11060 LD	(DE),A
003E3F FD     11061 LD	IY,BUFFER
003E40 21   
003E41 00   
003E42 54   
003E43 CD     11062 CALL	DLPAIR
003E44 5B   
003E45 44   
003E46 CD     11063 CALL	NXT
003E47 8F   
003E48 45   
003E49 FE     11064 CP	TIF		;IF CLAUSE ?
003E4A E7   
003E4B 3E     11065 LD	A,0		;INIT IF-CLAUSE LENGTH
003E4C 00   
003E4D 20     11066 JR	NZ,LISTB
003E4E 15   
003E4F FD     11067 INC	IY		;SKIP IF
003E50 23   
003E51 CD     11068 CALL	NXT		;SKIP SPACES (IF ANY)
003E52 8F   
003E53 45   
003E54 EB     11069 EX	DE,HL
003E55 FD     11070 PUSH	IY
003E56 E5   
003E57 E1     11071 POP	HL		;HL ADDRESSES IF CLAUSE
003E58 3E     11072 LD	A,CR
003E59 0D   
003E5A C5     11073 PUSH	BC
003E5B 01     11074 LD	BC,256
003E5C 00   
003E5D 01   
003E5E ED     11075 CPIR			;LOCATE CR
003E5F B1   
003E60 79     11076 LD	A,C
003E61 2F     11077 CPL			;A = SUBSTRING LENGTH
003E62 C1     11078 POP	BC
003E63 EB     11079 EX	DE,HL
003E64 5F     11080 LISTB:          LD	E,A		;IF-CLAUSE LENGTH
003E65 78     11081 LD	A,B
003E66 B1     11082 OR	C
003E67 20     11083 JR	NZ,LISTA
003E68 01   
003E69 0B     11084 DEC	BC
003E6A D9     11085 LISTA:          EXX
003E6B DD     11086 LD	IX,LISTON
003E6C 21   
003E6D FE   
003E6E 55   
003E6F 1E     11087 LD	E,0		;INDENTATION COUNT
003E70 00   
003E71 D9     11088 EXX
003E72 3E     11089 LD	A,20
003E73 14   
003E74 C5     11091 LISTC:          PUSH	BC		;SAVE HIGH LINE NUMBER
003E75 D5     11092 PUSH	DE		;SAVE IF-CLAUSE LENGTH
003E76 E5     11093 PUSH	HL		;SAVE PROGRAM POINTER
003E77 08     11094 EX	AF,AF'
003E78 7E     11095 LD	A,(HL)
003E79 B7     11096 OR	A
003E7A 28     11097 JR	Z,WARMNC
003E7B 0E   
003E7C 7B     11101 LD	A,E		;A = IF-CLAUSE LENGTH
003E7D 23     11102 INC	HL
003E7E 5E     11103 LD	E,(HL)
003E7F 23     11104 INC	HL
003E80 56     11105 LD	D,(HL)		;DE = LINE NUMBER
003E81 2B     11106 DEC	HL
003E82 2B     11107 DEC	HL
003E83 D5     11108 PUSH	DE		;SAVE LINE NUMBER
003E84 EB     11109 EX	DE,HL
003E85 37     11110 SCF
003E86 ED     11111 SBC	HL,BC
003E87 42   
003E88 EB     11112 EX	DE,HL
003E89 D1     11113 POP	DE		;RESTORE LINE NUMBER
003E8A D2     11114 WARMNC:         JP	NC,WARM
003E8B 33   
003E8C 38   
003E8D 4E     11115 LD	C,(HL)		;C = LINE LENGTH + 4
003E8E 47     11116 LD	B,A		;B = IF-CLAUSE LENGTH
003E8F 23     11120 INC	HL
003E90 23     11121 INC	HL
003E91 23     11122 INC	HL		;HL ADDRESSES LINE TEXT
003E92 0D     11123 DEC	C
003E93 0D     11124 DEC	C
003E94 0D     11125 DEC	C
003E95 0D     11126 DEC	C		;C = LINE LENGTH
003E96 D5     11127 PUSH	DE		;SAVE LINE NUMBER
003E97 E5     11128 PUSH	HL		;SAVE LINE ADDRESS
003E98 AF     11129 XOR	A		;A <- 0
003E99 B8     11130 CP	B		;WAS THERE AN IF-CLAUSE
003E9A FD     11131 PUSH	IY
003E9B E5   
003E9C D1     11132 POP	DE		;DE ADDRESSES IF-CLAUSE
003E9D C4     11133 CALL	NZ,SEARCH	;SEARCH FOR IF CLAUSE
003E9E 76   
003E9F 1E   
003EA0 E1     11134 POP	HL		;RESTORE LINE ADDRESS
003EA1 D1     11135 POP	DE		;RESTORE LINE NUMBER
003EA2 FD     11136 PUSH	IY
003EA3 E5   
003EA4 CC     11137 CALL	Z,LISTIT	;LIST IF MATCH
003EA5 E1   
003EA6 40   
003EA7 FD     11138 POP	IY
003EA8 E1   
003EA9 08     11140 EX	AF,AF'
003EAA 3D     11141 DEC	A
003EAB CD     11142 CALL	LTRAP
003EAC 38   
003EAD 06   
003EAE E1     11143 POP	HL		;RESTORE POINTER
003EAF 5E     11144 LD	E,(HL)
003EB0 16     11145 LD	D,0
003EB1 00   
003EB2 19     11146 ADD	HL,DE		;ADDRESS NEXT LINE
003EB3 D1     11147 POP	DE		;RESTORE IF-CLAUSE LEN
003EB4 C1     11148 POP	BC		;RESTORE HI LINE NUMBER
003EB5 18     11149 JR	LISTC
003EB6 BD   
003EB7 CD     11156 RENUM:          CALL	CLEAR		;USES DYNAMIC AREA
003EB8 C7   
003EB9 40   
003EBA CD     11157 CALL	PAIR		;LOAD HL,BC
003EBB 38   
003EBC 44   
003EBD D9     11158 EXX
003EBE 2A     11159 LD	HL,(PAGE_)
003EBF DC   
003EC0 55   
003EC1 ED     11160 LD	DE,(LOMEM)
003EC2 5B   
003EC3 DE   
003EC4 55   
003EC5 7E     11161 RENUM1:         LD	A,(HL)		;BUILD TABLE
003EC6 B7     11162 OR	A
003EC7 28     11163 JR	Z,RENUM2
003EC8 28   
003EC9 23     11164 INC	HL
003ECA 4E     11165 LD	C,(HL)		;OLD LINE NUMBER
003ECB 23     11166 INC	HL
003ECC 46     11167 LD	B,(HL)
003ECD EB     11168 EX	DE,HL
003ECE 71     11169 LD	(HL),C
003ECF 23     11170 INC	HL
003ED0 70     11171 LD	(HL),B
003ED1 23     11172 INC	HL
003ED2 D9     11173 EXX
003ED3 E5     11174 PUSH	HL
003ED4 09     11175 ADD	HL,BC		;ADD INCREMENT
003ED5 DA     11176 JP	C,TOOBIGmn	;"Too big"
003ED6 33   
003ED7 44   
003ED8 D9     11177 EXX
003ED9 C1     11178 POP	BC
003EDA 71     11179 LD	(HL),C
003EDB 23     11180 INC	HL
003EDC 70     11181 LD	(HL),B
003EDD 23     11182 INC	HL
003EDE EB     11183 EX	DE,HL
003EDF 2B     11184 DEC	HL
003EE0 2B     11185 DEC	HL
003EE1 AF     11186 XOR	A
003EE2 47     11187 LD	B,A
003EE3 4E     11188 LD	C,(HL)
003EE4 09     11189 ADD	HL,BC		;NEXT LINE
003EE5 EB     11190 EX	DE,HL
003EE6 E5     11191 PUSH	HL
003EE7 24     11192 INC	H
003EE8 ED     11193 SBC	HL,SP
003EE9 72   
003EEA E1     11194 POP	HL
003EEB EB     11195 EX	DE,HL
003EEC 38     11196 JR	C,RENUM1	;CONTINUE
003EED D7   
003EEE C3     11197 JP	ERROR_		;'No room' (A = 0)
003EEF C8   
003EF0 3F   
003EF1 EB     11199 RENUM2:         EX	DE,HL
003EF2 36     11200 LD	(HL),-1
003EF3 FF   
003EF4 23     11201 INC	HL
003EF5 36     11202 LD	(HL),-1
003EF6 FF   
003EF7 ED     11203 LD	DE,(LOMEM)
003EF8 5B   
003EF9 DE   
003EFA 55   
003EFB D9     11204 EXX
003EFC 2A     11205 LD	HL,(PAGE_)
003EFD DC   
003EFE 55   
003EFF 4E     11206 RENUM3:         LD	C,(HL)
003F00 79     11207 LD	A,C
003F01 B7     11208 OR	A
003F02 28     11209 JR	Z,WARMNC
003F03 86   
003F04 D9     11210 EXX
003F05 EB     11211 EX	DE,HL
003F06 23     11212 INC	HL
003F07 23     11213 INC	HL
003F08 5E     11214 LD	E,(HL)
003F09 23     11215 INC	HL
003F0A 56     11216 LD	D,(HL)
003F0B 23     11217 INC	HL
003F0C D5     11218 PUSH	DE
003F0D EB     11219 EX	DE,HL
003F0E D9     11220 EXX
003F0F D1     11221 POP	DE
003F10 23     11222 INC	HL
003F11 73     11223 LD	(HL),E		;NEW LINE NUMBER
003F12 23     11224 INC	HL
003F13 72     11225 LD	(HL),D
003F14 23     11226 INC	HL
003F15 0D     11227 DEC	C
003F16 0D     11228 DEC	C
003F17 0D     11229 DEC	C
003F18 06     11230 LD	B,0
003F19 00   
003F1A 3E     11231 RENUM7:         LD	A,TLINO
003F1B 8D   
003F1C ED     11232 CPIR			;SEARCH FOR LINE NUMBER
003F1D B1   
003F1E 20     11233 JR	NZ,RENUM3
003F1F DF   
003F20 C5     11234 PUSH	BC
003F21 E5     11235 PUSH	HL
003F22 E5     11236 PUSH	HL
003F23 FD     11237 POP	IY
003F24 E1   
003F25 D9     11238 EXX
003F26 E5     11239 PUSH	HL
003F27 CD     11240 CALL	DECODE		;DECODE LINE NUMBER
003F28 E4   
003F29 1F   
003F2A E1     11241 POP	HL
003F2B D9     11242 EXX
003F2C 44     11243 LD	B,H
003F2D 4D     11244 LD	C,L
003F2E 2A     11245 LD	HL,(LOMEM)
003F2F DE   
003F30 55   
003F31 5E     11246 RENUM4:         LD	E,(HL)		;CROSS-REFERENCE TABLE
003F32 23     11247 INC	HL
003F33 56     11248 LD	D,(HL)
003F34 23     11249 INC	HL
003F35 EB     11250 EX	DE,HL
003F36 B7     11251 OR	A		;CLEAR CARRY
003F37 ED     11252 SBC	HL,BC
003F38 42   
003F39 EB     11253 EX	DE,HL
003F3A 5E     11254 LD	E,(HL)		;NEW NUMBER
003F3B 23     11255 INC	HL
003F3C 56     11256 LD	D,(HL)
003F3D 23     11257 INC	HL
003F3E 38     11258 JR	C,RENUM4
003F3F F1   
003F40 EB     11259 EX	DE,HL
003F41 28     11260 JR	Z,RENUM5	;FOUND
003F42 1A   
003F43 CD     11261 CALL	TELL
003F44 7E   
003F45 45   
003F46 46     11262 DB	"Failed at "
003F47 61   
003F48 69   
003F49 6C   
003F4A 65   
003F4B 64   
003F4C 20   
003F4D 61   
003F4E 74   
003F4F 20   
003F50 00     11263 DB	0
003F51 D9     11264 EXX
003F52 E5     11265 PUSH	HL
003F53 D9     11266 EXX
003F54 E1     11267 POP	HL
003F55 CD     11268 CALL	PBCDL
003F56 16   
003F57 42   
003F58 CD     11269 CALL	CRLF
003F59 7F   
003F5A 41   
003F5B 18     11270 JR	RENUM6
003F5C 06   
003F5D D1     11271 RENUM5:         POP	DE
003F5E D5     11272 PUSH	DE
003F5F 1B     11273 DEC	DE
003F60 CD     11274 CALL	ENCODE		;RE-WRITE NUMBER
003F61 43   
003F62 45   
003F63 E1     11275 RENUM6:         POP	HL
003F64 C1     11276 POP	BC
003F65 18     11277 JR	RENUM7
003F66 B3   
003F67 CD     11284 AUTO:           CALL	PAIR
003F68 38   
003F69 44   
003F6A 22     11285 LD	(AUTONO),HL
003F6B E8   
003F6C 55   
003F6D 79     11286 LD	A,C
003F6E 32     11287 LD	(INCREM),A
003F6F FF   
003F70 55   
003F71 18     11288 JR	CLOOP0
003F72 37   
003F73 CD     11293 BAD:            CALL	TELL		;"Bad program'
003F74 7E   
003F75 45   
003F76 13     11294 DB	13H
003F77 70     11295 DB	"program"
003F78 72   
003F79 6F   
003F7A 67   
003F7B 72   
003F7C 61   
003F7D 6D   
003F7E 0D     11296 DB	CR
003F7F 0A     11297 DB	LF
003F80 00     11298 DB	0
003F81 CD     11299 NEW:            CALL	NEWIT
003F82 C2   
003F83 40   
003F84 18     11300 JR	CLOOP0
003F85 24   
003F86 CD     11304 LOAD:           CALL	EXPRS		;GET FILENAME
003F87 C0   
003F88 18   
003F89 3E     11305 LD	A,CR
003F8A 0D   
003F8B 12     11306 LD	(DE),A
003F8C CD     11307 CALL	LOAD0
003F8D 84   
003F8E 40   
003F8F CD     11308 CALL	CLEAR
003F90 C7   
003F91 40   
003F92 18     11309 JR	WARM0
003F93 31   
003F94 2A     11313 OLD:            LD	HL,(PAGE_)
003F95 DC   
003F96 55   
003F97 E5     11314 PUSH	HL
003F98 23     11315 INC	HL
003F99 23     11316 INC	HL
003F9A 23     11317 INC	HL
003F9B 01     11318 LD	BC,252
003F9C FC   
003F9D 00   
003F9E 3E     11319 LD	A,CR
003F9F 0D   
003FA0 ED     11320 CPIR
003FA1 B1   
003FA2 20     11321 JR	NZ,BAD
003FA3 CF   
003FA4 7D     11322 LD	A,L
003FA5 E1     11323 POP	HL
003FA6 77     11324 LD	(HL),A
003FA7 CD     11325 CALL	CLEAN
003FA8 9E   
003FA9 40   
003FAA C3     11326 CLOOP0:         JP	CLOOP
003FAB 34   
003FAC 38   
003FAD CD     11330 SAVE:           CALL	EXPRS		;FILENAME
003FAE C0   
003FAF 18   
003FB0 3E     11331 LD	A,CR
003FB1 0D   
003FB2 12     11332 LD	(DE),A
003FB3 ED     11333 LD	DE,(PAGE_)
003FB4 5B   
003FB5 DC   
003FB6 55   
003FB7 CD     11334 CALL	GETTOP
003FB8 A9   
003FB9 40   
003FBA B7     11335 OR	A
003FBB ED     11336 SBC	HL,DE
003FBC 52   
003FBD 44     11337 LD	B,H		;LENGTH OF PROGRAM
003FBE 4D     11338 LD	C,L
003FBF 21     11339 LD	HL,ACCS
003FC0 00   
003FC1 53   
003FC2 CD     11340 CALL	OSSAVE
003FC3 C4   
003FC4 07   
003FC5 C3     11341 WARM0:          JP	WARM
003FC6 33   
003FC7 38   
003FC8 21     11346 ERROR_:         LD	HL,ERRWDS
003FC9 A5   
003FCA 3C   
003FCB 4F     11347 LD	C,A
003FCC B7     11348 OR	A
003FCD 28     11349 JR	Z,ERROR1
003FCE 0C   
003FCF 47     11350 LD	B,A		;ERROR NUMBER
003FD0 AF     11351 XOR	A
003FD1 BE     11352 ERROR0:         CP	(HL)
003FD2 23     11353 INC	HL
003FD3 20     11354 JR	NZ,ERROR0
003FD4 FC   
003FD5 10     11355 DJNZ	ERROR0
003FD6 FA   
003FD7 18     11356 JR	ERROR1		;MUST NOT PUSH HL HERE
003FD8 02   
003FD9 E1     11358 EXTERR:         POP	HL
003FDA 4F     11359 LD	C,A
003FDB 22     11360 ERROR1:         LD	(ERRTXT),HL
003FDC EE   
003FDD 55   
003FDE 2A     11361 LD	HL,(ONERSP)
003FDF EC   
003FE0 55   
003FE1 7C     11362 LD	A,H
003FE2 B5     11363 OR	L
003FE3 ED     11364 LD	SP,(HIMEM)	;MUST SET SP BEFORE 'CALL'
003FE4 7B   
003FE5 E2   
003FE6 55   
003FE7 28     11365 JR	Z,ERROR4
003FE8 01   
003FE9 F9     11366 LD	SP,HL
003FEA 79     11367 ERROR4:         LD	A,C		;ERROR NUMBER
003FEB CD     11368 CALL	SETLIN		;SP IS SET NOW
003FEC DF   
003FED 41   
003FEE 32     11369 LD	(ERR),A
003FEF FD   
003FF0 55   
003FF1 22     11370 LD	(ERL),HL
003FF2 F2   
003FF3 55   
003FF4 B7     11371 OR	A
003FF5 28     11372 JR	Z,ERROR2	;'FATAL' ERROR
003FF6 0B   
003FF7 2A     11373 LD	HL,(ERRTRP)
003FF8 EA   
003FF9 55   
003FFA 7C     11374 LD	A,H
003FFB B5     11375 OR	L
003FFC E5     11376 PUSH	HL
003FFD FD     11377 POP	IY
003FFE E1   
003FFF C2     11378 JP	NZ,XEQ		;ERROR TRAPPED
004000 1D   
004001 25   
004002 ED     11379 ERROR2:         LD	SP,(HIMEM)
004003 7B   
004004 E2   
004005 55   
004006 ED     11380 SBC	HL,HL
004007 62   
004008 22     11381 LD	(AUTONO),HL
004009 E8   
00400A 55   
00400B 22     11382 LD	(TRACEN),HL	;CANCEL TRACE
00400C E6   
00400D 55   
00400E CD     11383 CALL	RESET		;RESET OPSYS
00400F 45   
004010 06   
004011 CD     11384 CALL	CRLF
004012 7F   
004013 41   
004014 CD     11385 CALL	REPORT		;MESSAGE
004015 69   
004016 45   
004017 2A     11386 LD	HL,(ERL)
004018 F2   
004019 55   
00401A CD     11387 CALL	SAYLN
00401B 06   
00401C 42   
00401D 1E     11388 LD	E,0
00401E 00   
00401F DC     11389 CALL	C,OSSHUT	;CLOSE ALL FILES
004020 55   
004021 06   
004022 CD     11390 CALL	CRLF
004023 7F   
004024 41   
004025 18     11391 JR	CLOOP0
004026 83   
004027 21     11404 LEX:            LD	HL,KEYWDS
004028 08   
004029 39   
00402A FD     11405 LEX0:           LD	A,(IY)
00402B 7E   
00402C 00   
00402D 46     11406 LD	B,(HL)
00402E 23     11407 INC	HL
00402F BE     11408 CP	(HL)
004030 28     11409 JR	Z,LEX2
004031 0A   
004032 D8     11410 RET	C		;FAIL EXIT
004033 23     11411 LEX1:           INC	HL
004034 7E     11412 LD	A,(HL)
004035 FE     11413 CP	160
004036 A0   
004037 EA     11414 JP	PE,LEX1
004038 33   
004039 40   
00403A 18     11415 JR	LEX0
00403B EE   
00403C FD     11417 LEX2:           PUSH	IY		;SAVE POINTER
00403D E5   
00403E 23     11418 LEX3:           INC	HL
00403F 7E     11419 LD	A,(HL)
004040 FE     11420 CP	160
004041 A0   
004042 E2     11421 JP	PO,LEX6		;FOUND
004043 69   
004044 40   
004045 FD     11422 INC	IY
004046 23   
004047 FD     11423 LD	A,(IY)
004048 7E   
004049 00   
00404A BE     11424 CP	(HL)
00404B 20     11425 JR	NZ,LEX7
00404C 05   
00404D FE     11426 CP	161
00404E A1   
00404F EA     11427 JP	PE,LEX3
004050 3E   
004051 40   
004052 FD     11428 LEX7:           LD	A,(IY)
004053 7E   
004054 00   
004055 FE     11429 CP	'.'
004056 2E   
004057 28     11430 JR	Z,LEX6		;FOUND (ABBREV.)
004058 10   
004059 CD     11431 CALL	RANGE1
00405A 80   
00405B 44   
00405C 38     11432 JR	C,LEX5
00405D 04   
00405E FD     11433 LEX4:           POP	IY		;RESTORE POINTER
00405F E1   
004060 18     11434 JR	LEX1
004061 D1   
004062 7E     11436 LEX5:           LD	A,(HL)
004063 FE     11437 CP	' '
004064 20   
004065 20     11438 JR	NZ,LEX4
004066 F7   
004067 FD     11439 DEC	IY
004068 2B   
004069 F1     11440 LEX6:           POP	AF
00406A AF     11441 XOR	A
00406B 78     11442 LD	A,B
00406C C9     11443 RET
00406D D5     11449 DEL:            PUSH	DE
00406E E5     11450 PUSH	HL
00406F E5     11451 PUSH	HL
004070 06     11452 LD	B,0
004071 00   
004072 4E     11453 LD	C,(HL)
004073 09     11454 ADD	HL,BC
004074 E5     11455 PUSH	HL
004075 EB     11456 EX	DE,HL
004076 CD     11457 CALL	GETTOP
004077 A9   
004078 40   
004079 ED     11458 SBC	HL,DE
00407A 52   
00407B 44     11459 LD	B,H
00407C 4D     11460 LD	C,L
00407D E1     11461 POP	HL
00407E D1     11462 POP	DE
00407F ED     11463 LDIR			;DELETE LINE
004080 B0   
004081 E1     11464 POP	HL
004082 D1     11465 POP	DE
004083 C9     11466 RET
004084 ED     11476 LOAD0:          LD	DE,(PAGE_)
004085 5B   
004086 DC   
004087 55   
004088 21     11477 LD	HL,-256
004089 00   
00408A FF   
00408B 39     11478 ADD	HL,SP
00408C ED     11479 SBC	HL,DE		;FIND AVAILABLE SPACE
00408D 52   
00408E 44     11480 LD	B,H
00408F 4D     11481 LD	C,L
004090 21     11482 LD	HL,ACCS
004091 00   
004092 53   
004093 CD     11483 CALL	OSLOAD		;LOAD
004094 CE   
004095 06   
004096 D4     11484 CALL	NC,NEWIT
004097 C2   
004098 40   
004099 3E     11485 LD	A,0
00409A 00   
00409B D2     11486 JP	NC,ERROR_	;"No room"
00409C C8   
00409D 3F   
00409E CD     11487 CLEAN:          CALL	GETTOP
00409F A9   
0040A0 40   
0040A1 2B     11488 DEC	HL
0040A2 36     11489 LD	(HL),-1		;WRITE &FFFF
0040A3 FF   
0040A4 2B     11490 DEC	HL
0040A5 36     11491 LD	(HL),-1
0040A6 FF   
0040A7 18     11492 JR	CLEAR
0040A8 1E   
0040A9 2A     11494 GETTOP:         LD	HL,(PAGE_)
0040AA DC   
0040AB 55   
0040AC 06     11495 LD	B,0
0040AD 00   
0040AE 3E     11496 LD	A,CR
0040AF 0D   
0040B0 4E     11497 GETOP1:         LD	C,(HL)
0040B1 0C     11498 INC	C
0040B2 0D     11499 DEC	C
0040B3 28     11500 JR	Z,GETOP2
0040B4 09   
0040B5 09     11501 ADD	HL,BC
0040B6 2B     11502 DEC	HL
0040B7 BE     11503 CP	(HL)
0040B8 23     11504 INC	HL
0040B9 28     11505 JR	Z,GETOP1
0040BA F5   
0040BB C3     11506 JP	BAD
0040BC 73   
0040BD 3F   
0040BE 23     11507 GETOP2:         INC	HL		;N.B. CALLED FROM NEWIT
0040BF 23     11508 INC	HL
0040C0 23     11509 INC	HL
0040C1 C9     11510 RET
0040C2 2A     11519 NEWIT:          LD	HL,(PAGE_)
0040C3 DC   
0040C4 55   
0040C5 36     11520 LD	(HL),0
0040C6 00   
0040C7 E5     11521 CLEAR:          PUSH	HL
0040C8 C5     11522 PUSH	BC
0040C9 F5     11523 PUSH	AF
0040CA CD     11524 CALL	GETTOP
0040CB A9   
0040CC 40   
0040CD 22     11525 LD	(LOMEM),HL
0040CE DE   
0040CF 55   
0040D0 22     11526 LD	(FREE),HL
0040D1 E0   
0040D2 55   
0040D3 21     11527 LD	HL,DYNVAR
0040D4 6C   
0040D5 55   
0040D6 06     11529 LD	B,54+2*2
0040D7 70   
0040D8 36     11530 CLEAR1:         LD	(HL),0
0040D9 00   
0040DA 23     11531 INC	HL
0040DB 10     11532 DJNZ	CLEAR1
0040DC FB   
0040DD F1     11533 POP	AF
0040DE C1     11534 POP	BC
0040DF E1     11535 POP	HL
0040E0 C9     11536 RET
0040E1 E5     11545 LISTIT:         PUSH	HL
0040E2 EB     11546 EX	DE,HL
0040E3 C5     11547 PUSH	BC
0040E4 CD     11548 CALL	PBCD
0040E5 1A   
0040E6 42   
0040E7 C1     11549 POP	BC
0040E8 E1     11550 POP	HL
0040E9 7E     11551 LD	A,(HL)
0040EA D9     11552 EXX
0040EB 21     11553 LD	HL,TOKSUB
0040EC 02   
0040ED 3E   
0040EE 01     11554 LD	BC,LENSUB
0040EF 08   
0040F0 00   
0040F1 ED     11555 CPIR
0040F2 B1   
0040F3 CC     11556 CALL	Z,INDSUB
0040F4 79   
0040F5 41   
0040F6 FE     11557 CP	TENDCASE
0040F7 CB   
0040F8 CC     11558 CALL	Z,INDSUB
0040F9 79   
0040FA 41   
0040FB 3E     11559 LD	A,' '
0040FC 20   
0040FD DD     11560 BIT	0,(IX)
0040FE CB   
0040FF 00   
004100 46   
004101 C4     11561 CALL	NZ,OUTCHR
004102 86   
004103 41   
004104 7B     11562 LD	A,E
004105 87     11563 ADD	A,A
004106 DD     11564 BIT	1,(IX)
004107 CB   
004108 00   
004109 4E   
00410A C4     11565 CALL	NZ,SPACES
00410B 27   
00410C 36   
00410D D9     11566 EXX
00410E 7E     11567 LD	A,(HL)
00410F 1E     11568 LD	E,0
004110 00   
004111 D9     11569 EXX
004112 01     11570 LD	BC,LENADD
004113 07   
004114 00   
004115 21     11571 LIST5:          LD	HL,TOKADD
004116 FB   
004117 3D   
004118 ED     11572 CPIR
004119 B1   
00411A CC     11573 CALL	Z,INDADD
00411B 7D   
00411C 41   
00411D FE     11574 CP	TCASE
00411E C8   
00411F CC     11575 CALL	Z,INDADD
004120 7D   
004121 41   
004122 D9     11576 EXX
004123 7E     11577 LIST8:          LD	A,(HL)
004124 23     11578 INC	HL
004125 FE     11579 CP	CR
004126 0D   
004127 28     11580 JR	Z,LIST9
004128 25   
004129 57     11581 LD	D,A
00412A FE     11582 CP	TEXIT
00412B 10   
00412C 20     11583 JR	NZ,LIST6
00412D 02   
00412E CB     11584 SET	7,E
00412F FB   
004130 FE     11585 LIST6:          CP	'"'
004131 22   
004132 20     11586 JR	NZ,LIST7
004133 01   
004134 1C     11587 INC	E
004135 CD     11588 LIST7:          CALL	LOUT
004136 6D   
004137 41   
004138 7B     11589 LD	A,E
004139 E6     11590 AND	81H
00413A 81   
00413B 20     11591 JR	NZ,LIST8
00413C E6   
00413D 7E     11592 LD	A,(HL)
00413E D9     11593 EXX
00413F 21     11594 LD	HL,TOKSUB
004140 02   
004141 3E   
004142 01     11595 LD	BC,3
004143 03   
004144 00   
004145 ED     11596 CPIR
004146 B1   
004147 CC     11597 CALL	Z,INDSUB
004148 79   
004149 41   
00414A 0E     11598 LD	C,4
00414B 04   
00414C 18     11599 JR	LIST5
00414D C7   
00414E 7A     11601 LIST9:          LD	A,D
00414F FE     11602 CP	TTHEN
004150 8C   
004151 D9     11603 EXX
004152 CC     11604 CALL	Z,INDADD
004153 7D   
004154 41   
004155 D9     11605 EXX
004156 18     11606 JR	CRLF
004157 27   
004158 E5     11608 PRLINO:         PUSH	HL
004159 FD     11609 POP	IY
00415A E1   
00415B C5     11610 PUSH	BC
00415C CD     11611 CALL	DECODE
00415D E4   
00415E 1F   
00415F C1     11612 POP	BC
004160 D9     11613 EXX
004161 C5     11614 PUSH	BC
004162 D5     11615 PUSH	DE
004163 CD     11616 CALL	PBCDL
004164 16   
004165 42   
004166 D1     11617 POP	DE
004167 C1     11618 POP	BC
004168 D9     11619 EXX
004169 FD     11620 PUSH	IY
00416A E5   
00416B E1     11621 POP	HL
00416C C9     11622 RET
00416D CB     11624 LOUT:           BIT	0,E
00416E 43   
00416F 20     11625 JR	NZ,OUTCHR
004170 15   
004171 FE     11626 CP	TLINO
004172 8D   
004173 28     11627 JR	Z,PRLINO
004174 E3   
004175 CD     11628 CALL	OUT
004176 9F   
004177 41   
004178 C9     11629 RET
004179 1D     11631 INDSUB:         DEC	E
00417A F2     11632 JP	P,INDRET
00417B 7E   
00417C 41   
00417D 1C     11633 INDADD:         INC	E
00417E C9     11634 INDRET:         RET
00417F 3E     11642 CRLF:           LD	A,CR
004180 0D   
004181 CD     11643 CALL	OUTCHR
004182 86   
004183 41   
004184 3E     11644 LD	A,LF
004185 0A   
004186 CD     11645 OUTCHR:         CALL	OSWRCH
004187 97   
004188 05   
004189 D6     11646 SUB	CR
00418A 0D   
00418B 28     11647 JR	Z,CARRET
00418C 05   
00418D D8     11648 RET	C		;NON-PRINTING
00418E 3A     11649 LD	A,(COUNT)
00418F FB   
004190 55   
004191 3C     11650 INC	A
004192 32     11651 CARRET:         LD	(COUNT),A
004193 FB   
004194 55   
004195 C8     11652 RET	Z
004196 E5     11653 PUSH	HL
004197 2A     11654 LD	HL,(WIDTH)
004198 FC   
004199 55   
00419A BD     11655 CP	L
00419B E1     11656 POP	HL
00419C C0     11657 RET	NZ
00419D 18     11658 JR	CRLF
00419E E0   
00419F FE     11665 OUT:            CP	160
0041A0 A0   
0041A1 EA     11666 JP	PE,OUTCHR
0041A2 86   
0041A3 41   
0041A4 C5     11667 PUSH	BC
0041A5 E5     11668 PUSH	HL
0041A6 21     11669 LD	HL,KEYWDS
0041A7 08   
0041A8 39   
0041A9 01     11670 LD	BC,KEYWDL
0041AA 5B   
0041AB 03   
0041AC ED     11671 CPIR
0041AD B1   
0041AE C4     11672 CALL	NZ,OUTCHR
0041AF 86   
0041B0 41   
0041B1 06     11673 LD	B,160
0041B2 A0   
0041B3 FE     11674 CP	145
0041B4 91   
0041B5 EA     11675 JP	PE,TOKEN1
0041B6 B9   
0041B7 41   
0041B8 04     11676 INC	B
0041B9 7E     11677 TOKEN1:         LD	A,(HL)
0041BA 23     11678 INC	HL
0041BB B8     11679 CP	B
0041BC F5     11680 PUSH	AF
0041BD EC     11681 CALL	PE,OUTCHR
0041BE 86   
0041BF 41   
0041C0 F1     11682 POP	AF
0041C1 EA     11683 JP	PE,TOKEN1
0041C2 B9   
0041C3 41   
0041C4 E1     11684 POP	HL
0041C5 C1     11685 POP	BC
0041C6 C9     11686 RET
0041C7 EB     11695 FINDL:          EX	DE,HL
0041C8 2A     11696 LD	HL,(PAGE_)
0041C9 DC   
0041CA 55   
0041CB AF     11697 XOR	A		;A=0
0041CC BE     11698 CP	(HL)
0041CD 3C     11699 INC	A
0041CE D0     11700 RET	NC
0041CF AF     11701 XOR	A		;CLEAR CARRY
0041D0 47     11702 LD	B,A
0041D1 4E     11703 FINDL1:         LD	C,(HL)
0041D2 E5     11704 PUSH	HL
0041D3 23     11705 INC	HL
0041D4 7E     11706 LD	A,(HL)
0041D5 23     11707 INC	HL
0041D6 66     11708 LD	H,(HL)
0041D7 6F     11709 LD	L,A
0041D8 ED     11710 SBC	HL,DE
0041D9 52   
0041DA E1     11711 POP	HL
0041DB D0     11712 RET	NC		;FOUND | PAST
0041DC 09     11713 ADD	HL,BC
0041DD 18     11714 JR	FINDL1
0041DE F2   
0041DF 06     11721 SETLIN:         LD	B,0
0041E0 00   
0041E1 ED     11722 LD	DE,(CURLIN)
0041E2 5B   
0041E3 F4   
0041E4 55   
0041E5 2A     11723 LD	HL,(PAGE_)
0041E6 DC   
0041E7 55   
0041E8 B7     11724 OR	A
0041E9 ED     11725 SBC	HL,DE
0041EA 52   
0041EB 19     11726 ADD	HL,DE
0041EC 30     11727 JR	NC,SET3
0041ED 13   
0041EE 4E     11728 SET1:           LD	C,(HL)
0041EF 0C     11729 INC	C
0041F0 0D     11730 DEC	C
0041F1 28     11731 JR	Z,SET3
0041F2 0E   
0041F3 09     11732 ADD	HL,BC
0041F4 ED     11733 SBC	HL,DE
0041F5 52   
0041F6 19     11734 ADD	HL,DE
0041F7 38     11735 JR	C,SET1
0041F8 F5   
0041F9 ED     11736 SBC	HL,BC
0041FA 42   
0041FB 23     11737 INC	HL
0041FC 5E     11738 LD	E,(HL)		;LINE NUMBER
0041FD 23     11739 INC	HL
0041FE 56     11740 LD	D,(HL)
0041FF EB     11741 EX	DE,HL
004200 C9     11742 SET2:           RET
004201 21     11744 SET3:           LD	HL,0
004202 00   
004203 00   
004204 18     11745 JR	SET2
004205 FA   
004206 7C     11753 SAYLN:          LD	A,H
004207 B5     11754 OR	L
004208 C8     11755 RET	Z
004209 CD     11756 CALL	TELL
00420A 7E   
00420B 45   
00420C 20     11757 DB	" at line "
00420D 61   
00420E 74   
00420F 20   
004210 6C   
004211 69   
004212 6E   
004213 65   
004214 20   
004215 00     11758 DB	0
004216 0E     11759 PBCDL:          LD	C,0
004217 00   
004218 18     11760 JR	PBCD0
004219 02   
00421A 0E     11767 PBCD:           LD	C,' '
00421B 20   
00421C 06     11768 PBCD0:          LD	B,5
00421D 05   
00421E 11     11769 LD	DE,10000
00421F 10   
004220 27   
004221 AF     11770 PBCD1:          XOR	A
004222 ED     11771 PBCD2:          SBC	HL,DE
004223 52   
004224 3C     11772 INC	A
004225 30     11773 JR	NC,PBCD2
004226 FB   
004227 19     11774 ADD	HL,DE
004228 3D     11775 DEC	A
004229 28     11776 JR	Z,PBCD3
00422A 04   
00422B CB     11777 SET	4,C
00422C E1   
00422D CB     11778 SET	5,C
00422E E9   
00422F B1     11779 PBCD3:          OR	C
004230 C4     11780 CALL	NZ,OUTCHR
004231 86   
004232 41   
004233 78     11781 LD	A,B
004234 FE     11782 CP	5
004235 05   
004236 28     11783 JR	Z,PBCD4
004237 06   
004238 29     11784 ADD	HL,HL
004239 54     11785 LD	D,H
00423A 5D     11786 LD	E,L
00423B 29     11787 ADD	HL,HL
00423C 29     11788 ADD	HL,HL
00423D 19     11789 ADD	HL,DE
00423E 11     11790 PBCD4:          LD	DE,1000
00423F E8   
004240 03   
004241 10     11791 DJNZ	PBCD1
004242 DE   
004243 37     11792 SCF
004244 C9     11793 RET
004245 FD     11797 GETV1:          INC	IY
004246 23   
004247 FD     11798 INC	IY		;SKIP ()
004248 23   
004249 E5     11799 PUSH	HL		;SET EXIT CONDITIONS
00424A DD     11800 POP	IX
00424B E1   
00424C 7A     11801 LD	A,D
00424D F6     11802 OR	64		;FLAG ARRAY
00424E 40   
00424F BF     11803 CP	A
004250 C9     11804 RET
004251 CD     11811 PUTVAR:         CALL	CREATE
004252 C0   
004253 43   
004254 FD     11812 LD	A,(IY)
004255 7E   
004256 00   
004257 FE     11813 CP	'('
004258 28   
004259 20     11814 JR	NZ,GETVZ	;SET EXIT CONDITIONS
00425A 7D   
00425B FD     11815 LD	A,(IY+1)
00425C 7E   
00425D 01   
00425E FE     11816 CP	')'		;WHOLE ARRAY?
00425F 29   
004260 28     11817 JR	Z,GETV1
004261 E3   
004262 3E     11818 ARRAY:          LD	A,14		;'Bad use of array'
004263 0E   
004264 C3     11819 ERROR3:         JP	ERROR_
004265 C8   
004266 3F   
004267 FD     11833 GETVAR:         LD	A,(IY)
004268 7E   
004269 00   
00426A FE     11834 CP	'!'
00426B 21   
00426C 28     11835 JR	Z,GETV5
00426D 76   
00426E FE     11836 CP	'?'
00426F 3F   
004270 28     11837 JR	Z,GETV6
004271 76   
004272 FE     11838 CP	'|'
004273 7C   
004274 28     11839 JR	Z,GETVF
004275 75   
004276 FE     11840 CP	'$'
004277 24   
004278 28     11841 JR	Z,GETV4
004279 75   
00427A CD     11842 CALL	LOCATE
00427B 34   
00427C 43   
00427D C0     11843 RET	NZ
00427E FD     11844 LD	A,(IY)
00427F 7E   
004280 00   
004281 FE     11845 CP	'('		;ARRAY?
004282 28   
004283 20     11846 JR	NZ,GETVX	;EXIT
004284 4B   
004285 FD     11847 LD	A,(IY+1)
004286 7E   
004287 01   
004288 FE     11848 CP	')'		;WHOLE ARRAY?
004289 29   
00428A 28     11849 JR	Z,GETV1
00428B B9   
00428C D5     11850 PUSH	DE		;SAVE TYPE
00428D 7E     11851 LD	A,(HL)
00428E 23     11852 INC	HL
00428F 66     11853 LD	H,(HL)
004290 6F     11854 LD	L,A		;INDIRECT LINK
004291 E6     11855 AND	0FEH
004292 FE   
004293 B4     11856 OR	H
004294 28     11857 JR	Z,ARRAY
004295 CC   
004296 7E     11858 LD	A,(HL)		;NO. OF DIMENSIONS
004297 B7     11859 OR	A
004298 28     11860 JR	Z,ARRAY
004299 C8   
00429A 23     11861 INC	HL
00429B 11     11862 LD	DE,0		;ACCUMULATOR
00429C 00   
00429D 00   
00429E F5     11863 PUSH	AF
00429F FD     11864 INC	IY		;SKIP (
0042A0 23   
0042A1 E5     11865 GETV3:          PUSH	HL
0042A2 D5     11866 PUSH	DE
0042A3 CD     11867 CALL	EXPRI		;SUBSCRIPT
0042A4 B7   
0042A5 18   
0042A6 D9     11868 EXX
0042A7 D1     11869 POP	DE
0042A8 E3     11870 EX	(SP),HL
0042A9 4E     11871 LD	C,(HL)
0042AA 23     11872 INC	HL
0042AB 46     11873 LD	B,(HL)
0042AC 23     11874 INC	HL
0042AD E3     11875 EX	(SP),HL
0042AE EB     11876 EX	DE,HL
0042AF D5     11877 PUSH	DE
0042B0 CD     11878 CALL	MUL16		;HL=HL*BC
0042B1 41   
0042B2 37   
0042B3 D1     11879 POP	DE
0042B4 19     11880 ADD	HL,DE
0042B5 EB     11881 EX	DE,HL
0042B6 B7     11882 OR	A
0042B7 ED     11883 SBC	HL,BC
0042B8 42   
0042B9 3E     11884 LD	A,15
0042BA 0F   
0042BB 30     11885 JR	NC,ERROR3	;"Subscript"
0042BC A7   
0042BD E1     11886 POP	HL
0042BE F1     11887 POP	AF
0042BF 3D     11888 DEC	A		;DIMENSION COUNTER
0042C0 20     11889 JR	NZ,GETV2
0042C1 1C   
0042C2 CD     11890 CALL	BRAKET		;CLOSING BRACKET
0042C3 32   
0042C4 21   
0042C5 F1     11891 POP	AF		;RESTORE TYPE
0042C6 E5     11892 PUSH	HL
0042C7 CD     11893 CALL	X14OR5		;DE=DE*n
0042C8 31   
0042C9 37   
0042CA E1     11894 POP	HL
0042CB 19     11895 ADD	HL,DE
0042CC 57     11896 LD	D,A		;TYPE
0042CD FD     11897 LD	A,(IY)
0042CE 7E   
0042CF 00   
0042D0 FE     11898 GETVX:          CP	'?'
0042D1 3F   
0042D2 28     11899 JR	Z,GETV9
0042D3 26   
0042D4 FE     11900 CP	'!'
0042D5 21   
0042D6 28     11901 JR	Z,GETV8
0042D7 1E   
0042D8 E5     11902 GETVZ:          PUSH	HL		;SET EXIT CONDITIONS
0042D9 DD     11903 POP	IX
0042DA E1   
0042DB 7A     11904 LD	A,D
0042DC BF     11905 CP	A
0042DD C9     11906 RET
0042DE F5     11908 GETV2:          PUSH	AF
0042DF CD     11909 CALL	COMMA
0042E0 26   
0042E1 21   
0042E2 18     11910 JR	GETV3
0042E3 BD   
0042E4 3E     11914 GETV5:          LD	A,4		;UNARY 32-BIT INDIRN.
0042E5 04   
0042E6 18     11915 JR	GETV7
0042E7 09   
0042E8 AF     11916 GETV6:          XOR	A		;UNARY 8-BIT INDIRECTION
0042E9 18     11917 JR	GETV7
0042EA 06   
0042EB 3E     11918 GETVF:          LD	A,5		;VARIANT INDIRECTION
0042EC 05   
0042ED 18     11919 JR	GETV7
0042EE 02   
0042EF 3E     11920 GETV4:          LD	A,128		;STATIC STRING
0042F0 80   
0042F1 ED     11921 GETV7:          SBC	HL,HL
0042F2 62   
0042F3 F5     11922 PUSH	AF
0042F4 18     11923 JR	GETV0
0042F5 15   
0042F6 06     11925 GETV8:          LD	B,4		;32-BIT BINARY INDIRN.
0042F7 04   
0042F8 18     11926 JR	GETVA
0042F9 02   
0042FA 06     11927 GETV9:          LD	B,0		;8-BIT BINARY INDIRN.
0042FB 00   
0042FC E5     11928 GETVA:          PUSH	HL
0042FD DD     11929 POP	IX
0042FE E1   
0042FF 7A     11930 LD	A,D		;TYPE
004300 FE     11931 CP	129
004301 81   
004302 C8     11932 RET	Z		;STRING!
004303 C5     11933 PUSH	BC
004304 CD     11934 CALL	LOADN		;LEFT OPERAND
004305 A9   
004306 19   
004307 CD     11935 CALL	SFIX
004308 9B   
004309 1C   
00430A D9     11936 EXX
00430B E5     11937 GETV0:          PUSH	HL
00430C FD     11938 INC	IY
00430D 23   
00430E CD     11939 CALL	ITEMI
00430F E4   
004310 18   
004311 D9     11940 EXX
004312 D1     11941 POP	DE
004313 F1     11942 POP	AF
004314 19     11943 ADD	HL,DE
004315 E5     11944 PUSH	HL
004316 DD     11945 POP	IX
004317 E1   
004318 BF     11946 CP	A
004319 C9     11947 RET
00431A FD     11957 GETDEF:         LD	A,(IY+1)
00431B 7E   
00431C 01   
00431D CD     11958 CALL	RANGE1
00431E 80   
00431F 44   
004320 D8     11959 RET	C
004321 FD     11960 LD	A,(IY)
004322 7E   
004323 00   
004324 21     11961 LD	HL,FNPTR
004325 D8   
004326 55   
004327 FE     11962 CP	TFN
004328 A4   
004329 28     11963 JR	Z,LOC2
00432A 43   
00432B 21     11964 LD	HL,PROPTR
00432C DA   
00432D 55   
00432E FE     11965 CP	TPROC
00432F F2   
004330 28     11966 JR	Z,LOC2
004331 3C   
004332 37     11967 SCF
004333 C9     11968 RET
004334 D6     11984 LOCATE:         SUB	'@'
004335 40   
004336 D8     11985 RET	C
004337 26     11986 LD	H,0
004338 00   
004339 FE     11987 CP	'Z'-'@'+1
00433A 1B   
00433B 30     11988 JR	NC,LOC0		;NOT STATIC
00433C 1D   
00433D 87     11989 ADD	A,A
00433E 6F     11990 LD	L,A
00433F FD     11991 LD	A,(IY+1)	;2nd CHARACTER
004340 7E   
004341 01   
004342 FE     11992 CP	'%'
004343 25   
004344 20     11993 JR	NZ,LOC1		;NOT STATIC
004345 20   
004346 FD     11994 LD	A,(IY+2)
004347 7E   
004348 02   
004349 FE     11995 CP	'('
00434A 28   
00434B 28     11996 JR	Z,LOC1		;NOT STATIC
00434C 19   
00434D 29     11997 ADD	HL,HL
00434E 11     11998 LD	DE,STAVAR	;STATIC VARIABLES
00434F 00   
004350 55   
004351 19     11999 ADD	HL,DE
004352 FD     12000 INC	IY
004353 23   
004354 FD     12001 INC	IY
004355 23   
004356 16     12002 LD	D,4		;INTEGER TYPE
004357 04   
004358 AF     12003 XOR	A
004359 C9     12004 RET
00435A FE     12006 LOC0:           CP	'_'-'@'
00435B 1F   
00435C D8     12007 RET	C
00435D FE     12008 CP	'z'-'@'+1
00435E 3B   
00435F 3F     12009 CCF
004360 3D     12010 DEC	A		;SET NZ
004361 D8     12011 RET	C
004362 D6     12012 SUB	3
004363 03   
004364 87     12013 ADD	A,A
004365 6F     12014 LD	L,A
004366 11     12015 LOC1:           LD	DE,DYNVAR	;DYNAMIC VARIABLES
004367 6C   
004368 55   
004369 2D     12016 DEC	L
00436A 2D     12017 DEC	L
00436B 37     12018 SCF
00436C F8     12019 RET	M
00436D 19     12020 ADD	HL,DE
00436E 5E     12021 LOC2:           LD	E,(HL)
00436F 23     12022 INC	HL
004370 56     12023 LD	D,(HL)
004371 7A     12024 LD	A,D
004372 B3     12025 OR	E
004373 28     12026 JR	Z,LOC6		;UNDEFINED VARIABLE
004374 49   
004375 62     12027 LD	H,D
004376 6B     12028 LD	L,E
004377 23     12029 INC	HL		;SKIP LINK
004378 23     12030 INC	HL
004379 FD     12031 PUSH	IY
00437A E5   
00437B 7E     12032 LOC3:           LD	A,(HL)		;COMPARE
00437C 23     12033 INC	HL
00437D FD     12034 INC	IY
00437E 23   
00437F FD     12035 CP	(IY)
004380 BE   
004381 00   
004382 28     12036 JR	Z,LOC3
004383 F7   
004384 B7     12037 OR	A		;0=TERMINATOR
004385 28     12038 JR	Z,LOC5		;FOUND (MAYBE)
004386 05   
004387 FD     12039 LOC4:           POP	IY
004388 E1   
004389 EB     12040 EX	DE,HL
00438A 18     12041 JR	LOC2		;TRY NEXT ENTRY
00438B E2   
00438C FD     12043 LOC5:           DEC	IY
00438D 2B   
00438E FD     12044 LD	A,(IY)
00438F 7E   
004390 00   
004391 FE     12045 CP	'('
004392 28   
004393 28     12046 JR	Z,LOCX		;FOUND
004394 13   
004395 FD     12047 INC	IY
004396 23   
004397 CD     12048 CALL	RANGE
004398 73   
004399 44   
00439A 38     12049 JR	C,LOCX		;FOUND
00439B 0C   
00439C FE     12050 CP	'('
00439D 28   
00439E 28     12051 JR	Z,LOC4		;KEEP LOOKING
00439F E7   
0043A0 FD     12052 LD	A,(IY-1)
0043A1 7E   
0043A2 FF   
0043A3 CD     12053 CALL	RANGE1
0043A4 80   
0043A5 44   
0043A6 30     12054 JR	NC,LOC4		;KEEP LOOKING
0043A7 DF   
0043A8 D1     12055 LOCX:           POP	DE
0043A9 FD     12056 TYPE:           LD	A,(IY-1)
0043AA 7E   
0043AB FF   
0043AC FE     12057 CP	'$'
0043AD 24   
0043AE 16     12058 LD	D,129
0043AF 81   
0043B0 C8     12059 RET	Z		;STRING
0043B1 FE     12060 CP	'&'
0043B2 26   
0043B3 16     12061 LD	D,1
0043B4 01   
0043B5 C8     12062 RET	Z		;BYTE
0043B6 FE     12063 CP	'%'
0043B7 25   
0043B8 16     12064 LD	D,4
0043B9 04   
0043BA C8     12065 RET	Z		;INTEGER
0043BB 14     12066 INC	D
0043BC BF     12067 CP	A
0043BD C9     12068 RET
0043BE 3C     12070 LOC6:           INC	A		;SET NZ
0043BF C9     12071 RET
0043C0 AF     12078 CREATE:         XOR	A
0043C1 ED     12079 LD	DE,(FREE)
0043C2 5B   
0043C3 E0   
0043C4 55   
0043C5 72     12080 LD	(HL),D
0043C6 2B     12081 DEC	HL
0043C7 73     12082 LD	(HL),E
0043C8 EB     12083 EX	DE,HL
0043C9 77     12084 LD	(HL),A
0043CA 23     12085 INC	HL
0043CB 77     12086 LD	(HL),A
0043CC 23     12087 INC	HL
0043CD FD     12088 LOC7:           INC	IY
0043CE 23   
0043CF CD     12089 CALL	RANGE		;END OF VARIABLE?
0043D0 73   
0043D1 44   
0043D2 38     12090 JR	C,LOC8
0043D3 14   
0043D4 77     12091 LD	(HL),A
0043D5 23     12092 INC	HL
0043D6 CD     12093 CALL	RANGE1
0043D7 80   
0043D8 44   
0043D9 30     12094 JR	NC,LOC7
0043DA F2   
0043DB FE     12095 CP	'('
0043DC 28   
0043DD 28     12096 JR	Z,LOC8
0043DE 09   
0043DF FD     12097 LD	A,(IY+1)
0043E0 7E   
0043E1 01   
0043E2 FE     12098 CP	'('
0043E3 28   
0043E4 28     12099 JR	Z,LOC7
0043E5 E7   
0043E6 FD     12100 INC	IY
0043E7 23   
0043E8 36     12101 LOC8:           LD	(HL),0		;TERMINATOR
0043E9 00   
0043EA 23     12102 INC	HL
0043EB E5     12103 PUSH	HL
0043EC CD     12104 CALL	TYPE
0043ED A9   
0043EE 43   
0043EF FD     12105 LD	A,(IY)
0043F0 7E   
0043F1 00   
0043F2 FE     12106 CP	'('
0043F3 28   
0043F4 3E     12107 LD	A,2		;SIZE OF INDIRECT LINK
0043F5 02   
0043F6 28     12108 JR	Z,LOC9
0043F7 07   
0043F8 7A     12109 LD	A,D
0043F9 B7     12110 OR	A		;STRING?
0043FA F2     12111 JP	P,LOC9
0043FB FF   
0043FC 43   
0043FD 3E     12112 LD	A,4
0043FE 04   
0043FF 36     12113 LOC9:           LD	(HL),0		;INITIALISE TO ZERO
004400 00   
004401 23     12114 INC	HL
004402 3D     12115 DEC	A
004403 20     12116 JR	NZ,LOC9
004404 FA   
004405 22     12117 LD	(FREE),HL
004406 E0   
004407 55   
004408 CD     12118 CALL	CHECK
004409 0A   
00440A 33   
00440B E1     12119 POP	HL
00440C AF     12120 XOR	A
00440D C9     12121 RET
00440E CD     12129 LINNUM:         CALL	NXT
00440F 8F   
004410 45   
004411 21     12130 LD	HL,0
004412 00   
004413 00   
004414 FD     12131 LINNM1:         LD	A,(IY)
004415 7E   
004416 00   
004417 D6     12132 SUB	'0'
004418 30   
004419 D8     12133 RET	C
00441A FE     12134 CP	10
00441B 0A   
00441C D0     12135 RET	NC
00441D FD     12136 INC	IY
00441E 23   
00441F 54     12137 LD	D,H
004420 5D     12138 LD	E,L
004421 29     12139 ADD	HL,HL		;*2
004422 38     12140 JR	C,TOOBIGmn
004423 0F   
004424 29     12141 ADD	HL,HL		;*4
004425 38     12142 JR	C,TOOBIGmn
004426 0C   
004427 19     12143 ADD	HL,DE		;*5
004428 38     12144 JR	C,TOOBIGmn
004429 09   
00442A 29     12145 ADD	HL,HL		;*10
00442B 38     12146 JR	C,TOOBIGmn
00442C 06   
00442D 5F     12147 LD	E,A
00442E 16     12148 LD	D,0
00442F 00   
004430 19     12149 ADD	HL,DE		;ADD IN DIGIT
004431 30     12150 JR	NC,LINNM1
004432 E1   
004433 3E     12151 TOOBIGmn:         LD	A,20
004434 14   
004435 C3     12152 JP	ERROR_		;"Too big"
004436 C8   
004437 3F   
004438 CD     12160 PAIR:           CALL	LINNUM		;FIRST
004439 0E   
00443A 44   
00443B 7C     12161 LD	A,H
00443C B5     12162 OR	L
00443D 20     12163 JR	NZ,PAIR1
00443E 02   
00443F 2E     12164 LD	L,10
004440 0A   
004441 CD     12165 PAIR1:          CALL	TERMQ
004442 BA   
004443 35   
004444 FD     12166 INC	IY
004445 23   
004446 E5     12167 PUSH	HL
004447 21     12168 LD	HL,10
004448 0A   
004449 00   
00444A C4     12169 CALL	NZ,LINNUM	;SECOND
00444B 0E   
00444C 44   
00444D E3     12170 EX	(SP),HL
00444E C1     12171 POP	BC
00444F 78     12172 LD	A,B
004450 B1     12173 OR	C
004451 C0     12174 RET	NZ
004452 CD     12175 CALL	EXTERR
004453 D9   
004454 3F   
004455 53     12176 DB	"Silly"
004456 69   
004457 6C   
004458 6C   
004459 79   
00445A 00     12177 DB	0
00445B CD     12185 DLPAIR:         CALL	LINNUM
00445C 0E   
00445D 44   
00445E E5     12186 PUSH	HL
00445F CD     12187 CALL	TERMQ
004460 BA   
004461 35   
004462 28     12188 JR	Z,DLP1
004463 09   
004464 FE     12189 CP	TIF
004465 E7   
004466 28     12190 JR	Z,DLP1
004467 05   
004468 FD     12191 INC	IY
004469 23   
00446A CD     12192 CALL	LINNUM
00446B 0E   
00446C 44   
00446D E3     12193 DLP1:           EX	(SP),HL
00446E CD     12194 CALL	FINDL
00446F C7   
004470 41   
004471 C1     12195 POP	BC
004472 C9     12196 RET
004473 FD     12203 RANGE:          LD	A,(IY)
004474 7E   
004475 00   
004476 FE     12204 CP	'$'
004477 24   
004478 D8     12205 RET	C
004479 FE     12206 CP	'&'+1
00447A 27   
00447B 3F     12207 CCF
00447C D0     12208 RET	NC
00447D FE     12209 CP	'('
00447E 28   
00447F C8     12210 RET	Z
004480 FE     12211 RANGE1:         CP	'0'
004481 30   
004482 D8     12212 RET	C
004483 FE     12213 CP	'9'+1
004484 3A   
004485 3F     12214 CCF
004486 D0     12215 RET	NC
004487 FE     12216 CP	'@'		;V2.4
004488 40   
004489 C8     12217 RET	Z
00448A FE     12218 RANGE2:         CP	'A'
00448B 41   
00448C D8     12219 RET	C
00448D FE     12220 CP	'Z'+1
00448E 5B   
00448F 3F     12221 CCF
004490 D0     12222 RET	NC
004491 FE     12223 CP	'_'
004492 5F   
004493 D8     12224 RET	C
004494 FE     12225 CP	'z'+1
004495 7B   
004496 3F     12226 CCF
004497 C9     12227 RET
004498 12     12243 LEXAN1:         LD	(DE),A		;TRANSFER TO BUFFER
004499 13     12244 INC	DE		;INCREMENT POINTERS
00449A FD     12245 INC	IY
00449B 23   
00449C 7B     12246 LEXAN2:         LD	A,E		;MAIN ENTRY
00449D FE     12247 CP	252		;TEST LENGTH
00449E FC   
00449F 3E     12248 LD	A,19
0044A0 13   
0044A1 D2     12249 JP	NC,ERROR_	;'String too long'
0044A2 C8   
0044A3 3F   
0044A4 FD     12250 LD	A,(IY)
0044A5 7E   
0044A6 00   
0044A7 FE     12251 CP	CR
0044A8 0D   
0044A9 C8     12252 RET	Z		;END OF LINE
0044AA CD     12253 CALL	RANGE1
0044AB 80   
0044AC 44   
0044AD 30     12254 JR	NC,LEXAN3
0044AE 04   
0044AF CB     12255 RES	5,C		;NOT IN VARIABLE
0044B0 A9   
0044B1 CB     12256 RES	3,C		;NOT IN HEX
0044B2 99   
0044B3 FE     12257 LEXAN3:         CP	' '
0044B4 20   
0044B5 28     12258 JR	Z,LEXAN1	;PASS SPACES
0044B6 E1   
0044B7 FE     12259 CP	','
0044B8 2C   
0044B9 28     12260 JR	Z,LEXAN1	;PASS COMMAS
0044BA DD   
0044BB FE     12261 CP	'G'
0044BC 47   
0044BD 38     12262 JR	C,LEXAN4
0044BE 02   
0044BF CB     12263 RES	3,C		;NOT IN HEX
0044C0 99   
0044C1 FE     12264 LEXAN4:         CP	'"'
0044C2 22   
0044C3 20     12265 JR	NZ,LEXAN5
0044C4 05   
0044C5 CB     12266 RL	C
0044C6 11   
0044C7 3F     12267 CCF			;TOGGLE C7
0044C8 CB     12268 RR	C
0044C9 19   
0044CA CB     12269 LEXAN5:         BIT	4,C
0044CB 61   
0044CC 28     12270 JR	Z,LEXAN6
0044CD 10   
0044CE CB     12271 RES	4,C
0044CF A1   
0044D0 C5     12272 PUSH	BC
0044D1 D5     12273 PUSH	DE
0044D2 CD     12274 CALL	LINNUM		;GET LINE NUMBER
0044D3 0E   
0044D4 44   
0044D5 D1     12275 POP	DE
0044D6 C1     12276 POP	BC
0044D7 7C     12277 LD	A,H
0044D8 B5     12278 OR	L
0044D9 C4     12279 CALL	NZ,ENCODE	;ENCODE LINE NUMBER
0044DA 43   
0044DB 45   
0044DC 18     12280 JR	LEXAN2		;CONTINUE
0044DD BE   
0044DE 0D     12282 LEXAN6:         DEC	C
0044DF 28     12283 JR	Z,LEXAN7	;C=1 (LEFT)
0044E0 09   
0044E1 0C     12284 INC	C
0044E2 20     12285 JR	NZ,LEXAN1
0044E3 B4   
0044E4 B7     12286 OR	A
0044E5 F4     12287 CALL	P,LEX		;TOKENISE IF POSS.
0044E6 27   
0044E7 40   
0044E8 18     12288 JR	LEXAN8
0044E9 12   
0044EA FE     12290 LEXAN7:         CP	'*'
0044EB 2A   
0044EC 28     12291 JR	Z,LEXAN9
0044ED 16   
0044EE B7     12292 OR	A
0044EF F4     12293 CALL	P,LEX		;TOKENISE IF POSS.
0044F0 27   
0044F1 40   
0044F2 FE     12294 CP	TOKLO
0044F3 8F   
0044F4 38     12295 JR	C,LEXAN8
0044F5 06   
0044F6 FE     12296 CP	TOKHI+1
0044F7 94   
0044F8 30     12297 JR	NC,LEXAN8
0044F9 02   
0044FA C6     12298 ADD	A,OFFSET	;LEFT VERSION
0044FB 40   
0044FC FE     12299 LEXAN8:         CP	TREM
0044FD F4   
0044FE 28     12300 JR	Z,LEXAN9
0044FF 04   
004500 FE     12301 CP	TDATA
004501 DC   
004502 20     12302 JR	NZ,LEXANA
004503 02   
004504 CB     12303 LEXAN9:         SET	6,C		;QUIT TOKENISING
004505 F1   
004506 FE     12304 LEXANA:         CP	TFN
004507 A4   
004508 28     12305 JR	Z,LEXANB
004509 09   
00450A FE     12306 CP	TPROC
00450B F2   
00450C 28     12307 JR	Z,LEXANB
00450D 05   
00450E CD     12308 CALL	RANGE2
00450F 8A   
004510 44   
004511 38     12309 JR	C,LEXANC
004512 02   
004513 CB     12310 LEXANB:         SET	5,C		;IN VARIABLE/FN/PROC
004514 E9   
004515 FE     12311 LEXANC:         CP	'&'
004516 26   
004517 20     12312 JR	NZ,LEXAND
004518 02   
004519 CB     12313 SET	3,C		;IN HEX
00451A D9   
00451B 21     12314 LEXAND:         LD	HL,LIST1
00451C 3A   
00451D 45   
00451E C5     12315 PUSH	BC
00451F 01     12316 LD	BC,LIST1L
004520 06   
004521 00   
004522 ED     12317 CPIR
004523 B1   
004524 C1     12318 POP	BC
004525 20     12319 JR	NZ,LEXANE
004526 02   
004527 CB     12320 SET	4,C		;ACCEPT LINE NUMBER
004528 E1   
004529 21     12321 LEXANE:         LD	HL,LIST2
00452A 3E   
00452B 45   
00452C C5     12322 PUSH	BC
00452D 01     12323 LD	BC,LIST2L
00452E 05   
00452F 00   
004530 ED     12324 CPIR
004531 B1   
004532 C1     12325 POP	BC
004533 20     12326 JR	NZ,LEXANF
004534 02   
004535 CB     12327 SET	0,C		;ENTER LEFT MODE
004536 C1   
004537 C3     12328 LEXANF:         JP	LEXAN1
004538 98   
004539 44   
00453A E5     12330 LIST1:          DB	TGOTO
00453B E4     12331 DB	TGOSUB
00453C F7     12332 DB	TRESTORE
00453D FC     12333 DB	TTRACE
00453E 8C     12334 LIST2:          DB	TTHEN
00453F 8B     12335 DB	TELSE
004540 F5     12337 DB	TREPEAT
004541 85     12338 DB	TERROR
004542 3A     12339 DB	':'
004543 CB     12347 ENCODE:         SET	4,C
004544 E1   
004545 EB     12348 EX	DE,HL
004546 36     12349 LD	(HL),TLINO
004547 8D   
004548 23     12350 INC	HL
004549 7A     12351 LD	A,D
00454A E6     12352 AND	0C0H
00454B C0   
00454C 0F     12353 RRCA
00454D 0F     12354 RRCA
00454E 47     12355 LD	B,A
00454F 7B     12356 LD	A,E
004550 E6     12357 AND	0C0H
004551 C0   
004552 B0     12358 OR	B
004553 0F     12359 RRCA
004554 0F     12360 RRCA
004555 EE     12361 XOR	01010100B
004556 54   
004557 77     12362 LD	(HL),A
004558 23     12363 INC	HL
004559 7B     12364 LD	A,E
00455A E6     12365 AND	3FH
00455B 3F   
00455C F6     12366 OR	'@'
00455D 40   
00455E 77     12367 LD	(HL),A
00455F 23     12368 INC	HL
004560 7A     12369 LD	A,D
004561 E6     12370 AND	3FH
004562 3F   
004563 F6     12371 OR	'@'
004564 40   
004565 77     12372 LD	(HL),A
004566 23     12373 INC	HL
004567 EB     12374 EX	DE,HL
004568 C9     12375 RET
004569 2A     12382 REPORT:         LD	HL,(ERRTXT)
00456A EE   
00456B 55   
00456C 7E     12383 TEXT_:          LD	A,(HL)
00456D 23     12384 INC	HL
00456E B7     12385 OR	A
00456F C8     12386 RET	Z
004570 FE     12387 CP	LF
004571 0A   
004572 28     12388 JR	Z,TEXTLF	;Token for TINT
004573 05   
004574 CD     12389 CALL	OUT
004575 9F   
004576 41   
004577 18     12390 JR	TEXT_
004578 F3   
004579 CD     12392 TEXTLF:         CALL	OUTCHR
00457A 86   
00457B 41   
00457C 18     12393 JR	TEXT_
00457D EE   
00457E E3     12399 TELL:           EX	(SP),HL		;GET RETURN ADDRESS
00457F CD     12400 CALL	TEXT_
004580 6C   
004581 45   
004582 E3     12401 EX	(SP),HL
004583 C9     12402 RET
004584 CD     12406 NLIST:          CALL	NXT
004585 8F   
004586 45   
004587 FE     12407 CP	','		;ANOTHER VARIABLE?
004588 2C   
004589 28     12408 JR	Z,NXT1
00458A 0A   
00458B C1     12409 POP	BC		;DITCH RETURN ADDRESS
00458C C3     12410 JP	XEQ
00458D 1D   
00458E 25   
00458F FD     12412 NXT:            LD	A,(IY)
004590 7E   
004591 00   
004592 FE     12413 CP	' '
004593 20   
004594 C0     12414 RET	NZ
004595 FD     12415 NXT1:           INC	IY
004596 23   
004597 18     12416 JR	NXT
004598 F6   
004599             12421   ; --- Begin math.asm ---
004599 FD     12466 FPP:            PUSH	IY		;Save IY
00459A E5   
00459B FD     12467 LD	IY,0
00459C 21   
00459D 00   
00459E 00   
00459F FD     12468 ADD	IY,SP		;Save SP in IY
0045A0 39   
0045A1 CD     12469 CALL	OP		;Perform operation
0045A2 B0   
0045A3 45   
0045A4 BF     12470 CP	A		;Good return (Z, NC)
0045A5 FD     12471 EXITmat:           POP	IY		;Restore IY
0045A6 E1   
0045A7 C9     12472 RET			;Return to caller
0045A8 3E     12476 BADmat:            LD	A,BADOP		;"Bad operation code"
0045A9 01   
0045AA FD     12477 ERROR_mat:         LD	SP,IY		;Restore SP from IY
0045AB F9   
0045AC B7     12478 OR	A		;Set NZ
0045AD 37     12479 SCF			;Set C
0045AE 18     12480 JR	EXITmat
0045AF F5   
0045B0 FE     12485 OP:             CP	RTABLE-DTABLE/2
0045B1 2E   
0045B2 30     12486 JR	NC,BADmat
0045B3 F4   
0045B4 FE     12488 CP	FTABLE-DTABLE/2
0045B5 10   
0045B6 30     12489 JR	NC,DISPAT
0045B7 07   
0045B8 08     12490 EX	AF,AF'
0045B9 78     12491 LD	A,B
0045BA B1     12492 OR	C		;Both integer?
0045BB C4     12493 CALL	NZ,FLOATA	;No, so float both
0045BC 29   
0045BD 4F   
0045BE 08     12494 EX	AF,AF'
0045BF E5     12495 DISPAT:         PUSH	HL
0045C0 21     12496 LD	HL,DTABLE
0045C1 D0   
0045C2 45   
0045C3 C5     12497 PUSH	BC
0045C4 87     12498 ADD	A,A		;A = op-code * 2
0045C5 4F     12499 LD	C,A
0045C6 06     12500 LD	B,0		;BC = op-code * 2
0045C7 00   
0045C8 09     12501 ADD	HL,BC
0045C9 7E     12502 LD	A,(HL)		;Get low byte
0045CA 23     12503 INC	HL
0045CB 66     12504 LD	H,(HL)		;Get high byte
0045CC 6F     12505 LD	L,A
0045CD C1     12506 POP	BC
0045CE E3     12507 EX	(SP),HL
0045CF C9     12508 RET			;Off to routine
0045D0 4F     12512 DTABLE:         DW	IAND		;0  & (INTEGER)
0045D1 46   
0045D2 9C     12513 DW	IBDIV		;1  DIV
0045D3 46   
0045D4 61     12514 DW	IEOR		;2  EOR
0045D5 46   
0045D6 85     12515 DW	IMOD		;3  MOD
0045D7 46   
0045D8 73     12516 DW	IOR		;4  |
0045D9 46   
0045DA 9A     12517 DW	ILE		;5  <=
0045DB 48   
0045DC A7     12518 DW	INE		;6  <>
0045DD 48   
0045DE 8F     12519 DW	IGE		;7  >=
0045DF 48   
0045E0 78     12520 DW	ILT		;8  <
0045E1 48   
0045E2 B2     12521 DW	IEQ		;9  =
0045E3 48   
0045E4 66     12522 DW	IMUL		;10 *
0045E5 47   
0045E6 BF     12523 DW	IADD		;11 +
0045E7 46   
0045E8 83     12524 DW	IGT		;12 >
0045E9 48   
0045EA A9     12525 DW	ISUB		;13 -
0045EB 46   
0045EC E1     12526 DW	IPOW		;14 ^
0045ED 47   
0045EE 1E     12527 DW	IDIV		;15 /
0045EF 47   
0045F0 02     12529 FTABLE:         DW	ABS		;16 ABS
0045F1 49   
0045F2 5E     12530 DW	ACS		;17 ACS
0045F3 4C   
0045F4 BA     12531 DW	ASN		;18 ASN
0045F5 4B   
0045F6 DF     12532 DW	ATN		;19 ATN
0045F7 4B   
0045F8 F8     12533 DW	COS		;20 COS
0045F9 49   
0045FA 2C     12534 DW	DEG		;21 DEG
0045FB 49   
0045FC 9D     12535 DW	EXP		;22 EXP
0045FD 4A   
0045FE 72     12536 DW	INT_		;23 INT_
0045FF 49   
004600 28     12537 DW	LN		;24 LN
004601 4B   
004602 A8     12538 DW	LOG		;25 LOG
004603 4B   
004604 0D     12539 DW	CPL_		;26 NOT
004605 49   
004606 34     12540 DW	RAD		;27 RAD
004607 49   
004608 4A     12541 DW	SGN		;28 SGN
004609 49   
00460A 03     12542 DW	SIN		;29 SIN
00460B 4A   
00460C 88     12543 DW	SQR		;30 SQR
00460D 49   
00460E DB     12544 DW	TAN		;31 TAN
00460F 49   
004610 A5     12546 DW	ZEROmat		;32 ZERO
004611 4F   
004612 7C     12547 DW	FONE		;33 FONE
004613 4A   
004614 B6     12548 DW	TRUE		;34 TRUE
004615 48   
004616 20     12549 DW	PI		;35 PI
004617 49   
004618 5A     12551 DW	VAL		;36 VAL
004619 49   
00461A 66     12552 DW	STRmat		;37 STR$
00461B 4C   
00461C 7B     12554 DW	SFIXmat		;38 FIX
00461D 4E   
00461E 36     12555 DW	SFLOAT		;39 FLOAT
00461F 4F   
004620 7B     12557 DW	FTEST		;40 TEST
004621 4F   
004622 8C     12558 DW	FCOMP		;41 COMPARE
004623 4F   
004624 C1     12560 DW	ISHL		;42 <<
004625 48   
004626 C1     12561 DW	ISHX		;43 <<<
004627 48   
004628 CE     12562 DW	ISAR		;44 >>
004629 48   
00462A E0     12563 DW	ISHR		;45 >>>
00462B 48   
00462C 4C     12565 RTABLE:         DW	FAND		;& (FLOATING-POINT)
00462D 46   
00462E 99     12566 DW	FBDIV		;DIV
00462F 46   
004630 5E     12567 DW	FEOR		;EOR
004631 46   
004632 82     12568 DW	FMOD		;MOD
004633 46   
004634 70     12569 DW	FOR		;|
004635 46   
004636 95     12570 DW	FLE		;<=
004637 48   
004638 A2     12571 DW	FNE		;<>
004639 48   
00463A 8A     12572 DW	FGE		;>=
00463B 48   
00463C 73     12573 DW	FLT		;<
00463D 48   
00463E AD     12574 DW	FEQ		;=
00463F 48   
004640 91     12575 DW	FMUL		;*
004641 47   
004642 C9     12576 DW	FADD		;+
004643 46   
004644 7E     12577 DW	FGT		;>
004645 48   
004646 B3     12578 DW	FSUB		;-
004647 46   
004648 49     12579 DW	FPOW		;^
004649 48   
00464A 21     12580 DW	FDIV		;/
00464B 47   
00464C CD     12591 FAND:           CALL	FIX2
00464D 72   
00464E 4E   
00464F 7C     12592 IAND:           LD	A,H
004650 A2     12593 AND	D
004651 67     12594 LD	H,A
004652 7D     12595 LD	A,L
004653 A3     12596 AND	E
004654 6F     12597 LD	L,A
004655 D9     12598 EXX
004656 7C     12599 LD	A,H
004657 A2     12600 AND	D
004658 67     12601 LD	H,A
004659 7D     12602 LD	A,L
00465A A3     12603 AND	E
00465B 6F     12604 LD	L,A
00465C D9     12605 EXX
00465D C9     12606 RET
00465E CD     12611 FEOR:           CALL	FIX2
00465F 72   
004660 4E   
004661 7C     12612 IEOR:           LD	A,H
004662 AA     12613 XOR	D
004663 67     12614 LD	H,A
004664 7D     12615 LD	A,L
004665 AB     12616 XOR	E
004666 6F     12617 LD	L,A
004667 D9     12618 EXX
004668 7C     12619 LD	A,H
004669 AA     12620 XOR	D
00466A 67     12621 LD	H,A
00466B 7D     12622 LD	A,L
00466C AB     12623 XOR	E
00466D 6F     12624 LD	L,A
00466E D9     12625 EXX
00466F C9     12626 RET
004670 CD     12631 FOR:            CALL	FIX2
004671 72   
004672 4E   
004673 7C     12632 IOR:            LD	A,H
004674 B2     12633 OR	D
004675 67     12634 LD	H,A
004676 7D     12635 LD	A,L
004677 B3     12636 OR	E
004678 6F     12637 LD	L,A
004679 D9     12638 EXX
00467A 7C     12639 LD	A,H
00467B B2     12640 OR	D
00467C 67     12641 LD	H,A
00467D 7D     12642 LD	A,L
00467E B3     12643 OR	E
00467F 6F     12644 LD	L,A
004680 D9     12645 EXX
004681 C9     12646 RET
004682 CD     12651 FMOD:           CALL	FIX2
004683 72   
004684 4E   
004685 7C     12652 IMOD:           LD	A,H
004686 AA     12653 XOR	D		;DIV RESULT SIGN
004687 CB     12654 BIT	7,H
004688 7C   
004689 CD     12655 CALL	ABS2		;MAKE BOTH POSITIVE
00468A 79   
00468B 51   
00468C 3E     12656 LD	A,-33
00468D DF   
00468E CD     12657 CALL	DIVA		;DIVIDE
00468F B5   
004690 50   
004691 D9     12658 EXX
004692 0E     12659 LD	C,0		;INTEGER MARKER
004693 00   
004694 08     12660 EX	AF,AF'
004695 C8     12661 RET	Z
004696 C3     12662 JP	NEGATE
004697 8A   
004698 4E   
004699 CD     12666 FBDIV:          CALL	FIX2
00469A 72   
00469B 4E   
00469C CD     12667 IBDIV:          CALL	IMOD
00469D 85   
00469E 46   
00469F B7     12668 OR	A
0046A0 CD     12669 CALL	SWAP
0046A1 60   
0046A2 4F   
0046A3 0E     12670 LD	C,0
0046A4 00   
0046A5 F0     12671 RET	P
0046A6 C3     12672 JP	NEGATE
0046A7 8A   
0046A8 4E   
0046A9 CD     12677 ISUB:           CALL	SUB
0046AA E8   
0046AB 4F   
0046AC E0     12678 RET	PO
0046AD CD     12679 CALL	ADD
0046AE E2   
0046AF 4F   
0046B0 CD     12680 CALL	FLOAT2
0046B1 2D   
0046B2 4F   
0046B3 7A     12681 FSUB:           LD	A,D
0046B4 EE     12682 XOR	80H		;CHANGE SIGN THEN ADD
0046B5 80   
0046B6 57     12683 LD	D,A
0046B7 18     12684 JR	FADD
0046B8 10   
0046B9 7C     12688 RSUB:           LD	A,H
0046BA EE     12689 XOR	80H
0046BB 80   
0046BC 67     12690 LD	H,A
0046BD 18     12691 JR	FADD
0046BE 0A   
0046BF CD     12696 IADD:           CALL	ADD
0046C0 E2   
0046C1 4F   
0046C2 E0     12697 RET	PO
0046C3 CD     12698 CALL	SUB
0046C4 E8   
0046C5 4F   
0046C6 CD     12699 CALL	FLOAT2
0046C7 2D   
0046C8 4F   
0046C9 05     12700 FADD:           DEC	B
0046CA 04     12701 INC	B
0046CB C8     12702 RET	Z		;ARG 2 ZERO
0046CC 0D     12703 DEC	C
0046CD 0C     12704 INC	C
0046CE CA     12705 JP	Z,SWAP		;ARG 1 ZERO
0046CF 60   
0046D0 4F   
0046D1 D9     12706 EXX
0046D2 01     12707 LD	BC,0		;INITIALISE
0046D3 00   
0046D4 00   
0046D5 D9     12708 EXX
0046D6 7C     12709 LD	A,H
0046D7 AA     12710 XOR	D		;XOR SIGNS
0046D8 F5     12711 PUSH	AF
0046D9 78     12712 LD	A,B
0046DA B9     12713 CP	C		;COMPARE EXPONENTS
0046DB DC     12714 CALL	C,SWAP		;MAKE DED'E'B LARGEST
0046DC 60   
0046DD 4F   
0046DE 78     12715 LD	A,B
0046DF CB     12716 SET	7,H		;IMPLIED 1
0046E0 FC   
0046E1 C4     12717 CALL	NZ,FIX		;ALIGN
0046E2 62   
0046E3 4E   
0046E4 F1     12718 POP	AF
0046E5 7A     12719 LD	A,D		;SIGN OF LARGER
0046E6 CB     12720 SET	7,D		;IMPLIED 1
0046E7 FA   
0046E8 FA     12721 JP	M,FADD3		;SIGNS DIFFERENT
0046E9 F5   
0046EA 46   
0046EB CD     12722 CALL	ADD		;HLH'L'=HLH'L'+DED'E'
0046EC E2   
0046ED 4F   
0046EE DC     12723 CALL	C,DIV2		;NORMALISE
0046EF 68   
0046F0 4F   
0046F1 CB     12724 SET	7,H
0046F2 FC   
0046F3 18     12725 JR	FADD4
0046F4 0A   
0046F5 CD     12727 FADD3:          CALL	SUB		;HLH'L'=HLH'L'-DED'E'
0046F6 E8   
0046F7 4F   
0046F8 DC     12728 CALL	C,NEG		;NEGATE HLH'L'B'C'
0046F9 9E   
0046FA 4E   
0046FB CD     12729 CALL	FLO48
0046FC 0A   
0046FD 4F   
0046FE 2F     12730 CPL			;CHANGE RESULT SIGN
0046FF D9     12731 FADD4:          EXX
004700 EB     12732 EX	DE,HL
004701 21     12733 LD	HL,8000H
004702 00   
004703 80   
004704 B7     12734 OR	A		;CLEAR CARRY
004705 ED     12735 SBC	HL,BC
004706 42   
004707 EB     12736 EX	DE,HL
004708 D9     12737 EXX
004709 CC     12738 CALL	Z,ODD		;ROUND UNBIASSED
00470A 5A   
00470B 4F   
00470C DC     12739 CALL	C,ADD1		;ROUND UP
00470D 4C   
00470E 4F   
00470F DC     12740 CALL	C,INCC
004710 74   
004711 4F   
004712 CB     12741 RES	7,H
004713 BC   
004714 0D     12742 DEC	C
004715 0C     12743 INC	C
004716 CA     12744 JP	Z,ZEROmat
004717 A5   
004718 4F   
004719 B7     12745 OR	A		;RESULT SIGNQ
00471A F0     12746 RET	P		;POSITIVE
00471B CB     12747 SET	7,H		;NEGATIVE
00471C FC   
00471D C9     12748 RET
00471E CD     12753 IDIV:           CALL	FLOAT2
00471F 2D   
004720 4F   
004721 05     12754 FDIV:           DEC	B		;TEST FOR ZERO
004722 04     12755 INC	B
004723 3E     12756 LD	A,DIVBY0
004724 12   
004725 CA     12757 JP	Z,ERROR_mat		;"Division by zero"
004726 AA   
004727 45   
004728 0D     12758 DEC	C		;TEST FOR ZERO
004729 0C     12759 INC	C
00472A C8     12760 RET	Z
00472B 7C     12761 LD	A,H
00472C AA     12762 XOR	D		;CALC. RESULT SIGN
00472D 08     12763 EX	AF,AF'		;SAVE SIGN
00472E CB     12764 SET	7,D		;REPLACE IMPLIED 1's
00472F FA   
004730 CB     12765 SET	7,H
004731 FC   
004732 C5     12766 PUSH	BC		;SAVE EXPONENTS
004733 42     12767 LD	B,D		;LOAD REGISTERS
004734 4B     12768 LD	C,E
004735 11     12769 LD	DE,0
004736 00   
004737 00   
004738 D9     12770 EXX
004739 42     12771 LD	B,D
00473A 4B     12772 LD	C,E
00473B 11     12773 LD	DE,0
00473C 00   
00473D 00   
00473E 3E     12774 LD	A,-32		;LOOP COUNTER
00473F E0   
004740 CD     12775 CALL	DIVA		;DIVIDE
004741 B5   
004742 50   
004743 D9     12776 EXX
004744 CB     12777 BIT	7,D
004745 7A   
004746 D9     12778 EXX
004747 CC     12779 CALL	Z,DIVB		;NORMALISE & INC A
004748 D0   
004749 50   
00474A EB     12780 EX	DE,HL
00474B D9     12781 EXX
00474C CB     12782 SRL	B		;DIVISOR/2
00474D 38   
00474E CB     12783 RR	C
00474F 19   
004750 B7     12784 OR	A		;CLEAR CARRY
004751 ED     12785 SBC	HL,BC		;REMAINDER-DIVISOR/2
004752 42   
004753 3F     12786 CCF
004754 EB     12787 EX	DE,HL		;RESULT IN HLH'L'
004755 CC     12788 CALL	Z,ODD		;ROUND UNBIASSED
004756 5A   
004757 4F   
004758 DC     12789 CALL	C,ADD1		;ROUND UP
004759 4C   
00475A 4F   
00475B C1     12790 POP	BC		;RESTORE EXPONENTS
00475C DC     12791 CALL	C,INCC
00475D 74   
00475E 4F   
00475F 1F     12792 RRA			;LSB OF A TO CARRY
004760 79     12793 LD	A,C		;COMPUTE NEW EXPONENT
004761 98     12794 SBC	A,B
004762 3F     12795 CCF
004763 C3     12796 JP	CHKOVF
004764 CA   
004765 47   
004766 7C     12800 IMUL:           LD	A,H
004767 AA     12801 XOR	D
004768 CD     12802 CALL	ABS2		;MAKE BOTH POSITIVE
004769 79   
00476A 51   
00476B 3E     12803 LD	A,-33
00476C DF   
00476D CD     12804 CALL	MULA		;MULTIPLY
00476E E3   
00476F 50   
004770 D9     12805 EXX
004771 0E     12806 LD	C,191		;PRESET EXPONENT
004772 BF   
004773 CD     12807 CALL	TESTmat		;TEST RANGE
004774 85   
004775 4F   
004776 20     12808 JR	NZ,IMUL1	;TOO BIG
004777 0D   
004778 CB     12809 BIT	7,D
004779 7A   
00477A 20     12810 JR	NZ,IMUL1
00477B 09   
00477C CD     12811 CALL	SWAP
00477D 60   
00477E 4F   
00477F 4A     12812 LD	C,D		;INTEGER MARKER
004780 08     12813 EX	AF,AF'
004781 F0     12814 RET	P
004782 C3     12815 JP	NEGATE
004783 8A   
004784 4E   
004785 0D     12817 IMUL1:          DEC	C
004786 CD     12818 CALL	SLA8
004787 4C   
004788 51   
004789 F2     12819 JP	P,IMUL1		;NORMALISE
00478A 85   
00478B 47   
00478C 08     12820 EX	AF,AF'
00478D F8     12821 RET	M
00478E CB     12822 RES	7,H		;POSITIVE
00478F BC   
004790 C9     12823 RET
004791 05     12827 FMUL:           DEC	B		;TEST FOR ZERO
004792 04     12828 INC	B
004793 CA     12829 JP	Z,ZEROmat
004794 A5   
004795 4F   
004796 0D     12830 DEC	C		;TEST FOR ZERO
004797 0C     12831 INC	C
004798 C8     12832 RET	Z
004799 7C     12833 LD	A,H
00479A AA     12834 XOR	D		;CALC. RESULT SIGN
00479B 08     12835 EX	AF,AF'
00479C CB     12836 SET	7,D		;REPLACE IMPLIED 1's
00479D FA   
00479E CB     12837 SET	7,H
00479F FC   
0047A0 C5     12838 PUSH	BC		;SAVE EXPONENTS
0047A1 44     12839 LD	B,H		;LOAD REGISTERS
0047A2 4D     12840 LD	C,L
0047A3 21     12841 LD	HL,0
0047A4 00   
0047A5 00   
0047A6 D9     12842 EXX
0047A7 44     12843 LD	B,H
0047A8 4D     12844 LD	C,L
0047A9 21     12845 LD	HL,0
0047AA 00   
0047AB 00   
0047AC 3E     12846 LD	A,-32		;LOOP COUNTER
0047AD E0   
0047AE CD     12847 CALL	MULA		;MULTIPLY
0047AF E3   
0047B0 50   
0047B1 DC     12848 CALL	C,MULB		;NORMALISE & INC A
0047B2 F7   
0047B3 50   
0047B4 D9     12849 EXX
0047B5 E5     12850 PUSH	HL
0047B6 21     12851 LD	HL,8000H
0047B7 00   
0047B8 80   
0047B9 B7     12852 OR	A		;CLEAR CARRY
0047BA ED     12853 SBC	HL,DE
0047BB 52   
0047BC E1     12854 POP	HL
0047BD CC     12855 CALL	Z,ODD		;ROUND UNBIASSED
0047BE 5A   
0047BF 4F   
0047C0 DC     12856 CALL	C,ADD1		;ROUND UP
0047C1 4C   
0047C2 4F   
0047C3 C1     12857 POP	BC		;RESTORE EXPONENTS
0047C4 DC     12858 CALL	C,INCC
0047C5 74   
0047C6 4F   
0047C7 1F     12859 RRA			;LSB OF A TO CARRY
0047C8 79     12860 LD	A,C		;COMPUTE NEW EXPONENT
0047C9 88     12861 ADC	A,B
0047CA 38     12862 CHKOVF:         JR	C,CHKO1
0047CB 05   
0047CC F2     12863 JP	P,ZEROmat		;UNDERFLOW
0047CD A5   
0047CE 4F   
0047CF 18     12864 JR	CHKO2
0047D0 03   
0047D1 FA     12865 CHKO1:          JP	M,OFLOW		;OVERFLOW
0047D2 76   
0047D3 4F   
0047D4 C6     12866 CHKO2:          ADD	A,80H
0047D5 80   
0047D6 4F     12867 LD	C,A
0047D7 CA     12868 JP	Z,ZEROmat
0047D8 A5   
0047D9 4F   
0047DA 08     12869 EX	AF,AF'		;RESTORE SIGN BIT
0047DB CB     12870 RES	7,H
0047DC BC   
0047DD F0     12871 RET	P
0047DE CB     12872 SET	7,H
0047DF FC   
0047E0 C9     12873 RET
0047E1 CD     12877 IPOW:           CALL	SWAP
0047E2 60   
0047E3 4F   
0047E4 CB     12878 BIT	7,H
0047E5 7C   
0047E6 F5     12879 PUSH	AF		;SAVE SIGN
0047E7 C4     12880 CALL	NZ,NEGATE
0047E8 8A   
0047E9 4E   
0047EA 48     12881 IPOW0:          LD	C,B
0047EB 06     12882 LD	B,32		;LOOP COUNTER
0047EC 20   
0047ED CD     12883 IPOW1:          CALL	X2
0047EE FF   
0047EF 4F   
0047F0 38     12884 JR	C,IPOW2
0047F1 08   
0047F2 10     12885 DJNZ	IPOW1
0047F3 F9   
0047F4 F1     12886 POP	AF
0047F5 D9     12887 EXX
0047F6 2C     12888 INC	L		;RESULT=1
0047F7 D9     12889 EXX
0047F8 4C     12890 LD	C,H
0047F9 C9     12891 RET
0047FA F1     12893 IPOW2:          POP	AF
0047FB C5     12894 PUSH	BC
0047FC EB     12895 EX	DE,HL
0047FD E5     12896 PUSH	HL
0047FE D9     12897 EXX
0047FF EB     12898 EX	DE,HL
004800 E5     12899 PUSH	HL
004801 D9     12900 EXX
004802 DD     12901 LD	IX,0
004803 21   
004804 00   
004805 00   
004806 DD     12902 ADD	IX,SP
004807 39   
004808 28     12903 JR	Z,IPOW4
004809 34   
00480A C5     12904 PUSH	BC
00480B D9     12905 EXX
00480C D5     12906 PUSH	DE
00480D D9     12907 EXX
00480E D5     12908 PUSH	DE
00480F CD     12909 CALL	SFLOAT
004810 36   
004811 4F   
004812 CD     12910 CALL	RECIP
004813 14   
004814 4B   
004815 CD     12911 CALL	STORE5
004816 8A   
004817 32   
004818 18     12912 JR	IPOW5
004819 1D   
00481A C5     12914 IPOW3:          PUSH	BC
00481B D9     12915 EXX
00481C CB     12916 SLA	E
00481D 23   
00481E CB     12917 RL	D
00481F 12   
004820 D5     12918 PUSH	DE
004821 D9     12919 EXX
004822 CB     12920 RL	E
004823 13   
004824 CB     12921 RL	D
004825 12   
004826 D5     12922 PUSH	DE
004827 3E     12923 LD	A,'*' & 0FH
004828 0A   
004829 F5     12924 PUSH	AF
00482A CD     12925 CALL	COPY
00482B 11   
00482C 50   
00482D CD     12926 CALL	OP		;SQUARE
00482E B0   
00482F 45   
004830 F1     12927 POP	AF
004831 CD     12928 CALL	DLOAD5
004832 75   
004833 1A   
004834 DC     12929 CALL	C,OP		;MULTIPLY BY X
004835 B0   
004836 45   
004837 D1     12930 IPOW5:          POP	DE
004838 D9     12931 EXX
004839 D1     12932 POP	DE
00483A D9     12933 EXX
00483B 79     12934 LD	A,C
00483C C1     12935 POP	BC
00483D 4F     12936 LD	C,A
00483E 10     12937 IPOW4:          DJNZ	IPOW3
00483F DA   
004840 F1     12938 POP	AF
004841 F1     12939 POP	AF
004842 F1     12940 POP	AF
004843 C9     12941 RET
004844 F1     12943 FPOW0:          POP	AF
004845 F1     12944 POP	AF
004846 F1     12945 POP	AF
004847 18     12946 JR	IPOW0
004848 A1   
004849 CB     12950 FPOW:           BIT	7,D
00484A 7A   
00484B F5     12951 PUSH	AF
00484C CD     12952 CALL	SWAP
00484D 60   
00484E 4F   
00484F CD     12953 CALL	PUSH5
004850 1F   
004851 50   
004852 0D     12954 DEC	C
004853 0C     12955 INC	C
004854 28     12956 JR	Z,FPOW0
004855 EE   
004856 3E     12957 LD	A,158
004857 9E   
004858 B9     12958 CP	C
004859 38     12959 JR	C,FPOW1
00485A 08   
00485B 3C     12960 INC	A
00485C CD     12961 CALL	FIX
00485D 62   
00485E 4E   
00485F 08     12962 EX	AF,AF'
004860 F2     12963 JP	P,FPOW0
004861 44   
004862 48   
004863 CD     12964 FPOW1:          CALL	SWAP
004864 60   
004865 4F   
004866 CD     12965 CALL	LN0
004867 2B   
004868 4B   
004869 CD     12966 CALL	POP5
00486A 28   
00486B 50   
00486C F1     12967 POP	AF
00486D CD     12968 CALL	FMUL
00486E 91   
00486F 47   
004870 C3     12969 JP	EXP0
004871 A0   
004872 4A   
004873 CD     12974 FLT:            CALL	FCP
004874 AF   
004875 4F   
004876 18     12975 JR	ILT1
004877 03   
004878 CD     12976 ILT:            CALL	ICP
004879 A2   
00487A 4F   
00487B D0     12977 ILT1:           RET	NC
00487C 18     12978 JR	TRUE
00487D 38   
00487E CD     12980 FGT:            CALL	FCP
00487F AF   
004880 4F   
004881 18     12981 JR	IGT1
004882 03   
004883 CD     12982 IGT:            CALL	ICP
004884 A2   
004885 4F   
004886 C8     12983 IGT1:           RET	Z
004887 D8     12984 RET	C
004888 18     12985 JR	TRUE
004889 2C   
00488A CD     12987 FGE:            CALL	FCP
00488B AF   
00488C 4F   
00488D 18     12988 JR	IGE1
00488E 03   
00488F CD     12989 IGE:            CALL	ICP
004890 A2   
004891 4F   
004892 D8     12990 IGE1:           RET	C
004893 18     12991 JR	TRUE
004894 21   
004895 CD     12993 FLE:            CALL	FCP
004896 AF   
004897 4F   
004898 18     12994 JR	ILE1
004899 03   
00489A CD     12995 ILE:            CALL	ICP
00489B A2   
00489C 4F   
00489D 28     12996 ILE1:           JR	Z,TRUE
00489E 17   
00489F D0     12997 RET	NC
0048A0 18     12998 JR	TRUE
0048A1 14   
0048A2 CD     13000 FNE:            CALL	FCP
0048A3 AF   
0048A4 4F   
0048A5 18     13001 JR	INE1
0048A6 03   
0048A7 CD     13002 INE:            CALL	ICP
0048A8 A2   
0048A9 4F   
0048AA C8     13003 INE1:           RET	Z
0048AB 18     13004 JR	TRUE
0048AC 09   
0048AD CD     13006 FEQ:            CALL	FCP
0048AE AF   
0048AF 4F   
0048B0 18     13007 JR	IEQ1
0048B1 03   
0048B2 CD     13008 IEQ:            CALL	ICP
0048B3 A2   
0048B4 4F   
0048B5 C0     13009 IEQ1:           RET	NZ
0048B6 21     13010 TRUE:           LD	HL,-1
0048B7 FF   
0048B8 FF   
0048B9 D9     13011 EXX
0048BA 21     13012 LD	HL,-1
0048BB FF   
0048BC FF   
0048BD D9     13013 EXX
0048BE AF     13014 XOR	A
0048BF 4F     13015 LD	C,A
0048C0 C9     13016 RET
0048C1 CD     13021 ISHL:           CALL	SHIFTS
0048C2 F2   
0048C3 48   
0048C4 28     13022 JR	Z,SHRET
0048C5 07   
0048C6 D9     13023 ISHL1:          EXX
0048C7 29     13024 ADD	HL,HL
0048C8 D9     13025 EXX
0048C9 ED     13026 ADC	HL,HL
0048CA 6A   
0048CB 10     13027 DJNZ	ISHL1
0048CC F9   
0048CD C9     13028 SHRET:          RET
0048CE CD     13030 ISAR:           CALL	SHIFTS
0048CF F2   
0048D0 48   
0048D1 28     13031 JR	Z,SHRET
0048D2 FA   
0048D3 CB     13032 ISAR1:          SRA	H
0048D4 2C   
0048D5 CB     13033 RR	L
0048D6 1D   
0048D7 D9     13034 EXX
0048D8 CB     13035 RR	H
0048D9 1C   
0048DA CB     13036 RR	L
0048DB 1D   
0048DC D9     13037 EXX
0048DD 10     13038 DJNZ	ISAR1
0048DE F4   
0048DF C9     13039 RET
0048E0 CD     13041 ISHR:           CALL	SHIFTS
0048E1 F2   
0048E2 48   
0048E3 28     13042 JR	Z,SHRET
0048E4 E8   
0048E5 CB     13043 ISHR1:          SRL	H
0048E6 3C   
0048E7 CB     13044 RR	L
0048E8 1D   
0048E9 D9     13045 EXX
0048EA CB     13046 RR	H
0048EB 1C   
0048EC CB     13047 RR	L
0048ED 1D   
0048EE D9     13048 EXX
0048EF 10     13049 DJNZ	ISHR1
0048F0 F4   
0048F1 C9     13050 RET
0048F2 CD     13052 SHIFTS:         CALL	FIX2
0048F3 72   
0048F4 4E   
0048F5 7A     13053 LD	A,D
0048F6 B3     13054 OR	E
0048F7 D9     13055 EXX
0048F8 B2     13056 OR	D
0048F9 7B     13057 LD	A,E
0048FA D9     13058 EXX
0048FB 06     13059 LD	B,32
0048FC 20   
0048FD 20     13060 JR	NZ,SHMAX
0048FE 02   
0048FF 47     13061 LD	B,A
004900 B7     13062 OR	A
004901 C9     13063 SHMAX:          RET
004902 CB     13074 ABS:            BIT	7,H
004903 7C   
004904 C8     13075 RET	Z		;POSITIVE/ZERO
004905 0D     13076 DEC	C
004906 0C     13077 INC	C
004907 CA     13078 JP	Z,NEGATE	;INTEGER
004908 8A   
004909 4E   
00490A CB     13079 RES	7,H
00490B BC   
00490C C9     13080 RET
00490D CD     13085 CPL_:           CALL	SFIXmat
00490E 7B   
00490F 4E   
004910 7C     13086 LD	A,H
004911 2F     13087 CPL
004912 67     13088 LD	H,A
004913 7D     13089 LD	A,L
004914 2F     13090 CPL
004915 6F     13091 LD	L,A
004916 D9     13092 EXX
004917 7C     13093 LD	A,H
004918 2F     13094 CPL
004919 67     13095 LD	H,A
00491A 7D     13096 LD	A,L
00491B 2F     13097 CPL
00491C 6F     13098 LD	L,A
00491D D9     13099 EXX
00491E AF     13100 XOR	A		;NUMERIC MARKER
00491F C9     13101 RET
004920 21     13106 PI:             LD	HL,490FH
004921 0F   
004922 49   
004923 D9     13107 EXX
004924 21     13108 LD	HL,0DAA2H
004925 A2   
004926 DA   
004927 D9     13109 EXX
004928 0E     13110 LD	C,81H
004929 81   
00492A AF     13111 XOR	A		;NUMERIC MARKER
00492B C9     13112 RET
00492C CD     13117 DEG:            CALL	FPI180
00492D 3C   
00492E 49   
00492F CD     13118 CALL	FMUL
004930 91   
004931 47   
004932 AF     13119 XOR	A
004933 C9     13120 RET
004934 CD     13125 RAD:            CALL	FPI180
004935 3C   
004936 49   
004937 CD     13126 CALL	FDIV
004938 21   
004939 47   
00493A AF     13127 XOR	A
00493B C9     13128 RET
00493C CD     13132 FPI180:         CALL	SFLOAT
00493D 36   
00493E 4F   
00493F 11     13133 LD	DE,652EH
004940 2E   
004941 65   
004942 D9     13134 EXX
004943 11     13135 LD	DE,0E0D3H
004944 D3   
004945 E0   
004946 D9     13136 EXX
004947 06     13137 LD	B,85H
004948 85   
004949 C9     13138 RET
00494A CD     13143 SGN:            CALL	TESTmat
00494B 85   
00494C 4F   
00494D B1     13144 OR	C
00494E C8     13145 RET	Z		;ZERO
00494F CB     13146 BIT	7,H
004950 7C   
004951 C2     13147 JP	NZ,TRUE		;-1
004952 B6   
004953 48   
004954 CD     13148 CALL	ZEROmat
004955 A5   
004956 4F   
004957 C3     13149 JP	ADD1		;1
004958 4C   
004959 4F   
00495A CD     13155 VAL:            CALL	SIGNQ
00495B 67   
00495C 51   
00495D F5     13156 PUSH	AF
00495E CD     13157 CALL	CON
00495F B8   
004960 4D   
004961 F1     13158 POP	AF
004962 FE     13159 CP	'-'
004963 2D   
004964 3E     13160 LD	A,0		;NUMERIC MARKER
004965 00   
004966 C0     13161 RET	NZ
004967 0D     13162 DEC	C
004968 0C     13163 INC	C
004969 CA     13164 JP	Z,NEGATE	;ZERO/INTEGER
00496A 8A   
00496B 4E   
00496C 7C     13165 LD	A,H
00496D EE     13166 XOR	80H		;CHANGE SIGN (FP)
00496E 80   
00496F 67     13167 LD	H,A
004970 AF     13168 XOR	A
004971 C9     13169 RET
004972 0D     13174 INT_:           DEC	C
004973 0C     13175 INC	C
004974 C8     13176 RET	Z		;ZERO/INTEGER
004975 3E     13177 LD	A,159
004976 9F   
004977 44     13178 LD	B,H		;B7=SIGN BIT
004978 CD     13179 CALL	FIX
004979 62   
00497A 4E   
00497B 08     13180 EX	AF,AF'
00497C A0     13181 AND	B
00497D FC     13182 CALL	M,ADD1		;NEGATIVE NON-INTEGER
00497E 4C   
00497F 4F   
004980 78     13183 LD	A,B
004981 B7     13184 OR	A
004982 FC     13185 CALL	M,NEGATE
004983 8A   
004984 4E   
004985 AF     13186 XOR	A
004986 4F     13187 LD	C,A
004987 C9     13188 RET
004988 CD     13193 SQR:            CALL	SFLOAT
004989 36   
00498A 4F   
00498B CB     13194 SQR0:           BIT	7,H
00498C 7C   
00498D 3E     13195 LD	A,NGROOT
00498E 15   
00498F C2     13196 JP	NZ,ERROR_mat	;"-ve root"
004990 AA   
004991 45   
004992 0D     13197 DEC	C
004993 0C     13198 INC	C
004994 C8     13199 RET	Z		;ZERO
004995 CB     13200 SET	7,H		;IMPLIED 1
004996 FC   
004997 CB     13201 BIT	0,C
004998 41   
004999 CC     13202 CALL	Z,DIV2		;MAKE EXPONENT ODD
00499A 68   
00499B 4F   
00499C 79     13203 LD	A,C
00499D D6     13204 SUB	80H
00499E 80   
00499F CB     13205 SRA	A		;HALVE EXPONENT
0049A0 2F   
0049A1 C6     13206 ADD	A,80H
0049A2 80   
0049A3 4F     13207 LD	C,A
0049A4 C5     13208 PUSH	BC		;SAVE EXPONENT
0049A5 EB     13209 EX	DE,HL
0049A6 21     13210 LD	HL,0
0049A7 00   
0049A8 00   
0049A9 44     13211 LD	B,H
0049AA 4D     13212 LD	C,L
0049AB D9     13213 EXX
0049AC EB     13214 EX	DE,HL
0049AD 21     13215 LD	HL,0
0049AE 00   
0049AF 00   
0049B0 44     13216 LD	B,H
0049B1 4D     13217 LD	C,L
0049B2 3E     13218 LD	A,-31
0049B3 E1   
0049B4 CD     13219 CALL	SQRA		;ROOT
0049B5 16   
0049B6 51   
0049B7 D9     13220 EXX
0049B8 CB     13221 BIT	7,B
0049B9 78   
0049BA D9     13222 EXX
0049BB CC     13223 CALL	Z,SQRA		;NORMALISE & INC A
0049BC 16   
0049BD 51   
0049BE CD     13224 CALL	SQRB
0049BF 35   
0049C0 51   
0049C1 B7     13225 OR	A		;CLEAR CARRY
0049C2 CD     13226 CALL	DIVB
0049C3 D0   
0049C4 50   
0049C5 CB     13227 RR	E		;LSB TO CARRY
0049C6 1B   
0049C7 60     13228 LD	H,B
0049C8 69     13229 LD	L,C
0049C9 D9     13230 EXX
0049CA 60     13231 LD	H,B
0049CB 69     13232 LD	L,C
0049CC DC     13233 CALL	C,ADD1		;ROUND UP
0049CD 4C   
0049CE 4F   
0049CF C1     13234 POP	BC		;RESTORE EXPONENT
0049D0 DC     13235 CALL	C,INCC
0049D1 74   
0049D2 4F   
0049D3 1F     13236 RRA
0049D4 9F     13237 SBC	A,A
0049D5 81     13238 ADD	A,C
0049D6 4F     13239 LD	C,A
0049D7 CB     13240 RES	7,H		;POSITIVE
0049D8 BC   
0049D9 AF     13241 XOR	A
0049DA C9     13242 RET
0049DB CD     13247 TAN:            CALL	SFLOAT
0049DC 36   
0049DD 4F   
0049DE CD     13248 CALL	PUSH5
0049DF 1F   
0049E0 50   
0049E1 CD     13249 CALL	COS0
0049E2 FB   
0049E3 49   
0049E4 CD     13250 CALL	POP5
0049E5 28   
0049E6 50   
0049E7 CD     13251 CALL	PUSH5
0049E8 1F   
0049E9 50   
0049EA CD     13252 CALL	SWAP
0049EB 60   
0049EC 4F   
0049ED CD     13253 CALL	SIN0
0049EE 06   
0049EF 4A   
0049F0 CD     13254 CALL	POP5
0049F1 28   
0049F2 50   
0049F3 CD     13255 CALL	FDIV
0049F4 21   
0049F5 47   
0049F6 AF     13256 XOR	A		;NUMERIC MARKER
0049F7 C9     13257 RET
0049F8 CD     13262 COS:            CALL	SFLOAT
0049F9 36   
0049FA 4F   
0049FB CD     13263 COS0:           CALL	SCALE
0049FC AB   
0049FD 4E   
0049FE 1C     13264 INC	E
0049FF 1C     13265 INC	E
004A00 7B     13266 LD	A,E
004A01 18     13267 JR	SIN1
004A02 0E   
004A03 CD     13272 SIN:            CALL	SFLOAT
004A04 36   
004A05 4F   
004A06 E5     13273 SIN0:           PUSH	HL		;H7=SIGN
004A07 CD     13274 CALL	SCALE
004A08 AB   
004A09 4E   
004A0A F1     13275 POP	AF
004A0B 07     13276 RLCA
004A0C 07     13277 RLCA
004A0D 07     13278 RLCA
004A0E E6     13279 AND	4
004A0F 04   
004A10 AB     13280 XOR	E
004A11 F5     13281 SIN1:           PUSH	AF		;OCTANT
004A12 CB     13282 RES	7,H
004A13 BC   
004A14 1F     13283 RRA
004A15 CD     13284 CALL	PIBY4
004A16 92   
004A17 4A   
004A18 DC     13285 CALL	C,RSUB		;X=(PI/4)-X
004A19 B9   
004A1A 46   
004A1B F1     13286 POP	AF
004A1C F5     13287 PUSH	AF
004A1D E6     13288 AND	3
004A1E 03   
004A1F E2     13289 JP	PO,SIN2		;USE COSINE APPROX.
004A20 50   
004A21 4A   
004A22 CD     13290 CALL	PUSH5		;SAVE X
004A23 1F   
004A24 50   
004A25 CD     13291 CALL	SQUARE		;PUSH X*X
004A26 19   
004A27 50   
004A28 CD     13292 CALL	POLY
004A29 52   
004A2A 50   
004A2B B7     13293 DW	0A8B7H		;a(8)
004A2C A8   
004A2D 11     13294 DW	3611H
004A2E 36   
004A2F 6D     13295 DB	6DH
004A30 26     13296 DW	0DE26H		;a(6)
004A31 DE   
004A32 05     13297 DW	0D005H
004A33 D0   
004A34 73     13298 DB	73H
004A35 C0     13299 DW	80C0H		;a(4)
004A36 80   
004A37 88     13300 DW	888H
004A38 08   
004A39 79     13301 DB	79H
004A3A 9D     13302 DW	0AA9DH		;a(2)
004A3B AA   
004A3C AA     13303 DW	0AAAAH
004A3D AA   
004A3E 7D     13304 DB	7DH
004A3F 00     13305 DW	0		;a(0)
004A40 00   
004A41 00     13306 DW	0
004A42 00   
004A43 80     13307 DB	80H
004A44 CD     13308 CALL	POP5
004A45 28   
004A46 50   
004A47 CD     13309 CALL	POP5
004A48 28   
004A49 50   
004A4A CD     13310 CALL	FMUL
004A4B 91   
004A4C 47   
004A4D C3     13311 JP	SIN3
004A4E 72   
004A4F 4A   
004A50 CD     13313 SIN2:           CALL	SQUARE		;PUSH X*X
004A51 19   
004A52 50   
004A53 CD     13314 CALL	POLY
004A54 52   
004A55 50   
004A56 71     13315 DW	0D571H		;b(8)
004A57 D5   
004A58 78     13316 DW	4C78H
004A59 4C   
004A5A 70     13317 DB	70H
004A5B AF     13318 DW	94AFH		;b(6)
004A5C 94   
004A5D 03     13319 DW	0B603H
004A5E B6   
004A5F 76     13320 DB	76H
004A60 C8     13321 DW	9CC8H		;b(4)
004A61 9C   
004A62 AA     13322 DW	2AAAH
004A63 2A   
004A64 7B     13323 DB	7BH
004A65 DD     13324 DW	0FFDDH		;b(2)
004A66 FF   
004A67 FF     13325 DW	0FFFFH
004A68 FF   
004A69 7E     13326 DB	7EH
004A6A 00     13327 DW	0		;b(0)
004A6B 00   
004A6C 00     13328 DW	0
004A6D 00   
004A6E 80     13329 DB	80H
004A6F CD     13330 CALL	POP5
004A70 28   
004A71 50   
004A72 F1     13331 SIN3:           POP	AF
004A73 E6     13332 AND	4
004A74 04   
004A75 C8     13333 RET	Z
004A76 0D     13334 DEC	C
004A77 0C     13335 INC	C
004A78 C8     13336 RET	Z		;ZERO
004A79 CB     13337 SET	7,H		;MAKE NEGATIVE
004A7A FC   
004A7B C9     13338 RET
004A7C 21     13342 FONE:           LD	HL,0
004A7D 00   
004A7E 00   
004A7F D9     13343 EXX
004A80 21     13344 LD	HL,0
004A81 00   
004A82 00   
004A83 D9     13345 EXX
004A84 0E     13346 LD	C,80H
004A85 80   
004A86 C9     13347 RET
004A87 11     13349 DONE:           LD	DE,0
004A88 00   
004A89 00   
004A8A D9     13350 EXX
004A8B 11     13351 LD	DE,0
004A8C 00   
004A8D 00   
004A8E D9     13352 EXX
004A8F 06     13353 LD	B,80H
004A90 80   
004A91 C9     13354 RET
004A92 11     13356 PIBY4:          LD	DE,490FH
004A93 0F   
004A94 49   
004A95 D9     13357 EXX
004A96 11     13358 LD	DE,0DAA2H
004A97 A2   
004A98 DA   
004A99 D9     13359 EXX
004A9A 06     13360 LD	B,7FH
004A9B 7F   
004A9C C9     13361 RET
004A9D CD     13366 EXP:            CALL	SFLOAT
004A9E 36   
004A9F 4F   
004AA0 CD     13367 EXP0:           CALL	LN2		;LN(2)
004AA1 1D   
004AA2 4B   
004AA3 D9     13368 EXX
004AA4 1D     13369 DEC	E
004AA5 01     13370 LD	BC,0D1CFH	;0.6931471805599453
004AA6 CF   
004AA7 D1   
004AA8 D9     13371 EXX
004AA9 E5     13372 PUSH	HL		;H7=SIGN
004AAA CD     13373 CALL	MOD48		;"MODULUS"
004AAB BB   
004AAC 4E   
004AAD F1     13374 POP	AF
004AAE CB     13375 BIT	7,E
004AAF 7B   
004AB0 28     13376 JR	Z,EXP1
004AB1 09   
004AB2 17     13377 RLA
004AB3 DA     13378 JP	C,ZEROmat
004AB4 A5   
004AB5 4F   
004AB6 3E     13379 LD	A,EXPRNG
004AB7 18   
004AB8 C3     13380 JP	ERROR_mat		;"Exp range"
004AB9 AA   
004ABA 45   
004ABB E6     13382 EXP1:           AND	80H
004ABC 80   
004ABD B3     13383 OR	E
004ABE F5     13384 PUSH	AF		;INTEGER PART
004ABF CB     13385 RES	7,H
004AC0 BC   
004AC1 CD     13386 CALL	PUSH5		;PUSH X*LN(2)
004AC2 1F   
004AC3 50   
004AC4 CD     13387 CALL	POLY
004AC5 52   
004AC6 50   
004AC7 72     13388 DW	4072H		;a(7)
004AC8 40   
004AC9 2E     13389 DW	942EH
004ACA 94   
004ACB 73     13390 DB	73H
004ACC 65     13391 DW	6F65H		;a(6)
004ACD 6F   
004ACE 4F     13392 DW	2E4FH
004ACF 2E   
004AD0 76     13393 DB	76H
004AD1 37     13394 DW	6D37H		;a(5)
004AD2 6D   
004AD3 02     13395 DW	8802H
004AD4 88   
004AD5 79     13396 DB	79H
004AD6 12     13397 DW	0E512H		;a(4)
004AD7 E5   
004AD8 A0     13398 DW	2AA0H
004AD9 2A   
004ADA 7B     13399 DB	7BH
004ADB 14     13400 DW	4F14H		;a(3)
004ADC 4F   
004ADD AA     13401 DW	0AAAAH
004ADE AA   
004ADF 7D     13402 DB	7DH
004AE0 56     13403 DW	0FD56H		;a(2)
004AE1 FD   
004AE2 FF     13404 DW	7FFFH
004AE3 7F   
004AE4 7E     13405 DB	7EH
004AE5 FE     13406 DW	0FFFEH		;a(1)
004AE6 FF   
004AE7 FF     13407 DW	0FFFFH
004AE8 FF   
004AE9 7F     13408 DB	7FH
004AEA 00     13409 DW	0		;a(0)
004AEB 00   
004AEC 00     13410 DW	0
004AED 00   
004AEE 80     13411 DB	80H
004AEF CD     13412 CALL	POP5
004AF0 28   
004AF1 50   
004AF2 F1     13413 POP	AF
004AF3 F5     13414 PUSH	AF
004AF4 F4     13415 CALL	P,RECIP		;X=1/X
004AF5 14   
004AF6 4B   
004AF7 F1     13416 POP	AF
004AF8 F2     13417 JP	P,EXP4
004AF9 FF   
004AFA 4A   
004AFB E6     13418 AND	7FH
004AFC 7F   
004AFD ED     13419 NEG
004AFE 44   
004AFF C6     13420 EXP4:           ADD	A,80H
004B00 80   
004B01 81     13421 ADD	A,C
004B02 38     13422 JR	C,EXP2
004B03 05   
004B04 F2     13423 JP	P,ZEROmat		;UNDERFLOW
004B05 A5   
004B06 4F   
004B07 18     13424 JR	EXP3
004B08 03   
004B09 FA     13425 EXP2:           JP	M,OFLOW		;OVERFLOW
004B0A 76   
004B0B 4F   
004B0C C6     13426 EXP3:           ADD	A,80H
004B0D 80   
004B0E CA     13427 JP	Z,ZEROmat
004B0F A5   
004B10 4F   
004B11 4F     13428 LD	C,A
004B12 AF     13429 XOR	A		;NUMERIC MARKER
004B13 C9     13430 RET
004B14 CD     13432 RECIP:          CALL	DONE
004B15 87   
004B16 4A   
004B17 CD     13433 RDIV:           CALL	SWAP
004B18 60   
004B19 4F   
004B1A C3     13434 JP	FDIV		;RECIPROCAL
004B1B 21   
004B1C 47   
004B1D 11     13436 LN2:            LD	DE,3172H	;LN(2)
004B1E 72   
004B1F 31   
004B20 D9     13437 EXX
004B21 11     13438 LD	DE,17F8H
004B22 F8   
004B23 17   
004B24 D9     13439 EXX
004B25 06     13440 LD	B,7FH
004B26 7F   
004B27 C9     13441 RET
004B28 CD     13446 LN:             CALL	SFLOAT
004B29 36   
004B2A 4F   
004B2B 3E     13447 LN0:            LD	A,LOGRNG
004B2C 16   
004B2D CB     13448 BIT	7,H
004B2E 7C   
004B2F C2     13449 JP	NZ,ERROR_mat	;"Log range"
004B30 AA   
004B31 45   
004B32 0C     13450 INC	C
004B33 0D     13451 DEC	C
004B34 CA     13452 JP	Z,ERROR_mat
004B35 AA   
004B36 45   
004B37 11     13453 LD	DE,3504H	;SQR(2)
004B38 04   
004B39 35   
004B3A D9     13454 EXX
004B3B 11     13455 LD	DE,0F333H	;1.41421356237
004B3C 33   
004B3D F3   
004B3E D9     13456 EXX
004B3F CD     13457 CALL	ICP0		;MANTISSA>SQR(2)?
004B40 B7   
004B41 4F   
004B42 79     13458 LD	A,C		;EXPONENT
004B43 0E     13459 LD	C,80H		;1 <= X < 2
004B44 80   
004B45 38     13460 JR	C,LN4
004B46 02   
004B47 0D     13461 DEC	C
004B48 3C     13462 INC	A
004B49 F5     13463 LN4:            PUSH	AF		;SAVE EXPONENT
004B4A CD     13464 CALL	RATIO		;X=(X-1)/(X+1)
004B4B 34   
004B4C 50   
004B4D CD     13465 CALL	PUSH5
004B4E 1F   
004B4F 50   
004B50 CD     13466 CALL	SQUARE		;PUSH X*X
004B51 19   
004B52 50   
004B53 CD     13467 CALL	POLY
004B54 52   
004B55 50   
004B56 48     13468 DW	0CC48H		;a(9)
004B57 CC   
004B58 FB     13469 DW	74FBH
004B59 74   
004B5A 7D     13470 DB	7DH
004B5B AF     13471 DW	0AEAFH		;a(7)
004B5C AE   
004B5D FF     13472 DW	11FFH
004B5E 11   
004B5F 7E     13473 DB	7EH
004B60 8C     13474 DW	0D98CH		;a(5)
004B61 D9   
004B62 CD     13475 DW	4CCDH
004B63 4C   
004B64 7E     13476 DB	7EH
004B65 E3     13477 DW	0A9E3H		;a(3)
004B66 A9   
004B67 AA     13478 DW	2AAAH
004B68 2A   
004B69 7F     13479 DB	7FH
004B6A 00     13480 DW	0		;a(1)
004B6B 00   
004B6C 00     13481 DW	0
004B6D 00   
004B6E 81     13482 DB	81H
004B6F CD     13483 CALL	POP5
004B70 28   
004B71 50   
004B72 CD     13484 CALL	POP5
004B73 28   
004B74 50   
004B75 CD     13485 CALL	FMUL
004B76 91   
004B77 47   
004B78 F1     13486 POP	AF		;EXPONENT
004B79 CD     13487 CALL	PUSH5
004B7A 1F   
004B7B 50   
004B7C 08     13488 EX	AF,AF'
004B7D CD     13489 CALL	ZEROmat
004B7E A5   
004B7F 4F   
004B80 08     13490 EX	AF,AF'
004B81 D6     13491 SUB	80H
004B82 80   
004B83 28     13492 JR	Z,LN3
004B84 1B   
004B85 30     13493 JR	NC,LN1
004B86 02   
004B87 2F     13494 CPL
004B88 3C     13495 INC	A
004B89 67     13496 LN1:            LD	H,A
004B8A 0E     13497 LD	C,87H
004B8B 87   
004B8C F5     13498 PUSH	AF
004B8D CD     13499 CALL	FLOAT
004B8E 1C   
004B8F 4F   
004B90 CB     13500 RES	7,H
004B91 BC   
004B92 CD     13501 CALL	LN2
004B93 1D   
004B94 4B   
004B95 CD     13502 CALL	FMUL
004B96 91   
004B97 47   
004B98 F1     13503 POP	AF
004B99 30     13504 JR	NC,LN3
004B9A 05   
004B9B FA     13505 JP	M,LN3
004B9C A0   
004B9D 4B   
004B9E CB     13506 SET	7,H
004B9F FC   
004BA0 CD     13507 LN3:            CALL	POP5
004BA1 28   
004BA2 50   
004BA3 CD     13508 CALL	FADD
004BA4 C9   
004BA5 46   
004BA6 AF     13509 XOR	A
004BA7 C9     13510 RET
004BA8 CD     13515 LOG:            CALL	LN
004BA9 28   
004BAA 4B   
004BAB 11     13516 LD	DE,5E5BH	;LOG(e)
004BAC 5B   
004BAD 5E   
004BAE D9     13517 EXX
004BAF 11     13518 LD	DE,0D8A9H
004BB0 A9   
004BB1 D8   
004BB2 D9     13519 EXX
004BB3 06     13520 LD	B,7EH
004BB4 7E   
004BB5 CD     13521 CALL	FMUL
004BB6 91   
004BB7 47   
004BB8 AF     13522 XOR	A
004BB9 C9     13523 RET
004BBA CD     13528 ASN:            CALL	SFLOAT
004BBB 36   
004BBC 4F   
004BBD CD     13529 CALL	PUSH5
004BBE 1F   
004BBF 50   
004BC0 CD     13530 CALL	COPY
004BC1 11   
004BC2 50   
004BC3 CD     13531 CALL	FMUL
004BC4 91   
004BC5 47   
004BC6 CD     13532 CALL	DONE
004BC7 87   
004BC8 4A   
004BC9 CD     13533 CALL	RSUB
004BCA B9   
004BCB 46   
004BCC CD     13534 CALL	SQR0
004BCD 8B   
004BCE 49   
004BCF CD     13535 CALL	POP5
004BD0 28   
004BD1 50   
004BD2 0C     13536 INC	C
004BD3 0D     13537 DEC	C
004BD4 3E     13538 LD	A,2
004BD5 02   
004BD6 D5     13539 PUSH	DE
004BD7 28     13540 JR	Z,ACS1
004BD8 70   
004BD9 D1     13541 POP	DE
004BDA CD     13542 CALL	RDIV
004BDB 17   
004BDC 4B   
004BDD 18     13543 JR	ATN0
004BDE 03   
004BDF CD     13548 ATN:            CALL	SFLOAT
004BE0 36   
004BE1 4F   
004BE2 E5     13549 ATN0:           PUSH	HL		;SAVE SIGN
004BE3 CB     13550 RES	7,H
004BE4 BC   
004BE5 11     13551 LD	DE,5413H	;TAN(PI/8)=SQR(2)-1
004BE6 13   
004BE7 54   
004BE8 D9     13552 EXX
004BE9 11     13553 LD	DE,0CCD0H
004BEA D0   
004BEB CC   
004BEC D9     13554 EXX
004BED 06     13555 LD	B,7EH
004BEE 7E   
004BEF CD     13556 CALL	FCP0		;COMPARE
004BF0 B4   
004BF1 4F   
004BF2 06     13557 LD	B,0
004BF3 00   
004BF4 38     13558 JR	C,ATN2
004BF5 1C   
004BF6 11     13559 LD	DE,1A82H	;TAN(3*PI/8)=SQR(2)+1
004BF7 82   
004BF8 1A   
004BF9 D9     13560 EXX
004BFA 11     13561 LD	DE,799AH
004BFB 9A   
004BFC 79   
004BFD D9     13562 EXX
004BFE 06     13563 LD	B,81H
004BFF 81   
004C00 CD     13564 CALL	FCP0		;COMPARE
004C01 B4   
004C02 4F   
004C03 38     13565 JR	C,ATN1
004C04 08   
004C05 CD     13566 CALL	RECIP		;X=1/X
004C06 14   
004C07 4B   
004C08 06     13567 LD	B,2
004C09 02   
004C0A C3     13568 JP	ATN2
004C0B 12   
004C0C 4C   
004C0D CD     13569 ATN1:           CALL	RATIO		;X=(X-1)/(X+1)
004C0E 34   
004C0F 50   
004C10 06     13570 LD	B,1
004C11 01   
004C12 C5     13571 ATN2:           PUSH	BC		;SAVE FLAG
004C13 CD     13572 CALL	PUSH5
004C14 1F   
004C15 50   
004C16 CD     13573 CALL	SQUARE		;PUSH X*X
004C17 19   
004C18 50   
004C19 CD     13574 CALL	POLY
004C1A 52   
004C1B 50   
004C1C 35     13575 DW	0F335H		;a(13)
004C1D F3   
004C1E D8     13576 DW	37D8H
004C1F 37   
004C20 7B     13577 DB	7BH
004C21 91     13578 DW	6B91H		;a(11)
004C22 6B   
004C23 B9     13579 DW	0AAB9H
004C24 AA   
004C25 7C     13580 DB	7CH
004C26 DE     13581 DW	41DEH		;a(9)
004C27 41   
004C28 97     13582 DW	6197H
004C29 61   
004C2A 7C     13583 DB	7CH
004C2B 7B     13584 DW	9D7BH		;a(7)
004C2C 9D   
004C2D 37     13585 DW	9237H
004C2E 92   
004C2F 7D     13586 DB	7DH
004C30 5A     13587 DW	2A5AH		;a(5)
004C31 2A   
004C32 CC     13588 DW	4CCCH
004C33 4C   
004C34 7D     13589 DB	7DH
004C35 5C     13590 DW	0A95CH		;a(3)
004C36 A9   
004C37 AA     13591 DW	0AAAAH
004C38 AA   
004C39 7E     13592 DB	7EH
004C3A 00     13593 DW	0		;a(1)
004C3B 00   
004C3C 00     13594 DW	0
004C3D 00   
004C3E 80     13595 DB	80H
004C3F CD     13596 CALL	POP5
004C40 28   
004C41 50   
004C42 CD     13597 CALL	POP5
004C43 28   
004C44 50   
004C45 CD     13598 CALL	FMUL
004C46 91   
004C47 47   
004C48 F1     13599 POP	AF
004C49 CD     13600 ACS1:           CALL	PIBY4		;PI/4
004C4A 92   
004C4B 4A   
004C4C 1F     13601 RRA
004C4D F5     13602 PUSH	AF
004C4E DC     13603 CALL	C,FADD
004C4F C9   
004C50 46   
004C51 F1     13604 POP	AF
004C52 04     13605 INC	B
004C53 1F     13606 RRA
004C54 DC     13607 CALL	C,RSUB
004C55 B9   
004C56 46   
004C57 F1     13608 POP	AF
004C58 B7     13609 OR	A
004C59 F0     13610 RET	P
004C5A CB     13611 SET	7,H		;MAKE NEGATIVE
004C5B FC   
004C5C AF     13612 XOR	A
004C5D C9     13613 RET
004C5E CD     13618 ACS:            CALL	ASN
004C5F BA   
004C60 4B   
004C61 3E     13619 LD	A,2
004C62 02   
004C63 F5     13620 PUSH	AF
004C64 18     13621 JR	ACS1
004C65 E3   
004C66 CD     13631 STRmat:            CALL	SFLOAT
004C67 36   
004C68 4F   
004C69 06     13632 LD	B,0		;DEFAULT PT. POSITION
004C6A 00   
004C6B CB     13633 BIT	7,H		;NEGATIVE?
004C6C 7C   
004C6D 28     13634 JR	Z,STR10
004C6E 06   
004C6F CB     13635 RES	7,H
004C70 BC   
004C71 3E     13636 LD	A,'-'
004C72 2D   
004C73 12     13637 LD	(DE),A		;STORE SIGN
004C74 13     13638 INC	DE
004C75 AF     13639 STR10:          XOR	A		;CLEAR A
004C76 B9     13640 CP	C
004C77 28     13641 JR	Z,STR2mat		;ZERO
004C78 47   
004C79 D5     13642 PUSH	DE		;SAVE TEXT POINTER
004C7A 78     13643 LD	A,B
004C7B F5     13644 STR11:          PUSH	AF		;SAVE DECIMAL COUNTER
004C7C 79     13645 LD	A,C		;BINARY EXPONENT
004C7D FE     13646 CP	161
004C7E A1   
004C7F 30     13647 JR	NC,STR14
004C80 1A   
004C81 FE     13648 CP	155
004C82 9B   
004C83 30     13649 JR	NC,STR15
004C84 25   
004C85 2F     13650 CPL
004C86 FE     13651 CP	225
004C87 E1   
004C88 38     13652 JR	C,STR13
004C89 02   
004C8A 3E     13653 LD	A,-8
004C8B F8   
004C8C C6     13654 STR13:          ADD	A,28
004C8D 1C   
004C8E CD     13655 CALL	POWR10
004C8F 79   
004C90 50   
004C91 F5     13656 PUSH	AF
004C92 CD     13657 CALL	FMUL
004C93 91   
004C94 47   
004C95 F1     13658 POP	AF
004C96 47     13659 LD	B,A
004C97 F1     13660 POP	AF
004C98 90     13661 SUB	B
004C99 18     13662 JR	STR11
004C9A E0   
004C9B D6     13663 STR14:          SUB	32
004C9C 20   
004C9D CD     13664 CALL	POWR10
004C9E 79   
004C9F 50   
004CA0 F5     13665 PUSH	AF
004CA1 CD     13666 CALL	FDIV
004CA2 21   
004CA3 47   
004CA4 F1     13667 POP	AF
004CA5 47     13668 LD	B,A
004CA6 F1     13669 POP	AF
004CA7 80     13670 ADD	A,B
004CA8 18     13671 JR	STR11
004CA9 D1   
004CAA 3E     13672 STR15:          LD	A,9
004CAB 09   
004CAC CD     13673 CALL	POWR10		;10^9
004CAD 79   
004CAE 50   
004CAF CD     13674 CALL	FCP0
004CB0 B4   
004CB1 4F   
004CB2 79     13675 LD	A,C
004CB3 C1     13676 POP	BC
004CB4 4F     13677 LD	C,A
004CB5 CB     13678 SET	7,H		;IMPLIED 1
004CB6 FC   
004CB7 DC     13679 CALL	C,X10B		;X10, DEC B
004CB8 D6   
004CB9 4F   
004CBA D1     13680 POP	DE		;RESTORE TEXT POINTER
004CBB CB     13681 RES	7,C
004CBC B9   
004CBD 3E     13682 LD	A,0
004CBE 00   
004CBF 17     13683 RLA			;PUT CARRY IN LSB
004CC0 0C     13691 STR2mat:           INC	C
004CC1 08     13692 EX	AF,AF'		;SAVE A
004CC2 78     13693 LD	A,B
004CC3 DD     13694 BIT	1,(IX+2)
004CC4 CB   
004CC5 02   
004CC6 4E   
004CC7 20     13695 JR	NZ,STR20
004CC8 08   
004CC9 AF     13696 XOR	A
004CCA DD     13697 CP	(IX+1)
004CCB BE   
004CCC 01   
004CCD 28     13698 JR	Z,STR21
004CCE 0A   
004CCF 3E     13699 LD	A,-10
004CD0 F6   
004CD1 DD     13700 STR20:          ADD	A,(IX+1)	;SIG. FIG. COUNT
004CD2 86   
004CD3 01   
004CD4 B7     13701 OR	A		;CLEAR CARRY
004CD5 FA     13702 JP	M,STR21
004CD6 D9   
004CD7 4C   
004CD8 AF     13703 XOR	A
004CD9 F5     13704 STR21:          PUSH	AF
004CDA 08     13705 EX	AF,AF'		;RESTORE A
004CDB CD     13706 STR22:          CALL	X2		;RL AHLH'L'
004CDC FF   
004CDD 4F   
004CDE 8F     13707 ADC	A,A
004CDF FE     13708 CP	10
004CE0 0A   
004CE1 38     13709 JR	C,STR23
004CE2 05   
004CE3 D6     13710 SUB	10
004CE4 0A   
004CE5 D9     13711 EXX
004CE6 2C     13712 INC	L		;SET RESULT BIT
004CE7 D9     13713 EXX
004CE8 0D     13714 STR23:          DEC	C
004CE9 20     13715 JR	NZ,STR22	;32 TIMES
004CEA F0   
004CEB 4F     13716 LD	C,A		;REMAINDER
004CEC 7C     13717 LD	A,H
004CED E6     13718 AND	3FH		;CLEAR OUT JUNK
004CEE 3F   
004CEF 67     13719 LD	H,A
004CF0 F1     13720 POP	AF
004CF1 F2     13721 JP	P,STR24
004CF2 FE   
004CF3 4C   
004CF4 3C     13722 INC	A
004CF5 20     13723 JR	NZ,STR26
004CF6 1C   
004CF7 3E     13724 LD	A,4
004CF8 04   
004CF9 B9     13725 CP	C		;ROUND UP?
004CFA 3E     13726 LD	A,0
004CFB 00   
004CFC 18     13727 JR	STR26
004CFD 15   
004CFE F5     13728 STR24:          PUSH	AF
004CFF 79     13729 LD	A,C
004D00 CE     13730 ADC	A,'0'		;ADD CARRY
004D01 30   
004D02 FE     13731 CP	'0'
004D03 30   
004D04 28     13732 JR	Z,STR25		;SUPPRESS ZERO
004D05 05   
004D06 FE     13733 CP	'9'+1
004D07 3A   
004D08 3F     13734 CCF
004D09 30     13735 JR	NC,STR26
004D0A 08   
004D0B E3     13736 STR25:          EX	(SP),HL
004D0C CB     13737 BIT	6,L		;ZERO FLAG
004D0D 75   
004D0E E3     13738 EX	(SP),HL
004D0F 20     13739 JR	NZ,STR27
004D10 05   
004D11 3E     13740 LD	A,'0'
004D12 30   
004D13 3C     13741 STR26:          INC	A		;SET +VE
004D14 3D     13742 DEC	A
004D15 F5     13743 PUSH	AF		;PUT ON STACK + CARRY
004D16 04     13744 STR27:          INC	B
004D17 CD     13745 CALL	TESTmat		;IS HLH'L' ZERO?
004D18 85   
004D19 4F   
004D1A 0E     13746 LD	C,32
004D1B 20   
004D1C 3E     13747 LD	A,0
004D1D 00   
004D1E 20     13748 JR	NZ,STR22
004D1F BB   
004D20 F1     13749 POP	AF
004D21 F5     13750 PUSH	AF
004D22 3E     13751 LD	A,0
004D23 00   
004D24 38     13752 JR	C,STR22
004D25 B5   
004D26 EB     13760 STR3:           EX	DE,HL		;STRING POINTER
004D27 0E     13761 LD	C,-1		;FLAG "E"
004D28 FF   
004D29 16     13762 LD	D,1
004D2A 01   
004D2B DD     13763 LD	E,(IX+1)	;f2
004D2C 5E   
004D2D 01   
004D2E DD     13764 BIT	0,(IX+2)
004D2F CB   
004D30 02   
004D31 46   
004D32 20     13765 JR	NZ,STR34	;E MODE
004D33 32   
004D34 DD     13766 BIT	1,(IX+2)
004D35 CB   
004D36 02   
004D37 4E   
004D38 28     13767 JR	Z,STR31
004D39 11   
004D3A 78     13768 LD	A,B		;F MODE
004D3B B7     13769 OR	A
004D3C 28     13770 JR	Z,STR30
004D3D 04   
004D3E FA     13771 JP	M,STR30
004D3F 42   
004D40 4D   
004D41 50     13772 LD	D,B
004D42 7A     13773 STR30:          LD	A,D
004D43 DD     13774 ADD	A,(IX+1)
004D44 86   
004D45 01   
004D46 5F     13775 LD	E,A
004D47 FE     13776 CP	11
004D48 0B   
004D49 38     13777 JR	C,STR32
004D4A 17   
004D4B 78     13778 STR31:          LD	A,B		;G MODE
004D4C 11     13779 LD	DE,101H
004D4D 01   
004D4E 01   
004D4F B7     13780 OR	A
004D50 FA     13781 JP	M,STR34
004D51 66   
004D52 4D   
004D53 28     13782 JR	Z,STR32
004D54 0D   
004D55 DD     13783 LD	A,(IX+1)
004D56 7E   
004D57 01   
004D58 B7     13784 OR	A
004D59 20     13785 JR	NZ,STR3A
004D5A 02   
004D5B 3E     13786 LD	A,10
004D5C 0A   
004D5D B8     13787 STR3A:          CP	B
004D5E 38     13788 JR	C,STR34
004D5F 06   
004D60 50     13789 LD	D,B
004D61 58     13790 LD	E,B
004D62 78     13791 STR32:          LD	A,B
004D63 C6     13792 ADD	A,129
004D64 81   
004D65 4F     13793 LD	C,A
004D66 CB     13794 STR34:          SET	7,D
004D67 FA   
004D68 1D     13795 DEC	E
004D69 7A     13796 STR35:          LD	A,D
004D6A B9     13797 CP	C
004D6B 30     13798 JR	NC,STR33
004D6C 0C   
004D6D F1     13799 STR36:          POP	AF
004D6E 28     13800 JR	Z,STR37
004D6F 03   
004D70 F2     13801 JP	P,STR38
004D71 7B   
004D72 4D   
004D73 F5     13802 STR37:          PUSH	AF
004D74 1C     13803 INC	E
004D75 1D     13804 DEC	E
004D76 FA     13805 JP	M,STR4
004D77 8A   
004D78 4D   
004D79 3E     13806 STR33:          LD	A,'0'
004D7A 30   
004D7B 15     13807 STR38:          DEC	D
004D7C E2     13808 JP	PO,STR39
004D7D 82   
004D7E 4D   
004D7F 36     13809 LD	(HL),'.'
004D80 2E   
004D81 23     13810 INC	HL
004D82 77     13811 STR39:          LD	(HL),A
004D83 23     13812 INC	HL
004D84 1D     13813 DEC	E
004D85 F2     13814 JP	P,STR35
004D86 69   
004D87 4D   
004D88 18     13815 JR	STR36
004D89 E3   
004D8A F1     13817 STR4:           POP	AF
004D8B 0C     13818 STR40:          INC	C
004D8C 4D     13819 LD	C,L
004D8D 20     13820 JR	NZ,STR44
004D8E 27   
004D8F 36     13821 LD	(HL),'E'	;EXPONENT
004D90 45   
004D91 23     13822 INC	HL
004D92 78     13823 LD	A,B
004D93 3D     13824 DEC	A
004D94 F2     13825 JP	P,STR41
004D95 9C   
004D96 4D   
004D97 36     13826 LD	(HL),'-'
004D98 2D   
004D99 23     13827 INC	HL
004D9A ED     13828 NEG
004D9B 44   
004D9C 36     13829 STR41:          LD	(HL),'0'
004D9D 30   
004D9E 28     13830 JR	Z,STR47
004D9F 15   
004DA0 FE     13831 CP	10
004DA1 0A   
004DA2 47     13832 LD	B,A
004DA3 3E     13833 LD	A,':'
004DA4 3A   
004DA5 38     13834 JR	C,STR42
004DA6 03   
004DA7 23     13835 INC	HL
004DA8 36     13836 LD	(HL),'0'
004DA9 30   
004DAA 34     13837 STR42:          INC	(HL)
004DAB BE     13838 CP	(HL)
004DAC 20     13839 JR	NZ,STR43
004DAD 05   
004DAE 36     13840 LD	(HL),'0'
004DAF 30   
004DB0 2B     13841 DEC	HL
004DB1 34     13842 INC	(HL)
004DB2 23     13843 INC	HL
004DB3 10     13844 STR43:          DJNZ	STR42
004DB4 F5   
004DB5 23     13845 STR47:          INC	HL
004DB6 EB     13846 STR44:          EX	DE,HL
004DB7 C9     13847 RET
004DB8 CD     13857 CON:            CALL	ZEROmat		;INITIALISE TO ZERO
004DB9 A5   
004DBA 4F   
004DBB 0E     13858 LD	C,0		;TRUNCATION COUNTER
004DBC 00   
004DBD CD     13859 CALL	NUMBERmat		;GET INTEGER PART
004DBE 3D   
004DBF 4E   
004DC0 FE     13860 CP	'.'
004DC1 2E   
004DC2 06     13861 LD	B,0		;DECL. PLACE COUNTER
004DC3 00   
004DC4 CC     13862 CALL	Z,NUMBIX	;GET FRACTION PART
004DC5 3B   
004DC6 4E   
004DC7 FE     13863 CP	'E'
004DC8 45   
004DC9 3E     13864 LD	A,0		;INITIALISE EXPONENT
004DCA 00   
004DCB CC     13865 CALL	Z,GETEXP	;GET EXPONENT
004DCC 0C   
004DCD 4E   
004DCE CB     13866 BIT	7,H
004DCF 7C   
004DD0 20     13867 JR	NZ,CON0		;INTEGER OVERFLOW
004DD1 08   
004DD2 B7     13868 OR	A
004DD3 20     13869 JR	NZ,CON0		;EXPONENT NON-ZERO
004DD4 05   
004DD5 B8     13870 CP	B
004DD6 20     13871 JR	NZ,CON0		;DECIMAL POINT
004DD7 02   
004DD8 B9     13872 CP	C
004DD9 C8     13873 RET	Z		;INTEGER
004DDA 90     13874 CON0:           SUB	B
004DDB 81     13875 ADD	A,C
004DDC 0E     13876 LD	C,159
004DDD 9F   
004DDE CD     13877 CALL	FLOAT
004DDF 1C   
004DE0 4F   
004DE1 CB     13878 RES	7,H		;DITCH IMPLIED 1
004DE2 BC   
004DE3 B7     13879 OR	A
004DE4 C8     13880 RET	Z		;DONE
004DE5 FA     13881 JP	M,CON2		;NEGATIVE EXPONENT
004DE6 F0   
004DE7 4D   
004DE8 CD     13882 CALL	POWR10
004DE9 79   
004DEA 50   
004DEB CD     13883 CALL	FMUL		;SCALE
004DEC 91   
004DED 47   
004DEE AF     13884 XOR	A
004DEF C9     13885 RET
004DF0 FE     13886 CON2:           CP	-38
004DF1 DA   
004DF2 38     13887 JR	C,CON3		;CAN'T SCALE IN ONE GO
004DF3 0A   
004DF4 ED     13888 NEG
004DF5 44   
004DF6 CD     13889 CALL	POWR10
004DF7 79   
004DF8 50   
004DF9 CD     13890 CALL	FDIV		;SCALE
004DFA 21   
004DFB 47   
004DFC AF     13891 XOR	A
004DFD C9     13892 RET
004DFE F5     13893 CON3:           PUSH	AF
004DFF 3E     13894 LD	A,38
004E00 26   
004E01 CD     13895 CALL	POWR10
004E02 79   
004E03 50   
004E04 CD     13896 CALL	FDIV
004E05 21   
004E06 47   
004E07 F1     13897 POP	AF
004E08 C6     13898 ADD	A,38
004E09 26   
004E0A 18     13899 JR	CON2
004E0B E4   
004E0C C5     13909 GETEXP:         PUSH	BC		;SAVE REGISTERS
004E0D 47     13910 LD	B,A		;INITIAL VALUE
004E0E 0E     13911 LD	C,2		;2 DIGITS MAX
004E0F 02   
004E10 DD     13912 INC	IX		;BUMP PAST 'E'
004E11 23   
004E12 CD     13913 CALL	SIGNQ
004E13 67   
004E14 51   
004E15 08     13914 EX	AF,AF'		;SAVE EXPONENT SIGN
004E16 CD     13915 GETEX1:         CALL	DIGITQ
004E17 5D   
004E18 51   
004E19 38     13916 JR	C,GETEX2
004E1A 17   
004E1B 78     13917 LD	A,B		;B=B*10
004E1C 87     13918 ADD	A,A
004E1D 87     13919 ADD	A,A
004E1E 80     13920 ADD	A,B
004E1F 87     13921 ADD	A,A
004E20 47     13922 LD	B,A
004E21 DD     13923 LD	A,(IX)		;GET BACK DIGIT
004E22 7E   
004E23 00   
004E24 DD     13924 INC	IX
004E25 23   
004E26 E6     13925 AND	0FH		;MASK UNWANTED BITS
004E27 0F   
004E28 80     13926 ADD	A,B		;ADD IN DIGIT
004E29 47     13927 LD	B,A
004E2A 0D     13928 DEC	C
004E2B F2     13929 JP	P,GETEX1
004E2C 16   
004E2D 4E   
004E2E 06     13930 LD	B,100		;FORCE OVERFLOW
004E2F 64   
004E30 18     13931 JR	GETEX1
004E31 E4   
004E32 08     13932 GETEX2:         EX	AF,AF'		;RESTORE SIGN
004E33 FE     13933 CP	'-'
004E34 2D   
004E35 78     13934 LD	A,B
004E36 C1     13935 POP	BC		;RESTORE
004E37 C0     13936 RET	NZ
004E38 ED     13937 NEG			;NEGATE EXPONENT
004E39 44   
004E3A C9     13938 RET
004E3B DD     13951 NUMBIX:         INC	IX
004E3C 23   
004E3D CD     13952 NUMBERmat:         CALL	DIGITQ
004E3E 5D   
004E3F 51   
004E40 D8     13953 RET	C
004E41 04     13954 INC	B		;INCREMENT DIGIT COUNT
004E42 DD     13955 INC	IX
004E43 23   
004E44 CD     13956 CALL	X10		;*10 & COPY OLD VALUE
004E45 F0   
004E46 4F   
004E47 38     13957 JR	C,NUMB1		;OVERFLOW
004E48 13   
004E49 0D     13958 DEC	C		;SEE IF TRUNCATED
004E4A 0C     13959 INC	C
004E4B 20     13960 JR	NZ,NUMB1	;IMPORTANT!
004E4C 0F   
004E4D E6     13961 AND	0FH
004E4E 0F   
004E4F D9     13962 EXX
004E50 06     13963 LD	B,0
004E51 00   
004E52 4F     13964 LD	C,A
004E53 09     13965 ADD	HL,BC		;ADD IN DIGIT
004E54 D9     13966 EXX
004E55 30     13967 JR	NC,NUMBERmat
004E56 E6   
004E57 23     13968 INC	HL		;CARRY
004E58 7C     13969 LD	A,H
004E59 B5     13970 OR	L
004E5A 20     13971 JR	NZ,NUMBERmat
004E5B E1   
004E5C 0C     13972 NUMB1:          INC	C		;TRUNCATION COUNTER
004E5D CD     13973 CALL	SWAP1		;RESTORE PREVIOUS VALUE
004E5E 63   
004E5F 4F   
004E60 18     13974 JR	NUMBERmat
004E61 DB   
004E62 08     13984 FIX:            EX	AF,AF'
004E63 AF     13985 XOR	A
004E64 08     13986 EX	AF,AF'
004E65 CB     13987 SET	7,H		;IMPLIED 1
004E66 FC   
004E67 CD     13988 FIX1:           CALL	DIV2
004E68 68   
004E69 4F   
004E6A B9     13989 CP	C
004E6B C8     13990 RET	Z
004E6C D2     13991 JP	NC,FIX1
004E6D 67   
004E6E 4E   
004E6F C3     13992 JP	OFLOW
004E70 76   
004E71 4F   
004E72 CD     14002 FIX2:           CALL	SWAP
004E73 60   
004E74 4F   
004E75 CD     14003 CALL	SFIXmat
004E76 7B   
004E77 4E   
004E78 CD     14004 CALL	SWAP
004E79 60   
004E7A 4F   
004E7B 0D     14005 SFIXmat:           DEC	C
004E7C 0C     14006 INC	C
004E7D C8     14007 RET	Z		;INTEGER/ZERO
004E7E CB     14008 BIT	7,H		;SIGN
004E7F 7C   
004E80 F5     14009 PUSH	AF
004E81 3E     14010 LD	A,159
004E82 9F   
004E83 CD     14011 CALL	FIX
004E84 62   
004E85 4E   
004E86 F1     14012 POP	AF
004E87 0E     14013 LD	C,0
004E88 00   
004E89 C8     14014 RET	Z
004E8A B7     14015 NEGATE:         OR	A		;CLEAR CARRY
004E8B D9     14016 EXX
004E8C D5     14017 NEG0:           PUSH	DE
004E8D EB     14018 EX	DE,HL
004E8E 21     14019 LD	HL,0
004E8F 00   
004E90 00   
004E91 ED     14020 SBC	HL,DE
004E92 52   
004E93 D1     14021 POP	DE
004E94 D9     14022 EXX
004E95 D5     14023 PUSH	DE
004E96 EB     14024 EX	DE,HL
004E97 21     14025 LD	HL,0
004E98 00   
004E99 00   
004E9A ED     14026 SBC	HL,DE
004E9B 52   
004E9C D1     14027 POP	DE
004E9D C9     14028 RET
004E9E D9     14034 NEG:            EXX
004E9F 2F     14035 CPL
004EA0 E5     14036 PUSH	HL
004EA1 B7     14037 OR	A		;CLEAR CARRY
004EA2 ED     14038 SBC	HL,HL
004EA3 62   
004EA4 ED     14039 SBC	HL,BC
004EA5 42   
004EA6 44     14040 LD	B,H
004EA7 4D     14041 LD	C,L
004EA8 E1     14042 POP	HL
004EA9 18     14043 JR	NEG0
004EAA E1   
004EAB 3E     14056 SCALE:          LD	A,150
004EAC 96   
004EAD B9     14057 CP	C
004EAE 3E     14058 LD	A,ACLOST
004EAF 17   
004EB0 DA     14059 JP	C,ERROR_mat		;"Accuracy lost"
004EB1 AA   
004EB2 45   
004EB3 CD     14060 CALL	PIBY4
004EB4 92   
004EB5 4A   
004EB6 D9     14061 EXX
004EB7 01     14062 LD	BC,2169H	;3.141592653589793238
004EB8 69   
004EB9 21   
004EBA D9     14063 EXX
004EBB CB     14064 MOD48:          SET	7,D		;IMPLIED 1
004EBC FA   
004EBD CB     14065 SET	7,H
004EBE FC   
004EBF 79     14066 LD	A,C
004EC0 0E     14067 LD	C,0		;INIT QUOTIENT
004EC1 00   
004EC2 DD     14068 LD	IX,0
004EC3 21   
004EC4 00   
004EC5 00   
004EC6 DD     14069 PUSH	IX		;PUT ZERO ON STACK
004EC7 E5   
004EC8 B8     14070 CP	B
004EC9 38     14071 JR	C,MOD485	;DIVIDEND<DIVISOR
004ECA 3A   
004ECB D9     14072 MOD481:         EXX			;CARRY=0 HERE
004ECC E3     14073 EX	(SP),HL
004ECD ED     14074 SBC	HL,BC
004ECE 42   
004ECF E3     14075 EX	(SP),HL
004ED0 ED     14076 SBC	HL,DE
004ED1 52   
004ED2 D9     14077 EXX
004ED3 ED     14078 SBC	HL,DE
004ED4 52   
004ED5 30     14079 JR	NC,MOD482	;DIVIDEND>=DIVISOR
004ED6 09   
004ED7 D9     14080 EXX
004ED8 E3     14081 EX	(SP),HL
004ED9 09     14082 ADD	HL,BC
004EDA E3     14083 EX	(SP),HL
004EDB ED     14084 ADC	HL,DE
004EDC 5A   
004EDD D9     14085 EXX
004EDE ED     14086 ADC	HL,DE
004EDF 5A   
004EE0 3F     14087 MOD482:         CCF
004EE1 CB     14088 RL	C		;QUOTIENT
004EE2 11   
004EE3 30     14089 JR	NC,MOD483
004EE4 02   
004EE5 CB     14090 SET	7,C		;STICKY BIT
004EE6 F9   
004EE7 3D     14091 MOD483:         DEC	A
004EE8 B8     14092 CP	B
004EE9 38     14093 JR	C,MOD484	;DIVIDEND<DIVISOR
004EEA 19   
004EEB E3     14094 EX	(SP),HL
004EEC 29     14095 ADD	HL,HL		;DIVIDEND * 2
004EED E3     14096 EX	(SP),HL
004EEE D9     14097 EXX
004EEF ED     14098 ADC	HL,HL
004EF0 6A   
004EF1 D9     14099 EXX
004EF2 ED     14100 ADC	HL,HL
004EF3 6A   
004EF4 30     14101 JR	NC,MOD481	;AGAIN
004EF5 D5   
004EF6 B7     14102 OR	A
004EF7 D9     14103 EXX
004EF8 E3     14104 EX	(SP),HL
004EF9 ED     14105 SBC	HL,BC		;OVERFLOW, SO SUBTRACT
004EFA 42   
004EFB E3     14106 EX	(SP),HL
004EFC ED     14107 SBC	HL,DE
004EFD 52   
004EFE D9     14108 EXX
004EFF ED     14109 SBC	HL,DE
004F00 52   
004F01 B7     14110 OR	A
004F02 18     14111 JR	MOD482
004F03 DC   
004F04 3C     14113 MOD484:         INC	A
004F05 59     14114 MOD485:         LD	E,C		;QUOTIENT
004F06 4F     14115 LD	C,A		;REMAINDER EXPONENT
004F07 D9     14116 EXX
004F08 C1     14117 POP	BC
004F09 D9     14118 EXX
004F0A CB     14119 FLO48:          BIT	7,H
004F0B 7C   
004F0C C0     14120 RET	NZ
004F0D D9     14121 EXX
004F0E CB     14122 SLA	C
004F0F 21   
004F10 CB     14123 RL	B
004F11 10   
004F12 ED     14124 ADC	HL,HL
004F13 6A   
004F14 D9     14125 EXX
004F15 ED     14126 ADC	HL,HL
004F16 6A   
004F17 0D     14127 DEC	C
004F18 C2     14128 JP	NZ,FLO48
004F19 0A   
004F1A 4F   
004F1B C9     14129 RET
004F1C CB     14135 FLOAT:          BIT	7,H
004F1D 7C   
004F1E C0     14136 RET	NZ
004F1F D9     14137 EXX			;SAME AS "X2"
004F20 29     14138 ADD	HL,HL		;TIME-CRITICAL
004F21 D9     14139 EXX			;REGION
004F22 ED     14140 ADC	HL,HL		;(BENCHMARKS)
004F23 6A   
004F24 0D     14141 DEC	C
004F25 C2     14142 JP	NZ,FLOAT
004F26 1C   
004F27 4F   
004F28 C9     14143 RET
004F29 08     14150 FLOATA:         EX	AF,AF'
004F2A C6     14152 ADD	A,RTABLE-DTABLE/2
004F2B 2E   
004F2C 08     14153 EX	AF,AF'
004F2D CD     14154 FLOAT2:         CALL	SWAP
004F2E 60   
004F2F 4F   
004F30 CD     14155 CALL	SFLOAT
004F31 36   
004F32 4F   
004F33 CD     14156 CALL	SWAP
004F34 60   
004F35 4F   
004F36 0D     14157 SFLOAT:         DEC	C
004F37 0C     14158 INC	C
004F38 C0     14159 RET	NZ		;ALREADY FLOATING-POINT
004F39 CD     14160 CALL	TESTmat
004F3A 85   
004F3B 4F   
004F3C C8     14161 RET	Z		;ZERO
004F3D 7C     14162 LD	A,H
004F3E B7     14163 OR	A
004F3F FC     14164 CALL	M,NEGATE
004F40 8A   
004F41 4E   
004F42 0E     14165 LD	C,159
004F43 9F   
004F44 CD     14166 CALL	FLOAT
004F45 1C   
004F46 4F   
004F47 B7     14167 OR	A
004F48 F8     14168 RET	M		;NEGATIVE
004F49 CB     14169 RES	7,H
004F4A BC   
004F4B C9     14170 RET
004F4C D9     14176 ADD1:           EXX
004F4D 01     14177 LD	BC,1
004F4E 01   
004F4F 00   
004F50 09     14178 ADD	HL,BC
004F51 D9     14179 EXX
004F52 D0     14180 RET	NC
004F53 C5     14181 PUSH	BC
004F54 01     14182 LD	BC,1
004F55 01   
004F56 00   
004F57 09     14183 ADD	HL,BC
004F58 C1     14184 POP	BC
004F59 C9     14185 RET
004F5A B7     14192 ODD:            OR	A		;CLEAR CARRY
004F5B D9     14193 EXX
004F5C CB     14194 SET	0,L		;MAKE ODD
004F5D C5   
004F5E D9     14195 EXX
004F5F C9     14196 RET
004F60 79     14204 SWAP:           LD	A,C
004F61 48     14205 LD	C,B
004F62 47     14206 LD	B,A
004F63 EB     14207 SWAP1:          EX	DE,HL
004F64 D9     14208 EXX
004F65 EB     14209 EX	DE,HL
004F66 D9     14210 EXX
004F67 C9     14211 RET
004F68 CD     14217 DIV2:           CALL	D2
004F69 06   
004F6A 50   
004F6B D9     14218 EXX
004F6C CB     14219 RR	B
004F6D 18   
004F6E CB     14220 RR	C
004F6F 19   
004F70 08     14221 EX	AF,AF'
004F71 B0     14222 OR	B
004F72 08     14223 EX	AF,AF'
004F73 D9     14224 EXX
004F74 0C     14225 INCC:           INC	C
004F75 C0     14226 RET	NZ
004F76 3E     14227 OFLOW:          LD	A,TOOBIG
004F77 14   
004F78 C3     14228 JP	ERROR_mat		;"Too big"
004F79 AA   
004F7A 45   
004F7B CD     14233 FTEST:          CALL	TESTmat
004F7C 85   
004F7D 4F   
004F7E C8     14234 RET	Z
004F7F 7C     14235 LD	A,H
004F80 E6     14236 AND	10000000B
004F81 80   
004F82 F6     14237 OR	01000000B
004F83 40   
004F84 C9     14238 RET
004F85 7C     14244 TESTmat:           LD	A,H
004F86 B5     14245 OR	L
004F87 D9     14246 EXX
004F88 B4     14247 OR	H
004F89 B5     14248 OR	L
004F8A D9     14249 EXX
004F8B C9     14250 RET
004F8C 78     14255 FCOMP:          LD	A,B
004F8D B1     14256 OR	C		;Both integer?
004F8E 20     14257 JR	NZ,FCOMP1
004F8F 0A   
004F90 CD     14258 CALL	ICP
004F91 A2   
004F92 4F   
004F93 3E     14259 FCOMP0:         LD	A,0
004F94 00   
004F95 C8     14260 RET	Z		;Equal
004F96 3E     14261 LD	A,80H
004F97 80   
004F98 1F     14262 RRA
004F99 C9     14263 RET
004F9A CD     14265 FCOMP1:         CALL	FLOAT2		;Float both
004F9B 2D   
004F9C 4F   
004F9D CD     14266 CALL	FCP
004F9E AF   
004F9F 4F   
004FA0 18     14267 JR	FCOMP0
004FA1 F1   
004FA2 CD     14277 ICP:            CALL	ICP1
004FA3 CE   
004FA4 4F   
004FA5 3E     14278 ZEROmat:           LD	A,0
004FA6 00   
004FA7 D9     14279 EXX
004FA8 67     14280 LD	H,A
004FA9 6F     14281 LD	L,A
004FAA D9     14282 EXX
004FAB 67     14283 LD	H,A
004FAC 6F     14284 LD	L,A
004FAD 4F     14285 LD	C,A
004FAE C9     14286 RET
004FAF CD     14288 FCP:            CALL	FCP1
004FB0 C1   
004FB1 4F   
004FB2 18     14289 JR	ZEROmat		;PRESET FALSE
004FB3 F1   
004FB4 79     14291 FCP0:           LD	A,C
004FB5 B8     14292 CP	B		;COMPARE EXPONENTS
004FB6 C0     14293 RET	NZ
004FB7 ED     14294 ICP0:           SBC	HL,DE		;COMP MANTISSA MSB
004FB8 52   
004FB9 19     14295 ADD	HL,DE
004FBA C0     14296 RET	NZ
004FBB D9     14297 EXX
004FBC ED     14298 SBC	HL,DE		;COMP MANTISSA LSB
004FBD 52   
004FBE 19     14299 ADD	HL,DE
004FBF D9     14300 EXX
004FC0 C9     14301 RET
004FC1 7C     14303 FCP1:           LD	A,H
004FC2 AA     14304 XOR	D
004FC3 7C     14305 LD	A,H
004FC4 17     14306 RLA
004FC5 F8     14307 RET	M
004FC6 30     14308 JR	NC,FCP0
004FC7 EC   
004FC8 CD     14309 CALL	FCP0
004FC9 B4   
004FCA 4F   
004FCB C8     14310 RET	Z		;** V0.1 BUG FIX
004FCC 3F     14311 CCF
004FCD C9     14312 RET
004FCE 7C     14314 ICP1:           LD	A,H
004FCF AA     14315 XOR	D
004FD0 F2     14316 JP	P,ICP0
004FD1 B7   
004FD2 4F   
004FD3 7C     14317 LD	A,H
004FD4 17     14318 RLA
004FD5 C9     14319 RET
004FD6 05     14325 X10B:           DEC	B
004FD7 0C     14326 INC	C
004FD8 CD     14327 X5:             CALL	COPY0
004FD9 12   
004FDA 50   
004FDB CD     14328 CALL	D2C
004FDC 05   
004FDD 50   
004FDE CD     14329 CALL	D2C
004FDF 05   
004FE0 50   
004FE1 08     14330 EX	AF,AF'		;SAVE CARRY
004FE2 D9     14331 ADD:            EXX
004FE3 19     14332 ADD	HL,DE
004FE4 D9     14333 EXX
004FE5 ED     14334 ADC	HL,DE
004FE6 5A   
004FE7 C9     14335 RET
004FE8 D9     14341 SUB:            EXX
004FE9 B7     14342 OR	A
004FEA ED     14343 SBC	HL,DE
004FEB 52   
004FEC D9     14344 EXX
004FED ED     14345 SBC	HL,DE
004FEE 52   
004FEF C9     14346 RET
004FF0 CD     14359 X10:            CALL	COPY0		;DED'E'=HLH'L'
004FF1 12   
004FF2 50   
004FF3 CD     14360 CALL	X2
004FF4 FF   
004FF5 4F   
004FF6 D8     14361 RET	C		;TOO BIG
004FF7 CD     14362 CALL	X2
004FF8 FF   
004FF9 4F   
004FFA D8     14363 RET	C
004FFB CD     14364 CALL	ADD
004FFC E2   
004FFD 4F   
004FFE D8     14365 RET	C
004FFF D9     14366 X2:             EXX
005000 29     14367 ADD	HL,HL
005001 D9     14368 EXX
005002 ED     14369 ADC	HL,HL
005003 6A   
005004 C9     14370 RET
005005 0C     14376 D2C:            INC	C
005006 CB     14377 D2:             SRL	H
005007 3C   
005008 CB     14378 RR	L
005009 1D   
00500A D9     14379 EXX
00500B CB     14380 RR	H
00500C 1C   
00500D CB     14381 RR	L
00500E 1D   
00500F D9     14382 EXX
005010 C9     14383 RET
005011 41     14388 COPY:           LD	B,C
005012 54     14389 COPY0:          LD	D,H
005013 5D     14390 LD	E,L
005014 D9     14391 EXX
005015 54     14392 LD	D,H
005016 5D     14393 LD	E,L
005017 D9     14394 EXX
005018 C9     14395 RET
005019 CD     14401 SQUARE:         CALL	COPY
00501A 11   
00501B 50   
00501C CD     14402 CALL	FMUL
00501D 91   
00501E 47   
00501F DD     14403 PUSH5:          POP	IX		;RETURN ADDRESS
005020 E1   
005021 C5     14404 PUSH	BC
005022 E5     14405 PUSH	HL
005023 D9     14406 EXX
005024 E5     14407 PUSH	HL
005025 D9     14408 EXX
005026 DD     14409 JP	(IX)		;"RETURN"
005027 E9   
005028 DD     14414 POP5:           POP	IX		;RETURN ADDRESS
005029 E1   
00502A D9     14415 EXX
00502B D1     14416 POP	DE
00502C D9     14417 EXX
00502D D1     14418 POP	DE
00502E 79     14419 LD	A,C
00502F C1     14420 POP	BC
005030 41     14421 LD	B,C
005031 4F     14422 LD	C,A
005032 DD     14423 JP	(IX)		;"RETURN"
005033 E9   
005034 CD     14430 RATIO:          CALL	PUSH5		;SAVE X
005035 1F   
005036 50   
005037 CD     14431 CALL	DONE
005038 87   
005039 4A   
00503A CD     14432 CALL	FADD
00503B C9   
00503C 46   
00503D CD     14433 CALL	POP5		;RESTORE X
00503E 28   
00503F 50   
005040 CD     14434 CALL	PUSH5		;SAVE X+1
005041 1F   
005042 50   
005043 CD     14435 CALL	SWAP
005044 60   
005045 4F   
005046 CD     14436 CALL	DONE
005047 87   
005048 4A   
005049 CD     14437 CALL	FSUB
00504A B3   
00504B 46   
00504C CD     14438 CALL	POP5		;RESTORE X+1
00504D 28   
00504E 50   
00504F C3     14439 JP	FDIV
005050 21   
005051 47   
005052 DD     14450 POLY:           LD	IX,2
005053 21   
005054 02   
005055 00   
005056 DD     14451 ADD	IX,SP
005057 39   
005058 DD     14452 EX	(SP),IX
005059 E3   
00505A CD     14453 CALL	DLOAD5		;FIRST COEFFICIENT
00505B 75   
00505C 1A   
00505D CD     14454 POLY1:          CALL	FMUL
00505E 91   
00505F 47   
005060 11     14455 LD	DE,5
005061 05   
005062 00   
005063 DD     14456 ADD	IX,DE
005064 19   
005065 CD     14457 CALL	DLOAD5		;NEXT COEFFICIENT
005066 75   
005067 1A   
005068 DD     14458 EX	(SP),IX
005069 E3   
00506A 04     14459 INC	B
00506B 05     14460 DEC	B		;TEST
00506C FA     14461 JP	M,FADD
00506D C9   
00506E 46   
00506F CD     14462 CALL	FADD
005070 C9   
005071 46   
005072 CD     14463 CALL	DLOAD5		;X
005073 75   
005074 1A   
005075 DD     14464 EX	(SP),IX
005076 E3   
005077 18     14465 JR	POLY1
005078 E4   
005079 3C     14474 POWR10:         INC	A
00507A 08     14475 EX	AF,AF'
00507B E5     14476 PUSH	HL
00507C D9     14477 EXX
00507D E5     14478 PUSH	HL
00507E D9     14479 EXX
00507F CD     14480 CALL	DONE
005080 87   
005081 4A   
005082 CD     14481 CALL	SWAP
005083 60   
005084 4F   
005085 AF     14482 XOR	A
005086 08     14483 POWR11:         EX	AF,AF'
005087 3D     14484 DEC	A
005088 28     14485 JR	Z,POWR14	;EXITmat TYPE 1
005089 20   
00508A F2     14486 JP	P,POWR13
00508B 91   
00508C 50   
00508D B9     14487 CP	C
00508E 38     14488 JR	C,POWR14	;EXITmat TYPE 2
00508F 1A   
005090 3C     14489 INC	A
005091 08     14490 POWR13:         EX	AF,AF'
005092 3C     14491 INC	A
005093 CB     14492 SET	7,H
005094 FC   
005095 CD     14493 CALL	X5
005096 D8   
005097 4F   
005098 30     14494 JR	NC,POWR12
005099 05   
00509A 08     14495 EX	AF,AF'
00509B CD     14496 CALL	D2C
00509C 05   
00509D 50   
00509E 08     14497 EX	AF,AF'
00509F 08     14498 POWR12:         EX	AF,AF'
0050A0 DC     14499 CALL	C,ADD1		;ROUND UP
0050A1 4C   
0050A2 4F   
0050A3 0C     14500 INC	C
0050A4 FA     14501 JP	M,POWR11
0050A5 86   
0050A6 50   
0050A7 C3     14502 JP	OFLOW
0050A8 76   
0050A9 4F   
0050AA CD     14503 POWR14:         CALL	SWAP
0050AB 60   
0050AC 4F   
0050AD CB     14504 RES	7,D
0050AE BA   
0050AF D9     14505 EXX
0050B0 E1     14506 POP	HL
0050B1 D9     14507 EXX
0050B2 E1     14508 POP	HL
0050B3 08     14509 EX	AF,AF'
0050B4 C9     14510 RET
0050B5 B7     14518 DIVA:           OR	A		;CLEAR CARRY
0050B6 ED     14519 DIV0:           SBC	HL,BC		;DIVIDEND-DIVISOR
0050B7 42   
0050B8 D9     14520 EXX
0050B9 ED     14521 SBC	HL,BC
0050BA 42   
0050BB D9     14522 EXX
0050BC 30     14523 JR	NC,DIV1
0050BD 05   
0050BE 09     14524 ADD	HL,BC		;DIVIDEND+DIVISOR
0050BF D9     14525 EXX
0050C0 ED     14526 ADC	HL,BC
0050C1 4A   
0050C2 D9     14527 EXX
0050C3 3F     14528 DIV1:           CCF
0050C4 CB     14529 DIVC:           RL	E		;SHIFT RESULT INTO DE
0050C5 13   
0050C6 CB     14530 RL	D
0050C7 12   
0050C8 D9     14531 EXX
0050C9 CB     14532 RL	E
0050CA 13   
0050CB CB     14533 RL	D
0050CC 12   
0050CD D9     14534 EXX
0050CE 3C     14535 INC	A
0050CF F0     14536 RET	P
0050D0 ED     14537 DIVB:           ADC	HL,HL		;DIVIDEND*2
0050D1 6A   
0050D2 D9     14538 EXX
0050D3 ED     14539 ADC	HL,HL
0050D4 6A   
0050D5 D9     14540 EXX
0050D6 30     14541 JR	NC,DIV0
0050D7 DE   
0050D8 B7     14542 OR	A
0050D9 ED     14543 SBC	HL,BC		;DIVIDEND-DIVISOR
0050DA 42   
0050DB D9     14544 EXX
0050DC ED     14545 SBC	HL,BC
0050DD 42   
0050DE D9     14546 EXX
0050DF 37     14547 SCF
0050E0 C3     14548 JP	DIVC
0050E1 C4   
0050E2 50   
0050E3 B7     14556 MULA:           OR	A		;CLEAR CARRY
0050E4 D9     14557 MUL0:           EXX
0050E5 CB     14558 RR	D		;MULTIPLIER/2
0050E6 1A   
0050E7 CB     14559 RR	E
0050E8 1B   
0050E9 D9     14560 EXX
0050EA CB     14561 RR	D
0050EB 1A   
0050EC CB     14562 RR	E
0050ED 1B   
0050EE 30     14563 JR	NC,MUL1
0050EF 05   
0050F0 09     14564 ADD	HL,BC		;ADD IN MULTIPLICAND
0050F1 D9     14565 EXX
0050F2 ED     14566 ADC	HL,BC
0050F3 4A   
0050F4 D9     14567 EXX
0050F5 3C     14568 MUL1:           INC	A
0050F6 F0     14569 RET	P
0050F7 D9     14570 MULB:           EXX
0050F8 CB     14571 RR	H		;PRODUCT/2
0050F9 1C   
0050FA CB     14572 RR	L
0050FB 1D   
0050FC D9     14573 EXX
0050FD CB     14574 RR	H
0050FE 1C   
0050FF CB     14575 RR	L
005100 1D   
005101 C3     14576 JP	MUL0
005102 E4   
005103 50   
005104 ED     14584 SQR1:           SBC	HL,BC
005105 42   
005106 D9     14585 EXX
005107 ED     14586 SBC	HL,BC
005108 42   
005109 D9     14587 EXX
00510A 0C     14588 INC	C
00510B 30     14589 JR	NC,SQR2
00510C 07   
00510D 0D     14590 DEC	C
00510E 09     14591 ADD	HL,BC
00510F D9     14592 EXX
005110 ED     14593 ADC	HL,BC
005111 4A   
005112 D9     14594 EXX
005113 0D     14595 DEC	C
005114 3C     14596 SQR2:           INC	A
005115 F0     14597 RET	P
005116 CB     14598 SQRA:           SLA	C
005117 21   
005118 CB     14599 RL	B
005119 10   
00511A 0C     14600 INC	C
00511B D9     14601 EXX
00511C CB     14602 RL	C
00511D 11   
00511E CB     14603 RL	B
00511F 10   
005120 CD     14604 CALL	SLA8
005121 4C   
005122 51   
005123 CD     14605 CALL	SLA8
005124 4C   
005125 51   
005126 D9     14606 EXX
005127 D2     14607 JP	NC,SQR1
005128 04   
005129 51   
00512A B7     14608 SQR3:           OR	A
00512B ED     14609 SBC	HL,BC
00512C 42   
00512D D9     14610 EXX
00512E ED     14611 SBC	HL,BC
00512F 42   
005130 D9     14612 EXX
005131 0C     14613 INC	C
005132 C3     14614 JP	SQR2
005133 14   
005134 51   
005135 29     14616 SQRB:           ADD	HL,HL
005136 D9     14617 EXX
005137 ED     14618 ADC	HL,HL
005138 6A   
005139 D9     14619 EXX
00513A 38     14620 JR	C,SQR3
00513B EE   
00513C 3C     14621 INC	A
00513D 0C     14622 INC	C
00513E ED     14623 SBC	HL,BC
00513F 42   
005140 D9     14624 EXX
005141 ED     14625 SBC	HL,BC
005142 42   
005143 D9     14626 EXX
005144 D0     14627 RET	NC
005145 09     14628 ADD	HL,BC
005146 D9     14629 EXX
005147 ED     14630 ADC	HL,BC
005148 4A   
005149 D9     14631 EXX
00514A 0D     14632 DEC	C
00514B C9     14633 RET
00514C D9     14635 SLA8:           EXX
00514D CB     14636 SLA	E
00514E 23   
00514F CB     14637 RL	D
005150 12   
005151 D9     14638 EXX
005152 CB     14639 RL	E
005153 13   
005154 CB     14640 RL	D
005155 12   
005156 D9     14641 EXX
005157 ED     14642 ADC	HL,HL
005158 6A   
005159 D9     14643 EXX
00515A ED     14644 ADC	HL,HL
00515B 6A   
00515C C9     14645 RET
00515D DD     14647 DIGITQ:         LD	A,(IX)
00515E 7E   
00515F 00   
005160 FE     14648 CP	'9'+1
005161 3A   
005162 3F     14649 CCF
005163 D8     14650 RET	C
005164 FE     14651 CP	'0'
005165 30   
005166 C9     14652 RET
005167 DD     14654 SIGNQ:          LD	A,(IX)
005168 7E   
005169 00   
00516A DD     14655 INC	IX
00516B 23   
00516C FE     14656 CP	' '
00516D 20   
00516E 28     14657 JR	Z,SIGNQ
00516F F7   
005170 FE     14658 CP	'+'
005171 2B   
005172 C8     14659 RET	Z
005173 FE     14660 CP	'-'
005174 2D   
005175 C8     14661 RET	Z
005176 DD     14662 DEC	IX
005177 2B   
005178 C9     14663 RET
005179 08     14665 ABS2:           EX	AF,AF'
00517A CB     14666 BIT	7,H
00517B 7C   
00517C C4     14667 CALL	NZ,NEGATE	;MAKE ARGUMENTS +VE
00517D 8A   
00517E 4E   
00517F CD     14668 CALL	SWAP
005180 60   
005181 4F   
005182 CB     14669 BIT	7,H
005183 7C   
005184 C4     14670 CALL	NZ,NEGATE
005185 8A   
005186 4E   
005187 44     14671 LD	B,H
005188 4D     14672 LD	C,L
005189 21     14673 LD	HL,0
00518A 00   
00518B 00   
00518C D9     14674 EXX
00518D 44     14675 LD	B,H
00518E 4D     14676 LD	C,L
00518F 21     14677 LD	HL,0
005190 00   
005191 00   
005192 C9     14678 RET
005193             14683   ; --- Begin data.asm ---
005193 FF     14705 ALIGN 256
005194 FF   
005195 FF   
005196 FF   
005197 FF   
005198 FF   
005199 FF   
00519A FF   
00519B FF   
00519C FF   
00519D FF   
00519E FF   
00519F FF   
0051A0 FF   
0051A1 FF   
0051A2 FF   
0051A3 FF   
0051A4 FF   
0051A5 FF   
0051A6 FF   
0051A7 FF   
0051A8 FF   
0051A9 FF   
0051AA FF   
0051AB FF   
0051AC FF   
0051AD FF   
0051AE FF   
0051AF FF   
0051B0 FF   
0051B1 FF   
0051B2 FF   
0051B3 FF   
0051B4 FF   
0051B5 FF   
0051B6 FF   
0051B7 FF   
0051B8 FF   
0051B9 FF   
0051BA FF   
0051BB FF   
0051BC FF   
0051BD FF   
0051BE FF   
0051BF FF   
0051C0 FF   
0051C1 FF   
0051C2 FF   
0051C3 FF   
0051C4 FF   
0051C5 FF   
0051C6 FF   
0051C7 FF   
0051C8 FF   
0051C9 FF   
0051CA FF   
0051CB FF   
0051CC FF   
0051CD FF   
0051CE FF   
0051CF FF   
0051D0 FF   
0051D1 FF   
0051D2 FF   
0051D3 FF   
0051D4 FF   
0051D5 FF   
0051D6 FF   
0051D7 FF   
0051D8 FF   
0051D9 FF   
0051DA FF   
0051DB FF   
0051DC FF   
0051DD FF   
0051DE FF   
0051DF FF   
0051E0 FF   
0051E1 FF   
0051E2 FF   
0051E3 FF   
0051E4 FF   
0051E5 FF   
0051E6 FF   
0051E7 FF   
0051E8 FF   
0051E9 FF   
0051EA FF   
0051EB FF   
0051EC FF   
0051ED FF   
0051EE FF   
0051EF FF   
0051F0 FF   
0051F1 FF   
0051F2 FF   
0051F3 FF   
0051F4 FF   
0051F5 FF   
0051F6 FF   
0051F7 FF   
0051F8 FF   
0051F9 FF   
0051FA FF   
0051FB FF   
0051FC FF   
0051FD FF   
0051FE FF   
0051FF FF   
005200 FF   
005201 FF   
005202 FF   
005203 FF   
005204 FF   
005205 FF   
005206 FF   
005207 FF   
005208 FF   
005209 FF   
00520A FF   
00520B FF   
00520C FF   
00520D FF   
00520E FF   
00520F FF   
005210 FF   
005211 FF   
005212 FF   
005213 FF   
005214 FF   
005215 FF   
005216 FF   
005217 FF   
005218 FF   
005219 FF   
00521A FF   
00521B FF   
00521C FF   
00521D FF   
00521E FF   
00521F FF   
005220 FF   
005221 FF   
005222 FF   
005223 FF   
005224 FF   
005225 FF   
005226 FF   
005227 FF     14715 ALIGN 256
005228 FF   
005229 FF   
00522A FF   
00522B FF   
00522C FF   
00522D FF   
00522E FF   
00522F FF   
005230 FF   
005231 FF   
005232 FF   
005233 FF   
005234 FF   
005235 FF   
005236 FF   
005237 FF   
005238 FF   
005239 FF   
00523A FF   
00523B FF   
00523C FF   
00523D FF   
00523E FF   
00523F FF   
005240 FF   
005241 FF   
005242 FF   
005243 FF   
005244 FF   
005245 FF   
005246 FF   
005247 FF   
005248 FF   
005249 FF   
00524A FF   
00524B FF   
00524C FF   
00524D FF   
00524E FF   
00524F FF   
005250 FF   
005251 FF   
005252 FF   
005253 FF   
005254 FF   
005255 FF   
005256 FF   
005257 FF   
005258 FF   
005259 FF   
00525A FF   
00525B FF   
00525C FF   
00525D FF   
00525E FF   
00525F FF   
005260 FF   
005261 FF   
005262 FF   
005263 FF   
005264 FF   
005265 FF   
005266 FF   
005267 FF   
005268 FF   
005269 FF   
00526A FF   
00526B FF   
00526C FF   
00526D FF   
00526E FF   
00526F FF   
005270 FF   
005271 FF   
005272 FF   
005273 FF   
005274 FF   
005275 FF   
005276 FF   
005277 FF   
005278 FF   
005279 FF   
00527A FF   
00527B FF   
00527C FF   
00527D FF   
00527E FF   
00527F FF   
005280 FF   
005281 FF   
005282 FF   
005283 FF   
005284 FF   
005285 FF   
005286 FF   
005287 FF   
005288 FF   
005289 FF   
00528A FF   
00528B FF   
00528C FF   
00528D FF   
00528E FF   
00528F FF   
005290 FF   
005291 FF   
005292 FF   
005293 FF   
005294 FF   
005295 FF   
005296 FF   
005297 FF   
005298 FF   
005299 FF   
00529A FF   
00529B FF   
00529C FF   
00529D FF   
00529E FF   
00529F FF   
0052A0 FF   
0052A1 FF   
0052A2 FF   
0052A3 FF   
0052A4 FF   
0052A5 FF   
0052A6 FF   
0052A7 FF   
0052A8 FF   
0052A9 FF   
0052AA FF   
0052AB FF   
0052AC FF   
0052AD FF   
0052AE FF   
0052AF FF   
0052B0 FF   
0052B1 FF   
0052B2 FF   
0052B3 FF   
0052B4 FF   
0052B5 FF   
0052B6 FF   
0052B7 FF   
0052B8 FF   
0052B9 FF   
0052BA FF   
0052BB FF   
0052BC FF   
0052BD FF   
0052BE FF   
0052BF FF   
0052C0 FF   
0052C1 FF   
0052C2 FF   
0052C3 FF   
0052C4 FF   
0052C5 FF   
0052C6 FF   
0052C7 FF   
0052C8 FF   
0052C9 FF   
0052CA FF   
0052CB FF   
0052CC FF   
0052CD FF   
0052CE FF   
0052CF FF   
0052D0 FF   
0052D1 FF   
0052D2 FF   
0052D3 FF   
0052D4 FF   
0052D5 FF   
0052D6 FF   
0052D7 FF   
0052D8 FF   
0052D9 FF   
0052DA FF   
0052DB FF   
0052DC FF   
0052DD FF   
0052DE FF   
0052DF FF   
0052E0 FF   
0052E1 FF   
0052E2 FF   
0052E3 FF   
0052E4 FF   
0052E5 FF   
0052E6 FF   
0052E7 FF   
0052E8 FF   
0052E9 FF   
0052EA FF   
0052EB FF   
0052EC FF   
0052ED FF   
0052EE FF   
0052EF FF   
0052F0 FF   
0052F1 FF   
0052F2 FF   
0052F3 FF   
0052F4 FF   
0052F5 FF   
0052F6 FF   
0052F7 FF   
0052F8 FF   
0052F9 FF   
0052FA FF   
0052FB FF   
0052FC FF   
0052FD FF   
0052FE FF   
0052FF FF   
